<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- CSS ≈°t√Ωly zost√°vaj√∫ rovnak√© --- */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start; /* Zmenen√© na flex-start pre lep≈°ie zarovnanie s details */
        gap: 10px; /* Pridan√Ω gap pre medzery */
    }
    /* Priame deti .settings (div, details, button) */
    .settings > div,
    .settings > details,
    .settings > button {
        flex: 1 1 200px; /* Zachovanie flex basis */
        margin: 0; /* Odstr√°nen√Ω margin, pou≈æ√≠vame gap */
    }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 900px; /* Mierne zv√§ƒç≈°en√° min-width kv√¥li nov√©mu stƒ∫pcu */ }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; /* Zarovnaj obsah buniek hore */ }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea /* Pridan√Ω select a .note-textarea */ {
        width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px;
    }
    /* Uprav ≈°√≠rky stƒ∫pcov podƒæa potreby */
    th:nth-child(1), td:nth-child(1) { min-width: 50px; } /* De≈à */
    th:nth-child(2), td:nth-child(2) { min-width: 80px; } /* Pr√≠chod */
    th:nth-child(3), td:nth-child(3) { min-width: 80px; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* Prest√°vka */
    th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* Odpracovan√© */
    th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* Hrub√° Mzda */
    th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* ƒåist√° Mzda */
    th:nth-child(8), td:nth-child(8) { min-width: 120px; } /* Pozn√°mka - nov√Ω stƒ∫pec */
    th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia - posledn√Ω stƒ∫pec */

    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    /* ≈†t√Ωl pre prihlasovacie/odhlasovacie tlaƒçidlo */
    #auth-action-btn.login { background-color: #2196F3; }
    #auth-action-btn.login:hover { background-color: #1976D2; }
    #auth-action-btn.logout { background-color: #f44336; }
    #auth-action-btn.logout:hover { background-color: #d32f2f; }

    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input, .current-day .note-textarea /* Pridan√© .note-textarea pre current-day */ { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode /* Pridan√Ω select a .note-textarea */ {
        background-color: #666; color: white; border-color: #888; /* Pridan√° farba okraja pre dark mode */
    }
    .btn.dark-mode { color: #eee; } /* Lep≈°ia ƒçitateƒænos≈• v dark mode */
    .reset-btn.dark-mode { background-color: #c62828; } .reset-btn.dark-mode:hover { background-color: #b71c1c; }
    .export-btn.dark-mode { background-color: #2e7d32; } .export-btn.dark-mode:hover { background-color: #1b5e20; }
    .restore-btn.dark-mode { background-color: #6a1b9a; } .restore-btn.dark-mode:hover { background-color: #4a148c; }
    .backup-btn.dark-mode { background-color: #ef6c00; } .backup-btn.dark-mode:hover { background-color: #e65100; }
    #auth-action-btn.login.dark-mode { background-color: #1976D2; } #auth-action-btn.login.dark-mode:hover { background-color: #0D47A1; }
    #auth-action-btn.logout.dark-mode { background-color: #c62828; } #auth-action-btn.logout.dark-mode:hover { background-color: #b71c1c; }

    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input, .current-day.dark-mode .note-textarea /* Pridan√© .note-textarea pre current-day dark mode */ { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    /* Auth container ≈°t√Ωly */
    #auth-container { max-width: 400px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); text-align: center; border: 1px solid #ccc; }
     body.dark-mode #auth-container { background-color: #555; border-color: #777; }
    #auth-container h1 { font-size: 1.8em; margin-bottom: 15px; }
    #auth-container h2 { font-size: 1.4em; margin-top: 20px; margin-bottom: 10px; color: #444; }
     body.dark-mode #auth-container h2 { color: #eee; }
    #auth-container input { width: 90%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
     body.dark-mode #auth-container input { background-color: #666; color: white; border-color: #888; }
    #auth-container button { width: 95%; padding: 12px; margin: 15px 0 5px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 1.1em; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
    #auth-container button:hover { background-color: #45a049; }
    #auth-message { margin-bottom: 15px; font-weight: bold; color: #333; }
     body.dark-mode #auth-message { color: #eee; }
    #forgot-password-link { display: block; margin-top: 10px; font-size: 0.9em; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }
     body.dark-mode #forgot-password-link { color: #66b3ff; }
     /* Tlaƒçidlo na zatvorenie formul√°ra */
     #close-auth-btn { background-color: #aaa; margin-top: 10px; }
     #close-auth-btn:hover { background-color: #888; }


    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; text-align: center; padding: 20px; }
    #loading-container h1 { font-size: 1.5em; color: #555; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }

    /* --- ≈†T√ùLY PRE ZBALITEƒΩN√ö ƒåAS≈§ (nezmenen√©) --- */
    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
    .collapsible-settings summary:hover { background-color: #eee; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
    body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
    body.dark-mode .collapsible-content { border-top-color: #666; }

    /* --- ≈†T√ùLY PRE POZN√ÅMKY (nezmenen√©) --- */
    .note-container { display: none; margin-top: 5px; }
    .note-container.visible { display: block; }
    .note-textarea { width: 95%; min-height: 40px; resize: vertical; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; background-color: #f0f0f0; }
    .toggle-note-btn { background-color: #6c757d; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease; margin-bottom: 2px; }
    .toggle-note-btn:hover { background-color: #5a6268; }
    .note-textarea.dark-mode { background-color: #555; color: #f4f4f4; border-color: #777; }
    .toggle-note-btn.dark-mode { background-color: #828a91; }
    .toggle-note-btn.dark-mode:hover { background-color: #70777d; }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loading-container"><h1>Naƒç√≠tavam Bruno's Calculator...</h1></div>

  <!-- Auth container - ≈°tandardne skryt√Ω -->
  <div id="auth-container" style="display:none;">
    <h1>Prihl√°senie / Registr√°cia</h1>
    <p>Prihl√°senie umo≈æ≈àuje synchroniz√°ciu d√°t medzi zariadeniami.</p>
    <div id="auth-message"></div>
    <div id="auth-forms">
      <h2>Registr√°cia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrova≈•</button>
      <h2>Prihl√°senie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihl√°si≈• sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
    <button id="close-auth-btn" onclick="closeAuthForm()">Zavrie≈•</button>
  </div>

  <!-- Calculator container - ≈°tandardne viditeƒæn√Ω po naƒç√≠tan√≠ -->
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>

    <!-- Nastavenia -->
    <div class="settings">
        <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
                <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
                <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
                <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
                <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
            </select>
        </div>
        <details class="collapsible-settings">
            <summary>ƒéal≈°ie nastavenia</summary>
            <div class="collapsible-content">
                <div><label for="employeeNameInput">Meno pracovn√≠ka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()"></div>
                <div><label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div>
                <div><label for="taxRateInput">Da≈àov√© percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"></div>
                <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div>
                <div><label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2">2</option></select></div>
            </div>
        </details>
        <button onclick="toggleDarkMode()" class="btn highlight">Tmav√Ω re≈æim</button>
    </div>

    <!-- Tabuƒæka -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th> <th>Pr√≠chod</th> <th>Odchod</th> <th>Prest√°vka</th> <th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th> <th>ƒåist√° Mzda (‚Ç¨)</th> <th class="th-note">Pozn√°mka</th> <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <!-- S√∫ƒçty a info -->
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lok√°lne √∫lo≈æisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>

    <!-- Tlaƒçidl√° -->
    <div class="btn-container">
      <!-- Nov√© tlaƒçidlo pre Prihl√°senie/Odhl√°senie -->
      <button id="auth-action-btn" class="btn"></button>
      <button class="btn reset-btn" onclick="resetAll()">Resetova≈• aktu√°lny mesiac</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu (lok√°lnu)</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu (lok√°lnu)</button>
      <!-- P√¥vodn√© odhlasovacie tlaƒçidlo je nahraden√© nov√Ωm auth-action-btn -->
      <!-- <button id="logout-btn" class="btn reset-btn" onclick="logout()" style="display:none;">Odhl√°si≈• sa</button> -->
    </div>
  </div>

  <!-- Notifik√°cia -->
  <div id="saveNotification"></div>

  <script>
    // 1. Firebase Config & Init - Nezmenen√©
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktiv√°cii Firebase App Check:", error); }
    const db = firebase.firestore(); const auth = firebase.auth();

    // 2. Povolenie Firestore Offline Persistence - Nezmenen√©
    db.enablePersistence().then(() => { console.log("Firestore offline persistence povolen√°."); }).catch((err) => { console.error("Firestore offline persistence chyba:", err.code, err.message, err); if (err.code == 'failed-precondition') { console.warn("Firestore offline persistence: Viacn√°sobn√© otvoren√© taby, povolen√© len v jednom."); } else if (err.code == 'unimplemented') { console.error("Firestore offline persistence: Prehliadaƒç nie je podporovan√Ω."); } });

    // 3. Glob√°lne premenn√© - Pridan√° isLoggedIn
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
    let monthData = {};
    let firestoreListenerUnsubscribe = null;
    let isLoggedIn = false; // Nov√° premenn√° na sledovanie stavu prihl√°senia
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const authContainer = document.getElementById('auth-container');
    const calculatorContainer = document.getElementById('calculator-container');
    const loadingContainer = document.getElementById('loading-container');
    const authActionButton = document.getElementById('auth-action-btn');
    const authMessage = document.getElementById('auth-message');
    const MAX_DATA_SIZE = 4 * 1024 * 1024;
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // 4. Auth funkcie (Register, Login, Logout, Forgot Password) - Upraven√© pre UI
    function register() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log("Registrovan√Ω:", userCredential.user);
          alert("Registr√°cia √∫spe≈°n√°! Teraz ste prihl√°sen√Ω.");
          closeAuthForm(); // Zatvor formul√°r po √∫spechu
        })
        .catch((error) => {
          console.error("Chyba pri registr√°cii:", error.message);
          alert("Chyba pri registr√°cii: " + error.message);
        });
    }

    function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log("Prihl√°sen√Ω:", userCredential.user);
          alert("Prihl√°senie √∫spe≈°n√©!");
          closeAuthForm(); // Zatvor formul√°r po √∫spechu
        })
        .catch((error) => {
          console.error("Chyba pri prihl√°sen√≠:", error.message);
          alert("Chyba pri prihl√°sen√≠: " + error.message);
        });
    }

    function logout() {
      auth.signOut()
        .then(() => {
          console.log("Odhl√°sen√Ω.");
          alert("Odhl√°senie √∫spe≈°n√©!");
          // UI sa aktualizuje cez onAuthStateChanged
        })
        .catch((error) => {
          console.error("Chyba pri odhl√°sen√≠:", error.message);
          alert("Chyba pri odhl√°sen√≠: " + error.message);
        });
    }

    function forgotPassword() {
      const emailInput = document.getElementById('loginEmail'); // Pou≈æijeme email z prihlasovacieho formul√°ra
      const email = emailInput.value;
      if (!email) {
        alert("Pros√≠m, zadajte svoju e-mailov√∫ adresu do poƒæa pre prihl√°senie.");
        emailInput.focus();
        return;
      }
      auth.sendPasswordResetEmail(email)
        .then(() => {
          console.log("E-mail na obnovenie hesla odoslan√Ω na:", email);
          alert("Odkaz na obnovenie hesla bol odoslan√Ω na va≈°u e-mailov√∫ adresu. Skontrolujte si pros√≠m po≈°tu (aj prieƒçinok Spam).");
        })
        .catch((error) => {
          console.error("Chyba pri odosielan√≠ e-mailu na obnovenie hesla:", error);
          alert("Chyba pri odosielan√≠ e-mailu na obnovenie hesla: " + error.message);
        });
    }

    // Funkcia na zatvorenie prihlasovacieho formul√°ra
    function closeAuthForm() {
        authContainer.style.display = 'none';
    }

    // Funkcia na ovl√°danie tlaƒçidla a zobrazenie formul√°ra
    function handleAuthAction() {
        if (isLoggedIn) {
            // Ak je prihl√°sen√Ω, tlaƒçidlo sl√∫≈æi na odhl√°senie
            logout();
        } else {
            // Ak nie je prihl√°sen√Ω, tlaƒçidlo zobraz√≠ prihlasovac√≠ formul√°r
            authMessage.textContent = "Prihl√°ste sa pre synchroniz√°ciu d√°t.";
            authContainer.style.display = 'block';
            authContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Funkcia na aktualiz√°ciu textu a funkcie tlaƒçidla
    function updateAuthActionButton() {
        if (!authActionButton) return;
        if (isLoggedIn && auth.currentUser) {
            authActionButton.textContent = `Odhl√°si≈• sa (${auth.currentUser.email})`;
            authActionButton.onclick = logout;
            authActionButton.classList.remove('login');
            authActionButton.classList.add('logout'); // Prirad√≠ triedu pre ≈°t√Ωl
        } else {
            authActionButton.textContent = 'Prihl√°si≈• sa / Registrova≈•';
            authActionButton.onclick = handleAuthAction;
            authActionButton.classList.remove('logout');
            authActionButton.classList.add('login'); // Prirad√≠ triedu pre ≈°t√Ωl
        }
         // Aplikuj dark mode ≈°t√Ωly aj na toto tlaƒçidlo
        applyDarkMode(document.body.classList.contains('dark-mode'));
    }


    // 5. Auth State Change Listener - *** V√ùRAZNE UPRAVEN√â ***
    auth.onAuthStateChanged(user => {
        console.log("onAuthStateChanged: Stav zisten√Ω.", user ? `Pou≈æ√≠vateƒæ: ${user.email}` : "≈Ωiadny pou≈æ√≠vateƒæ.");
        const previousLoginState = isLoggedIn; // Zapam√§t√°me si predch√°dzaj√∫ci stav
        isLoggedIn = !!user; // Aktualizujeme glob√°lny stav

        // Skry loading screen, zobraz kalkulaƒçku (ak e≈°te nie je)
        if (loadingContainer) loadingContainer.classList.add('hidden');
        calculatorContainer.style.display = "block";
        authContainer.style.display = "none"; // Formul√°r je ≈°tandardne skryt√Ω

        // Zastav√≠me predch√°dzaj√∫ci listener, ak existoval
        if (firestoreListenerUnsubscribe) {
            console.log("Odhlasujem predch√°dzaj√∫ci Firestore listener pri zmene Auth stavu.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        // Aktualizujeme UI tlaƒçidla Prihl√°si≈•/Odhl√°si≈•
        updateAuthActionButton();

        // Nastavenie z√°kladn√Ωch premenn√Ωch z localStorage (rob√≠ sa v≈ædy)
        const storedMonth = localStorage.getItem('currentMonth');
        const storedYear = localStorage.getItem('currentYear');
        const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        const currentDate = new Date();
        currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
        currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();

        // Aplikujeme dark mode hneƒè
        applyDarkMode(darkMode);

        // Naƒç√≠tame nastavenia (mzda, da≈à, atƒè.) z localStorage
        hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
        taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
        decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
        employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

        // Aktualizujeme input polia pre nastavenia
        hourlyWageInput.value = hourlyWage;
        taxRateInput.value = taxRate * 100;
        decimalPlacesSelect.value = decimalPlaces;
        employeeNameInput.value = employeeName;
        // Aktualizujeme selecty pre mesiac a rok
        monthSelect.value = currentMonth;
        if (yearSelect.querySelector(`option[value="${currentYear}"]`)) { yearSelect.value = currentYear; }
        else { console.warn(`Rok ${currentYear} z localStorage nen√°jden√Ω, pou≈æ√≠vam aktu√°lny.`); currentYear = currentDate.getFullYear(); populateYearSelect(); yearSelect.value = currentYear; }

        if (user) {
            // ----- POU≈Ω√çVATEƒΩ JE PRIHL√ÅSEN√ù -----
            console.log("Pou≈æ√≠vateƒæ prihl√°sen√Ω. Nastavujem Firebase listener.");

            // Ak sa pou≈æ√≠vateƒæ pr√°ve prihl√°sil (predt√Ωm nebol)
            if (!previousLoginState) {
                console.log("Prv√© prihl√°senie v tejto session. Naƒç√≠tavam lok√°lne d√°ta ako z√°klad.");
                // Lok√°lne d√°ta s√∫ u≈æ naƒç√≠tan√© v monthData cez loadFromLocalStorage ni≈æ≈°ie
            }

            // Naƒç√≠tame d√°ta dn√≠ z localStorage ako v√Ωchodiskov√Ω stav
            console.log("onAuthStateChanged (prihl√°sen√Ω): Volanie loadFromLocalStorage (naƒç√≠ta d√°ta dn√≠).");
            loadFromLocalStorage(); // Toto naƒç√≠ta monthData z localStorage a vykresl√≠ tabuƒæku

            // Nastav√≠me listener, ktor√Ω potom m√¥≈æe prep√≠sa≈• lok√°lne d√°ta d√°tami z Firebase
            setupFirestoreListener();

            // Vytvorenie/kontrola u≈æ√≠vateƒæsk√©ho dokumentu v Firestore
            const uid = user.uid;
            const userDocRef = db.collection("users").doc(uid);
            userDocRef.get().then(userDocSnap => {
                 if (!userDocSnap.exists) {
                    userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true })
                         .then(() => console.log("Vytvoren√Ω/aktualizovan√Ω dokument pre:", uid))
                         .catch(err => console.error("Chyba pri vytv√°ran√≠/aktualiz√°cii dokumentu pou≈æ√≠vateƒæa:", err));
                 } else { console.log("Dokument pou≈æ√≠vateƒæa existuje:", uid); }
            }).catch(err => {
                 console.error("Chyba pri kontrole dokumentu pou≈æ√≠vateƒæa (userDocRef.get):", err);
                 showSaveNotification("Chyba pri overovan√≠ pou≈æ√≠vateƒæsk√Ωch d√°t", "error");
            });

            // Timeout logika pre pr√≠pad pomal√©ho naƒç√≠tania listenera (m√¥≈æe zosta≈•)
            setTimeout(() => {
                 if (auth.currentUser && !navigator.onLine) {
                      console.log("onAuthStateChanged (setTimeout): Vyn√∫ten√© druh√© volanie loadFromLocalStorage (offline)...");
                      loadFromLocalStorage(); // Znovu naƒç√≠ta lok√°lne pre istotu pri offline
                 }
            }, 200); // Mierne zv√Ω≈°en√Ω timeout

        } else {
            // ----- POU≈Ω√çVATEƒΩ NIE JE PRIHL√ÅSEN√ù -----
            console.log("Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω. Kalkulaƒçka pobe≈æ√≠ v lok√°lnom re≈æime.");

             // Zastav√≠me listener, ak be≈æal (u≈æ by mal by≈• zastaven√Ω vy≈°≈°ie, ale pre istotu)
            if (firestoreListenerUnsubscribe) {
                firestoreListenerUnsubscribe();
                firestoreListenerUnsubscribe = null;
            }

            // Naƒç√≠tame a zobraz√≠me d√°ta ƒçisto z localStorage
            console.log("onAuthStateChanged (neprihl√°sen√Ω): Volanie loadFromLocalStorage.");
            loadFromLocalStorage(); // Naƒç√≠ta d√°ta (nastavenia aj dni) a vykresl√≠ UI
        }

        // Aktualiz√°cia uv√≠tacej spr√°vy (rob√≠ sa v≈ædy)
        updateWelcomeMessage();
    });

    // 6. Utility funkcie (debounce, showSaveNotification, getFirstName, updateWelcomeMessage) - Nezmenen√©
    function debounce(func, wait) { let timeout; return function (...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), wait); }; }
    function showSaveNotification(message, type = 'success') { const notification = document.getElementById('saveNotification'); notification.textContent = message; notification.className = 'show'; if (type === 'error') { notification.classList.add('error'); } else if (type === 'warning') { notification.classList.add('warning'); } notification.classList.add('show'); setTimeout(() => { notification.classList.remove('show'); notification.classList.remove('error'); notification.classList.remove('warning'); }, 3000); }
    function getFirstName(fullName) { if (!fullName || typeof fullName !== 'string') { return ''; } const trimmedName = fullName.trim(); if (!trimmedName) { return ''; } const parts = trimmedName.split(' '); return parts[0]; }
    function updateWelcomeMessage() { const welcomeElement = document.getElementById('welcomeMessage'); if (!welcomeElement) return; const firstName = getFirstName(employeeName); if (firstName) { welcomeElement.textContent = `Vitaj sp√§≈•, ${firstName}! üëã`; } else { welcomeElement.textContent = ''; } }

    // 7. Funkcia na nastavenie Firestore Listenera - **UPRAVEN√â pre logiku pri neexistuj√∫com dokumente**
    function setupFirestoreListener() {
        if (!isLoggedIn || !auth.currentUser) { console.log("setupFirestoreListener: Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω, listener sa nenastavuje."); return; }
        if (firestoreListenerUnsubscribe) { console.log("setupFirestoreListener: Odhlasujem predch√°dzaj√∫ci listener."); firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; }

        const uid = auth.currentUser.uid;
        if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) { const now = new Date(); currentMonth = currentMonth ?? now.getMonth(); currentYear = currentYear ?? now.getFullYear(); console.warn("setupFirestoreListener: Ch√Ωba mesiac/rok, pou≈æit√© aktu√°lne."); }
        const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`; const docRef = db.doc(docPath);
        console.log(`setupFirestoreListener: Nastavujem listener pre ${docPath}`);

        firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
            console.log(`Firestore listener: Prijat√Ω snapshot pre ${docPath}. Metadata:`, docSnap.metadata);
            const isLocalWrite = docSnap.metadata.hasPendingWrites;

            if (isLocalWrite) {
                console.log("Listener: Detekovan√° lok√°lna zmena (pending write). Preskakujem aktualiz√°ciu UI z listenera.");
                 // Aj keƒè preskakujeme UI update, mali by sme d√°ta z pending write ulo≈æi≈• do monthData a localStorage
                 if (docSnap.exists) {
                     const data = docSnap.data(); const firebaseDaysData = data.days || [];
                     if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                     monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                         start: day.start || '', end: day.end || '', breakTime: day.breakTime || '', note: day.note || ''
                     }));
                     // Uklad√°me aj nastavenia z pending write, ak s√∫ tam
                     hourlyWage = data.hourlyWage ?? hourlyWage;
                     taxRate = (data.taxRate ?? (taxRate * 100)) / 100;
                     decimalPlaces = data.decimalPlaces ?? decimalPlaces;
                     employeeName = data.employeeName ?? employeeName;
                     const fbDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');

                     localStorage.setItem('workDaysData', JSON.stringify(monthData));
                     localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                     localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                     localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                     localStorage.setItem('employeeName', JSON.stringify(employeeName));
                     localStorage.setItem('darkMode', JSON.stringify(fbDarkMode));
                     console.log("Listener (pending write): D√°ta z lok√°lnej zmeny ulo≈æen√© do monthData a localStorage.");
                     updateDataSize(); // Aktualizujeme veƒækos≈•
                 }
                 return; // Nepokraƒçujeme v aktualiz√°cii UI z tohto snapshotu
            }

            if (docSnap.exists) {
                // ----- DOKUMENT EXISTUJE -----
                const data = docSnap.data();
                console.log(`Listener: Dokument existuje (server/cache), naƒç√≠tan√© d√°ta:`, data);
                try {
                    // Naƒç√≠tanie nastaven√≠ z Firebase (s fallbackom na aktu√°lne hodnoty)
                    const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
                    const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
                    const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
                    const firebaseEmployeeName = data.employeeName ?? employeeName;
                    const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');
                    const firebaseDaysData = data.days || [];

                    // Aktualiz√°cia glob√°lnych premenn√Ωch
                    hourlyWage = firebaseHourlyWage;
                    taxRate = firebaseTaxRatePercent / 100;
                    decimalPlaces = firebaseDecimalPlaces;
                    employeeName = firebaseEmployeeName;

                    // Aktualiz√°cia inputov (len ak nemaj√∫ fokus)
                    if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
                    if (document.activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
                    decimalPlacesSelect.value = decimalPlaces;
                    if (document.activeElement !== employeeNameInput) employeeNameInput.value = employeeName;

                    // Aktualiz√°cia monthData pre dni
                    if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                        start: day.start || '', end: day.end || '', breakTime: day.breakTime || '', note: day.note || ''
                    }));
                    console.log(`Listener: monthData pre ${currentYear}-${currentMonth} aktualizovan√© z Firebase. Poƒçet dn√≠: ${monthData[currentYear][currentMonth].length}`);

                    // Ulo≈æenie naƒç√≠tan√Ωch d√°t do localStorage (ako cache/aktu√°lny stav)
                    localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                    localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                    localStorage.setItem('darkMode', JSON.stringify(firebaseDarkMode));
                    localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                    localStorage.setItem('employeeName', JSON.stringify(employeeName));
                    localStorage.setItem('workDaysData', JSON.stringify(monthData));
                    console.log("Listener: D√°ta z Firebase ulo≈æen√© do localStorage.");

                    // Cielen√° aktualiz√°cia UI (len zmenen√© hodnoty a nie akt√≠vne inputy)
                    console.log("Listener: Vykon√°vam cielen√∫ aktualiz√°ciu UI...");
                    const daysInMonth = getDaysInMonth(currentMonth);
                    const activeElementId = document.activeElement?.id;
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayData = monthData[currentYear]?.[currentMonth]?.[i - 1];
                        const startId = `start-${currentYear}-${currentMonth}-${i}`;
                        const endId = `end-${currentYear}-${currentMonth}-${i}`;
                        const breakId = `break-${currentYear}-${currentMonth}-${i}`;
                        const noteId = `note-${currentYear}-${currentMonth}-${i}`;
                        const startEl = document.getElementById(startId), endEl = document.getElementById(endId), breakEl = document.getElementById(breakId), noteEl = document.getElementById(noteId);
                        if (startEl && endEl && breakEl && noteEl) {
                            const newStart = dayData?.start || '', newEnd = dayData?.end || '', newBreak = dayData?.breakTime || '', newNote = dayData?.note || '';
                            if (startEl.value !== newStart && activeElementId !== startId) startEl.value = newStart;
                            if (endEl.value !== newEnd && activeElementId !== endId) endEl.value = newEnd;
                            if (breakEl.value !== newBreak && activeElementId !== breakId) breakEl.value = newBreak;
                            if (noteEl.value !== newNote && activeElementId !== noteId) noteEl.value = newNote;
                            calculateRow(i); // Prepoƒç√≠taj riadok po aktualiz√°cii hodn√¥t
                        }
                    }
                    calculateTotal(); // Prepoƒç√≠taj celkov√© s√∫ƒçty
                    applyDarkMode(firebaseDarkMode); // Aplikuj dark mode
                    updateWelcomeMessage(); // Aktualizuj pozdrav
                    updateDataSize(); // Aktualizuj veƒækos≈• storage
                    console.log("Listener: Cielen√° aktualiz√°cia UI dokonƒçen√°.");
                    if (!docSnap.metadata.fromCache) { console.log("Listener: D√°ta prijat√© priamo zo SERVERA."); showSaveNotification("D√°ta synchronizovan√©"); }

                } catch (processError) {
                    console.error(`Listener: Chyba pri spracovan√≠ d√°t z Firestore pre ${currentYear}-${currentMonth}:`, processError);
                    showSaveNotification("Chyba: Nespr√°vny form√°t d√°t z Firebase", "error");
                    // V pr√≠pade chyby by sme mali naƒç√≠ta≈• z localStorage ako fallback
                    console.log("Listener (chyba): Naƒç√≠tavam z localStorage ako fallback...");
                    loadFromLocalStorage();
                }
            } else {
                // ----- DOKUMENT NEEXISTUJE -----
                console.log(`Listener: Dokument neexistuje na Firebase pre ${currentYear}-${currentMonth}.`);
                 // V tomto pr√≠pade NECHCEME prep√≠sa≈• lok√°lne d√°ta pr√°zdnymi.
                 // Skontrolujeme, ƒçi m√°me nejak√© lok√°lne d√°ta pre tento mesiac.
                 const localDataForMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]);
                 if (localDataForMonth && localDataForMonth.length > 0) {
                     // M√°me lok√°lne d√°ta, ktor√© nie s√∫ vo Firebase -> nahrajme ich
                     console.log(`Listener: Lok√°lne d√°ta pre ${currentYear}-${currentMonth} existuj√∫. Nahr√°vam ich do Firebase...`);
                     saveToFirebaseIfNeeded(); // Zavol√° saveToFirebase, lebo sme prihl√°sen√≠
                 } else {
                     // Nem√°me ani lok√°lne d√°ta -> m√¥≈æeme resetova≈• lok√°lny stav pre tento mesiac (alebo nerobi≈• niƒç)
                     console.log(`Listener: Pre ${currentYear}-${currentMonth} neexistuj√∫ d√°ta ani lok√°lne, ani vo Firebase.`);
                     // Reset lok√°lnych d√°t pre istotu (ak by tam boli nespr√°vne ≈°trukt√∫ry)
                     if (!monthData) monthData = {};
                     if (!monthData[currentYear]) monthData[currentYear] = {};
                     monthData[currentYear][currentMonth] = [];
                     localStorage.setItem('workDaysData', JSON.stringify(monthData)); // Ulo≈æ√≠me pr√°zdne pole pre mesiac
                     console.log(`Listener: Lok√°lne d√°ta pre ${currentYear}-${currentMonth} resetovan√© na pr√°zdne pole.`);
                     // Vykresl√≠me pr√°zdnu tabuƒæku (alebo tabuƒæku len s nastaveniami)
                     createTable();
                     calculateTotal();
                 }
                 // Naƒç√≠tanie nastaven√≠ a update UI by mali by≈• u≈æ vykonan√© v onAuthStateChanged
                 // Ale pre istotu m√¥≈æeme zavola≈• update UI (ktor√© pou≈æije aktu√°lne glob√°lne premenn√©)
                 console.log("Listener (dokument neexistuje): Aktualizujem UI podƒæa aktu√°lneho stavu (ktor√Ω je lok√°lny).");
                 // Nasleduj√∫ce volanie u≈æ nemus√≠ by≈• nutn√©, ak loadFromLocalStorage be≈æ√≠ spr√°vne v onAuthStateChanged
                 // updateUIFromLoadedData(document.body.classList.contains('dark-mode'));
            }
        }, (error) => {
            console.error(`Firestore listener chyba pre ${docPath}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa pripoji≈• k Firebase", "error");
            console.log("Listener chyba, naƒç√≠tavam z localStorage ako fallback...");
            // Pri chybe listenera sa spoliehame na lok√°lne d√°ta
            loadFromLocalStorage();
        });
    }

    // 8. Funkcia na ukladanie do Firebase (volan√° len ak je prihl√°sen√Ω) - Nezmenen√©
    async function saveToFirebase() {
        if (!isLoggedIn || !auth.currentUser) { console.log("saveToFirebase: Preskoƒçen√©, pou≈æ√≠vateƒæ nie je prihl√°sen√Ω."); return; }
        const uid = auth.currentUser.uid;
        try {
            const currentMonthWorkData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            console.log(`saveToFirebase: Uklad√°m ${currentMonthWorkData.length} z√°znamov pre ${currentYear}-${currentMonth}.`);
            const dataToSave = {
                days: currentMonthWorkData,
                hourlyWage: hourlyWage || 10,
                taxRate: (taxRate * 100) || 2,
                decimalPlaces: decimalPlaces || 1,
                employeeName: employeeName || '',
                darkMode: document.body.classList.contains('dark-mode'),
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // Prid√° serverov√Ω ƒças poslednej √∫pravy
            };
            const yearMonthDoc = `${currentYear}-${currentMonth}`;
            const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);
            await docRef.set(dataToSave); // Pou≈æije set na prep√≠sanie cel√©ho dokumentu
            console.log(`saveToFirebase: Po≈æiadavka na ulo≈æenie d√°t pre ${yearMonthDoc} odoslan√°/zaraden√°.`);
            // Notifik√°cia sa zobraz√≠, keƒè listener potvrd√≠ √∫spe≈°n√Ω z√°pis (okrem local write)
        } catch (error) {
            console.error(`Chyba pri po≈æiadavke na ukladanie do Firebase pre ${currentYear}-${currentMonth}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa odosla≈• d√°ta do Firebase", "error");
        }
    }

    // Pomocn√° funkcia na volanie Firebase ukladania
    async function saveToFirebaseIfNeeded() {
        if (isLoggedIn && auth.currentUser) {
            console.log("saveToFirebaseIfNeeded: Pou≈æ√≠vateƒæ prihl√°sen√Ω, sp√∫≈°≈•am ukladanie do Firebase.");
            await saveToFirebase();
        } else {
             console.log("saveToFirebaseIfNeeded: Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω, ukladanie do Firebase preskoƒçen√©.");
        }
    }

    // 9. Funkcia na ukladanie do Local Storage - **UPRAVEN√â** volanie Firebase
    function saveToLocalStorage() {
        try {
            // Inicializ√°cia ≈°trukt√∫ry monthData, ak neexistuje
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) {
                monthData[currentYear][currentMonth] = [];
                console.warn(`saveToLocalStorage: Inicializovan√© pr√°zdne pole pre ${currentYear}-${currentMonth}, lebo ch√Ωbalo.`);
            }

            // Ulo≈æenie nastaven√≠
            localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
            localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
            localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
            localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
            localStorage.setItem('employeeName', JSON.stringify(employeeName));
            localStorage.setItem('currentMonth', currentMonth.toString());
            localStorage.setItem('currentYear', currentYear.toString());

            // Ulo≈æenie d√°t dn√≠ (monthData)
            const serializedMonthData = JSON.stringify(monthData);
            const bytes = new Blob([serializedMonthData]).size;
            if (bytes > MAX_DATA_SIZE * 0.9) { console.warn(`Veƒækos≈• d√°t ('workDaysData') v localStorage (${(bytes/1024).toFixed(1)} KB) sa bl√≠≈æi k limitu ${MAX_DATA_SIZE_KB} KB`); }
            if (bytes > MAX_DATA_SIZE) {
                alert(`Prekroƒçili ste maxim√°lnu veƒækos≈• d√°t (~${MAX_DATA_SIZE_KB} KB) pre d√°ta mesiacov v localStorage. Ukladanie zlyhalo.`);
                showSaveNotification("Chyba: Lok√°lne d√°ta s√∫ pr√≠li≈° veƒæk√©!", "error");
                return; // Neulo≈æ√≠me ani nesk√∫sime ulo≈æi≈• do Firebase
            }
            localStorage.setItem('workDaysData', serializedMonthData);

            updateDataSize(); // Aktualizuj zobrazenie veƒækosti

            // Zavolaj ukladanie do Firebase, iba ak je pou≈æ√≠vateƒæ prihl√°sen√Ω
            saveToFirebaseIfNeeded();

            // Notifik√°cia pre offline re≈æim
            if (!navigator.onLine) {
                 if (isLoggedIn) {
                    showSaveNotification("Offline: Zmeny ulo≈æen√© lok√°lne, synchronizuj√∫ sa po pripojen√≠", "warning");
                 } else {
                    showSaveNotification("Offline: Zmeny ulo≈æen√© lok√°lne", "warning");
                 }
            }

        } catch (error) {
            console.error('Chyba pri ukladan√≠ (lok√°lne/spusten√≠ Firebase save):', error);
            showSaveNotification("Kritick√° chyba pri ukladan√≠!", "error");
        }
    }

    // 10. Funkcia na naƒç√≠tanie z Local Storage - Volan√° v≈ædy pri ≈°tarte / zmene mesiaca / prihl√°sen√≠
    function loadFromLocalStorage() {
        try {
             // Nastavenie currentMonth a currentYear, ak e≈°te nie s√∫ (u≈æ by mali by≈• z onAuthStateChanged)
             if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                 const storedMonth = localStorage.getItem('currentMonth');
                 const storedYear = localStorage.getItem('currentYear');
                 const currentDate = new Date();
                 currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                 currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
                 console.log(`loadFromLocalStorage: Inicializujem mesiac=${getMonthName(currentMonth)}, rok=${currentYear}`);
             }
             console.log(`loadFromLocalStorage: Naƒç√≠tavam lok√°lne d√°ta pre ${getMonthName(currentMonth)} ${currentYear}`);

             // Naƒç√≠tanie d√°t dn√≠
             const storedMonthData = localStorage.getItem('workDaysData');
             monthData = storedMonthData ? JSON.parse(storedMonthData) : {};

             if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) {
                 console.log(`loadFromLocalStorage: Naƒç√≠tan√Ωch ${monthData[currentYear][currentMonth].length} z√°znamov pre dni z localStorage.`);
             } else {
                 console.log(`loadFromLocalStorage: Pre ${currentYear}-${currentMonth} neboli v localStorage n√°jden√© ≈æiadne z√°znamy dn√≠.`);
                 // Inicializujeme pr√°zdne pole, ak neexistuje
                 if (!monthData) monthData = {};
                 if (!monthData[currentYear]) monthData[currentYear] = {};
                 monthData[currentYear][currentMonth] = [];
             }

             // Naƒç√≠tanie nastaven√≠ (mzda, da≈à, atƒè.) - m√¥≈æe by≈• redundantn√©, ak sa vol√° z onAuthStateChanged, ale ne≈°kod√≠
             hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
             taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
             const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
             decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
             employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

             // Aktualiz√°cia UI na z√°klade naƒç√≠tan√Ωch d√°t (nastavenia aj dni)
             updateUIFromLoadedData(darkMode);

        } catch (error) {
             console.error(`Kritick√° chyba pri naƒç√≠tavan√≠/spracovan√≠ d√°t z localStorage pre ${getMonthName(currentMonth)} ${currentYear}:`, error);
             showSaveNotification("Chyba pri naƒç√≠tan√≠ lok√°lnych d√°t!", "error");
             // Reset na bezpeƒçn√Ω stav v pr√≠pade chyby parsovania
             monthData = {};
             hourlyWage = 10; taxRate = 0.02; decimalPlaces = 1; employeeName = ''; applyDarkMode(false);
             createTable(); // Vytvor√≠ pr√°zdnu tabuƒæku
             calculateTotal();
             updateDataSize();
        }
    }

    // 11. Funkcia na aktualiz√°ciu UI - Nezmenen√© (u≈æ pracuje s glob√°lnymi premenn√Ωmi)
    function updateUIFromLoadedData(darkModeValue) {
        console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(currentMonth)} ${currentYear}`);
        try {
            // Aktualiz√°cia inputov nastaven√≠
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = taxRate * 100;
            decimalPlacesSelect.value = decimalPlaces;
            employeeNameInput.value = employeeName;

            // Aktualiz√°cia selectov mesiaca a roka
            if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) { monthSelect.value = currentMonth; }
            else { console.warn(`Mesiac ${currentMonth} nen√°jden√Ω v selecte.`); monthSelect.value = new Date().getMonth(); currentMonth = parseInt(monthSelect.value); }
            if (yearSelect.querySelector(`option[value="${currentYear}"]`)) { yearSelect.value = currentYear; }
            else { console.warn(`Rok ${currentYear} nen√°jden√Ω v selecte.`); yearSelect.value = new Date().getFullYear(); currentYear = parseInt(yearSelect.value); populateYearSelect(); yearSelect.value = currentYear; }

            // Vytvorenie ≈°trukt√∫ry tabuƒæky
            createTable();

            // Naplnenie tabuƒæky d√°tami dn√≠ z glob√°lnej premennej monthData
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            console.log(`updateUIFromLoadedData: Poƒçet z√°znamov v monthData pre plnenie UI: ${dataForCurrentMonth.length}`);
            dataForCurrentMonth.forEach((day, index) => {
                const i = index + 1;
                const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);

                if (startElement && endElement && breakElement && noteElement) {
                    startElement.value = day.start || '';
                    endElement.value = day.end || '';
                    breakElement.value = day.breakTime || '';
                    noteElement.value = day.note || '';
                    calculateRow(i); // Prepoƒç√≠ta dan√Ω riadok
                } else {
                    // Toto by sa nemalo sta≈•, ak createTable funguje spr√°vne
                    console.error(`Kritick√° chyba: Elementy pre de≈à ${i} v updateUIFromLoadedData neboli n√°jden√© po createTable!`);
                }
            });

            // Prepoƒç√≠tanie celkov√Ωch s√∫ƒçtov
            calculateTotal();
            // Aktualiz√°cia veƒækosti √∫lo≈æiska
            updateDataSize();
            // Aplik√°cia tmav√©ho re≈æimu
            applyDarkMode(darkModeValue);
            // Aktualiz√°cia uv√≠tacej spr√°vy
            updateWelcomeMessage();
            console.log("UI aktualizovan√©.");
        } catch (error) {
            console.error("Chyba poƒças aktualiz√°cie UI:", error);
            showSaveNotification("Chyba pri prekresƒæovan√≠ UI!", "error");
        }
    }

    // 12. Funkcia pre aplikovanie Dark Mode - **UPRAVEN√â** pre nov√© tlaƒçidlo
    function applyDarkMode(isDark) {
        const elementsToToggle = [
            document.body,
            document.querySelector('.container'),
            totalSalaryDiv,
            document.querySelector('.collapsible-settings summary'),
            document.getElementById('auth-container'), // Pridan√Ω auth container
            authActionButton, // Pridan√© auth tlaƒçidlo
            document.getElementById('close-auth-btn'), // Pridan√© tlaƒçidlo zatvorenia auth
            ...document.querySelectorAll('table, th, td'),
            ...document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"], select'),
            ...document.querySelectorAll('.btn:not(#auth-action-btn)'), // Ostatn√© tlaƒçidl√°
            ...document.querySelectorAll('.toggle-note-btn'),
            ...document.querySelectorAll('.note-textarea')
        ];

        elementsToToggle.forEach(el => {
            if (el) { // Kontrola, ƒçi element existuje
                if (isDark) {
                    el.classList.add('dark-mode');
                } else {
                    el.classList.remove('dark-mode');
                }
            }
        });

        // ≈†peci√°lne pre auth tlaƒçidlo (aby sa zachovala farba login/logout)
        if (authActionButton) {
             if (isDark) authActionButton.classList.add('dark-mode');
             else authActionButton.classList.remove('dark-mode');
        }


        // Aplikuj ≈°peci√°lne na aktu√°lny de≈à (ak existuje)
        const currentDayRow = document.querySelector('.current-day');
        if (currentDayRow) {
            if (isDark) {
                 currentDayRow.classList.add('dark-mode');
                 currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn').forEach(el => el?.classList.add('dark-mode'));
            } else {
                currentDayRow.classList.remove('dark-mode');
                currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn').forEach(el => el?.classList.remove('dark-mode'));
            }
        }
    }


    // 13) Vytv√°ranie tabuƒæky (a s√∫visiace funkcie) - Nezmenen√© (u≈æ pracuj√∫ s glob√°lnymi premenn√Ωmi)
    function getDayName(year, month, day) { const daysOfWeek = ["Nedeƒæa", "Pondelok", "Utorok", "Streda", "≈†tvrtok", "Piatok", "Sobota"]; return daysOfWeek[new Date(year, month, day).getDay()]; }
    function createTable() { /* ... k√≥d createTable zost√°va rovnak√Ω ... */ }
    function toggleNote(day) { /* ... k√≥d toggleNote zost√°va rovnak√Ω ... */ }
    function handleNoteInput(textarea, day) { /* ... k√≥d handleNoteInput zost√°va rovnak√Ω ... */ }
    function processInputCompletion(inputId, nextId) { /* ... k√≥d processInputCompletion zost√°va rovnak√Ω (vol√° saveToLocalStorage) ... */ }
    const debouncedProcessInputCompletion = debounce(processInputCompletion, 700); // Mierne dlh≈°√≠ debounce
    function isTimeValid(timeStr) { /* ... k√≥d isTimeValid zost√°va rovnak√Ω ... */ }
    function handleInput(input, nextId, day) { /* ... k√≥d handleInput zost√°va rovnak√Ω ... */ }
    function handleBreakInput(day) { /* ... k√≥d handleBreakInput zost√°va rovnak√Ω ... */ }
    function updateMonthDataFromInput(input, day) { /* ... k√≥d updateMonthDataFromInput zost√°va rovnak√Ω ... */ }
    function formatInput(input) { /* ... k√≥d formatInput zost√°va rovnak√Ω ... */ }
    function moveNext(currentElement, nextId) { /* ... k√≥d moveNext zost√°va rovnak√Ω ... */ }
    function calculateRow(day) { /* ... k√≥d calculateRow zost√°va rovnak√Ω ... */ }
    function resetRow(day) { /* ... k√≥d resetRow zost√°va rovnak√Ω ... */ }
    function resetAll() { /* ... k√≥d resetAll zost√°va rovnak√Ω ... */ }

    // 14) V√Ωpoƒçet celkov√Ωch s√∫ƒçtov - Nezmenen√©
    function calculateTotal() { /* ... k√≥d calculateTotal zost√°va rovnak√Ω ... */ }

    // 15) Export do PDF (exportToPDF, sendPDF) - Nezmenen√© (pracuj√∫ s aktu√°lnym stavom monthData)
    function exportToPDF() { /* ... k√≥d exportToPDF zost√°va rovnak√Ω ... */ }
    function sendPDF() { /* ... k√≥d sendPDF zost√°va rovnak√Ω ... */ }

    // 16) Ostatn√© nastavenia - Nezmenen√© (u≈æ volaj√∫ debouncedProcessInputCompletion -> saveToLocalStorage)
    function changeDecimalPlaces() { /* ... k√≥d changeDecimalPlaces zost√°va rovnak√Ω ... */ }
    function updateEmployeeName() { /* ... k√≥d updateEmployeeName zost√°va rovnak√Ω ... */ }
    function updateSettings() { /* ... k√≥d updateSettings zost√°va rovnak√Ω ... */ }
    function changeMonth() { /* ... k√≥d changeMonth zost√°va rovnak√Ω ... */ }
    function changeYear() { /* ... k√≥d changeYear zost√°va rovnak√Ω ... */ }
    function handleMonthYearChange() {
        console.log(`handleMonthYearChange: Spusten√© pre ${getMonthName(currentMonth)} ${currentYear}`);
        localStorage.setItem('currentMonth', currentMonth.toString());
        localStorage.setItem('currentYear', currentYear.toString());
        // Naƒç√≠tame lok√°lne d√°ta pre nov√Ω mesiac/rok
        loadFromLocalStorage();
        // Ak sme prihl√°sen√≠, resetujeme a nastav√≠me listener pre nov√Ω dokument
        if (isLoggedIn) {
             if (firestoreListenerUnsubscribe) {
                 firestoreListenerUnsubscribe();
                 firestoreListenerUnsubscribe = null;
                 console.log("handleMonthYearChange: Predch√°dzaj√∫ci listener odhl√°sen√Ω.");
             }
             setupFirestoreListener();
        } else {
             console.log("handleMonthYearChange: Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω, listener sa nenastavuje.");
        }
    }
    function getDaysInMonth(month) { /* ... k√≥d getDaysInMonth zost√°va rovnak√Ω ... */ }
    function getMonthName(month) { /* ... k√≥d getMonthName zost√°va rovnak√Ω ... */ }
    function updateDataSize() { /* ... k√≥d updateDataSize zost√°va rovnak√Ω ... */ }
    function toggleDarkMode() { const isDarkMode = document.body.classList.toggle('dark-mode'); applyDarkMode(isDarkMode); localStorage.setItem('darkMode', JSON.stringify(isDarkMode)); saveToFirebaseIfNeeded(); } // Ulo≈æ√≠ nastavenie dark mode aj do Firebase

    // 17) Z√°lohovanie a obnova - **UPRAVEN√â** restoreBackup vol√° saveToFirebaseIfNeeded
    function createBackup() { /* ... k√≥d createBackup zost√°va rovnak√Ω (uklad√° z localStorage) ... */ }
    function restoreBackup() {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.json,application/json';
      fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const backup = JSON.parse(e.target.result);
            if (backup && typeof backup.workDaysData === 'string' /* && ostatn√© kontroly... */) {
              // Ulo≈æenie obnoven√Ωch d√°t do localStorage
              localStorage.setItem('workDaysData', backup.workDaysData);
              localStorage.setItem('hourlyWage', backup.hourlyWage);
              localStorage.setItem('taxRate', backup.taxRate);
              localStorage.setItem('darkMode', backup.darkMode);
              localStorage.setItem('decimalPlaces', backup.decimalPlaces);
              localStorage.setItem('employeeName', backup.employeeName);

              console.log("Z√°loha naƒç√≠tan√° do localStorage.");

              // Naƒç√≠tanie obnoven√Ωch d√°t do aplik√°cie a prekreslenie UI
              loadFromLocalStorage();

              showSaveNotification("Z√°loha √∫spe≈°ne obnoven√°.");
              alert("Z√°loha bola √∫spe≈°ne obnoven√°. D√°ta boli naƒç√≠tan√©.");

              // Spustenie ulo≈æenia (ktor√© zah≈ï≈àa aj Firebase, ak je pou≈æ√≠vateƒæ prihl√°sen√Ω)
              // Pou≈æijeme debounced funkciu, aby sa to ulo≈æilo s mal√Ωm oneskoren√≠m
              console.log("Sp√∫≈°≈•am debounced ulo≈æenie po obnove z√°lohy...");
              debouncedProcessInputCompletion('restore-backup', null);

            } else {
              alert("Chyba: S√∫bor z√°lohy m√° nespr√°vny form√°t alebo ch√Ωbaj√∫ d√°ta.");
            }
          } catch (error) {
            console.error("Chyba pri spracovan√≠ alebo obnove z√°lohy:", error);
            alert("Chyba pri ƒç√≠tan√≠ alebo obnove z√°lohy. S√∫bor m√¥≈æe by≈• po≈°koden√Ω alebo ma≈• nespr√°vny form√°t.");
          }
        };
        reader.onerror = (e) => {
          console.error("Chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy:", e);
          alert("Nastala chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy.");
        };
        reader.readAsText(file);
      };
      fileInput.click();
    }


    // 18) Inicializ√°cia - **UPRAVEN√â** pre nov√Ω flow
     document.addEventListener('DOMContentLoaded', () => {
         console.log("DOM naƒç√≠tan√Ω, inicializujem...");
         populateYearSelect(); // Napln√≠ roky v selecte

         // Skontrolujeme, ƒçi je service worker podporovan√Ω a zaregistrujeme ho
         if ('serviceWorker' in navigator) {
             window.addEventListener('load', () => {
                 navigator.serviceWorker.register('./service-worker.js')
                     .then(registration => { console.log('ServiceWorker zaregistrovan√Ω s rozsahom: ', registration.scope); })
                     .catch(error => { console.error('Registr√°cia ServiceWorker zlyhala: ', error); });
             });
         } else { console.warn("Service Worker nie je podporovan√Ω v tomto prehliadaƒçi."); }

         // Ostatn√° inicializ√°cia UI (napr. dark mode, welcome message) a naƒç√≠tanie d√°t
         // sa teraz deje prim√°rne v r√°mci onAuthStateChanged, ktor√Ω sa spust√≠ automaticky
         // po naƒç√≠tan√≠ Firebase kni≈æn√≠c.

         console.log("Z√°kladn√° inicializ√°cia dokonƒçen√°, ƒçak√°m na stav prihl√°senia Firebase...");
         // Nie je potrebn√© tu vola≈• loadFromLocalStorage alebo applyDarkMode,
         // preto≈æe onAuthStateChanged sa spust√≠ ƒçoskoro a urob√≠ to.
         // updateAuthActionButton() sa tie≈æ zavol√° v onAuthStateChanged.
     });

     function populateYearSelect() { const startYear = 2020; const endYear = new Date().getFullYear() + 2; yearSelect.innerHTML = ''; for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); } }

  </script>
</body>
</html>
