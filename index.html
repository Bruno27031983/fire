<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruno's Calculator s Firebase Auth (Kompletný + Úzky stĺpec)</title>
    <link rel="manifest" href="manifest.json"> <meta name="theme-color" content="#4CAF50">

    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* VLOŽENÉ CSS (z vylepšenej verzie) */
        /* Základné CSS Premenné */
        :root {
            --font-family: 'Roboto', sans-serif;
            --line-height: 1.6;
            --primary-color: #4CAF50;
            --primary-darker: #388e3c;
            --secondary-color: #8a2be2; /* Fialová pre aktuálny deň */
            --secondary-darker: #4a0e8f;
            --danger-color: #f44336;
            --danger-darker: #d32f2f;
            --warning-color: #ff9800;
            --warning-darker: #E68900;
            --info-color: #9C27B0; /* Restore button */
            --info-darker: #7B1FA2;
            --link-color-light: #007bff; /* Pre zbaliteľné nastavenia */
            --link-color-dark: #58a6ff; /* Pre zbaliteľné nastavenia v tmavom režime */


            --bg-color: #f4f4f4;
            --text-color: #333;
            --container-bg: white;
            --table-header-bg: #f2f2f2;
            --table-border-color: #ddd;
            --input-bg: #ffffd0; /* Svetložltá pre inputy */
            --input-border-color: #ccc;
            --total-salary-bg: #e6f3ff;
            --data-bar-bg: #ddd;
            --data-bar-fill: var(--primary-color);
            --shadow-color: rgba(0,0,0,0.1);
            --autor-info-color: #666;
            --link-color: var(--link-color-light); /* Použitie premennej */
            --notification-bg: var(--primary-color);
            --notification-error-bg: var(--danger-color);
            --notification-warning-bg: var(--warning-color);
            --notification-text-color: white;
            --loading-bg: white;
        }

        /* Tmavý Režim - prepis premenných */
        body.dark-mode {
            --bg-color: #333;
            --text-color: #f4f4f4;
            --container-bg: #444;
            --table-header-bg: #666;
            --table-border-color: #555;
            --input-bg: #555;
            --input-border-color: #777;
            --total-salary-bg: #2c3e50;
            --data-bar-bg: #555;
            --data-bar-fill: var(--primary-darker);
            --shadow-color: rgba(0,0,0,0.4);
            --autor-info-color: #aaa;
            --link-color: var(--link-color-dark); /* Použitie premennej */
            --notification-bg: var(--primary-darker);
            --notification-error-bg: var(--danger-darker);
            --notification-warning-bg: var(--warning-darker);
            --loading-bg: #333;
        }

        /* Základné štýly */
        body {
            font-family: var(--font-family);
            line-height: var(--line-height);
            margin: 0;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: var(--container-bg);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px var(--shadow-color);
            position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .autor-info {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 14px;
            font-style: italic;
            color: var(--autor-info-color);
        }

        /* Nadpisy */
        h1 {
            text-align: center;
            font-size: 2.5em;
            background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
            margin-bottom: 10px;
        }

        h2 {
            text-align: center;
            color: var(--text-color);
            margin-top: -10px;
            font-size: 1.2em;
            opacity: 0.8;
        }

        /* Nastavenia */
        .settings-toggle-button {
            background: none;
            border: none;
            color: var(--link-color);
            cursor: pointer;
            font-size: 1em;
            padding: 5px 0;
            margin-bottom: 10px;
            text-decoration: underline;
            display: block;
        }
        .settings-toggle-button:hover {
            opacity: 0.8;
        }

        .settings {
            margin-bottom: 20px;
        }
        #collapsible-settings-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            overflow: hidden;
            max-height: 500px;
            transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.4s ease-in-out;
            opacity: 1;
        }
        #collapsible-settings-items.hidden {
             max-height: 0;
             opacity: 0;
             margin-top: -15px;
             pointer-events: none;
        }

        #collapsible-settings-items > div {
            flex: 1 1 200px;
            min-width: 180px;
        }
         .settings-controls {
             display: flex;
             flex-wrap: wrap;
             gap: 15px;
             align-items: center;
             margin-top: 15px;
         }
         .settings-controls > div {
             flex: 1 1 200px;
             min-width: 180px;
         }

        .settings label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }

        /* Tabuľka */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            min-width: 800px;
            background-color: var(--container-bg);
            transition: background-color 0.3s ease;
            table-layout: auto; /* Alebo fixed, ak chceme striktnejšie šírky */
        }

        th, td {
            padding: 8px 10px;
            border: 1px solid var(--table-border-color);
            text-align: left;
            font-size: 0.9em;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        th {
            background-color: var(--table-header-bg);
            font-weight: bold;
        }

        /* =====> NOVÉ PRAVIDLO PRE ŠÍRKU PRVÉHO STĹPCA <===== */
        table th:first-child,
        table tbody td:first-child {
            width: 120px; /* Skús túto šírku, môžeš ju upraviť podľa potreby (napr. 110px, 130px) */
            min-width: 100px; /* Minimálna šírka, aby sa text úplne nestratil */
            box-sizing: border-box; /* Zahrnie padding a border do šírky */
            /* Ak by sa text stále zalamoval nechcene, odkomentuj nasledujúci riadok: */
            /* white-space: nowrap; */
        }
        /* =====> KONIEC NOVÉHO PRAVIDLA <===== */


        /* Aktuálny deň */
        tr.current-day {
            background-color: var(--secondary-color) !important;
            color: white;
        }
        tr.current-day td {
            border-color: var(--secondary-darker);
        }
        tr.current-day input {
            background-color: var(--secondary-darker) !important;
            color: white !important;
            border-color: var(--secondary-color) !important;
        }
        body.dark-mode tr.current-day {
             background-color: var(--secondary-darker) !important;
        }
        body.dark-mode tr.current-day input {
             background-color: var(--secondary-color) !important;
             border-color: var(--secondary-darker) !important;
        }


        /* Inputy */
        input[type="tel"], input[type="number"], input[type="text"], input[type="email"], input[type="password"], select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 14px;
            border: 1px solid var(--input-border-color);
            border-radius: 4px;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px var(--primary-color);
        }
        input[readonly] {
            background-color: #eee;
            cursor: not-allowed;
            opacity: 0.7;
        }
        body.dark-mode input[readonly] {
             background-color: #5a5a5a;
             opacity: 0.6;
        }

        /* Placeholder štýly */
        ::placeholder { color: #999; opacity: 1; }
        :-ms-input-placeholder { color: #999; }
        ::-ms-input-placeholder { color: #999; }
        body.dark-mode ::placeholder { color: #bbb; }
        body.dark-mode :-ms-input-placeholder { color: #bbb; }
        body.dark-mode ::-ms-input-placeholder { color: #bbb; }


        /* Tlačidlá */
        .btn-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            width: 100%;
            padding: 12px 20px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease;
            text-align: center;
            box-sizing: border-box;
        }
        .btn:hover { opacity: 0.9; }
        .btn:active { transform: scale(0.98); }

        .reset-btn { background-color: var(--danger-color); } .reset-btn:hover { background-color: var(--danger-darker); }
        .export-btn { background-color: var(--primary-color); } .export-btn:hover { background-color: var(--primary-darker); }
        .restore-btn { background-color: var(--info-color); } .restore-btn:hover { background-color: var(--info-darker); }
        .backup-btn { background-color: var(--warning-color); } .backup-btn:hover { background-color: var(--warning-darker); }

        .settings-controls .btn.highlight {
            background-color: var(--secondary-color);
            color: white;
            flex-grow: 0;
            min-width: 150px;
            padding: 8px 15px;
            font-size: 14px;
        }
        .settings-controls .btn.highlight:hover { background-color: var(--secondary-darker); }

        /* Celková mzda */
        #totalSalary {
            font-size: 16px;
            font-weight: normal;
            text-align: left;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--total-salary-bg);
            border-radius: 5px;
            border: 1px solid var(--table-border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #totalSalary strong {
            font-weight: bold;
            color: var(--primary-darker);
        }
        body.dark-mode #totalSalary strong { color: var(--primary-color); }

        /* Veľkosť dát */
        #dataSizeContainer { margin-top: 15px; text-align: center; }
        #dataSizeText { margin-bottom: 5px; font-size: 14px; color: var(--autor-info-color); }
        #dataSizeBar { width: 80%; max-width: 400px; height: 15px; background-color: var(--data-bar-bg); border-radius: 10px; margin: 0 auto; overflow: hidden; border: 1px solid var(--table-border-color); }
        #dataSizeFill { height: 100%; width: 0%; background-color: var(--data-bar-fill); transition: width 0.5s ease, background-color 0.3s ease; border-radius: 10px 0 0 10px; }
        #dataSizeFill.warn { background-color: var(--warning-color); }
        #dataSizeFill.danger { background-color: var(--danger-color); }
        body.dark-mode #dataSizeFill.warn { background-color: var(--warning-darker); }
        body.dark-mode #dataSizeFill.danger { background-color: var(--danger-darker); }


        /* Auth Container */
        #auth-container {
            max-width: 400px;
            margin: 30px auto;
            background: var(--container-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 15px var(--shadow-color);
            text-align: center;
            transition: background-color 0.3s ease;
        }
        #auth-container h1 { font-size: 2em; margin-bottom: 20px; }
        #auth-container h2 { font-size: 1.3em; margin-top: 25px; margin-bottom: 10px; color: var(--text-color); opacity: 0.9; }
        #auth-container input { width: 100%; padding: 12px; margin-bottom: 10px; box-sizing: border-box; }
        #auth-container button { width: 100%; padding: 12px; margin-top: 15px; border: none; background-color: var(--primary-color); color: white; font-size: 16px; font-weight: bold; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; }
        #auth-container button:hover { background-color: var(--primary-darker); }
        #auth-message { font-size: 1.1em; margin-bottom: 20px; color: var(--text-color); opacity: 0.8; }
        #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: var(--link-color); text-decoration: none; cursor: pointer; }
        #forgot-password-link:hover { text-decoration: underline; }
        #auth-loggedIn p { font-size: 1.1em; margin-bottom: 20px; color: var(--text-color); opacity: 0.8;}
        #auth-loggedIn button { margin-top: 20px; background-color: var(--danger-color); }
        #auth-loggedIn button:hover { background-color: var(--danger-darker); }


        /* Notifikácia */
        #saveNotification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--notification-bg);
            color: var(--notification-text-color);
            padding: 12px 25px;
            border-radius: 5px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease, background-color 0.3s ease;
            font-size: 15px;
        }
        #saveNotification.show { opacity: 1; visibility: visible; }
        #saveNotification.error { background-color: var(--notification-error-bg); }
        #saveNotification.warning { background-color: var(--notification-warning-bg); }

        /* Loading Container */
        #loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--loading-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }
        #loading-container h1 {
            max-width: 80%;
            font-size: 1.5em;
            text-shadow: none;
            animation: none;
            background: none;
            color: var(--text-color);
        }
        #loading-container.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        /* Animácie */
        @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }

        /* Responzivita */
        @media (max-width: 600px) {
            h1 { font-size: 1.8em; }
             #collapsible-settings-items { flex-direction: column; align-items: stretch; max-height: none; }
             #collapsible-settings-items > div { flex-basis: auto; }
             #collapsible-settings-items.hidden { display: none; }
             .settings-controls { flex-direction: column; align-items: stretch; }
             .settings-controls > div { flex-basis: auto; }
            .btn { font-size: 14px; padding: 10px 15px;}
            #totalSalary { font-size: 14px; }
            th, td { padding: 6px 8px; font-size: 0.85em; }
            #auth-container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div id="loading-container"><h1> Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte, dosiahnete všetko. </h1></div>

    <div id="auth-container" style="display:none;">
        <h1>Prihlásenie / Registrácia</h1>
        <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
        <div id="auth-forms">
            <h2>Registrácia</h2>
            <input type="email" id="registerEmail" placeholder="Email">
            <input type="password" id="registerPassword" placeholder="Heslo">
            <button onclick="register()">Registrovať</button>
            <h2>Prihlásenie</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Heslo">
            <button onclick="login()">Prihlásiť sa</button>
            <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
        </div>
         <div id="auth-loggedIn" style="display: none;">
            <p id="loggedInUserText"></p>
             <button onclick="logout()">Odhlásiť sa</button>
        </div>
    </div>

    <div id="calculator-container" class="container" style="display:none;">
        <div class="autor-info">Vytvoril Bruno</div>
        <h1 id="mainTitle">Bruno's Calculator</h1>
        <h2 id="welcomeMessage"></h2>

        <button id="settingsToggleButton" class="settings-toggle-button">Skryť nastavenia</button>

        <div class="settings">
            <div id="collapsible-settings-items">
                <div><label for="employeeNameInput">Meno pracovníka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()"></div>
                <div><label for="hourlyWageInput">Hodinová mzda (€): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div>
                <div><label for="taxRateInput">Daňové percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1" oninput="updateSettings()"></div>
                <div><label for="monthSelect">Mesiac: </label><select id="monthSelect" onchange="changeMonth()"><option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option><option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option><option value="6">Júl</option><option value="7">August</option><option value="8">September</option><option value="9">Október</option><option value="10">November</option><option value="11">December</option></select></div>
                <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div>
            </div>
             <div class="settings-controls">
                 <div><label for="decimalPlacesSelect">Počet desatinných miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2" selected>2</option></select></div>
                 <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead><tr><th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka (h)</th><th>Odpracované</th><th>Hrubá Mzda (€)</th><th>Čistá Mzda (€)</th><th>Akcia</th></tr></thead>
                <tbody id="workDays"></tbody>
            </table>
        </div>

        <div id="totalSalary"></div>

        <div id="dataSizeContainer">
            <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
            <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
        </div>

        <div class="btn-container">
            <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
            <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
            <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
            <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
            <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
            <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
        </div>
    </div>

    <div id="saveNotification"></div>

    <script>
        // --- KOMPLETNÝ JAVASCRIPT KÓD ---

        // 1. Firebase Config & Init
        const firebaseConfig = {
            apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo",
            authDomain: "bruno-3cee2.firebaseapp.com",
            projectId: "bruno-3cee2",
            storageBucket: "bruno-3cee2.appspot.com",
            messagingSenderId: "155545319308",
            appId: "1:155545319308:web:5da498ff1cd3e1833888a9"
        };
        firebase.initializeApp(firebaseConfig);
        try {
             const appCheck = firebase.appCheck();
             appCheck.activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true);
             console.log("Firebase App Check activated.");
        } catch (error) {
            console.warn("Chyba pri aktivácii Firebase App Check:", error);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 2. Povolenie Firestore Offline Persistence
        db.enablePersistence()
            .then(() => { console.log("Firestore offline persistence povolená."); })
            .catch((err) => {
                console.error("Firestore offline persistence chyba:", err.code, err.message, err);
                if (err.code == 'failed-precondition') {
                    console.warn("Firestore offline persistence: Viacnásobné otvorené taby, povolené len v jednom.");
                } else if (err.code == 'unimplemented') {
                    console.error("Firestore offline persistence: Prehliadač nie je podporovaný.");
                }
            });

        // 3. Globálne premenné
        let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
        let monthData = {};
        let firestoreListenerUnsubscribe = null;
        let settingsCollapsed = false;

        // Globálne premenné pre UI elementy
        const workDays = document.getElementById('workDays');
        const totalSalaryDiv = document.getElementById('totalSalary');
        const dataSizeText = document.getElementById('dataSizeText');
        const dataSizeFill = document.getElementById('dataSizeFill');
        const hourlyWageInput = document.getElementById('hourlyWageInput');
        const taxRateInput = document.getElementById('taxRateInput');
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
        const employeeNameInput = document.getElementById('employeeNameInput');
        const notificationArea = document.getElementById('saveNotification');
        const welcomeMessageElement = document.getElementById('welcomeMessage');
        const loadingContainer = document.getElementById('loading-container');
        const authContainer = document.getElementById('auth-container');
        const calculatorContainer = document.getElementById('calculator-container');
        const authMessage = document.getElementById('auth-message');
        const authForms = document.getElementById('auth-forms');
        const authLoggedIn = document.getElementById('auth-loggedIn');
        const loggedInUserText = document.getElementById('loggedInUserText');
        const settingsToggleButton = document.getElementById('settingsToggleButton');
        const collapsibleSettingsItems = document.getElementById('collapsible-settings-items');

        const MAX_DATA_SIZE = 4 * 1024 * 1024;
        const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

        // 4. Auth funkcie
        function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("Registrovaný:", userCredential.user);
                    showSaveNotification("Registrácia úspešná!", "success");
                })
                .catch((error) => {
                    console.error("Chyba pri registrácii:", error.message);
                    showSaveNotification("Chyba pri registrácii: " + error.message, "error");
                });
        }
        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("Prihlásený:", userCredential.user);
                     showSaveNotification("Prihlásenie úspešné!", "success");
                })
                .catch((error) => {
                    console.error("Chyba pri prihlásení:", error.message);
                     showSaveNotification("Chyba pri prihlásení: " + error.message, "error");
                });
        }
        function logout() {
            auth.signOut()
                .then(() => {
                    console.log("Odhlásený.");
                     showSaveNotification("Odhlásenie úspešné!", "success");
                })
                .catch((error) => {
                    console.error("Chyba pri odhlásení:", error.message);
                    showSaveNotification("Chyba pri odhlásení: " + error.message, "error");
                });
        }
        function forgotPassword() {
            const emailInput = document.getElementById('loginEmail');
            const email = emailInput.value;
            if (!email) {
                 showSaveNotification("Prosím, zadajte svoju e-mailovú adresu.", "warning");
                emailInput.focus();
                return;
            }
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    console.log("E-mail na obnovenie hesla odoslaný na:", email);
                    showSaveNotification("Odkaz na obnovenie hesla odoslaný. Skontrolujte si poštu (aj Spam).", "success", 6000);
                })
                .catch((error) => {
                    console.error("Chyba pri odosielaní e-mailu na obnovenie hesla:", error);
                    showSaveNotification("Chyba pri odosielaní e-mailu: " + error.message, "error");
                });
        }

        // 5. Auth State Change Listener
         auth.onAuthStateChanged(user => {
            console.log("onAuthStateChanged: Stav zistený.", user ? `Používateľ: ${user.email}` : "Žiadny používateľ.");
            if (loadingContainer) loadingContainer.classList.add('hidden');

            if (firestoreListenerUnsubscribe) {
                console.log("Odhlasujem predchádzajúci Firestore listener pri zmene Auth stavu.");
                firestoreListenerUnsubscribe();
                firestoreListenerUnsubscribe = null;
            }

            if (user) {
                authMessage.style.display = 'none';
                authForms.style.display = 'none';
                loggedInUserText.textContent = `Prihlásený: ${user.email}`;
                authLoggedIn.style.display = 'block';
                authContainer.style.display = 'none';
                calculatorContainer.style.display = 'block';

                console.log("Používateľ prihlásený, nastavujem UI a listener...");

                const storedMonth = localStorage.getItem('currentMonth');
                const storedYear = localStorage.getItem('currentYear');
                const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                const currentDate = new Date();

                currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();

                if (isNaN(currentMonth) || currentMonth < 0 || currentMonth > 11) currentMonth = currentDate.getMonth();
                if (isNaN(currentYear) || currentYear < 2000 || currentYear > currentDate.getFullYear() + 5) currentYear = currentDate.getFullYear();

                monthSelect.value = currentMonth;
                if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                    yearSelect.value = currentYear;
                } else {
                    console.warn(`Rok ${currentYear} z localStorage nenájdený v selecte, používam aktuálny rok.`);
                    currentYear = currentDate.getFullYear();
                    populateYearSelect();
                    yearSelect.value = currentYear;
                }
                applyDarkMode(darkMode);

                hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                const taxRatePercent = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) || 2;
                taxRate = taxRatePercent / 100;
                decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2;
                employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

                hourlyWageInput.value = hourlyWage;
                taxRateInput.value = taxRate * 100;
                decimalPlacesSelect.value = decimalPlaces;
                employeeNameInput.value = employeeName;

                console.log("onAuthStateChanged: Prvé volanie loadFromLocalStorage...");
                loadFromLocalStorage();
                setupFirestoreListener();

                const uid = user.uid;
                const userDocRef = db.collection("users").doc(uid);
                userDocRef.get().then(userDocSnap => {
                    if (!userDocSnap.exists) {
                        userDocRef.set({
                             email: user.email,
                             createdAt: firebase.firestore.FieldValue.serverTimestamp()
                             }, { merge: true })
                             .then(() => console.log("Vytvorený/aktualizovaný dokument pre:", uid))
                             .catch(err => console.error("Chyba pri vytváraní/aktualizácii dokumentu používateľa:", err));
                    } else {
                        console.log("Dokument používateľa existuje:", uid);
                    }
                }).catch(err => {
                    console.error("Chyba pri kontrole dokumentu používateľa (userDocRef.get):", err);
                    showSaveNotification("Chyba pri overovaní používateľských dát", "error");
                });

                 setTimeout(() => {
                    if (auth.currentUser && !navigator.onLine) {
                        console.log("onAuthStateChanged (setTimeout): Vynútené druhé volanie loadFromLocalStorage (offline)...");
                        loadFromLocalStorage();
                    } else if (auth.currentUser && navigator.onLine) {
                        console.log("onAuthStateChanged (setTimeout): Online, druhé volanie loadFromLocalStorage preskočené.");
                    }
                 }, 200);

            } else {
                authMessage.textContent = "Žiadny používateľ nie je prihlásený.";
                authMessage.style.display = 'block';
                authForms.style.display = 'block';
                authLoggedIn.style.display = 'none';
                authContainer.style.display = 'block';
                calculatorContainer.style.display = 'none';
                console.log("Používateľ odhlásený/neprihlásený.");

                monthData = {};
                workDays.innerHTML = '';
                totalSalaryDiv.innerHTML = '';
                updateWelcomeMessage();
            }
        });

        // 6. Utility funkcie
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        function showSaveNotification(message, type = 'success', duration = 3000) {
            if (!notificationArea) return;
            notificationArea.textContent = message;
            notificationArea.className = `show ${type}`;
            setTimeout(() => {
                 if (notificationArea) notificationArea.classList.remove('show');
                 setTimeout(() => { if(notificationArea) notificationArea.className = ''; }, 500);
            }, duration);
        }

        // 7. Funkcie pre pozdrav
        function getFirstName(fullName) {
            if (!fullName || typeof fullName !== 'string') return '';
            const trimmedName = fullName.trim();
            if (!trimmedName) return '';
            const parts = trimmedName.split(' ');
            return parts[0];
        }

        function updateWelcomeMessage() {
             if (!welcomeMessageElement) return;
             const firstName = getFirstName(employeeName);
             if (firstName) {
                 welcomeMessageElement.textContent = `Vitaj, ${firstName}!`;
             } else {
                 welcomeMessageElement.textContent = '';
             }
        }

        // 8. Firestore Listener
        function setupFirestoreListener() {
            if (firestoreListenerUnsubscribe) {
                 console.log("Odhlasujem predchádzajúci Firestore listener.");
                 firestoreListenerUnsubscribe();
                 firestoreListenerUnsubscribe = null;
            }
            const currentUser = auth.currentUser;
            if (!currentUser) return;
            const uid = currentUser.uid;
            if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                 console.error("setupFirestoreListener: Chýba mesiac alebo rok!"); return;
            }
            const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
            const docRef = db.doc(docPath);
            console.log(`setupFirestoreListener: Nastavujem listener pre ${docPath}`);
            firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
                console.log(`Firestore listener: Prijatý snapshot pre ${docPath}. Metadata:`, docSnap.metadata);
                const isLocalWrite = docSnap.metadata.hasPendingWrites;
                const source = docSnap.metadata.fromCache ? "cache" : "server";

                if (isLocalWrite) {
                    console.log("Listener: Detekovaná lokálna zmena (pending writes).");
                    showSaveNotification("Synchronizujem lokálne zmeny...", "warning", 1500);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const firebaseDaysData = data.days || [];
                        if (!monthData) monthData = {};
                        if (!monthData[currentYear]) monthData[currentYear] = {};
                        monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                            start: day.start || '', end: day.end || '', breakTime: day.breakTime || ''
                        }));
                    }
                    return;
                }

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log(`Listener: Dokument existuje (${source}), dáta:`, data);
                    try {
                        let settingsChanged = false;
                        let workDataChanged = false;

                        const fbWage = data.hourlyWage ?? hourlyWage;
                        const fbTaxPercent = data.taxRate ?? (taxRate * 100);
                        const fbTaxRate = fbTaxPercent / 100;
                        const fbDecimals = data.decimalPlaces ?? decimalPlaces;
                        const fbName = data.employeeName ?? employeeName;
                        const fbDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');

                        if (hourlyWage !== fbWage) { hourlyWage = fbWage; settingsChanged = true; }
                        if (taxRate !== fbTaxRate) { taxRate = fbTaxRate; settingsChanged = true; }
                        if (decimalPlaces !== fbDecimals) { decimalPlaces = fbDecimals; settingsChanged = true; }
                        if (employeeName !== fbName) { employeeName = fbName; settingsChanged = true; }
                        if (document.body.classList.contains('dark-mode') !== fbDarkMode) {
                             applyDarkMode(fbDarkMode); settingsChanged = true;
                        }

                        const firebaseDaysData = data.days || [];
                        const localDaysData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
                        if (JSON.stringify(firebaseDaysData) !== JSON.stringify(localDaysData)) {
                            workDataChanged = true;
                            console.log("Listener: Work data differs.");
                            if (!monthData) monthData = {};
                            if (!monthData[currentYear]) monthData[currentYear] = {};
                            monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                                start: day.start || '', end: day.end || '', breakTime: day.breakTime || ''
                            }));
                        }

                        if (settingsChanged || workDataChanged) {
                            console.log("Listener: Data changed, updating UI and saving to LocalStorage.");
                            if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
                            if (document.activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
                            decimalPlacesSelect.value = decimalPlaces;
                            if (document.activeElement !== employeeNameInput) employeeNameInput.value = employeeName;
                            applyDarkMode(fbDarkMode);

                            const daysInMonth = getDaysInMonth(currentMonth);
                            const activeElementId = document.activeElement?.id;
                            for (let i = 1; i <= daysInMonth; i++) {
                                const dayData = monthData[currentYear]?.[currentMonth]?.[i - 1];
                                const startId = `start-${currentYear}-${currentMonth}-${i}`;
                                const endId = `end-${currentYear}-${currentMonth}-${i}`;
                                const breakId = `break-${currentYear}-${currentMonth}-${i}`;
                                const startElement = document.getElementById(startId);
                                const endElement = document.getElementById(endId);
                                const breakElement = document.getElementById(breakId);
                                if (startElement && endElement && breakElement) {
                                    const newStart = dayData?.start || ''; const newEnd = dayData?.end || ''; const newBreak = dayData?.breakTime || '';
                                    if (startElement.value !== newStart && activeElementId !== startId) startElement.value = newStart;
                                    if (endElement.value !== newEnd && activeElementId !== endId) endElement.value = newEnd;
                                    if (breakElement.value !== newBreak && activeElementId !== breakId) breakElement.value = newBreak;
                                    calculateRow(i);
                                }
                            }
                            calculateTotal();
                            updateWelcomeMessage();
                            saveToLocalStorage(); // Ulož zlúčené dáta
                            console.log("Listener: Cielená aktualizácia UI dokončená.");
                            if (!docSnap.metadata.fromCache) {
                                console.log("Listener: Dáta prijaté zo SERVERA.");
                                showSaveNotification("Dáta synchronizované");
                            }
                        } else {
                             console.log("Listener: Data is same, no UI update needed.");
                        }
                    } catch (processError) {
                        console.error(`Listener: Chyba spracovania dát:`, processError);
                        showSaveNotification("Chyba: Nesprávny formát dát z Firebase", "error");
                    }
                } else {
                    console.log(`Listener: Dokument neexistuje (${source}) na Firebase.`);
                    hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                    taxRate = (parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100) || 0.02;
                    const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                    decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2;
                    employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
                    hourlyWageInput.value = hourlyWage;
                    taxRateInput.value = taxRate * 100;
                    decimalPlacesSelect.value = decimalPlaces;
                    employeeNameInput.value = employeeName;
                    applyDarkMode(darkMode);
                    updateWelcomeMessage();
                    if (!monthData?.[currentYear]?.[currentMonth]) {
                         createTable(); calculateTotal();
                    }
                }
            }, (error) => {
                console.error(`Firestore listener chyba:`, error);
                showSaveNotification("Chyba: Nepodarilo sa pripojiť k Firebase", "error");
                loadFromLocalStorage();
            });
        }

        // 9. Ukladanie do Firebase
        async function saveToFirebase() {
            const currentUser = auth.currentUser; if (!currentUser) return;
            if (window.isSavingToFirebase) return; window.isSavingToFirebase = true;
            try {
                const currentMonthWorkData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) ? monthData[currentYear][currentMonth] : [];
                console.log(`saveToFirebase: Ukladám ${currentMonthWorkData.length} záznamov pre ${currentYear}-${currentMonth}.`);
                const dataToSave = {
                    days: currentMonthWorkData, hourlyWage: hourlyWage || 10, taxRate: (taxRate * 100) || 2,
                    decimalPlaces: decimalPlaces || 2, employeeName: employeeName || '', darkMode: document.body.classList.contains('dark-mode'),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                const docRef = db.collection("users").doc(currentUser.uid).collection("calculatorData").doc(`${currentYear}-${currentMonth}`);
                await docRef.set(dataToSave);
                console.log(`saveToFirebase: Dáta uložené.`);
            } catch (error) {
                console.error(`Chyba pri ukladaní do Firebase:`, error);
                showSaveNotification("Chyba: Nepodarilo sa uložiť dáta do Firebase", "error");
            } finally { window.isSavingToFirebase = false; }
        }

        // 10. Debounced Save
        const debouncedProcessInputCompletion = debounce((sourceId, nextId) => {
             console.log(`Debounced save triggered by: ${sourceId}`);
             saveToLocalStorage();
             if (navigator.onLine && auth.currentUser) { saveToFirebase(); }
             else if (!navigator.onLine && auth.currentUser) { showSaveNotification("Offline: Zmeny uložené lokálne", "warning"); }
        }, 1000);

        // 11. Ukladanie do Local Storage
        function saveToLocalStorage() {
            try {
                if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
                localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
                localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                localStorage.setItem('employeeName', JSON.stringify(employeeName));
                localStorage.setItem('currentMonth', currentMonth.toString());
                localStorage.setItem('currentYear', currentYear.toString());
                const serializedMonthData = JSON.stringify(monthData);
                const bytes = new Blob([serializedMonthData]).size;
                if (bytes > MAX_DATA_SIZE * 0.9 && bytes <= MAX_DATA_SIZE) {
                     showSaveNotification(`Lokálne úložisko takmer plné (${(bytes/1024).toFixed(0)} KB / ${MAX_DATA_SIZE_KB} KB).`, "warning", 5000);
                } else if (bytes > MAX_DATA_SIZE) {
                     showSaveNotification("Chyba: Lokálne dáta sú príliš veľké!", "error", 10000); updateDataSize(); return;
                }
                localStorage.setItem('workDaysData', serializedMonthData); updateDataSize();
            } catch (error) {
                console.error('Chyba pri ukladaní do Local Storage:', error);
                showSaveNotification("Kritická chyba pri ukladaní lokálnych dát!", "error");
                if (error.name === 'QuotaExceededError') showSaveNotification("Lokálne úložisko je plné!", "error", 10000);
            }
        }

        // 12. Načítanie z Local Storage
        function loadFromLocalStorage() {
            try {
                console.log(`loadFromLocalStorage: Načítavam pre ${getMonthName(currentMonth)} ${currentYear}`);
                const storedMonthData = localStorage.getItem('workDaysData');
                monthData = storedMonthData ? JSON.parse(storedMonthData) : {};
                if (typeof monthData !== 'object' || monthData === null) { monthData = {}; }
                if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) {
                    console.log(`loadFromLocalStorage: Načítaných ${monthData[currentYear][currentMonth].length} záznamov.`);
                } else {
                    console.log(`loadFromLocalStorage: Pre ${currentYear}-${currentMonth} nenájdené záznamy.`);
                    if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                    if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
                }
                hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                taxRate = (parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100) || 0.02;
                const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2;
                employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
                updateUIFromLoadedData(darkMode);
            } catch (error) {
                console.error(`Kritická chyba pri načítavaní z localStorage:`, error);
                showSaveNotification("Chyba pri načítaní lokálnych dát!", "error");
                monthData = {}; createTable(); calculateTotal();
            }
        }

        // 13. Aktualizácia UI po načítaní
        function updateUIFromLoadedData(darkModeValue) {
            console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(currentMonth)} ${currentYear}`);
            try {
                hourlyWageInput.value = hourlyWage; taxRateInput.value = taxRate * 100;
                decimalPlacesSelect.value = decimalPlaces; employeeNameInput.value = employeeName;
                monthSelect.value = currentMonth; createTable();
                const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
                dataForCurrentMonth.forEach((day, index) => {
                    const i = index + 1;
                    const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                    const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                    const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                    if (startElement && endElement && breakElement) {
                        startElement.value = day.start || ''; endElement.value = day.end || ''; breakElement.value = day.breakTime || '';
                        calculateRow(i);
                    } else { console.error(`Chyba: Elementy pre deň ${i} nenájdené.`); }
                });
                calculateTotal(); updateDataSize(); applyDarkMode(darkModeValue); updateWelcomeMessage();
                console.log("UI aktualizované.");
            } catch (error) {
                console.error("Chyba počas aktualizácie UI:", error);
                showSaveNotification("Chyba pri prekresľovaní UI!", "error");
            }
        }

        // 14. Aplikovanie Dark Mode
        function applyDarkMode(isDark) {
             if (isDark) { document.body.classList.add('dark-mode'); }
             else { document.body.classList.remove('dark-mode'); }
        }

        // 15. Funkcie pre tabuľku a výpočty
        function getDayName(year, month, day) {
            const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"];
            return daysOfWeek[new Date(year, month, day).getDay()];
        }

        function createTable() {
            workDays.innerHTML = '';
            const daysInMonth = getDaysInMonth(currentMonth);
            const today = new Date();
            const currentDayOfMonth = today.getDate(); const currentMonthIndex = today.getMonth(); const currentYearValue = today.getFullYear();
            const fragment = document.createDocumentFragment();
            for (let i = 1; i <= daysInMonth; i++) {
                const row = document.createElement('tr');
                const isCurrentDay = (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue);
                if (isCurrentDay) row.classList.add('current-day');
                const dayName = getDayName(currentYear, currentMonth, i);
                const year = currentYear; const month = currentMonth;
                const dayData = monthData?.[year]?.[month]?.[i - 1] || { start: '', end: '', breakTime: '' };
                row.innerHTML = `
                    <td>Deň ${i} (${dayName})</td>
                    <td><input type="tel" id="start-${year}-${month}-${i}" value="${dayData.start}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${year}-${month}-${i}', ${i})"></td>
                    <td><input type="tel" id="end-${year}-${month}-${i}" value="${dayData.end}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${year}-${month}-${i}', ${i})"></td>
                    <td><input type="number" id="break-${year}-${month}-${i}" value="${dayData.breakTime}" min="0" step="0.1" placeholder="prestávka" oninput="handleBreakInput(${i})"></td>
                    <td id="total-${year}-${month}-${i}">0h 0m (${(0).toFixed(decimalPlaces || 2)} h)</td>
                    <td><input type="number" id="gross-${year}-${month}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td>
                    <td><input type="number" id="net-${year}-${month}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td>
                    <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
                `;
                fragment.appendChild(row);
            }
            workDays.appendChild(fragment);
            applyDarkMode(document.body.classList.contains('dark-mode'));
            recalculateAllRowsAndTotal();
        }

        function recalculateAllRowsAndTotal() {
            const daysInMonth = getDaysInMonth(currentMonth);
            for (let i = 1; i <= daysInMonth; i++) { calculateRow(i); }
            calculateTotal();
        }

        // --- PLNÉ TELÁ FUNKCIÍ, KTORÉ BOLI PREDTÝM SKRÁTENÉ ---

        function isTimeValid(timeStr) {
            const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
            return timeRegex.test(timeStr);
        }

        function handleInput(input, nextId, day) {
             formatInput(input); // Formátuj HH:MM
             updateMonthDataFromInput(input, day); // Ulož hodnotu do monthData
             calculateRow(day); // Prepočítaj riadok
             calculateTotal(); // Prepočítaj súčet
             debouncedProcessInputCompletion(input.id, nextId); // Spusti debouncované ukladanie
             // Pokus o presun fokusu
             if (input.value.length === 5 && isTimeValid(input.value)) {
                 moveNext(input, nextId);
             }
        }

        function handleBreakInput(day) {
            const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
            updateMonthDataFromInput(input, day); // Ulož hodnotu do monthData
            calculateRow(day); // Prepočítaj riadok
            calculateTotal(); // Prepočítaj súčet
            // Priprav ID pre ďalší deň (ak existuje)
            const nextDay = day + 1;
            let nextInputElementId = null;
            if (nextDay <= getDaysInMonth(currentMonth)) {
                nextInputElementId = `start-${currentYear}-${currentMonth}-${nextDay}`;
            }
            debouncedProcessInputCompletion(input.id, nextInputElementId); // Spusti debouncované ukladanie
        }

        function updateMonthDataFromInput(input, day) {
            if (!input) return; const dayIndex = day - 1; const fieldId = input.id; let field = 'unknown';
            if (fieldId.startsWith('start-')) field = 'start'; else if (fieldId.startsWith('end-')) field = 'end'; else if (fieldId.startsWith('break-')) field = 'breakTime';
            const value = input.value;
            if (field !== 'unknown') {
                if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
                while (monthData[currentYear][currentMonth].length <= dayIndex) { monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '' }); }
                if (monthData[currentYear][currentMonth][dayIndex]) { monthData[currentYear][currentMonth][dayIndex][field] = value; }
                else { monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', [field]: value }; }
            } else { console.warn("updateMonthDataFromInput: Nerozpoznané pole:", fieldId); }
        }

        function formatInput(input) {
            if (!input || input.type !== 'tel') return;
            let value = input.value.replace(/[^\d:]/g, '');
            if (value.length === 4 && !value.includes(':')) { value = value.slice(0, 2) + ':' + value.slice(2); }
            else if (value.length === 3 && value.charAt(2) !== ':' && parseInt(value.slice(0, 2)) <= 23) { value = value.slice(0, 2) + ':' + value.slice(2); }
            if (value.length > 5) { value = value.slice(0, 5); } input.value = value;
            input.style.border = ''; if (value.length === 5 && !isTimeValid(value)) { input.style.border = '1px solid red'; setTimeout(() => { input.style.border = ''; }, 2000); }
        }

        function moveNext(currentElement, nextId) {
             if (!nextId || !currentElement) return; const nextElement = document.getElementById(nextId);
             if (nextElement) { if (document.activeElement === currentElement) { nextElement.focus(); if (nextElement.select) { nextElement.select(); } } }
        }

        function calculateRow(day) {
            const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value;
            const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value;
            const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
            const breakTime = parseFloat(breakTimeInput?.value) || 0;
            const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
            const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
            const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
            if (!totalCell || !grossElement || !netElement) return;
            if (!startTimeStr || !endTimeStr || !isTimeValid(startTimeStr) || !isTimeValid(endTimeStr)) {
                totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 2)} h)`; grossElement.value = '0.00'; netElement.value = '0.00'; return;
            }
            try {
                const [startHours, startMinutes] = startTimeStr.split(':').map(Number); const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
                const startDate = new Date(currentYear, currentMonth, day, startHours, startMinutes); let endDate = new Date(currentYear, currentMonth, day, endHours, endMinutes);
                if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); }
                const diffMinutes = (endDate - startDate) / (1000 * 60); const breakMinutes = breakTime * 60; const workedMinutes = Math.max(0, diffMinutes - breakMinutes);
                const hours = Math.floor(workedMinutes / 60); const minutes = Math.round(workedMinutes % 60); const decimalHours = workedMinutes / 60;
                totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces || 2)} h)`;
                const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate;
                const grossSalary = decimalHours * currentHourlyWage; const netSalary = grossSalary * (1 - currentTaxRate);
                grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00'; netElement.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00';
            } catch(e) { totalCell.textContent = 'Chyba'; grossElement.value = 'N/A'; netElement.value = 'N/A'; }
        }

        function resetRow(day) {
            const dayIndex = day - 1;
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
            if (start && end && breakTime) {
                start.value = ''; end.value = ''; breakTime.value = ''; calculateRow(day); calculateTotal();
                if (monthData?.[currentYear]?.[currentMonth]?.[dayIndex]) { monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '' }; }
                debouncedProcessInputCompletion(`reset-${day}`, null); showSaveNotification(`Deň ${day} vynulovaný.`);
            }
        }

        function resetAll() {
            if (confirm(`Naozaj chcete resetovať všetky záznamy pre ${getMonthName(currentMonth)} ${currentYear}?`)) {
                if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = [];
                createTable(); calculateTotal(); debouncedProcessInputCompletion(`reset-all`, null); showSaveNotification("Dáta pre aktuálny mesiac boli resetované.");
            }
        }

        function calculateTotal() {
            let grandTotalWorkedMinutes = 0; let grandTotalGrossSalary = 0; let grandTotalNetSalary = 0; let daysWithEntries = 0;
            const rows = workDays.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const dayIndex = index + 1;
                const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`); const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`);
                const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`); const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayIndex}`);
                const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayIndex}`);
                const currentGross = grossInput ? parseFloat(grossInput.value) : 0; const currentNet = netInput ? parseFloat(netInput.value) : 0;
                if (startInput?.value || endInput?.value) { daysWithEntries++; }
                if (isFinite(currentGross)) { grandTotalGrossSalary += currentGross; } if (isFinite(currentNet)) { grandTotalNetSalary += currentNet; }
                 const startTimeStr = startInput?.value; const endTimeStr = endInput?.value;
                 if (startTimeStr && endTimeStr && isTimeValid(startTimeStr) && isTimeValid(endTimeStr)) {
                     try {
                         const breakTime = parseFloat(breakInput?.value) || 0; const [startHours, startMinutes] = startTimeStr.split(':').map(Number); const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
                         const startDate = new Date(currentYear, currentMonth, dayIndex, startHours, startMinutes); let endDate = new Date(currentYear, currentMonth, dayIndex, endHours, endMinutes);
                         if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); }
                         const diffMinutes = (endDate - startDate) / (1000 * 60); const breakMinutes = breakTime * 60; const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes);
                         grandTotalWorkedMinutes += workedMinutesForRow;
                     } catch (e) { /* ignore */ }
                 }
            });
            const grandTotalDecimalHours = grandTotalWorkedMinutes / 60; const totalHours = Math.floor(grandTotalWorkedMinutes / 60); const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60);
            const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0; const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
            const averageHours = Math.floor(averageWorkedMinutes / 60); const averageMinutes = Math.round(averageWorkedMinutes % 60); const averageDecimalHours = averageWorkedMinutes / 60;
            totalSalaryDiv.innerHTML = `Počet dní so záznamom: ${daysWithEntries}<br>Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(decimalPlaces || 2)} h)<br>Celková hrubá mzda: ${grandTotalGrossSalary.toFixed(2)} €<br>Celková čistá mzda: ${grandTotalNetSalary.toFixed(2)} €<br>Priemerná čistá mzda na deň: ${averageNetSalary.toFixed(2)} €<br><strong>Priemerný odpracovaný čas na deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(decimalPlaces || 2)} h)</strong>`;
        }

        function initializeJsPDFWithCheck() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') { showSaveNotification("Chyba: jsPDF nie je načítaná.", "error"); return null; }
            if (typeof window.jspdf.jsPDF.API?.autoTable === 'undefined') { showSaveNotification("Chyba: jsPDF-AutoTable nie je načítaný.", "error"); return null; }
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); }
            catch (e) { console.warn("PDF Font Error:", e); } return doc;
        }
        function exportToPDF() {
            const doc = initializeJsPDFWithCheck(); if (!doc) return;
            try {
                const year = currentYear; const month = currentMonth; const monthName = getMonthName(month);
                doc.setFontSize(18); doc.text(`Bruno's Calculator - Výkaz (${monthName} ${year})`, 14, 20);
                doc.setFontSize(12); doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28);
                doc.text(`Hodinová mzda: ${hourlyWage.toFixed(2)} €`, 14, 34); doc.text(`Daň (%): ${(taxRate * 100).toFixed(decimalPlaces || 2)}`, 100, 34);
                const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované", "Hrubá Mzda (€)", "Čistá Mzda (€)"]; const tableRows = [];
                const dataForCurrentMonth = (monthData && monthData[year] && monthData[year][month]) || []; const daysInMonthPDF = getDaysInMonth(month);
                for (let i = 1; i <= daysInMonthPDF; i++) {
                    const dayData = dataForCurrentMonth[i - 1] || { start: '', end: '', breakTime: '' };
                    if (dayData.start || dayData.end) {
                        const dayNum = i; const dayNameStr = getDayName(year, month, dayNum);
                        const totalCell = document.getElementById(`total-${year}-${month}-${dayNum}`); const grossInput = document.getElementById(`gross-${year}-${month}-${dayNum}`); const netInput = document.getElementById(`net-${year}-${month}-${dayNum}`);
                        const workedTimeText = totalCell ? totalCell.textContent : 'N/A'; const grossValue = grossInput ? parseFloat(grossInput.value).toFixed(2) : '0.00';
                        const netValue = netInput ? parseFloat(netInput.value).toFixed(2) : '0.00'; const breakDisplay = dayData.breakTime || '0';
                        tableRows.push([ `Deň ${dayNum} (${dayNameStr})`, dayData.start || '-', dayData.end || '-', breakDisplay, workedTimeText, grossValue, netValue ]);
                    }
                }
                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName }, styles: { font: doc.getFont().fontName, fontSize: 9 }, alternateRowStyles: { fillColor: [240, 240, 240] } });
                const finalY = doc.lastAutoTable.finalY || 40; doc.setFontSize(10);
                const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, ''); doc.text(totalTextContent, 14, finalY + 10);
                const empNamePart = employeeName ? employeeName.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'pracovnik'; const pdfFileName = `Vykaz-${empNamePart}-${monthName}-${year}.pdf`;
                doc.save(pdfFileName); showSaveNotification("PDF exportované.");
            } catch (error) { console.error("Chyba pri exportToPDF:", error); showSaveNotification("Chyba pri vytváraní PDF.", "error"); }
        }
        function sendPDF() {
            const doc = initializeJsPDFWithCheck(); if (!doc) return;
            try {
                 const year = currentYear; const month = currentMonth; const monthName = getMonthName(month);
                 doc.setFontSize(16); doc.text(`Pracovný výkaz - ${monthName} ${year}`, 14, 20);
                 doc.setFontSize(12); doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28);
                 const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)"]; const tableRows = [];
                 const dataForCurrentMonth = (monthData && monthData[year] && monthData[year][month]) || []; const daysInMonthPDF = getDaysInMonth(month);
                 for (let i = 1; i <= daysInMonthPDF; i++) {
                     const dayData = dataForCurrentMonth[i - 1] || { start: '', end: '', breakTime: '' };
                     if (dayData.start || dayData.end) {
                         const dayNum = i; const dayNameStr = getDayName(year, month, dayNum); const breakDisplay = dayData.breakTime || '0';
                         tableRows.push([ `Deň ${dayNum} (${dayNameStr})`, dayData.start || '-', dayData.end || '-', breakDisplay ]);
                     }
                 }
                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 35, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName }, styles: { font: doc.getFont().fontName, fontSize: 9 }, alternateRowStyles: { fillColor: [240, 240, 240] } });
                const finalY = doc.lastAutoTable.finalY || 35; doc.setFontSize(10);
                let daysWithEntriesText = 'N/A'; const match = totalSalaryDiv.innerHTML.match(/Počet dní so záznamom: (\d+)/);
                if (match && match[1]) { daysWithEntriesText = match[1]; } const summaryText = `Počet dní so záznamom: ${daysWithEntriesText}`; doc.text(summaryText, 14, finalY + 10);
                const pdfBlob = doc.output('blob'); const empNamePart = employeeName ? employeeName.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'pracovnik';
                const pdfFileName = `Vykaz_odoslanie-${empNamePart}-${monthName}-${year}.pdf`; const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                    navigator.share({ files: [pdfFile], title: `Pracovný výkaz ${monthName} ${year}`, text: `Výkaz pre ${employeeName || 'pracovníka'} za ${monthName} ${year}.` })
                    .then(() => { showSaveNotification("PDF pripravené na zdieľanie."); })
                    .catch((error) => { if (error.name !== 'AbortError') { showSaveNotification('Chyba zdieľania, súbor sa stiahne.', "warning"); triggerDownloadHelper(pdfBlob, pdfFileName); } });
                } else { showSaveNotification("Zdieľanie nie je podporované, súbor sa stiahne.", "info"); triggerDownloadHelper(pdfBlob, pdfFileName); }
            } catch (error) { console.error("Chyba pri sendPDF:", error); showSaveNotification("Chyba pri odosielaní PDF.", "error"); }
        }
        function triggerDownloadHelper(blob, filename) {
             const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = filename;
             document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
        }

        function changeDecimalPlaces() {
            const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
            if (!isNaN(newDecimalPlaces) && (newDecimalPlaces === 1 || newDecimalPlaces === 2)) {
                decimalPlaces = newDecimalPlaces; recalculateAllRowsAndTotal(); debouncedProcessInputCompletion('settings-change', null);
            }
        }
        function updateEmployeeName() {
            employeeName = employeeNameInput.value; updateWelcomeMessage(); debouncedProcessInputCompletion('settings-change', null);
        }
        function updateSettings() {
            let changed = false; const newHourlyWage = parseFloat(hourlyWageInput.value); const newTaxRatePercent = parseFloat(taxRateInput.value);
            if (!isNaN(newHourlyWage) && newHourlyWage >= 0 && hourlyWage !== newHourlyWage) { hourlyWage = newHourlyWage; changed = true; }
            if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) { const newTaxRateDecimal = newTaxRatePercent / 100; if (taxRate !== newTaxRateDecimal) { taxRate = newTaxRateDecimal; changed = true; } }
            if (changed) { recalculateAllRowsAndTotal(); debouncedProcessInputCompletion('settings-change', null); }
        }
        function changeMonth() {
            const selectedMonth = parseInt(monthSelect.value); if (currentMonth !== selectedMonth) { currentMonth = selectedMonth; handleMonthYearChange(); }
        }
        function changeYear() {
            const selectedYear = parseInt(yearSelect.value); if (currentYear !== selectedYear) { currentYear = selectedYear; handleMonthYearChange(); }
        }
        function handleMonthYearChange() {
             console.log(`handleMonthYearChange: ${getMonthName(currentMonth)} ${currentYear}`); localStorage.setItem('currentMonth', currentMonth.toString()); localStorage.setItem('currentYear', currentYear.toString());
             loadFromLocalStorage(); if (auth.currentUser) { setupFirestoreListener(); }
        }
        function getDaysInMonth(month) {
            if (month === undefined || month === null || currentYear === undefined || currentYear === null) return 31;
            return new Date(currentYear, month + 1, 0).getDate();
        }
        function getMonthName(month) {
            const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
            return monthNames[month] || 'Neznámy';
        }
        function updateDataSize() {
             try {
                 const totalData = Object.values(localStorage).reduce((acc, value) => acc + (value ? value.length : 0), 0); const kb = (totalData / 1024).toFixed(2); const perc = Math.min(((totalData / MAX_DATA_SIZE) * 100), 100);
                 dataSizeText.textContent = `Lokálne úložisko: ~${kb} KB / ${MAX_DATA_SIZE_KB} KB`; dataSizeFill.style.width = `${perc}%`;
                 dataSizeFill.classList.remove('warn', 'danger'); if (perc > 90) dataSizeFill.classList.add('danger'); else if (perc > 70) dataSizeFill.classList.add('warn'); else dataSizeFill.style.backgroundColor = '';
             } catch (error) { dataSizeText.textContent = "Chyba veľkosti dát."; }
        }
        function toggleDarkMode() {
            const isDarkMode = document.body.classList.toggle('dark-mode'); applyDarkMode(isDarkMode); localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
            if (auth.currentUser) { debouncedProcessInputCompletion('settings-change', null); }
        }

        // --- Funkcia pre zbaliteľné nastavenia ---
        function toggleSettingsVisibility() {
            settingsCollapsed = !settingsCollapsed;
            collapsibleSettingsItems.classList.toggle('hidden', settingsCollapsed);
            settingsToggleButton.textContent = settingsCollapsed ? 'Zobraziť nastavenia' : 'Skryť nastavenia';
            localStorage.setItem('settingsCollapsed', JSON.stringify(settingsCollapsed));
        }

        // --- Záloha a obnova ---
        function createBackup() {
            try {
                const backupData = {
                    backupVersion: 2, backupTimestamp: new Date().toISOString(), workDaysData: localStorage.getItem('workDaysData') || '{}',
                    hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(10), taxRate: localStorage.getItem('taxRate') || JSON.stringify(2),
                    darkMode: localStorage.getItem('darkMode') || JSON.stringify(false), decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(2),
                    employeeName: localStorage.getItem('employeeName') || JSON.stringify(''), currentMonth: localStorage.getItem('currentMonth') || JSON.stringify(new Date().getMonth()),
                    currentYear: localStorage.getItem('currentYear') || JSON.stringify(new Date().getFullYear())
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" }); const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; const dateStr = new Date().toISOString().slice(0, 10);
                const empNamePart = employeeName ? employeeName.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'data'; a.download = `bruno-calculator-backup-${empNamePart}-${dateStr}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showSaveNotification("Záloha úspešne vytvorená.");
            } catch (error) { console.error("Chyba pri vytváraní zálohy:", error); showSaveNotification("Chyba pri vytváraní zálohy.", "error"); }
        }
        function restoreBackup() {
            const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.json,application/json';
            fileInput.onchange = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        if (!backup || typeof backup !== 'object' || !backup.workDaysData || typeof backup.workDaysData !== 'string') throw new Error("Neplatný formát súboru.");
                        localStorage.setItem('workDaysData', backup.workDaysData); localStorage.setItem('hourlyWage', backup.hourlyWage || JSON.stringify(10));
                        localStorage.setItem('taxRate', backup.taxRate || JSON.stringify(2)); localStorage.setItem('darkMode', backup.darkMode || JSON.stringify(false));
                        localStorage.setItem('decimalPlaces', backup.decimalPlaces || JSON.stringify(2)); localStorage.setItem('employeeName', backup.employeeName || JSON.stringify(''));
                        localStorage.setItem('currentMonth', backup.currentMonth || JSON.stringify(new Date().getMonth())); localStorage.setItem('currentYear', backup.currentYear || JSON.stringify(new Date().getFullYear()));
                        currentMonth = parseInt(JSON.parse(localStorage.getItem('currentMonth'))); currentYear = parseInt(JSON.parse(localStorage.getItem('currentYear')));
                        loadFromLocalStorage(); showSaveNotification("Záloha úspešne obnovená.", "success");
                        if (auth.currentUser) { debouncedProcessInputCompletion('restore-backup', null); }
                    } catch (error) { console.error("Chyba pri obnove zálohy:", error); showSaveNotification("Chyba pri obnove zálohy: " + error.message, "error"); }
                };
                reader.onerror = (e) => { showSaveNotification("Chyba pri čítaní súboru zálohy.", "error"); }; reader.readAsText(file);
            };
            fileInput.click();
        }

        // --- Inicializácia Aplikácie ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM načítaný, inicializujem...");
            populateYearSelect();

            const initialDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false; applyDarkMode(initialDarkMode);
            const storedMonth = localStorage.getItem('currentMonth'); const storedYear = localStorage.getItem('currentYear'); const now = new Date();
            currentMonth = storedMonth !== null ? parseInt(storedMonth) : now.getMonth(); currentYear = storedYear !== null ? parseInt(storedYear) : now.getFullYear();
            if (isNaN(currentMonth) || currentMonth < 0 || currentMonth > 11) currentMonth = now.getMonth(); if (isNaN(currentYear) || currentYear < 2000 || currentYear > now.getFullYear() + 5) currentYear = now.getFullYear();
            monthSelect.value = currentMonth; yearSelect.value = currentYear; // Nastav selecty
            employeeName = JSON.parse(localStorage.getItem('employeeName')) || ''; updateWelcomeMessage(); updateDataSize();

            // Inicializácia zbaliteľných nastavení
            settingsCollapsed = JSON.parse(localStorage.getItem('settingsCollapsed')) || false;
            if (collapsibleSettingsItems) collapsibleSettingsItems.classList.toggle('hidden', settingsCollapsed); // Check if exists
            if (settingsToggleButton) {
                settingsToggleButton.textContent = settingsCollapsed ? 'Zobraziť nastavenia' : 'Skryť nastavenia';
                settingsToggleButton.addEventListener('click', toggleSettingsVisibility);
            }

            if ('serviceWorker' in navigator) {
                 window.addEventListener('load', () => {
                     navigator.serviceWorker.register('./service-worker.js')
                         .then(registration => { console.log('ServiceWorker OK: ', registration.scope); })
                         .catch(error => { console.error('ServiceWorker chyba: ', error); });
                 });
            } else { console.warn("Service Worker nie je podporovaný."); }
            console.log("Základná inicializácia dokončená, čakám na onAuthStateChanged...");
        });

        function populateYearSelect() {
            const startYear = 2020; const endYear = new Date().getFullYear() + 2; yearSelect.innerHTML = '';
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option);
            }
            // Skontroluj, či currentYear je definovaný pred nastavením hodnoty
            if (currentYear !== undefined && currentYear !== null) {
                 yearSelect.value = currentYear;
            } else {
                 // Ak nie je, nastav default (napr. aktuálny rok)
                 yearSelect.value = new Date().getFullYear();
            }
        }

    </script>

</body>
</html>
