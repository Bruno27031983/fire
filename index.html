<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Bruno's Calculator s Firebase Auth</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#4CAF50" />

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.gstatic.com" />
<link
  href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext"
  rel="stylesheet"
/>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

<!-- Štýly -->
<style>
/*  ––– základné farby a typografia ––– */
body {
  font-family: "Roboto", sans-serif;
  line-height: 1.6;
  margin: 0;
  padding: 10px;
  background: #f4f4f4;
  color: #333;
}

/*  ––– layout ––– */
.container {
  max-width: 1200px;
  margin: auto;
  background: #fff;
  padding: 15px;
  border-radius: 5px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  position: relative;
}

.autor-info {
  position: absolute;
  top: 10px;
  left: 10px;
  font-size: 14px;
  font-style: italic;
  color: #666;
}

/*  ––– hlavičky ––– */
h1 {
  text-align: center;
  font-size: 2.5em;
  background: linear-gradient(
    90deg,
    #ff0000,
    #00ff00,
    #0000ff,
    #ffff00,
    #ff00ff
  );
  background-clip: text;
  -webkit-background-clip: text;
  color: transparent;
  animation: gradientText 5s ease-in-out infinite,
    textShadowPulse 2s ease-in-out infinite;
  margin-bottom: 10px;
}
h2 {
  text-align: center;
  color: #555;
  margin-top: -10px;
  font-size: 1.2em;
}

/*  ––– nastavenia ––– */
.settings {
  margin-bottom: 20px;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: center;
}
.settings > div {
  flex: 1 1 200px;
  margin: 5px;
}
.settings label {
  display: block;
  margin-bottom: 5px;
}

/*  ––– tabuľka ––– */
.table-container {
  overflow-x: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
  min-width: 800px;
}
th,
td {
  padding: 8px;
  border: 1px solid #ddd;
  text-align: left;
  font-size: 0.9em;
}
th {
  background: #f2f2f2;
}

/*  ––– vstupy ––– */
input[type="tel"],
input[type="number"],
input[type="text"] {
  width: 100%;
  padding: 5px;
  box-sizing: border-box;
  background: #ffffd0;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 3px;
}

/*  ––– tlačidlá ––– */
.btn-container {
  display: flex;
  flex-direction: column;
  width: 100%;
  gap: 15px;
  margin-top: 20px;
}
.btn {
  width: 100%;
  padding: 15px 20px;
  color: #fff;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  transition: background-color 0.3s ease;
  text-align: center;
  box-sizing: border-box;
}
.reset-btn {
  background: #f44336;
}
.reset-btn:hover {
  background: #d32f2f;
}
.export-btn {
  background: #4caf50;
}
.export-btn:hover {
  background: #388e3c;
}
.restore-btn {
  background: #9c27b0;
}
.restore-btn:hover {
  background: #7b1fa2;
}
.backup-btn {
  background: #ffa500;
}
.backup-btn:hover {
  background: #e68900;
}
.highlight {
  background: #ffcc00;
  color: #333;
  font-weight: bold;
  border: 2px solid #ffcc00;
}

/*  ––– súčty ––– */
#totalSalary {
  font-size: 18px;
  font-weight: bold;
  text-align: center;
  margin-top: 20px;
  padding: 10px;
  background: #e6f3ff;
  border-radius: 5px;
}

/*  ––– veľkosť localStorage ––– */
#dataSizeContainer {
  margin-top: 10px;
  text-align: center;
}
#dataSizeText {
  margin-bottom: 5px;
  font-size: 14px;
  color: #555;
}
#dataSizeBar {
  width: 80%;
  height: 20px;
  background: #ddd;
  border-radius: 10px;
  margin: 0 auto;
  overflow: hidden;
}
#dataSizeFill {
  height: 100%;
  width: 0;
  background: #4caf50;
  transition: width 0.3s ease;
}

/*  ––– dnešný deň ––– */
.current-day {
  background: #8a2be2;
  color: #fff;
}
.current-day input {
  background: #9932cc;
  color: #fff;
}

/*  ––– animácie ––– */
@keyframes gradientText {
  0% {
    background-position: 0 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0 50%;
  }
}
@keyframes textShadowPulse {
  0%,
  100% {
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.5),
      0 0 20px rgba(255, 255, 255, 0.3),
      0 0 30px rgba(255, 255, 255, 0.2);
  }
  50% {
    text-shadow: 0 0 20px rgba(255, 255, 255, 1),
      0 0 30px rgba(255, 255, 255, 0.9),
      0 0 40px rgba(255, 255, 255, 0.7);
  }
}

/*  ––– dark‑mode ––– */
body.dark-mode {
  background: #333;
  color: #f4f4f4;
}
.container.dark-mode {
  background: #444;
}
table.dark-mode,
td.dark-mode,
th.dark-mode {
  background: #555;
  color: #f4f4f4;
}
input[type="tel"].dark-mode,
input[type="number"].dark-mode,
input[type="text"].dark-mode {
  background: #666;
  color: #fff;
}
.btn.dark-mode {
  color: #333;
}
.reset-btn.dark-mode {
  background: #d32f2f;
}
.export-btn.dark-mode {
  background: #388e3c;
}
.restore-btn.dark-mode {
  background: #7b1fa2;
}
.backup-btn.dark-mode {
  background: #e68900;
}
#totalSalary.dark-mode {
  background: #2c3e50;
}
.current-day.dark-mode {
  background: #4a0e8f;
}
.current-day.dark-mode input {
  background: #5c1db3;
}
body.dark-mode .autor-info {
  color: #aaa;
}

/*  ––– auth ––– */
#auth-container {
  max-width: 400px;
  margin: 20px auto;
  background: #fff;
  padding: 20px;
  border-radius: 5px;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
  text-align: center;
}
#auth-container input {
  width: 90%;
  padding: 10px;
  margin: 5px 0;
  border: 1px solid #ccc;
  border-radius: 3px;
}
#auth-container button {
  width: 95%;
  padding: 10px;
  margin: 10px 0;
  border: none;
  background: #4caf50;
  color: #fff;
  font-size: 16px;
  border-radius: 3px;
  cursor: pointer;
}
#auth-container button:hover {
  background: #45a049;
}

/*  ––– notifikácia ––– */
#saveNotification {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #4caf50;
  color: #fff;
  padding: 10px 20px;
  border-radius: 5px;
  display: none;
  z-index: 1000;
  transition: background-color 0.3s ease, opacity 0.5s ease;
}
#saveNotification.show {
  display: block;
  opacity: 1;
}
#saveNotification.error {
  background: #f44336;
}
#saveNotification.warning {
  background: #ff9800;
}

/*  ––– loader ––– */
#loading-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.5s ease-out;
}
#loading-container.hidden {
  opacity: 0;
  pointer-events: none;
}

/*  ––– zabudnuté heslo ––– */
#forgot-password-link {
  display: block;
  margin-top: 15px;
  font-size: 14px;
  color: #007bff;
  text-decoration: none;
  cursor: pointer;
}
#forgot-password-link:hover {
  text-decoration: underline;
}
</style>
</head>
<body>
<!-- Loader -->
<div id="loading-container">
  <h1>
    Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte,
    dosiahnete všetko.
  </h1>
</div>

<!-- AUTH -->
<div id="auth-container" style="display: none">
  <h1>Prihlásenie / Registrácia</h1>
  <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
  <div id="auth-forms">
    <h2>Registrácia</h2>
    <input type="email" id="registerEmail" placeholder="Email" />
    <input type="password" id="registerPassword" placeholder="Heslo" />
    <button onclick="register()">Registrovať</button>

    <h2>Prihlásenie</h2>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPassword" placeholder="Heslo" />
    <button onclick="login()">Prihlásiť sa</button>

    <a id="forgot-password-link" onclick="forgotPassword()"
      >Zabudli ste heslo?</a
    >
  </div>
</div>

<!-- KALKULAČKA -->
<div id="calculator-container" class="container" style="display: none">
  <div class="autor-info">Vytvoril Bruno</div>
  <h1 id="mainTitle">Bruno's Calculator</h1>
  <h2 id="welcomeMessage"></h2>

  <div class="settings">
    <div>
      <label for="employeeNameInput">Meno pracovníka: </label>
      <input
        type="text"
        id="employeeNameInput"
        placeholder="Zadajte meno pracovníka"
        oninput="updateEmployeeName()"
      />
    </div>
    <div>
      <label for="hourlyWageInput">Hodinová mzda (€): </label>
      <input
        type="number"
        id="hourlyWageInput"
        value="10"
        min="0"
        step="0.1"
        oninput="updateSettings()"
      />
    </div>
    <div>
      <label for="taxRateInput">Daňové percento (%): </label>
      <input
        type="number"
        id="taxRateInput"
        value="2"
        min="0"
        step="0.1"
        oninput="updateSettings()"
      />
    </div>
    <div>
      <label for="monthSelect">Mesiac: </label>
      <select id="monthSelect" onchange="changeMonth()">
        <option value="0">Január</option>
        <option value="1">Február</option>
        <option value="2">Marec</option>
        <option value="3">Apríl</option>
        <option value="4">Máj</option>
        <option value="5">Jún</option>
        <option value="6">Júl</option>
        <option value="7">August</option>
        <option value="8">September</option>
        <option value="9">Október</option>
        <option value="10">November</option>
        <option value="11">December</option>
      </select>
    </div>
    <div>
      <label for="yearSelect">Rok: </label>
      <select id="yearSelect" onchange="changeYear()"></select>
    </div>
    <div>
      <label for="decimalPlacesSelect">Počet desatinných miest: </label>
      <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
        <option value="1">1</option>
        <option value="2">2</option>
      </select>
    </div>
    <button onclick="toggleDarkMode()" class="btn highlight">
      Prepínať tmavý režim
    </button>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Deň</th>
          <th>Príchod</th>
          <th>Odchod</th>
          <th>Prestávka</th>
          <th>Odpracované</th>
          <th>Hrubá Mzda (€)</th>
          <th>Čistá Mzda (€)</th>
          <th>Akcia</th>
        </tr>
      </thead>
      <tbody id="workDays"></tbody>
    </table>
  </div>

  <div id="totalSalary"></div>

  <div id="dataSizeContainer">
    <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
    <div id="dataSizeBar">
      <div id="dataSizeFill"></div>
    </div>
  </div>

  <div class="btn-container">
    <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
    <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
    <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
    <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
    <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
    <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
  </div>
</div>

<div id="saveNotification"></div>

<!-- *************************  JAVASCRIPT  ************************* -->
<script>
/* 1. Firebase config & init */
const firebaseConfig = {
  apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo",
  authDomain: "bruno-3cee2.firebaseapp.com",
  projectId: "bruno-3cee2",
  storageBucket: "bruno-3cee2.appspot.com",
  messagingSenderId: "155545319308",
  appId: "1:155545319308:web:5da498ff1cd3e1833888a9",
};
firebase.initializeApp(firebaseConfig);
try {
  firebase.appCheck().activate("6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv", true);
} catch (e) {
  console.warn("AppCheck", e);
}
const db = firebase.firestore();
const auth = firebase.auth();

/* 2. Povolenie offline persistence */
db.enablePersistence().catch((err) =>
  console.warn("Firestore persistence", err)
);

/* 3. Globálne premenné */
let currentMonth,
  currentYear,
  decimalPlaces,
  employeeName,
  hourlyWage,
  taxRate;
let monthData = {};
let firestoreListenerUnsubscribe = null;

/* DOM referencie */
const workDays = document.getElementById("workDays");
const totalSalaryDiv = document.getElementById("totalSalary");
const dataSizeText = document.getElementById("dataSizeText");
const dataSizeFill = document.getElementById("dataSizeFill");
const hourlyWageInput = document.getElementById("hourlyWageInput");
const taxRateInput = document.getElementById("taxRateInput");
const monthSelect = document.getElementById("monthSelect");
const yearSelect = document.getElementById("yearSelect");
const decimalPlacesSelect = document.getElementById("decimalPlacesSelect");
const employeeNameInput = document.getElementById("employeeNameInput");

const MAX_DATA_SIZE = 4 * 1024 * 1024;
const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

/* 4. Auth funkcie */
function register() {
  const email = document.getElementById("registerEmail").value;
  const password = document.getElementById("registerPassword").value;
  auth
    .createUserWithEmailAndPassword(email, password)
    .then(() => alert("Registrácia úspešná!"))
    .catch((e) => alert("Chyba pri registrácii: " + e.message));
}
function login() {
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  auth
    .signInWithEmailAndPassword(email, password)
    .then(() => alert("Prihlásenie úspešné!"))
    .catch((e) => alert("Chyba pri prihlásení: " + e.message));
}
function logout() {
  auth
    .signOut()
    .then(() => alert("Odhlásenie úspešné!"))
    .catch((e) => alert("Chyba pri odhlásení: " + e.message));
}
function forgotPassword() {
  const email = document.getElementById("loginEmail").value;
  if (!email) {
    alert("Zadajte najprv email do poľa prihlásenia.");
    return;
  }
  auth
    .sendPasswordResetEmail(email)
    .then(() =>
      alert(
        "Odkaz na obnovenie hesla bol odoslaný. Skontrolujte si poštu (aj spam)."
      )
    )
    .catch((e) => alert("Chyba pri odoslaní emailu: " + e.message));
}

/* 5. Helpery */
function debounce(fn, delay) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), delay);
  };
}
function showSaveNotification(msg, type = "success") {
  const el = document.getElementById("saveNotification");
  el.textContent = msg;
  el.className = "show";
  if (type === "error") el.classList.add("error");
  if (type === "warning") el.classList.add("warning");
  setTimeout(() => el.classList.remove("show"), 3000);
}

/* 6. onAuthStateChanged */
auth.onAuthStateChanged((user) => {
  document
    .getElementById("loading-container")
    .classList.add("hidden");
  if (firestoreListenerUnsubscribe) firestoreListenerUnsubscribe();

  const authCont = document.getElementById("auth-container");
  const calcCont = document.getElementById("calculator-container");

  if (user) {
    authCont.style.display = "none";
    calcCont.style.display = "block";
    setupInitialState();
    setupFirestoreListener();
  } else {
    authCont.style.display = "block";
    calcCont.style.display = "none";
    monthData = {};
    workDays.innerHTML = "";
    totalSalaryDiv.innerHTML = "";
  }
});

/* 7. Inicializačné funkcie */
function setupInitialState() {
  const now = new Date();
  currentMonth = parseInt(localStorage.getItem("currentMonth") ?? now.getMonth());
  currentYear = parseInt(localStorage.getItem("currentYear") ?? now.getFullYear());

  monthSelect.value = currentMonth;
  populateYearSelect();
  yearSelect.value = currentYear;

  hourlyWage = parseFloat(localStorage.getItem("hourlyWage")) || 10;
  taxRate = (parseFloat(localStorage.getItem("taxRate")) || 2) / 100;
  decimalPlaces = parseInt(localStorage.getItem("decimalPlaces")) || 1;
  employeeName = localStorage.getItem("employeeName") || "";

  hourlyWageInput.value = hourlyWage;
  taxRateInput.value = taxRate * 100;
  decimalPlacesSelect.value = decimalPlaces;
  employeeNameInput.value = employeeName;

  createTable();
  loadFromLocalStorage();
  applyDarkMode(JSON.parse(localStorage.getItem("darkMode")) || false);
  updateWelcomeMessage();
}

/* 8. Firestore listener – vrátane cache‑fetch */
function setupFirestoreListener() {
  const uid = auth.currentUser?.uid;
  if (!uid) return;
  const docRef = db.doc(
    `users/${uid}/calculatorData/${currentYear}-${currentMonth}`
  );

  // najprv pokus o cache
  docRef
    .get({ source: "cache" })
    .then((snap) => snap.exists && applyFirestoreData(snap.data()));

  // realtime listener
  firestoreListenerUnsubscribe = docRef.onSnapshot(
    (snap) => snap.exists && applyFirestoreData(snap.data()),
    (err) => {
      console.error("listener", err);
      showSaveNotification("Firebase listener chyba", "error");
    }
  );
}

/* 9. Aplikuj dáta z Firestore */
function applyFirestoreData(data) {
  hourlyWage = data.hourlyWage ?? hourlyWage;
  taxRate = (data.taxRate ?? taxRate * 100) / 100;
  decimalPlaces = data.decimalPlaces ?? decimalPlaces;
  employeeName = data.employeeName ?? employeeName;
  const darkMode = data.darkMode ?? false;
  monthData[currentYear] = {
    ...monthData[currentYear],
    [currentMonth]: data.days || [],
  };

  hourlyWageInput.value = hourlyWage;
  taxRateInput.value = taxRate * 100;
  decimalPlacesSelect.value = decimalPlaces;
  employeeNameInput.value = employeeName;

  localStorage.setItem("hourlyWage", hourlyWage);
  localStorage.setItem("taxRate", taxRate * 100);
  localStorage.setItem("decimalPlaces", decimalPlaces);
  localStorage.setItem("employeeName", employeeName);
  localStorage.setItem("darkMode", darkMode);
  localStorage.setItem("workDaysData", JSON.stringify(monthData));

  createTable();
  renderDays();
  calculateTotal();
  applyDarkMode(darkMode);
  updateWelcomeMessage();
}

/* 10. Tvorba tabuľky */
function createTable() {
  workDays.innerHTML = "";
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const today = new Date();
  for (let i = 1; i <= daysInMonth; i++) {
    const tr = document.createElement("tr");
    if (
      i === today.getDate() &&
      currentMonth === today.getMonth() &&
      currentYear === today.getFullYear()
    )
      tr.classList.add("current-day");

    tr.innerHTML = `
      <td>Deň ${i}</td>
      <td><input type="tel" id="start-${i}" maxlength="5" placeholder="HH:MM" oninput="handleInput(this, ${i})"></td>
      <td><input type="tel" id="end-${i}" maxlength="5" placeholder="HH:MM" oninput="handleInput(this, ${i})"></td>
      <td><input type="number" id="break-${i}" min="0" step="0.5" placeholder="prestávka" oninput="handleBreak(${i})"></td>
      <td id="total-${i}">0h 0m (0.0 h)</td>
      <td><input type="number" id="gross-${i}" readonly></td>
      <td><input type="number" id="net-${i}" readonly></td>
      <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>`;
    workDays.appendChild(tr);
  }
  applyDarkMode(document.body.classList.contains("dark-mode"));
}

/* 11. Vykreslenie uložených dní */
function renderDays() {
  const list = monthData[currentYear]?.[currentMonth] || [];
  list.forEach((d, idx) => {
    const i = idx + 1;
    document.getElementById(`start-${i}`).value = d.start || "";
    document.getElementById(`end-${i}`).value = d.end || "";
    document.getElementById(`break-${i}`).value = d.breakTime || "";
    calculateRow(i);
  });
}

/* 12. Input handling */
function handleInput(el, day) {
  formatTime(el);
  updateDayData(day);
  calculateRow(day);
  debouncedSave();
}
function handleBreak(day) {
  updateDayData(day);
  calculateRow(day);
  debouncedSave();
}
const debouncedSave = debounce(saveEverything, 500);

/* 13. Aktualizuj struktúru monthData */
function updateDayData(day) {
  const index = day - 1;
  if (!monthData[currentYear]) monthData[currentYear] = {};
  if (!monthData[currentYear][currentMonth])
    monthData[currentYear][currentMonth] = [];
  while (monthData[currentYear][currentMonth].length <= index)
    monthData[currentYear][currentMonth].push({
      start: "",
      end: "",
      breakTime: "",
    });

  monthData[currentYear][currentMonth][index] = {
    start: document.getElementById(`start-${day}`).value,
    end: document.getElementById(`end-${day}`).value,
    breakTime: document.getElementById(`break-${day}`).value,
  };
}

/* 14. Preformátuj čas */
function formatTime(el) {
  let v = el.value.replace(/[^\d:]/g, "");
  if (v.length === 4 && !v.includes(":")) v = v.slice(0, 2) + ":" + v.slice(2);
  if (v.length > 5) v = v.slice(0, 5);
  el.value = v;
}

/* 15. Výpočet riadku */
function calculateRow(day) {
  const start = document.getElementById(`start-${day}`).value;
  const end = document.getElementById(`end-${day}`).value;
  const br = parseFloat(document.getElementById(`break-${day}`).value) || 0;

  const totalCell = document.getElementById(`total-${day}`);
  const grossEl = document.getElementById(`gross-${day}`);
  const netEl = document.getElementById(`net-${day}`);

  if (!/^\d{2}:\d{2}$/.test(start) || !/^\d{2}:\d{2}$/.test(end)) {
    totalCell.textContent = "0h 0m (0.0 h)";
    grossEl.value = netEl.value = "";
    return;
  }

  const [sh, sm] = start.split(":").map(Number);
  const [eh, em] = end.split(":").map(Number);
  let mins = (eh * 60 + em) - (sh * 60 + sm);
  if (mins < 0) mins += 24 * 60;
  mins = Math.max(0, mins - br * 60);

  const h = Math.floor(mins / 60);
  const m = mins % 60;
  const dec = mins / 60;

  totalCell.textContent = `${h}h ${m}m (${dec.toFixed(decimalPlaces)} h)`;
  const gross = dec * hourlyWage;
  const net = gross * (1 - taxRate);
  grossEl.value = gross.toFixed(2);
  netEl.value = net.toFixed(2);
}

/* 16. Celkové súčty */
function calculateTotal() {
  let mins = 0,
    days = 0;
  const rows = document.querySelectorAll("tbody tr");
  rows.forEach((tr, idx) => {
    const [start, end] = [
      document.getElementById(`start-${idx + 1}`).value,
      document.getElementById(`end-${idx + 1}`).value,
    ];
    const br = parseFloat(
      document.getElementById(`break-${idx + 1}`).value
    ) || 0;
    if (/^\\d{2}:\\d{2}$/.test(start) && /^\\d{2}:\\d{2}$/.test(end)) {
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      let diff = eh * 60 + em - (sh * 60 + sm);
      if (diff < 0) diff += 24 * 60;
      diff = Math.max(0, diff - br * 60);
      mins += diff;
      if (diff) days++;
    }
  });
  const dec = mins / 60;
  const gross = dec * hourlyWage;
  const net = gross * (1 - taxRate);
  const avgNet = days ? net / days : 0;

  const h = Math.floor(mins / 60);
  const m = mins % 60;
  totalSalaryDiv.innerHTML = `
    Počet odpracovaných dní: ${days}<br>
    Celkový odpracovaný čas: ${h}h ${m}m (${dec.toFixed(decimalPlaces)} h)<br>
    Celková hrubá mzda: ${gross.toFixed(2)}€<br>
    Celková čistá mzda: ${net.toFixed(2)}€<br>
    Priemerná čistá mzda na deň: ${avgNet.toFixed(2)}€
  `;
}

/* 17.  Ukladanie */
function saveEverything() {
  localStorage.setItem("workDaysData", JSON.stringify(monthData));
  localStorage.setItem("hourlyWage", hourlyWage);
  localStorage.setItem("taxRate", taxRate * 100);
  localStorage.setItem("decimalPlaces", decimalPlaces);
  localStorage.setItem("employeeName", employeeName);
  localStorage.setItem("currentMonth", currentMonth);
  localStorage.setItem("currentYear", currentYear);
  updateDataSize();
  saveToFirebase();
}
function saveToFirebase() {
  const user = auth.currentUser;
  if (!user) return;

  const data = {
    days: monthData[currentYear]?.[currentMonth] || [],
    hourlyWage,
    taxRate: taxRate * 100,
    decimalPlaces,
    employeeName,
    darkMode: document.body.classList.contains("dark-mode"),
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
  };
  db.doc(
    `users/${user.uid}/calculatorData/${currentYear}-${currentMonth}`
  ).set(data);
}

/* 18.  ––– ďalšie util funkcie (reset, backup, export, dark‑mode …) ––– */
/* ... (pridaj svoje pôvodné funkcie, ak ich potrebuješ) ... */

/* 19. DOMContentLoaded – offline poistka */
document.addEventListener("DOMContentLoaded", () => {
  populateYearSelect();
  loadFromLocalStorage();
  setTimeout(() => {
    if (!navigator.onLine) {
      document
        .getElementById("loading-container")
        .classList.add("hidden");
      document
        .getElementById("calculator-container")
        .style.display = "block";
    }
  }, 500);

  if ("serviceWorker" in navigator)
    window.addEventListener("load", () =>
      navigator.serviceWorker
        .register("./service-worker.js")
        .catch((e) => console.warn("SW", e))
    );
});

/* 20. Pomocné */
function populateYearSelect() {
  const start = 2020;
  const end = new Date().getFullYear() + 2;
  yearSelect.innerHTML = "";
  for (let y = start; y <= end; y++) {
    yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
  }
}
function loadFromLocalStorage() {
  monthData = JSON.parse(localStorage.getItem("workDaysData") || "{}");
  renderDays();
  calculateTotal();
}
function applyDarkMode(on) {
  document.body.classList.toggle("dark-mode", on);
}
function toggleDarkMode() {
  const on = !document.body.classList.contains("dark-mode");
  applyDarkMode(on);
  localStorage.setItem("darkMode", on);
}
function updateWelcomeMessage() {
  const first = employeeName.trim().split(" ")[0] || "";
  document.getElementById("welcomeMessage").textContent = first
    ? `Vitaj, ${first}!`
    : "";
}
function updateEmployeeName() {
  employeeName = employeeNameInput.value;
  updateWelcomeMessage();
  debouncedSave();
}
function updateSettings() {
  hourlyWage = parseFloat(hourlyWageInput.value) || 0;
  taxRate = (parseFloat(taxRateInput.value) || 0) / 100;
  calculateTotal();
  debouncedSave();
}
function changeMonth() {
  currentMonth = parseInt(monthSelect.value);
  localStorage.setItem("currentMonth", currentMonth);
  createTable();
  renderDays();
  calculateTotal();
  setupFirestoreListener();
}
function changeYear() {
  currentYear = parseInt(yearSelect.value);
  localStorage.setItem("currentYear", currentYear);
  createTable();
  renderDays();
  calculateTotal();
  setupFirestoreListener();
}
function changeDecimalPlaces() {
  decimalPlaces = parseInt(decimalPlacesSelect.value);
  calculateTotal();
  debouncedSave();
}

/* ... doplň ďalšie pôvodné funkcie (resetAll, backup, exportToPDF atď.) ... */
</script>
</body>
</html>
