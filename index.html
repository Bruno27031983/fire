<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <!-- Načítanie písma Roboto z Google Fonts (externá knižnica) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase knižnice -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <!-- Pridaná knižnica pre Firebase App Check -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF a autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; }
    .settings > div { flex: 1 1 200px; margin: 5px; }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 800px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%,100% { text-shadow:0 0 10px rgba(255,255,255,0.5),0 0 20px rgba(255,255,255,0.3),0 0 30px rgba(255,255,255,0.2); } 50% { text-shadow:0 0 20px rgba(255,255,255,1),0 0 30px rgba(255,255,255,0.9),0 0 40px rgba(255,255,255,0.7); } }
    /* ... plus dark-mode a autor-info, auth-container, saveNotification, loading-container štýly ... */
  </style>
</head>
<body>
  <div id="loading-container"><h1>Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte, dosiahnete všetko.</h1></div>

  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>

  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>
    <!-- nastavenia, tabuľka dní, tlačidlá, výstupy, dátová veľkosť -->
  </div>

  <div id="saveNotification"></div>

  <script>
    // 1. Firebase Config & Init
    const firebaseConfig = {
      apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo",
      authDomain: "bruno-3cee2.firebaseapp.com",
      projectId: "bruno-3cee2",
      storageBucket: "bruno-3cee2.appspot.com",
      messagingSenderId: "155545319308",
      appId: "1:155545319308:web:5da498ff1cd3e1833888a9"
    };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); }
    catch (e) { console.warn("App Check:", e); }
    const db = firebase.firestore(), auth = firebase.auth();
    db.enablePersistence().catch(err => console.error("Persistence:", err));

    // 2. Globálne premenné
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
    let monthData = {}, firestoreListenerUnsubscribe = null;
    const workDays=document.getElementById('workDays'),
          totalSalaryDiv=document.getElementById('totalSalary'),
          dataSizeText=document.getElementById('dataSizeText'),
          dataSizeFill=document.getElementById('dataSizeFill'),
          hourlyWageInput=document.getElementById('hourlyWageInput'),
          taxRateInput=document.getElementById('taxRateInput'),
          monthSelect=document.getElementById('monthSelect'),
          yearSelect=document.getElementById('yearSelect'),
          decimalPlacesSelect=document.getElementById('decimalPlacesSelect'),
          employeeNameInput=document.getElementById('employeeNameInput'),
          MAX_DATA_SIZE=4*1024*1024, MAX_DATA_SIZE_KB=MAX_DATA_SIZE/1024;

    // 3. Auth funkcie
    function register(){ /*...*/ }
    function login(){ /*...*/ }
    function logout(){ /*...*/ }
    function forgotPassword(){ /*...*/ }

    // 4. Auth State Change + železobetónové load-from-local fallback
    auth.onAuthStateChanged(user=>{
      const ac=document.getElementById('auth-container'),
            cc=document.getElementById('calculator-container'),
            lc=document.getElementById('loading-container');
      if(lc) lc.classList.add('hidden');
      if(firestoreListenerUnsubscribe){ firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe=null; }
      if(user){
        document.getElementById('auth-message').textContent="Prihlásený: "+user.email;
        ac.style.display='none'; cc.style.display='block';
        // načítaj lokálne
        loadFromLocalStorage();
        // nastav listener
        setupFirestoreListener();
        // železobetónová poistka
        setTimeout(()=>{
          if(auth.currentUser && !navigator.onLine){
            console.log("Offline fallback");
            loadFromLocalStorage();
          }
        },150);
      } else {
        ac.style.display='block'; cc.style.display='none';
        monthData={}; workDays.innerHTML=''; totalSalaryDiv.innerHTML='';
        updateWelcomeMessage();
      }
    });

    // 5. loadFromLocalStorage
    function loadFromLocalStorage(){
      try{
        const d=localStorage.getItem('workDaysData');
        monthData=d?JSON.parse(d):{};
        console.log("Načítané lokálne",monthData);
        // vykresli data do UI
        updateUIFromLoadedData(JSON.parse(localStorage.getItem('darkMode'))||false);
      }catch(e){ console.error("LO lokalStorage:",e); }
    }

    // 6. setupFirestoreListener
    function setupFirestoreListener(){
      const uid=auth.currentUser.uid;
      if(!uid) return;
      if(currentMonth==null||currentYear==null){
        const now=new Date();
        currentMonth=currentMonth||now.getMonth();
        currentYear=currentYear||now.getFullYear();
      }
      const path=`users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
      firestoreListenerUnsubscribe=db.doc(path).onSnapshot(doc=>{
        if(doc.exists && !doc.metadata.hasPendingWrites){
          const data=doc.data();
          // synchronizuj monthData
          if(!monthData[currentYear]) monthData[currentYear]={};
          monthData[currentYear][currentMonth]=data.days||[];
          localStorage.setItem('workDaysData',JSON.stringify(monthData));
          // uloz nastavenia
          localStorage.setItem('hourlyWage',JSON.stringify(data.hourlyWage));
          localStorage.setItem('taxRate',JSON.stringify(data.taxRate));
          localStorage.setItem('decimalPlaces',JSON.stringify(data.decimalPlaces));
          localStorage.setItem('employeeName',JSON.stringify(data.employeeName));
          localStorage.setItem('darkMode',JSON.stringify(data.darkMode));
          // aktualizuj UI
          updateUIFromLoadedData(data.darkMode);
        } else {
          console.log("Snapshot neexistuje alebo je lokálny, fallback na lokálne");
          loadFromLocalStorage();
        }
      },err=>{
        console.error("Firestore listener:",err);
        loadFromLocalStorage();
      });
    }

    // 7. UI a pomocné funkcie (compute, vytvorenie tabuľky, updateWelcomeMessage, etc.)
    // ... priamo zakomponované z predchádzajúcej verzie kódu ...

    // 8. Inicializácia pri načítaní
    document.addEventListener('DOMContentLoaded',()=>{
      populateYearSelect();
      applyDarkMode(JSON.parse(localStorage.getItem('darkMode'))||false);
      updateWelcomeMessage();
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('./service-worker.js').catch(e=>console.error(e));
      }
    });

    function populateYearSelect(){
      const start=2020, end=new Date().getFullYear()+2;
      yearSelect.innerHTML='';
      for(let y=start;y<=end;y++){
        const opt=document.createElement('option');
        opt.value=y; opt.textContent=y;
        yearSelect.appendChild(opt);
      }
    }
  </script>
</body>
</html>
