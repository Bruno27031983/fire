<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruno's Calculator s Firebase Auth (Všetko v jednom)</title>
    <link rel="manifest" href="manifest.json"> <meta name="theme-color" content="#4CAF50">

    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* VLOŽENÉ CSS (z vylepšenej verzie) */
        /* Základné CSS Premenné */
        :root {
            --font-family: 'Roboto', sans-serif;
            --line-height: 1.6;
            --primary-color: #4CAF50;
            --primary-darker: #388e3c;
            --secondary-color: #8a2be2; /* Fialová pre aktuálny deň */
            --secondary-darker: #4a0e8f;
            --danger-color: #f44336;
            --danger-darker: #d32f2f;
            --warning-color: #ff9800;
            --warning-darker: #E68900;
            --info-color: #9C27B0; /* Restore button */
            --info-darker: #7B1FA2;

            --bg-color: #f4f4f4;
            --text-color: #333;
            --container-bg: white;
            --table-header-bg: #f2f2f2;
            --table-border-color: #ddd;
            --input-bg: #ffffd0; /* Svetložltá pre inputy */
            --input-border-color: #ccc;
            --total-salary-bg: #e6f3ff;
            --data-bar-bg: #ddd;
            --data-bar-fill: var(--primary-color);
            --shadow-color: rgba(0,0,0,0.1);
            --autor-info-color: #666;
            --link-color: #007bff;
            --notification-bg: var(--primary-color);
            --notification-error-bg: var(--danger-color);
            --notification-warning-bg: var(--warning-color);
            --notification-text-color: white;
            --loading-bg: white;
        }

        /* Tmavý Režim - prepis premenných */
        body.dark-mode {
            --bg-color: #333;
            --text-color: #f4f4f4;
            --container-bg: #444;
            --table-header-bg: #666;
            --table-border-color: #555;
            --input-bg: #555;
            --input-border-color: #777;
            --total-salary-bg: #2c3e50;
            --data-bar-bg: #555;
            --data-bar-fill: var(--primary-darker);
            --shadow-color: rgba(0,0,0,0.4);
            --autor-info-color: #aaa;
            --link-color: #58a6ff;
            --notification-bg: var(--primary-darker);
            --notification-error-bg: var(--danger-darker);
            --notification-warning-bg: var(--warning-darker);
            --loading-bg: #333;
        }

        /* Základné štýly */
        body {
            font-family: var(--font-family);
            line-height: var(--line-height);
            margin: 0;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: var(--container-bg);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px var(--shadow-color);
            position: relative;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .autor-info {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 14px;
            font-style: italic;
            color: var(--autor-info-color);
        }

        /* Nadpisy */
        h1 {
            text-align: center;
            font-size: 2.5em;
            background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
            margin-bottom: 10px;
        }

        h2 {
            text-align: center;
            color: var(--text-color);
            margin-top: -10px;
            font-size: 1.2em;
            opacity: 0.8;
        }

        /* Nastavenia */
        .settings {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Medzera medzi prvkami */
            align-items: center;
        }

        .settings > div {
            flex: 1 1 200px; /* Flexibilné rozloženie */
            min-width: 180px; /* Minimálna šírka pre lepšie zobrazenie */
        }

        .settings label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }

        /* Tabuľka */
        .table-container {
            overflow-x: auto; /* Horizontálne scrollovanie na menších obrazovkách */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            min-width: 800px; /* Minimálna šírka pre zobrazenie všetkých stĺpcov */
            background-color: var(--container-bg); /* Aby tabuľka mala rovnaké pozadie */
            transition: background-color 0.3s ease;
        }

        th, td {
            padding: 8px 10px; /* Mierne väčší padding */
            border: 1px solid var(--table-border-color);
            text-align: left;
            font-size: 0.9em;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        th {
            background-color: var(--table-header-bg);
            font-weight: bold;
        }

        /* Aktuálny deň */
        tr.current-day {
            background-color: var(--secondary-color) !important; /* Výraznejšie pozadie */
            color: white;
        }
        tr.current-day td {
            border-color: var(--secondary-darker);
        }
        tr.current-day input {
            background-color: var(--secondary-darker) !important; /* Tmavšie fialové inputy */
            color: white !important;
            border-color: var(--secondary-color) !important;
        }
        /* Oprava pre tmavý režim aktuálneho dňa */
        body.dark-mode tr.current-day {
             background-color: var(--secondary-darker) !important;
        }
        body.dark-mode tr.current-day input {
             background-color: var(--secondary-color) !important;
             border-color: var(--secondary-darker) !important;
        }


        /* Inputy */
        input[type="tel"], input[type="number"], input[type="text"], input[type="email"], input[type="password"], select {
            width: 100%;
            padding: 8px; /* Väčší padding */
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 14px;
            border: 1px solid var(--input-border-color);
            border-radius: 4px; /* Mierne zaoblené rohy */
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px var(--primary-color);
        }
        /* Readonly inputy */
        input[readonly] {
            background-color: #eee; /* Svetlo sivé pozadie */
            cursor: not-allowed;
            opacity: 0.7;
        }
        body.dark-mode input[readonly] {
             background-color: #5a5a5a;
             opacity: 0.6;
        }

        /* Placeholder štýly */
        ::placeholder { color: #999; opacity: 1; }
        :-ms-input-placeholder { color: #999; }
        ::-ms-input-placeholder { color: #999; }
        body.dark-mode ::placeholder { color: #bbb; }
        body.dark-mode :-ms-input-placeholder { color: #bbb; }
        body.dark-mode ::-ms-input-placeholder { color: #bbb; }


        /* Tlačidlá */
        .btn-container {
            display: flex;
            flex-direction: column; /* Tlačidlá pod sebou */
            width: 100%;
            gap: 10px; /* Medzera medzi tlačidlami */
            margin-top: 20px;
        }

        .btn {
            width: 100%;
            padding: 12px 20px; /* Upravený padding */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease;
            text-align: center;
            box-sizing: border-box;
        }
        .btn:hover { opacity: 0.9; }
        .btn:active { transform: scale(0.98); }

        .reset-btn { background-color: var(--danger-color); } .reset-btn:hover { background-color: var(--danger-darker); }
        .export-btn { background-color: var(--primary-color); } .export-btn:hover { background-color: var(--primary-darker); }
        .restore-btn { background-color: var(--info-color); } .restore-btn:hover { background-color: var(--info-darker); }
        .backup-btn { background-color: var(--warning-color); } .backup-btn:hover { background-color: var(--warning-darker); }

        /* Tlačidlo pre tmavý režim v nastaveniach */
        .settings .btn.highlight { /* Zmena selektora pre jednoduchosť */
            background-color: var(--secondary-color);
            color: white;
            flex-grow: 0;
            min-width: 150px;
            padding: 8px 15px;
            font-size: 14px;
        }
        .settings .btn.highlight:hover { background-color: var(--secondary-darker); }

        /* Celková mzda */
        #totalSalary {
            font-size: 16px;
            font-weight: normal;
            text-align: left;
            margin-top: 20px;
            padding: 15px;
            background-color: var(--total-salary-bg);
            border-radius: 5px;
            border: 1px solid var(--table-border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #totalSalary strong {
            font-weight: bold;
            color: var(--primary-darker);
        }
        body.dark-mode #totalSalary strong { color: var(--primary-color); }

        /* Veľkosť dát */
        #dataSizeContainer { margin-top: 15px; text-align: center; }
        #dataSizeText { margin-bottom: 5px; font-size: 14px; color: var(--autor-info-color); }
        #dataSizeBar { width: 80%; max-width: 400px; height: 15px; background-color: var(--data-bar-bg); border-radius: 10px; margin: 0 auto; overflow: hidden; border: 1px solid var(--table-border-color); }
        #dataSizeFill { height: 100%; width: 0%; background-color: var(--data-bar-fill); transition: width 0.5s ease, background-color 0.3s ease; border-radius: 10px 0 0 10px; }
        /* Farby pre data size bar */
        #dataSizeFill.warn { background-color: var(--warning-color); }
        #dataSizeFill.danger { background-color: var(--danger-color); }
        body.dark-mode #dataSizeFill.warn { background-color: var(--warning-darker); }
        body.dark-mode #dataSizeFill.danger { background-color: var(--danger-darker); }


        /* Auth Container */
        #auth-container {
            max-width: 400px;
            margin: 30px auto;
            background: var(--container-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 15px var(--shadow-color);
            text-align: center;
            transition: background-color 0.3s ease;
        }
        #auth-container h1 { font-size: 2em; margin-bottom: 20px; }
        #auth-container h2 { font-size: 1.3em; margin-top: 25px; margin-bottom: 10px; color: var(--text-color); opacity: 0.9; }
        #auth-container input { width: 100%; padding: 12px; margin-bottom: 10px; box-sizing: border-box; }
        #auth-container button { width: 100%; padding: 12px; margin-top: 15px; border: none; background-color: var(--primary-color); color: white; font-size: 16px; font-weight: bold; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; }
        #auth-container button:hover { background-color: var(--primary-darker); }
        #auth-message { font-size: 1.1em; margin-bottom: 20px; color: var(--text-color); opacity: 0.8; }
        #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: var(--link-color); text-decoration: none; cursor: pointer; }
        #forgot-password-link:hover { text-decoration: underline; }
        #auth-loggedIn p { font-size: 1.1em; margin-bottom: 20px; color: var(--text-color); opacity: 0.8;}
        #auth-loggedIn button { margin-top: 20px; background-color: var(--danger-color); }
        #auth-loggedIn button:hover { background-color: var(--danger-darker); }


        /* Notifikácia (Používa sa #saveNotification z pôvodného JS) */
        #saveNotification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--notification-bg);
            color: var(--notification-text-color);
            padding: 12px 25px;
            border-radius: 5px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease, background-color 0.3s ease;
            font-size: 15px;
        }
        #saveNotification.show { opacity: 1; visibility: visible; }
        #saveNotification.error { background-color: var(--notification-error-bg); }
        #saveNotification.warning { background-color: var(--notification-warning-bg); }

        /* Loading Container */
        #loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--loading-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }
        #loading-container h1 {
            max-width: 80%;
            font-size: 1.5em;
            text-shadow: none;
            animation: none;
            background: none;
            color: var(--text-color); /* Použije farbu textu z témy */
        }
        #loading-container.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        /* Animácie */
        @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }

        /* Responzivita */
        @media (max-width: 600px) {
            h1 { font-size: 1.8em; }
            .settings { flex-direction: column; align-items: stretch; }
            .settings > div { flex-basis: auto; }
            .btn { font-size: 14px; padding: 10px 15px;}
            #totalSalary { font-size: 14px; }
            th, td { padding: 6px 8px; font-size: 0.85em; }
            #auth-container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div id="loading-container"><h1> Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte, dosiahnete všetko. </h1></div>

    <div id="auth-container" style="display:none;">
        <h1>Prihlásenie / Registrácia</h1>
        <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
        <div id="auth-forms">
            <h2>Registrácia</h2>
            <input type="email" id="registerEmail" placeholder="Email">
            <input type="password" id="registerPassword" placeholder="Heslo">
            <button onclick="register()">Registrovať</button> <h2>Prihlásenie</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Heslo">
            <button onclick="login()">Prihlásiť sa</button> <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a> </div>
         <div id="auth-loggedIn" style="display: none;"> <p id="loggedInUserText"></p> <button onclick="logout()">Odhlásiť sa</button> </div>
    </div>

    <div id="calculator-container" class="container" style="display:none;">
        <div class="autor-info">Vytvoril Bruno</div>
        <h1 id="mainTitle">Bruno's Calculator</h1>
        <h2 id="welcomeMessage"></h2> <div class="settings">
            <div><label for="employeeNameInput">Meno pracovníka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()"></div>
            <div><label for="hourlyWageInput">Hodinová mzda (€): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div>
            <div><label for="taxRateInput">Daňové percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1" oninput="updateSettings()"></div>
            <div><label for="monthSelect">Mesiac: </label><select id="monthSelect" onchange="changeMonth()"><option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option><option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option><option value="6">Júl</option><option value="7">August</option><option value="8">September</option><option value="9">Október</option><option value="10">November</option><option value="11">December</option></select></div>
            <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div>
            <div><label for="decimalPlacesSelect">Počet desatinných miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2">2</option></select></div>
            <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button> </div>

        <div class="table-container">
            <table>
                <thead><tr><th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka (h)</th><th>Odpracované</th><th>Hrubá Mzda (€)</th><th>Čistá Mzda (€)</th><th>Akcia</th></tr></thead>
                <tbody id="workDays"></tbody>
            </table>
        </div>

        <div id="totalSalary"></div>

        <div id="dataSizeContainer">
            <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
            <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
        </div>

        <div class="btn-container">
            <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button> <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button> <button class="btn export-btn" onclick="sendPDF()">Odoslať</button> <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button> <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button> <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhlásiť sa</button> </div>
    </div>

    <div id="saveNotification"></div> <script>
        // VLOŽENÝ JAVASCRIPT (z PÔVODNEJ verzie - Firebase v8 Compat)

        // 1. Firebase Config & Init
        // -----> TU JE VLOŽENÁ KONFIGURÁCIA <-----
        const firebaseConfig = {
            apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo",
            authDomain: "bruno-3cee2.firebaseapp.com",
            projectId: "bruno-3cee2",
            storageBucket: "bruno-3cee2.appspot.com",
            messagingSenderId: "155545319308",
            appId: "1:155545319308:web:5da498ff1cd3e1833888a9"
        };
        firebase.initializeApp(firebaseConfig);
        try {
             // -----> TU JE VLOŽENÝ KĽÚČ APP CHECK <-----
             const appCheck = firebase.appCheck();
             appCheck.activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); // Kľúč z pôvodného kódu
             console.log("Firebase App Check activated.");
        } catch (error) {
            console.warn("Chyba pri aktivácii Firebase App Check:", error);
            // Možno zobraziť notifikáciu užívateľovi
            // showSaveNotification("Chyba pri aktivácii App Check.", "error");
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 2. Povolenie Firestore Offline Persistence
        db.enablePersistence()
            .then(() => { console.log("Firestore offline persistence povolená."); })
            .catch((err) => {
                console.error("Firestore offline persistence chyba:", err.code, err.message, err);
                if (err.code == 'failed-precondition') {
                    console.warn("Firestore offline persistence: Viacnásobné otvorené taby, povolené len v jednom.");
                    // showSaveNotification("Offline režim: Otvorených viacero kariet, povolené len v jednej.", "warning");
                } else if (err.code == 'unimplemented') {
                    console.error("Firestore offline persistence: Prehliadač nie je podporovaný.");
                     // showSaveNotification("Offline režim nie je podporovaný týmto prehliadačom.", "error");
                }
            });

        // 3. Globálne premenné
        let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
        let monthData = {}; // { year: { month: [ { start, end, breakTime }, ... ] } }
        let firestoreListenerUnsubscribe = null;

        // Globálne premenné pre UI elementy (už definované v pôvodnom kóde, ale môžeme ich získať tu pre prehľadnosť)
        const workDays = document.getElementById('workDays');
        const totalSalaryDiv = document.getElementById('totalSalary');
        const dataSizeText = document.getElementById('dataSizeText');
        const dataSizeFill = document.getElementById('dataSizeFill');
        const hourlyWageInput = document.getElementById('hourlyWageInput');
        const taxRateInput = document.getElementById('taxRateInput');
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
        const employeeNameInput = document.getElementById('employeeNameInput');
        const notificationArea = document.getElementById('saveNotification'); // Premenovaná z pôvodného #notification
        const welcomeMessageElement = document.getElementById('welcomeMessage');
        const loadingContainer = document.getElementById('loading-container');
        const authContainer = document.getElementById('auth-container');
        const calculatorContainer = document.getElementById('calculator-container');
        const authMessage = document.getElementById('auth-message');
        const authForms = document.getElementById('auth-forms');
        const authLoggedIn = document.getElementById('auth-loggedIn');
        const loggedInUserText = document.getElementById('loggedInUserText');


        const MAX_DATA_SIZE = 4 * 1024 * 1024; // 4MB limit pre localStorage
        const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

        // 4. Auth funkcie (Register, Login, Logout)
        function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("Registrovaný:", userCredential.user);
                    showSaveNotification("Registrácia úspešná!", "success");
                })
                .catch((error) => {
                    console.error("Chyba pri registrácii:", error.message);
                    showSaveNotification("Chyba pri registrácii: " + error.message, "error");
                });
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log("Prihlásený:", userCredential.user);
                     showSaveNotification("Prihlásenie úspešné!", "success");
                })
                .catch((error) => {
                    console.error("Chyba pri prihlásení:", error.message);
                     showSaveNotification("Chyba pri prihlásení: " + error.message, "error");
                });
        }

        function logout() {
            auth.signOut()
                .then(() => {
                    console.log("Odhlásený.");
                     showSaveNotification("Odhlásenie úspešné!", "success");
                     // onAuthStateChanged sa postará o zobrazenie/skrytie UI
                     // a vyčistenie stavu
                })
                .catch((error) => {
                    console.error("Chyba pri odhlásení:", error.message);
                    showSaveNotification("Chyba pri odhlásení: " + error.message, "error");
                });
        }

        // Funkcia Zabudli ste heslo
        function forgotPassword() {
            const emailInput = document.getElementById('loginEmail');
            const email = emailInput.value;
            if (!email) {
                 showSaveNotification("Prosím, zadajte svoju e-mailovú adresu.", "warning");
                emailInput.focus();
                return;
            }
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    console.log("E-mail na obnovenie hesla odoslaný na:", email);
                    showSaveNotification("Odkaz na obnovenie hesla odoslaný. Skontrolujte si poštu (aj Spam).", "success", 6000);
                })
                .catch((error) => {
                    console.error("Chyba pri odosielaní e-mailu na obnovenie hesla:", error);
                    showSaveNotification("Chyba pri odosielaní e-mailu: " + error.message, "error");
                });
        }

        // 5. Auth State Change Listener
        auth.onAuthStateChanged(user => {
            console.log("onAuthStateChanged: Stav zistený.", user ? `Používateľ: ${user.email}` : "Žiadny používateľ.");
            if (loadingContainer) loadingContainer.classList.add('hidden'); // Skry loading screen

            // Odhlásenie z predchádzajúceho listenera
            if (firestoreListenerUnsubscribe) {
                console.log("Odhlasujem predchádzajúci Firestore listener pri zmene Auth stavu.");
                firestoreListenerUnsubscribe();
                firestoreListenerUnsubscribe = null;
            }

            if (user) {
                // User is signed in
                authMessage.style.display = 'none'; // Skry správu o neprihlásení
                authForms.style.display = 'none'; // Skry formuláre
                loggedInUserText.textContent = `Prihlásený: ${user.email}`;
                authLoggedIn.style.display = 'block'; // Zobraz info o prihlásenom a odhlásenie
                authContainer.style.display = 'none'; // Skry celý auth kontajner
                calculatorContainer.style.display = 'block'; // Zobraz kalkulačku

                console.log("Používateľ prihlásený, nastavujem UI a listener...");

                // Načítanie posledného stavu z localStorage alebo default
                const storedMonth = localStorage.getItem('currentMonth');
                const storedYear = localStorage.getItem('currentYear');
                const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                const currentDate = new Date();

                currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();

                // Validácia načítaných hodnôt
                if (isNaN(currentMonth) || currentMonth < 0 || currentMonth > 11) {
                    currentMonth = currentDate.getMonth();
                }
                 if (isNaN(currentYear) || currentYear < 2000 || currentYear > currentDate.getFullYear() + 5) {
                    currentYear = currentDate.getFullYear();
                 }

                // Nastavenie selectov a ostatných inputov z localStorage
                monthSelect.value = currentMonth;
                // Over, či rok existuje v selecte
                if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                    yearSelect.value = currentYear;
                } else {
                    console.warn(`Rok ${currentYear} z localStorage nenájdený v selecte, používam aktuálny rok.`);
                    currentYear = currentDate.getFullYear();
                    populateYearSelect(); // Znovu naplň select rokmi
                    yearSelect.value = currentYear;
                }
                applyDarkMode(darkMode); // Aplikuj tmavý režim

                // Načítaj nastavenia
                hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                const taxRatePercent = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) || 2;
                taxRate = taxRatePercent / 100;
                decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2; // Default 2
                employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

                // Aktualizuj inputy nastavení
                hourlyWageInput.value = hourlyWage;
                taxRateInput.value = taxRate * 100;
                decimalPlacesSelect.value = decimalPlaces;
                employeeNameInput.value = employeeName;

                // Prvé načítanie dát (z localStorage) a vykreslenie UI
                console.log("onAuthStateChanged: Prvé volanie loadFromLocalStorage...");
                loadFromLocalStorage(); // Načíta monthData a aktualizuje UI vrátane tabuľky

                // Nastavenie Firestore listenera pre aktuálny mesiac/rok
                setupFirestoreListener();

                // Overenie / vytvorenie užívateľského dokumentu vo Firestore
                const uid = user.uid;
                const userDocRef = db.collection("users").doc(uid);
                userDocRef.get().then(userDocSnap => {
                    if (!userDocSnap.exists) {
                        userDocRef.set({
                             email: user.email,
                             createdAt: firebase.firestore.FieldValue.serverTimestamp() // Použi server timestamp
                             }, { merge: true })
                             .then(() => console.log("Vytvorený/aktualizovaný dokument pre:", uid))
                             .catch(err => console.error("Chyba pri vytváraní/aktualizácii dokumentu používateľa:", err));
                    } else {
                        console.log("Dokument používateľa existuje:", uid);
                    }
                }).catch(err => {
                    console.error("Chyba pri kontrole dokumentu používateľa (userDocRef.get):", err);
                    showSaveNotification("Chyba pri overovaní používateľských dát", "error");
                });

                 // Timeout pre prípad, že sme offline a listener nespustí update
                 setTimeout(() => {
                    if (auth.currentUser && !navigator.onLine) {
                        console.log("onAuthStateChanged (setTimeout): Vynútené druhé volanie loadFromLocalStorage (offline)...");
                        loadFromLocalStorage(); // Znovu načítaj z localStorage pre istotu
                    } else if (auth.currentUser && navigator.onLine) {
                        console.log("onAuthStateChanged (setTimeout): Online, druhé volanie loadFromLocalStorage preskočené.");
                    }
                 }, 200); // Zvýšený timeout pre istotu

            } else {
                // User is signed out
                authMessage.textContent = "Žiadny používateľ nie je prihlásený.";
                authMessage.style.display = 'block';
                authForms.style.display = 'block';
                authLoggedIn.style.display = 'none';
                authContainer.style.display = 'block'; // Zobraz auth kontajner
                calculatorContainer.style.display = 'none'; // Skry kalkulačku
                console.log("Používateľ odhlásený/neprihlásený.");

                // Vyčistenie stavu a UI
                monthData = {};
                workDays.innerHTML = ''; // Vymaž tabuľku
                totalSalaryDiv.innerHTML = ''; // Vymaž súčet
                updateWelcomeMessage(); // Skry pozdrav
                 // Možno resetovať aj nastavenia? Zatiaľ nie.
                 // hourlyWageInput.value = 10; ... atď.
            }
        });

        // 6. Utility funkcie (debounce, showSaveNotification)
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        function showSaveNotification(message, type = 'success', duration = 3000) {
            if (!notificationArea) return;
            notificationArea.textContent = message;
            // Použi CSS triedy pre typ notifikácie
            notificationArea.className = `show ${type}`; // Pridaj typ ako triedu
            setTimeout(() => {
                 if (notificationArea) notificationArea.classList.remove('show');
                 // Po skrytí odstráň aj typovú triedu
                 setTimeout(() => { if(notificationArea) notificationArea.className = ''; }, 500);
            }, duration);
        }

        // --- Funkcie pre pozdrav ---
        function getFirstName(fullName) {
            if (!fullName || typeof fullName !== 'string') {
                return '';
            }
            const trimmedName = fullName.trim();
            if (!trimmedName) {
                return '';
            }
            const parts = trimmedName.split(' ');
            return parts[0];
        }

        function updateWelcomeMessage() {
             if (!welcomeMessageElement) return;
             const firstName = getFirstName(employeeName); // Použije globálnu premennú
             if (firstName) {
                 welcomeMessageElement.textContent = `Vitaj, ${firstName}!`;
             } else {
                 welcomeMessageElement.textContent = ''; // Skryje, ak nie je meno
             }
        }


        // 7. Funkcia na nastavenie Firestore Listenera
        function setupFirestoreListener() {
            // Odhlásenie z predchádzajúceho listenera (už riešené v onAuthStateChanged, ale pre istotu)
            if (firestoreListenerUnsubscribe) {
                 console.log("Odhlasujem predchádzajúci Firestore listener.");
                 firestoreListenerUnsubscribe();
                 firestoreListenerUnsubscribe = null;
            }

            const currentUser = auth.currentUser;
            if (!currentUser) {
                console.log("setupFirestoreListener: Nikto nie je prihlásený.");
                return;
            }
            const uid = currentUser.uid;

            // Overenie platnosti mesiaca a roka
            if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                 console.error("setupFirestoreListener: Chýba mesiac alebo rok v globálnom stave!");
                 const now = new Date();
                 currentMonth = currentMonth ?? now.getMonth();
                 currentYear = currentYear ?? now.getFullYear();
                 // Aktualizuj selectboxy pre istotu
                 monthSelect.value = currentMonth;
                 yearSelect.value = currentYear;
                 // Môže byť potrebné znovu načítať z localStorage?
            }

            const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
            const docRef = db.doc(docPath); // Použitie db.doc() pre v8

            console.log(`setupFirestoreListener: Nastavujem listener pre ${docPath}`);

            firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
                console.log(`Firestore listener: Prijatý snapshot pre ${docPath}. Metadata:`, docSnap.metadata);
                const isLocalWrite = docSnap.metadata.hasPendingWrites;
                const source = docSnap.metadata.fromCache ? "cache" : "server";

                if (isLocalWrite) {
                    console.log("Listener: Detekovaná lokálna zmena (pending writes). Preskakujem plnú aktualizáciu UI.");
                    showSaveNotification("Synchronizujem lokálne zmeny...", "warning", 1500);
                    // Aj keď je lokálny zápis, môžeme aktualizovať monthData v pamäti,
                    // ak snapshot už obsahuje dáta (môže byť z cache)
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const firebaseDaysData = data.days || [];
                        if (!monthData) monthData = {};
                        if (!monthData[currentYear]) monthData[currentYear] = {};
                        monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                            start: day.start || '',
                            end: day.end || '',
                            breakTime: day.breakTime || '' // Uložíme ako string
                        }));
                        // Silent update settings from potential merged data?
                        // updateSettingsFromFirebaseData(data, true);
                    }
                    return; // Neaktualizuj UI naplno, aby sa neprepísal aktívny input
                }

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log(`Listener: Dokument existuje (${source}), načítané dáta:`, data);

                    try {
                        let settingsChanged = false;
                        let workDataChanged = false;

                         // --- Update Settings ---
                         const fbWage = data.hourlyWage ?? hourlyWage;
                         const fbTaxPercent = data.taxRate ?? (taxRate * 100);
                         const fbTaxRate = fbTaxPercent / 100;
                         const fbDecimals = data.decimalPlaces ?? decimalPlaces;
                         const fbName = data.employeeName ?? employeeName;
                         const fbDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');

                         if (hourlyWage !== fbWage) { hourlyWage = fbWage; settingsChanged = true; }
                         if (taxRate !== fbTaxRate) { taxRate = fbTaxRate; settingsChanged = true; }
                         if (decimalPlaces !== fbDecimals) { decimalPlaces = fbDecimals; settingsChanged = true; }
                         if (employeeName !== fbName) { employeeName = fbName; settingsChanged = true; }
                         if (document.body.classList.contains('dark-mode') !== fbDarkMode) {
                             // Apply dark mode change directly here if needed
                             applyDarkMode(fbDarkMode);
                             settingsChanged = true;
                         }

                        // --- Update Work Data ---
                        const firebaseDaysData = data.days || [];
                        const localDaysData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
                        // Jednoduché porovnanie stringov pre detekciu zmeny
                         if (JSON.stringify(firebaseDaysData) !== JSON.stringify(localDaysData)) {
                            workDataChanged = true;
                            console.log("Listener: Work data differs, updating local state.");
                            if (!monthData) monthData = {};
                            if (!monthData[currentYear]) monthData[currentYear] = {};
                            monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                                start: day.start || '',
                                end: day.end || '',
                                breakTime: day.breakTime || '' // Uložiť ako string
                            }));
                         }


                        // --- Apply Changes & Update UI ---
                        if (settingsChanged || workDataChanged) {
                             console.log("Listener: Data changed, updating UI and saving to LocalStorage.");

                             // Update UI inputs (s kontrolou fokusu)
                             if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
                             if (document.activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
                             decimalPlacesSelect.value = decimalPlaces;
                             if (document.activeElement !== employeeNameInput) employeeNameInput.value = employeeName;
                             applyDarkMode(fbDarkMode); // Znovu aplikuj pre istotu

                             // Update table (cielená aktualizácia inputov)
                             const daysInMonth = getDaysInMonth(currentMonth); // Tu by mal byť rok globálny
                             const activeElementId = document.activeElement?.id;

                             for (let i = 1; i <= daysInMonth; i++) {
                                const dayData = monthData[currentYear]?.[currentMonth]?.[i - 1];
                                const startId = `start-${currentYear}-${currentMonth}-${i}`;
                                const endId = `end-${currentYear}-${currentMonth}-${i}`;
                                const breakId = `break-${currentYear}-${currentMonth}-${i}`;

                                const startElement = document.getElementById(startId);
                                const endElement = document.getElementById(endId);
                                const breakElement = document.getElementById(breakId);

                                if (startElement && endElement && breakElement) {
                                    const newStart = dayData?.start || '';
                                    const newEnd = dayData?.end || '';
                                    const newBreak = dayData?.breakTime || '';

                                    if (startElement.value !== newStart && activeElementId !== startId) startElement.value = newStart;
                                    if (endElement.value !== newEnd && activeElementId !== endId) endElement.value = newEnd;
                                    if (breakElement.value !== newBreak && activeElementId !== breakId) breakElement.value = newBreak;

                                     // Prepočítaj riadok po aktualizácii hodnôt
                                     calculateRow(i);
                                } else {
                                     // Ak element neexistuje, tabuľka asi ešte nebola vytvorená alebo je chyba
                                     // console.warn(`Listener: Chýbajú input elementy pre deň ${i} pri cielenej aktualizácii.`);
                                }
                             }

                             calculateTotal(); // Prepočítaj celkový súčet
                             updateWelcomeMessage(); // Aktualizuj pozdrav

                             // Ulož zlúčené dáta do localStorage
                             localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                             localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                             localStorage.setItem('darkMode', JSON.stringify(fbDarkMode));
                             localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                             localStorage.setItem('employeeName', JSON.stringify(employeeName));
                             localStorage.setItem('workDaysData', JSON.stringify(monthData)); // Ulož aktualizované work data
                             updateDataSize(); // Aktualizuj ukazovateľ veľkosti

                             console.log("Listener: Cielená aktualizácia UI dokončená.");
                             if (!docSnap.metadata.fromCache) {
                                console.log("Listener: Dáta prijaté priamo zo SERVERA.");
                                showSaveNotification("Dáta synchronizované");
                             }

                        } else {
                             console.log("Listener: Data is the same as local state, no UI update needed.");
                        }

                    } catch (processError) {
                        console.error(`Listener: Chyba pri spracovaní dát z Firestore pre ${currentYear}-${currentMonth}:`, processError);
                        showSaveNotification("Chyba: Nesprávny formát dát z Firebase", "error");
                    }
                } else {
                    // Dokument neexistuje na Firebase
                    console.log(`Listener: Dokument neexistuje (${source}) na Firebase pre ${currentYear}-${currentMonth}.`);
                    // Ak dokument neexistuje na serveri, mal by som vymazať lokálne dáta pre tento mesiac?
                    // Alebo ponechať lokálne ako zdroj pravdy, ak bol užívateľ offline?
                    // Aktuálne správanie: Ponechá lokálne dáta, ak existujú.
                    // Ak chceme vymazať lokálne dáta, ak na serveri nie sú:
                    /*
                    if (monthData?.[currentYear]?.[currentMonth]?.length > 0) { // Ak mame lokalne data
                        console.log("Listener: Mazem lokalne data, lebo dokument na serveri neexistuje.");
                        if (!monthData) monthData = {};
                        if (!monthData[currentYear]) monthData[currentYear] = {};
                        monthData[currentYear][currentMonth] = []; // Vycisti data pre mesiac
                        localStorage.setItem('workDaysData', JSON.stringify(monthData));
                        // Refresh UI to show empty table
                        createTable();
                        calculateTotal();
                        showSaveNotification("Dáta pre tento mesiac boli vymazané zo servera.", "warning");
                    }
                    */
                    // Načítanie nastavení z local storage, ak dokument neexistuje, aby sa neprepisovali
                    hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                    taxRate = (parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100) || 0.02;
                    const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                    decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2;
                    employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
                    // Aktualizuj inputy a UI
                    hourlyWageInput.value = hourlyWage;
                    taxRateInput.value = taxRate * 100;
                    decimalPlacesSelect.value = decimalPlaces;
                    employeeNameInput.value = employeeName;
                    applyDarkMode(darkMode);
                    updateWelcomeMessage();
                    // Ak lokálne dáta neexistujú, vytvor prázdnu tabuľku
                    if (!monthData?.[currentYear]?.[currentMonth]) {
                         createTable();
                         calculateTotal();
                    }

                }
            }, (error) => {
                console.error(`Firestore listener chyba pre ${docPath}:`, error);
                showSaveNotification("Chyba: Nepodarilo sa pripojiť k Firebase", "error");
                console.log("Listener chyba, načítavam z localStorage ako fallback...");
                loadFromLocalStorage(); // Fallback na local storage pri chybe listenera
            });
        }

        // 8. Funkcia na ukladanie do Firebase
        async function saveToFirebase() {
            const currentUser = auth.currentUser;
            if (!currentUser) {
                console.log("saveToFirebase: Nikto nie je prihlásený.");
                return;
            }
            const uid = currentUser.uid;
            // Zabránenie viacnásobnému ukladaniu naraz (jednoduchý flag)
            if (window.isSavingToFirebase) {
                 console.log("saveToFirebase: Už prebieha ukladanie, preskakujem.");
                 return;
            }
            window.isSavingToFirebase = true;

            try {
                 // Získaj dáta pre aktuálny mesiac/rok z globálnej premennej
                 const currentMonthWorkData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth])
                                            ? monthData[currentYear][currentMonth]
                                            : [];

                console.log(`saveToFirebase: Ukladám ${currentMonthWorkData.length} záznamov pre ${currentYear}-${currentMonth}.`);

                const dataToSave = {
                    days: currentMonthWorkData, // Ulož pole objektov ako je
                    hourlyWage: hourlyWage || 10,
                    taxRate: (taxRate * 100) || 2, // Ulož ako percento
                    decimalPlaces: decimalPlaces || 2,
                    employeeName: employeeName || '',
                    darkMode: document.body.classList.contains('dark-mode'),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() // Serverový čas poslednej úpravy
                };

                const yearMonthDoc = `${currentYear}-${currentMonth}`;
                const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);

                await docRef.set(dataToSave);
                console.log(`saveToFirebase: Požiadavka na uloženie dát pre ${yearMonthDoc} odoslaná.`);
                // Notifikáciu zobrazí listener po potvrdení zo servera (ak nie je local write)

            } catch (error) {
                console.error(`Chyba pri požiadavke na ukladanie do Firebase pre ${currentYear}-${currentMonth}:`, error);
                showSaveNotification("Chyba: Nepodarilo sa odoslať dáta do Firebase", "error");
            } finally {
                 window.isSavingToFirebase = false; // Uvoľni flag
            }
        }

         // --- Debounced Save Function ---
         // Táto funkcia sa volá po každej relevantnej zmene (input, nastavenie, reset)
         const debouncedProcessInputCompletion = debounce((sourceId, nextId) => {
              console.log(`Debounced save triggered by: ${sourceId}`);
              saveToLocalStorage(); // Vždy ulož lokálne
              if (navigator.onLine && auth.currentUser) {
                  saveToFirebase(); // Ulož do Firebase, ak sme online a prihlásení
              } else if (!navigator.onLine && auth.currentUser) {
                   showSaveNotification("Offline: Zmeny uložené lokálne", "warning");
              }
              // Presun fokusu bol riešený priamo v handleInput/handleBreakInput
              // if (sourceId !== 'settings-change' && sourceId !== 'restore-backup' && !sourceId.startsWith('reset-')) {
              //     moveNext(document.getElementById(sourceId), nextId);
              // }
         }, 1000); // Ulož 1 sekundu po poslednej zmene

        // 9. Funkcia na ukladanie do Local Storage
        // (Volá sa z debouncedProcessInputCompletion)
        function saveToLocalStorage() {
            try {
                // Over, či existuje štruktúra pre aktuálny mesiac/rok
                if (!monthData) monthData = {};
                if (!monthData[currentYear]) monthData[currentYear] = {};
                if (!monthData[currentYear][currentMonth]) {
                    // Ak neexistuje, vytvor prázdne pole (nemalo by sa stať pri normálnom používaní)
                    monthData[currentYear][currentMonth] = [];
                    console.warn(`saveToLocalStorage: Inicializované prázdne pole pre ${currentYear}-${currentMonth}.`);
                }

                // Ulož nastavenia
                localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); // Ulož ako percento
                localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
                localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                localStorage.setItem('employeeName', JSON.stringify(employeeName));

                // Ulož aktuálny mesiac a rok
                localStorage.setItem('currentMonth', currentMonth.toString());
                localStorage.setItem('currentYear', currentYear.toString());

                // Ulož dáta práce (potenciálne veľké)
                const serializedMonthData = JSON.stringify(monthData);
                const bytes = new Blob([serializedMonthData]).size;

                // Kontrola veľkosti
                if (bytes > MAX_DATA_SIZE * 0.9 && bytes <= MAX_DATA_SIZE) {
                     console.warn(`Veľkosť dát ('workDaysData') v localStorage sa blíži k limitu: ${bytes} bajtov`);
                     showSaveNotification(`Lokálne úložisko je takmer plné (${(bytes/1024).toFixed(0)} KB / ${MAX_DATA_SIZE_KB} KB).`, "warning", 5000);
                } else if (bytes > MAX_DATA_SIZE) {
                     console.error(`Prekročená maximálna veľkosť dát (${bytes} > ${MAX_DATA_SIZE}) pre 'workDaysData'. Ukladanie zlyhalo.`);
                     showSaveNotification("Chyba: Lokálne dáta sú príliš veľké! Neuložili sa.", "error", 10000);
                     // Neulož 'workDaysData', ak prekračuje limit
                     updateDataSize(); // Ukáž plný stav
                     return; // Neukladaj
                }

                localStorage.setItem('workDaysData', serializedMonthData);
                updateDataSize(); // Aktualizuj zobrazenie veľkosti
                // console.log("Data saved to Local Storage."); // Menej ukecané logovanie

            } catch (error) {
                console.error('Chyba pri ukladaní do Local Storage:', error);
                showSaveNotification("Kritická chyba pri ukladaní lokálnych dát!", "error");
                if (error.name === 'QuotaExceededError') {
                     showSaveNotification("Lokálne úložisko je plné!", "error", 10000);
                }
            }
        }

        // 10. Funkcia na načítanie z Local Storage
        // (Volá sa pri štarte a zmene mesiaca/roka)
        function loadFromLocalStorage() {
            try {
                console.log(`loadFromLocalStorage: Načítavam pre ${getMonthName(currentMonth)} ${currentYear}`);
                const storedMonthData = localStorage.getItem('workDaysData');
                monthData = storedMonthData ? JSON.parse(storedMonthData) : {};

                // Základná validácia načítanej štruktúry
                 if (typeof monthData !== 'object' || monthData === null) {
                     console.warn("loadFromLocalStorage: Načítaná neplatná štruktúra monthData, resetujem.");
                     monthData = {};
                 }


                if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) {
                    console.log(`loadFromLocalStorage: Načítaných ${monthData[currentYear][currentMonth].length} záznamov pre ${currentYear}-${currentMonth}.`);
                } else {
                    console.log(`loadFromLocalStorage: Pre ${currentYear}-${currentMonth} neboli v localStorage nájdené žiadne záznamy alebo štruktúra chýba.`);
                    // Ak dáta pre mesiac neexistujú, zaisti, že pole existuje
                    if (!monthData) monthData = {};
                    if (!monthData[currentYear]) monthData[currentYear] = {};
                    if (!monthData[currentYear][currentMonth]) {
                        monthData[currentYear][currentMonth] = [];
                    }
                }

                // Načítaj nastavenia (už by mali byť načítané v onAuthStateChanged, ale pre istotu)
                hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                taxRate = (parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100) || 0.02;
                const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2;
                employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

                // Aktualizuj UI na základe načítaných dát
                updateUIFromLoadedData(darkMode); // Táto funkcia aktualizuje inputy a tabuľku

            } catch (error) {
                console.error(`Kritická chyba pri načítavaní/spracovaní dát z localStorage pre ${getMonthName(currentMonth)} ${currentYear}:`, error);
                showSaveNotification("Chyba pri načítaní lokálnych dát!", "error");
                // Reset na bezpečný stav v prípade chyby
                monthData = {};
                createTable(); // Vytvor prázdnu tabuľku
                calculateTotal(); // Vynuluj súčty
            }
        }

        // 11. Funkcia na aktualizáciu UI po načítaní dát
        function updateUIFromLoadedData(darkModeValue) {
            console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(currentMonth)} ${currentYear}`);
            try {
                // Aktualizuj inputy nastavení
                hourlyWageInput.value = hourlyWage;
                taxRateInput.value = taxRate * 100;
                decimalPlacesSelect.value = decimalPlaces;
                employeeNameInput.value = employeeName;
                monthSelect.value = currentMonth; // Mesiac a rok by už mali byť správne nastavené

                // Znovu vytvor tabuľku na základe `monthData`
                createTable();

                // Naplň tabuľku hodnotami z `monthData`
                const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
                console.log(`updateUIFromLoadedData: Počet záznamov v monthData pre ${currentYear}-${currentMonth}: ${dataForCurrentMonth.length}`);

                dataForCurrentMonth.forEach((day, index) => {
                    const i = index + 1;
                    const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                    const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                    const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);

                    if (startElement && endElement && breakElement) {
                        startElement.value = day.start || '';
                        endElement.value = day.end || '';
                        breakElement.value = day.breakTime || ''; // breakTime je už string
                        calculateRow(i); // Prepočítaj riadok po naplnení
                    } else {
                        // Toto by sa nemalo stať, ak createTable funguje správne
                        console.error(`Chyba: Elementy pre deň ${i} v updateUIFromLoadedData neboli nájdené po createTable!`);
                    }
                });

                calculateTotal(); // Prepočítaj celkové súčty
                updateDataSize(); // Aktualizuj veľkosť dát
                applyDarkMode(darkModeValue); // Aplikuj tmavý režim
                updateWelcomeMessage(); // Aktualizuj pozdrav

                console.log("UI aktualizované.");
            } catch (error) {
                console.error("Chyba počas aktualizácie UI:", error);
                showSaveNotification("Chyba pri prekresľovaní UI!", "error");
            }
        }

        // 12. Funkcia pre aplikovanie Dark Mode
        function applyDarkMode(isDark) {
             // Jednoduchšia verzia - len prepne triedu na body
             if (isDark) {
                 document.body.classList.add('dark-mode');
             } else {
                 document.body.classList.remove('dark-mode');
             }
             // CSS premenné a selektory sa postarajú o zvyšok
        }

        // 13) Vytváranie tabuľky (a súvisiace funkcie)
        function getDayName(year, month, day) {
            const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"];
            // Mesiac je 0-indexovaný v Date objekte
            return daysOfWeek[new Date(year, month, day).getDay()];
        }

        function createTable() {
            workDays.innerHTML = ''; // Vyčisti starú tabuľku
            const daysInMonth = getDaysInMonth(currentMonth); // Použi globálny currentMonth a currentYear
            const today = new Date();
            const currentDayOfMonth = today.getDate();
            const currentMonthIndex = today.getMonth();
            const currentYearValue = today.getFullYear();

            const fragment = document.createDocumentFragment(); // Pre lepší výkon

            for (let i = 1; i <= daysInMonth; i++) {
                const row = document.createElement('tr');
                const isCurrentDay = (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue);
                if (isCurrentDay) {
                    row.classList.add('current-day');
                }
                const dayName = getDayName(currentYear, currentMonth, i);
                const year = currentYear; // Lokálne pre ID
                const month = currentMonth; // Lokálne pre ID

                // Získaj dáta pre tento deň z `monthData`, ak existujú
                const dayData = monthData?.[year]?.[month]?.[i - 1] || { start: '', end: '', breakTime: '' };

                row.innerHTML = `
                    <td>Deň ${i} (${dayName})</td>
                    <td><input type="tel" id="start-${year}-${month}-${i}" value="${dayData.start}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${year}-${month}-${i}', ${i})"></td>
                    <td><input type="tel" id="end-${year}-${month}-${i}" value="${dayData.end}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${year}-${month}-${i}', ${i})"></td>
                    <td><input type="number" id="break-${year}-${month}-${i}" value="${dayData.breakTime}" min="0" step="0.1" placeholder="hod." oninput="handleBreakInput(${i})"></td>
                    <td id="total-${year}-${month}-${i}">0h 0m (${(0).toFixed(decimalPlaces || 2)} h)</td>
                    <td><input type="number" id="gross-${year}-${month}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td>
                    <td><input type="number" id="net-${year}-${month}-${i}" min="0" step="0.01" placeholder="0.00" readonly></td>
                    <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td> `;
                fragment.appendChild(row);
            }
            workDays.appendChild(fragment); // Pridaj všetky riadky naraz
            // Aplikuj tmavý režim na novovytvorené elementy, ak je aktívny
            applyDarkMode(document.body.classList.contains('dark-mode'));
            // Prepočítaj všetky riadky po vytvorení tabuľky
            recalculateAllRowsAndTotal();
        }

         // --- Funkcia na prepočítanie všetkých riadkov ---
         function recalculateAllRowsAndTotal() {
             const daysInMonth = getDaysInMonth(currentMonth);
             for (let i = 1; i <= daysInMonth; i++) {
                 calculateRow(i);
             }
             calculateTotal();
         }


        // Input handling funkcie
        // POZNÁMKA: debouncedProcessInputCompletion sa volá z handleInput a handleBreakInput
        function isTimeValid(timeStr) {
            const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
            return timeRegex.test(timeStr);
        }

        function handleInput(input, nextId, day) {
             formatInput(input); // Formátuj HH:MM
             updateMonthDataFromInput(input, day); // Ulož hodnotu do monthData
             calculateRow(day); // Prepočítaj riadok
             calculateTotal(); // Prepočítaj súčet
             debouncedProcessInputCompletion(input.id, nextId); // Spusti debouncované ukladanie
             // Pokus o presun fokusu
             if (input.value.length === 5 && isTimeValid(input.value)) {
                 moveNext(input, nextId);
             }
        }

        function handleBreakInput(day) {
            const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
            updateMonthDataFromInput(input, day); // Ulož hodnotu do monthData
            calculateRow(day); // Prepočítaj riadok
            calculateTotal(); // Prepočítaj súčet
            // Priprav ID pre ďalší deň (ak existuje)
            const nextDay = day + 1;
            let nextInputElementId = null;
            if (nextDay <= getDaysInMonth(currentMonth)) {
                nextInputElementId = `start-${currentYear}-${currentMonth}-${nextDay}`;
            }
            debouncedProcessInputCompletion(input.id, nextInputElementId); // Spusti debouncované ukladanie
            // Možno presunúť focus na Enter?
            // input.onkeydown = (e) => { if (e.key === 'Enter' && nextInputElementId) moveNext(input, nextInputElementId); };
        }


        // Funkcia na aktualizáciu `monthData` pri zmene inputu
        function updateMonthDataFromInput(input, day) {
            if (!input) return;
            const dayIndex = day - 1; // 0-based index
            const fieldId = input.id;
            let field = 'unknown';

            if (fieldId.startsWith('start-')) field = 'start';
            else if (fieldId.startsWith('end-')) field = 'end';
            else if (fieldId.startsWith('break-')) field = 'breakTime';

            const value = input.value;

            if (field !== 'unknown') {
                // Ensure data structure exists
                if (!monthData) monthData = {};
                if (!monthData[currentYear]) monthData[currentYear] = {};
                if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];

                // Ensure array is long enough
                while (monthData[currentYear][currentMonth].length <= dayIndex) {
                    monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '' });
                }

                // Update the value
                 if (monthData[currentYear][currentMonth][dayIndex]) {
                    monthData[currentYear][currentMonth][dayIndex][field] = value; // Ulož ako string
                 } else {
                      // Should not happen if array is padded
                     console.error(`updateMonthDataFromInput: Chýba záznam pre deň ${dayIndex}.`);
                     monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', [field]: value };
                 }

            } else {
                console.warn("updateMonthDataFromInput: Nerozpoznané pole pre input ID:", fieldId);
            }
             // Samotné ukladanie rieši debouncedProcessInputCompletion
        }


        function formatInput(input) {
            if (!input || input.type !== 'tel') return;
            let value = input.value.replace(/[^\d:]/g, ''); // Ponechaj len čísla a dvojbodku

            // Auto-format HHMM to HH:MM
            if (value.length === 4 && value.indexOf(':') === -1) {
                value = value.slice(0, 2) + ':' + value.slice(2);
            }
            // Auto-format HMM to H:MM? (menej časté)
            // else if (value.length === 3 && value.indexOf(':') === -1) {
            //     value = value.slice(0, 1) + ':' + value.slice(1);
            // }
             // Auto-format HH M to HH:M?
             else if (value.length === 3 && value.charAt(2) !== ':' && parseInt(value.slice(0,2)) <= 23 ) {
                 value = value.slice(0, 2) + ':' + value.slice(2);
             }


            // Limit length to 5 characters (HH:MM)
            if (value.length > 5) {
                value = value.slice(0, 5);
            }

            input.value = value;

             // Validácia po naformátovaní
             input.style.border = ''; // Reset border
             if (value.length === 5 && !isTimeValid(value)) {
                 input.style.border = '1px solid red';
                 // Zmizne po chvíli
                 setTimeout(() => { input.style.border = ''; }, 2000);
            }
        }

        function moveNext(currentElement, nextId) {
             if (!nextId || !currentElement) return;
             const nextElement = document.getElementById(nextId);
             if (nextElement) {
                 // Presuň fokus len ak ho má aktuálny element
                 if (document.activeElement === currentElement) {
                     console.log(`moveNext: Presúvam fokus z ${currentElement.id} na ${nextId}`);
                     nextElement.focus();
                     if (nextElement.select) { // Označ text, ak je to input
                         nextElement.select();
                     }
                 } else {
                      console.log(`moveNext: Aktuálny element ${currentElement.id} už nemá fokus.`);
                 }
             } else {
                 console.warn(`moveNext: Element s ID ${nextId} nebol nájdený.`);
             }
        }

        function calculateRow(day) {
            const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value;
            const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value;
            const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
            const breakTime = parseFloat(breakTimeInput?.value) || 0; // Prestávka v hodinách
            const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
            const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
            const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

            if (!totalCell || !grossElement || !netElement) {
                console.warn(`Elementy pre výpočet riadku ${day} nenájdené.`);
                return; // Exit if elements are missing
            }

            // Reset to 0 if inputs are invalid or missing
            if (!startTimeStr || !endTimeStr || !isTimeValid(startTimeStr) || !isTimeValid(endTimeStr)) {
                totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 2)} h)`;
                grossElement.value = '0.00';
                netElement.value = '0.00';
                return;
            }

            try {
                const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
                const [endHours, endMinutes] = endTimeStr.split(':').map(Number);

                // Create Date objects for calculation (handles overnight)
                 // Assume current year/month/day for calculation
                const startDate = new Date(currentYear, currentMonth, day, startHours, startMinutes);
                let endDate = new Date(currentYear, currentMonth, day, endHours, endMinutes);

                 // Ak end time je menší ako start time, predpokladaj ďalší deň
                if (endDate < startDate) {
                     endDate.setDate(endDate.getDate() + 1);
                }

                const diffMilliseconds = endDate - startDate;
                const diffMinutes = diffMilliseconds / (1000 * 60);

                const breakMinutes = breakTime * 60;
                const workedMinutes = Math.max(0, diffMinutes - breakMinutes);

                const hours = Math.floor(workedMinutes / 60);
                const minutes = Math.round(workedMinutes % 60); // Round minutes
                const decimalHours = workedMinutes / 60;

                totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces || 2)} h)`;

                // Použi aktuálne globálne nastavenia
                const currentHourlyWage = hourlyWage;
                const currentTaxRate = taxRate;

                const grossSalary = decimalHours * currentHourlyWage;
                const netSalary = grossSalary * (1 - currentTaxRate);

                // Format output values
                grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00';
                netElement.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00';
            } catch(e) {
                 console.error(`Chyba pri výpočte riadku ${day}:`, e);
                 totalCell.textContent = 'Chyba';
                 grossElement.value = 'N/A';
                 netElement.value = 'N/A';
            }
        }


        function resetRow(day) {
            const dayIndex = day - 1;
            const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
            const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
            const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);

            if (start && end && breakTime) {
                start.value = '';
                end.value = '';
                breakTime.value = '';
                // Prepočítaj riadok (vynuluje sa) a celok
                calculateRow(day);
                calculateTotal();

                // Aktualizuj monthData
                if (monthData?.[currentYear]?.[currentMonth]?.[dayIndex]) {
                    monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '' };
                }
                 // Ulož zmeny
                 debouncedProcessInputCompletion(`reset-${day}`, null);
                 showSaveNotification(`Deň ${day} vynulovaný.`);
            }
        }


        function resetAll() {
            if (confirm(`Naozaj chcete resetovať všetky záznamy pre ${getMonthName(currentMonth)} ${currentYear}?`)) {
                // Vyčisti dáta v pamäti
                if (!monthData) monthData = {};
                if (!monthData[currentYear]) monthData[currentYear] = {};
                monthData[currentYear][currentMonth] = []; // Prázdne pole pre aktuálny mesiac

                // Prekresli UI
                createTable(); // Vytvorí prázdnu tabuľku
                calculateTotal(); // Vynuluje súčty

                // Ulož zmeny
                debouncedProcessInputCompletion(`reset-all`, null);
                showSaveNotification("Dáta pre aktuálny mesiac boli resetované.");
            }
        }

        // 14) Výpočet celkových súčtov
        function calculateTotal() {
            let grandTotalWorkedMinutes = 0;
            let grandTotalGrossSalary = 0;
            let grandTotalNetSalary = 0;
            let daysWithEntries = 0; // Počet dní s aspoň nejakým záznamom

            const rows = workDays.querySelectorAll('tr');

            rows.forEach((row, index) => {
                const dayIndex = index + 1; // Deň je 1-based
                const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`);
                const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`);
                const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`);
                const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayIndex}`);
                const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayIndex}`);

                // Skontroluj, či existujú inputy pre hrubú/čistú mzdu
                const currentGross = grossInput ? parseFloat(grossInput.value) : 0;
                const currentNet = netInput ? parseFloat(netInput.value) : 0;

                 // Ak existuje aspoň príchod alebo odchod, rátaj ako deň so záznamom
                if (startInput?.value || endInput?.value) {
                     daysWithEntries++;
                }

                // Sčítaj hrubú a čistú mzdu priamo z inputov (už sú vypočítané v calculateRow)
                if (isFinite(currentGross)) {
                    grandTotalGrossSalary += currentGross;
                }
                 if (isFinite(currentNet)) {
                    grandTotalNetSalary += currentNet;
                }


                // --- Sčítanie minút pre celkový čas ---
                 const startTimeStr = startInput?.value;
                 const endTimeStr = endInput?.value;
                 if (startTimeStr && endTimeStr && isTimeValid(startTimeStr) && isTimeValid(endTimeStr)) {
                     try {
                         const breakTime = parseFloat(breakInput?.value) || 0;
                         const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
                         const [endHours, endMinutes] = endTimeStr.split(':').map(Number);

                         const startDate = new Date(currentYear, currentMonth, dayIndex, startHours, startMinutes);
                         let endDate = new Date(currentYear, currentMonth, dayIndex, endHours, endMinutes);
                         if (endDate < startDate) {
                             endDate.setDate(endDate.getDate() + 1);
                         }
                         const diffMinutes = (endDate - startDate) / (1000 * 60);
                         const breakMinutes = breakTime * 60;
                         const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes);
                         grandTotalWorkedMinutes += workedMinutesForRow;
                     } catch (e) {
                          console.error(`Chyba pri sčítaní času pre deň ${dayIndex}:`, e);
                     }
                 }

            });

            const grandTotalDecimalHours = grandTotalWorkedMinutes / 60;
            const totalHours = Math.floor(grandTotalWorkedMinutes / 60);
            const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60); // Round minutes

            // Výpočet priemerov
            const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0;
            const averageWorkedMinutes = daysWithEntries > 0 ? (grandTotalWorkedMinutes / daysWithEntries) : 0;
            const averageHours = Math.floor(averageWorkedMinutes / 60);
            const averageMinutes = Math.round(averageWorkedMinutes % 60); // Round minutes
            const averageDecimalHours = averageWorkedMinutes / 60;

            // Aktualizuj HTML obsah súčtov
            totalSalaryDiv.innerHTML = `
                Počet dní so záznamom: ${daysWithEntries}<br>
                Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(decimalPlaces || 2)} h)<br>
                Celková hrubá mzda: ${grandTotalGrossSalary.toFixed(2)} €<br>
                Celková čistá mzda: ${grandTotalNetSalary.toFixed(2)} €<br>
                Priemerná čistá mzda na deň: ${averageNetSalary.toFixed(2)} €<br>
                <strong>Priemerný odpracovaný čas na deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(decimalPlaces || 2)} h)</strong>
            `;
        }


        // 15) Export do PDF (exportToPDF, sendPDF) - Logika zostáva, upravený prístup k dátam
         function initializeJsPDFWithCheck() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                 showSaveNotification("Chyba: Knižnica jsPDF nie je načítaná.", "error");
                 console.error("jsPDF library is not loaded correctly.");
                 return null;
            }
             if (typeof window.jspdf.jsPDF.API?.autoTable === 'undefined') {
                 showSaveNotification("Chyba: Plugin jsPDF-AutoTable nie je načítaný.", "error");
                 console.error("jsPDF autoTable plugin is not loaded correctly.");
                 return null;
             }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            try {
                // Skús pridať font
                doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
                doc.setFont('Roboto');
            } catch (e) {
                console.warn("Could not load Roboto font for PDF, using default.", e);
                // Pokračuj s defaultným písmom
            }
            return doc;
         }

        function exportToPDF() {
            console.log("exportToPDF: Spustené...");
            const doc = initializeJsPDFWithCheck();
            if (!doc) return;

            try {
                const year = currentYear; // Globálne premenné
                const month = currentMonth;
                const monthName = getMonthName(month);

                doc.setFontSize(18);
                doc.text(`Bruno's Calculator - Výkaz (${monthName} ${year})`, 14, 20);

                doc.setFontSize(12);
                doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28);
                doc.text(`Hodinová mzda: ${hourlyWage.toFixed(2)} €`, 14, 34); // Použi globálne
                doc.text(`Daň (%): ${(taxRate * 100).toFixed(decimalPlaces || 2)}`, 100, 34); // Použi globálne

                const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované", "Hrubá Mzda (€)", "Čistá Mzda (€)"];
                const tableRows = [];

                const dataForCurrentMonth = (monthData && monthData[year] && monthData[year][month]) || [];
                const daysInMonthPDF = getDaysInMonth(month); // Získaj počet dní

                 for (let i = 1; i <= daysInMonthPDF; i++) {
                     const dayData = dataForCurrentMonth[i - 1] || { start: '', end: '', breakTime: '' };
                     // Pridaj riadok len ak má záznam
                     if (dayData.start || dayData.end) {
                         const dayNum = i;
                         const dayNameStr = getDayName(year, month, dayNum);
                         // Získaj hodnoty z UI elementov (tie by mali byť aktuálne)
                         const totalCell = document.getElementById(`total-${year}-${month}-${dayNum}`);
                         const grossInput = document.getElementById(`gross-${year}-${month}-${dayNum}`);
                         const netInput = document.getElementById(`net-${year}-${month}-${dayNum}`);

                         const workedTimeText = totalCell ? totalCell.textContent : 'N/A';
                         const grossValue = grossInput ? parseFloat(grossInput.value).toFixed(2) : '0.00';
                         const netValue = netInput ? parseFloat(netInput.value).toFixed(2) : '0.00';
                         const breakDisplay = dayData.breakTime || '0';

                         const rowData = [
                            `Deň ${dayNum} (${dayNameStr})`,
                            dayData.start || '-',
                            dayData.end || '-',
                            breakDisplay,
                            workedTimeText,
                            grossValue,
                            netValue
                        ];
                        tableRows.push(rowData);
                    }
                }


                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 40,
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName },
                    styles: { font: doc.getFont().fontName, fontSize: 9 },
                    alternateRowStyles: { fillColor: [240, 240, 240] }
                });

                const finalY = doc.lastAutoTable.finalY || 40;
                doc.setFontSize(10);
                const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, '');
                doc.text(totalTextContent, 14, finalY + 10);

                const empNamePart = employeeName ? employeeName.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'pracovnik';
                const pdfFileName = `Vykaz-${empNamePart}-${monthName}-${year}.pdf`;
                doc.save(pdfFileName);
                showSaveNotification("PDF exportované.");
            } catch (error) {
                console.error("Chyba pri generovaní PDF v exportToPDF:", error);
                 showSaveNotification("Nastala chyba pri vytváraní PDF súboru.", "error");
            }
        }

        function sendPDF() {
            console.log("sendPDF: Spustené...");
            const doc = initializeJsPDFWithCheck();
            if (!doc) return;

            try {
                 const year = currentYear;
                 const month = currentMonth;
                 const monthName = getMonthName(month);

                doc.setFontSize(16);
                doc.text(`Pracovný výkaz - ${monthName} ${year}`, 14, 20);
                doc.setFontSize(12);
                doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28);

                const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)"];
                const tableRows = [];
                const dataForCurrentMonth = (monthData && monthData[year] && monthData[year][month]) || [];
                const daysInMonthPDF = getDaysInMonth(month);

                 for (let i = 1; i <= daysInMonthPDF; i++) {
                     const dayData = dataForCurrentMonth[i - 1] || { start: '', end: '', breakTime: '' };
                     if (dayData.start || dayData.end) {
                         const dayNum = i;
                         const dayNameStr = getDayName(year, month, dayNum);
                         const breakDisplay = dayData.breakTime || '0';
                         const rowData = [
                             `Deň ${dayNum} (${dayNameStr})`,
                             dayData.start || '-',
                             dayData.end || '-',
                             breakDisplay
                         ];
                         tableRows.push(rowData);
                     }
                 }

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 35,
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName },
                    styles: { font: doc.getFont().fontName, fontSize: 9 },
                    alternateRowStyles: { fillColor: [240, 240, 240] }
                });

                const finalY = doc.lastAutoTable.finalY || 35;
                doc.setFontSize(10);
                // Získaj len počet dní
                let daysWithEntriesText = 'N/A';
                const match = totalSalaryDiv.innerHTML.match(/Počet dní so záznamom: (\d+)/); // Použi upravený regex
                if (match && match[1]) { daysWithEntriesText = match[1]; }
                const summaryText = `Počet dní so záznamom: ${daysWithEntriesText}`;
                doc.text(summaryText, 14, finalY + 10);

                const pdfBlob = doc.output('blob');
                const empNamePart = employeeName ? employeeName.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'pracovnik';
                const pdfFileName = `Vykaz_odoslanie-${empNamePart}-${monthName}-${year}.pdf`;
                const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

                // Web Share API
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                    navigator.share({
                        files: [pdfFile],
                        title: `Pracovný výkaz ${monthName} ${year}`,
                        text: `Výkaz pre ${employeeName || 'pracovníka'} za ${monthName} ${year}.`
                    }).then(() => {
                        showSaveNotification("PDF pripravené na zdieľanie.");
                    }).catch((error) => {
                        if (error.name !== 'AbortError') {
                            console.error('sendPDF: Chyba pri zdieľaní cez Web Share API:', error);
                            showSaveNotification('Chyba pri zdieľaní súboru. Súbor bude stiahnutý.', "warning");
                            triggerDownloadHelper(pdfBlob, pdfFileName); // Fallback na stiahnutie
                        } else {
                            console.log('sendPDF: Zdieľanie PDF zrušené používateľom.');
                        }
                    });
                } else {
                    // Fallback na stiahnutie
                    showSaveNotification("Zdieľanie súborov nie je podporované. Súbor bude stiahnutý.", "info");
                    triggerDownloadHelper(pdfBlob, pdfFileName);
                }
            } catch (error) {
                console.error("Chyba pri generovaní alebo zdieľaní PDF v sendPDF:", error);
                 showSaveNotification("Nastala chyba pri vytváraní alebo zdieľaní PDF.", "error");
            }
        }

         // Pomocná funkcia na stiahnutie
         function triggerDownloadHelper(blob, filename) {
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.style.display = 'none';
             a.href = url;
             a.download = filename;
             document.body.appendChild(a);
             a.click();
             window.URL.revokeObjectURL(url);
             document.body.removeChild(a);
         }


        // 16) Ostatné nastavenia
        function changeDecimalPlaces() {
            const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
            if (!isNaN(newDecimalPlaces) && (newDecimalPlaces === 1 || newDecimalPlaces === 2)) {
                decimalPlaces = newDecimalPlaces;
                recalculateAllRowsAndTotal(); // Prepočítaj všetko s novým počtom miest
                debouncedProcessInputCompletion('settings-change', null); // Ulož zmenu
            }
        }

        function updateEmployeeName() {
            employeeName = employeeNameInput.value; // Aktualizuj globálnu premennú
            updateWelcomeMessage(); // Aktualizuj pozdrav
            debouncedProcessInputCompletion('settings-change', null); // Ulož zmenu
        }

        // Funkcia na aktualizáciu hodinovej mzdy a dane
        function updateSettings() {
            let changed = false;
            const newHourlyWageStr = hourlyWageInput.value;
            const newTaxRateStr = taxRateInput.value;

            const newHourlyWage = parseFloat(newHourlyWageStr);
            const newTaxRatePercent = parseFloat(newTaxRateStr);

            if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
                 if (hourlyWage !== newHourlyWage) {
                    hourlyWage = newHourlyWage;
                    changed = true;
                 }
            }

            if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) {
                const newTaxRateDecimal = newTaxRatePercent / 100;
                 if (taxRate !== newTaxRateDecimal) {
                    taxRate = newTaxRateDecimal;
                    changed = true;
                 }
            }

            if (changed) {
                recalculateAllRowsAndTotal(); // Prepočítaj mzdy s novými sadzbami
                debouncedProcessInputCompletion('settings-change', null); // Ulož zmeny
            }
        }


        function changeMonth() {
            const selectedMonth = parseInt(monthSelect.value);
            if (currentMonth !== selectedMonth) {
                currentMonth = selectedMonth;
                console.log(`Zmenený mesiac na: ${getMonthName(currentMonth)}`);
                handleMonthYearChange();
            }
        }

        function changeYear() {
            const selectedYear = parseInt(yearSelect.value);
            if (currentYear !== selectedYear) {
                currentYear = selectedYear;
                console.log(`Zmenený rok na: ${currentYear}`);
                handleMonthYearChange();
            }
        }

        // Spoločná funkcia pre zmenu mesiaca alebo roka
        function handleMonthYearChange() {
             console.log(`handleMonthYearChange: Spustené pre ${getMonthName(currentMonth)} ${currentYear}`);
             localStorage.setItem('currentMonth', currentMonth.toString());
             localStorage.setItem('currentYear', currentYear.toString());
             // Načítaj dáta pre nový mesiac/rok z localStorage ako prvé
             loadFromLocalStorage(); // Toto aktualizuje monthData a UI
             // Ak je používateľ prihlásený, nastav nový Firestore listener
             if (auth.currentUser) {
                 setupFirestoreListener();
             } else {
                 console.log("handleMonthYearChange: Používateľ nie je prihlásený.");
             }
        }

        function getDaysInMonth(month) { // Jednoduchšia verzia, používa globálny rok
            if (month === undefined || month === null || currentYear === undefined || currentYear === null) {
                console.warn("getDaysInMonth: Chýba mesiac alebo rok, vraciam 31.");
                return 31;
            }
            return new Date(currentYear, month + 1, 0).getDate();
        }

        function getMonthName(month) {
            const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
            return monthNames[month] || 'Neznámy';
        }

        function updateDataSize() {
             try {
                 const totalData = Object.values(localStorage).reduce((acc, value) => acc + (value ? value.length : 0), 0);
                 const kilobytes = (totalData / 1024).toFixed(2);
                 const percentageUsed = Math.min(((totalData / MAX_DATA_SIZE) * 100), 100);

                 dataSizeText.textContent = `Lokálne úložisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
                 dataSizeFill.style.width = `${percentageUsed}%`;

                 // Zmena farby baru
                 dataSizeFill.classList.remove('warn', 'danger'); // Odstráň staré triedy
                 if (percentageUsed > 90) {
                     dataSizeFill.style.backgroundColor = ''; // Reset inline štýl
                     dataSizeFill.classList.add('danger');
                 } else if (percentageUsed > 70) {
                      dataSizeFill.style.backgroundColor = '';
                      dataSizeFill.classList.add('warn');
                 } else {
                     dataSizeFill.style.backgroundColor = ''; // Použije farbu z CSS premennej
                 }
             } catch (error) {
                 console.error("Chyba pri výpočte veľkosti localStorage:", error);
                 dataSizeText.textContent = "Chyba pri výpočte veľkosti dát.";
             }
        }

        function toggleDarkMode() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            applyDarkMode(isDarkMode); // Aplikuj vizuálnu zmenu
            localStorage.setItem('darkMode', JSON.stringify(isDarkMode)); // Ulož nastavenie
            // Ulož zmenu aj do Firebase, ak je používateľ prihlásený
            if (auth.currentUser) {
                 // Priamo zavolaj saveToFirebase alebo cez debounced funkciu?
                 // Priama úprava dokumentu môže byť rýchlejšia pre takúto malú zmenu.
                 // Ale pre konzistenciu použijeme debouncedSaveData
                 debouncedProcessInputCompletion('settings-change', null);
            }
        }

        // 17) Zálohovanie a obnova
        function createBackup() {
            try {
                 // Zhromaždi dáta priamo z localStorage
                const backupData = {
                    backupVersion: 2, // Verzia formátu zálohy
                    backupTimestamp: new Date().toISOString(),
                    workDaysData: localStorage.getItem('workDaysData') || '{}',
                    hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(10),
                    taxRate: localStorage.getItem('taxRate') || JSON.stringify(2), // Uložené ako %
                    darkMode: localStorage.getItem('darkMode') || JSON.stringify(false),
                    decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(2),
                    employeeName: localStorage.getItem('employeeName') || JSON.stringify(''),
                    // Uložiť aj currentMonth/Year? Môže byť užitočné
                    currentMonth: localStorage.getItem('currentMonth') || JSON.stringify(new Date().getMonth()),
                    currentYear: localStorage.getItem('currentYear') || JSON.stringify(new Date().getFullYear())
                };

                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateStr = new Date().toISOString().slice(0, 10);
                const empNamePart = employeeName ? employeeName.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'data';
                a.download = `bruno-calculator-backup-${empNamePart}-${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showSaveNotification("Záloha úspešne vytvorená.");

            } catch (error) {
                console.error("Chyba pri vytváraní zálohy:", error);
                showSaveNotification("Nastala chyba pri vytváraní záložného súboru.", "error");
            }
        }

        function restoreBackup() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json,application/json';

            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);

                        // Základná validácia štruktúry zálohy
                        if (!backup || typeof backup !== 'object' || !backup.workDaysData || typeof backup.workDaysData !== 'string') {
                            throw new Error("Súbor zálohy má nesprávny formát alebo chýbajú kľúčové dáta.");
                        }

                        console.log(`Obnovujem zálohu verzie ${backup.backupVersion || 'N/A'}...`);

                        // Prepíš localStorage hodnotami zo zálohy
                        localStorage.setItem('workDaysData', backup.workDaysData);
                        localStorage.setItem('hourlyWage', backup.hourlyWage || JSON.stringify(10));
                        localStorage.setItem('taxRate', backup.taxRate || JSON.stringify(2));
                        localStorage.setItem('darkMode', backup.darkMode || JSON.stringify(false));
                        localStorage.setItem('decimalPlaces', backup.decimalPlaces || JSON.stringify(2));
                        localStorage.setItem('employeeName', backup.employeeName || JSON.stringify(''));
                        localStorage.setItem('currentMonth', backup.currentMonth || JSON.stringify(new Date().getMonth()));
                        localStorage.setItem('currentYear', backup.currentYear || JSON.stringify(new Date().getFullYear()));

                        // Znovu načítaj stav z práve obnoveného localStorage
                        // Najprv nastav currentMonth/Year z obnovených dát
                         currentMonth = parseInt(JSON.parse(localStorage.getItem('currentMonth')));
                         currentYear = parseInt(JSON.parse(localStorage.getItem('currentYear')));
                         // Potom zavolaj loadFromLocalStorage, ktorý načíta zvyšok a aktualizuje UI
                        loadFromLocalStorage();

                        showSaveNotification("Záloha úspešne obnovená.", "success");

                        // Ak je používateľ prihlásený, pokús sa nahrať obnovené dáta aj do Firebase
                        if (auth.currentUser) {
                             console.log("Obnova zálohy: Ukladám obnovené dáta pre AKTUÁLNY mesiac do Firebase...");
                             // Uloží len aktuálne zobrazený mesiac po obnove
                             debouncedProcessInputCompletion('restore-backup', null);
                             // Pre plnú synchronizáciu by bolo treba iterovať cez všetky mesiace v backup.workDaysData a uložiť ich
                             // (toto je zložitejšie a potenciálne pomalé)
                        }

                    } catch (error) {
                        console.error("Chyba pri spracovaní alebo obnove zálohy:", error);
                        showSaveNotification("Chyba pri obnove zálohy: " + error.message, "error");
                    }
                };
                reader.onerror = (e) => {
                    console.error("Chyba pri čítaní súboru zálohy:", e);
                     showSaveNotification("Nastala chyba pri čítaní súboru zálohy.", "error");
                };
                reader.readAsText(file);
            };
            fileInput.click();
        }

        // 18) Inicializácia
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM načítaný, inicializujem...");
            populateYearSelect(); // Naplní select rokmi

            // Načítaj počiatočný stav z localStorage (pre prípad, že auth listener ešte nezbehol)
             const initialDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
             applyDarkMode(initialDarkMode);

             // Nastav počiatočný mesiac/rok pre prípad, že nie sme prihlásení
             const storedMonth = localStorage.getItem('currentMonth');
             const storedYear = localStorage.getItem('currentYear');
             const now = new Date();
             currentMonth = storedMonth !== null ? parseInt(storedMonth) : now.getMonth();
             currentYear = storedYear !== null ? parseInt(storedYear) : now.getFullYear();
              // Validácia
             if (isNaN(currentMonth) || currentMonth < 0 || currentMonth > 11) currentMonth = now.getMonth();
             if (isNaN(currentYear) || currentYear < 2000 || currentYear > now.getFullYear() + 5) currentYear = now.getFullYear();

             monthSelect.value = currentMonth;
             yearSelect.value = currentYear;

             // Načítaj employeeName pre počiatočný pozdrav
             employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
             updateWelcomeMessage(); // Zobraz pozdrav, ak je meno

             // Zobraz veľkosť dát
             updateDataSize();

             // Registrácia Service Worker (ak existuje)
            if ('serviceWorker' in navigator) {
                 window.addEventListener('load', () => {
                     navigator.serviceWorker.register('./service-worker.js') // Predpokladá sw.js v koreňovom adresári
                         .then(registration => { console.log('ServiceWorker zaregistrovaný s rozsahom: ', registration.scope); })
                         .catch(error => { console.error('Registrácia ServiceWorker zlyhala: ', error); });
                 });
            } else {
                 console.warn("Service Worker nie je podporovaný v tomto prehliadači.");
            }

            console.log("Základná inicializácia dokončená, čakám na stav prihlásenia (onAuthStateChanged)...");
             // Listener onAuthStateChanged sa postará o finálne načítanie dát a UI pre prihláseného používateľa
        });

        function populateYearSelect() {
            const startYear = 2020;
            const endYear = new Date().getFullYear() + 2; // Povoliť výber budúcich rokov
            yearSelect.innerHTML = ''; // Vyčisti staré možnosti
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
             // Nastav aktuálny rok ako vybraný po naplnení
             yearSelect.value = currentYear;
        }

    </script>
</body>
</html>
