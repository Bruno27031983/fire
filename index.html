<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <!-- Načítanie písma Roboto z Google Fonts (externá knižnica) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase knižnice -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <!-- Pridaná knižnica pre Firebase App Check -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF a autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* CSS štýly zostávajú rovnaké */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; }
    .settings > div { flex: 1 1 200px; margin: 5px; }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 800px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode { background-color: #666; color: white; }
    .btn.dark-mode { color: #333; }
    .reset-btn.dark-mode { background-color: #d32f2f; }
    .export-btn.dark-mode { background-color: #388e3c; }
    .restore-btn.dark-mode { background-color: #7B1FA2; }
    .backup-btn.dark-mode { background-color: #E68900; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
    #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
    #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
  <!-- HTML obsah zostáva rovnaký -->
  <div id="loading-container"><h1>Nitra 3 : Žilina 2</h1></div>
  <div id="auth-container" style="display:none;"> <!-- Login/Register form --> <h1>Prihlásenie / Registrácia</h1> <div id="auth-message">Žiadny používateľ nie je prihlásený.</div> <div id="auth-forms"> <h2>Registrácia</h2> <input type="email" id="registerEmail" placeholder="Email"> <input type="password" id="registerPassword" placeholder="Heslo"> <button onclick="register()">Registrovať</button> <h2>Prihlásenie</h2> <input type="email" id="loginEmail" placeholder="Email"> <input type="password" id="loginPassword" placeholder="Heslo"> <button onclick="login()">Prihlásiť sa</button> </div> <button onclick="logout()">Odhlásiť sa</button> </div>
  <div id="calculator-container" class="container" style="display:none;"> <!-- Calculator UI --> <div class="autor-info">Vytvoril Bruno</div> <h1 id="mainTitle">Bruno's Calculator</h1> <h2></h2> <div class="settings"> <div><label for="employeeNameInput">Meno pracovníka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()"></div> <div><label for="hourlyWageInput">Hodinová mzda (€): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div> <div><label for="taxRateInput">Daňové percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"></div> <div><label for="monthSelect">Mesiac: </label><select id="monthSelect" onchange="changeMonth()"><option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option><option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option><option value="6">Júl</option><option value="7">August</option><option value="8">September</option><option value="9">Október</option><option value="10">November</option><option value="11">December</option></select></div> <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div> <div><label for="decimalPlacesSelect">Počet desatinných miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2">2</option></select></div> <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button> </div> <div class="table-container"> <table> <thead><tr><th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka</th><th>Odpracované</th><th>Hrubá Mzda (€)</th><th>Čistá Mzda (€)</th><th>Akcia</th></tr></thead> <tbody id="workDays"></tbody> </table> </div> <div id="totalSalary"></div> <div id="dataSizeContainer"> <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div> <div id="dataSizeBar"><div id="dataSizeFill"></div></div> </div> <div class="btn-container"> <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button> <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button> <button class="btn export-btn" onclick="sendPDF()">Odoslať</button> <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button> <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button> </div> </div>
  <div id="saveNotification"></div>

  <script>
    // Sekcie 1, 2, 3, 4 (okrem calculateRow, calculateTotal), 8, 9, 10 zostávajú rovnaké
    // ... (Firebase config, Globals, Auth, Utils, Save/Load (okrem calc.), Settings, Backup/Restore, Init) ...
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" }; firebase.initializeApp(firebaseConfig); try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktivácii Firebase App Check:", error); } const db = firebase.firestore(); const auth = firebase.auth();
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate; let monthData = {}; const workDays = document.getElementById('workDays'); const totalSalaryDiv = document.getElementById('totalSalary'); const dataSizeText = document.getElementById('dataSizeText'); const dataSizeFill = document.getElementById('dataSizeFill'); const hourlyWageInput = document.getElementById('hourlyWageInput'); const taxRateInput = document.getElementById('taxRateInput'); const monthSelect = document.getElementById('monthSelect'); const yearSelect = document.getElementById('yearSelect'); const decimalPlacesSelect = document.getElementById('decimalPlacesSelect'); const employeeNameInput = document.getElementById('employeeNameInput'); const MAX_DATA_SIZE = 4 * 1024 * 1024; const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;
    function register() { const email = document.getElementById('registerEmail').value; const password = document.getElementById('registerPassword').value; auth.createUserWithEmailAndPassword(email, password) .then((userCredential) => { console.log("Registrovaný:", userCredential.user); alert("Registrácia úspešná!"); }) .catch((error) => { console.error("Chyba pri registrácii:", error.message); alert("Chyba pri registrácii: " + error.message); }); }
    function login() { const email = document.getElementById('loginEmail').value; const password = document.getElementById('loginPassword').value; auth.signInWithEmailAndPassword(email, password) .then((userCredential) => { console.log("Prihlásený:", userCredential.user); alert("Prihlásenie úspešné!"); }) .catch((error) => { console.error("Chyba pri prihlásení:", error.message); alert("Chyba pri prihlásení: " + error.message); }); }
    function logout() { auth.signOut() .then(() => { console.log("Odhlásený."); alert("Odhlásenie úspešné!"); }) .catch((error) => { console.error("Chyba pri odhlásení:", error.message); alert("Chyba pri odhlásení: " + error.message); }); }
    auth.onAuthStateChanged(user => { const authMessage = document.getElementById('auth-message'); const authContainer = document.getElementById('auth-container'); const calculatorContainer = document.getElementById('calculator-container'); const loadingContainer = document.getElementById('loading-container'); if (loadingContainer) loadingContainer.classList.add('hidden'); if (user) { authMessage.textContent = "Prihlásený: " + user.email + (navigator.onLine ? "" : " (Offline)"); authContainer.style.display = "none"; calculatorContainer.style.display = "block"; console.log("Stav prihlásenia zmenený (používateľ prihlásený), načítavam z localStorage..."); loadFromLocalStorage(); if (navigator.onLine) { console.log("Sme online, pokúšam sa načítať aktuálne dáta z Firebase..."); loadFromFirebase().catch(error => { console.error("Nepodarilo sa načítať dáta z Firebase po prihlásení:", error); showSaveNotification("Nepodarilo sa načítať z Firebase", "error"); }); const uid = user.uid; const userDocRef = db.collection("users").doc(uid); userDocRef.get().then(userDocSnap => { if (!userDocSnap.exists) { userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true }) .then(() => console.log("Vytvorený/aktualizovaný dokument pre:", uid)) .catch(err => console.error("Chyba pri vytváraní/aktualizácii dokumentu používateľa:", err)); } }).catch(err => console.error("Chyba pri kontrole dokumentu používateľa:", err)); } else { console.log("Sme offline, pracujem s dátami z localStorage."); showSaveNotification("Pracujete v offline režime", "warning"); } } else { authMessage.textContent = "Žiadny používateľ nie je prihlásený."; authContainer.style.display = "block"; calculatorContainer.style.display = "none"; console.log("Používateľ odhlásený, zobrazujem prihlasovací formulár."); } });
    function debounce(func, wait) { let timeout; return function (...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), wait); }; }
    function showSaveNotification(message, type = 'success') { const notification = document.getElementById('saveNotification'); notification.textContent = message; notification.className = 'show'; if (type === 'error') { notification.classList.add('error'); } else if (type === 'warning') { notification.classList.add('warning'); } notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 3000); }
    async function saveToFirebase() { if (!navigator.onLine) { console.log("Offline, preskakujem ukladanie do Firebase."); return; } const currentUser = auth.currentUser; if (!currentUser) { console.log("Nikto nie je prihlásený, preskakujem ukladanie do Firebase."); return; } try { const currentMonthWorkData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []; const dataToSave = { days: currentMonthWorkData, hourlyWage: hourlyWage || 10, taxRate: (taxRate * 100) || 2, decimalPlaces: decimalPlaces || 1, employeeName: employeeName || '', darkMode: document.body.classList.contains('dark-mode'), timestamp: firebase.firestore.FieldValue.serverTimestamp() }; const yearMonthDoc = `${currentYear}-${currentMonth}`; const uid = currentUser.uid; const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc); await docRef.set(dataToSave); console.log(`saveToFirebase: Dáta pre ${yearMonthDoc} uložené do Firebase v novej štruktúre.`); } catch (error) { console.error(`Chyba pri ukladaní do Firebase pre ${currentYear}-${currentMonth}:`, error); showSaveNotification("Chyba: Nepodarilo sa uložiť do Firebase", "error"); } }
    function saveToLocalStorage() { try { const currentMonthWorkData = []; for (let i = 1; i <= getDaysInMonth(currentMonth); i++) { const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || ''; const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || ''; const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || ''; const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0.00'; const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0.00'; currentMonthWorkData.push({ start, end, breakTime, gross, net }); } if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = currentMonthWorkData; const serializedMonthData = JSON.stringify(monthData); const otherSettingsData = JSON.stringify(hourlyWage) + JSON.stringify(taxRate * 100) + JSON.stringify(document.body.classList.contains('dark-mode')) + JSON.stringify(decimalPlaces) + JSON.stringify(employeeName); const totalDataString = serializedMonthData + otherSettingsData; const bytes = new Blob([totalDataString]).size; if (bytes > MAX_DATA_SIZE) { alert(`Prekročili ste maximálnu veľkosť dát (${MAX_DATA_SIZE_KB} KB) v localStorage. Ukladanie zlyhalo.`); showSaveNotification("Chyba: Dáta sú príliš veľké!", "error"); return; } localStorage.setItem('workDaysData', serializedMonthData); localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage)); localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode'))); localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces)); localStorage.setItem('employeeName', JSON.stringify(employeeName)); localStorage.setItem('currentMonth', currentMonth.toString()); localStorage.setItem('currentYear', currentYear.toString()); updateDataSize(); saveToFirebase(); if (!navigator.onLine) { showSaveNotification("Offline: Uložené len lokálne", "warning"); } else { /* showSaveNotification("Dáta uložené"); */ } } catch (error) { console.error('Chyba pri ukladaní do localStorage:', error); showSaveNotification("Kritická chyba pri ukladaní lokálnych dát!", "error"); } }
    const debouncedSaveToLocalStorage = debounce(saveToLocalStorage, 500);
    async function loadFromFirebase() { const uid = auth.currentUser?.uid; if (!navigator.onLine) { console.log("loadFromFirebase: Offline, načítanie preskočené."); return; } if (!uid) { console.log("loadFromFirebase: Nikto nie je prihlásený."); return; } const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`; console.log(`loadFromFirebase: Pokúšam sa načítať dokument: ${docPath}`); try { const docRef = db.doc(docPath); const docSnap = await docRef.get({ source: 'server' }); if (docSnap.exists) { const data = docSnap.data(); console.log(`loadFromFirebase: Načítané dáta z Firebase pre ${currentYear}-${currentMonth} (nová štruktúra):`, data); try { const firebaseDaysData = data.days || []; const firebaseHourlyWage = data.hourlyWage ?? 10; const firebaseTaxRatePercent = data.taxRate ?? 2; const firebaseDecimalPlaces = data.decimalPlaces ?? 1; const firebaseEmployeeName = data.employeeName ?? ''; const firebaseDarkMode = data.darkMode ?? false; hourlyWage = firebaseHourlyWage; taxRate = firebaseTaxRatePercent / 100; decimalPlaces = firebaseDecimalPlaces; employeeName = firebaseEmployeeName; if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = firebaseDaysData; localStorage.setItem('workDaysData', JSON.stringify(monthData)); localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage)); localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); localStorage.setItem('darkMode', JSON.stringify(firebaseDarkMode)); localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces)); localStorage.setItem('employeeName', JSON.stringify(employeeName)); localStorage.setItem('currentMonth', currentMonth.toString()); localStorage.setItem('currentYear', currentYear.toString()); updateUIFromLoadedData(firebaseDarkMode); showSaveNotification("Dáta synchronizované z Firebase"); } catch (processError) { console.error(`Chyba pri spracovaní dát načítaných z Firebase pre ${currentYear}-${currentMonth}:`, processError); showSaveNotification("Chyba: Nesprávny formát dát z Firebase", "error"); } } else { console.log(`loadFromFirebase: Žiadne dáta na Firebase pre ${currentYear}-${currentMonth}.`); if (monthData && monthData[currentYear]) { monthData[currentYear][currentMonth] = []; } else if (monthData && !monthData[currentYear]) { monthData[currentYear] = {}; monthData[currentYear][currentMonth] = []; } else if (!monthData) { monthData = { [currentYear]: { [currentMonth]: [] } }; } localStorage.setItem('workDaysData', JSON.stringify(monthData)); updateUIFromLoadedData(JSON.parse(localStorage.getItem('darkMode')) || false); } } catch (error) { console.error(`Chyba pri načítavaní z Firebase pre ${currentYear}-${currentMonth}:`, error); showSaveNotification("Chyba: Nepodarilo sa načítať z Firebase", "error"); } }
    function loadFromLocalStorage() { try { console.log(`loadFromLocalStorage: Načítavam pre ${getMonthName(currentMonth)} ${currentYear}`); const storedMonthData = localStorage.getItem('workDaysData'); monthData = storedMonthData ? JSON.parse(storedMonthData) : {}; hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10; taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02; const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false; decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1; employeeName = JSON.parse(localStorage.getItem('employeeName')) || ''; const storedMonth = localStorage.getItem('currentMonth'); const storedYear = localStorage.getItem('currentYear'); const currentDate = new Date(); if (currentMonth === undefined || currentMonth === null) { currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth(); } if (currentYear === undefined || currentYear === null) { currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear(); } updateUIFromLoadedData(darkMode); } catch (error) { console.error(`Kritická chyba pri načítavaní/spracovaní dát z localStorage pre ${getMonthName(currentMonth)} ${currentYear}:`, error); showSaveNotification("Chyba pri načítaní lokálnych dát!", "error"); alert("Chyba pri načítaní lokálnych dát. Skúste vymazať dáta aplikácie alebo obnoviť zálohu."); } }
    function updateUIFromLoadedData(darkModeValue) { console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(currentMonth)} ${currentYear}`); try { hourlyWageInput.value = hourlyWage; taxRateInput.value = taxRate * 100; decimalPlacesSelect.value = decimalPlaces; employeeNameInput.value = employeeName; if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) { monthSelect.value = currentMonth; } else { monthSelect.value = new Date().getMonth();} if (yearSelect.querySelector(`option[value="${currentYear}"]`)) { yearSelect.value = currentYear; } else { yearSelect.value = new Date().getFullYear(); populateYearSelect(); yearSelect.value = currentYear; } createTable(); const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []; console.log(`updateUIFromLoadedData: Počet záznamov pre ${currentYear}-${currentMonth} je ${dataForCurrentMonth.length}`); dataForCurrentMonth.forEach((day, index) => { const i = index + 1; const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`); const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`); const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`); if (startElement && endElement && breakElement) { startElement.value = day.start || ''; endElement.value = day.end || ''; breakElement.value = day.breakTime || ''; calculateRow(i); } }); calculateTotal(); updateDataSize(); applyDarkMode(darkModeValue); console.log("UI aktualizované."); } catch (error) { console.error("Chyba počas aktualizácie UI:", error); showSaveNotification("Chyba pri prekresľovaní UI!", "error"); } }
    function applyDarkMode(isDark) { const elementsToToggle = [ document.body, document.querySelector('.container'), totalSalaryDiv, ...document.querySelectorAll('table, th, td, input'), ...document.querySelectorAll('.btn') ]; const currentDayRow = document.querySelector('.current-day'); if (currentDayRow) elementsToToggle.push(currentDayRow); if (isDark) { elementsToToggle.forEach(el => el?.classList.add('dark-mode')); } else { elementsToToggle.forEach(el => el?.classList.remove('dark-mode')); } }

    // -----------------------
    // 5) Vytváranie tabuľky (a súvisiace funkcie)
    // -----------------------
    function getDayName(year, month, day) { const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"]; return daysOfWeek[new Date(year, month, day).getDay()]; }
    function createTable() { workDays.innerHTML = ''; const daysInMonth = getDaysInMonth(currentMonth); const today = new Date(); const currentDayOfMonth = today.getDate(); const currentMonthIndex = today.getMonth(); const currentYearValue = today.getFullYear(); for (let i = 1; i <= daysInMonth; i++) { const row = document.createElement('tr'); if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) { row.classList.add('current-day'); } const dayName = getDayName(currentYear, currentMonth, i); row.innerHTML = `<td>Deň ${i} (${dayName})</td><td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${currentYear}-${currentMonth}-${i}', ${i})"></td><td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${currentYear}-${currentMonth}-${i}', ${i})"></td><td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="prestávka" oninput="handleBreakInput(${i})"></td><td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces || 1)} h)</td><td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Hrubá Mzda" readonly></td><td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Čistá Mzda" readonly></td><td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>`; workDays.appendChild(row); } applyDarkMode(document.body.classList.contains('dark-mode')); }
    function handleInput(input, nextId, day) { formatAndMoveNext(input, nextId); calculateRow(day); calculateAndUpdateTotals(); }
    function handleBreakInput(day) { calculateRow(day); const currentInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const nextDay = day + 1; if (nextDay <= getDaysInMonth(currentMonth)) { const nextInputElement = document.getElementById(`start-${currentYear}-${currentMonth}-${nextDay}`); if (nextInputElement) moveNext(currentInput, `start-${currentYear}-${currentMonth}-${nextDay}`); } calculateAndUpdateTotals(); }
    function calculateAndUpdateTotals() { calculateTotal(); debouncedSaveToLocalStorage(); }
    function formatAndMoveNext(input, nextId) { let value = input.value.replace(/[^\d:]/g, ''); if (value.length === 3 && value.charAt(2) !== ':') { value = value.slice(0, 2) + ':' + value.slice(2); } else if (value.length === 4 && !value.includes(':')) { value = value.slice(0, 2) + ':' + value.slice(2); } if (value.length > 5) { value = value.slice(0, 5); } input.value = value; if (value.length === 5) { const parts = value.split(':'); if (parts.length === 2) { const hours = parseInt(parts[0], 10); const minutes = parseInt(parts[1], 10); if (!isNaN(hours) && hours >= 0 && hours < 24 && !isNaN(minutes) && minutes >= 0 && minutes < 60) { moveNext(input, nextId); } else { input.style.border = '1px solid red'; setTimeout(() => { input.style.border = ''; }, 2000); } } else { input.style.border = '1px solid red'; setTimeout(() => { input.style.border = ''; }, 2000); } } else { input.style.border = ''; } }
    function moveNext(currentElement, nextId) { const nextElement = document.getElementById(nextId); if (nextElement) { nextElement.focus(); if (nextElement.select) { nextElement.select(); } } }

    // --- UPRAVENÁ calculateRow pre prácu v CENTOCH ---
    function calculateRow(day) {
      const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value;
      const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value;
      const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      const breakTime = parseFloat(breakTimeInput?.value) || 0;
      const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
      const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
      const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

      if (!startTimeStr || !endTimeStr || !totalCell || !grossElement || !netElement) { return; }
      const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
      if (!timeRegex.test(startTimeStr) || !timeRegex.test(endTimeStr)) {
          totalCell.textContent = 'Neplatný čas'; grossElement.value = '0.00'; netElement.value = '0.00'; return;
      }

      const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
      const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
      const startTotalMinutes = startHours * 60 + startMinutes;
      let endTotalMinutes = endHours * 60 + endMinutes;
      if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; }
      const diffMinutes = endTotalMinutes - startTotalMinutes;
      const breakMinutes = breakTime * 60;
      const workedMinutes = Math.max(0, diffMinutes - breakMinutes);

      const hours = Math.floor(workedMinutes / 60);
      const minutes = Math.round(workedMinutes % 60);
      const decimalHours = (workedMinutes / 60);

      totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces || 1)} h)`;

      const currentHourlyWage = parseFloat(hourlyWageInput.value) || 0;
      const currentTaxRate = (parseFloat(taxRateInput.value) || 0) / 100;
      const currentDecimalPlaces = decimalPlaces || 1;
      const hourlyWageInCents = Math.round(currentHourlyWage * 100);
      const grossSalaryInCents = Math.round((workedMinutes / 60) * hourlyWageInCents);
      const netSalaryInCents = Math.round(grossSalaryInCents * (1 - currentTaxRate));

      grossElement.value = (grossSalaryInCents / 100).toFixed(currentDecimalPlaces);
      netElement.value = (netSalaryInCents / 100).toFixed(currentDecimalPlaces);
    }
     // --- KONIEC UPRAVENEJ calculateRow ---

    function resetRow(day) { const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const total = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const net = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (start && end && breakTime && total && gross && net) { start.value = ''; end.value = ''; breakTime.value = ''; total.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`; gross.value = '0.00'; net.value = '0.00'; calculateAndUpdateTotals(); } }
    function resetAll() { if (confirm('Naozaj chcete resetovať všetky záznamy pre tento mesiac?')) { if (monthData && monthData[currentYear]) { monthData[currentYear][currentMonth] = []; } createTable(); calculateTotal(); debouncedSaveToLocalStorage(); showSaveNotification("Dáta pre aktuálny mesiac boli resetované."); } }

    // --- UPRAVENÁ calculateTotal pre prácu v CENTOCH ---
    function calculateTotal() {
      let grandTotalWorkedMinutes = 0;
      let grandTotalGrossSalaryInCents = 0;
      let grandTotalNetSalaryInCents = 0;
      let daysWithEntries = 0;
      const rows = workDays.querySelectorAll('tr');

      const currentHourlyWage = parseFloat(hourlyWageInput.value) || 0;
      const currentTaxRate = (parseFloat(taxRateInput.value) || 0) / 100;
      const currentDecimalPlaces = decimalPlaces || 1;
      const hourlyWageInCents = Math.round(currentHourlyWage * 100);

      rows.forEach((row, index) => {
          const dayIndex = index + 1;
          const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`)?.value;
          const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`)?.value;
          const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`);

          if (startTimeStr || endTimeStr) {
              const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
              if (!timeRegex.test(startTimeStr) || !timeRegex.test(endTimeStr)) {
                  return;
              }
              const breakTime = parseFloat(breakTimeInput?.value) || 0;
              const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
              const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
              const startTotalMinutes = startHours * 60 + startMinutes;
              let endTotalMinutes = endHours * 60 + endMinutes;
              if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; }
              const diffMinutes = endTotalMinutes - startTotalMinutes;
              const breakMinutes = breakTime * 60;
              const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes);

              const grossSalaryInCentsForRow = Math.round((workedMinutesForRow / 60) * hourlyWageInCents);
              const netSalaryInCentsForRow = Math.round(grossSalaryInCentsForRow * (1 - currentTaxRate));

              grandTotalWorkedMinutes += workedMinutesForRow;
              grandTotalGrossSalaryInCents += grossSalaryInCentsForRow;
              grandTotalNetSalaryInCents += netSalaryInCentsForRow;

               if (workedMinutesForRow > 0) {
                   daysWithEntries++;
               }
          }
      });

      const grandTotalDecimalHours = grandTotalWorkedMinutes / 60;
      const grandTotalGrossSalary = grandTotalGrossSalaryInCents / 100;
      const grandTotalNetSalary = grandTotalNetSalaryInCents / 100;
      const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0;
      const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
      const averageHours = Math.floor(averageWorkedMinutes / 60);
      const averageMinutes = Math.round(averageWorkedMinutes % 60);
      const averageDecimalHours = (averageWorkedMinutes / 60);
      const totalHours = Math.floor(grandTotalWorkedMinutes / 60);
      const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60);

      totalSalaryDiv.innerHTML = `
        Počet odpracovaných dní: ${daysWithEntries}<br>
        Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(currentDecimalPlaces)} h)<br>
        Celková hrubá mzda: ${grandTotalGrossSalary.toFixed(currentDecimalPlaces)}€<br>
        Celková čistá mzda: ${grandTotalNetSalary.toFixed(currentDecimalPlaces)}€<br>
        Priemerná čistá mzda na deň: ${averageNetSalary.toFixed(currentDecimalPlaces)}€<br>
        <strong>Priemerný odpracovaný čas na deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(currentDecimalPlaces)} h)</strong>
      `;
    }
     // --- KONIEC UPRAVENEJ calculateTotal ---

    // -----------------------
    // 7) Export do PDF (zostáva rovnaká s opravenou kontrolou)
    // -----------------------
    /* exportToPDF, sendPDF */
    function exportToPDF() { console.log("exportToPDF: Spustené..."); if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Knižnica jsPDF alebo autoTable nie je správne načítaná."); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; } const { jsPDF } = window.jspdf; try { const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("Could not load Roboto font for PDF, using default.", e); } doc.setFontSize(18); doc.text(`Bruno's Calculator - Výkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20); doc.setFontSize(12); doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28); doc.text(`Hodinová mzda: ${hourlyWage || 'N/A'} €`, 14, 34); doc.text(`Daň (%): ${taxRate*100 || 'N/A'}`, 100, 34); const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované", "Hrubá Mzda (€)", "Čistá Mzda (€)"]; const tableRows = []; const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []; console.log(`exportToPDF: Počet záznamov pre ${currentYear}-${currentMonth} v monthData: ${dataForCurrentMonth.length}`); dataForCurrentMonth.forEach((day, index) => { if (day.start || day.end) { const dayNum = index + 1; const dayName = getDayName(currentYear, currentMonth, dayNum); const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${dayNum}`); const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayNum}`); const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayNum}`); const workedTimeText = totalCell ? totalCell.textContent : 'N/A'; const grossValue = grossInput ? grossInput.value : '0.00'; const netValue = netInput ? netInput.value : '0.00'; const rowData = [ `Deň ${dayNum} (${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0', workedTimeText, grossValue, netValue ]; tableRows.push(rowData); } }); console.log("exportToPDF: Dáta pre tabuľku pripravené:", tableRows); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName }, styles: { font: doc.getFont().fontName, fontSize: 9 }, alternateRowStyles: { fillColor: [240, 240, 240] } }); const finalY = doc.lastAutoTable.finalY || 40; doc.setFontSize(10); const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, ''); doc.text(totalTextContent, 14, finalY + 10); const pdfFileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`; doc.save(pdfFileName); console.log(`exportToPDF: PDF súbor "${pdfFileName}" by mal byť stiahnutý.`); showSaveNotification("PDF exportované."); } catch (error) { console.error("Chyba pri generovaní PDF v exportToPDF:", error); alert("Nastala chyba pri vytváraní PDF súboru."); } }
    function sendPDF() { console.log("sendPDF: Spustené..."); if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Knižnica jsPDF alebo autoTable nie je správne načítaná."); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; } const { jsPDF } = window.jspdf; try { const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("sendPDF: Could not load Roboto font, using default.", e); } doc.setFontSize(18); doc.text(`Bruno's Calculator - Výkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20); doc.setFontSize(12); doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28); doc.text(`Hodinová mzda: ${hourlyWage || 'N/A'} €`, 14, 34); doc.text(`Daň (%): ${taxRate*100 || 'N/A'}`, 100, 34); const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované", "Hrubá Mzda (€)", "Čistá Mzda (€)"]; const tableRows = []; const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []; console.log(`sendPDF: Počet záznamov pre ${currentYear}-${currentMonth} v monthData: ${dataForCurrentMonth.length}`); dataForCurrentMonth.forEach((day, index) => { if (day.start || day.end) { const dayNum = index + 1; const dayName = getDayName(currentYear, currentMonth, dayNum); const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${dayNum}`); const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayNum}`); const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayNum}`); const workedTimeText = totalCell ? totalCell.textContent : 'N/A'; const grossValue = grossInput ? grossInput.value : '0.00'; const netValue = netInput ? netInput.value : '0.00'; const rowData = [ `Deň ${dayNum} (${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0', workedTimeText, grossValue, netValue ]; tableRows.push(rowData); } }); console.log("sendPDF: Dáta pre tabuľku pripravené:", tableRows); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName }, styles: { font: doc.getFont().fontName, fontSize: 9 }, alternateRowStyles: { fillColor: [240, 240, 240] } }); const finalY = doc.lastAutoTable.finalY || 40; doc.setFontSize(10); const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, ''); doc.text(totalTextContent, 14, finalY + 10); const pdfBlob = doc.output('blob'); const pdfFileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`; const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' }); console.log(`sendPDF: PDF file "${pdfFileName}" vytvorený ako Blob.`); if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) { console.log("sendPDF: Web Share API je dostupné, pokúšam sa zdieľať."); navigator.share({ files: [pdfFile], title: `Pracovný výkaz ${getMonthName(currentMonth)} ${currentYear}`, text: `Výkaz pre ${employeeName || 'pracovníka'} za ${getMonthName(currentMonth)} ${currentYear}.` }).then(() => { console.log('sendPDF: PDF úspešne zdieľané cez Web Share API.'); showSaveNotification("PDF pripravené na zdieľanie."); }).catch((error) => { if (error.name !== 'AbortError') { console.error('sendPDF: Chyba pri zdieľaní cez Web Share API:', error); alert('Chyba pri zdieľaní súboru.'); } else { console.log('sendPDF: Zdieľanie PDF zrušené používateľom.'); } }); } else { console.log("sendPDF: Web Share API nie je podporované alebo nemôže zdieľať súbory, sťahujem PDF."); alert("Zdieľanie súborov nie je podporované vaším prehliadačom alebo systémom. Súbor bude stiahnutý."); const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = pdfFileName; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); console.log(`sendPDF: PDF súbor "${pdfFileName}" stiahnutý (fallback).`); } } catch (error) { console.error("Chyba pri generovaní alebo zdieľaní PDF v sendPDF:", error); alert("Nastala chyba pri vytváraní alebo zdieľaní PDF súboru."); } }

    // -----------------------
    // 8) Ostatné nastavenia (zostávajú rovnaké)
    // -----------------------
    /* changeDecimalPlaces, updateEmployeeName, updateSettings, changeMonth, changeYear, handleMonthYearChange, getDaysInMonth, getMonthName, updateDataSize, toggleDarkMode */
     function changeDecimalPlaces() { const newDecimalPlaces = parseInt(decimalPlacesSelect.value); if (!isNaN(newDecimalPlaces)) { decimalPlaces = newDecimalPlaces; updateUIFromLoadedData(document.body.classList.contains('dark-mode')); debouncedSaveToLocalStorage(); } }
     function updateEmployeeName() { employeeName = employeeNameInput.value.trim(); debouncedSaveToLocalStorage(); }
     function updateSettings() { const newHourlyWage = parseFloat(hourlyWageInput.value); const newTaxRatePercent = parseFloat(taxRateInput.value); if (!isNaN(newHourlyWage) && newHourlyWage >= 0) { hourlyWage = newHourlyWage; } else { hourlyWageInput.value = hourlyWage; } if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0) { taxRate = newTaxRatePercent / 100; } else { taxRateInput.value = taxRate * 100; } updateUIFromLoadedData(document.body.classList.contains('dark-mode')); debouncedSaveToLocalStorage(); }
     function changeMonth() { const selectedMonth = parseInt(monthSelect.value); if (currentMonth !== selectedMonth) { currentMonth = selectedMonth; console.log(`Zmenený mesiac na: ${getMonthName(currentMonth)}`); handleMonthYearChange(); } }
     function changeYear() { const selectedYear = parseInt(yearSelect.value); if (currentYear !== selectedYear) { currentYear = selectedYear; console.log(`Zmenený rok na: ${currentYear}`); handleMonthYearChange(); } }
     function handleMonthYearChange() { console.log(`handleMonthYearChange: Spustené pre ${getMonthName(currentMonth)} ${currentYear}`); localStorage.setItem('currentMonth', currentMonth.toString()); localStorage.setItem('currentYear', currentYear.toString()); loadFromLocalStorage(); if (navigator.onLine && auth.currentUser) { console.log("Sme online, pokúšam načítať dáta z Firebase pre nový mesiac/rok..."); setTimeout(() => { loadFromFirebase().catch(error => { console.error("Nepodarilo sa načítať dáta z Firebase po zmene mesiaca/roka:", error); }); }, 100); } else { console.log("Offline alebo neprihlásený, zobrazujem dáta z localStorage pre nový mesiac/rok."); } }
     function getDaysInMonth(month) { return new Date(currentYear, month + 1, 0).getDate(); }
     function getMonthName(month) { const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"]; return monthNames[month] || 'Neznámy'; }
     function updateDataSize() { try { const totalData = Object.values(localStorage).reduce((acc, value) => acc + (value ? value.length : 0), 0); const kilobytes = (totalData * 2 / 1024).toFixed(2); const percentageUsed = Math.min(((totalData * 2 / MAX_DATA_SIZE) * 100), 100); dataSizeText.textContent = `Lokálne úložisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`; dataSizeFill.style.width = `${percentageUsed}%`; if (percentageUsed > 90) { dataSizeFill.style.backgroundColor = '#f44336'; } else if (percentageUsed > 70) { dataSizeFill.style.backgroundColor = '#ff9800'; } else { dataSizeFill.style.backgroundColor = '#4CAF50'; } } catch (error) { console.error("Chyba pri výpočte veľkosti localStorage:", error); dataSizeText.textContent = "Chyba pri výpočte veľkosti dát."; } }
     function toggleDarkMode() { const isDarkMode = document.body.classList.toggle('dark-mode'); applyDarkMode(isDarkMode); localStorage.setItem('darkMode', JSON.stringify(isDarkMode)); if (navigator.onLine && auth.currentUser) { const uid = auth.currentUser.uid; db.collection("users").doc(uid).collection("calculatorData").doc(`${currentYear}-${currentMonth}`).set({ darkMode: isDarkMode }, { merge: true }).then(() => console.log("Dark mode stav uložený do Firebase.")).catch(error => console.error("Chyba pri ukladaní dark mode do Firebase:", error)); } }

    // -----------------------
    // 9) Zálohovanie a obnova (zostávajú rovnaké)
    // -----------------------
    /* createBackup, restoreBackup */
     function createBackup() { try { const backupData = { workDaysData: localStorage.getItem('workDaysData') || '{}', hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(10), taxRate: localStorage.getItem('taxRate') || JSON.stringify(2), darkMode: localStorage.getItem('darkMode') || JSON.stringify(false), decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(1), employeeName: localStorage.getItem('employeeName') || JSON.stringify(''), backupVersion: 1, backupTimestamp: new Date().toISOString() }; const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `bruno-calculator-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showSaveNotification("Záloha úspešne vytvorená."); } catch (error) { console.error("Chyba pri vytváraní zálohy:", error); alert("Nastala chyba pri vytváraní záložného súboru."); } }
     function restoreBackup() { const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.json,application/json'; fileInput.onchange = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const backup = JSON.parse(e.target.result); if (backup && typeof backup.workDaysData === 'string' && typeof backup.hourlyWage === 'string') { localStorage.setItem('workDaysData', backup.workDaysData); localStorage.setItem('hourlyWage', backup.hourlyWage); localStorage.setItem('taxRate', backup.taxRate); localStorage.setItem('darkMode', backup.darkMode); localStorage.setItem('decimalPlaces', backup.decimalPlaces); localStorage.setItem('employeeName', backup.employeeName); loadFromLocalStorage(); showSaveNotification("Záloha úspešne obnovená."); alert("Záloha bola úspešne obnovená. Dáta boli načítané."); saveToFirebase(); } else { alert("Chyba: Súbor zálohy má nesprávny formát."); } } catch (error) { console.error("Chyba pri spracovaní alebo obnove zálohy:", error); alert("Chyba pri čítaní alebo obnove zálohy. Súbor môže byť poškodený alebo mať nesprávny formát."); } }; reader.onerror = (e) => { console.error("Chyba pri čítaní súboru zálohy:", e); alert("Nastala chyba pri čítaní súboru zálohy."); }; reader.readAsText(file); }; fileInput.click(); }


    // -----------------------
    // 10) Inicializácia (zostáva rovnaká)
    // -----------------------
    /* DOMContentLoaded listener, populateYearSelect */
     document.addEventListener('DOMContentLoaded', () => { console.log("DOM načítaný, inicializujem..."); populateYearSelect(); hourlyWageInput.value = 10; taxRateInput.value = 2; decimalPlacesSelect.value = 1; employeeNameInput.value = ''; const initialMonth = parseInt(localStorage.getItem('currentMonth')) ?? new Date().getMonth(); const initialYear = parseInt(localStorage.getItem('currentYear')) ?? new Date().getFullYear(); monthSelect.value = initialMonth; yearSelect.value = initialYear; createTable(); calculateTotal(); updateDataSize(); if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js') .then(registration => { console.log('ServiceWorker zaregistrovaný s rozsahom: ', registration.scope); }) .catch(error => { console.error('Registrácia ServiceWorker zlyhala: ', error); }); }); } else { console.warn("Service Worker nie je podporovaný v tomto prehliadači."); } console.log("Základná inicializácia dokončená, čakám na stav prihlásenia..."); });
     function populateYearSelect() { const startYear = 2020; const endYear = new Date().getFullYear() + 2; yearSelect.innerHTML = ''; for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); } }

  </script>
</body>
</html>
