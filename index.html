<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <!-- PRIDANÝ SKRIPT PRE PÍSMO S PODPOROU DIAKRITIKY -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-customfonts/1.0.4/DejavuSans-normal.js"></script>

  <style>
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .settings > div, .settings > details, .settings > button { flex: 1 1 200px; margin: 0; }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 950px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; position: relative; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
    input[type="tel"] { padding-right: 28px; }
    .time-icon { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2em; color: #555; user-select: none; z-index: 2; }
    .time-icon:hover { color: #007bff; opacity: 0.8; }
    body.dark-mode .time-icon { color: #bbb; }
    body.dark-mode .time-icon:hover { color: #87cefa; }
    .note-indicator-icon { display: none; font-size: 0.9em; margin-right: 4px; color: #28a745; vertical-align: middle; cursor: default; }
    body.dark-mode .note-indicator-icon { color: #6fbf7a; }
    th:nth-child(1), td:nth-child(1) { min-width: 50px; }
    th:nth-child(2), td:nth-child(2) { min-width: 90px; }
    th:nth-child(3), td:nth-child(3) { min-width: 90px; }
    th:nth-child(4), td:nth-child(4) { min-width: 80px; }
    th:nth-child(5), td:nth-child(5) { min-width: 120px; }
    th:nth-child(6), td:nth-child(6) { min-width: 90px; }
    th:nth-child(7), td:nth-child(7) { min-width: 90px; }
    th:nth-child(8), td:nth-child(8) { min-width: 130px; }
    th:last-child, td:last-child { min-width: 90px; text-align: center; }
    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input, .current-day .note-textarea { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode { background-color: #666; color: white; border-color: #888; }
    .btn.dark-mode { color: #333; }
    .reset-btn.dark-mode { background-color: #d32f2f; }
    .export-btn.dark-mode { background-color: #388e3c; }
    .restore-btn.dark-mode { background-color: #7B1FA2; }
    .backup-btn.dark-mode { background-color: #E68900; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input, .current-day.dark-mode .note-textarea { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
    #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
    #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }
    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
    .collapsible-settings summary:hover { background-color: #eee; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
    body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
    body.dark-mode .collapsible-content { border-top-color: #666; }
    .note-container { display: none; margin-top: 5px; }
    .note-container.visible { display: block; }
    .note-textarea { width: 95%; min-height: 40px; resize: vertical; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; background-color: #f0f0f0; }
    .toggle-note-btn { background-color: #6c757d; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease; margin-bottom: 2px; vertical-align: middle; }
    .toggle-note-btn:hover { background-color: #5a6268; }
    .note-textarea.dark-mode { background-color: #555; color: #f4f4f4; border-color: #777; }
    .toggle-note-btn.dark-mode { background-color: #828a91; }
    .toggle-note-btn.dark-mode:hover { background-color: #70777d; }
  </style>
</head>
<body>
  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>
    <div class="settings">
        <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
                <option value="0">Január</option>
                <option value="1">Február</option>
                <option value="2">Marec</option>
                <option value="3">Apríl</option>
                <option value="4">Máj</option>
                <option value="5">Jún</option>
                <option value="6">Júl</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">Október</option>
                <option value="10">November</option>
                <option value="11">December</option>
            </select>
        </div>

        <details class="collapsible-settings">
            <summary>Ďalšie nastavenia</summary>
            <div class="collapsible-content">
                <div>
                    <label for="employeeNameInput">Meno pracovníka: </label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinová mzda (€): </label>
                    <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="taxRateInput">Daňové percento (%): </label>
                    <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="yearSelect">Rok: </label>
                    <select id="yearSelect" onchange="changeYear()"></select>
                </div>
                <div>
                    <label for="decimalPlacesSelect">Počet desatinných miest: </label>
                    <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>
            </div>
        </details>

        <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka</th>
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th class="th-note">Poznámka</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
    </div>
  </div>
  <div id="saveNotification"></div>

  <script>
    // Firebase Config & Init
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktivácii Firebase App Check:", error); }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Offline Persistence
    db.enablePersistence().catch((err) => { 
      if (err.code == 'failed-precondition') { 
        console.warn("Firestore offline: Viacnásobné taby."); 
      } else if (err.code == 'unimplemented') { 
        console.error("Firestore offline: Prehliadač nepodporovaný."); 
      } 
    });

    // Globálne premenné
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
    let monthData = {};
    let firestoreListenerUnsubscribe = null;
    
    // NOVÉ: Tracking aktívnych zmien a timestamp
    let localChangeTimestamp = 0;
    let isUserEditing = false;
    let editingTimeout = null;
    let pendingChanges = new Set(); // Track ktoré polia sa práve menia

    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const MAX_DATA_SIZE = 4 * 1024 * 1024;
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // Auth funkcie
    function register() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => { alert("Registrácia úspešná!"); })
        .catch((error) => { console.error("Chyba pri registrácii:", error.message); alert("Chyba pri registrácii: " + error.message); });
    }

    function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => { alert("Prihlásenie úspešné!"); })
        .catch((error) => { console.error("Chyba pri prihlásení:", error.message); alert("Chyba pri prihlásení: " + error.message); });
    }

    function logout() {
      auth.signOut()
        .then(() => { alert("Odhlásenie úspešné!"); })
        .catch((error) => { console.error("Chyba pri odhlásení:", error.message); alert("Chyba pri odhlásení: " + error.message); });
    }

    function forgotPassword() {
      const emailInput = document.getElementById('loginEmail');
      const email = emailInput.value;
      if (!email) {
        alert("Prosím, zadajte svoju e-mailovú adresu do poľa pre prihlásenie.");
        emailInput.focus();
        return;
      }
      auth.sendPasswordResetEmail(email)
        .then(() => { alert("Odkaz na obnovenie hesla bol odoslaný na vašu e-mailovú adresu."); })
        .catch((error) => { console.error("Chyba pri odosielaní e-mailu:", error); alert("Chyba: " + error.message); });
    }

    // Auth State Change
    auth.onAuthStateChanged(user => {
      const authContainer = document.getElementById('auth-container');
      const calculatorContainer = document.getElementById('calculator-container');

      if (firestoreListenerUnsubscribe) {
        firestoreListenerUnsubscribe();
        firestoreListenerUnsubscribe = null;
      }

      if (user) {
        document.getElementById('auth-message').textContent = "Prihlásený: " + user.email;
        authContainer.style.display = "none";
        calculatorContainer.style.display = "block";

        const storedMonth = localStorage.getItem('currentMonth');
        const storedYear = localStorage.getItem('currentYear');
        const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        const currentDate = new Date();
        
        currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
        currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
        
        monthSelect.value = currentMonth;
        if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
          yearSelect.value = currentYear;
        } else {
          currentYear = currentDate.getFullYear();
          populateYearSelect();
          yearSelect.value = currentYear;
        }

        applyDarkMode(darkMode);
        
        hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
        taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
        decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
        employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
        
        hourlyWageInput.value = hourlyWage;
        taxRateInput.value = taxRate * 100;
        decimalPlacesSelect.value = decimalPlaces;
        employeeNameInput.value = employeeName;

        loadFromLocalStorage();
        setupFirestoreListener();

        const uid = user.uid;
        const userDocRef = db.collection("users").doc(uid);
        userDocRef.get().then(userDocSnap => {
          if (!userDocSnap.exists) {
            userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true })
              .catch(err => console.error("Chyba pri vytváraní dokumentu používateľa:", err));
          }
        }).catch(err => { console.error("Chyba pri kontrole dokumentu:", err); });

      } else {
        document.getElementById('auth-message').textContent = "Žiadny používateľ nie je prihlásený.";
        authContainer.style.display = "block";
        calculatorContainer.style.display = "none";
        monthData = {};
        workDays.innerHTML = '';
        totalSalaryDiv.innerHTML = '';
        updateWelcomeMessage();
      }
    });

    // Utility funkcie
    function showSaveNotification(message, type = 'success') {
      const notification = document.getElementById('saveNotification');
      notification.textContent = message;
      notification.className = 'show';
      if (type === 'error') {
        notification.classList.add('error');
      } else if (type === 'warning') {
        notification.classList.add('warning');
      }
      setTimeout(() => notification.classList.remove('show'), 3000);
    }

    function getFirstName(fullName) {
      if (!fullName || typeof fullName !== 'string') return '';
      const trimmedName = fullName.trim();
      if (!trimmedName) return '';
      const parts = trimmedName.split(' ');
      return parts[0];
    }

    function updateWelcomeMessage() {
      const welcomeElement = document.getElementById('welcomeMessage');
      if (!welcomeElement) return;
      const firstName = getFirstName(employeeName);
      if (firstName) {
        welcomeElement.textContent = `Vitaj späť, ${firstName}! 👋`;
      } else {
        welcomeElement.textContent = '';
      }
    }

    // VYLEPŠENÝ Firestore Listener s ochranou pred vymazávaním
    function setupFirestoreListener() {
      if (firestoreListenerUnsubscribe) {
        firestoreListenerUnsubscribe();
        firestoreListenerUnsubscribe = null;
      }

      const uid = auth.currentUser?.uid;
      if (!uid) return;

      if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
        const now = new Date();
        currentMonth = currentMonth ?? now.getMonth();
        currentYear = currentYear ?? now.getFullYear();
      }

      const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
      const docRef = db.doc(docPath);

      firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
        const hasPending = docSnap.metadata.hasPendingWrites;
        const activeElementId = document.activeElement?.id;

        // Ak ide o náš vlastný zápis, neaktualizujeme UI
        if (hasPending) {
          if (docSnap.exists) {
            const data = docSnap.data();
            const firebaseDaysData = data.days || [];
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
              start: day.start || '',
              end: day.end || '',
              breakTime: day.breakTime || '',
              note: day.note || '',
              noteVisible: day.noteVisible === true
            }));
          }
          return;
        }

        // NOVÁ LOGIKA: Ak používateľ aktívne edituje, odložíme sync
        if (isUserEditing || pendingChanges.size > 0) {
          console.log('Používateľ edituje, odloženie Firestore sync...');
          return;
        }

        // Overíme timestamp - ak je lokálna zmena čerstvejšia, ignorujeme Firebase
        const firestoreTimestamp = docSnap.data()?.timestamp?.toMillis() || 0;
        if (localChangeTimestamp > firestoreTimestamp && (Date.now() - localChangeTimestamp < 5000)) {
          console.log('Lokálna zmena je čerstvejšia, ignorujem Firebase update');
          return;
        }

        if (docSnap.exists) {
          const data = docSnap.data();
          try {
            const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
            const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
            const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
            const firebaseEmployeeName = data.employeeName ?? employeeName;
            const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');
            const firebaseDaysData = data.days || [];

            hourlyWage = firebaseHourlyWage;
            taxRate = firebaseTaxRatePercent / 100;
            decimalPlaces = firebaseDecimalPlaces;
            employeeName = firebaseEmployeeName;

            if (document.activeElement !== hourlyWageInput) { hourlyWageInput.value = hourlyWage; }
            if (document.activeElement !== taxRateInput) { taxRateInput.value = taxRate * 100; }
            decimalPlacesSelect.value = decimalPlaces;
            if (document.activeElement !== employeeNameInput) { employeeNameInput.value = employeeName; }

            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            
            // NOVÁ LOGIKA: Merge namiesto prepísania
            const existingData = monthData[currentYear][currentMonth] || [];
            monthData[currentYear][currentMonth] = firebaseDaysData.map((day, idx) => {
              const existing = existingData[idx] || {};
              // Zachovaj lokálne dáta ak sú novšie
              return {
                start: day.start || existing.start || '',
                end: day.end || existing.end || '',
                breakTime: day.breakTime || existing.breakTime || '',
                note: day.note || existing.note || '',
                noteVisible: day.noteVisible === true || existing.noteVisible === true
              };
            });

            const daysInMonth = getDaysInMonth(currentMonth);
            let anyRowRecalculated = false;

            for (let i = 1; i <= daysInMonth; i++) {
              const dayIndex = i - 1;
              const firebaseDayData = monthData[currentYear]?.[currentMonth]?.[dayIndex] || {
                start: '', end: '', breakTime: '', note: '', noteVisible: false
              };

              const startId = `start-${currentYear}-${currentMonth}-${i}`;
              const endId = `end-${currentYear}-${currentMonth}-${i}`;
              const breakId = `break-${currentYear}-${currentMonth}-${i}`;
              const noteId = `note-${currentYear}-${currentMonth}-${i}`;
              const noteContainerId = `note-container-${currentYear}-${currentMonth}-${i}`;
              const noteButtonId = `note-toggle-${currentYear}-${currentMonth}-${i}`;
              const noteIndicatorId = `note-indicator-${currentYear}-${currentMonth}-${i}`;

              const startElement = document.getElementById(startId);
              const endElement = document.getElementById(endId);
              const breakElement = document.getElementById(breakId);
              const noteElement = document.getElementById(noteId);
              const noteContainer = document.getElementById(noteContainerId);
              const noteButton = document.getElementById(noteButtonId);
              const noteIndicator = document.getElementById(noteIndicatorId);

              if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
                const newStart = firebaseDayData.start || '';
                const newEnd = firebaseDayData.end || '';
                const newBreak = firebaseDayData.breakTime || '';
                const newNote = firebaseDayData.note || '';
                const newNoteVisible = firebaseDayData.noteVisible === true;
                let rowUpdatedByListener = false;

                // VYLEPŠENÉ: Neprepisuj ak je pole práve editované
                if (startElement.value !== newStart && activeElementId !== startId && !pendingChanges.has(startId)) {
                  startElement.value = newStart;
                  rowUpdatedByListener = true;
                }
                if (endElement.value !== newEnd && activeElementId !== endId && !pendingChanges.has(endId)) {
                  endElement.value = newEnd;
                  rowUpdatedByListener = true;
                }
                if (breakElement.value !== newBreak && activeElementId !== breakId && !pendingChanges.has(breakId)) {
                  breakElement.value = newBreak;
                  rowUpdatedByListener = true;
                }
                if (noteElement.value !== newNote && activeElementId !== noteId && !pendingChanges.has(noteId)) {
                  noteElement.value = newNote;
                  updateNoteIndicator(i);
                }

                const currentNoteVisible = noteContainer.classList.contains('visible');
                if (currentNoteVisible !== newNoteVisible) {
                  noteContainer.classList.toggle('visible', newNoteVisible);
                  noteButton.textContent = newNoteVisible ? 'Skryť' : 'Poznámka';
                }

                if (rowUpdatedByListener) {
                  calculateRow(i);
                  anyRowRecalculated = true;
                }
              }
            }

            if (anyRowRecalculated) { calculateTotal(); }
            applyDarkMode(firebaseDarkMode);
            updateWelcomeMessage();
            updateDataSize();

            if (!docSnap.metadata.fromCache) {
              showSaveNotification("Dáta synchronizované");
            }

          } catch (processError) {
            console.error(`Listener: Chyba pri spracovaní dát:`, processError);
            showSaveNotification("Chyba: Nesprávny formát dát z Firebase", "error");
          }
        } else {
          if (!monthData) monthData = {};
          if (!monthData[currentYear]) monthData[currentYear] = {};
          monthData[currentYear][currentMonth] = [];
          localStorage.setItem('workDaysData', JSON.stringify(monthData));

          hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
          taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
          const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
          decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
          employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

          hourlyWageInput.value = hourlyWage;
          taxRateInput.value = taxRate * 100;
          decimalPlacesSelect.value = decimalPlaces;
          employeeNameInput.value = employeeName;

          createTable();
          calculateTotal();
          applyDarkMode(darkMode);
          updateWelcomeMessage();
          updateDataSize();
        }

      }, (error) => {
        console.error(`Firestore listener CHYBA:`, error);
        showSaveNotification("Chyba: Nepodarilo sa pripojiť k Firebase", "error");
        loadFromLocalStorage();
      });
    }

    // VYLEPŠENÉ ukladanie do Firebase
    async function saveToFirebase() {
      const currentUser = auth.currentUser;
      if (!currentUser) return;
      
      try {
        localChangeTimestamp = Date.now(); // Zaznamenaj čas lokálnej zmeny

        const currentMonthWorkData = ((monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []).map(day => ({
          start: day.start || '',
          end: day.end || '',
          breakTime: day.breakTime || '',
          note: day.note || '',
          noteVisible: day.noteVisible === true
        }));

        const dataToSave = {
          days: currentMonthWorkData,
          hourlyWage: hourlyWage || 10,
          taxRate: (taxRate * 100) || 2,
          decimalPlaces: decimalPlaces || 1,
          employeeName: employeeName || '',
          darkMode: document.body.classList.contains('dark-mode'),
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        const yearMonthDoc = `${currentYear}-${currentMonth}`;
        const uid = currentUser.uid;
        const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);
        
        await docRef.set(dataToSave);
        
      } catch (error) {
        console.error(`Chyba pri ukladaní do Firebase:`, error);
        showSaveNotification("Chyba: Nepodarilo sa odoslať dáta do Firebase", "error");
      }
    }

    // VYLEPŠENÉ ukladanie do Local Storage
    let saveTimeout = null;
    function saveToLocalStorage() {
      try {
        if (!monthData) monthData = {};
        if (!monthData[currentYear]) monthData[currentYear] = {};
        if (!monthData[currentYear][currentMonth]) {
          monthData[currentYear][currentMonth] = [];
        }

        localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
        localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
        localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
        localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
        localStorage.setItem('employeeName', JSON.stringify(employeeName));
        localStorage.setItem('currentMonth', currentMonth.toString());
        localStorage.setItem('currentYear', currentYear.toString());

        const serializedMonthData = JSON.stringify(monthData);
        const bytes = new Blob([serializedMonthData]).size;

        if (bytes > MAX_DATA_SIZE * 0.9) {
          console.warn(`Veľkosť dát v localStorage sa blíži k limitu: ${bytes} bajtov`);
        }
        if (bytes > MAX_DATA_SIZE) {
          alert(`Prekročili ste maximálnu veľkosť dát (~${MAX_DATA_SIZE_KB} KB).`);
          showSaveNotification("Chyba: Lokálne dáta sú príliš veľké!", "error");
          return;
        }

        localStorage.setItem('workDaysData', serializedMonthData);
        updateDataSize();

        // Debounce Firebase save
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          saveToFirebase();
          if (!navigator.onLine) {
            showSaveNotification("Offline: Zmeny uložené lokálne", "warning");
          }
        }, 1000);

      } catch (error) {
        console.error('Chyba pri ukladaní:', error);
        showSaveNotification("Kritická chyba pri ukladaní!", "error");
      }
    }

    function loadFromLocalStorage() {
      try {
        if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
          const storedMonth = localStorage.getItem('currentMonth');
          const storedYear = localStorage.getItem('currentYear');
          const currentDate = new Date();
          currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
          currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
        }

        const storedMonthData = localStorage.getItem('workDaysData');
        monthData = storedMonthData ? JSON.parse(storedMonthData) : {};

        if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) {
          monthData[currentYear][currentMonth] = monthData[currentYear][currentMonth].map(day => ({
            ...day,
            noteVisible: day.noteVisible === true
          }));
        }

        hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
        taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
        const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
        employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
        
        updateUIFromLoadedData(darkMode);
      } catch (error) {
        console.error(`Chyba pri načítavaní dát:`, error);
        showSaveNotification("Chyba pri načítaní lokálnych dát!", "error");
        monthData = {};
        createTable();
        calculateTotal();
      }
    }

    function updateUIFromLoadedData(darkModeValue) {
      try {
        hourlyWageInput.value = hourlyWage;
        taxRateInput.value = taxRate * 100;
        decimalPlacesSelect.value = decimalPlaces;
        employeeNameInput.value = employeeName;

        if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
          monthSelect.value = currentMonth;
        } else {
          monthSelect.value = new Date().getMonth();
          currentMonth = parseInt(monthSelect.value);
        }

        if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
          yearSelect.value = currentYear;
        } else {
          yearSelect.value = new Date().getFullYear();
          currentYear = parseInt(yearSelect.value);
          populateYearSelect();
          yearSelect.value = currentYear;
        }

        createTable();
        const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];

        dataForCurrentMonth.forEach((day, index) => {
          const i = index + 1;
          const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
          const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
          const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
          const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);
          const noteContainer = document.getElementById(`note-container-${currentYear}-${currentMonth}-${i}`);
          const noteButton = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${i}`);
          const noteIndicator = document.getElementById(`note-indicator-${currentYear}-${currentMonth}-${i}`);

          if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
            startElement.value = day.start || '';
            endElement.value = day.end || '';
            breakElement.value = day.breakTime || '';
            noteElement.value = day.note || '';
            calculateRow(i);

            const isNoteVisible = day.noteVisible === true;
            noteContainer.classList.toggle('visible', isNoteVisible);
            noteButton.textContent = isNoteVisible ? 'Skryť' : 'Poznámka';
            updateNoteIndicator(i);

            const isDarkModeActive = document.body.classList.contains('dark-mode');
            if (noteElement) noteElement.classList.toggle('dark-mode', isDarkModeActive);
            if (noteButton) noteButton.classList.toggle('dark-mode', isDarkModeActive);
            if (noteIndicator) noteIndicator.classList.toggle('dark-mode', isDarkModeActive);
          }
        });

        calculateTotal();
        updateDataSize();
        applyDarkMode(darkModeValue);
        updateWelcomeMessage();
      } catch (error) {
        console.error("Chyba počas aktualizácie UI:", error);
        showSaveNotification("Chyba pri prekresľovaní UI!", "error");
      }
    }

    function applyDarkMode(isDark) {
      const elementsToToggle = [
        document.body,
        document.querySelector('.container'),
        totalSalaryDiv,
        document.querySelector('.collapsible-settings summary'),
        ...document.querySelectorAll('table, th, td'),
        ...document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"], select'),
        ...document.querySelectorAll('.btn'),
        ...document.querySelectorAll('.toggle-note-btn'),
        ...document.querySelectorAll('.note-textarea'),
        ...document.querySelectorAll('.time-icon'),
        ...document.querySelectorAll('.note-indicator-icon')
      ];
      
      elementsToToggle.forEach(el => el?.classList[isDark ? 'add' : 'remove']('dark-mode'));
      
      const currentDayRow = document.querySelector('.current-day');
      if (currentDayRow) {
        currentDayRow.classList[isDark ? 'add' : 'remove']('dark-mode');
        currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn').forEach(el => 
          el?.classList[isDark ? 'add' : 'remove']('dark-mode')
        );
      }
    }

    function getDayName(year, month, day) {
      const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"];
      return daysOfWeek[new Date(year, month, day).getDay()];
    }

    function createTable() {
      workDays.innerHTML = '';
      const daysInMonth = getDaysInMonth(currentMonth);
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }

        const dayName = getDayName(currentYear, currentMonth, i);
        const baseId = `${currentYear}-${currentMonth}-${i}`;
        const startId = `start-${baseId}`;
        const endId = `end-${baseId}`;
        const breakId = `break-${baseId}`;
        const totalId = `total-${baseId}`;
        const grossId = `gross-${baseId}`;
        const netId = `net-${baseId}`;
        const noteToggleId = `note-toggle-${baseId}`;
        const noteContainerId = `note-container-${baseId}`;
        const noteTextareaId = `note-${baseId}`;
        const noteIndicatorId = `note-indicator-${baseId}`;

        row.innerHTML = `
          <td>Deň ${i} (${dayName})</td>
          <td>
            <input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}', ${i})">
            <span class="time-icon" title="Vložiť aktuálny čas" onclick="insertCurrentTime('${startId}')">⏰</span>
          </td>
          <td>
            <input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}', ${i})">
            <span class="time-icon" title="Vložiť aktuálny čas" onclick="insertCurrentTime('${endId}')">⏰</span>
          </td>
          <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="prestávka" oninput="handleBreakInput(${i})"></td>
          <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces || 1)} h)</td>
          <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="Hrubá Mzda" readonly></td>
          <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="Čistá Mzda" readonly></td>
          <td>
            <span class="note-indicator-icon" id="${noteIndicatorId}">📝</span>
            <button id="${noteToggleId}" class="toggle-note-btn" onclick="toggleNote(${i})">Poznámka</button>
            <div id="${noteContainerId}" class="note-container">
              <textarea id="${noteTextareaId}" class="note-textarea" placeholder="Zadajte poznámku..." oninput="handleNoteInput(this, ${i})"></textarea>
            </div>
          </td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>
        `;
        workDays.appendChild(row);
      }
      
      applyDarkMode(document.body.classList.contains('dark-mode'));
    }

    window.insertCurrentTime = function(targetInputId) {
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const formattedTime = `${hours}:${minutes}`;

      const targetInput = document.getElementById(targetInputId);
      if (targetInput) {
        targetInput.value = formattedTime;
        const day = parseInt(targetInputId.split('-')[3]);
        if (!isNaN(day)) {
          updateMonthDataFromInput(targetInput, day);
          calculateRow(day);
          calculateTotal();
          saveToLocalStorage();
        }
      }
    }

    function toggleNote(day) {
      const containerId = `note-container-${currentYear}-${currentMonth}-${day}`;
      const buttonId = `note-toggle-${currentYear}-${currentMonth}-${day}`;
      const noteContainer = document.getElementById(containerId);
      const toggleButton = document.getElementById(buttonId);

      if (noteContainer && toggleButton) {
        const isVisible = noteContainer.classList.toggle('visible');
        toggleButton.textContent = isVisible ? 'Skryť' : 'Poznámka';

        const dayIndex = day - 1;
        if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth] && monthData[currentYear][currentMonth][dayIndex]) {
          monthData[currentYear][currentMonth][dayIndex].noteVisible = isVisible;
        } else {
          if (!monthData) monthData = {};
          if (!monthData[currentYear]) monthData[currentYear] = {};
          if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
          while (dayIndex >= monthData[currentYear][currentMonth].length) {
            monthData[currentYear][currentMonth].push({
              start: '', end: '', breakTime: '', note: '', noteVisible: false
            });
          }
          monthData[currentYear][currentMonth][dayIndex].noteVisible = isVisible;
        }
        
        saveToLocalStorage();

        if (document.body.classList.contains('dark-mode')) {
          const textarea = noteContainer.querySelector('textarea');
          if (textarea) textarea.classList.toggle('dark-mode', isVisible);
          toggleButton.classList.toggle('dark-mode', isVisible);
        }
      }
    }

    function updateNoteIndicator(day) {
      const noteTextarea = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`);
      const indicatorIcon = document.getElementById(`note-indicator-${currentYear}-${currentMonth}-${day}`);
      
      if (noteTextarea && indicatorIcon) {
        const hasContent = noteTextarea.value.trim() !== '';
        indicatorIcon.style.display = hasContent ? 'inline-block' : 'none';
        indicatorIcon.classList.toggle('dark-mode', document.body.classList.contains('dark-mode'));
      }
    }

    function isTimeValid(timeStr) {
      const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
      return timeRegex.test(timeStr);
    }

    // VYLEPŠENÉ input handling s ochranou
    function handleInput(input, nextId, day) {
      // Označ že pole sa edituje
      isUserEditing = true;
      pendingChanges.add(input.id);
      
      if (editingTimeout) clearTimeout(editingTimeout);
      editingTimeout = setTimeout(() => {
        isUserEditing = false;
        pendingChanges.delete(input.id);
      }, 2000);

      formatInput(input);
      updateMonthDataFromInput(input, day);
      calculateRow(day);
      calculateTotal();
      saveToLocalStorage();
      
      if (input.type === 'tel' && input.value.length === 5 && isTimeValid(input.value)) {
        moveNext(input, nextId);
      }
    }

    function handleBreakInput(day) {
      const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      isUserEditing = true;
      pendingChanges.add(input.id);
      
      if (editingTimeout) clearTimeout(editingTimeout);
      editingTimeout = setTimeout(() => {
        isUserEditing = false;
        pendingChanges.delete(input.id);
      }, 2000);

      updateMonthDataFromInput(input, day);
      calculateRow(day);
      calculateTotal();
      saveToLocalStorage();
    }

    function handleNoteInput(textarea, day) {
      isUserEditing = true;
      pendingChanges.add(textarea.id);
      
      if (editingTimeout) clearTimeout(editingTimeout);
      editingTimeout = setTimeout(() => {
        isUserEditing = false;
        pendingChanges.delete(textarea.id);
      }, 2000);

      updateMonthDataFromInput(textarea, day);
      saveToLocalStorage();
      updateNoteIndicator(day);
    }

    function updateMonthDataFromInput(input, day) {
      if (!input) return;
      
      const dayIndex = day - 1;
      const fieldId = input.id;
      let field = 'unknown';

      if (fieldId.startsWith('start-')) field = 'start';
      else if (fieldId.startsWith('end-')) field = 'end';
      else if (fieldId.startsWith('break-')) field = 'breakTime';
      else if (fieldId.startsWith('note-')) field = 'note';

      const value = input.value;

      if (field !== 'unknown') {
        if (!monthData) monthData = {};
        if (!monthData[currentYear]) monthData[currentYear] = {};
        if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];

        while (dayIndex >= monthData[currentYear][currentMonth].length) {
          monthData[currentYear][currentMonth].push({
            start: '', end: '', breakTime: '', note: '', noteVisible: false
          });
        }

        if (monthData[currentYear][currentMonth][dayIndex] && typeof monthData[currentYear][currentMonth][dayIndex].noteVisible === 'undefined') {
          monthData[currentYear][currentMonth][dayIndex].noteVisible = false;
        }

        if (!monthData[currentYear][currentMonth][dayIndex]) {
          monthData[currentYear][currentMonth][dayIndex] = {
            start: '', end: '', breakTime: '', note: '', noteVisible: false
          };
        }

        const currentValue = monthData[currentYear]?.[currentMonth]?.[dayIndex]?.[field];
        if (currentValue !== value) {
          monthData[currentYear][currentMonth][dayIndex][field] = value;
        }
      }
    }

    function formatInput(input) {
      if (!input || input.type !== 'tel') return;
      
      let value = input.value.replace(/[^\d:]/g, '');

      if (value.length === 4 && !value.includes(':')) {
        value = value.slice(0, 2) + ':' + value.slice(2);
      } else if (value.length === 3 && value.charAt(2) !== ':' && parseInt(value.slice(0, 2)) <= 23) {
        value = value.slice(0, 2) + ':' + value.slice(2);
      }

      if (value.length > 5) {
        value = value.slice(0, 5);
      }

      if (input.value !== value) {
        input.value = value;
      }

      if (value.length > 0 && value.length < 5) {
        if (input.style.border !== '') input.style.border = '';
      } else if (value.length === 5) {
        if (isTimeValid(value)) {
          if (input.style.border !== '') input.style.border = '';
        } else {
          input.style.border = '1px solid red';
          setTimeout(() => {
            if (input.style.borderColor === 'red') input.style.border = '';
          }, 2000);
        }
      } else {
        if (input.style.border !== '') input.style.border = '';
      }
    }

    function moveNext(currentElement, nextId) {
      if (!nextId || !currentElement) return;
      const nextElement = document.getElementById(nextId);
      if (nextElement && document.activeElement === currentElement) {
        nextElement.focus();
        if (nextElement.select) nextElement.select();
      }
    }

    function calculateRow(day) {
      const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value;
      const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value;
      const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      const breakTime = parseFloat(breakTimeInput?.value) || 0;
      const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
      const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
      const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

      if (!totalCell || !grossElement || !netElement) return;

      if (!startTimeStr && !endTimeStr) {
        totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
        grossElement.value = '0.00';
        netElement.value = '0.00';
        return;
      }

      const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
      if (!timeRegex.test(startTimeStr) && startTimeStr !== '' || !timeRegex.test(endTimeStr) && endTimeStr !== '') {
        totalCell.textContent = 'Neplatný čas';
        grossElement.value = '0.00';
        netElement.value = '0.00';
        return;
      }

      if (startTimeStr === '' || endTimeStr === '') {
        totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
        grossElement.value = '0.00';
        netElement.value = '0.00';
        return;
      }

      const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
      const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
      const startTotalMinutes = startHours * 60 + startMinutes;
      let endTotalMinutes = endHours * 60 + endMinutes;

      if (endTotalMinutes < startTotalMinutes) {
        endTotalMinutes += 24 * 60;
      }

      const diffMinutes = endTotalMinutes - startTotalMinutes;
      const breakMinutes = breakTime * 60;
      const workedMinutes = Math.max(0, diffMinutes - breakMinutes);
      const hours = Math.floor(workedMinutes / 60);
      const minutes = Math.round(workedMinutes % 60);
      const decimalHours = (workedMinutes / 60);

      totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces || 1)} h)`;

      const currentHourlyWage = hourlyWage;
      const currentTaxRate = taxRate;
      const grossSalary = decimalHours * currentHourlyWage;
      grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00';

      const netSalary = grossSalary * (1 - currentTaxRate);
      netElement.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00';
    }

    function resetRow(day) {
      const dayIndex = day - 1;
      const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
      const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
      const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      const total = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
      const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
      const net = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
      const note = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`);
      const noteContainer = document.getElementById(`note-container-${currentYear}-${currentMonth}-${day}`);
      const noteToggle = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${day}`);
      const noteIndicator = document.getElementById(`note-indicator-${currentYear}-${currentMonth}-${day}`);

      if (start && end && breakTime && total && gross && net && note && noteContainer && noteToggle && noteIndicator) {
        start.value = '';
        end.value = '';
        breakTime.value = '';
        note.value = '';
        total.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
        gross.value = '0.00';
        net.value = '0.00';
        noteContainer.classList.remove('visible');
        noteToggle.textContent = 'Poznámka';
        updateNoteIndicator(day);

        if (!monthData) monthData = {};
        if (!monthData[currentYear]) monthData[currentYear] = {};
        if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
        
        while (dayIndex >= monthData[currentYear][currentMonth].length) {
          monthData[currentYear][currentMonth].push({
            start: '', end: '', breakTime: '', note: '', noteVisible: false
          });
        }
        
        if (monthData[currentYear][currentMonth][dayIndex]) {
          monthData[currentYear][currentMonth][dayIndex] = {
            start: '', end: '', breakTime: '', note: '', noteVisible: false
          };
        }

        calculateTotal();
        saveToLocalStorage();
      }
    }

    function resetAll() {
      if (confirm('Naozaj chcete resetovať všetky záznamy pre tento mesiac?')) {
        if (!monthData) monthData = {};
        if (!monthData[currentYear]) monthData[currentYear] = {};
        
        const days = getDaysInMonth(currentMonth);
        monthData[currentYear][currentMonth] = Array.from({ length: days }, () => ({
          start: '', end: '', breakTime: '', note: '', noteVisible: false
        }));

        createTable();
        calculateTotal();
        saveToLocalStorage();
        showSaveNotification("Dáta pre aktuálny mesiac boli resetované.");
      }
    }

    function calculateTotal() {
      let grandTotalWorkedMinutes = 0;
      let daysWithEntries = 0;
      const rows = workDays.querySelectorAll('tr');
      const currentHourlyWage = hourlyWage;
      const currentTaxRate = taxRate;
      const currentDecimalPlaces = decimalPlaces || 1;

      rows.forEach((row, index) => {
        const dayIndex = index + 1;
        const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`)?.value;
        const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`)?.value;
        const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`);

        if (startTimeStr && endTimeStr) {
          const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
          if (timeRegex.test(startTimeStr) && timeRegex.test(endTimeStr)) {
            const breakTime = parseFloat(breakTimeInput?.value) || 0;
            const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
            const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
            const startTotalMinutes = startHours * 60 + startMinutes;
            let endTotalMinutes = endHours * 60 + endMinutes;

            if (endTotalMinutes < startTotalMinutes) {
              endTotalMinutes += 24 * 60;
            }

            const diffMinutes = endTotalMinutes - startTotalMinutes;
            const breakMinutes = breakTime * 60;
            const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes);
            grandTotalWorkedMinutes += workedMinutesForRow;

            if (workedMinutesForRow > 0 || (startTimeStr && endTimeStr)) {
              daysWithEntries++;
            }
          }
        }
      });

      const grandTotalDecimalHours = grandTotalWorkedMinutes / 60;
      const grandTotalGrossSalary = grandTotalDecimalHours * currentHourlyWage;
      const grandTotalNetSalary = grandTotalGrossSalary * (1 - currentTaxRate);
      const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0;
      const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
      const averageHours = Math.floor(averageWorkedMinutes / 60);
      const averageMinutes = Math.round(averageWorkedMinutes % 60);
      const averageDecimalHours = (averageWorkedMinutes / 60);
      const totalHours = Math.floor(grandTotalWorkedMinutes / 60);
      const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60);

      totalSalaryDiv.innerHTML = `
        Počet odpracovaných dní: ${daysWithEntries}<br>
        Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(currentDecimalPlaces)} h)<br>
        Celková hrubá mzda: ${grandTotalGrossSalary.toFixed(2)}€<br>
        Celková čistá mzda: ${grandTotalNetSalary.toFixed(2)}€<br>
        Priemerná čistá mzda na deň: ${averageNetSalary.toFixed(2)}€<br>
        <strong>Priemerný odpracovaný čas na deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(currentDecimalPlaces)} h)</strong>
      `;
    }

    function exportToPDF() {
      if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') {
        alert("Chyba: Knižnica jsPDF alebo autoTable nie je správne načítaná.");
        return;
      }

      const { jsPDF } = window.jspdf;
      try {
        const doc = new jsPDF();

        // ---> ZAČIATOK ÚPRAVY PRE DIAKRITIKU <---
        // Nastavenie písma, ktoré podporuje slovenské znaky
        doc.setFont('DejaVuSans', 'normal');
        // ---> KONIEC ÚPRAVY PRE DIAKRITIKU <---

        doc.setFontSize(18);
        doc.text(`Bruno's Calculator - Výkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
        doc.setFontSize(12);
        doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28);
        doc.text(`Hodinová mzda: ${hourlyWage || 'N/A'} €`, 14, 34);
        doc.text(`Daň (%): ${taxRate * 100 || 'N/A'}`, 100, 34);

        const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované", "Hrubá Mzda (€)", "Čistá Mzda (€)", "Poznámka"];
        const tableRows = [];
        const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];

        dataForCurrentMonth.forEach((day, index) => {
          if (day.start || day.end || day.note) {
            const dayNum = index + 1;
            const dayName = getDayName(currentYear, currentMonth, dayNum);
            const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${dayNum}`);
            const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayNum}`);
            const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayNum}`);
            const workedTimeText = totalCell ? totalCell.textContent : 'N/A';
            const grossValue = grossInput ? parseFloat(grossInput.value).toFixed(2) : '0.00';
            const netValue = netInput ? parseFloat(netInput.value).toFixed(2) : '0.00';
            const noteText = day.note || '';

            const rowData = [
              `Deň ${dayNum} (${dayName})`,
              day.start || '-',
              day.end || '-',
              day.breakTime || '0',
              workedTimeText,
              grossValue,
              netValue,
              noteText
            ];
            tableRows.push(rowData);
          }
        });

        doc.autoTable({
          head: [tableColumn],
          body: tableRows,
          startY: 40,
          headStyles: { fillColor: [41, 128, 185], textColor: 255, font: 'DejaVuSans' },
          styles: { fontSize: 8, font: 'DejaVuSans' },
          alternateRowStyles: { fillColor: [240, 240, 240] },
          columnStyles: { 7: { cellWidth: 'auto' } }
        });

        const finalY = doc.lastAutoTable.finalY || 40;
        doc.setFontSize(10);
        const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, '');
        doc.text(totalTextContent, 14, finalY + 10);

        const pdfFileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
        doc.save(pdfFileName);
        showSaveNotification("PDF exportované.");
      } catch (error) {
        console.error("Chyba pri generovaní PDF:", error);
        alert("Nastala chyba pri vytváraní PDF súboru.");
      }
    }

    function sendPDF() {
      if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') {
        alert("Chyba: Knižnica jsPDF alebo autoTable nie je správne načítaná.");
        return;
      }

      const { jsPDF } = window.jspdf;
      try {
        const doc = new jsPDF();

        // ---> ZAČIATOK ÚPRAVY PRE DIAKRITIKU <---
        // Nastavenie písma, ktoré podporuje slovenské znaky
        doc.setFont('DejaVuSans', 'normal');
        // ---> KONIEC ÚPRAVY PRE DIAKRITIKU <---

        doc.setFontSize(16);
        doc.text(`Pracovný výkaz - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
        doc.setFontSize(12);
        doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28);

        const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Poznámka"];
        const tableRows = [];
        const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];

        dataForCurrentMonth.forEach((day, index) => {
          if (day.start || day.end || day.note) {
            const dayNum = index + 1;
            const dayName = getDayName(currentYear, currentMonth, dayNum);
            const noteText = day.note || '';
            const rowData = [
              `Deň ${dayNum} (${dayName})`,
              day.start || '-',
              day.end || '-',
              day.breakTime || '0',
              noteText
            ];
            tableRows.push(rowData);
          }
        });

        doc.autoTable({
          head: [tableColumn],
          body: tableRows,
          startY: 35,
          headStyles: { fillColor: [41, 128, 185], textColor: 255, font: 'DejaVuSans' },
          styles: { fontSize: 9, font: 'DejaVuSans' },
          alternateRowStyles: { fillColor: [240, 240, 240] },
          columnStyles: { 4: { cellWidth: 'auto' } }
        });

        const finalY = doc.lastAutoTable.finalY || 35;
        doc.setFontSize(10);
        const totalSalaryHTML = totalSalaryDiv.innerHTML;
        let daysWithEntriesText = 'N/A';
        const match = totalSalaryHTML.match(/Počet odpracovaných dní: (\d+)/);
        if (match && match[1]) {
          daysWithEntriesText = match[1];
        }
        const summaryText = `Počet odpracovaných dní: ${daysWithEntriesText}`;
        doc.text(summaryText, 14, finalY + 10);

        const pdfBlob = doc.output('blob');
        const pdfFileName = `Vykaz_odoslanie-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
        const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
          navigator.share({
            files: [pdfFile],
            title: `Pracovný výkaz ${getMonthName(currentMonth)} ${currentYear}`,
            text: `Výkaz pre ${employeeName || 'pracovníka'} za ${getMonthName(currentMonth)} ${currentYear}.`
          }).then(() => {
            showSaveNotification("PDF pripravené na zdieľanie.");
          }).catch((error) => {
            if (error.name !== 'AbortError') {
              console.error('Chyba pri zdieľaní:', error);
              alert('Chyba pri zdieľaní súboru.');
            }
          });
        } else {
          alert("Zdieľanie súborov nie je podporované. Súbor bude stiahnutý.");
          const url = URL.createObjectURL(pdfBlob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = pdfFileName;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        }
      } catch (error) {
        console.error("Chyba pri generovaní alebo zdieľaní PDF:", error);
        alert("Nastala chyba pri vytváraní alebo zdieľaní PDF súboru.");
      }
    }

    function changeDecimalPlaces() {
      const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
      if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) {
        decimalPlaces = newDecimalPlaces;
        calculateTotal();
        saveToLocalStorage();
      }
    }

    function updateEmployeeName() {
      employeeName = employeeNameInput.value;
      updateWelcomeMessage();
      saveToLocalStorage();
    }

    function updateSettings() {
      const newHourlyWageStr = hourlyWageInput.value;
      const newTaxRateStr = taxRateInput.value;
      const newHourlyWage = parseFloat(newHourlyWageStr);
      const newTaxRatePercent = parseFloat(newTaxRateStr);
      let settingsChanged = false;

      if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
        if (hourlyWage !== newHourlyWage) {
          hourlyWage = newHourlyWage;
          settingsChanged = true;
        }
      }

      if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) {
        const newTaxRateDecimal = newTaxRatePercent / 100;
        if (taxRate !== newTaxRateDecimal) {
          taxRate = newTaxRateDecimal;
          settingsChanged = true;
        }
      }

      if (settingsChanged) {
        const rows = workDays.querySelectorAll('tr');
        rows.forEach((row, index) => calculateRow(index + 1));
        calculateTotal();
        saveToLocalStorage();
      }
    }

    function changeMonth() {
      const selectedMonth = parseInt(monthSelect.value);
      if (currentMonth !== selectedMonth) {
        currentMonth = selectedMonth;
        handleMonthYearChange();
      }
    }

    function changeYear() {
      const selectedYear = parseInt(yearSelect.value);
      if (currentYear !== selectedYear) {
        currentYear = selectedYear;
        handleMonthYearChange();
      }
    }

    function handleMonthYearChange() {
      localStorage.setItem('currentMonth', currentMonth.toString());
      localStorage.setItem('currentYear', currentYear.toString());
      loadFromLocalStorage();
      if (auth.currentUser) {
        setupFirestoreListener();
      }
    }

    function getDaysInMonth(month) {
      if (month === undefined || month === null || currentYear === undefined || currentYear === null) {
        return 31;
      }
      return new Date(currentYear, month + 1, 0).getDate();
    }

    function getMonthName(month) {
      const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      return monthNames[month] || 'Neznámy';
    }

    function updateDataSize() {
      try {
        const totalData = Object.values(localStorage).reduce((acc, value) => acc + (value ? value.length : 0), 0);
        const kilobytes = (totalData / 1024).toFixed(2);
        const percentageUsed = Math.min(((totalData / MAX_DATA_SIZE) * 100), 100);
        
        dataSizeText.textContent = `Lokálne úložisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
        dataSizeFill.style.width = `${percentageUsed}%`;

        if (percentageUsed > 90) {
          dataSizeFill.style.backgroundColor = '#f44336';
        } else if (percentageUsed > 70) {
          dataSizeFill.style.backgroundColor = '#ff9800';
        } else {
          dataSizeFill.style.backgroundColor = '#4CAF50';
        }
      } catch (error) {
        console.error("Chyba pri výpočte veľkosti localStorage:", error);
        dataSizeText.textContent = "Chyba pri výpočte veľkosti dát.";
      }
    }

    function toggleDarkMode() {
      const isDarkMode = document.body.classList.toggle('dark-mode');
      applyDarkMode(isDarkMode);
      localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
      if (auth.currentUser) {
        saveToFirebase();
      }
    }

    function createBackup() {
      try {
        const backupData = {
          workDaysData: localStorage.getItem('workDaysData') || '{}',
          hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(10),
          taxRate: localStorage.getItem('taxRate') || JSON.stringify(2),
          darkMode: localStorage.getItem('darkMode') || JSON.stringify(false),
          decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(1),
          employeeName: localStorage.getItem('employeeName') || JSON.stringify(''),
          backupVersion: 2,
          backupTimestamp: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bruno-calculator-backup-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showSaveNotification("Záloha úspešne vytvorená.");
      } catch (error) {
        console.error("Chyba pri vytváraní zálohy:", error);
        alert("Nastala chyba pri vytváraní záložného súboru.");
      }
    }

    function restoreBackup() {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.json,application/json';
      
      fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const backup = JSON.parse(e.target.result);
            if (backup && typeof backup.workDaysData === 'string' && typeof backup.hourlyWage === 'string' && typeof backup.taxRate === 'string' && typeof backup.darkMode === 'string' && typeof backup.decimalPlaces === 'string' && typeof backup.employeeName === 'string') {
              localStorage.setItem('workDaysData', backup.workDaysData);
              localStorage.setItem('hourlyWage', backup.hourlyWage);
              localStorage.setItem('taxRate', backup.taxRate);
              localStorage.setItem('darkMode', backup.darkMode);
              localStorage.setItem('decimalPlaces', backup.decimalPlaces);
              localStorage.setItem('employeeName', backup.employeeName);
              
              loadFromLocalStorage();
              showSaveNotification("Záloha úspešne obnovená.");
              alert("Záloha bola úspešne obnovená. Dáta boli načítané.");
              
              if (auth.currentUser) {
                saveToLocalStorage();
              }
            } else {
              alert("Chyba: Súbor zálohy má nesprávny formát alebo chýbajú dáta.");
            }
          } catch (error) {
            console.error("Chyba pri spracovaní alebo obnove zálohy:", error);
            alert("Chyba pri čítaní alebo obnove zálohy. Súbor môže byť poškodený alebo mať nesprávny formát.");
          }
        };
        
        reader.onerror = (e) => {
          console.error("Chyba pri čítaní súboru zálohy:", e);
          alert("Nastala chyba pri čítaní súboru zálohy.");
        };
        
        reader.readAsText(file);
      };
      
      fileInput.click();
    }

    document.addEventListener('DOMContentLoaded', () => {
      populateYearSelect();
      const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
      applyDarkMode(darkMode);
      updateWelcomeMessage();

      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(registration => {})
            .catch(error => {
              console.error('Registrácia ServiceWorker zlyhala: ', error);
            });
        });
      }
    });

    function populateYearSelect() {
      const startYear = 2020;
      const endYear = new Date().getFullYear() + 2;
      yearSelect.innerHTML = '';
      
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
    }
  </script>
</body>
</html>
