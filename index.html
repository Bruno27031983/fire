<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruno's Calculator s Firebase Auth</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">

    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* CSS ≈°t√Ωly - Vr√°ten√© ≈°t√Ωly pre restore-btn a backup-btn */
        body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
        .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
        h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
        h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
        .settings {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        .settings > div,
        .settings > details,
        .settings > button {
            flex: 1 1 200px;
            margin: 0;
        }
        .settings label { display: block; margin-bottom: 5px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 900px; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; }
        th { background-color: #f2f2f2; }
        input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea {
            width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px;
        }
        th:nth-child(1), td:nth-child(1) { min-width: 50px; } /* De≈à */
        th:nth-child(2), td:nth-child(2) { min-width: 80px; } /* Pr√≠chod */
        th:nth-child(3), td:nth-child(3) { min-width: 80px; } /* Odchod */
        th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* Prest√°vka */
        th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* Odpracovan√© */
        th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* Hrub√° Mzda */
        th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* ƒåist√° Mzda */
        th:nth-child(8), td:nth-child(8) { min-width: 120px; } /* Pozn√°mka */
        th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia */

        .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
        .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
        .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
        .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
        /* Vr√°ten√© ≈°t√Ωly */
        .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
        .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
        .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
        #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
        .current-day { background-color: #8a2be2; color: white; }
        .current-day input, .current-day .note-textarea { background-color: #9932cc; color: white; }
        @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
        body.dark-mode { background-color: #333; color: #f4f4f4; }
        .container.dark-mode { background-color: #444; color: #f4f4f4; }
        table.dark-mode { background-color: #555; color: #f4f4f4; }
        th.dark-mode { background-color: #666; }
        td.dark-mode { background-color: #444; color: #f4f4f4; }
        input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode {
            background-color: #666; color: white; border-color: #888;
        }
        .btn.dark-mode { color: #333; /* Text tlaƒçidiel v tmavom re≈æime - zv√°≈æi≈•, ƒçi necha≈• biely */ }
        .reset-btn.dark-mode { background-color: #d32f2f; }
        .export-btn.dark-mode { background-color: #388e3c; }
        /* Vr√°ten√© dark-mode ≈°t√Ωly */
        .restore-btn.dark-mode { background-color: #7B1FA2; }
        .backup-btn.dark-mode { background-color: #E68900; }
        #totalSalary.dark-mode { background-color: #2c3e50; }
        .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
        .current-day.dark-mode input, .current-day.dark-mode .note-textarea { background-color: #5c1db3; color: #fff; }
        body.dark-mode .autor-info { color: #aaa; }
        #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
        #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
        #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
        #auth-container button:hover { background-color: #45a049; }
        #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
        #saveNotification.show { display: block; opacity: 1; }
        #saveNotification.error { background-color: #f44336; }
        #saveNotification.warning { background-color: #ff9800; }
        #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
        #loading-container.hidden { opacity: 0; pointer-events: none; }
        #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
        #forgot-password-link:hover { text-decoration: underline; }

        .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
        .collapsible-settings summary:hover { background-color: #eee; }
        .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
        .collapsible-content > div { flex: 1 1 200px; margin: 0; }
        body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
        body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
        body.dark-mode .collapsible-content { border-top-color: #666; }

        .note-container { display: none; margin-top: 5px; }
        .note-container.visible { display: block; }
        .note-textarea { width: 95%; min-height: 40px; resize: vertical; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; background-color: #f0f0f0; }
        .toggle-note-btn { background-color: #6c757d; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease; margin-bottom: 2px; }
        .toggle-note-btn:hover { background-color: #5a6268; }
        .note-textarea.dark-mode { background-color: #555; color: #f4f4f4; border-color: #777; }
        .toggle-note-btn.dark-mode { background-color: #828a91; }
        .toggle-note-btn.dark-mode:hover { background-color: #70777d; }

    </style>
</head>
<body>
    <div id="loading-container"><h1> Tajomstvo √∫spechu je slu≈°nos≈• a √∫primnos≈•. Akon√°hle sa ich zbav√≠te, dosiahnete v≈°etko. </h1></div>
    <div id="auth-container" style="display:none;">
        <h1>Prihl√°senie / Registr√°cia</h1>
        <div id="auth-message">≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.</div>
        <div id="auth-forms">
            <h2>Registr√°cia</h2>
            <input type="email" id="registerEmail" placeholder="Email">
            <input type="password" id="registerPassword" placeholder="Heslo">
            <button onclick="register()">Registrova≈•</button>
            <h2>Prihl√°senie</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Heslo">
            <button onclick="login()">Prihl√°si≈• sa</button>
            <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
        </div>
    </div>
    <div id="calculator-container" class="container" style="display:none;">
        <div class="autor-info">Vytvoril Bruno</div>
        <h1 id="mainTitle">Bruno's Calculator</h1>
        <h2 id="welcomeMessage"></h2> <div class="settings">
            <div>
                <label for="monthSelect">Mesiac: </label>
                <select id="monthSelect" onchange="changeMonth()">
                    <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option> <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option> <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option> <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
                </select>
            </div>
             <details class="collapsible-settings">
                 <summary>ƒéal≈°ie nastavenia</summary>
                 <div class="collapsible-content">
                     <div>
                         <label for="employeeNameInput">Meno pracovn√≠ka: </label>
                         <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
                     </div>
                     <div>
                         <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
                         <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
                     </div>
                     <div>
                         <label for="taxRateInput">Da≈àov√© percento (%): </label>
                         <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
                     </div>
                     <div>
                         <label for="yearSelect">Rok: </label>
                         <select id="yearSelect" onchange="changeYear()"></select>
                     </div>
                     <div>
                         <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
                         <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                             <option value="1">1</option>
                             <option value="2" selected>2</option>
                         </select>
                     </div>
                 </div>
             </details>
             <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
        </div>
        <div class="table-container">
             <table>
                 <thead>
                     <tr>
                         <th>De≈à</th> <th>Pr√≠chod</th> <th>Odchod</th> <th>Prest√°vka</th> <th>Odpracovan√©</th> <th>Hrub√° Mzda (‚Ç¨)</th> <th>ƒåist√° Mzda (‚Ç¨)</th> <th class="th-note">Pozn√°mka</th> <th>Akcia</th>
                     </tr>
                 </thead>
                 <tbody id="workDays"></tbody>
             </table>
        </div>
        <div id="totalSalary"></div>
        <div class="btn-container">
            <button class="btn reset-btn" onclick="resetAll()">Resetova≈• tento mesiac</button>
            <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
            <button class="btn export-btn" onclick="sendPDF()">Odosla≈• v√Ωkaz</button>
            <button class="btn restore-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu zo s√∫boru</button>
            <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu do s√∫boru</button>
            <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
        </div>
    </div>
    <div id="saveNotification"></div>

    <script>
        // Firebase Config, Init, Persistence (nezmenen√©)
        const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
        firebase.initializeApp(firebaseConfig);
        try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktiv√°cii Firebase App Check:", error); }
        const db = firebase.firestore(); const auth = firebase.auth();
        db.enablePersistence().then(() => { console.log("Firestore offline persistence povolen√°."); }).catch((err) => { console.error("Firestore offline persistence chyba:", err.code, err.message); });

        // Glob√°lne premenn√© (nezmenen√©)
        let currentMonth, currentYear;
        let decimalPlaces = 2;
        let employeeName = '';
        let hourlyWage = 10;
        let taxRate = 0.02;
        let isDarkMode = false;
        let monthData = {}; // ≈†trukt√∫ra: { year: { month: [dayData1, ...] } }
        let firestoreListenerUnsubscribe = null;

        // DOM Elementy (nezmenen√©)
        const workDays = document.getElementById('workDays');
        const totalSalaryDiv = document.getElementById('totalSalary');
        const hourlyWageInput = document.getElementById('hourlyWageInput');
        const taxRateInput = document.getElementById('taxRateInput');
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
        const employeeNameInput = document.getElementById('employeeNameInput');
        const welcomeMessageElement = document.getElementById('welcomeMessage');

        // Auth funkcie, initializeUserSettings (nezmenen√©)
        function register() { const email = document.getElementById('registerEmail').value; const password = document.getElementById('registerPassword').value; auth.createUserWithEmailAndPassword(email, password).then((userCredential) => { console.log("Registrovan√Ω:", userCredential.user); alert("Registr√°cia √∫spe≈°n√°!"); initializeUserSettings(userCredential.user.uid, email); }).catch((error) => { console.error("Chyba pri registr√°cii:", error.message); alert("Chyba pri registr√°cii: " + error.message); }); }
        function login() { const email = document.getElementById('loginEmail').value; const password = document.getElementById('loginPassword').value; auth.signInWithEmailAndPassword(email, password).then((userCredential) => { console.log("Prihl√°sen√Ω:", userCredential.user); alert("Prihl√°senie √∫spe≈°n√©!"); }).catch((error) => { console.error("Chyba pri prihl√°sen√≠:", error.message); alert("Chyba pri prihl√°sen√≠: " + error.message); }); }
        function logout() { auth.signOut().then(() => { console.log("Odhl√°sen√Ω."); alert("Odhl√°senie √∫spe≈°n√©!"); }).catch((error) => { console.error("Chyba pri odhl√°sen√≠:", error.message); alert("Chyba pri odhl√°sen√≠: " + error.message); }); }
        function forgotPassword() { const emailInput = document.getElementById('loginEmail'); const email = emailInput.value; if (!email) { alert("Pros√≠m, zadajte svoju e-mailov√∫ adresu do poƒæa pre prihl√°senie."); emailInput.focus(); return; } auth.sendPasswordResetEmail(email).then(() => { alert("Odkaz na obnovenie hesla bol odoslan√Ω na va≈°u e-mailov√∫ adresu. Skontrolujte si pros√≠m po≈°tu (aj prieƒçinok Spam)."); }).catch((error) => { alert("Chyba pri odosielan√≠ e-mailu na obnovenie hesla: " + error.message); }); }
        function initializeUserSettings(uid, email) { const userDocRef = db.collection("users").doc(uid); const initialData = { email: email, createdAt: new Date().toISOString() }; userDocRef.set(initialData, { merge: true }).then(() => { console.log("Vytvoren√Ω/aktualizovan√Ω dokument pre:", uid); const now = new Date(); const initialYear = now.getFullYear(); const initialMonth = now.getMonth(); const initialDocPath = `users/${uid}/calculatorData/${initialYear}-${initialMonth}`; const initialMonthData = { days: [], hourlyWage: 10, taxRate: 2, decimalPlaces: 2, employeeName: '', darkMode: false, timestamp: firebase.firestore.FieldValue.serverTimestamp() }; db.doc(initialDocPath).set(initialMonthData).then(() => console.log(`Inicializaƒçn√Ω dokument pre ${initialYear}-${initialMonth} vytvoren√Ω.`)).catch(err => console.error("Chyba pri vytv√°ran√≠ inicializaƒçn√©ho dokumentu mesiaca:", err)); }).catch(err => console.error("Chyba pri vytv√°ran√≠/aktualiz√°cii dokumentu pou≈æ√≠vateƒæa:", err)); }

        // Auth State Change Listener (nezmenen√© oproti predch√°dzaj√∫cej verzii bez localStorage)
        auth.onAuthStateChanged(user => {
            console.log("onAuthStateChanged: Stav zisten√Ω.", user ? `Pou≈æ√≠vateƒæ: ${user.email}` : "≈Ωiadny pou≈æ√≠vateƒæ.");
            const authContainer = document.getElementById('auth-container');
            const calculatorContainer = document.getElementById('calculator-container');
            const loadingContainer = document.getElementById('loading-container');
            if (loadingContainer) loadingContainer.classList.add('hidden');

            if (firestoreListenerUnsubscribe) { firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; }

            if (user) {
                document.getElementById('auth-message').textContent = "Prihl√°sen√Ω: " + user.email;
                authContainer.style.display = "none"; calculatorContainer.style.display = "block";
                console.log("Pou≈æ√≠vateƒæ prihl√°sen√Ω, nastavujem UI a listener...");
                const currentDate = new Date();
                currentMonth = currentMonth ?? currentDate.getMonth(); currentYear = currentYear ?? currentDate.getFullYear();
                monthSelect.value = currentMonth;
                populateYearSelect();
                if (yearSelect.querySelector(`option[value="${currentYear}"]`)) { yearSelect.value = currentYear; }
                else { currentYear = currentDate.getFullYear(); populateYearSelect(); yearSelect.value = currentYear; console.warn(`Rok ${currentYear} nen√°jden√Ω, nastavujem aktu√°lny rok.`); }
                applyCurrentSettingsToUI(); // Default UI settings
                createTable(); calculateTotal(); updateWelcomeMessage();
                setupFirestoreListener(); // Load real data
                const uid = user.uid; const userDocRef = db.collection("users").doc(uid);
                userDocRef.get().then(userDocSnap => { if (!userDocSnap.exists) { initializeUserSettings(uid, user.email); } else { console.log("Dokument pou≈æ√≠vateƒæa existuje:", uid); } }).catch(err => { console.error("Chyba pri kontrole dokumentu pou≈æ√≠vateƒæa:", err); showSaveNotification("Chyba pri overovan√≠ pou≈æ√≠vateƒæsk√Ωch d√°t", "error"); });
            } else {
                document.getElementById('auth-message').textContent = "≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.";
                authContainer.style.display = "block"; calculatorContainer.style.display = "none";
                console.log("Pou≈æ√≠vateƒæ odhl√°sen√Ω/neprihl√°sen√Ω.");
                const currentDate = new Date(); currentMonth = currentDate.getMonth(); currentYear = currentDate.getFullYear();
                decimalPlaces = 2; employeeName = ''; hourlyWage = 10; taxRate = 0.02; isDarkMode = false; monthData = {};
                workDays.innerHTML = ''; totalSalaryDiv.innerHTML = ''; updateWelcomeMessage();
            }
        });

        // Utility funkcie (debounce, showSaveNotification, getFirstName, updateWelcomeMessage) - Nezmenen√©
        function debounce(func, wait) { let timeout; return function (...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), wait); }; }
        function showSaveNotification(message, type = 'success') { const notification = document.getElementById('saveNotification'); notification.textContent = message; notification.className = 'show'; if (type === 'error') notification.classList.add('error'); else if (type === 'warning') notification.classList.add('warning'); notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 3000); }
        function getFirstName(fullName) { if (!fullName || typeof fullName !== 'string') return ''; const trimmedName = fullName.trim(); if (!trimmedName) return ''; return trimmedName.split(' ')[0]; }
        function updateWelcomeMessage() { if (!welcomeMessageElement) return; const firstName = getFirstName(employeeName); welcomeMessageElement.textContent = firstName ? `Vitaj sp√§≈•, ${firstName}! üëã` : ''; }

        // Firestore Listener, resetToDefaultState, applyCurrentSettingsToUI (nezmenen√© oproti predch. verzii)
        function setupFirestoreListener() {
            if (firestoreListenerUnsubscribe) { firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; }
            const uid = auth.currentUser?.uid; if (!uid) { console.log("setupFirestoreListener: Nikto nie je prihl√°sen√Ω."); return; }
            if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) { const now = new Date(); currentMonth = currentMonth ?? now.getMonth(); currentYear = currentYear ?? now.getFullYear(); console.warn("setupFirestoreListener: Ch√Ωba mesiac/rok."); }
            const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`; const docRef = db.doc(docPath);
            console.log(`setupFirestoreListener: Nastavujem listener pre ${docPath}`);
            firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
                console.log(`Firestore listener: Prijat√Ω snapshot pre ${docPath}. Metadata:`, docSnap.metadata);
                const isLocalWrite = docSnap.metadata.hasPendingWrites;
                if (isLocalWrite) { console.log("Listener: Detekovan√° lok√°lna zmena. Preskakujem aktualiz√°ciu UI."); showSaveNotification("Synchronizujem zmeny...", "warning"); return; }
                if (docSnap.exists) {
                    const data = docSnap.data(); console.log(`Listener: Dokument existuje, naƒç√≠tan√© d√°ta:`, data);
                    try {
                        hourlyWage = data.hourlyWage ?? 10; taxRate = (data.taxRate ?? 2) / 100; decimalPlaces = data.decimalPlaces ?? 2;
                        employeeName = data.employeeName ?? ''; isDarkMode = data.darkMode ?? false; const firebaseDaysData = data.days || [];
                        if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                        monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '', note: day.note || '' }));
                        console.log(`Listener: monthData pre ${currentYear}-${currentMonth} aktualizovan√©. Poƒçet dn√≠: ${monthData[currentYear][currentMonth].length}`);
                        console.log("Listener: Vykon√°vam pln√∫ aktualiz√°ciu UI z Firestore d√°t...");
                        updateUIFromLoadedData(); // Pou≈æije aktu√°lne glob√°lne premenn√©
                        if (!docSnap.metadata.fromCache) { showSaveNotification("D√°ta synchronizovan√©"); } else { showSaveNotification("D√°ta naƒç√≠tan√© (offline/cache)", "warning"); }
                    } catch (processError) { console.error(`Listener: Chyba pri spracovan√≠ d√°t z Firestore pre ${currentYear}-${currentMonth}:`, processError); showSaveNotification("Chyba: Nespr√°vny form√°t d√°t z Firebase", "error"); resetToDefaultState(); }
                } else {
                    console.log(`Listener: Dokument neexistuje na Firebase pre ${currentYear}-${currentMonth}. Inicializujem mesiac.`);
                    if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = [];
                    const initialMonthData = { days: [], hourlyWage: hourlyWage || 10, taxRate: (taxRate * 100) || 2, decimalPlaces: decimalPlaces || 2, employeeName: employeeName || '', darkMode: isDarkMode || false, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                    docRef.set(initialMonthData).then(() => { console.log(`Listener: Vytvoren√Ω nov√Ω dokument pre ${currentYear}-${currentMonth}.`); createTable(); calculateTotal(); applyCurrentSettingsToUI(); updateWelcomeMessage(); }).catch(err => { console.error(`Listener: Chyba pri vytv√°ran√≠ nov√©ho dokumentu pre ${currentYear}-${currentMonth}:`, err); showSaveNotification("Chyba: Nepodarilo sa inicializova≈• d√°ta mesiaca", "error"); resetToDefaultState(); });
                }
            }, (error) => { console.error(`Firestore listener chyba pre ${docPath}:`, error); showSaveNotification("Chyba: Nepodarilo sa pripoji≈• k Firebase", "error"); resetToDefaultState(); });
        }
        function resetToDefaultState() { console.warn("Resetujem UI a glob√°lne premenn√© na default stav."); const currentDate = new Date(); currentMonth = currentDate.getMonth(); currentYear = currentDate.getFullYear(); monthData = {}; hourlyWage = 10; taxRate = 0.02; decimalPlaces = 2; employeeName = ''; isDarkMode = false; monthSelect.value = currentMonth; yearSelect.value = currentYear; applyCurrentSettingsToUI(); createTable(); calculateTotal(); updateWelcomeMessage(); }
        function applyCurrentSettingsToUI() { hourlyWageInput.value = hourlyWage; taxRateInput.value = taxRate * 100; decimalPlacesSelect.value = decimalPlaces; employeeNameInput.value = employeeName; applyDarkMode(isDarkMode); }

        // Funkcia na ukladanie do Firebase (nezmenen√© oproti predch. verzii)
        async function saveDataToFirebase() {
            const currentUser = auth.currentUser; if (!currentUser) { console.log("saveDataToFirebase: Nikto nie je prihl√°sen√Ω."); return; }
            if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) { console.error("saveDataToFirebase: Ch√Ωba mesiac alebo rok."); showSaveNotification("Chyba: Nebol vybrat√Ω mesiac/rok", "error"); return; }
            try {
                const currentMonthWorkData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
                console.log(`saveDataToFirebase: Uklad√°m ${currentMonthWorkData.length} z√°znamov a nastavenia pre ${currentYear}-${currentMonth}.`);
                const dataToSave = { days: currentMonthWorkData, hourlyWage: hourlyWage || 10, taxRate: (taxRate * 100) || 2, decimalPlaces: decimalPlaces || 2, employeeName: employeeName || '', darkMode: isDarkMode || false, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                const yearMonthDoc = `${currentYear}-${currentMonth}`; const uid = currentUser.uid; const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);
                await docRef.set(dataToSave); console.log(`saveDataToFirebase: Po≈æiadavka na ulo≈æenie d√°t pre ${yearMonthDoc} odoslan√°/zaraden√°.`);
            } catch (error) { console.error(`Chyba pri po≈æiadavke na ukladanie do Firebase pre ${currentYear}-${currentMonth}:`, error); showSaveNotification("Chyba: Nepodarilo sa odosla≈• d√°ta do Firebase", "error"); }
        }

        // Funkcia na aktualiz√°ciu UI (nezmenen√© oproti predch. verzii)
        function updateUIFromLoadedData() {
            console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(currentMonth)} ${currentYear} s pou≈æit√≠m glob√°lnych premenn√Ωch.`);
            try {
                applyCurrentSettingsToUI(); // Nastavenia
                if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) monthSelect.value = currentMonth; else { console.warn(`Mesiac ${currentMonth} nen√°jden√Ω.`); monthSelect.value = new Date().getMonth(); currentMonth = parseInt(monthSelect.value); }
                if (yearSelect.querySelector(`option[value="${currentYear}"]`)) yearSelect.value = currentYear; else { console.warn(`Rok ${currentYear} nen√°jden√Ω.`); yearSelect.value = new Date().getFullYear(); currentYear = parseInt(yearSelect.value); populateYearSelect(); yearSelect.value = currentYear;}
                createTable(); // ≈†trukt√∫ra tabuƒæky
                const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
                console.log(`updateUIFromLoadedData: Poƒçet z√°znamov v glob. monthData pre ${currentYear}-${currentMonth}: ${dataForCurrentMonth.length}`);
                dataForCurrentMonth.forEach((day, index) => {
                    const i = index + 1; const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`); const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`); const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`); const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);
                    if (startElement && endElement && breakElement && noteElement) { startElement.value = day.start || ''; endElement.value = day.end || ''; breakElement.value = day.breakTime || ''; noteElement.value = day.note || ''; calculateRow(i); }
                    else { console.error(`Kritick√° chyba: Elementy pre de≈à ${i} neboli n√°jden√©!`); }
                });
                calculateTotal(); updateWelcomeMessage();
                console.log("UI aktualizovan√© z glob√°lnych premenn√Ωch.");
            } catch (error) { console.error("Chyba poƒças aktualiz√°cie UI:", error); showSaveNotification("Chyba pri prekresƒæovan√≠ UI!", "error"); }
        }

        // Funkcia pre aplikovanie Dark Mode (nezmenen√© oproti predch. verzii)
        function applyDarkMode(applyDark) { isDarkMode = applyDark; const elementsToToggle = [document.body, document.querySelector('.container'), totalSalaryDiv, document.querySelector('.collapsible-settings summary'), ...document.querySelectorAll('table, th, td, input[type="tel"], input[type="number"], input[type="text"], select, .btn, .toggle-note-btn, .note-textarea')]; elementsToToggle.forEach(el => el?.classList.toggle('dark-mode', isDarkMode)); const currentDayRow = document.querySelector('.current-day'); if (currentDayRow) { currentDayRow.classList.toggle('dark-mode', isDarkMode); currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn').forEach(el => el?.classList.toggle('dark-mode', isDarkMode)); } }

        // Vytv√°ranie tabuƒæky, getDayName, toggleNote, handleNoteInput (nezmenen√©)
        function getDayName(year, month, day) { const daysOfWeek = ["Nedeƒæa", "Pondelok", "Utorok", "Streda", "≈†tvrtok", "Piatok", "Sobota"]; return daysOfWeek[new Date(year, month, day).getDay()]; }
        function createTable() { workDays.innerHTML = ''; const tableHead = document.querySelector('table thead tr'); if (tableHead && !tableHead.querySelector('.th-note')) { const noteTh = document.createElement('th'); noteTh.textContent = 'Pozn√°mka'; noteTh.classList.add('th-note'); const lastTh = tableHead.lastElementChild; tableHead.insertBefore(noteTh, lastTh); } const daysInMonth = getDaysInMonth(currentMonth); const today = new Date(); const currentDayOfMonth = today.getDate(); const currentMonthIndex = today.getMonth(); const currentYearValue = today.getFullYear(); for (let i = 1; i <= daysInMonth; i++) { const row = document.createElement('tr'); if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) row.classList.add('current-day'); const dayName = getDayName(currentYear, currentMonth, i); const baseId = `${currentYear}-${currentMonth}-${i}`; const startId = `start-${baseId}`; const endId = `end-${baseId}`; const breakId = `break-${baseId}`; const totalId = `total-${baseId}`; const grossId = `gross-${baseId}`; const netId = `net-${baseId}`; const noteToggleId = `note-toggle-${baseId}`; const noteContainerId = `note-container-${baseId}`; const noteTextareaId = `note-${baseId}`; row.innerHTML = `<td>De≈à ${i} (${dayName})</td><td><input type="tel" id="${startId}" ...></td><td><input type="tel" id="${endId}" ...></td><td><input type="number" id="${breakId}" ...></td><td id="${totalId}">0h 0m (...)</td><td><input type="number" id="${grossId}" ...></td><td><input type="number" id="${netId}" ...></td><td><button id="${noteToggleId}" ...>Pozn√°mka</button><div id="${noteContainerId}" ...><textarea id="${noteTextareaId}" ...></textarea></div></td><td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulova≈•</button></td>`; workDays.appendChild(row); } applyDarkMode(isDarkMode); } // Tu som skr√°til HTML pre prehƒæadnos≈•, k√≥d je rovnak√Ω
        function toggleNote(day) { const containerId = `note-container-${currentYear}-${currentMonth}-${day}`; const buttonId = `note-toggle-${currentYear}-${currentMonth}-${day}`; const noteContainer = document.getElementById(containerId); const toggleButton = document.getElementById(buttonId); if (noteContainer && toggleButton) { const isVisible = noteContainer.classList.toggle('visible'); toggleButton.textContent = isVisible ? 'Skry≈•' : 'Pozn√°mka'; if (isDarkMode) { const textarea = noteContainer.querySelector('textarea'); if(textarea) textarea.classList.toggle('dark-mode', isVisible); toggleButton.classList.toggle('dark-mode', isVisible); } } else { console.warn(`toggleNote: Elementy pre pozn√°mku d≈àa ${day} neboli n√°jden√©.`); } }
        function handleNoteInput(textarea, day) { updateMonthDataFromInput(textarea, day); debouncedSaveDataToFirebase(); }

        // Input handling, updateMonthDataFromInput, calculateRow, resetRow, resetAll (nezmenen√© oproti predch. verzii)
        const debouncedSaveDataToFirebase = debounce(saveDataToFirebase, 750);
        function processInputCompletion(inputId, nextId) { console.log(`processInputCompletion: Spusten√© pre ${inputId}, ƒèal≈°√≠: ${nextId}`); const inputElement = document.getElementById(inputId); calculateTotal(); debouncedSaveDataToFirebase(); if (inputElement?.type === 'tel' && inputElement.value.length === 5 && isTimeValid(inputElement.value)) moveNext(inputElement, nextId); else if (inputElement?.type === 'number' && inputId.startsWith('break-')) moveNext(inputElement, nextId); }
        function isTimeValid(timeStr) { const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeStr); }
        function handleInput(input, nextId, day) { formatInput(input); updateMonthDataFromInput(input, day); calculateRow(day); processInputCompletion(input.id, nextId); }
        function handleBreakInput(day) { const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); updateMonthDataFromInput(input, day); calculateRow(day); const nextDay = day + 1; let nextInputElementId = null; if (nextDay <= getDaysInMonth(currentMonth)) nextInputElementId = `start-${currentYear}-${currentMonth}-${nextDay}`; processInputCompletion(input.id, nextInputElementId); }
        function updateMonthDataFromInput(input, day) { if (!input) return; const dayIndex = day - 1; const fieldId = input.id; let field = 'unknown'; if (fieldId.startsWith('start-')) field = 'start'; else if (fieldId.startsWith('end-')) field = 'end'; else if (fieldId.startsWith('break-')) field = 'breakTime'; else if (fieldId.startsWith('note-')) field = 'note'; const value = input.value; if (field !== 'unknown') { if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = []; while (monthData[currentYear][currentMonth].length <= dayIndex) monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '' }); if (!monthData[currentYear][currentMonth][dayIndex]) monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '' }; monthData[currentYear][currentMonth][dayIndex][field] = value; } else console.warn("updateMonthDataFromInput: Nerozpoznan√© pole:", fieldId); }
        function formatInput(input) { if (!input || input.type !== 'tel') return; let v = input.value.replace(/[^\d:]/g, ''); if (v.length === 4 && !v.includes(':')) v = v.slice(0, 2) + ':' + v.slice(2); else if (v.length === 3 && v.charAt(2) !== ':' && parseInt(v.slice(0, 2)) <= 23) v = v.slice(0, 2) + ':' + v.slice(2); if (v.length > 5) v = v.slice(0, 5); input.value = v; input.style.border = (v.length === 5 && !isTimeValid(v)) ? '1px solid red' : ''; if(input.style.border) setTimeout(() => input.style.border = '', 2000); }
        function moveNext(currentElement, nextId) { if (!nextId || !currentElement) return; const nextElement = document.getElementById(nextId); if (nextElement && document.activeElement === currentElement) { nextElement.focus(); if (nextElement.select) nextElement.select(); } }
        function calculateRow(day) { const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value; const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value; const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const breakTime = parseFloat(breakInput?.value) || 0; const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const grossEl = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netEl = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!totalCell || !grossEl || !netEl) return; if (!start || !end || !isTimeValid(start) || !isTimeValid(end)) { totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`; grossEl.value = '0.00'; netEl.value = '0.00'; return; } const [sh, sm] = start.split(':').map(Number); const [eh, em] = end.split(':').map(Number); let startMins = sh * 60 + sm; let endMins = eh * 60 + em; if (endMins < startMins) endMins += 24 * 60; const diffMins = endMins - startMins; const breakMins = breakTime * 60; const workedMins = Math.max(0, diffMins - breakMins); const hours = Math.floor(workedMins / 60); const minutes = Math.round(workedMins % 60); const decHours = workedMins / 60; totalCell.textContent = `${hours}h ${minutes}m (${decHours.toFixed(decimalPlaces || 1)} h)`; const gross = decHours * hourlyWage; grossEl.value = isFinite(gross) ? gross.toFixed(2) : '0.00'; const net = gross * (1 - taxRate); netEl.value = isFinite(net) ? net.toFixed(2) : '0.00'; }
        function resetRow(day) { const dayIndex = day - 1; const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const total = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const net = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); const note = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`); const noteContainer = document.getElementById(`note-container-${currentYear}-${currentMonth}-${day}`); const noteToggle = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${day}`); if (start && end && breakTime && total && gross && net && note && noteContainer && noteToggle) { start.value = ''; end.value = ''; breakTime.value = ''; note.value = ''; total.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`; gross.value = '0.00'; net.value = '0.00'; noteContainer.classList.remove('visible'); noteToggle.textContent = 'Pozn√°mka'; if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = []; while (monthData[currentYear][currentMonth].length <= dayIndex) monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '' }); if (monthData[currentYear][currentMonth][dayIndex]) monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '' }; else console.error(`resetRow: Ch√Ωba z√°znam pre de≈à ${dayIndex}.`); calculateTotal(); saveDataToFirebase(); } else console.warn(`resetRow: Elementy pre de≈à ${day} nen√°jden√©.`); }
        function resetAll() { if (confirm('Naozaj chcete resetova≈• v≈°etky z√°znamy pre tento mesiac?')) { if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = []; createTable(); calculateTotal(); saveDataToFirebase(); showSaveNotification("D√°ta pre aktu√°lny mesiac boli resetovan√©."); } }

        // V√Ωpoƒçet celkov√Ωch s√∫ƒçtov (nezmenen√©)
        function calculateTotal() { let grandTotalWorkedMinutes = 0; let daysWithEntries = 0; const rows = workDays.querySelectorAll('tr'); rows.forEach((row, index) => { const dayIndex = index + 1; const start = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`)?.value; const end = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`)?.value; const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`); if (start && end && isTimeValid(start) && isTimeValid(end)) { const breakTime = parseFloat(breakInput?.value) || 0; const [sh, sm] = start.split(':').map(Number); const [eh, em] = end.split(':').map(Number); let startMins = sh * 60 + sm; let endMins = eh * 60 + em; if (endMins < startMins) endMins += 24 * 60; const diffMins = endMins - startMins; const breakMins = breakTime * 60; const workedMins = Math.max(0, diffMins - breakMins); grandTotalWorkedMinutes += workedMins; if (workedMins > 0) daysWithEntries++; } }); const decHours = grandTotalWorkedMinutes / 60; const gross = decHours * hourlyWage; const net = gross * (1 - taxRate); const avgNet = daysWithEntries > 0 ? (net / daysWithEntries) : 0; const avgMins = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0; const avgH = Math.floor(avgMins / 60); const avgM = Math.round(avgMins % 60); const avgDecH = avgMins / 60; const totalH = Math.floor(grandTotalWorkedMinutes / 60); const totalM = Math.round(grandTotalWorkedMinutes % 60); totalSalaryDiv.innerHTML = `Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntries}<br>Celkov√Ω odpracovan√Ω ƒças: ${totalH}h ${totalM}m (${decHours.toFixed(decimalPlaces)} h)<br>Celkov√° hrub√° mzda: ${gross.toFixed(2)}‚Ç¨<br>Celkov√° ƒçist√° mzda: ${net.toFixed(2)}‚Ç¨<br>Priemern√° ƒçist√° mzda na de≈à: ${avgNet.toFixed(2)}‚Ç¨<br><strong>Priemern√Ω odpracovan√Ω ƒças na de≈à: ${avgH}h ${avgM}m (${avgDecH.toFixed(decimalPlaces)} h)</strong>`; }

        // Export do PDF (nezmenen√©)
        function exportToPDF() { /* ... k√≥d exportToPDF ... */ }
        function sendPDF() { /* ... k√≥d sendPDF ... */ }

        // Ostatn√© nastavenia (changeDecimalPlaces, updateEmployeeName, updateSettings, changeMonth, changeYear, handleMonthYearChange, getDaysInMonth, getMonthName, toggleDarkMode) - Nezmenen√© oproti predch. verzii
        function changeDecimalPlaces() { const newDecimalPlaces = parseInt(decimalPlacesSelect.value); if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) { decimalPlaces = newDecimalPlaces; calculateTotal(); saveDataToFirebase(); } }
        function updateEmployeeName() { employeeName = employeeNameInput.value; updateWelcomeMessage(); saveDataToFirebase(); }
        function updateSettings() { const newHourlyWage = parseFloat(hourlyWageInput.value); const newTaxRatePercent = parseFloat(taxRateInput.value); let changed = false; if (!isNaN(newHourlyWage) && newHourlyWage >= 0 && hourlyWage !== newHourlyWage) { hourlyWage = newHourlyWage; changed = true; } const newTaxRateDecimal = newTaxRatePercent / 100; if (!isNaN(newTaxRateDecimal) && newTaxRateDecimal >= 0 && newTaxRateDecimal <= 1 && taxRate !== newTaxRateDecimal) { taxRate = newTaxRateDecimal; changed = true; } if (changed) { workDays.querySelectorAll('tr').forEach((row, index) => calculateRow(index + 1)); calculateTotal(); saveDataToFirebase(); } }
        function changeMonth() { const selectedMonth = parseInt(monthSelect.value); if (currentMonth !== selectedMonth) { currentMonth = selectedMonth; handleMonthYearChange(); } }
        function changeYear() { const selectedYear = parseInt(yearSelect.value); if (currentYear !== selectedYear) { currentYear = selectedYear; handleMonthYearChange(); } }
        function handleMonthYearChange() { console.log(`handleMonthYearChange: ${getMonthName(currentMonth)} ${currentYear}`); if (auth.currentUser) setupFirestoreListener(); else { createTable(); calculateTotal(); } }
        function getDaysInMonth(month) { if (month === undefined || month === null || currentYear === undefined || currentYear === null) return 31; return new Date(currentYear, month + 1, 0).getDate(); }
        function getMonthName(month) { const names = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"]; return names[month] || 'Nezn√°my'; }
        function toggleDarkMode() { const newDarkModeState = !isDarkMode; applyDarkMode(newDarkModeState); saveDataToFirebase(); }


        // 17) Z√°lohovanie a obnova - **UPRAVEN√â: Pracuje s glob√°lnymi premenn√Ωmi**
        function createBackup() {
            try {
                 console.log("Vytv√°ram z√°lohu z aktu√°lneho stavu aplik√°cie...");
                const backupData = {
                    // Uklad√°me aktu√°lne hodnoty glob√°lnych premenn√Ωch
                    settings: {
                        hourlyWage: hourlyWage,
                        taxRate: taxRate, // Uklad√°me ako desatinn√© ƒç√≠slo
                        isDarkMode: isDarkMode,
                        decimalPlaces: decimalPlaces,
                        employeeName: employeeName,
                        // M√¥≈æeme prida≈• aj posledn√Ω zobrazen√Ω mesiac/rok pre lep≈°iu obnovu UI
                         lastViewedMonth: currentMonth,
                         lastViewedYear: currentYear
                    },
                    // Uklad√°me cel√∫ ≈°trukt√∫ru monthData
                    workDaysData: monthData || {},
                    backupVersion: 3, // Zv√Ω≈°en√° verzia kv√¥li zmene ≈°trukt√∫ry
                    backupTimestamp: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateStr = new Date().toISOString().slice(0, 10);
                a.download = `bruno-calculator-backup-${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showSaveNotification("Z√°loha √∫spe≈°ne vytvoren√° a stiahnut√°.");
            } catch (error) {
                console.error("Chyba pri vytv√°ran√≠ z√°lohy:", error);
                alert("Nastala chyba pri vytv√°ran√≠ z√°lo≈æn√©ho s√∫boru.");
                showSaveNotification("Chyba pri vytv√°ran√≠ z√°lohy!", "error");
            }
        }

        function restoreBackup() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json,application/json';
            fileInput.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        console.log("Spracov√°vam z√°lohu:", backup);

                        // Kontrola z√°kladnej ≈°trukt√∫ry z√°lohy verzie 3
                        if (backup && backup.settings && typeof backup.workDaysData === 'object' && backup.backupVersion === 3) {

                            // 1. Obnovenie nastaven√≠ do glob√°lnych premenn√Ωch
                            hourlyWage = backup.settings.hourlyWage ?? 10;
                            taxRate = backup.settings.taxRate ?? 0.02;
                            isDarkMode = backup.settings.isDarkMode ?? false;
                            decimalPlaces = backup.settings.decimalPlaces ?? 2;
                            employeeName = backup.settings.employeeName ?? '';
                            console.log("Nastavenia obnoven√©:", {hourlyWage, taxRate, isDarkMode, decimalPlaces, employeeName});

                             // 2. Obnovenie d√°t mesiacov do glob√°lnej premennej
                            monthData = backup.workDaysData || {};
                             console.log("Mesaƒçn√© d√°ta obnoven√©.");

                             // 3. Nastavenie aktu√°lneho zobrazenia (ak je v z√°lohe)
                            const lastMonth = backup.settings.lastViewedMonth;
                            const lastYear = backup.settings.lastViewedYear;
                            if (lastMonth !== undefined && lastYear !== undefined && monthData[lastYear]?.[lastMonth] !== undefined) {
                                 currentMonth = lastMonth;
                                 currentYear = lastYear;
                                 console.log(`Nastavujem zobrazenie na ${getMonthName(currentMonth)} ${currentYear} zo z√°lohy.`);
                            } else {
                                 // Fallback na aktu√°lny d√°tum, ak posledn√© zobrazenie nie je platn√©
                                 const now = new Date();
                                 currentMonth = now.getMonth();
                                 currentYear = now.getFullYear();
                                 console.log("Posledn√© zobrazenie zo z√°lohy neplatn√©, nastavujem aktu√°lny mesiac/rok.");
                            }

                            // 4. Aktualiz√°cia cel√©ho UI s obnoven√Ωmi d√°tami
                            updateUIFromLoadedData();

                            // 5. Ulo≈æenie obnoven√Ωch d√°t PRE AKTU√ÅLNY MESIAC/ROK do Firebase
                            if (auth.currentUser) {
                                console.log("Obnova z√°lohy: Uklad√°m obnoven√© d√°ta pre aktu√°lne zobrazen√Ω mesiac/rok do Firebase...");
                                saveDataToFirebase(); // Ulo≈æ√≠ aktu√°lne zobrazen√Ω mesiac/rok
                            }

                            showSaveNotification("Z√°loha √∫spe≈°ne obnoven√°.");
                            alert("Z√°loha bola √∫spe≈°ne obnoven√°. Skontrolujte d√°ta a pr√≠padne prejdite na in√© mesiace, ak ich chcete synchronizova≈• s Firebase.");

                        } else {
                            alert("Chyba: S√∫bor z√°lohy m√° nespr√°vny form√°t alebo nepodporovan√∫ verziu (vy≈æaduje sa verzia 3).");
                             showSaveNotification("Chyba: Nespr√°vny form√°t z√°lohy", "error");
                        }
                    } catch (error) {
                        console.error("Chyba pri spracovan√≠ alebo obnove z√°lohy:", error);
                        alert("Chyba pri ƒç√≠tan√≠ alebo obnove z√°lohy. S√∫bor m√¥≈æe by≈• po≈°koden√Ω alebo ma≈• nespr√°vny form√°t.");
                        showSaveNotification("Chyba pri obnove z√°lohy!", "error");
                    }
                };
                reader.onerror = (e) => {
                    console.error("Chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy:", e);
                    alert("Nastala chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy.");
                    showSaveNotification("Chyba pri ƒç√≠tan√≠ s√∫boru!", "error");
                };
                reader.readAsText(file);
            };
            fileInput.click();
        }


        // 18) Inicializ√°cia (nezmenen√© oproti predch. verzii)
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM naƒç√≠tan√Ω, inicializujem...");
            populateYearSelect();
            const now = new Date(); currentMonth = now.getMonth(); currentYear = now.getFullYear();
            monthSelect.value = currentMonth; yearSelect.value = currentYear;
            applyDarkMode(isDarkMode); updateWelcomeMessage();
            if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(r => console.log('SW reg OK:', r.scope)).catch(e => console.error('SW reg FAIL:', e)); }); } else { console.warn("Service Worker nie je podporovan√Ω."); }
            console.log("Z√°kladn√° inicializ√°cia dokonƒçen√°, ƒçak√°m na stav prihl√°senia...");
        });
        function populateYearSelect() { const startYear = 2020; const endYear = new Date().getFullYear() + 2; yearSelect.innerHTML = ''; for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); } }

    </script>
</body>
</html>
