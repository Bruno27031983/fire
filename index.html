<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <!-- Načítanie písma Roboto z Google Fonts (externá knižnica) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase knižnice -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <!-- Pridaná knižnica pre Firebase App Check -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF a autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* CSS */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; }
    .settings > div { flex: 1 1 200px; margin: 5px; }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 800px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode { background-color: #666; color: white; }
    .btn.dark-mode { color: #333; }
    .reset-btn.dark-mode { background-color: #d32f2f; }
    .export-btn.dark-mode { background-color: #388e3c; }
    .restore-btn.dark-mode { background-color: #7B1FA2; }
    .backup-btn.dark-mode { background-color: #E68900; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
    #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
    #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <!-- HTML -->
  <div id="loading-container"><h1> Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte, dosiahnete všetko. </h1></div>
  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>
    <div class="settings">
      <div><label for="employeeNameInput">Meno pracovníka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()"></div>
      <div><label for="hourlyWageInput">Hodinová mzda (€): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div>
      <div><label for="taxRateInput">Daňové percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"></div>
      <div><label for="monthSelect">Mesiac: </label><select id="monthSelect" onchange="changeMonth()"><option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option><option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option><option value="6">Júl</option><option value="7">August</option><option value="8">September</option><option value="9">Október</option><option value="10">November</option><option value="11">December</option></select></div>
      <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div>
      <div><label for="decimalPlacesSelect">Počet desatinných miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2">2</option></select></div>
      <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>
    <div class="table-container">
      <table>
        <thead><tr><th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka</th><th>Odpracované</th><th>Hrubá Mzda (€)</th><th>Čistá Mzda (€)</th><th>Akcia</th></tr></thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
    </div>
  </div>
  <div id="saveNotification"></div>

  <script>
    // 1. Firebase Config & Init
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktivácii Firebase App Check:", error); }
    const db = firebase.firestore(); const auth = firebase.auth();

    // 2. Povolenie Firestore Offline Persistence
    let persistenceEnabled = false;
    db.enablePersistence().then(() => {
        console.log("Firestore offline persistence povolená.");
        persistenceEnabled = true;
    }).catch((err) => { console.error("Firestore offline persistence chyba:", err.code, err.message, err); /*...*/ });

    // 3. Globálne premenné
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate; let monthData = {}; let firestoreListenerUnsubscribe = null;
    const workDays = document.getElementById('workDays'); const totalSalaryDiv = document.getElementById('totalSalary'); const dataSizeText = document.getElementById('dataSizeText'); const dataSizeFill = document.getElementById('dataSizeFill'); const hourlyWageInput = document.getElementById('hourlyWageInput'); const taxRateInput = document.getElementById('taxRateInput'); const monthSelect = document.getElementById('monthSelect'); const yearSelect = document.getElementById('yearSelect'); const decimalPlacesSelect = document.getElementById('decimalPlacesSelect'); const employeeNameInput = document.getElementById('employeeNameInput'); const MAX_DATA_SIZE = 4 * 1024 * 1024; const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // 4. Auth funkcie (Register, Login, Logout, ForgotPassword) - Bez zmeny
    function register() { /*...*/ }
    function login() { /*...*/ }
    function logout() { /*...*/ }
    function forgotPassword() { /*...*/ }

    // 5. Auth State Change Listener - UPRAVENÉ: Načíta z localStorage a potom spustí listener
    auth.onAuthStateChanged(user => {
        console.log("onAuthStateChanged: Stav zistený.", user ? `Používateľ: ${user.email}` : "Žiadny používateľ.");
        const authContainer = document.getElementById('auth-container');
        const calculatorContainer = document.getElementById('calculator-container');
        const loadingContainer = document.getElementById('loading-container');
        if (loadingContainer) loadingContainer.classList.add('hidden');

        if (firestoreListenerUnsubscribe) {
            console.log("Odhlasujem predchádzajúci Firestore listener pri zmene Auth stavu.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        if (user) {
            document.getElementById('auth-message').textContent = "Prihlásený: " + user.email;
            authContainer.style.display = "none";
            calculatorContainer.style.display = "block";
            console.log("Používateľ prihlásený, načítavam stav z localStorage a spúšťam listener...");

            // --- Začiatok: Načítanie KOMPLETNÉHO STAVU z localStorage ---
            // Najprv nastavíme mesiac/rok, aby sme vedeli, ktoré dáta načítať
            const storedMonth = localStorage.getItem('currentMonth');
            const storedYear = localStorage.getItem('currentYear');
            const currentDate = new Date();
            currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
            currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
            monthSelect.value = currentMonth;
             if (!yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                 console.warn(`Rok ${currentYear} z localStorage nenájdený v selecte, používam aktuálny rok.`);
                 currentYear = currentDate.getFullYear();
                 populateYearSelect();
             }
            yearSelect.value = currentYear;

            // Teraz voláme loadFromLocalStorage, ktorá načíta VŠETKO (nastavenia aj dáta dní) a AKTUALIZUJE UI
            console.log("onAuthStateChanged: Volám loadFromLocalStorage() na zobrazenie posledného stavu...");
            loadFromLocalStorage();
            // --- Koniec: Načítanie KOMPLETNÉHO STAVU z localStorage ---

            // Až teraz nastavíme listener, ktorý bude počúvať na zmeny zo servera/cache
            // a aktualizovať stav (vrátane localStorage) a UI
            console.log("onAuthStateChanged: Spúšťam Firestore listener...");
            setupFirestoreListener();

            // Kontrola/vytvorenie používateľského dokumentu (zostáva)
            const uid = user.uid;
            const userDocRef = db.collection("users").doc(uid);
            userDocRef.get().then(userDocSnap => { /* ... ako predtým ... */
                 if (!userDocSnap.exists) { userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true }).then(() => console.log("Vytvorený/aktualizovaný dokument pre:", uid)).catch(err => console.error("Chyba pri vytváraní/aktualizácii dokumentu používateľa:", err)); } else { console.log("Dokument používateľa existuje:", uid); }
            }).catch(err => { /* ... ako predtým ... */
                 console.error("Chyba pri kontrole dokumentu používateľa (userDocRef.get):", err); showSaveNotification("Chyba pri overovaní používateľských dát", "error");
            });

        } else {
            // Blok pre odhláseného používateľa
            document.getElementById('auth-message').textContent = "Žiadny používateľ nie je prihlásený.";
            authContainer.style.display = "block";
            calculatorContainer.style.display = "none";
            console.log("Používateľ odhlásený/neprihlásený.");
            monthData = {}; workDays.innerHTML = ''; totalSalaryDiv.innerHTML = ''; updateWelcomeMessage();
        }
    });


    // 6. Utility funkcie (debounce, showSaveNotification) - Bez zmeny
    function debounce(func, wait) { /*...*/ }
    function showSaveNotification(message, type = 'success') { /*...*/ }

    // --- Funkcie pre pozdrav (getFirstName, updateWelcomeMessage) - Bez zmeny ---
    function getFirstName(fullName) { /*...*/ }
    function updateWelcomeMessage() { /*...*/ }

    // --- Pomocná funkcia getFirestoreDocRef - Bez zmeny ---
    function getFirestoreDocRef() { /*...*/ }

    // --- Funkcia processFirestoreData - Bez zmeny ---
    function processFirestoreData(data, isLocalWrite) { /*...*/ }

    // 7. Funkcia setupFirestoreListener - Bez zmeny (používa processFirestoreData)
    function setupFirestoreListener() { /*...*/ }

    // 8. Funkcia saveToFirebase - Bez zmeny
    async function saveToFirebase() { /*...*/ }

    // 9. Funkcia saveToLocalStorage - Bez zmeny
    function saveToLocalStorage() { /*...*/ }

    // 10. Funkcia loadFromLocalStorage - Bez zmeny (ale volaná častejšie)
    function loadFromLocalStorage() {
        // console.warn("loadFromLocalStorage: Táto funkcia by sa mala volať len pri obnove zálohy."); // Komentár už neplatí
        console.log("loadFromLocalStorage: Načítavam kompletný stav z localStorage...");
        try {
             if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) { const storedMonth = localStorage.getItem('currentMonth'); const storedYear = localStorage.getItem('currentYear'); const currentDate = new Date(); currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth(); currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear(); console.log(`loadFromLocalStorage: Inicializujem mesiac=${currentMonth}, rok=${currentYear}`); } console.log(`loadFromLocalStorage: Načítavam pre ${getMonthName(currentMonth)} ${currentYear}`); const storedMonthData = localStorage.getItem('workDaysData'); monthData = storedMonthData ? JSON.parse(storedMonthData) : {}; if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) { console.log(`loadFromLocalStorage: Načítaných ${monthData[currentYear][currentMonth].length} záznamov pre ${currentYear}-${currentMonth} z localStorage.`); } else { console.log(`loadFromLocalStorage: Pre ${currentYear}-${currentMonth} neboli v localStorage nájdené žiadne záznamy alebo štruktúra chýba.`); monthData = {}; /* Reset, ak chýba štruktúra */ } hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10; taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02; const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false; decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1; employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
             // Po načítaní dát voláme updateUIFromLoadedData na prekreslenie
             updateUIFromLoadedData(darkMode);
         } catch (error) { console.error(`Kritická chyba pri načítavaní/spracovaní dát z localStorage pre ${getMonthName(currentMonth)} ${currentYear}:`, error); showSaveNotification("Chyba pri načítaní lokálnych dát!", "error"); monthData = {}; createTable(); calculateTotal(); }
     }

    // 11. Funkcia updateUIFromLoadedData - Bez zmeny
    function updateUIFromLoadedData(darkModeValue) { /*...*/ }

    // 12. Funkcia applyDarkMode - Bez zmeny
    function applyDarkMode(isDark) { /*...*/ }

    // 13) Funkcie pre tabuľku (getDayName, createTable, processInputCompletion, isTimeValid, handleInput, handleBreakInput, updateMonthDataFromInput, formatInput, moveNext, calculateRow, resetRow, resetAll) - Bez zmeny
    function getDayName(year, month, day) { /*...*/ }
    function createTable() { /*...*/ }
    function processInputCompletion(inputId, nextId) { /*...*/ }
    const debouncedProcessInputCompletion = debounce(processInputCompletion, 500);
    function isTimeValid(timeStr) { /*...*/ }
    function handleInput(input, nextId, day) { /*...*/ }
    function handleBreakInput(day) { /*...*/ }
    function updateMonthDataFromInput(input, day) { /*...*/ }
    function formatInput(input) { /*...*/ }
    function moveNext(currentElement, nextId) { /*...*/ }
    function calculateRow(day) { /*...*/ }
    function resetRow(day) { /*...*/ }
    function resetAll() { /*...*/ }

    // 14) Funkcia calculateTotal - Bez zmeny
    function calculateTotal() { /*...*/ }

    // 15) Funkcie pre PDF (exportToPDF, sendPDF) - Bez zmeny
    function exportToPDF() { /*...*/ }
    function sendPDF() { /*...*/ }

    // 16) Ostatné nastavenia (changeDecimalPlaces, updateEmployeeName, updateSettings, changeMonth, changeYear, handleMonthYearChange, getDaysInMonth, getMonthName, updateDataSize, toggleDarkMode) - Bez zmeny okrem handleMonthYearChange
    function changeDecimalPlaces() { /*...*/ }
    function updateEmployeeName() { /*...*/ }
    function updateSettings() { /*...*/ }
    function changeMonth() { /*...*/ }
    function changeYear() { /*...*/ }
    // UPRAVENÉ: handleMonthYearChange teraz volá loadFromLocalStorage a reštartuje listener
    function handleMonthYearChange() {
        console.log(`handleMonthYearChange: Spustené pre ${getMonthName(currentMonth)} ${currentYear}`);
        localStorage.setItem('currentMonth', currentMonth.toString());
        localStorage.setItem('currentYear', currentYear.toString());
        // Pri zmene mesiaca/roka vždy načítame stav z localStorage
        loadFromLocalStorage();
        if (auth.currentUser) {
            // A reštartujeme listener, aby sa pripojil na nový dokument
            setupFirestoreListener();
        } else {
            console.log("handleMonthYearChange: Používateľ nie je prihlásený.");
        }
    }
    function getDaysInMonth(month) { /*...*/ }
    function getMonthName(month) { /*...*/ }
    function updateDataSize() { /*...*/ }
    function toggleDarkMode() { /*...*/ }

    // 17) Zálohovanie a obnova - Bez zmeny
    function createBackup() { /*...*/ }
    function restoreBackup() { /*...*/ } // Táto funkcia už volá loadFromLocalStorage po obnove

    // 18) Inicializácia - UPRAVENÉ: Zjednodušené online/offline handlery
     document.addEventListener('DOMContentLoaded', () => {
         console.log("DOM načítaný, inicializujem...");
         populateYearSelect();
         const initialDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
         applyDarkMode(initialDarkMode);
         updateWelcomeMessage();

         // --- Online/Offline Listenery ---
         window.addEventListener('offline', handleOfflineStatus);
         window.addEventListener('online', handleOnlineStatus);
         if (!navigator.onLine) { handleOfflineStatus(); } // Zobraziť počiatočný stav
         // --- ---

         if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(registration => { console.log('ServiceWorker zaregistrovaný s rozsahom: ', registration.scope); }).catch(error => { console.error('Registrácia ServiceWorker zlyhala: ', error); }); }); } else { console.warn("Service Worker nie je podporovaný v tomto prehliadači."); }
         console.log("Základná inicializácia dokončená, čakám na stav prihlásenia (onAuthStateChanged)...");
     });

     function populateYearSelect() { /*...*/ }

     // --- UPRAVENÉ: Funkcie pre Online/Offline stav ---
     function handleOfflineStatus() {
         console.log("Status: Offline");
         // Len zobrazíme notifikáciu, spoliehame sa na dáta už načítané z localStorage
         showSaveNotification("Ste offline. Zobrazuje sa posledný uložený stav.", "warning");
         // Nečítame explicitne z cache
     }

     function handleOnlineStatus() {
         console.log("Status: Online");
         showSaveNotification("Opäť online. Synchronizujem...", "success");
         // Reštartujeme listener, aby sa zosynchronizoval so serverom
         if (auth.currentUser) {
             console.log("handleOnlineStatus: Reštartujem Firestore listener...");
             setupFirestoreListener();
         }
     }
     // --- KONIEC: Funkcie pre Online/Offline stav ---

  </script>
</body>
</html>
