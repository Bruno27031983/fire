<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* === CSS ≈†t√Ωly - ZAHRNUT√â V≈†ETKY √öPRAVY === */
    body {
        font-family: 'Roboto', sans-serif;
        line-height: 1.6;
        margin: 0; /* Odstr√°nen√Ω predvolen√Ω margin */
        padding: 0; /* Odstr√°nen√© odsadenie od okrajov okna */
        background-color: #f4f4f4;
        color: #333;
    }
    .container {
        /* max-width: 1200px; */ /* ODSTR√ÅNEN√â pre pln√∫ ≈°√≠rku */
        /* margin: auto; */    /* ODSTR√ÅNEN√â pre pln√∫ ≈°√≠rku */
        width: 100%;           /* Explicitn√° pln√° ≈°√≠rka */
        box-sizing: border-box;/* Padding sa zapoƒç√≠ta do ≈°√≠rky */
        min-height: 100vh;     /* Kontajner na cel√∫ v√Ω≈°ku (voliteƒæn√©) */
        background: white;
        padding: 15px;         /* Vn√∫torn√© odsadenie ponechan√© */
        /* border-radius: 5px; */ /* Odstr√°nen√© (voliteƒæn√©) */
        /* box-shadow: 0 0 10px rgba(0,0,0,0.1); */ /* Odstr√°nen√© (voliteƒæn√©) */
        position: relative;
     }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; min-height: 1.4em; /* V√Ω≈°ka kv√¥li stabilite pri zobrazen√≠/skryt√≠ pozdravu */ }
    .settings {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
    }
    .settings > div,
    .settings > details,
    .settings > button {
        flex: 1 1 200px;
        margin: 0;
    }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        min-width: 800px; /* Zachova≈• pre pr√≠pad √∫zkych obrazoviek, ak je overflow-x */
        table-layout: fixed; /* D√¥le≈æit√© pre <col> ≈°√≠rky, ak by sa pridali */
        word-wrap: break-word;
    }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"], select {
        width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px;
    }
    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }

    /* Dark Mode ≈†t√Ωly */
    body.dark-mode { background-color: #1e1e1e; /* Tmav≈°ie pozadie */ color: #f1f1f1; }
    .container.dark-mode { background-color: #2d2d2d; /* Tmav≈°√≠ kontajner */ color: #f1f1f1; /* box-shadow: none; */ /* Tie≈à v tmavom re≈æime nemus√≠ by≈• vidie≈• */ }
    table.dark-mode { background-color: #3a3a3a; color: #f1f1f1; }
    th.dark-mode { background-color: #4a4a4a; border-color: #555; }
    td.dark-mode { background-color: #3a3a3a; color: #f1f1f1; border-color: #555;}
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode {
        background-color: #4a4a4a; color: white; border-color: #666;
    }
    .btn.dark-mode { background-color: #555; color: #f1f1f1;} /* V≈°eobecn√© tmav√© tlaƒçidlo */
    .reset-btn.dark-mode { background-color: #c0392b; } .reset-btn.dark-mode:hover { background-color: #a93226; }
    .export-btn.dark-mode { background-color: #27ae60; } .export-btn.dark-mode:hover { background-color: #229954; }
    .restore-btn.dark-mode { background-color: #8e44ad; } .restore-btn.dark-mode:hover { background-color: #7d3c98; }
    .backup-btn.dark-mode { background-color: #f39c12; } .backup-btn.dark-mode:hover { background-color: #d68910; }
    .highlight.dark-mode { background-color: #444; color: #ffcc00; border-color: #ffcc00; } /* Zv√Ωraznenie pre tmav√Ω re≈æim */
    #totalSalary.dark-mode { background-color: #3a3a3a; border: 1px solid #555; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container.dark-mode { background: #3a3a3a; color: #f1f1f1; } /* Dark mode pre auth */
    #auth-container input.dark-mode { background-color: #4a4a4a; color: white; border-color: #666;}
    #auth-container button.dark-mode { background-color: #27ae60; }
    #auth-container button.dark-mode:hover { background-color: #229954; }
    #forgot-password-link.dark-mode { color: #5dade2; }
    #saveNotification.dark-mode { background-color: #555; color: #f1f1f1; }
    #saveNotification.error.dark-mode { background-color: #c0392b; }
    #saveNotification.warning.dark-mode { background-color: #f39c12; }

    /* ≈†t√Ωly pre Auth kontajner */
    #auth-container { max-width: 400px; margin: 50px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; }
    #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
    #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
    #auth-container button:hover { background-color: #45a049; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }

    /* ≈†t√Ωly pre notifik√°ciu ulo≈æenia */
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }

    /* --- ≈†T√ùLY PRE ZBALITEƒΩN√ö ƒåAS≈§ --- */
    .collapsible-settings summary {
        cursor: pointer;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
        background-color: #f8f8f8;
        margin-bottom: 5px;
        display: list-item;
        transition: background-color 0.2s ease;
        font-weight: bold;
    }
    .collapsible-settings summary:hover {
        background-color: #eee;
    }
    .collapsible-content {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 5px 5px 5px;
        border-top: 1px solid #eee;
        margin-top: 5px;
    }
    .collapsible-content > div {
        flex: 1 1 200px;
        margin: 0;
    }
    /* Dark mode pre summary a collapsible content */
    body.dark-mode .collapsible-settings summary {
        background-color: #555;
        border-color: #777;
        color: #f1f1f1;
    }
     body.dark-mode .collapsible-settings summary:hover {
        background-color: #666;
    }
    body.dark-mode .collapsible-content {
        border-top-color: #666;
    }
    /* --- KONIEC ≈†T√ùLOV PRE ZBALITEƒΩN√ö ƒåAS≈§ --- */
  </style>
</head>
<body>
  <div id="auth-container" style="display:none;">
    <h1>Prihl√°senie / Registr√°cia</h1>
    <div id="auth-message">≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.</div>
    <div id="auth-forms">
      <h2>Registr√°cia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrova≈•</button>
      <h2>Prihl√°senie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihl√°si≈• sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>

  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2> <div class="settings">
        <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
                <option value="0">Janu√°r</option><option value="1">Febru√°r</option><option value="2">Marec</option><option value="3">Apr√≠l</option><option value="4">M√°j</option><option value="5">J√∫n</option><option value="6">J√∫l</option><option value="7">August</option><option value="8">September</option><option value="9">Okt√≥ber</option><option value="10">November</option><option value="11">December</option>
            </select>
        </div>
        <details class="collapsible-settings">
            <summary>ƒéal≈°ie nastavenia</summary>
            <div class="collapsible-content">
                <div><label for="employeeNameInput">Meno pracovn√≠ka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()"></div>
                <div><label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div>
                <div><label for="taxRateInput">Da≈àov√© percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"></div>
                <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div>
                <div><label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2">2</option></select></div>
            </div>
        </details>
        <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div>
    <div class="table-container">
      <table>
        <thead><tr><th>De≈à</th><th>Pr√≠chod</th><th>Odchod</th><th>Prest√°vka</th><th>Odpracovan√©</th><th>Hrub√° Mzda (‚Ç¨)</th><th>ƒåist√° Mzda (‚Ç¨)</th><th>Akcia</th></tr></thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lok√°lne √∫lo≈æisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetova≈• v≈°etko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈•</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
      <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
    </div>
  </div>
  <div id="saveNotification"></div>

  <script>
    // 1. Firebase Config & Init
    // Konfigur√°cia je teraz priamo tu:
    const firebaseConfig = {
        apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", // POZOR: Overte si, ƒçi s√∫ to va≈°e spr√°vne kƒæ√∫ƒçe!
        authDomain: "bruno-3cee2.firebaseapp.com",
        projectId: "bruno-3cee2",
        storageBucket: "bruno-3cee2.appspot.com",
        messagingSenderId: "155545319308",
        appId: "1:155545319308:web:5da498ff1cd3e1833888a9"
    };

    // Inicializ√°cia Firebase
    firebase.initializeApp(firebaseConfig);
    try {
        // Nahraƒète 'YOUR_RECAPTCHA_SITE_KEY' va≈°√≠m kƒæ√∫ƒçom pre reCAPTCHA Enterprise alebo v3
        firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true);
        console.log("Firebase App Check aktivovan√Ω.");
    } catch (error) {
        console.warn("Chyba pri aktiv√°cii Firebase App Check:", error);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- Zvy≈°ok JavaScript k√≥du zost√°va rovnak√Ω ako v predch√°dzaj√∫cej odpovedi ---
    // (Obsahuje: Offline persistence, Glob√°lne premenn√©, Auth funkcie, Listener,
    // Utility, Pozdrav, Firestore listener, Ukladanie/Naƒç√≠tanie, UI update,
    // Dark mode, Tabuƒæka, V√Ωpoƒçty, Reset, PDF Export, Nastavenia, Z√°lohovanie, Init...)

    // 2. Povolenie Firestore Offline Persistence
    db.enablePersistence().then(() => { console.log("Firestore offline persistence povolen√°."); }).catch((err) => { console.error("Firestore offline persistence chyba:", err.code, err.message, err); if (err.code == 'failed-precondition') { console.warn("Firestore offline persistence: Viacn√°sobn√© otvoren√© taby, povolen√© len v jednom."); } else if (err.code == 'unimplemented') { console.error("Firestore offline persistence: Prehliadaƒç nie je podporovan√Ω."); } });

    // 3. Glob√°lne premenn√©
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate; let monthData = {}; let firestoreListenerUnsubscribe = null;
    const workDays = document.getElementById('workDays'); const totalSalaryDiv = document.getElementById('totalSalary'); const dataSizeText = document.getElementById('dataSizeText'); const dataSizeFill = document.getElementById('dataSizeFill'); const hourlyWageInput = document.getElementById('hourlyWageInput'); const taxRateInput = document.getElementById('taxRateInput'); const monthSelect = document.getElementById('monthSelect'); const yearSelect = document.getElementById('yearSelect'); const decimalPlacesSelect = document.getElementById('decimalPlacesSelect'); const employeeNameInput = document.getElementById('employeeNameInput'); const MAX_DATA_SIZE = 4 * 1024 * 1024; const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // 4. Auth funkcie (Register, Login, Logout, Forgot Password)
    function register() { const email = document.getElementById('registerEmail').value; const password = document.getElementById('registerPassword').value; auth.createUserWithEmailAndPassword(email, password).then((userCredential) => { console.log("Registrovan√Ω:", userCredential.user); alert("Registr√°cia √∫spe≈°n√°!"); }).catch((error) => { console.error("Chyba pri registr√°cii:", error.message); alert("Chyba pri registr√°cii: " + error.message); }); }
    function login() { const email = document.getElementById('loginEmail').value; const password = document.getElementById('loginPassword').value; auth.signInWithEmailAndPassword(email, password).then((userCredential) => { console.log("Prihl√°sen√Ω:", userCredential.user); alert("Prihl√°senie √∫spe≈°n√©!"); }).catch((error) => { console.error("Chyba pri prihl√°sen√≠:", error.message); alert("Chyba pri prihl√°sen√≠: " + error.message); }); }
    function logout() { if (confirm("Naozaj sa chcete odhl√°si≈•?")) { auth.signOut().then(() => { console.log("Odhl√°sen√Ω."); alert("Odhl√°senie √∫spe≈°n√©!"); }).catch((error) => { console.error("Chyba pri odhl√°sen√≠:", error.message); alert("Chyba pri odhl√°sen√≠: " + error.message); }); } }
    function forgotPassword() {
      const emailInput = document.getElementById('loginEmail'); const email = emailInput.value;
      if (!email) { alert("Pros√≠m, zadajte svoju e-mailov√∫ adresu do poƒæa pre prihl√°senie."); emailInput.focus(); return; }
      auth.sendPasswordResetEmail(email).then(() => { console.log("E-mail na obnovenie hesla odoslan√Ω na:", email); alert("Odkaz na obnovenie hesla bol odoslan√Ω na va≈°u e-mailov√∫ adresu. Skontrolujte si pros√≠m po≈°tu (aj prieƒçinok Spam)."); }).catch((error) => { console.error("Chyba pri odosielan√≠ e-mailu na obnovenie hesla:", error); alert("Chyba pri odosielan√≠ e-mailu na obnovenie hesla: " + error.message); });
    }

    // 5. Auth State Change Listener (bez loadingContainer)
    auth.onAuthStateChanged(user => {
        console.log("onAuthStateChanged: Stav zisten√Ω.", user ? `Pou≈æ√≠vateƒæ: ${user.email}` : "≈Ωiadny pou≈æ√≠vateƒæ.");
        const authContainer = document.getElementById('auth-container');
        const calculatorContainer = document.getElementById('calculator-container');

        // Aplikovanie dark mode na auth kontajner podƒæa stavu body
        if(document.body.classList.contains('dark-mode')) {
            authContainer?.classList.add('dark-mode');
            authContainer?.querySelectorAll('input, button, a').forEach(el => el.classList.add('dark-mode'));
        } else {
            authContainer?.classList.remove('dark-mode');
            authContainer?.querySelectorAll('input, button, a').forEach(el => el.classList.remove('dark-mode'));
        }


        if (firestoreListenerUnsubscribe) { firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; }

        if (user) { // Pou≈æ√≠vateƒæ je prihl√°sen√Ω
            authContainer.style.display = "none";
            calculatorContainer.style.display = "block"; // Zobraz√≠ sa kontajner kalkulaƒçky
            console.log("Pou≈æ√≠vateƒæ prihl√°sen√Ω, nastavujem UI a listener...");

            // Naƒç√≠tanie posledn√©ho stavu z localStorage
            const storedMonth = localStorage.getItem('currentMonth'); const storedYear = localStorage.getItem('currentYear');
            const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false; const currentDate = new Date();
            currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
            currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
            monthSelect.value = currentMonth;
            // Kontrola a pr√≠padn√© doplnenie rokov, ak ch√Ωba
            if (!yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                console.warn(`Rok ${currentYear} z localStorage nen√°jden√Ω, dopƒ∫≈àam select a nastavujem.`);
                populateYearSelect(); // Znova napln√≠ roky
            }
             if (yearSelect.querySelector(`option[value="${currentYear}"]`)){
                 yearSelect.value = currentYear;
             } else {
                 // Ak ani po doplnen√≠ rok nie je platn√Ω (veƒæmi star√Ω rok), nastav√≠ aktu√°lny
                 console.warn(`Rok ${currentYear} st√°le neplatn√Ω, pou≈æ√≠vam aktu√°lny rok.`);
                 currentYear = currentDate.getFullYear();
                 yearSelect.value = currentYear;
             }

            applyDarkMode(darkMode); // Aplikuje dark mode hneƒè na zaƒçiatku

            // Naƒç√≠tanie ostatn√Ωch nastaven√≠
            hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
            taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
            decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
            employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = taxRate * 100;
            decimalPlacesSelect.value = decimalPlaces;
            employeeNameInput.value = employeeName;

            loadFromLocalStorage(); // Naƒç√≠ta d√°ta z localStorage pre aktu√°lny mesiac/rok
            setupFirestoreListener(); // Nastav√≠ listener na zmeny z Firebase

            // Vytvorenie/kontrola u≈æ√≠vateƒæsk√©ho dokumentu vo Firebase
            const uid = user.uid; const userDocRef = db.collection("users").doc(uid);
            userDocRef.get().then(userDocSnap => { if (!userDocSnap.exists) { userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true }).then(() => console.log("Vytvoren√Ω/aktualizovan√Ω dokument pre:", uid)).catch(err => console.error("Chyba pri vytv√°ran√≠/aktualiz√°cii dokumentu pou≈æ√≠vateƒæa:", err)); } else { console.log("Dokument pou≈æ√≠vateƒæa existuje:", uid); } }).catch(err => { console.error("Chyba pri kontrole dokumentu pou≈æ√≠vateƒæa:", err); showSaveNotification("Chyba pri overovan√≠ pou≈æ√≠vateƒæsk√Ωch d√°t", "error"); });

            // Timeout pre offline naƒç√≠tanie (ak je potrebn√©)
             setTimeout(() => { if (auth.currentUser && !navigator.onLine) { loadFromLocalStorage(); } }, 150);

        } else { // Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω
            authContainer.style.display = "block"; // Zobraz√≠ sa prihlasovac√≠ formul√°r
            calculatorContainer.style.display = "none";
            monthData = {}; workDays.innerHTML = ''; totalSalaryDiv.innerHTML = '';
            updateWelcomeMessage(); // Skryje pozdrav
        }
    });

    // 6. Utility funkcie (debounce, showSaveNotification)
    function debounce(func, wait) { let timeout; return function (...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), wait); }; }
    function showSaveNotification(message, type = 'success') {
        const notification = document.getElementById('saveNotification');
        notification.textContent = message;
        // Reset classes before adding new ones
        notification.className = '';
        notification.classList.add('show');
         // Add dark-mode class if needed
        if (document.body.classList.contains('dark-mode')) {
            notification.classList.add('dark-mode');
        }
        // Add type class (error/warning/success)
        if (type === 'error') { notification.classList.add('error'); }
        else if (type === 'warning') { notification.classList.add('warning'); }
        // No need for 'success' class, default style applies

        setTimeout(() => {
             notification.classList.remove('show');
             // Optionally remove type classes after hiding if needed
             // notification.classList.remove('error', 'warning', 'dark-mode');
        }, 3000);
    }


    // Funkcie pre pozdrav (s upraven√Ωm textom)
    function getFirstName(fullName) {
      if (!fullName || typeof fullName !== 'string') { return ''; }
      const trimmedName = fullName.trim(); if (!trimmedName) { return ''; }
      const parts = trimmedName.split(' '); return parts[0];
    }
    function updateWelcomeMessage() {
      const welcomeElement = document.getElementById('welcomeMessage'); if (!welcomeElement) return;
      const firstName = getFirstName(employeeName);
      if (firstName) { welcomeElement.textContent = `Vitaj sp√§≈•, ${firstName}! üëã`; }
      else { welcomeElement.textContent = ''; }
    }

    // 7. Funkcia na nastavenie Firestore Listenera
    function setupFirestoreListener() {
        if (firestoreListenerUnsubscribe) { console.log("Odhlasujem predch√°dzaj√∫ci Firestore listener."); firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; }
        const uid = auth.currentUser?.uid; if (!uid) { console.log("setupFirestoreListener: Nikto nie je prihl√°sen√Ω."); return; }
        if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) { const now = new Date(); currentMonth = currentMonth ?? now.getMonth(); currentYear = currentYear ?? now.getFullYear(); console.warn("setupFirestoreListener: Ch√Ωba mesiac/rok."); }
        const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`; const docRef = db.doc(docPath);
        console.log(`setupFirestoreListener: Nastavujem listener pre ${docPath}`);

        firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
            console.log(`Firestore listener: Prijat√Ω snapshot pre ${docPath}. Metadata:`, docSnap.metadata);
            const isLocalWrite = docSnap.metadata.hasPendingWrites;

            if (isLocalWrite) {
                console.log("Listener: Detekovan√° lok√°lna zmena. Preskakujem UI update.");
                showSaveNotification("Synchronizujem...", "warning");
                // Ulo≈æ√≠me do local storage aj pri lok√°lnom z√°pise pre konzistenciu offline
                if (docSnap.exists) {
                    const data = docSnap.data(); const firebaseDaysData = data.days || [];
                    if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '' }));
                    localStorage.setItem('workDaysData', JSON.stringify(monthData));
                }
                return; // Neaktualizujeme UI z lok√°lneho echa
            }

            // Spracovanie d√°t zo servera alebo cache
            if (docSnap.exists) {
                const data = docSnap.data();
                console.log(`Listener: Dokument ${docPath} existuje. Zdroj: ${docSnap.metadata.fromCache ? 'Cache' : 'Server'}. D√°ta:`, data);
                try {
                    const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
                    const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
                    const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
                    const firebaseEmployeeName = data.employeeName ?? employeeName;
                    const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');
                    const firebaseDaysData = data.days || [];

                    // Aktualiz√°cia glob√°lnych premenn√Ωch
                    hourlyWage = firebaseHourlyWage;
                    taxRate = firebaseTaxRatePercent / 100;
                    decimalPlaces = firebaseDecimalPlaces;
                    employeeName = firebaseEmployeeName;

                    // Bezpeƒçn√° aktualiz√°cia UI (len ak element nem√° fokus)
                    if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
                    if (document.activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
                    decimalPlacesSelect.value = decimalPlaces;
                    if (document.activeElement !== employeeNameInput) employeeNameInput.value = employeeName;

                    // Aktualiz√°cia d√°t v pam√§ti a local storage
                    if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '' }));
                    localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                    localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                    localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                    localStorage.setItem('employeeName', JSON.stringify(employeeName));
                    localStorage.setItem('darkMode', JSON.stringify(firebaseDarkMode)); // Ulo≈æ√≠me aj dark mode
                    localStorage.setItem('workDaysData', JSON.stringify(monthData));
                    console.log("Listener: D√°ta ulo≈æen√© do localStorage.");

                    // Cielen√° aktualiz√°cia UI tabuƒæky
                    const daysInMonth = getDaysInMonth(currentMonth);
                    const activeElementId = document.activeElement?.id;
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayData = monthData[currentYear]?.[currentMonth]?.[i - 1];
                        const startId = `start-${currentYear}-${currentMonth}-${i}`;
                        const endId = `end-${currentYear}-${currentMonth}-${i}`;
                        const breakId = `break-${currentYear}-${currentMonth}-${i}`;
                        const startElement = document.getElementById(startId);
                        const endElement = document.getElementById(endId);
                        const breakElement = document.getElementById(breakId);

                        if (startElement && endElement && breakElement) {
                            const newStart = dayData?.start || ''; const newEnd = dayData?.end || ''; const newBreak = dayData?.breakTime || '';
                            if (startElement.value !== newStart && activeElementId !== startId) startElement.value = newStart;
                            if (endElement.value !== newEnd && activeElementId !== endId) endElement.value = newEnd;
                            if (breakElement.value !== newBreak && activeElementId !== breakId) breakElement.value = newBreak;
                            calculateRow(i); // Prepoƒç√≠tame riadok
                        } else if(document.getElementById(`total-${currentYear}-${currentMonth}-${i}`)) {
                            // Ak existuje bunka total, ale ch√Ωbaj√∫ inputy, logujeme varovanie
                             console.warn(`Listener: Ch√Ωbaj√∫ input elementy pre de≈à ${i} pri UI update.`);
                        }
                    }

                    calculateTotal(); // Prepoƒç√≠ta celkov√© s√∫ƒçty
                    applyDarkMode(firebaseDarkMode); // Aplikuje dark mode
                    updateWelcomeMessage(); // Aktualizuje pozdrav
                    console.log("Listener: UI aktualizovan√©.");
                    if (!docSnap.metadata.fromCache) {
                        showSaveNotification("D√°ta synchronizovan√©");
                    }

                } catch (processError) {
                    console.error(`Listener: Chyba pri spracovan√≠ d√°t z Firestore pre ${docPath}:`, processError);
                    showSaveNotification("Chyba: Nespr√°vny form√°t d√°t z Firebase", "error");
                }
            } else { // Dokument na Firebase neexistuje
                console.log(`Listener: Dokument ${docPath} neexistuje (${docSnap.metadata.fromCache ? 'Cache' : 'Server'}). Inicializujem lok√°lne.`);
                if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                monthData[currentYear][currentMonth] = []; // Pr√°zdne d√°ta pre tento mesiac
                localStorage.setItem('workDaysData', JSON.stringify(monthData)); // Ulo≈æ√≠me pr√°zdne pole

                // Naƒç√≠tame nastavenia z localStorage a zobraz√≠me pr√°zdnu tabuƒæku
                hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
                const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
                employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
                hourlyWageInput.value = hourlyWage; taxRateInput.value = taxRate * 100; decimalPlacesSelect.value = decimalPlaces; employeeNameInput.value = employeeName;
                createTable(); calculateTotal(); applyDarkMode(darkMode); updateWelcomeMessage();
            }
        }, (error) => {
            console.error(`Firestore listener chyba pre ${docPath}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa pripoji≈• k Firebase", "error");
            console.log("Listener chyba, sk√∫≈°am naƒç√≠ta≈• z localStorage...");
            loadFromLocalStorage(); // Fallback na lok√°lne d√°ta pri chybe listenera
        });
    }


    // 8. Funkcia na ukladanie do Firebase
    const debouncedSaveToFirebase = debounce(async () => { // Pridan√Ω debounce aj sem
        const currentUser = auth.currentUser;
        if (!currentUser) { console.log("saveToFirebase: Nikto nie je prihl√°sen√Ω."); return; }
        if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
            console.error("saveToFirebase: Ch√Ωba mesiac alebo rok!"); return;
        }
        try {
            const currentMonthWorkData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            console.log(`saveToFirebase: Uklad√°m ${currentMonthWorkData.length} z√°znamov pre ${currentYear}-${currentMonth}.`);
            const dataToSave = {
                days: currentMonthWorkData,
                hourlyWage: hourlyWage || 10,
                taxRate: (taxRate * 100) || 2,
                decimalPlaces: decimalPlaces || 1,
                employeeName: employeeName || '',
                darkMode: document.body.classList.contains('dark-mode'),
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // ƒåasov√° znaƒçka servera
            };
            const yearMonthDoc = `${currentYear}-${currentMonth}`;
            const uid = currentUser.uid;
            const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);

            await docRef.set(dataToSave, { merge: true }); // Pou≈æijeme merge pre pr√≠padn√© bud√∫ce polia
            console.log(`saveToFirebase: D√°ta pre ${yearMonthDoc} √∫spe≈°ne ulo≈æen√©/aktualizovan√©.`);
            // Notifik√°cia sa zobraz√≠, keƒè d√°ta pr√≠du nasp√§≈• cez listener zo servera

        } catch (error) {
            console.error(`Chyba pri ukladan√≠ do Firebase pre ${currentYear}-${currentMonth}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa ulo≈æi≈• d√°ta do Firebase", "error");
        }
    }, 1500); // Debounce na 1.5 sekundy pre ukladanie do Firebase

    // 9. Funkcia na ukladanie do Local Storage (sp√∫≈°≈•a aj debouncovan√© ukladanie do Firebase)
    function saveToLocalStorage() {
        try {
            if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                 console.error("saveToLocalStorage: Ch√Ωba mesiac alebo rok!"); return;
            }
            // Inicializ√°cia ≈°trukt√∫ry monthData, ak neexistuje
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) {
                 monthData[currentYear][currentMonth] = [];
                 console.warn(`saveToLocalStorage: Inicializovan√© pr√°zdne pole pre ${currentYear}-${currentMonth}.`);
            }

            // Ulo≈æenie nastaven√≠
            localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
            localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
            localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
            localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
            localStorage.setItem('employeeName', JSON.stringify(employeeName));
            localStorage.setItem('currentMonth', currentMonth.toString());
            localStorage.setItem('currentYear', currentYear.toString());

            // Ulo≈æenie d√°t o pracovn√Ωch d≈àoch (cel√° ≈°trukt√∫ra)
            const serializedMonthData = JSON.stringify(monthData);
            const bytes = new Blob([serializedMonthData]).size;
            if (bytes > MAX_DATA_SIZE * 0.9) { console.warn(`LocalStorage ('workDaysData') sa bl√≠≈æi k limitu: ${bytes} bajtov`); }
            if (bytes > MAX_DATA_SIZE) {
                 alert(`Prekroƒçili ste limit d√°t (~${MAX_DATA_SIZE_KB} KB) v localStorage. Ukladanie zlyhalo.`);
                 showSaveNotification("Chyba: Lok√°lne d√°ta s√∫ pr√≠li≈° veƒæk√©!", "error"); return;
            }
            localStorage.setItem('workDaysData', serializedMonthData);

            updateDataSize(); // Aktualiz√°cia ukazovateƒæa veƒækosti

            // Spustenie debouncovan√©ho ukladania do Firebase
            if (auth.currentUser) {
                 debouncedSaveToFirebase();
            }

            if (!navigator.onLine) {
                 showSaveNotification("Offline: Zmeny ulo≈æen√© lok√°lne", "warning");
            }
         } catch (error) {
             console.error('Chyba pri ukladan√≠ do localStorage:', error);
             showSaveNotification("Kritick√° chyba pri ukladan√≠!", "error");
         }
    }
    // Debouncovan√° verzia pre ukladanie, aby sa nesp√∫≈°≈•alo pr√≠li≈° ƒçasto
    const debouncedSaveToLocalStorage = debounce(saveToLocalStorage, 500); // 500ms debounce pre lok√°lne ukladanie

    // 10. Funkcia na naƒç√≠tanie z Local Storage
    function loadFromLocalStorage() {
        try {
             // Inicializ√°cia mesiaca/roka, ak nie s√∫ nastaven√©
            if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                const storedMonth = localStorage.getItem('currentMonth'); const storedYear = localStorage.getItem('currentYear');
                const currentDate = new Date();
                currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
                console.log(`loadFromLocalStorage: Inicializujem mesiac=${currentMonth}, rok=${currentYear}`);
            }
            console.log(`loadFromLocalStorage: Naƒç√≠tavam pre ${getMonthName(currentMonth)} ${currentYear}`);

            // Naƒç√≠tanie d√°t o d≈àoch
            const storedMonthData = localStorage.getItem('workDaysData');
            monthData = storedMonthData ? JSON.parse(storedMonthData) : {};
            if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) {
                 console.log(`loadFromLocalStorage: Naƒç√≠tan√Ωch ${monthData[currentYear][currentMonth].length} z√°znamov pre ${currentYear}-${currentMonth}.`);
            } else {
                 console.log(`loadFromLocalStorage: Pre ${currentYear}-${currentMonth} neboli n√°jden√© d√°ta.`);
                 if(!monthData) monthData = {};
                 if(!monthData[currentYear]) monthData[currentYear] = {};
                 monthData[currentYear][currentMonth] = []; // Vytvor√≠me pr√°zdne pole, ak ch√Ωba
            }

            // Naƒç√≠tanie nastaven√≠
            hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
            taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
            const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
            decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
            employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

            updateUIFromLoadedData(darkMode); // Aktualizuje cel√© UI

        } catch (error) {
            console.error(`Kritick√° chyba pri naƒç√≠tavan√≠/spracovan√≠ d√°t z localStorage:`, error);
            showSaveNotification("Chyba pri naƒç√≠tan√≠ lok√°lnych d√°t!", "error");
            monthData = {}; // Reset d√°t v pr√≠pade chyby
            createTable(); calculateTotal(); // Zobraz√≠ pr√°zdnu tabuƒæku
        }
    }


    // 11. Funkcia na aktualiz√°ciu UI z naƒç√≠tan√Ωch d√°t
    function updateUIFromLoadedData(darkModeValue) {
        console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(currentMonth)} ${currentYear}`);
        try {
            // Nastavenie hodn√¥t v nastaveniach
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = taxRate * 100;
            decimalPlacesSelect.value = decimalPlaces;
            employeeNameInput.value = employeeName;
            // Nastavenie selectov pre mesiac a rok
             if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) monthSelect.value = currentMonth; else { console.warn(`Mesiac ${currentMonth} nen√°jden√Ω.`); monthSelect.value = new Date().getMonth(); currentMonth = parseInt(monthSelect.value); }
             if (yearSelect.querySelector(`option[value="${currentYear}"]`)) yearSelect.value = currentYear; else { console.warn(`Rok ${currentYear} nen√°jden√Ω.`); yearSelect.value = new Date().getFullYear(); currentYear = parseInt(yearSelect.value); populateYearSelect(); yearSelect.value = currentYear;}

            // Vytvorenie tabuƒæky a naplnenie d√°tami
            createTable();
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            dataForCurrentMonth.forEach((day, index) => {
                const i = index + 1;
                const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                if (startElement && endElement && breakElement) {
                    startElement.value = day.start || '';
                    endElement.value = day.end || '';
                    breakElement.value = day.breakTime || '';
                    calculateRow(i); // Prepoƒç√≠ta hodnoty pre riadok
                } else { console.error(`Chyba: Elementy pre de≈à ${i} nen√°jden√© po createTable!`); }
            });

            calculateTotal(); // Prepoƒç√≠ta celkov√© s√∫ƒçty
            updateDataSize(); // Aktualizuje ukazovateƒæ veƒækosti d√°t
            applyDarkMode(darkModeValue); // Aplikuje dark mode
            updateWelcomeMessage(); // Aktualizuje pozdrav
            console.log("UI aktualizovan√©.");
        } catch (error) {
            console.error("Chyba poƒças aktualiz√°cie UI:", error);
            showSaveNotification("Chyba pri prekresƒæovan√≠ UI!", "error");
        }
    }

    // 12. Funkcia pre aplikovanie Dark Mode
     function applyDarkMode(isDark) {
        const body = document.body;
        const container = document.querySelector('.container');
        const authContainer = document.getElementById('auth-container'); // Pridan√© pre auth kontajner
        const elementsToToggle = [
            body, container, totalSalaryDiv, authContainer,
            document.querySelector('.collapsible-settings summary'),
            ...document.querySelectorAll('table, th, td'),
            ...document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"], select'),
            ...document.querySelectorAll('.btn'),
            ...document.querySelectorAll('#auth-container input, #auth-container button, #auth-container a'), // Prvky v auth
            document.getElementById('saveNotification') // Notifik√°cia
        ];
        const currentDayRow = document.querySelector('.current-day');
        if (currentDayRow) { elementsToToggle.push(currentDayRow, ...currentDayRow.querySelectorAll('input')); }

        if (isDark) {
            elementsToToggle.forEach(el => el?.classList.add('dark-mode'));
        } else {
            elementsToToggle.forEach(el => el?.classList.remove('dark-mode'));
        }
         // Ulo≈æenie stavu do localStorage (vol√°me len pri prepnut√≠ tlaƒçidlom, nie pri naƒç√≠tan√≠)
         // localStorage.setItem('darkMode', JSON.stringify(isDark));
    }

    // 13) Vytv√°ranie tabuƒæky a pr√°ca s riadkami
    function getDayName(year, month, day) { const daysOfWeek = ["Nedeƒæa", "Pondelok", "Utorok", "Streda", "≈†tvrtok", "Piatok", "Sobota"]; return daysOfWeek[new Date(year, month, day).getDay()]; }
    function createTable() {
        workDays.innerHTML = '';
        const daysInMonth = getDaysInMonth(currentMonth);
        const today = new Date();
        const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth();
        const currentYearValue = today.getFullYear();

        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            const dayDate = new Date(currentYear, currentMonth, i);
            if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
                row.classList.add('current-day'); // Zv√Ωraznenie aktu√°lneho d≈àa
            }
            const dayName = getDayName(currentYear, currentMonth, i);
            // Unik√°tne ID pre ka≈æd√Ω input a bunku s v√Ωsledkom
            row.innerHTML = `
                <td>De≈à ${i} (${dayName})</td>
                <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${currentYear}-${currentMonth}-${i}', ${i})"></td>
                <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${currentYear}-${currentMonth}-${i}', ${i})"></td>
                <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="prest√°vka" oninput="handleBreakInput(${i})"></td>
                <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces || 1)} h)</td>
                <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Hrub√° Mzda" readonly></td>
                <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="ƒåist√° Mzda" readonly></td>
                <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulova≈•</button></td>`;
            workDays.appendChild(row);
        }
        // Aplikujeme dark mode na novo vytvoren√© elementy, ak je akt√≠vny
        applyDarkMode(document.body.classList.contains('dark-mode'));
    }

    // --- Input handling ---
    function isTimeValid(timeStr) { const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeStr); }
    function formatInput(input) {
         if (!input || input.type !== 'tel') return;
         let value = input.value.replace(/[^\d:]/g, '');
         // Automatick√© doplnenie ':'
         if (value.length === 2 && !value.includes(':') && parseInt(value) <= 23) {
              // Ak pou≈æ√≠vateƒæ nap√≠sal len hodiny a pre≈°iel ƒèalej, nedopƒ∫≈àame
              // Dopln√≠me ':' len ak pokraƒçuje v p√≠san√≠
         } else if (value.length === 3 && value.charAt(2) !== ':' && parseInt(value.slice(0, 2)) <= 23 && parseInt(value.charAt(2)) <= 5) {
              value = value.slice(0, 2) + ':' + value.slice(2);
         } else if (value.length === 4 && !value.includes(':')) {
             // Pre pr√≠pad ako 1234 -> 12:34
             value = value.slice(0, 2) + ':' + value.slice(2);
         }

         if (value.length > 5) { value = value.slice(0, 5); }
         input.value = value;
    }
    function moveNext(currentElement, nextId) {
        if (!nextId || !currentElement) return;
        const nextElement = document.getElementById(nextId);
        if (nextElement && document.activeElement === currentElement) { // Presunie fokus len ak je element st√°le akt√≠vny
             console.log(`moveNext: Pres√∫vam fokus z ${currentElement.id} na ${nextId}`);
             nextElement.focus();
             if (nextElement.select) nextElement.select(); // Oznaƒç√≠ text v ƒèal≈°om poli
        }
    }
    function handleInput(input, nextId, day) {
        formatInput(input); // Form√°tuje vstup HH:MM
        updateMonthDataFromInput(input, day); // Aktualizuje d√°ta v pam√§ti
        calculateRow(day); // Prepoƒç√≠ta riadok
        debouncedSaveToLocalStorage(); // Spust√≠ debouncovan√© ukladanie
        // Presun na ƒèal≈°√≠ input po zadan√≠ 5 znakov a validnom ƒçase
        if (input.value.length === 5 && isTimeValid(input.value)) {
             moveNext(input, nextId);
        }
    }
    function handleBreakInput(day) {
        const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        updateMonthDataFromInput(input, day);
        calculateRow(day);
        debouncedSaveToLocalStorage();
        // Po zadan√≠ prest√°vky m√¥≈æeme presun√∫≈• fokus na ƒèal≈°√≠ de≈à (ak existuje)
        const nextDay = day + 1;
        let nextInputElementId = null;
        if (nextDay <= getDaysInMonth(currentMonth)) {
            nextInputElementId = `start-${currentYear}-${currentMonth}-${nextDay}`;
        }
        moveNext(input, nextInputElementId); // Pokus o presun fokusu
    }
    function updateMonthDataFromInput(input, day) {
        if (!input) return;
        const dayIndex = day - 1;
        const fieldId = input.id;
        let field = ''; // Urƒç√≠me pole podƒæa ID
        if (fieldId.startsWith('start-')) field = 'start';
        else if (fieldId.startsWith('end-')) field = 'end';
        else if (fieldId.startsWith('break-')) field = 'breakTime';
        else return; // Nezn√°my input

        const value = input.value;

        // Zabezpeƒç√≠me existenciu ≈°trukt√∫ry
        if (!monthData) monthData = {};
        if (!monthData[currentYear]) monthData[currentYear] = {};
        if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
        // Dopln√≠me dni, ak ch√Ωbaj√∫
        while (monthData[currentYear][currentMonth].length <= dayIndex) {
            monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '' });
        }

        // Aktualizujeme hodnotu
        if (monthData[currentYear][currentMonth][dayIndex]) {
            monthData[currentYear][currentMonth][dayIndex][field] = value;
        } else {
            console.error(`updateMonthData: Chyba - neexistuje z√°znam pre de≈à ${dayIndex}.`);
            monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', [field]: value };
        }
    }

    // --- V√Ωpoƒçty ---
    function calculateRow(day) {
        const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value;
        const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value;
        const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const breakTime = parseFloat(breakTimeInput?.value) || 0;
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

        if (!totalCell || !grossElement || !netElement) return; // Elementy neexistuj√∫

        if (!startTimeStr || !endTimeStr || !isTimeValid(startTimeStr) || !isTimeValid(endTimeStr)) {
            totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
            grossElement.value = '0.00'; netElement.value = '0.00';
            return;
        }

        const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
        const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
        const startTotalMinutes = startHours * 60 + startMinutes;
        let endTotalMinutes = endHours * 60 + endMinutes;
        if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; }
        const diffMinutes = endTotalMinutes - startTotalMinutes;
        const breakMinutes = breakTime * 60;
        const workedMinutes = Math.max(0, diffMinutes - breakMinutes);
        const hours = Math.floor(workedMinutes / 60);
        const minutes = Math.round(workedMinutes % 60);
        const decimalHours = workedMinutes / 60;

        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces || 1)} h)`;

        const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate;
        const grossSalary = decimalHours * currentHourlyWage;
        grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00';
        const netSalary = grossSalary * (1 - currentTaxRate);
        netElement.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00';
    }
    function calculateTotal() {
        let grandTotalWorkedMinutes = 0; let daysWithEntries = 0;
        const rows = workDays.querySelectorAll('tr');
        const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate; const currentDecimalPlaces = decimalPlaces || 1;

        rows.forEach((row, index) => {
            const dayIndex = index + 1;
            const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`)?.value;
            const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`)?.value;
            const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`);

            if (startTimeStr && endTimeStr && isTimeValid(startTimeStr) && isTimeValid(endTimeStr)) {
                const breakTime = parseFloat(breakTimeInput?.value) || 0;
                const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
                const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
                const startTotalMinutes = startHours * 60 + startMinutes;
                let endTotalMinutes = endHours * 60 + endMinutes;
                if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; }
                const diffMinutes = endTotalMinutes - startTotalMinutes;
                const breakMinutes = breakTime * 60;
                const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes);
                grandTotalWorkedMinutes += workedMinutesForRow;
                if (workedMinutesForRow > 0) { daysWithEntries++; }
            }
        });

        const grandTotalDecimalHours = grandTotalWorkedMinutes / 60;
        const grandTotalGrossSalary = grandTotalDecimalHours * currentHourlyWage;
        const grandTotalNetSalary = grandTotalGrossSalary * (1 - currentTaxRate);
        const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0;
        const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
        const averageHours = Math.floor(averageWorkedMinutes / 60);
        const averageMinutes = Math.round(averageWorkedMinutes % 60);
        const averageDecimalHours = averageWorkedMinutes / 60;
        const totalHours = Math.floor(grandTotalWorkedMinutes / 60);
        const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60);

        totalSalaryDiv.innerHTML = `
            Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntries}<br>
            Celkov√Ω odpracovan√Ω ƒças: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(currentDecimalPlaces)} h)<br>
            Celkov√° hrub√° mzda: ${grandTotalGrossSalary.toFixed(2)}‚Ç¨<br>
            Celkov√° ƒçist√° mzda: ${grandTotalNetSalary.toFixed(2)}‚Ç¨<br>
            Priemern√° ƒçist√° mzda na de≈à: ${averageNetSalary.toFixed(2)}‚Ç¨<br>
            <strong>Priemern√Ω odpracovan√Ω ƒças na de≈à: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(currentDecimalPlaces)} h)</strong>`;
    }

    // --- Resetovanie ---
    function resetRow(day) {
        const dayIndex = day - 1;
        const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        if (start && end && breakTime) {
            start.value = ''; end.value = ''; breakTime.value = '';
             // Aktualizujeme d√°ta v pam√§ti
            if (monthData?.[currentYear]?.[currentMonth]?.[dayIndex]) {
                monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '' };
            }
            calculateRow(day); // Prepoƒç√≠ta a vizu√°lne resetne riadok
            calculateTotal(); // Prepoƒç√≠ta celkov√© s√∫ƒçty
            debouncedSaveToLocalStorage(); // Ulo≈æ√≠ zmeny
        }
    }
    function resetAll() {
        if (confirm('Naozaj chcete resetova≈• v≈°etky z√°znamy pre tento mesiac? T√°to akcia je nezvratn√°!')) {
            if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
            monthData[currentYear][currentMonth] = []; // Vyma≈æeme d√°ta len pre aktu√°lny mesiac
            createTable(); // Prekresl√≠ pr√°zdnu tabuƒæku
            calculateTotal(); // Vynuluje s√∫ƒçty
            debouncedSaveToLocalStorage(); // Ulo≈æ√≠ pr√°zdne d√°ta
            showSaveNotification("D√°ta pre aktu√°lny mesiac boli resetovan√©.");
        }
    }

    // 15) Export do PDF (exportToPDF, sendPDF)
    function exportToPDF() {
        console.log("exportToPDF: Spusten√©...");
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Kni≈ænica jsPDF nie je naƒç√≠tan√°."); console.error("jsPDF library/plugin error."); return; }
        const { jsPDF } = window.jspdf;
        try {
            const doc = new jsPDF();
            try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); }
            catch(e) { console.warn("Nepodarilo sa naƒç√≠ta≈• Roboto font pre PDF, pou≈æije sa predvolen√Ω.", e); }

            doc.setFontSize(18); doc.text(`Bruno's Calculator - V√Ωkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
            doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${employeeName || 'Nezadan√©'}`, 14, 28);
            doc.text(`Hodinov√° mzda: ${hourlyWage || 'N/A'} ‚Ç¨`, 14, 34); doc.text(`Da≈à (%): ${(taxRate*100).toFixed(1) || 'N/A'}`, 100, 34);

            const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka(h)", "Odpracovan√©", "Hrub√°(‚Ç¨)", "ƒåist√°(‚Ç¨)"];
            const tableRows = [];
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            dataForCurrentMonth.forEach((day, index) => {
                if (day.start || day.end) {
                    const dayNum = index + 1; const dayName = getDayName(currentYear, currentMonth, dayNum);
                    const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${dayNum}`);
                    const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayNum}`);
                    const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayNum}`);
                    const workedTimeTextMatch = totalCell?.textContent.match(/^(.*)\s+\(/);
                    const workedTimeText = workedTimeTextMatch ? workedTimeTextMatch[1] : 'N/A';
                    const grossValue = grossInput ? parseFloat(grossInput.value).toFixed(2) : '0.00';
                    const netValue = netInput ? parseFloat(netInput.value).toFixed(2) : '0.00';
                    const rowData = [ `D${dayNum}(${dayName.slice(0,2)})`, day.start||'-', day.end||'-', day.breakTime||'0', workedTimeText, grossValue, netValue ];
                    tableRows.push(rowData);
                }
            });

            doc.autoTable({
                head: [tableColumn], body: tableRows, startY: 40,
                headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName, fontSize: 8 },
                styles: { font: doc.getFont().fontName, fontSize: 8, cellPadding: 1.5 },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                columnStyles: { 0: { cellWidth: 35 }, 1: { cellWidth: 18 }, 2: { cellWidth: 18 }, 3: { cellWidth: 20 }, 4: { cellWidth: 35 }, 5: { cellWidth: 22 }, 6: { cellWidth: 22 } }
            });

            const finalY = doc.lastAutoTable.finalY || 40;
            doc.setFontSize(10);
            const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, '');
            doc.text(totalTextContent, 14, finalY + 10);

            const pdfFileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
            doc.save(pdfFileName);
            showSaveNotification("PDF exportovan√©.");
        } catch (error) { console.error("Chyba pri generovan√≠ PDF:", error); alert("Nastala chyba pri vytv√°ran√≠ PDF s√∫boru."); }
    }
    function sendPDF() {
         console.log("sendPDF: Spusten√©...");
         if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Kni≈ænica jsPDF nie je naƒç√≠tan√°."); return; }
         const { jsPDF } = window.jspdf;
         try {
             const doc = new jsPDF();
             try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("sendPDF: Nepodarilo sa naƒç√≠ta≈• Roboto font.", e); }

             doc.setFontSize(16); doc.text(`Pracovn√Ω v√Ωkaz - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
             doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${employeeName || 'Nezadan√©'}`, 14, 28);

             const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)"];
             const tableRows = [];
             const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
             dataForCurrentMonth.forEach((day, index) => {
                 if (day.start || day.end) {
                     const dayNum = index + 1; const dayName = getDayName(currentYear, currentMonth, dayNum);
                     const rowData = [ `D${dayNum}(${dayName.slice(0,2)})`, day.start || '-', day.end || '-', day.breakTime || '0' ];
                     tableRows.push(rowData);
                 }
             });

             doc.autoTable({ head: [tableColumn], body: tableRows, startY: 35,
                 headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName, fontSize: 9 },
                 styles: { font: doc.getFont().fontName, fontSize: 9 },
                 alternateRowStyles: { fillColor: [240, 240, 240] }
             });
             const finalY = doc.lastAutoTable.finalY || 35;

             doc.setFontSize(10);
             const totalSalaryHTML = totalSalaryDiv.innerHTML;
             let daysWithEntriesText = 'N/A'; const matchDays = totalSalaryHTML.match(/Poƒçet odpracovan√Ωch dn√≠: (\d+)/); if (matchDays && matchDays[1]) daysWithEntriesText = matchDays[1];
             let totalTimeText = 'N/A'; const matchTime = totalSalaryHTML.match(/Celkov√Ω odpracovan√Ω ƒças: (.*?)</); if (matchTime && matchTime[1]) totalTimeText = matchTime[1].trim();
             const summaryText = `Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntriesText}\nCelkov√Ω ƒças: ${totalTimeText}`;
             doc.text(summaryText, 14, finalY + 10);

             const pdfBlob = doc.output('blob');
             const pdfFileName = `Vykaz_odoslanie-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
             const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

             if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                 navigator.share({ files: [pdfFile], title: `Pracovn√Ω v√Ωkaz ${getMonthName(currentMonth)} ${currentYear}`, text: `V√Ωkaz pre ${employeeName || 'pracovn√≠ka'} za ${getMonthName(currentMonth)} ${currentYear}.` })
                   .then(() => { showSaveNotification("PDF pripraven√© na zdieƒæanie."); })
                   .catch((error) => { if (error.name !== 'AbortError') { console.error('sendPDF: Chyba pri zdieƒæan√≠:', error); alert('Chyba pri zdieƒæan√≠ s√∫boru.'); } else { console.log('sendPDF: Zdieƒæanie zru≈°en√©.'); } });
             } else {
                 alert("Zdieƒæanie s√∫borov nie je podporovan√©. S√∫bor bude stiahnut√Ω.");
                 const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a');
                 a.style.display = 'none'; a.href = url; a.download = pdfFileName;
                 document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
             }
         } catch (error) { console.error("Chyba pri generovan√≠/odosielan√≠ PDF:", error); alert("Nastala chyba pri vytv√°ran√≠/odosielan√≠ PDF."); }
     }

    // 16) Ostatn√© nastavenia a obsluha zmien
    function changeDecimalPlaces() {
        const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
        if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) {
            decimalPlaces = newDecimalPlaces;
            const rows = workDays.querySelectorAll('tr');
            rows.forEach((row, index) => calculateRow(index + 1));
            calculateTotal();
            debouncedSaveToLocalStorage();
        }
    }
    function updateEmployeeName() {
        employeeName = employeeNameInput.value;
        updateWelcomeMessage();
        debouncedSaveToLocalStorage();
    }
    function updateSettings() { // Pre hodinov√∫ mzdu a da≈à
        const newHourlyWage = parseFloat(hourlyWageInput.value);
        const newTaxRatePercent = parseFloat(taxRateInput.value);
        let changed = false;
        if (!isNaN(newHourlyWage) && newHourlyWage >= 0 && hourlyWage !== newHourlyWage) {
            hourlyWage = newHourlyWage; changed = true;
        }
        if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) {
            const newTaxRateDecimal = newTaxRatePercent / 100;
            if (taxRate !== newTaxRateDecimal) {
                taxRate = newTaxRateDecimal; changed = true;
            }
        }
        if (changed) {
             const rows = workDays.querySelectorAll('tr');
             rows.forEach((row, index) => calculateRow(index + 1));
             calculateTotal();
             debouncedSaveToLocalStorage();
        }
    }
    function changeMonth() { const selectedMonth = parseInt(monthSelect.value); if (currentMonth !== selectedMonth) { currentMonth = selectedMonth; handleMonthYearChange(); } }
    function changeYear() { const selectedYear = parseInt(yearSelect.value); if (currentYear !== selectedYear) { currentYear = selectedYear; handleMonthYearChange(); } }
    function handleMonthYearChange() {
        console.log(`handleMonthYearChange: Spusten√© pre ${getMonthName(currentMonth)} ${currentYear}`);
        localStorage.setItem('currentMonth', currentMonth.toString());
        localStorage.setItem('currentYear', currentYear.toString());
        loadFromLocalStorage();
        if (auth.currentUser) { setupFirestoreListener(); }
    }

    // --- Pomocn√© funkcie ---
    function getDaysInMonth(month) { if (month === undefined || month === null || currentYear === undefined || currentYear === null) { return 31; } return new Date(currentYear, month + 1, 0).getDate(); }
    function getMonthName(month) { const monthNames = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"]; return monthNames[month] || 'Nezn√°my'; }
    function updateDataSize() { try { const totalData = Object.values(localStorage).reduce((acc, value) => acc + (value ? value.length : 0), 0); const kilobytes = (totalData / 1024).toFixed(2); const percentageUsed = Math.min(((totalData / MAX_DATA_SIZE) * 100), 100); dataSizeText.textContent = `Lok√°lne √∫lo≈æisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`; dataSizeFill.style.width = `${percentageUsed}%`; if (percentageUsed > 90) dataSizeFill.style.backgroundColor = '#f44336'; else if (percentageUsed > 70) dataSizeFill.style.backgroundColor = '#ff9800'; else dataSizeFill.style.backgroundColor = '#4CAF50'; } catch (error) { console.error("Chyba pri v√Ωpoƒçte veƒækosti localStorage:", error); dataSizeText.textContent = "Chyba veƒækosti d√°t."; } }
    function toggleDarkMode() {
        const isDarkMode = document.body.classList.toggle('dark-mode');
        applyDarkMode(isDarkMode); // Aplikuje ≈°t√Ωly
        localStorage.setItem('darkMode', JSON.stringify(isDarkMode)); // Ulo≈æ√≠ preferenciu
        if (auth.currentUser) { debouncedSaveToFirebase(); } // Ulo≈æ√≠ cel√Ω stav vr√°tane dark mode do Firebase
    }

    // 17) Z√°lohovanie a obnova
    function createBackup() {
         try {
             const backupData = { workDaysData: localStorage.getItem('workDaysData') || '{}', hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(10), taxRate: localStorage.getItem('taxRate') || JSON.stringify(2), darkMode: localStorage.getItem('darkMode') || JSON.stringify(false), decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(1), employeeName: localStorage.getItem('employeeName') || JSON.stringify(''), backupVersion: 2, backupTimestamp: new Date().toISOString() };
             const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
             const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `bruno-calculator-backup-${new Date().toISOString().slice(0,10)}.json`;
             document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
             showSaveNotification("Z√°loha √∫spe≈°ne vytvoren√°.");
         } catch (error) { console.error("Chyba pri vytv√°ran√≠ z√°lohy:", error); alert("Nastala chyba pri vytv√°ran√≠ z√°lo≈æn√©ho s√∫boru."); }
    }
    function restoreBackup() {
         const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.json,application/json';
         fileInput.onchange = (event) => {
             const file = event.target.files[0]; if (!file) return;
             const reader = new FileReader();
             reader.onload = (e) => {
                 try {
                     const backup = JSON.parse(e.target.result);
                     if (backup && typeof backup.workDaysData === 'string' && typeof backup.hourlyWage === 'string' && typeof backup.taxRate === 'string' && typeof backup.darkMode === 'string' && typeof backup.decimalPlaces === 'string' && typeof backup.employeeName === 'string') {
                         localStorage.setItem('workDaysData', backup.workDaysData); localStorage.setItem('hourlyWage', backup.hourlyWage); localStorage.setItem('taxRate', backup.taxRate); localStorage.setItem('darkMode', backup.darkMode); localStorage.setItem('decimalPlaces', backup.decimalPlaces); localStorage.setItem('employeeName', backup.employeeName);
                         loadFromLocalStorage(); // Naƒç√≠ta obnoven√© d√°ta a aktualizuje UI
                         showSaveNotification("Z√°loha √∫spe≈°ne obnoven√°."); alert("Z√°loha bola √∫spe≈°ne obnoven√°.");
                         if (auth.currentUser) { console.log("Obnova z√°lohy: Uklad√°m obnoven√© d√°ta do Firebase..."); saveToLocalStorage(); } // Ulo≈æ√≠ obnoven√Ω stav
                     } else { alert("Chyba: S√∫bor z√°lohy m√° nespr√°vny form√°t."); }
                 } catch (error) { console.error("Chyba pri spracovan√≠ z√°lohy:", error); alert("Chyba pri ƒç√≠tan√≠/obnove z√°lohy."); }
             };
             reader.onerror = (e) => { console.error("Chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy:", e); alert("Nastala chyba pri ƒç√≠tan√≠ s√∫boru."); };
             reader.readAsText(file);
         };
         fileInput.click();
    }

    // 18) Inicializ√°cia pri naƒç√≠tan√≠ str√°nky
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM naƒç√≠tan√Ω, inicializujem...");
        populateYearSelect();
        const initialDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        applyDarkMode(initialDarkMode);
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(registration => { console.log('ServiceWorker zaregistrovan√Ω:', registration.scope); }).catch(error => { console.error('Registr√°cia ServiceWorker zlyhala:', error); }); }); } else { console.warn("Service Worker nie je podporovan√Ω."); }
        console.log("Z√°kladn√° inicializ√°cia dokonƒçen√°, ƒçak√°m na stav prihl√°senia...");
    });

    function populateYearSelect() {
        const startYear = 2020; const endYear = new Date().getFullYear() + 2;
        yearSelect.innerHTML = ''; // Vyƒçist√≠me
        for (let year = startYear; year <= endYear; year++) {
            const option = document.createElement('option'); option.value = year; option.textContent = year;
            yearSelect.appendChild(option);
        }
        // Prednastav√≠me rok, ak nie je naƒç√≠tan√Ω z localStorage
        if (!yearSelect.value) { yearSelect.value = new Date().getFullYear(); }
    }

  </script>
</body>
</html>
