<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Kalkulačka na výpočet mzdy s Firebase autentifikáciou">
  <meta name="theme-color" content="#4CAF50">
  <link rel="manifest" href="/fire/manifest.json">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <title>Bruno's Calculator s Firebase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
      min-width: 320px;
    }
    .auth-container, .calculator-container {
      display: none;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    input[type="text"], input[type="number"], select {
      padding: 5px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      padding: 10px 20px;
      margin: 5px 0;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    button:hover {
      background-color: #45a049;
    }
    #data-size {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 12px;
    }
    /* Tmavý režim */
    body.dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    .container.dark-mode {
      background-color: #444;
    }
    table.dark-mode th, table.dark-mode td {
      background-color: #555;
      color: #f4f4f4;
    }
    input[type="text"].dark-mode, input[type="number"].dark-mode {
      background-color: #666;
      color: white;
    }
    button.dark-mode {
      background-color: #388e3c;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="auth-container" class="auth-container">
      <h1 style="text-align: center; font-size: 2em; background: linear-gradient(to right, #4CAF50, #ffeb3b); -webkit-background-clip: text; color: transparent;">Prihlásenie / Registrácia</h1>
      <p id="auth-message">Žiadny používateľ nie je prihlásený.</p>
      <h3>Registrácia</h3>
      <input type="email" id="reg-email" placeholder="Email"><br>
      <input type="password" id="reg-password" placeholder="Heslo"><br>
      <button onclick="register()">Registrovať</button>
      <h3>Prihlásenie</h3>
      <input type="email" id="login-email" placeholder="Email"><br>
      <input type="password" id="login-password" placeholder="Heslo"><br>
      <button onclick="login()">Prihlásiť sa</button>
      <button onclick="logout()">Odhlásiť sa</button>
    </div>
    <div id="calculator-container" class="calculator-container">
      <h1 style="text-align: center; font-size: 2em; background: linear-gradient(to right, #4CAF50, #ffeb3b); -webkit-background-clip: text; color: transparent;">Bruno's Calculator</h1>
      <p>Vytvoril a financoval Bruno</p>
      <div>
        <label>Meno pracovníka:</label>
        <input type="text" id="employee-name" value=""><br>
        <label>Hodinová mzda (€):</label>
        <input type="number" id="hourly-wage" value="10" step="0.01"><br>
        <label>Daňové percento (%):</label>
        <input type="number" id="tax-rate" value="2" step="0.01"><br>
        <label>Mesiac:</label>
        <select id="month-select"></select><br>
        <label>Rok:</label>
        <select id="year-select"></select><br>
        <label>Počet desatinných miest:</label>
        <select id="decimal-places-select">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
        </select><br>
        <button onclick="toggleDarkMode()">Prepínať tmavý režim</button>
        <button onclick="saveToFirebase()">Uložiť do Firebase</button>
      </div>
      <div class="table-container">
        <table id="work-days-table">
          <thead>
            <tr>
              <th>Deň</th>
              <th>Príchod</th>
              <th>Odchod</th>
              <th>Prestávka</th>
              <th>Odpracované (h)</th>
              <th>Hrubá Mzda (€)</th>
              <th>Čistá Mzda</th>
            </tr>
          </thead>
          <tbody id="work-days-body"></tbody>
        </table>
      </div>
      <div id="total-salary"></div>
      <div id="data-size"></div>
    </div>
  </div>

  <!-- Firebase a ďalšie knižnice -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Firebase konfigurácia – NAHRAĎ TÝMITO HODNOTAMI SVOJE SKUTOČNÉ HODNOTY Z FIREBASE CONSOLE
    const firebaseConfig = {
      apiKey: "tvoj-api-key",
      authDomain: "tvoj-auth-domain",
      projectId: "tvoj-project-id",
      storageBucket: "tvoj-storage-bucket",
      messagingSenderId: "tvoj-sender-id",
      appId: "tvoj-app-id"
    };

    // Inicializácia Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Povolenie offline podpory
    db.enablePersistence()
      .then(() => console.log("Offline persistence enabled for Firestore"))
      .catch((err) => console.error("Error enabling Firestore persistence:", err));
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(() => console.log("Offline persistence enabled for Auth"))
      .catch((err) => console.error("Error enabling Auth persistence:", err));

    let currentMonth = 0;
    let currentYear = 0;
    let decimalPlaces = 1;
    let employeeName = '';
    let hourlyWage = 10;
    let taxRate = 0.02;
    let monthData = {};
    let isDarkMode = false;

    // Obnova stavu pri načítaní
    document.addEventListener('DOMContentLoaded', () => {
      const currentDate = new Date();
      currentMonth = currentDate.getMonth();
      currentYear = currentDate.getFullYear();

      // Načítanie z localStorage
      decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
      employeeName = localStorage.getItem('employeeName') || '';
      hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
      taxRate = parseFloat(localStorage.getItem('taxRate')) / 100 || 0.02;
      monthData = JSON.parse(localStorage.getItem('workDaysData')) || {};
      isDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
      if (isDarkMode) toggleDarkMode();

      populateYearSelect();
      const monthSelect = document.getElementById('month-select');
      const yearSelect = document.getElementById('year-select');
      const decimalPlacesSelect = document.getElementById('decimal-places-select');
      monthSelect.value = currentMonth;
      yearSelect.value = currentYear;
      decimalPlacesSelect.value = decimalPlaces;
      document.getElementById('employee-name').value = employeeName;
      document.getElementById('hourly-wage').value = hourlyWage;
      document.getElementById('tax-rate').value = taxRate * 100;

      // Obnova stavu prihlásenia
      const savedAuthState = JSON.parse(localStorage.getItem('authState')) || { isLoggedIn: false };
      if (savedAuthState.isLoggedIn && !navigator.onLine) {
        handleAuthState(true); // Offline simulácia prihlásenia
        loadFromLocalStorage();
      }

      // Monitorovanie stavu prihlásenia a siete
      auth.onAuthStateChanged((user) => {
        if (user || (savedAuthState.isLoggedIn && !navigator.onLine)) {
          if (user) {
            localStorage.setItem('authState', JSON.stringify({
              uid: user.uid,
              email: user.email,
              isLoggedIn: true
            }));
          }
          handleAuthState(true);
          loadFromLocalOrFirebase();
        } else {
          localStorage.setItem('authState', JSON.stringify({ isLoggedIn: false }));
          handleAuthState(false);
        }
      });

      window.addEventListener('online', () => {
        if (savedAuthState.isLoggedIn) {
          loadFromLocalOrFirebase();
        }
      });
      window.addEventListener('offline', () => {
        if (savedAuthState.isLoggedIn) {
          handleAuthState(true);
          loadFromLocalStorage();
        }
      });

      createTable();
      calculateTotal();
      updateDataSize();
    });

    function populateYearSelect() {
      const yearSelect = document.getElementById('year-select');
      const currentYear = new Date().getFullYear();
      for (let i = currentYear - 5; i <= currentYear + 5; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        yearSelect.appendChild(option);
      }
      const monthSelect = document.getElementById('month-select');
      const months = ['Január', 'Február', 'Marec', 'Apríl', 'Máj', 'Jún', 'Júl', 'August', 'September', 'Október', 'November', 'December'];
      months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = month;
        monthSelect.appendChild(option);
      });
    }

    function createTable() {
      const tbody = document.getElementById('work-days-body');
      tbody.innerHTML = '';
      const month = parseInt(document.getElementById('month-select').value);
      const year = parseInt(document.getElementById('year-select').value);
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      decimalPlaces = parseInt(document.getElementById('decimal-places-select').value);
      employeeName = document.getElementById('employee-name').value;
      hourlyWage = parseFloat(document.getElementById('hourly-wage').value);
      taxRate = parseFloat(document.getElementById('tax-rate').value) / 100;

      localStorage.setItem('decimalPlaces', decimalPlaces);
      localStorage.setItem('employeeName', employeeName);
      localStorage.setItem('hourlyWage', hourlyWage);
      localStorage.setItem('taxRate', taxRate * 100);
      localStorage.setItem('darkMode', isDarkMode);

      for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(year, month, i);
        const dayName = date.toLocaleDateString('sk-SK', { weekday: 'long' });
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${dayName} (${i})</td>
          <td><input type="text" class="arrival-${i}" value="${monthData[`arrival-${i}`] || ''}" placeholder="HH:MM" oninput="updateRow(${i})"></td>
          <td><input type="text" class="departure-${i}" value="${monthData[`departure-${i}`] || ''}" placeholder="HH:MM" oninput="updateRow(${i})"></td>
          <td><input type="text" class="break-${i}" value="${monthData[`break-${i}`] || ''}" placeholder="prestávka" oninput="updateRow(${i})"></td>
          <td><input type="number" class="worked-${i}" value="${monthData[`worked-${i}`] || 0}" step="0.01" readonly></td>
          <td><input type="number" class="gross-${i}" value="${monthData[`gross-${i}`] || 0}" step="0.01" readonly></td>
          <td><input type="number" class="net-${i}" value="${monthData[`net-${i}`] || 0}" step="0.01" readonly></td>
        `;
        tbody.appendChild(row);
        updateRow(i);
      }
      calculateTotal();
      saveToLocalStorage();
    }

    function updateRow(day) {
      const arrival = document.querySelector(`.arrival-${day}`).value;
      const departure = document.querySelector(`.departure-${day}`).value;
      const breakTime = document.querySelector(`.break-${day}`).value || '0';
      const workedInput = document.querySelector(`.worked-${day}`);
      const grossInput = document.querySelector(`.gross-${day}`);
      const netInput = document.querySelector(`.net-${day}`);

      if (arrival && departure) {
        const [arrH, arrM] = arrival.split(':').map(Number);
        const [depH, depM] = departure.split(':').map(Number);
        const breakM = parseInt(breakTime) || 0;
        const totalMinutes = (depH * 60 + depM) - (arrH * 60 + arrM) - breakM;
        const workedHours = totalMinutes / 60;
        workedInput.value = workedHours.toFixed(decimalPlaces);
        const grossPay = workedHours * hourlyWage;
        grossInput.value = grossPay.toFixed(decimalPlaces);
        const netPay = grossPay * (1 - taxRate);
        netInput.value = netPay.toFixed(decimalPlaces);

        monthData[`arrival-${day}`] = arrival;
        monthData[`departure-${day}`] = departure;
        monthData[`break-${day}`] = breakTime;
        monthData[`worked-${day}`] = workedHours.toFixed(decimalPlaces);
        monthData[`gross-${day}`] = grossPay.toFixed(decimalPlaces);
        monthData[`net-${day}`] = netPay.toFixed(decimalPlaces);
      } else {
        workedInput.value = '0';
        grossInput.value = '0';
        netInput.value = '0';
      }
      calculateTotal();
      saveToLocalStorage();
    }

    function calculateTotal() {
      const decimalPlaces = parseInt(document.getElementById('decimal-places-select').value);
      let totalWorked = 0;
      let totalGross = 0;
      let totalNet = 0;
      const daysInMonth = new Date(parseInt(document.getElementById('year-select').value), parseInt(document.getElementById('month-select').value) + 1, 0).getDate();
      for (let i = 1; i <= daysInMonth; i++) {
        const worked = parseFloat(document.querySelector(`.worked-${i}`).value) || 0;
        const gross = parseFloat(document.querySelector(`.gross-${i}`).value) || 0;
        const net = parseFloat(document.querySelector(`.net-${i}`).value) || 0;
        totalWorked += worked;
        totalGross += gross;
        totalNet += net;
      }
      document.getElementById('total-salary').innerHTML = `
        Celkový odpracovaný čas: ${totalWorked.toFixed(decimalPlaces)} h<br>
        Celková hrubá mzda: ${totalGross.toFixed(decimalPlaces)} €<br>
        Celková čistá mzda: ${totalNet.toFixed(decimalPlaces)} €
      `;
      saveToLocalStorage();
    }

    function updateDataSize() {
      const dataSize = JSON.stringify(monthData).length;
      document.getElementById('data-size').textContent = `Veľkosť dát: ${dataSize} bajtov`;
    }

    function saveToLocalStorage() {
      localStorage.setItem('workDaysData', JSON.stringify(monthData));
      localStorage.setItem('employeeName', employeeName);
      localStorage.setItem('hourlyWage', hourlyWage);
      localStorage.setItem('taxRate', taxRate * 100);
      localStorage.setItem('decimalPlaces', decimalPlaces);
      localStorage.setItem('darkMode', isDarkMode);
      updateDataSize();
    }

    function loadFromLocalStorage() {
      employeeName = localStorage.getItem('employeeName') || '';
      hourlyWage = parseFloat(localStorage.getItem('hourlyWage')) || 10;
      taxRate = parseFloat(localStorage.getItem('taxRate')) / 100 || 0.02;
      monthData = JSON.parse(localStorage.getItem('workDaysData')) || {};
      decimalPlaces = parseInt(localStorage.getItem('decimalPlaces')) || 1;
      isDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
      document.getElementById('employee-name').value = employeeName;
      document.getElementById('hourly-wage').value = hourlyWage;
      document.getElementById('tax-rate').value = taxRate * 100;
      document.getElementById('decimal-places-select').value = decimalPlaces;
      if (isDarkMode) toggleDarkMode();
      createTable();
    }

    function loadFromLocalOrFirebase() {
      const user = auth.currentUser || (JSON.parse(localStorage.getItem('authState')) && { uid: JSON.parse(localStorage.getItem('authState')).uid });
      if (user) {
        const uid = user.uid;
        db.collection("users").doc(uid).collection("calculatorData").doc(`${currentYear}-${currentMonth}`).get()
          .then((doc) => {
            if (doc.exists) {
              const data = doc.data();
              monthData = data.workDaysData || {};
              employeeName = data.employeeName || '';
              hourlyWage = data.hourlyWage || 10;
              taxRate = data.taxRate || 0.02;
              document.getElementById('employee-name').value = employeeName;
              document.getElementById('hourly-wage').value = hourlyWage;
              document.getElementById('tax-rate').value = taxRate * 100;
              localStorage.setItem('workDaysData', JSON.stringify(monthData));
              localStorage.setItem('employeeName', employeeName);
              localStorage.setItem('hourlyWage', hourlyWage);
              localStorage.setItem('taxRate', taxRate * 100);
              createTable();
            } else {
              loadFromLocalStorage();
            }
          })
          .catch((error) => {
            console.warn("Offline or error fetching from Firebase, using local storage:", error);
            loadFromLocalStorage();
          });
      }
    }

    function saveToFirebase() {
      const user = auth.currentUser || (JSON.parse(localStorage.getItem('authState')) && { uid: JSON.parse(localStorage.getItem('authState')).uid });
      if (user) {
        const uid = user.uid;
        db.collection("users").doc(uid).collection("calculatorData").doc(`${currentYear}-${currentMonth}`).set({
          workDaysData: monthData,
          employeeName: employeeName,
          hourlyWage: hourlyWage,
          taxRate: taxRate,
          timestamp: new Date().toISOString()
        })
          .then(() => {
            console.log("Data saved to Firebase");
            saveToLocalStorage();
          })
          .catch((error) => {
            console.error("Error saving to Firebase, data saved locally:", error);
            saveToLocalStorage();
          });
      }
    }

    function handleAuthState(isLoggedIn) {
      const authContainer = document.getElementById('auth-container');
      const calculatorContainer = document.getElementById('calculator-container');
      const authMessage = document.getElementById('auth-message');
      if (isLoggedIn) {
        authMessage.textContent = `Prihlásený: ${JSON.parse(localStorage.getItem('authState')).email || 'Neznámy'}`;
        authContainer.style.display = 'none';
        calculatorContainer.style.display = 'block';
      } else {
        authMessage.textContent = "Žiadny používateľ nie je prihlásený.";
        authContainer.style.display = 'block';
        calculatorContainer.style.display = 'none';
      }
    }

    function register() {
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          localStorage.setItem('authState', JSON.stringify({
            uid: user.uid,
            email: user.email,
            isLoggedIn: true
          }));
          db.collection("users").doc(user.uid).set({
            email: email,
            createdAt: new Date().toISOString()
          });
        })
        .catch((error) => console.error("Error registering:", error.message));
    }

    function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          localStorage.setItem('authState', JSON.stringify({
            uid: user.uid,
            email: user.email,
            isLoggedIn: true
          }));
        })
        .catch((error) => console.error("Error logging in:", error.message));
    }

    function logout() {
      auth.signOut()
        .then(() => {
          localStorage.setItem('authState', JSON.stringify({ isLoggedIn: false }));
          handleAuthState(false);
        })
        .catch((error) => console.error("Error logging out:", error.message));
    }

    // Event listenery
    document.getElementById('month-select').addEventListener('change', createTable);
    document.getElementById('year-select').addEventListener('change', createTable);
    document.getElementById('decimal-places-select').addEventListener('change', () => {
      decimalPlaces = parseInt(document.getElementById('decimal-places-select').value);
      localStorage.setItem('decimalPlaces', decimalPlaces);
      createTable();
    });
    document.getElementById('employee-name').addEventListener('input', (e) => {
      employeeName = e.target.value;
      saveToLocalStorage();
    });
    document.getElementById('hourly-wage').addEventListener('input', (e) => {
      hourlyWage = parseFloat(e.target.value);
      saveToLocalStorage();
      createTable();
    });
    document.getElementById('tax-rate').addEventListener('input', (e) => {
      taxRate = parseFloat(e.target.value) / 100;
      saveToLocalStorage();
      createTable();
    });

    function toggleDarkMode() {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('dark-mode');
      document.querySelector('.container').classList.toggle('dark-mode');
      document.querySelectorAll('table th, table td, input[type="text"], input[type="number"]').forEach(el => el.classList.toggle('dark-mode'));
      document.querySelectorAll('button').forEach(el => el.classList.toggle('dark-mode'));
      saveToLocalStorage();
    }

    // Registrácia Service Worker-a
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/fire/service-worker.js')
        .then((registration) => console.log('Service Worker registered with scope:', registration.scope))
        .catch((error) => console.error('Service Worker registration failed:', error));
    }
  </script>
</body>
</html>
