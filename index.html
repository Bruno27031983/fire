<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- Z√°kladn√© ≈°t√Ωly --- */
    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
      transition: background-color 0.3s, color 0.3s; /* Plynul√Ω prechod pre dark mode */
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative; /* Pre autor-info */
      transition: background-color 0.3s, color 0.3s; /* Plynul√Ω prechod pre dark mode */
    }
    .autor-info {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 14px;
      font-style: italic;
      color: #666;
      transition: color 0.3s;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
      transition: color 0.3s;
    }

    /* --- Nastavenia (Settings) --- */
    .settings {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 15px; /* Zv√§ƒç≈°en√Ω gap pre lep≈°ie rozlo≈æenie */
    }
    .settings > div,
    .settings > details,
    .settings > button {
        flex: 1 1 220px; /* Mierne zv√§ƒç≈°en√Ω flex-basis */
        margin: 0;
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold; /* Zv√Ωraznenie labelov */
    }

    /* --- Tabuƒæka --- */
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 1000px; /* Mierne zv√§ƒç≈°en√° min-width */
      transition: background-color 0.3s, color 0.3s;
    }
    th, td {
        padding: 10px; /* Zv√§ƒç≈°en√Ω padding */
        border: 1px solid #ddd;
        text-align: left;
        font-size: 0.9em;
        vertical-align: middle; /* Zmenen√© na middle pre lep≈°ie centrovanie */
        position: relative;
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    th {
      background-color: #e9e9e9; /* Svetlej≈°ie pozadie hlaviƒçky */
      font-weight: bold; /* Zv√Ωraznenie hlaviƒçky */
    }
    tr:nth-child(even) td {
        background-color: #f9f9f9; /* Jemn√© pruhovanie riadkov */
    }
    tr:hover td {
        background-color: #f1f1f1; /* Zv√Ωraznenie riadku pri prejden√≠ my≈°ou */
    }

    /* --- Inputy a Selecty --- */
    input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea {
        width: 100%;
        padding: 8px; /* Zv√§ƒç≈°en√Ω padding */
        box-sizing: border-box;
        background-color: #ffffea; /* Jemne ≈ælt√© pozadie */
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px; /* Mierne zaoblenie */
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    input[type="tel"] {
        padding-right: 35px; /* Viac miesta pre ikonu */
    }
    input[readonly] {
        background-color: #eee; /* Odli≈°n√© pozadie pre readonly */
        cursor: not-allowed;
    }

    /* --- Ikony --- */
    .time-icon {
        position: absolute;
        right: 10px; /* Upraven√© odsadenie */
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 1.3em; /* Mierne v√§ƒç≈°ia ikona */
        color: #555;
        user-select: none;
        z-index: 2;
        transition: color 0.2s, opacity 0.2s;
    }
    .time-icon:hover {
        color: #007bff;
        opacity: 0.8;
    }
    .note-indicator-icon {
        display: none;
        font-size: 1em; /* V√§ƒç≈°√≠ indik√°tor */
        margin-right: 5px;
        color: #28a745;
        vertical-align: middle;
        cursor: default;
        transition: color 0.3s;
    }

    /* --- ≈†√≠rky stƒ∫pcov --- */
    th:nth-child(1), td:nth-child(1) { min-width: 130px; } /* De≈à (≈°ir≈°√≠) */
    th:nth-child(2), td:nth-child(2) { min-width: 110px; } /* Pr√≠chod */
    th:nth-child(3), td:nth-child(3) { min-width: 110px; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { min-width: 100px; } /* Prest√°vka */
    th:nth-child(5), td:nth-child(5) { min-width: 140px; } /* Odpracovan√© */
    th:nth-child(6), td:nth-child(6) { min-width: 110px; } /* Hrub√° Mzda */
    th:nth-child(7), td:nth-child(7) { min-width: 110px; } /* ƒåist√° Mzda */
    th:nth-child(8), td:nth-child(8) { min-width: 150px; } /* Pozn√°mka */
    th:last-child, td:last-child { min-width: 100px; text-align: center; } /* Akcia */

    /* --- Tlaƒçidl√° --- */
    .btn-container {
      display: flex;
      flex-wrap: wrap; /* Umo≈æn√≠ zalomenie na men≈°√≠ch obrazovk√°ch */
      gap: 10px; /* Medzery medzi tlaƒçidlami */
      margin-top: 20px;
      justify-content: center; /* Centrovanie tlaƒçidiel */
    }
    .btn {
      flex: 1 1 180px; /* Flexibiln√© tlaƒçidl√° */
      padding: 12px 15px; /* Upraven√Ω padding */
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease, transform 0.1s ease;
      text-align: center;
      box-sizing: border-box;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Jemn√Ω tie≈à */
    }
    .btn:hover {
        opacity: 0.9;
        transform: translateY(-1px); /* Mal√Ω posun pri hover */
    }
    .btn:active {
        transform: translateY(0px); /* Reset posunu pri kliknut√≠ */
    }
    .reset-btn { background-color: #dc3545; } .reset-btn:hover { background-color: #c82333; }
    .export-btn { background-color: #28a745; } .export-btn:hover { background-color: #218838; }
    .restore-btn { background-color: #6f42c1; } .restore-btn:hover { background-color: #5a32a3; }
    .backup-btn { background-color: #ffc107; color: #333; } .backup-btn:hover { background-color: #e0a800; }
    #logout-btn { background-color: #6c757d; } #logout-btn:hover { background-color: #5a6268; }
    .highlight { background-color: #007bff; } .highlight:hover { background-color: #0056b3; } /* Zmena farby pre dark mode toggle */

    /* --- Celkov√° mzda a veƒækos≈• d√°t --- */
    #totalSalary {
      font-size: 1.1em; /* Mierne v√§ƒç≈°ie p√≠smo */
      font-weight: bold;
      text-align: center;
      margin-top: 25px;
      padding: 15px;
      background-color: #e6f3ff;
      border-radius: 5px;
      border: 1px solid #b8d6f3; /* Jemn√Ω okraj */
      transition: background-color 0.3s, border-color 0.3s;
    }
    #dataSizeContainer {
      margin-top: 15px;
      text-align: center;
    }
    #dataSizeText {
      margin-bottom: 5px;
      font-size: 14px;
      color: #555;
      transition: color 0.3s;
    }
    #dataSizeBar {
      width: 80%;
      max-width: 400px; /* Maxim√°lna ≈°√≠rka progress baru */
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
      transition: background-color 0.3s;
    }
    #dataSizeFill {
      height: 100%;
      width: 0%;
      background-color: #28a745; /* Zelen√° farba */
      transition: width 0.5s ease, background-color 0.3s ease;
      border-radius: 10px 0 0 10px; /* Zaoblenie len na zaƒçiatku */
    }
    #dataSizeFill[style*="width: 100%"] {
        border-radius: 10px; /* Zaoblenie aj na konci, ak je pln√Ω */
    }

    /* --- Aktu√°lny de≈à --- */
    .current-day td { /* Aplikujeme na bunky, nie cel√Ω riadok pre lep≈°iu ƒçitateƒænos≈• */
        background-color: #e8dff5 !important; /* Svetlo fialov√°, !important pre prioritu nad pruhovan√≠m */
    }
    .current-day input, .current-day .note-textarea, .current-day select {
        background-color: #f3eafd; /* E≈°te svetlej≈°ia fialov√° pre inputy */
        font-weight: bold; /* Zv√Ωraznenie textu v aktu√°lnom dni */
    }

    /* --- Anim√°cie --- */
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 8px rgba(255, 255, 255, 0.4), 0 0 15px rgba(255, 255, 255, 0.2), 0 0 25px rgba(255, 255, 255, 0.1); } 50% { text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 0 25px rgba(255, 255, 255, 0.7), 0 0 35px rgba(255, 255, 255, 0.5); } }

    /* --- Dark Mode --- */
    body.dark-mode { background-color: #212529; color: #dee2e6; }
    .container.dark-mode { background-color: #343a40; color: #dee2e6; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    table.dark-mode { background-color: #495057; color: #dee2e6; }
    th.dark-mode { background-color: #5a6268; border-color: #6c757d; }
    td.dark-mode { border-color: #495057; }
    tr:nth-child(even) td.dark-mode { background-color: #40464b; }
    tr:hover td.dark-mode { background-color: #4e555b; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode { background-color: #495057; color: #dee2e6; border-color: #6c757d; }
    input[readonly].dark-mode { background-color: #5a6268; }
    .btn.dark-mode { /* Tlaƒçidl√° si ponechaj√∫ svoje farby, len text m√¥≈æe by≈• tmav≈°√≠ ak treba */ }
    .backup-btn.dark-mode { color: #fff; } /* Svetlej≈°√≠ text pre ≈ælt√© tlaƒçidlo */
    #totalSalary.dark-mode { background-color: #495057; border-color: #6c757d; }
    .current-day td.dark-mode { background-color: #4a3b5f !important; }
    .current-day.dark-mode input, .current-day.dark-mode .note-textarea, .current-day.dark-mode select { background-color: #5c4a75; color: #fff; }
    body.dark-mode .autor-info { color: #adb5bd; }
    body.dark-mode .time-icon { color: #adb5bd; }
    body.dark-mode .time-icon:hover { color: #87cefa; }
    body.dark-mode .note-indicator-icon { color: #6fbf7a; }
    #dataSizeBar.dark-mode { background-color: #6c757d; }
    #dataSizeText.dark-mode { color: #adb5bd; }

    /* --- Autentifik√°cia --- */
    #auth-container { max-width: 400px; margin: 30px auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; transition: background-color 0.3s; }
    #auth-container h1, #auth-container h2 { color: #333; }
    #auth-container input { width: calc(100% - 22px); padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; }
    #auth-container button { width: 100%; padding: 12px; margin: 12px 0; border: none; background-color: #28a745; color: #fff; font-size: 16px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
    #auth-container button:hover { background-color: #218838; }
    #auth-message { margin-bottom: 15px; font-weight: bold; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }
    /* Dark mode pre auth */
    #auth-container.dark-mode { background-color: #343a40; }
    #auth-container.dark-mode h1, #auth-container.dark-mode h2, #auth-container.dark-mode #auth-message { color: #dee2e6; }
    #auth-container.dark-mode input { background-color: #495057; color: #dee2e6; border-color: #6c757d; }
    #auth-container.dark-mode button { background-color: #388e3c; } #auth-container.dark-mode button:hover { background-color: #2e7d32; }
    #auth-container.dark-mode #forgot-password-link { color: #64b5f6; }

    /* --- Notifik√°cie a Loading --- */
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #28a745; color: white; padding: 12px 25px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease, transform 0.3s ease; opacity: 0; transform: translateY(20px); }
    #saveNotification.show { display: block; opacity: 1; transform: translateY(0); }
    #saveNotification.error { background-color: #dc3545; }
    #saveNotification.warning { background-color: #ffc107; color: #333; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-container h1 { font-size: 1.5em; background: none; color: #555; animation: none; text-shadow: none; } /* Jednoduch≈°√≠ text pre loading */
    #loading-container.hidden { opacity: 0; pointer-events: none; }
    /* Dark mode pre loading */
    #loading-container.dark-mode { background-color: rgba(33, 37, 41, 0.9); }
    #loading-container.dark-mode h1 { color: #dee2e6; }

    /* --- Zbaliteƒæn√© nastavenia --- */
    .collapsible-settings summary { cursor: pointer; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease, border-color 0.3s; font-weight: bold; list-style: revert; /* Zobraz√≠ ≈°√≠pku */ }
    .collapsible-settings summary:hover { background-color: #e9ecef; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 15px; padding: 15px 10px 10px 10px; border: 1px solid #dee2e6; border-top: none; /* Okraj len okolo obsahu */ border-radius: 0 0 4px 4px; /* Zaoblenie len dole */ margin-top: -6px; /* Prekrytie spodn√©ho okraja summary */ background-color: #fff; /* Pozadie pre obsah */ transition: background-color 0.3s, border-color 0.3s; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    /* Dark mode pre zbaliteƒæn√© */
    body.dark-mode .collapsible-settings summary { background-color: #495057; border-color: #6c757d; color: #dee2e6; }
    body.dark-mode .collapsible-settings summary:hover { background-color: #5a6268; }
    body.dark-mode .collapsible-content { background-color: #343a40; border-color: #6c757d; }

    /* --- Pozn√°mky --- */
    .note-container {
        display: none;
        margin-top: 8px; /* V√§ƒç≈°√≠ odstup */
    }
    .note-container.visible {
        display: block;
    }
    .note-textarea {
        width: 100%; /* Pln√° ≈°√≠rka v bunke */
        min-height: 50px; /* V√§ƒç≈°ia minim√°lna v√Ω≈°ka */
        resize: vertical;
        box-sizing: border-box;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 13px;
        background-color: #f8f8f8; /* Svetlej≈°ie pozadie */
    }
    .toggle-note-btn {
        background-color: #6c757d;
        color: white;
        padding: 4px 10px; /* V√§ƒç≈°√≠ padding */
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background-color 0.2s ease;
        margin-bottom: 4px;
        vertical-align: middle;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Jemn√Ω tie≈à */
    }
    .toggle-note-btn:hover {
        background-color: #5a6268;
    }
    /* Dark mode pre pozn√°mky */
    .note-textarea.dark-mode { background-color: #5a6268; color: #dee2e6; border-color: #6c757d; }
    .toggle-note-btn.dark-mode { background-color: #828a91; }
    .toggle-note-btn.dark-mode:hover { background-color: #70777d; }

    /* --- Media Queries pre responzivitu --- */
    @media (max-width: 768px) {
        h1 { font-size: 2em; }
        .settings { flex-direction: column; align-items: stretch; } /* Nastavenia pod sebou */
        .settings > div, .settings > details, .settings > button { flex-basis: auto; width: 100%; } /* Pln√° ≈°√≠rka */
        .btn-container { flex-direction: column; } /* Tlaƒçidl√° pod sebou */
        .btn { flex-basis: auto; width: 100%; } /* Pln√° ≈°√≠rka tlaƒçidiel */
        .autor-info { position: static; text-align: center; margin-bottom: 10px; } /* Info pod nadpisom */
        body { padding: 5px; }
        .container { padding: 10px; }
        th, td { padding: 6px; font-size: 0.85em; } /* Men≈°√≠ padding a p√≠smo v tabuƒæke */
        table { min-width: 600px; } /* Men≈°ia min-width pre tabuƒæku */
    }
     @media (max-width: 480px) {
        h1 { font-size: 1.8em; }
        #totalSalary { font-size: 1em; padding: 10px; }
        th, td { padding: 4px; font-size: 0.8em; }
        table { min-width: 450px; }
        .time-icon { font-size: 1.1em; right: 5px;}
        input[type="tel"] { padding-right: 28px; }
        .toggle-note-btn { padding: 3px 8px; font-size: 11px; }
        #auth-container { padding: 15px; }
    }

  </style>
</head>
<body>
  <div id="loading-container"><h1>Naƒç√≠tavam aplik√°ciu...</h1></div>

  <div id="auth-container" style="display:none;">
    <h1>Prihl√°senie / Registr√°cia</h1>
    <div id="auth-message">≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.</div>
    <div id="auth-forms">
      <h2>Registr√°cia</h2>
      <input type="email" id="registerEmail" placeholder="Email" autocomplete="email">
      <input type="password" id="registerPassword" placeholder="Heslo" autocomplete="new-password">
      <button onclick="register()">Registrova≈•</button>

      <h2>Prihl√°senie</h2>
      <input type="email" id="loginEmail" placeholder="Email" autocomplete="email">
      <input type="password" id="loginPassword" placeholder="Heslo" autocomplete="current-password">
      <button onclick="login()">Prihl√°si≈• sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()" href="#">Zabudli ste heslo?</a>
    </div>
  </div>

  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>

    <div class="settings">
        <div>
            <label for="monthSelect">Mesiac:</label>
            <select id="monthSelect" onchange="changeMonth()">
                <option value="0">Janu√°r</option>
                <option value="1">Febru√°r</option>
                <option value="2">Marec</option>
                <option value="3">Apr√≠l</option>
                <option value="4">M√°j</option>
                <option value="5">J√∫n</option>
                <option value="6">J√∫l</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">Okt√≥ber</option>
                <option value="10">November</option>
                <option value="11">December</option>
            </select>
        </div>

        <details class="collapsible-settings">
            <summary>ƒéal≈°ie nastavenia</summary>
            <div class="collapsible-content">
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka:</label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno" oninput="updateEmployeeName()">
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
                    <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%):</label>
                    <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="yearSelect">Rok:</label>
                    <select id="yearSelect" onchange="changeYear()"></select>
                </div>
                <div>
                    <label for="decimalPlacesSelect">Desatinn√© miesta (hod):</label>
                    <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                        <option value="1">1</option>
                        <option value="2" selected>2</option> </select>
                </div>
            </div>
        </details>

        <button onclick="toggleDarkMode()" class="btn highlight">Tmav√Ω / Svetl√Ω re≈æim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka (h)</th>
            <th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th class="th-note">Pozn√°mka</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays">
          </tbody>
      </table>
    </div>

    <div id="totalSalary">
      </div>

    <div id="dataSizeContainer">
      <div id="dataSizeText">Lok√°lne √∫lo≈æisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>

    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetova≈• mesiac</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• PDF (Detail)</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF (S√∫hrn)</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
      <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
    </div>
  </div>

  <div id="saveNotification"></div>

  <script>
    // 1. Firebase Configuration & Initialization
    const firebaseConfig = {
        apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo",
        authDomain: "bruno-3cee2.firebaseapp.com",
        projectId: "bruno-3cee2",
        storageBucket: "bruno-3cee2.appspot.com",
        messagingSenderId: "155545319308",
        appId: "1:155545319308:web:5da498ff1cd3e1833888a9"
    };
    firebase.initializeApp(firebaseConfig);
    try {
        firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true);
        console.log("Firebase App Check activated.");
    } catch (error) {
        console.warn("Could not activate Firebase App Check:", error);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // 2. Enable Firestore Offline Persistence
    db.enablePersistence({ synchronizeTabs: true })
      .then(() => console.log("Firestore offline persistence enabled."))
      .catch((err) => { /* Error handling */ });

    // 3. Global Variables & Constants
    let currentMonth, currentYear, decimalPlaces, employeeName = '', hourlyWage, taxRate; // Initialize employeeName
    let monthData = {};
    let firestoreListenerUnsubscribe = null;
    let isSavingToFirebase = false;
    let saveTimeoutId = null;

    // DOM Element References
    const workDaysTbody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const authContainer = document.getElementById('auth-container');
    const calculatorContainer = document.getElementById('calculator-container');
    const loadingContainer = document.getElementById('loading-container');
    const welcomeMessageElement = document.getElementById('welcomeMessage');
    const notificationElement = document.getElementById('saveNotification');

    // Constants
    const MAX_LOCAL_STORAGE_SIZE = 4 * 1024 * 1024;
    const MAX_LOCAL_STORAGE_KB = MAX_LOCAL_STORAGE_SIZE / 1024;
    const SAVE_DEBOUNCE_DELAY = 1500;

    // 4. Authentication Functions (Register, Login, Logout, Forgot Password) - unchanged
    function register() {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        if (!email || !password) { showSaveNotification("Pros√≠m, vypl≈àte email aj heslo.", "warning"); return; }
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => { showSaveNotification("Registr√°cia √∫spe≈°n√°!", "success"); })
            .catch((error) => { console.error("Chyba pri registr√°cii:", error.code, error.message); showSaveNotification(`Chyba registr√°cie: ${mapAuthError(error.code)}`, "error"); });
    }
    function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
         if (!email || !password) { showSaveNotification("Pros√≠m, vypl≈àte email aj heslo.", "warning"); return; }
        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => { showSaveNotification("Prihl√°senie √∫spe≈°n√©!", "success"); })
            .catch((error) => { console.error("Chyba pri prihl√°sen√≠:", error.code, error.message); showSaveNotification(`Chyba prihl√°senia: ${mapAuthError(error.code)}`, "error"); });
    }
    function logout() {
        auth.signOut()
            .then(() => { showSaveNotification("Odhl√°senie √∫spe≈°n√©.", "success"); })
            .catch((error) => { console.error("Chyba pri odhl√°sen√≠:", error.message); showSaveNotification("Chyba pri odhl√°sen√≠.", "error"); });
    }
    function forgotPassword() {
        const emailInput = document.getElementById('loginEmail');
        const email = emailInput.value;
        if (!email) { showSaveNotification("Zadajte e-mailov√∫ adresu do poƒæa pre prihl√°senie.", "warning"); emailInput.focus(); return; }
        auth.sendPasswordResetEmail(email)
            .then(() => { showSaveNotification("Email na obnovu hesla odoslan√Ω. Skontrolujte si po≈°tu (aj Spam).", "success", 5000); })
            .catch((error) => { console.error("Chyba pri odosielan√≠ emailu na obnovu hesla:", error); showSaveNotification(`Chyba: ${mapAuthError(error.code)}`, "error"); });
    }
    function mapAuthError(errorCode) { /* unchanged */
        switch (errorCode) {
            case 'auth/invalid-email': return 'Neplatn√Ω form√°t emailu.';
            case 'auth/user-not-found': return 'Pou≈æ√≠vateƒæ s t√Ωmto emailom neexistuje.';
            case 'auth/wrong-password': return 'Nespr√°vne heslo.';
            case 'auth/email-already-in-use': return 'Tento email sa u≈æ pou≈æ√≠va.';
            case 'auth/weak-password': return 'Heslo je pr√≠li≈° slab√© (min. 6 znakov).';
            case 'auth/network-request-failed': return 'Chyba siete. Skontrolujte pripojenie.';
            default: return 'Nastala nezn√°ma chyba.';
        }
    }

    // 5. Authentication State Change Listener - MODIFIED
    auth.onAuthStateChanged(async user => { // Added async
        if (loadingContainer) loadingContainer.classList.add('hidden');

        if (firestoreListenerUnsubscribe) {
            console.log("Detaching previous Firestore listener.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        if (user) {
            console.log("User signed in:", user.uid, user.email);
            document.getElementById('auth-message').textContent = `Prihl√°sen√Ω: ${user.email}`;
            authContainer.style.display = "none";
            calculatorContainer.style.display = "block";
            applyDarkModeStyles(authContainer, false);

            // --- MODIFICATION START: Load global settings (incl. name) from user doc ---
            await loadGlobalUserSettings(user.uid); // Wait for global settings to load
            // --- MODIFICATION END ---

            initializeDateIfNeeded(); // Ensure date is set before loading local/cloud month data
            loadFromLocalStorage(); // Load local month data first
            setupFirestoreListener(); // Setup real-time listener for cloud month data
            ensureUserDocumentExists(user); // Update last login etc.

        } else {
            // User is signed out
            console.log("User signed out.");
            document.getElementById('auth-message').textContent = "≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.";
            authContainer.style.display = "block";
            calculatorContainer.style.display = "none";
            applyDarkModeStyles(authContainer, document.body.classList.contains('dark-mode'));

            // Reset local state
            monthData = {};
            employeeName = ''; // Clear employee name on logout
            workDaysTbody.innerHTML = '';
            totalSalaryDiv.innerHTML = '';
            updateWelcomeMessage();
            updateDataSize();
        }
    });

    // --- NEW FUNCTION: Load global user settings from user document ---
    async function loadGlobalUserSettings(uid) {
        console.log("Loading global user settings from Firestore user doc...");
        const userDocRef = db.collection("users").doc(uid);
        try {
            const userDocSnap = await userDocRef.get();
            let loadedName = ''; // Default to empty

            if (userDocSnap.exists) {
                const userData = userDocSnap.data();
                console.log("User document data:", userData);
                // Load employeeName from user doc if it exists
                loadedName = userData.employeeName || '';
                // Could load other global settings here in the future if needed
            } else {
                console.log("User document doesn't exist yet.");
                 // If user doc doesn't exist, fall back to localStorage for name
                 loadedName = JSON.parse(localStorage.getItem('employeeName')) || '';
            }

            // If name from user doc is empty, try localStorage as fallback
            if (!loadedName) {
                loadedName = JSON.parse(localStorage.getItem('employeeName')) || '';
            }

            // Update global variable and UI
            employeeName = loadedName;
            employeeNameInput.value = employeeName;
            updateWelcomeMessage();
            console.log(`Global employeeName set to: "${employeeName}"`);

            // Load other settings primarily from localStorage (as before)
            // These could potentially be moved to the user doc too if desired
            initializeLocalSettings();


        } catch (error) {
            console.error("Error loading global user settings:", error);
            showSaveNotification("Chyba pri naƒç√≠tan√≠ glob√°lnych nastaven√≠.", "error");
            // Fallback to local storage settings if Firestore load fails
            initializeLocalSettings();
            employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
            employeeNameInput.value = employeeName;
            updateWelcomeMessage();
        }
    }

    // --- Helper to initialize non-name settings (mostly from localStorage) ---
    function initializeLocalSettings() {
         hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
         taxRate = (parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100) || 0.02;
         decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2;
         const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;

         // Apply initial dark mode state
         applyDarkMode(darkMode);

         // Update UI elements related to these settings
         hourlyWageInput.value = hourlyWage;
         taxRateInput.value = taxRate * 100;
         decimalPlacesSelect.value = decimalPlaces;
         console.log("Local settings initialized (wage, tax, decimals, dark mode).");
    }


    // 6. Utility Functions - unchanged
    function showSaveNotification(message, type = 'success', duration = 3000) { /* unchanged */
        if (!notificationElement) return;
        notificationElement.textContent = message;
        notificationElement.className = 'show'; // Base class to make it visible
        if (type === 'error') {
            notificationElement.classList.add('error');
        } else if (type === 'warning') {
            notificationElement.classList.add('warning');
        }
        requestAnimationFrame(() => {
             notificationElement.classList.add('show');
        });
        setTimeout(() => {
            notificationElement.classList.remove('show');
            setTimeout(() => {
                 if (!notificationElement.classList.contains('show')) {
                     notificationElement.classList.remove('error', 'warning');
                 }
            }, 500);
        }, duration);
    }
    function getFirstName(fullName) { /* unchanged */
        if (!fullName || typeof fullName !== 'string') return '';
        const trimmedName = fullName.trim();
        return trimmedName ? trimmedName.split(' ')[0] : '';
    }
    function updateWelcomeMessage() { /* unchanged */
        if (!welcomeMessageElement) return;
        const firstName = getFirstName(employeeName);
        welcomeMessageElement.textContent = firstName ? `Vitaj sp√§≈•, ${firstName}! üëã` : '';
    }
    function getDaysInMonth(month, year) { /* unchanged */
        if (month === undefined || month === null || year === undefined || year === null) { console.warn("getDaysInMonth: Missing month or year, returning 31."); return 31; }
        return new Date(year, month + 1, 0).getDate();
    }
    function getMonthName(monthIndex) { /* unchanged */
        const monthNames = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
        return monthNames[monthIndex] || 'Nezn√°my';
    }
    function isTimeValid(timeStr) { /* unchanged */
        if (!timeStr) return false;
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        return timeRegex.test(timeStr);
    }
    function debounce(func, delay) { /* unchanged */
        return function(...args) {
            clearTimeout(saveTimeoutId);
            saveTimeoutId = setTimeout(() => {
                func.apply(this, args);
            }, delay);
        };
    }

    // 7. Firestore Listener Setup - MODIFIED
    function setupFirestoreListener() {
        if (firestoreListenerUnsubscribe) {
            console.log("Detaching existing Firestore listener before setting up new one.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        const uid = auth.currentUser?.uid;
        if (!uid) { console.error("setupFirestoreListener: No user logged in."); return; }
        if (currentMonth === undefined || currentYear === undefined) { console.error("setupFirestoreListener: currentMonth or currentYear is undefined."); initializeDateIfNeeded(); if (currentMonth === undefined || currentYear === undefined) return; }

        const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
        const docRef = db.doc(docPath);
        console.log(`Setting up Firestore listener for monthly data: ${docPath}`);

        firestoreListenerUnsubscribe = docRef.onSnapshot(
            (docSnap) => {
                const source = docSnap.metadata.hasPendingWrites ? "Local" : "Server";
                console.log(`Firestore MONTHLY data received from ${source} for ${currentYear}-${currentMonth}. Pending: ${docSnap.metadata.hasPendingWrites}`);

                const activeElementId = document.activeElement?.id;

                if (docSnap.exists) {
                    const data = docSnap.data();
                    console.log("Processing Firestore monthly data:", data);

                    try {
                        // --- Update Settings from Firestore (EXCLUDING employeeName) ---
                        const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
                        const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
                        const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
                        // const firebaseEmployeeName = data.employeeName ?? employeeName; // REMOVED - Name loaded globally
                        const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');

                        // Update global vars and UI if data came from server or differs
                        if (source === "Server" || hourlyWage !== firebaseHourlyWage) {
                            hourlyWage = firebaseHourlyWage;
                            if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
                        }
                        if (source === "Server" || (taxRate * 100) !== firebaseTaxRatePercent) {
                            taxRate = firebaseTaxRatePercent / 100;
                            if (document.activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
                        }
                         if (source === "Server" || decimalPlaces !== firebaseDecimalPlaces) {
                            decimalPlaces = firebaseDecimalPlaces;
                            decimalPlacesSelect.value = decimalPlaces;
                        }
                        // REMOVED: Employee name update logic based on monthly data
                        // if (source === "Server" || employeeName !== firebaseEmployeeName) { ... }
                         if (source === "Server" || document.body.classList.contains('dark-mode') !== firebaseDarkMode) {
                            applyDarkMode(firebaseDarkMode);
                        }

                        // --- Update Work Days Data (Unchanged logic) ---
                        const firebaseDaysData = (data.days || []).map(day => ({
                            start: day.start || '', end: day.end || '', breakTime: day.breakTime || '',
                            note: day.note || '', noteVisible: day.noteVisible === true
                        }));

                        if (!monthData) monthData = {};
                        if (!monthData[currentYear]) monthData[currentYear] = {};
                        monthData[currentYear][currentMonth] = firebaseDaysData;

                        // --- Update UI Table Rows (Optimized - Unchanged logic) ---
                        const daysInMonth = getDaysInMonth(currentMonth, currentYear);
                        let uiNeedsRecalculation = false;
                        for (let i = 1; i <= daysInMonth; i++) { /* ... row update logic ... */
                            const dayIndex = i - 1;
                            const firebaseDay = firebaseDaysData[dayIndex] || { start: '', end: '', breakTime: '', note: '', noteVisible: false };
                            const baseId = `${currentYear}-${currentMonth}-${i}`;
                            const startId = `start-${baseId}`; const endId = `end-${baseId}`; const breakId = `break-${baseId}`;
                            const noteId = `note-${baseId}`; const noteContainerId = `note-container-${baseId}`;
                            const noteButtonId = `note-toggle-${baseId}`; const noteIndicatorId = `note-indicator-${baseId}`;
                            const startElement = document.getElementById(startId); const endElement = document.getElementById(endId);
                            const breakElement = document.getElementById(breakId); const noteElement = document.getElementById(noteId);
                            const noteContainer = document.getElementById(noteContainerId); const noteButton = document.getElementById(noteButtonId);
                            const noteIndicator = document.getElementById(noteIndicatorId);

                            if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
                                let rowUpdatedByListener = false;
                                if (startElement.value !== firebaseDay.start && activeElementId !== startId) { startElement.value = firebaseDay.start; rowUpdatedByListener = true; }
                                if (endElement.value !== firebaseDay.end && activeElementId !== endId) { endElement.value = firebaseDay.end; rowUpdatedByListener = true; }
                                if (breakElement.value !== firebaseDay.breakTime && activeElementId !== breakId) { breakElement.value = firebaseDay.breakTime; rowUpdatedByListener = true; }
                                if (noteElement.value !== firebaseDay.note && activeElementId !== noteId) { noteElement.value = firebaseDay.note; updateNoteIndicator(i); }
                                const currentNoteVisible = noteContainer.classList.contains('visible');
                                if (currentNoteVisible !== firebaseDay.noteVisible) {
                                    noteContainer.classList.toggle('visible', firebaseDay.noteVisible);
                                    noteButton.textContent = firebaseDay.noteVisible ? 'Skry≈•' : 'Pozn√°mka';
                                    applyDarkModeStyles(noteElement, firebaseDay.noteVisible && document.body.classList.contains('dark-mode'));
                                }
                                if (rowUpdatedByListener) { calculateRow(i); uiNeedsRecalculation = true; }
                            } else { console.warn(`Listener: Elements for day ${i} not found.`); }
                        }
                        if (uiNeedsRecalculation) { calculateTotal(); }

                        // Save potentially updated data (excluding name) back to local storage
                        saveToLocalStorage(false);

                        if (!docSnap.metadata.fromCache && !docSnap.metadata.hasPendingWrites) {
                             showSaveNotification("Mesaƒçn√© d√°ta synchronizovan√©", "success", 1500);
                        }

                    } catch (processError) {
                        console.error(`Listener: Error processing Firestore monthly data for ${currentYear}-${currentMonth}:`, processError);
                        showSaveNotification("Chyba spracovania mesaƒçn√Ωch d√°t z cloudu", "error");
                    }

                } else {
                    // Monthly Document doesn't exist in Firestore
                    console.log(`Firestore monthly document ${docPath} does not exist. Clearing local data for this month.`);
                    if (monthData && monthData[currentYear]) { monthData[currentYear][currentMonth] = []; }
                    saveToLocalStorage(false);
                    createTable();
                    calculateTotal();
                    updateDataSize();
                }
            },
            (error) => {
                console.error(`Firestore listener ERROR for ${docPath}:`, error);
                showSaveNotification("Chyba pripojenia k mesaƒçn√Ωm d√°tam v cloude", "error");
            }
        );
    }


    // 8. Save Data to Firebase (Called by debouncedSave) - MODIFIED
    async function saveToFirebase() {
        if (isSavingToFirebase) { console.log("Firebase save already in progress, skipping."); return; }
        const currentUser = auth.currentUser;
        if (!currentUser || !navigator.onLine) { /* Log warning */ return; }

        isSavingToFirebase = true;
        console.log(`Attempting to save MONTHLY data to Firebase for ${currentYear}-${currentMonth}`);

        try {
            // Prepare data for the current month/year (EXCLUDING employeeName)
            const currentMonthWorkData = ((monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []).map(day => ({
                start: day.start || '', end: day.end || '', breakTime: day.breakTime || '',
                note: day.note || '', noteVisible: day.noteVisible === true
            }));

            const dataToSave = {
                days: currentMonthWorkData,
                hourlyWage: hourlyWage || 10,
                taxRate: (taxRate * 100) || 2,
                decimalPlaces: decimalPlaces || 2,
                // employeeName: employeeName || '', // REMOVED - Name saved globally
                darkMode: document.body.classList.contains('dark-mode'),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            const yearMonthDoc = `${currentYear}-${currentMonth}`;
            const uid = currentUser.uid;
            // Path to the specific month's document
            const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);

            await docRef.set(dataToSave, { merge: true }); // Save monthly data
            console.log(`Monthly data successfully saved to Firebase for ${yearMonthDoc}`);

        } catch (error) {
            console.error(`Error saving monthly data to Firebase for ${currentYear}-${currentMonth}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa ulo≈æi≈• mesaƒçn√© d√°ta do cloudu", "error");
        } finally {
            isSavingToFirebase = false;
        }
    }

    // Debounced version remains the same
    const debouncedSaveToFirebase = debounce(saveToFirebase, SAVE_DEBOUNCE_DELAY);

    // 9. Save Data to Local Storage (and trigger debounced Firebase save) - Unchanged conceptually
    // It saves the current state (including global employeeName) locally
    // and triggers the debounced save which now only saves month-specific data to Firestore.
    function saveToLocalStorage(triggerFirebaseSave = true) {
        console.log("Saving to Local Storage...");
        try {
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];

            // Save settings (including the global employeeName)
            localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
            localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
            localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
            localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
            localStorage.setItem('employeeName', JSON.stringify(employeeName)); // Still save name locally
            localStorage.setItem('currentMonth', currentMonth.toString());
            localStorage.setItem('currentYear', currentYear.toString());

            // Save work days data
            const serializedMonthData = JSON.stringify(monthData);
            const bytes = new Blob([serializedMonthData]).size;
            if (bytes > MAX_LOCAL_STORAGE_SIZE * 0.9 && bytes <= MAX_LOCAL_STORAGE_SIZE) { /* Warn */ }
            else if (bytes > MAX_LOCAL_STORAGE_SIZE) { /* Error and return */ return; }
            localStorage.setItem('workDaysData', serializedMonthData);
            updateDataSize();

            // Trigger the debounced Firebase save (which now saves only month data)
            if (triggerFirebaseSave && navigator.onLine && auth.currentUser) {
                console.log("Triggering debounced Firebase save (for monthly data)...");
                debouncedSaveToFirebase();
            } else if (!navigator.onLine) {
                 showSaveNotification("Offline: Zmeny ulo≈æen√© lok√°lne", "warning", 1500);
            }

        } catch (error) { /* Error handling */ }
    }


    // 10. Load Data from Local Storage - Unchanged
    // Loads all data including employeeName from local storage initially or as fallback
    function loadFromLocalStorage() {
        console.log("Loading data from Local Storage...");
        try {
            initializeDateIfNeeded();

            // Load settings (employeeName is loaded here too, but might be overwritten by global load)
            hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
            taxRate = (parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100) || 0.02;
            const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
            decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2;
            // employeeName loaded globally now, but keep local as fallback/initial
            const localEmployeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
            if (!employeeName) employeeName = localEmployeeName; // Use local only if global is empty

            const storedMonthData = localStorage.getItem('workDaysData');
            monthData = storedMonthData ? JSON.parse(storedMonthData) : {};

            if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) {
                monthData[currentYear][currentMonth] = monthData[currentYear][currentMonth].map(day => ({
                    start: day.start || '', end: day.end || '', breakTime: day.breakTime || '',
                    note: day.note || '', noteVisible: day.noteVisible === true
                }));
            }
            console.log("Data loaded from Local Storage (incl. potential fallback name):", { employeeName });
            updateUIFromLoadedData(darkMode);

        } catch (error) { /* Error handling */ }
    }

    // 11. Update UI with Loaded Data - Unchanged
    // Updates UI based on current global variables (employeeName is now set globally before this runs)
    function updateUIFromLoadedData(darkModeValue) {
        console.log("Updating UI from loaded data...");
        try {
            // Update settings inputs (employeeNameInput uses the global variable)
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = taxRate * 100;
            decimalPlacesSelect.value = decimalPlaces;
            employeeNameInput.value = employeeName; // Uses the globally loaded name

            // Update month/year selects
            if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) { monthSelect.value = currentMonth; } else { /* Default */ }
            if (yearSelect.querySelector(`option[value="${currentYear}"]`)) { yearSelect.value = currentYear; } else { /* Default */ }

            createTable(); // Create table structure

            // Populate table rows
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            const daysInMonth = getDaysInMonth(currentMonth, currentYear);
             while (dataForCurrentMonth.length < daysInMonth) { dataForCurrentMonth.push({ start: '', end: '', breakTime: '', note: '', noteVisible: false }); }

            dataForCurrentMonth.forEach((day, index) => { /* ... populate row inputs and notes ... */
                const i = index + 1;
                const baseId = `${currentYear}-${currentMonth}-${i}`;
                const startElement = document.getElementById(`start-${baseId}`); const endElement = document.getElementById(`end-${baseId}`);
                const breakElement = document.getElementById(`break-${baseId}`); const noteElement = document.getElementById(`note-${baseId}`);
                const noteContainer = document.getElementById(`note-container-${baseId}`); const noteButton = document.getElementById(`note-toggle-${baseId}`);
                const noteIndicator = document.getElementById(`note-indicator-${baseId}`);
                if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
                    startElement.value = day.start || ''; endElement.value = day.end || ''; breakElement.value = day.breakTime || ''; noteElement.value = day.note || '';
                    const isNoteVisible = day.noteVisible === true;
                    noteContainer.classList.toggle('visible', isNoteVisible);
                    noteButton.textContent = isNoteVisible ? 'Skry≈•' : 'Pozn√°mka';
                    updateNoteIndicator(i);
                    calculateRow(i);
                } else { console.error(`Critical Error: Elements for day ${i} not found!`); }
            });

            calculateTotal();
            updateDataSize();
            applyDarkMode(darkModeValue);
            updateWelcomeMessage(); // Uses the globally loaded name

        } catch (error) { /* Error handling */ }
    }

    // 12. Dark Mode Functionality - Unchanged
    function applyDarkMode(isDark) { /* unchanged */
        console.log(`Applying dark mode: ${isDark}`);
        const body = document.body; const container = document.querySelector('.container');
        const authCont = document.getElementById('auth-container'); const loadingCont = document.getElementById('loading-container');
        body.classList.toggle('dark-mode', isDark);
        if (container) container.classList.toggle('dark-mode', isDark);
        if (totalSalaryDiv) totalSalaryDiv.classList.toggle('dark-mode', isDark);
        if (authCont) applyDarkModeStyles(authCont, isDark);
        if (loadingCont) applyDarkModeStyles(loadingCont, isDark);
        applyDarkModeStyles(document.querySelectorAll('table, th, td'), isDark);
        applyDarkModeStyles(document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea'), isDark);
        applyDarkModeStyles(document.querySelectorAll('.btn'), isDark);
        applyDarkModeStyles(document.querySelectorAll('.toggle-note-btn, .note-indicator-icon, .time-icon'), isDark);
        applyDarkModeStyles(document.querySelectorAll('.collapsible-settings summary, .collapsible-content'), isDark);
        applyDarkModeStyles(document.querySelectorAll('#dataSizeBar, #dataSizeText'), isDark);
        const currentDayRows = document.querySelectorAll('.current-day');
        currentDayRows.forEach(row => { applyDarkModeStyles(row.querySelectorAll('td'), isDark); applyDarkModeStyles(row.querySelectorAll('input, .note-textarea, select'), isDark); });
     }
    function applyDarkModeStyles(elements, isDark) { /* unchanged */
        if (!elements) return;
        if (elements instanceof Node) { elements.classList.toggle('dark-mode', isDark); }
        else if (elements instanceof NodeList || Array.isArray(elements)) { elements.forEach(el => el?.classList.toggle('dark-mode', isDark)); }
    }
    function toggleDarkMode() { /* unchanged - saves dark mode to month doc */
        const isDarkMode = !document.body.classList.contains('dark-mode');
        applyDarkMode(isDarkMode);
        localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
        if (auth.currentUser && navigator.onLine) {
            const uid = auth.currentUser.uid;
            // Save dark mode preference to the *currently viewed* month document
            const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(`${currentYear}-${currentMonth}`);
            docRef.set({ darkMode: isDarkMode }, { merge: true })
                .then(() => console.log("Dark mode preference saved to Firebase (current month)."))
                .catch(err => console.error("Error saving dark mode to Firebase:", err));
            // Consider also saving to the main user doc if you want a global default dark mode
            // const userDocRef = db.collection("users").doc(uid);
            // userDocRef.set({ darkMode: isDarkMode }, { merge: true });
        }
     }

    // 13. Table Creation and Day Row Generation - Unchanged
    function createTable() { /* unchanged */
        console.log(`Creating table for ${getMonthName(currentMonth)} ${currentYear}`);
        workDaysTbody.innerHTML = '';
        const tableHead = document.querySelector('table thead tr');
        if (tableHead && !tableHead.querySelector('.th-note')) { /* Add note header if missing */ }
        const daysInMonth = getDaysInMonth(currentMonth, currentYear);
        const today = new Date(); const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth(); const currentYearValue = today.getFullYear();
        const fragment = document.createDocumentFragment();
        for (let i = 1; i <= daysInMonth; i++) { /* ... create row HTML ... */
            const row = document.createElement('tr');
            const isCurrentDay = (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue);
            if (isCurrentDay) { row.classList.add('current-day'); }
            const dayName = getDayName(currentYear, currentMonth, i);
            const baseId = `${currentYear}-${currentMonth}-${i}`;
            const startId = `start-${baseId}`; const endId = `end-${baseId}`; const breakId = `break-${baseId}`;
            const totalId = `total-${baseId}`; const grossId = `gross-${baseId}`; const netId = `net-${baseId}`;
            const noteToggleId = `note-toggle-${baseId}`; const noteContainerId = `note-container-${baseId}`;
            const noteTextareaId = `note-${baseId}`; const noteIndicatorId = `note-indicator-${baseId}`;
            row.innerHTML = `<td>De≈à ${i} (${dayName})</td><td><input type="tel" id="${startId}" ...>...</td>...`; // Simplified for brevity
            fragment.appendChild(row);
        }
        workDaysTbody.appendChild(fragment);
        applyDarkMode(document.body.classList.contains('dark-mode'));
     }
    function insertCurrentTime(targetInputId) { /* unchanged */ }
    function toggleNote(day) { /* unchanged */ }
    function updateNoteIndicator(day) { /* unchanged */ }
    function ensureDayDataExists(dayIndex) { /* unchanged */ }

    // 14. Input Handling and Formatting - Unchanged
    function handleInput(input, nextId, day) { /* unchanged */ }
    function handleBreakInput(day) { /* unchanged */ }
    function handleNoteInput(textarea, day) { /* unchanged */ }
    function updateMonthDataFromInput(inputElement, day) { /* unchanged */ }
    function formatInput(input) { /* unchanged */ }
    function moveFocusToNext(currentElement, nextId) { /* unchanged */ }

    // 15. Row and Total Calculations - Unchanged
    function calculateRow(day) { /* unchanged */ }
    function resetRow(day) { /* unchanged */ }
    function resetAll() { /* unchanged */ }
    function calculateTotal() { /* unchanged */ }

    // 16. PDF Export and Sharing - Unchanged
    // Uses the global employeeName variable when generating PDFs
    function exportToPDF() { /* unchanged */ }
    function sendPDF() { /* unchanged */ }
    function downloadFile(blob, filename) { /* unchanged */ }

    // 17. Settings Change Handlers - MODIFIED updateEmployeeName
    function changeDecimalPlaces() { /* unchanged */ }

    function updateEmployeeName() {
        const newName = employeeNameInput.value;
        if (employeeName !== newName) {
            console.log(`Employee name changed to: ${newName}`);
            employeeName = newName; // Update global variable
            updateWelcomeMessage(); // Update UI
            localStorage.setItem('employeeName', JSON.stringify(employeeName)); // Save locally

            // --- MODIFICATION: Save name to the main user document in Firebase ---
            const currentUser = auth.currentUser;
            if (currentUser && navigator.onLine) {
                const userDocRef = db.collection("users").doc(currentUser.uid);
                userDocRef.set({ employeeName: employeeName }, { merge: true }) // Use set with merge to create/update
                    .then(() => {
                        console.log("Employee name updated in user document.");
                        showSaveNotification("Meno ulo≈æen√©.", "success", 1500);
                    })
                    .catch(err => {
                        console.error("Error updating employee name in user document:", err);
                        showSaveNotification("Chyba pri ukladan√≠ mena do cloudu.", "error");
                    });
            } else if (!currentUser) {
                 console.warn("Cannot save employee name to Firebase: No user logged in.");
            } else {
                 showSaveNotification("Offline: Meno ulo≈æen√© lok√°lne.", "warning", 1500);
            }
            // --- END MODIFICATION ---
        }
    }

    function updateSettings() { /* unchanged - only handles wage/tax */ }
    function changeMonth() { /* unchanged */ }
    function changeYear() { /* unchanged */ }
    function handleMonthYearChange() { /* unchanged */ }
    function updateDataSize() { /* unchanged */ }

    // 18. Backup and Restore Functionality - MODIFIED restoreBackup & uploadRestoredDataToFirebase
    function createBackup() { /* unchanged - already saves name in settings */ }

    function restoreBackup() {
        console.log("Initiating backup restore...");
        const fileInput = document.createElement('input');
        fileInput.type = 'file'; fileInput.accept = '.json,application/json';
        fileInput.onchange = (event) => {
            const file = event.target.files[0]; if (!file) return;
            console.log(`File selected for restore: ${file.name}`);
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    console.log("Backup file content parsed:", backup);
                    if (!backup || typeof backup !== 'object') throw new Error("Invalid backup file structure.");
                    if (!backup.settings || typeof backup.settings !== 'object') throw new Error("Missing 'settings'.");
                    if (typeof backup.workDaysData === 'undefined') throw new Error("Missing 'workDaysData'.");

                    // Restore Settings to localStorage
                    localStorage.setItem('hourlyWage', JSON.stringify(backup.settings.hourlyWage ?? 10));
                    localStorage.setItem('taxRate', JSON.stringify(backup.settings.taxRate ?? 2));
                    localStorage.setItem('darkMode', JSON.stringify(backup.settings.darkMode ?? false));
                    localStorage.setItem('decimalPlaces', JSON.stringify(backup.settings.decimalPlaces ?? 2));
                    localStorage.setItem('employeeName', JSON.stringify(backup.settings.employeeName ?? '')); // Restore name locally

                    // Restore Work Data to localStorage
                    if (typeof backup.workDaysData === 'object' && backup.workDaysData !== null) {
                         localStorage.setItem('workDaysData', JSON.stringify(backup.workDaysData));
                    } else { localStorage.setItem('workDaysData', '{}'); }
                    console.log("Data restored to Local Storage from backup.");

                    // --- MODIFICATION: Reload global settings (incl. name) THEN load month data ---
                    loadGlobalUserSettings(auth.currentUser?.uid) // Load global name etc. first
                         .then(() => {
                              loadFromLocalStorage(); // Then load the specific month data and update UI
                              showSaveNotification("Z√°loha √∫spe≈°ne obnoven√°.", "success", 4000);

                              // Ask user about uploading to Firebase
                              if (auth.currentUser && navigator.onLine) {
                                   if (confirm("Z√°loha obnoven√° lok√°lne. Chcete tieto obnoven√© d√°ta nahra≈• aj do cloudu? (Meno pracovn√≠ka sa ulo≈æ√≠ glob√°lne, mesaƒçn√© d√°ta prep√≠≈°u existuj√∫ce v cloude)")) {
                                        console.log("User confirmed upload of restored data to Firebase.");
                                        // Pass both work data and settings (containing the name)
                                        uploadRestoredDataToFirebase(backup.workDaysData, backup.settings);
                                   } else { console.log("User chose not to upload restored data to Firebase."); }
                              }
                         });
                    // --- END MODIFICATION ---

                } catch (error) { /* Error handling */ }
            };
            reader.onerror = (e) => { /* Error handling */ };
            reader.readAsText(file);
        };
        fileInput.click();
    }

    // MODIFIED: Saves employeeName to user doc, rest to monthly docs
    async function uploadRestoredDataToFirebase(restoredWorkData, restoredSettings) {
         const currentUser = auth.currentUser;
         if (!currentUser || !navigator.onLine) { /* Show warning */ return; }
         if (typeof restoredWorkData !== 'object' || restoredWorkData === null) { /* Error */ return; }
         if (!restoredSettings) { console.error("Restored settings missing for upload."); return; }

         showSaveNotification("Nahr√°vam obnoven√© d√°ta do cloudu...", "info", 5000);
         const uid = currentUser.uid;
         const userDocRef = db.collection("users").doc(uid);
         const monthlyPromises = [];

         // --- MODIFICATION: Save global settings (employee name) first ---
         const globalDataToSave = {
             employeeName: restoredSettings.employeeName ?? ''
             // Add other global settings here if needed in future (e.g., preferred dark mode)
             // darkMode: restoredSettings.darkMode ?? false // Example
         };
         try {
             await userDocRef.set(globalDataToSave, { merge: true });
             console.log("Global settings (employee name) uploaded to user document.");
         } catch (error) {
              console.error("Error uploading global settings (employee name) to Firebase:", error);
              showSaveNotification("Chyba pri nahr√°van√≠ mena pracovn√≠ka do cloudu.", "error");
              // Decide if you want to stop the whole upload or continue with monthly data
              // return; // Stop here if global save fails?
         }
         // --- END MODIFICATION ---


         // Iterate through years and months to save monthly data
         for (const year in restoredWorkData) {
              if (Object.hasOwnProperty.call(restoredWorkData, year)) {
                   const yearData = restoredWorkData[year];
                   for (const month in yearData) {
                        if (Object.hasOwnProperty.call(yearData, month)) {
                             const monthWorkData = yearData[month];
                             const yearMonthDoc = `${year}-${month}`;
                             const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);

                             // Prepare MONTHLY data (using restored settings but excluding name)
                             const dataToSave = {
                                  days: Array.isArray(monthWorkData) ? monthWorkData : [],
                                  hourlyWage: restoredSettings.hourlyWage ?? 10,
                                  taxRate: restoredSettings.taxRate ?? 2,
                                  decimalPlaces: restoredSettings.decimalPlaces ?? 2,
                                  darkMode: restoredSettings.darkMode ?? false,
                                  // employeeName: restoredSettings.employeeName ?? '', // REMOVED
                                  timestamp: firebase.firestore.FieldValue.serverTimestamp()
                             };
                             console.log(`Preparing to upload restored monthly data for ${yearMonthDoc}`);
                             monthlyPromises.push(docRef.set(dataToSave)); // Overwrite monthly doc
                        }
                   }
              }
         }

         try {
              await Promise.all(monthlyPromises);
              console.log("All restored monthly data successfully uploaded to Firebase.");
              showSaveNotification("Obnoven√© d√°ta √∫spe≈°ne nahran√© do cloudu.", "success");
              if (firestoreListenerUnsubscribe) { setupFirestoreListener(); } // Refresh listener
         } catch (error) {
              console.error("Error uploading restored monthly data to Firebase:", error);
              showSaveNotification("Chyba pri nahr√°van√≠ obnoven√Ωch mesaƒçn√Ωch d√°t do cloudu.", "error");
         }
    }


    // 19. Initialization Logic - MODIFIED
    function initializeDateIfNeeded() { // Renamed slightly
        if (currentMonth === undefined || currentYear === undefined) {
            const storedMonth = localStorage.getItem('currentMonth');
            const storedYear = localStorage.getItem('currentYear');
            const currentDate = new Date();
            currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
            currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
            if (isNaN(currentMonth) || currentMonth < 0 || currentMonth > 11) { currentMonth = currentDate.getMonth(); }
            if (isNaN(currentYear) || currentYear < 2000 || currentYear > currentDate.getFullYear() + 5) { currentYear = currentDate.getFullYear(); }
            console.log(`Initialized date: Month=${currentMonth}, Year=${currentYear}`);
        }
    }

    // Removed initializeUserSettings as its logic is now split into
    // loadGlobalUserSettings and initializeLocalSettings, called from onAuthStateChanged

    function populateYearSelect() { /* unchanged */ }

    // MODIFIED: Only updates lastLogin, creation handled separately if needed
     function ensureUserDocumentExists(user) {
         if (!user) return;
         const uid = user.uid;
         const userDocRef = db.collection("users").doc(uid);

         // Just update last login time if the document exists
         userDocRef.update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() })
             .then(() => console.log(`Updated lastLogin for user ${uid}`))
             .catch(err => {
                  // If update fails because doc doesn't exist, create it.
                  if (err.code === 'not-found') {
                       console.log(`User document for ${uid} not found during update, creating...`);
                       userDocRef.set({
                            email: user.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                            employeeName: employeeName // Include current name if creating
                       })
                       .then(() => console.log(`User document created for ${uid}`))
                       .catch(createErr => console.error("Error creating user document after failed update:", createErr));
                  } else {
                       console.warn("Could not update last login time (may be transient):", err);
                  }
             });
     }


    // --- DOMContentLoaded Event Listener ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM fully loaded and parsed.");
        // Date and settings are initialized based on Auth state now
        populateYearSelect();

        // Service Worker Registration
        if ('serviceWorker' in navigator) { /* unchanged */ }
        else { console.warn("Service Worker not supported."); }

        // Auth form listeners
        document.getElementById('registerPassword').addEventListener('keypress', function(e) { if (e.key === 'Enter') register(); });
        document.getElementById('loginPassword').addEventListener('keypress', function(e) { if (e.key === 'Enter') login(); });

        console.log("Initial setup complete. Waiting for Auth state...");
    });

  </script>
</body>
</html>
