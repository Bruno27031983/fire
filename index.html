<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 10px;
    }
    .settings > div,
    .settings > details,
    .settings > button {
        flex: 1 1 200px;
        margin: 0;
    }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 900px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea {
        width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px;
    }
    th:nth-child(1), td:nth-child(1) { min-width: 50px; } /* Deň */
    th:nth-child(2), td:nth-child(2) { min-width: 80px; } /* Príchod */
    th:nth-child(3), td:nth-child(3) { min-width: 80px; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* Prestávka */
    th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* Odpracované */
    th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* Hrubá Mzda */
    th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* Čistá Mzda */
    th:nth-child(8), td:nth-child(8) { min-width: 120px; } /* Poznámka */
    th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia */

    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }

    /* --- ZMENENÉ/PRIDANÉ ŠTÝLY PRE LOGIN/LOGOUT TLAČIDLO --- */
    #logout-btn {
        /* Štandardný štýl (keď je na odhlásenie) preberie z .reset-btn */
    }
    #logout-btn.login-prompt {
        background-color: #4CAF50; /* Zelená ako export */
        color: white;
    }
    #logout-btn.login-prompt:hover {
        background-color: #388e3c; /* Tmavšia zelená pri hover */
    }
    /* Dark mode pre login prompt */
    #logout-btn.login-prompt.dark-mode {
         background-color: #388e3c; /* Tmavšia zelená v dark mode */
         color: #eee;
    }
    #logout-btn.login-prompt.dark-mode:hover {
         background-color: #2e7d32; /* Ešte tmavšia zelená v dark mode pri hover */
    }
    /* Štýl pre odhlasovacie tlačidlo (ostáva červený) */
    #logout-btn.reset-btn { /* Keď slúži na odhlásenie, použije štýl reset-btn */
         background-color: #f44336;
    }
    #logout-btn.reset-btn:hover {
         background-color: #d32f2f;
    }
    #logout-btn.reset-btn.dark-mode {
         background-color: #c62828;
    }
    #logout-btn.reset-btn.dark-mode:hover {
         background-color: #b71c1c;
    }
    /* --- KONIEC ZMIEN ŠTÝLOV PRE LOGIN/LOGOUT TLAČIDLO --- */


    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input, .current-day .note-textarea { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode {
        background-color: #666; color: white; border-color: #888;
    }
    .btn.dark-mode { color: #eee; }
    .reset-btn.dark-mode { background-color: #c62828; } .reset-btn.dark-mode:hover { background-color: #b71c1c; }
    .export-btn.dark-mode { background-color: #2e7d32; } .export-btn.dark-mode:hover { background-color: #1b5e20; }
    .restore-btn.dark-mode { background-color: #6a1b9a; } .restore-btn.dark-mode:hover { background-color: #4a148c; }
    .backup-btn.dark-mode { background-color: #ef6c00; } .backup-btn.dark-mode:hover { background-color: #e65100; }

    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input, .current-day.dark-mode .note-textarea { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    /* Auth container štýly */
    #auth-container { max-width: 400px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); text-align: center; border: 1px solid #ccc; }
     body.dark-mode #auth-container { background-color: #555; border-color: #777; }
    #auth-container h1 { font-size: 1.8em; margin-bottom: 15px; }
    #auth-container h2 { font-size: 1.4em; margin-top: 20px; margin-bottom: 10px; color: #444; }
     body.dark-mode #auth-container h2 { color: #eee; }
    #auth-container input { width: 90%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
     body.dark-mode #auth-container input { background-color: #666; color: white; border-color: #888; }
    #auth-container button { width: 95%; padding: 12px; margin: 15px 0 5px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 1.1em; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
    #auth-container button:hover { background-color: #45a049; }
     #close-auth-btn { background-color: #aaa; margin-top: 10px; }
     #close-auth-btn:hover { background-color: #888; }
     body.dark-mode #close-auth-btn { background-color: #777; }
     body.dark-mode #close-auth-btn:hover { background-color: #666; }

    #auth-message { margin-bottom: 15px; font-weight: bold; color: #333; }
     body.dark-mode #auth-message { color: #eee; }
    #forgot-password-link { display: block; margin-top: 10px; font-size: 0.9em; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }
     body.dark-mode #forgot-password-link { color: #66b3ff; }

    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; text-align: center; padding: 20px; }
    /* Zmenený štýl pre H1 v loading containery */
    #loading-container h1 {
        font-size: 1.5em; /* Prípadne upravte veľkosť */
        color: #555; /* Prípadne upravte farbu */
        background: none; /* Odstránenie gradientu */
        -webkit-background-clip: unset;
        background-clip: unset;
        animation: none; /* Odstránenie animácií */
        text-shadow: none; /* Odstránenie tieňa */
    }
    #loading-container.hidden { opacity: 0; pointer-events: none; }

    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
    .collapsible-settings summary:hover { background-color: #eee; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
    body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
    body.dark-mode .collapsible-content { border-top-color: #666; }

    .note-container { display: none; margin-top: 5px; }
    .note-container.visible { display: block; }
    .note-textarea { width: 95%; min-height: 40px; resize: vertical; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; background-color: #f0f0f0; }
    .toggle-note-btn { background-color: #6c757d; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease; margin-bottom: 2px; }
    .toggle-note-btn:hover { background-color: #5a6268; }
    .note-textarea.dark-mode { background-color: #555; color: #f4f4f4; border-color: #777; }
    .toggle-note-btn.dark-mode { background-color: #828a91; }
    .toggle-note-btn.dark-mode:hover { background-color: #70777d; }
  </style>
</head>
<body>
  <!-- Loading screen - VRÁTENÝ PÔVODNÝ TEXT -->
  <div id="loading-container"><h1> Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte, dosiahnete všetko. </h1></div>

  <!-- Auth container - štandardne skrytý -->
  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <p>Prihlásenie umožňuje synchronizáciu dát medzi zariadeniami.</p>
    <div id="auth-message"></div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
    <button id="close-auth-btn" onclick="closeAuthForm()">Zavrieť</button>
  </div>

  <!-- Calculator container - štandardne viditeľný po načítaní -->
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>

    <!-- Nastavenia -->
    <div class="settings">
        <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
                <option value="0">Január</option> <option value="1">Február</option> <option value="2">Marec</option>
                <option value="3">Apríl</option> <option value="4">Máj</option> <option value="5">Jún</option>
                <option value="6">Júl</option> <option value="7">August</option> <option value="8">September</option>
                <option value="9">Október</option> <option value="10">November</option> <option value="11">December</option>
            </select>
        </div>
        <details class="collapsible-settings">
            <summary>Ďalšie nastavenia</summary>
            <div class="collapsible-content">
                <div><label for="employeeNameInput">Meno pracovníka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()"></div>
                <div><label for="hourlyWageInput">Hodinová mzda (€): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div>
                <div><label for="taxRateInput">Daňové percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"></div>
                <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div>
                <div><label for="decimalPlacesSelect">Počet desatinných miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2">2</option></select></div>
            </div>
        </details>
        <button onclick="toggleDarkMode()" class="btn highlight">Tmavý režim</button>
    </div>

    <!-- Tabuľka -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th> <th>Príchod</th> <th>Odchod</th> <th>Prestávka</th> <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th> <th>Čistá Mzda (€)</th> <th class="th-note">Poznámka</th> <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <!-- Súčty a info -->
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>

    <!-- Tlačidlá -->
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať aktuálny mesiac</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu (lokálnu)</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu (lokálnu)</button>
      <!-- Toto tlačidlo teraz slúži na Odhlásenie aj ako výzva na Prihlásenie -->
      <button id="logout-btn" class="btn" style="display: none;"></button>
    </div>
  </div>

  <!-- Notifikácia -->
  <div id="saveNotification"></div>

  <script>
    // 1. Firebase Config & Init - Nezmenené
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktivácii Firebase App Check:", error); }
    const db = firebase.firestore(); const auth = firebase.auth();

    // 2. Povolenie Firestore Offline Persistence - Nezmenené
    db.enablePersistence().then(() => { console.log("Firestore offline persistence povolená."); }).catch((err) => { console.error("Firestore offline persistence chyba:", err.code, err.message, err); if (err.code == 'failed-precondition') { console.warn("Firestore offline persistence: Viacnásobné otvorené taby, povolené len v jednom."); } else if (err.code == 'unimplemented') { console.error("Firestore offline persistence: Prehliadač nie je podporovaný."); } });

    // 3. Globálne premenné - Nezmenené
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
    let monthData = {};
    let firestoreListenerUnsubscribe = null;
    let isLoggedIn = false;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const authContainer = document.getElementById('auth-container');
    const calculatorContainer = document.getElementById('calculator-container');
    const loadingContainer = document.getElementById('loading-container');
    const logoutBtn = document.getElementById('logout-btn');
    const authMessage = document.getElementById('auth-message');
    const MAX_DATA_SIZE = 4 * 1024 * 1024;
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // 4. Auth funkcie (Register, Login, Logout, Forgot Password) - Nezmenené
    function register() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => { console.log("Registrovaný:", userCredential.user); alert("Registrácia úspešná! Teraz ste prihlásený."); closeAuthForm(); })
        .catch((error) => { console.error("Chyba pri registrácii:", error.message); alert("Chyba pri registrácii: " + error.message); });
    }
    function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => { console.log("Prihlásený:", userCredential.user); alert("Prihlásenie úspešné!"); closeAuthForm(); })
        .catch((error) => { console.error("Chyba pri prihlásení:", error.message); alert("Chyba pri prihlásení: " + error.message); });
    }
    function logout() {
      auth.signOut()
        .then(() => { console.log("Odhlásený."); alert("Odhlásenie úspešné!"); })
        .catch((error) => { console.error("Chyba pri odhlásení:", error.message); alert("Chyba pri odhlásení: " + error.message); });
    }
    function forgotPassword() {
      const emailInput = document.getElementById('loginEmail'); const email = emailInput.value;
      if (!email) { alert("Prosím, zadajte svoju e-mailovú adresu do poľa pre prihlásenie."); emailInput.focus(); return; }
      auth.sendPasswordResetEmail(email)
        .then(() => { console.log("E-mail na obnovenie hesla odoslaný na:", email); alert("Odkaz na obnovenie hesla bol odoslaný na vašu e-mailovú adresu. Skontrolujte si prosím poštu (aj priečinok Spam)."); })
        .catch((error) => { console.error("Chyba pri odosielaní e-mailu na obnovenie hesla:", error); alert("Chyba pri odosielaní e-mailu na obnovenie hesla: " + error.message); });
    }
    function closeAuthForm() { authContainer.style.display = 'none'; }

    // 5. Auth State Change Listener - Nezmenené (logika z predchádzajúcej verzie)
    auth.onAuthStateChanged(user => {
        console.log("onAuthStateChanged: Stav zistený.", user ? `Používateľ: ${user.email}` : "Žiadny používateľ.");
        const wasLoggedIn = isLoggedIn;
        isLoggedIn = !!user;

        if (loadingContainer) loadingContainer.classList.add('hidden');
        calculatorContainer.style.display = "block";
        authContainer.style.display = "none";

        if (firestoreListenerUnsubscribe && (!isLoggedIn || wasLoggedIn !== isLoggedIn)) {
            console.log("Odhlasujem predchádzajúci Firestore listener.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        console.log("onAuthStateChanged: Vykonávam základnú inicializáciu UI z localStorage.");
        const storedMonth = localStorage.getItem('currentMonth');
        const storedYear = localStorage.getItem('currentYear');
        const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        const currentDate = new Date();
        if (currentMonth === undefined || currentYear === undefined || wasLoggedIn !== isLoggedIn) {
            currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
            currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
        }
        if (monthSelect.value != currentMonth) monthSelect.value = currentMonth;
        if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
             if (yearSelect.value != currentYear) yearSelect.value = currentYear;
        } else {
            console.warn(`Rok ${currentYear} z localStorage nenájdený v selecte, používam aktuálny rok.`);
            currentYear = currentDate.getFullYear(); populateYearSelect(); yearSelect.value = currentYear;
        }
        applyDarkMode(darkMode);
        hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
        taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
        decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
        employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
        if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
        if (document.activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
        if (document.activeElement !== decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces;
        if (document.activeElement !== employeeNameInput) employeeNameInput.value = employeeName;
        updateWelcomeMessage();

        console.log("onAuthStateChanged: Volanie loadFromLocalStorage pre načítanie dát dní.");
        loadFromLocalStorage();

        if (user) {
            authMessage.textContent = "Prihlásený: " + user.email;
            logoutBtn.style.display = 'block';
            logoutBtn.onclick = logout;
            logoutBtn.textContent = `Odhlásiť sa (${user.email.substring(0, user.email.indexOf('@') || 10)}...)`;
            logoutBtn.classList.remove('login-prompt'); // Odstráni zelenú triedu
            logoutBtn.classList.add('reset-btn'); // Pridá červenú triedu

            console.log("Používateľ prihlásený, nastavujem Firebase listener...");
            setupFirestoreListener();

            const uid = user.uid; const userDocRef = db.collection("users").doc(uid);
            userDocRef.get().then(userDocSnap => { if (!userDocSnap.exists) { userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true }).then(() => console.log("Vytvorený/aktualizovaný dokument pre:", uid)).catch(err => console.error("Chyba pri vytváraní/aktualizácii dokumentu používateľa:", err)); } else { console.log("Dokument používateľa existuje:", uid); } }).catch(err => { console.error("Chyba pri kontrole dokumentu používateľa (userDocRef.get):", err); showSaveNotification("Chyba pri overovaní používateľských dát", "error"); });

        } else {
            authMessage.textContent = "Nie ste prihlásený. Dáta sa ukladajú len lokálne.";
            logoutBtn.style.display = 'block';
            logoutBtn.textContent = 'Prihlásiť sa / Registrovať';
            logoutBtn.onclick = () => {
                authContainer.style.display = 'block';
                authContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };
            logoutBtn.classList.remove('reset-btn'); // Odstráni červenú triedu
            logoutBtn.classList.add('login-prompt'); // Pridá zelenú triedu
            console.log("Používateľ nie je prihlásený. Kalkulačka beží v lokálnom režime.");
        }
        applyDarkMode(document.body.classList.contains('dark-mode'));
    });


    // 6. Utility funkcie (debounce, showSaveNotification, getFirstName, updateWelcomeMessage) - Nezmenené
    function debounce(func, wait) { let timeout; return function (...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), wait); }; }
    function showSaveNotification(message, type = 'success') { const notification = document.getElementById('saveNotification'); notification.textContent = message; notification.className = 'show'; if (type === 'error') { notification.classList.add('error'); } else if (type === 'warning') { notification.classList.add('warning'); } notification.classList.add('show'); setTimeout(() => { notification.classList.remove('show'); notification.classList.remove('error'); notification.classList.remove('warning');}, 3000); }
    function getFirstName(fullName) { if (!fullName || typeof fullName !== 'string') { return ''; } const trimmedName = fullName.trim(); if (!trimmedName) { return ''; } const parts = trimmedName.split(' '); return parts[0]; }
    function updateWelcomeMessage() { const welcomeElement = document.getElementById('welcomeMessage'); if (!welcomeElement) return; const firstName = getFirstName(employeeName); if (firstName) { welcomeElement.textContent = `Vitaj späť, ${firstName}! 👋`; } else { welcomeElement.textContent = ''; } }

    // 7. Funkcia na nastavenie Firestore Listenera - Nezmenené
    function setupFirestoreListener() { /* ... kód setupFirestoreListener ... */ }

    // 8. Funkcia na ukladanie do Firebase - Nezmenené
    async function saveToFirebase() { /* ... kód saveToFirebase ... */ }

    // 9. Funkcia na ukladanie do Local Storage - Nezmenené (už obsahuje vylepšenia)
    function saveToLocalStorage() { /* ... kód saveToLocalStorage ... */ }

    // 10. Funkcia na načítanie z Local Storage - Nezmenené
    function loadFromLocalStorage() { /* ... kód loadFromLocalStorage ... */ }

    // 11. Funkcia na aktualizáciu UI - Nezmenené
    function updateUIFromLoadedData(darkModeValue) { /* ... kód updateUIFromLoadedData ... */ }

    // 12. Funkcia pre aplikovanie Dark Mode - Nezmenené
    function applyDarkMode(isDark) { /* ... kód applyDarkMode ... */ }

    // 13) Vytváranie tabuľky a súvisiace funkcie - Nezmenené (debounce čas 400ms)
    function getDayName(year, month, day) { /* ... kód getDayName ... */ }
    function createTable() { /* ... kód createTable ... */ }
    function toggleNote(day) { /* ... kód toggleNote ... */ }
    function handleNoteInput(textarea, day) { updateMonthDataFromInput(textarea, day); debouncedProcessInputCompletion(textarea.id, null); }
    function processInputCompletion(inputId, nextId) { /* ... kód processInputCompletion ... */ }
    const debouncedProcessInputCompletion = debounce(processInputCompletion, 400); // Stále 400ms
    function isTimeValid(timeStr) { /* ... kód isTimeValid ... */ }
    function handleInput(input, nextId, day) { formatInput(input); updateMonthDataFromInput(input, day); calculateRow(day); debouncedProcessInputCompletion(input.id, nextId); }
    function handleBreakInput(day) { /* ... kód handleBreakInput ... */ }
    function updateMonthDataFromInput(input, day) { /* ... kód updateMonthDataFromInput ... */ }
    function formatInput(input) { /* ... kód formatInput ... */ }
    function moveNext(currentElement, nextId) { /* ... kód moveNext ... */ }
    function calculateRow(day) { /* ... kód calculateRow ... */ }
    function resetRow(day) { /* ... kód resetRow ... */ }
    function resetAll() { /* ... kód resetAll ... */ }

    // 14) Výpočet celkových súčtov - Nezmenené
    function calculateTotal() { /* ... kód calculateTotal ... */ }

    // 15) Export do PDF (exportToPDF, sendPDF) - Nezmenené
    function exportToPDF() { /* ... kód exportToPDF ... */ }
    function sendPDF() { /* ... kód sendPDF ... */ }

    // 16) Ostatné nastavenia - Nezmenené
    function changeDecimalPlaces() { /* ... kód changeDecimalPlaces ... */ }
    function updateEmployeeName() { /* ... kód updateEmployeeName ... */ }
    function updateSettings() { /* ... kód updateSettings ... */ }
    function changeMonth() { /* ... kód changeMonth ... */ }
    function changeYear() { /* ... kód changeYear ... */ }
    function handleMonthYearChange() { /* ... kód handleMonthYearChange ... */ }
    function getDaysInMonth(month) { /* ... kód getDaysInMonth ... */ }
    function getMonthName(month) { /* ... kód getMonthName ... */ }
    function updateDataSize() { /* ... kód updateDataSize ... */ }
    function toggleDarkMode() { /* ... kód toggleDarkMode ... */ }

    // 17) Zálohovanie a obnova - Nezmenené
    function createBackup() { /* ... kód createBackup ... */ }
    function restoreBackup() { /* ... kód restoreBackup ... */ }

    // 18) Inicializácia - Nezmenené (už obsahuje listenery pre ukladanie)
     document.addEventListener('DOMContentLoaded', () => {
         console.log("DOM načítaný, inicializujem...");
         populateYearSelect();

         document.addEventListener('visibilitychange', () => {
             if (document.visibilityState === 'hidden') {
                 console.log("Stránka skrytá (visibilitychange), vynucujem uloženie...");
                 saveToLocalStorage();
             }
         });
         window.addEventListener('pagehide', (event) => {
             console.log("Opustenie stránky (pagehide), vynucujem uloženie...");
             saveToLocalStorage();
         });

         if ('serviceWorker' in navigator) {
             window.addEventListener('load', () => {
                 navigator.serviceWorker.register('./service-worker.js')
                     .then(registration => { console.log('ServiceWorker zaregistrovaný s rozsahom: ', registration.scope); })
                     .catch(error => { console.error('Registrácia ServiceWorker zlyhala: ', error); });
             });
         } else { console.warn("Service Worker nie je podporovaný v tomto prehliadači."); }

         console.log("Základná inicializácia dokončená, čakám na stav prihlásenia Firebase...");
     });
     function populateYearSelect() { const startYear = 2020; const endYear = new Date().getFullYear() + 2; yearSelect.innerHTML = ''; for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); } }

  </script>
</body>
</html>
