<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruno's Calculator s Firebase v9</title>
    <link rel="manifest" href="manifest.json"> <meta name="theme-color" content="#4CAF50">

    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

   <style>

    /* CSS štýly zostávajú rovnaké */

    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }

    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }

    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }

    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }

    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }

    .settings {

        margin-bottom: 20px;

        display: flex;

        flex-wrap: wrap;

        justify-content: space-between;

        align-items: flex-start; /* Zmenené na flex-start pre lepšie zarovnanie s details */

        gap: 10px; /* Pridaný gap pre medzery */

    }

    /* Priame deti .settings (div, details, button) */

    .settings > div,

    .settings > details,

    .settings > button {

        flex: 1 1 200px; /* Zachovanie flex basis */

        margin: 0; /* Odstránený margin, používame gap */

    }

    .settings label { display: block; margin-bottom: 5px; }

    .table-container { overflow-x: auto; }

    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 950px; /* Mierne zväčšená min-width kvôli ikonám */ }

    th, td {

        padding: 8px;

        border: 1px solid #ddd;

        text-align: left;

        font-size: 0.9em;

        vertical-align: top; /* Zarovnaj obsah buniek hore */

        position: relative; /* Pozicovanie pre ikony */

    }

    th { background-color: #f2f2f2; }

    input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea /* Pridaný select a .note-textarea */ {

        width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px;

    }

    /* Úprava paddingu pre tel inputy kvôli ikone */

    input[type="tel"] {

        padding-right: 28px; /* Priestor pre ikonu */

    }

    /* Štýly pre ikonu hodín */

    .time-icon {

        position: absolute;

        right: 8px; /* Odsadenie od pravého okraja bunky */

        top: 50%;

        transform: translateY(-50%); /* Vertikálne centrovanie */

        cursor: pointer;

        font-size: 1.2em; /* Veľkosť ikony */

        color: #555; /* Farba ikony */

        user-select: none; /* Zabráni označeniu textu ikony */

        z-index: 2; /* Aby bola nad inputom, ak by sa prekrývali */

    }

    .time-icon:hover {

        color: #007bff; /* Zmena farby pri prejdení myšou */

        opacity: 0.8;

    }

    body.dark-mode .time-icon {

        color: #bbb; /* Svetlejšia ikona v tmavom režime */

    }

    body.dark-mode .time-icon:hover {

        color: #87cefa; /* Svetlomodrá pri hover v tmavom režime */

    }



    /* --- NOVÉ: Štýly pre ikonu indikátora poznámky --- */

     .note-indicator-icon {

        display: none; /* Štandardne skryté */

        font-size: 0.9em; /* Trochu menšie */

        margin-right: 4px; /* Medzera pred tlačidlom */

        color: #28a745; /* Zelená pre indikáciu */

        vertical-align: middle; /* Zarovnanie s textom tlačidla */

        cursor: default; /* Nie je klikateľná */

     }

     body.dark-mode .note-indicator-icon {

         color: #6fbf7a; /* Svetlejšia zelená v tmavom režime */

     }

    /* --- KONIEC nových štýlov pre ikonu indikátora --- */





    /* Uprav šírky stĺpcov podľa potreby */

    th:nth-child(1), td:nth-child(1) { min-width: 50px; } /* Deň */

    th:nth-child(2), td:nth-child(2) { min-width: 90px; } /* Príchod */

    th:nth-child(3), td:nth-child(3) { min-width: 90px; } /* Odchod */

    th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* Prestávka */

    th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* Odpracované */

    th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* Hrubá Mzda */

    th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* Čistá Mzda */

    th:nth-child(8), td:nth-child(8) { min-width: 130px; } /* Poznámka - mierne širší kvôli ikone */

    th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia */



    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }

    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }

    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }

    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }

    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }

    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }

    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }

    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }

    #dataSizeContainer { margin-top: 10px; text-align: center; }

    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }

    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }

    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }

    .current-day { background-color: #8a2be2; color: white; }

    .current-day input, .current-day .note-textarea /* Pridané .note-textarea pre current-day */ { background-color: #9932cc; color: white; }

    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }

    body.dark-mode { background-color: #333; color: #f4f4f4; }

    .container.dark-mode { background-color: #444; color: #f4f4f4; }

    table.dark-mode { background-color: #555; color: #f4f4f4; }

    th.dark-mode { background-color: #666; }

    td.dark-mode { background-color: #444; color: #f4f4f4; }

    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode /* Pridaný select a .note-textarea */ {

        background-color: #666; color: white; border-color: #888; /* Pridaná farba okraja pre dark mode */

    }

    .btn.dark-mode { color: #333; }

    .reset-btn.dark-mode { background-color: #d32f2f; }

    .export-btn.dark-mode { background-color: #388e3c; }

    .restore-btn.dark-mode { background-color: #7B1FA2; }

    .backup-btn.dark-mode { background-color: #E68900; }

    #totalSalary.dark-mode { background-color: #2c3e50; }

    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }

    .current-day.dark-mode input, .current-day.dark-mode .note-textarea /* Pridané .note-textarea pre current-day dark mode */ { background-color: #5c1db3; color: #fff; }

    body.dark-mode .autor-info { color: #aaa; }

    #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }

    #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }

    #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }

    #auth-container button:hover { background-color: #45a049; }

    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }

    #saveNotification.show { display: block; opacity: 1; }

    #saveNotification.error { background-color: #f44336; }

    #saveNotification.warning { background-color: #ff9800; }

    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }

    #loading-container.hidden { opacity: 0; pointer-events: none; }

    #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }

    #forgot-password-link:hover { text-decoration: underline; }



    /* --- ŠTÝLY PRE ZBALITEĽNÚ ČASŤ (nezmenené) --- */

    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }

    .collapsible-settings summary:hover { background-color: #eee; }

    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }

    .collapsible-content > div { flex: 1 1 200px; margin: 0; }

    body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }

    body.dark-mode .collapsible-settings summary:hover { background-color: #666; }

    body.dark-mode .collapsible-content { border-top-color: #666; }



    /* --- ŠTÝLY PRE POZNÁMKY --- */

    .note-container {

        display: none; /* Štandardne skryté */

        margin-top: 5px;

    }

    .note-container.visible {

        display: block; /* Zobrazené po kliknutí alebo načítaní */

    }

    .note-textarea {

        width: 95%; /* Trochu menšia šírka kvôli paddingu bunky */

        min-height: 40px; /* Minimálna výška */

        resize: vertical; /* Povoliť len vertikálnu zmenu veľkosti */

        box-sizing: border-box;

        padding: 5px;

        border: 1px solid #ccc;

        border-radius: 3px;

        font-size: 13px; /* Trochu menšie písmo pre poznámky */

        background-color: #f0f0f0; /* Svetlé pozadie pre odlíšenie */

        /* Dedi vlastnosti z nadradeného pravidla pre inputy */

    }

    .toggle-note-btn {

        background-color: #6c757d; /* Šedá farba */

        color: white;

        padding: 3px 8px; /* Menší padding */

        border: none;

        border-radius: 3px;

        cursor: pointer;

        font-size: 12px; /* Menšie písmo */

        transition: background-color 0.2s ease;

        margin-bottom: 2px; /* Malý odstup od textarea, ak je viditeľná */

        vertical-align: middle; /* Zarovnanie s ikonou */

    }

    .toggle-note-btn:hover {

        background-color: #5a6268;

    }

    /* Dark mode pre poznámky */

    .note-textarea.dark-mode {

        background-color: #555;

        color: #f4f4f4;

        border-color: #777;

    }

    .toggle-note-btn.dark-mode {

        background-color: #828a91;

    }

    .toggle-note-btn.dark-mode:hover {

        background-color: #70777d;

    }

    /* --- KONIEC ŠTÝLOV PRE POZNÁMKY --- */



  </style>
        body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
        .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
        h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
        h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
        .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .settings > div, .settings > details, .settings > button { flex: 1 1 200px; margin: 0; }
        .settings label { display: block; margin-bottom: 5px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 950px; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; position: relative; }
        th { background-color: #f2f2f2; }
        input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
        input[type="tel"] { padding-right: 28px; }
        .time-icon { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2em; color: #555; user-select: none; z-index: 2; }
        .time-icon:hover { color: #007bff; opacity: 0.8; }
        .note-indicator-icon { display: none; font-size: 0.9em; margin-right: 4px; color: #28a745; vertical-align: middle; cursor: default; }
        th:nth-child(1), td:nth-child(1) { min-width: 50px; } /* Deň */
        th:nth-child(2), td:nth-child(2) { min-width: 90px; } /* Príchod */
        th:nth-child(3), td:nth-child(3) { min-width: 90px; } /* Odchod */
        th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* Prestávka */
        th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* Odpracované */
        th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* Hrubá Mzda */
        th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* Čistá Mzda */
        th:nth-child(8), td:nth-child(8) { min-width: 130px; } /* Poznámka */
        th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia */
        .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
        .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
        .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
        .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
        .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
        .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
        .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
        #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
        #dataSizeContainer { margin-top: 10px; text-align: center; }
        #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
        #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
        #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
        .current-day { background-color: #8a2be2; color: white; }
        .current-day input, .current-day .note-textarea { background-color: #9932cc; color: white; }
        @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
        body.dark-mode { background-color: #333; color: #f4f4f4; }
        .container.dark-mode { background-color: #444; color: #f4f4f4; }
        table.dark-mode { background-color: #555; color: #f4f4f4; }
        th.dark-mode { background-color: #666; }
        td.dark-mode { background-color: #444; color: #f4f4f4; }
        input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode { background-color: #666; color: white; border-color: #888; }
        .btn.dark-mode { color: #333; }
        .reset-btn.dark-mode { background-color: #d32f2f; }
        .export-btn.dark-mode { background-color: #388e3c; }
        .restore-btn.dark-mode { background-color: #7B1FA2; }
        .backup-btn.dark-mode { background-color: #E68900; }
        #totalSalary.dark-mode { background-color: #2c3e50; }
        .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
        .current-day.dark-mode input, .current-day.dark-mode .note-textarea { background-color: #5c1db3; color: #fff; }
        body.dark-mode .autor-info { color: #aaa; }
        #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
        #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
        #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
        #auth-container button:hover { background-color: #45a049; }
        #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
        #saveNotification.show { display: block; opacity: 1; }
        #saveNotification.error { background-color: #f44336; }
        #saveNotification.warning { background-color: #ff9800; }
        #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
        #loading-container.hidden { opacity: 0; pointer-events: none; }
        #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
        #forgot-password-link:hover { text-decoration: underline; }
        .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
        .collapsible-settings summary:hover { background-color: #eee; }
        .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
        .collapsible-content > div { flex: 1 1 200px; margin: 0; }
        body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
        body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
        body.dark-mode .collapsible-content { border-top-color: #666; }
        .note-container { display: none; margin-top: 5px; }
        .note-container.visible { display: block; }
        .note-textarea { width: 95%; min-height: 40px; resize: vertical; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; background-color: #f0f0f0; }
        .toggle-note-btn { background-color: #6c757d; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease; margin-bottom: 2px; vertical-align: middle; }
        .toggle-note-btn:hover { background-color: #5a6268; }
        .note-textarea.dark-mode { background-color: #555; color: #f4f4f4; border-color: #777; }
        .toggle-note-btn.dark-mode { background-color: #828a91; }
        .toggle-note-btn.dark-mode:hover { background-color: #70777d; }
        body.dark-mode .time-icon { color: #bbb; }
        body.dark-mode .time-icon:hover { color: #87cefa; }
        body.dark-mode .note-indicator-icon { color: #6fbf7a; }

    </style>
</head>
<body>
    <div id="loading-container"><h1>Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte, dosiahnete všetko.</h1></div>

    <div id="auth-container" style="display:none;">
        <h1>Prihlásenie / Registrácia</h1>
        <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
        <div id="auth-forms">
            <h2>Registrácia</h2>
            <input type="email" id="registerEmail" placeholder="Email">
            <input type="password" id="registerPassword" placeholder="Heslo">
            <button onclick="register()">Registrovať</button>
            <h2>Prihlásenie</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Heslo">
            <button onclick="login()">Prihlásiť sa</button>
            <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
        </div>
    </div>

    <div id="calculator-container" class="container" style="display:none;">
        <div class="autor-info">Vytvoril Bruno</div>
        <h1 id="mainTitle">Bruno's Calculator</h1>
        <h2 id="welcomeMessage"></h2>
        <div class="settings">
            <div>
                <label for="monthSelect">Mesiac: </label>
                <select id="monthSelect" onchange="changeMonth()">
                    <option value="0">Január</option> <option value="1">Február</option> <option value="2">Marec</option>
                    <option value="3">Apríl</option> <option value="4">Máj</option> <option value="5">Jún</option>
                    <option value="6">Júl</option> <option value="7">August</option> <option value="8">September</option>
                    <option value="9">Október</option> <option value="10">November</option> <option value="11">December</option>
                </select>
            </div>

            <details class="collapsible-settings">
                <summary>Ďalšie nastavenia</summary>
                <div class="collapsible-content">
                    <div>
                        <label for="employeeNameInput">Meno pracovníka: </label>
                        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
                    </div>
                    <div>
                        <label for="hourlyWageInput">Hodinová mzda (€): </label>
                        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
                    </div>
                    <div>
                        <label for="taxRateInput">Daňové percento (%): </label>
                        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
                    </div>
                    <div>
                        <label for="yearSelect">Rok: </label>
                        <select id="yearSelect" onchange="changeYear()"></select>
                    </div>
                    <div>
                        <label for="decimalPlacesSelect">Počet desatinných miest: </label>
                        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                            <option value="1">1</option>
                            <option value="2" selected>2</option> </select>
                    </div>
                </div>
            </details>

            <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka</th>
                        <th>Odpracované</th><th>Hrubá Mzda (€)</th><th>Čistá Mzda (€)</th>
                        <th class="th-note">Poznámka</th><th>Akcia</th>
                    </tr>
                </thead>
                <tbody id="workDays"></tbody>
            </table>
        </div>
        <div id="totalSalary"></div>
        <div id="dataSizeContainer">
            <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
            <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
        </div>
        <div class="btn-container">
            <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
            <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
            <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
            <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu (JSON)</button>
            <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu (JSON)</button>
            <button id="logout-btn" class="btn reset-btn" onclick="logout()" style="display: none;">Odhlásiť sa</button>
        </div>
    </div>
    <div id="saveNotification"></div>

    <script type="module">
        // --- Firebase v9+ Importy ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, enableIndexedDbPersistence, doc, getDoc, setDoc, onSnapshot, serverTimestamp, collection, deleteDoc /* Prípadne potrebné pre reset */ } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check.js";

        // --- Firebase Konfigurácia (z vášho prvého kódu) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", // <-- Kľúč z V1
            authDomain: "bruno-3cee2.firebaseapp.com",      // <-- Doména z V1
            projectId: "bruno-3cee2",                       // <-- ProjectID z V1
            storageBucket: "bruno-3cee2.appspot.com",       // <-- Storage Bucket z V1
            messagingSenderId: "155545319308",              // <-- SenderID z V1
            appId: "1:155545319308:web:5da498ff1cd3e1833888a9" // <-- AppID z V1
        };

        // --- Firebase Inicializácia ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // App Check Inicializácia (nahraďte kľúčom!)
        try {
            initializeAppCheck(app, {
                provider: new ReCaptchaV3Provider('YOUR_RECAPTCHA_V3_SITE_KEY'), // <-- NAHRAĎTE VAŠÍM KĽÚČOM!
                isTokenAutoRefreshEnabled: true
            });
            console.log("Firebase App Check initialized.");
        } catch (error) {
            console.warn("Firebase App Check failed to initialize:", error);
        }

        // Povolenie Firestore Offline Persistence
        enableIndexedDbPersistence(db)
            .then(() => {
                console.log("Firestore offline persistence enabled.");
            })
            .catch((err) => {
                console.error("Firestore offline persistence error:", err);
                if (err.code == 'failed-precondition') {
                    console.warn("Firestore offline persistence: Multiple tabs open, persistence can only be enabled in one tab at a time.");
                } else if (err.code == 'unimplemented') {
                    console.error("Firestore offline persistence: The current browser does not support all of the features required to enable persistence.");
                }
            });

        // --- Globálne Premenné (z vášho prvého kódu) ---
        let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
        let monthData = {}; // Dôležité pre ukladanie dát vrátane poznámok
        let firestoreListenerUnsubscribe = null;
        let currentUser = null; // Na uchovanie aktuálne prihláseného používateľa

        const workDays = document.getElementById('workDays');
        const totalSalaryDiv = document.getElementById('totalSalary');
        const dataSizeText = document.getElementById('dataSizeText');
        const dataSizeFill = document.getElementById('dataSizeFill');
        const hourlyWageInput = document.getElementById('hourlyWageInput');
        const taxRateInput = document.getElementById('taxRateInput');
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
        const employeeNameInput = document.getElementById('employeeNameInput');
        const logoutBtn = document.getElementById('logout-btn');
        const MAX_DATA_SIZE = 4 * 1024 * 1024; // 4MB limit pre localStorage
        const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

        // --- Pomocné Funkcie (väčšinou z V1 kódu) ---
        function showSaveNotification(message, type = 'success') {
            const notification = document.getElementById('saveNotification');
            if (!notification) return;
            notification.textContent = message;
            notification.className = 'show'; // Reset class
            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            }
            notification.classList.add('show'); // Ensure 'show' is added
            setTimeout(() => {
                notification.classList.remove('show');
                // Ensure specific type classes are also removed if needed
                notification.classList.remove('error', 'warning');
            }, 3000);
        }

        function getFirstName(fullName) {
            if (!fullName || typeof fullName !== 'string') return '';
            const trimmedName = fullName.trim();
            if (!trimmedName) return '';
            const parts = trimmedName.split(' ');
            return parts[0];
        }

        function updateWelcomeMessage() {
            const welcomeElement = document.getElementById('welcomeMessage');
            if (!welcomeElement) return;
            const firstName = getFirstName(employeeName);
            welcomeElement.textContent = firstName ? `Vitaj späť, ${firstName}! 👋` : '';
        }

        // --- Auth Funkcie (prepísané na v9) ---
        window.register = async () => { // Priradenie k window pre onclick v HTML
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Voliteľne vytvor užívateľský dokument hneď po registrácii
                const userDocRef = doc(db, "users", userCredential.user.uid);
                await setDoc(userDocRef, { email: userCredential.user.email, createdAt: new Date().toISOString() }, { merge: true });
                alert("Registrácia úspešná!");
            } catch (error) {
                console.error("Chyba pri registrácii:", error);
                showSaveNotification("Chyba pri registrácii: " + error.message, "error");
                alert("Chyba pri registrácii: " + error.message); // Ponechaný alert pre priamu spätnú väzbu
            }
        }

        window.login = async () => { // Priradenie k window pre onclick v HTML
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                 alert("Prihlásenie úspešné!"); // Ponechaný alert
            } catch (error) {
                console.error("Chyba pri prihlásení:", error);
                showSaveNotification("Chyba pri prihlásení: " + error.message, "error");
                 alert("Chyba pri prihlásení: " + error.message); // Ponechaný alert
            }
        }

        window.logout = async () => { // Priradenie k window pre onclick v HTML
            try {
                await signOut(auth);
                // alert("Odhlásenie úspešné!"); // Alert nie je nutný, UI sa zmení
            } catch (error) {
                console.error("Chyba pri odhlásení:", error);
                showSaveNotification("Chyba pri odhlásení: " + error.message, "error");
                alert("Chyba pri odhlásení: " + error.message);
            }
        }

        window.forgotPassword = async () => { // Priradenie k window pre onclick v HTML
            const emailInput = document.getElementById('loginEmail');
            const email = emailInput.value;
            if (!email) {
                alert("Prosím, zadajte svoju e-mailovú adresu do poľa pre prihlásenie.");
                emailInput.focus();
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                alert("Odkaz na obnovenie hesla bol odoslaný na vašu e-mailovú adresu. Skontrolujte si prosím poštu (aj priečinok Spam).");
            } catch (error) {
                console.error("Chyba pri odosielaní e-mailu na obnovenie hesla:", error);
                showSaveNotification("Chyba pri odosielaní e-mailu na obnovenie hesla: " + error.message, "error");
                alert("Chyba pri odosielaní e-mailu na obnovenie hesla: " + error.message);
            }
        }

        // --- Auth State Change Listener (prepísaný na v9) ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user; // Uloženie aktuálneho používateľa
            const authContainer = document.getElementById('auth-container');
            const calculatorContainer = document.getElementById('calculator-container');
            const loadingContainer = document.getElementById('loading-container');

            if (loadingContainer) loadingContainer.classList.add('hidden');

            // Odpojenie predchádzajúceho listenera, ak existuje
            if (firestoreListenerUnsubscribe) {
                firestoreListenerUnsubscribe();
                firestoreListenerUnsubscribe = null;
                console.log("Previous Firestore listener unsubscribed.");
            }

            if (user) {
                // Používateľ prihlásený
                document.getElementById('auth-message').textContent = "Prihlásený: " + user.email;
                authContainer.style.display = "none";
                calculatorContainer.style.display = "block";
                logoutBtn.style.display = "inline-block"; // Zobraz logout tlačidlo

                // Načítanie posledného stavu z localStorage (rovnaké ako V1)
                const storedMonth = localStorage.getItem('currentMonth');
                const storedYear = localStorage.getItem('currentYear');
                const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                const currentDate = new Date();

                currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();

                // Overenie a nastavenie selectov (rovnaké ako V1)
                monthSelect.value = currentMonth;
                if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                    yearSelect.value = currentYear;
                } else {
                    console.warn(`Rok ${currentYear} z localStorage nenájdený v selecte, používam aktuálny rok.`);
                    currentYear = currentDate.getFullYear();
                    populateYearSelect(); // Znovu naplní select, ak by rok chýbal
                    yearSelect.value = currentYear;
                }

                applyDarkMode(darkMode); // Aplikuj tmavý režim

                // Načítanie ostatných nastavení z localStorage (rovnaké ako V1)
                hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
                decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2; // Default 2
                employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

                hourlyWageInput.value = hourlyWage;
                taxRateInput.value = taxRate * 100;
                decimalPlacesSelect.value = decimalPlaces;
                employeeNameInput.value = employeeName;

                loadFromLocalStorage(); // Prvé načítanie UI z localStorage

                setupFirestoreListener(); // Nastavenie listenera pre real-time dáta

                // Kontrola / vytvorenie užívateľského dokumentu vo Firestore (v9 syntax)
                const userDocRef = doc(db, "users", user.uid);
                 getDoc(userDocRef).then(userDocSnap => {
                    if (!userDocSnap.exists()) {
                        setDoc(userDocRef, { email: user.email, createdAt: new Date().toISOString() }, { merge: true })
                            .catch(err => console.error("Chyba pri vytváraní dokumentu používateľa:", err));
                    }
                }).catch(err => {
                    console.error("Chyba pri kontrole dokumentu používateľa (getDoc):", err);
                    showSaveNotification("Chyba pri overovaní používateľských dát", "error");
                });

            } else {
                // Používateľ odhlásený
                currentUser = null; // Vymaž používateľa
                document.getElementById('auth-message').textContent = "Žiadny používateľ nie je prihlásený.";
                authContainer.style.display = "block";
                calculatorContainer.style.display = "none";
                logoutBtn.style.display = "none"; // Skry logout tlačidlo

                // Vyčistenie dát pri odhlásení
                monthData = {};
                workDays.innerHTML = '';
                totalSalaryDiv.innerHTML = '';
                updateWelcomeMessage(); // Skryje uvítanie
            }
        });

        // --- Firestore Listener (prepísaný na v9) ---
        function setupFirestoreListener() {
            if (firestoreListenerUnsubscribe) { // Odpojenie existujúceho
                 firestoreListenerUnsubscribe();
                 firestoreListenerUnsubscribe = null;
                 console.log("Existing Firestore listener detached before setting up new one.");
            }
            if (!currentUser) {
                console.log("No user logged in, cannot setup Firestore listener.");
                return;
            }
            const uid = currentUser.uid;

            if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                const now = new Date();
                currentMonth = currentMonth ?? now.getMonth();
                currentYear = currentYear ?? now.getFullYear();
                console.warn("setupFirestoreListener: Missing month/year. Using current.", currentYear, currentMonth);
            }

            const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
            const docRef = doc(db, docPath);
            console.log(`Setting up Firestore listener for path: ${docPath}`);

            firestoreListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                console.log("Firestore snapshot received. Source:", docSnap.metadata.fromCache ? "cache" : "server", "Pending writes:", docSnap.metadata.hasPendingWrites);
                const hasPending = docSnap.metadata.hasPendingWrites;
                const activeElementId = document.activeElement?.id; // Aktívne fokusovaný element

                // ---- Logika spracovania snapshotu zostáva veľmi podobná V1 kódu ----
                // ---- Hlavný rozdiel je, ako sa pristupuje k dátam (`docSnap.data()`, `docSnap.exists()`) ----

                 if (hasPending) {
                     // Lokálny zápis - len aktualizujeme interný stav `monthData`, neprepisujeme UI inputy
                     console.log("Processing pending write snapshot.");
                     if (docSnap.exists()) {
                         const data = docSnap.data();
                         const firebaseDaysData = data.days || [];
                         if (!monthData) monthData = {};
                         if (!monthData[currentYear]) monthData[currentYear] = {};
                         // Uchováme stav poznámok
                         monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                             start: day.start || '',
                             end: day.end || '',
                             breakTime: day.breakTime || '',
                             note: day.note || '',
                             noteVisible: day.noteVisible === true // Zachováme boolean
                         }));
                     }
                     // Neprekresľujeme UI z pending writes, aby sme neprepisovali práve menené pole
                     return;
                 }

                // Dáta zo servera alebo cache (bez lokálnych zmien)
                if (docSnap.exists()) {
                    console.log("Processing server/cache snapshot.");
                    const data = docSnap.data();
                    try {
                        // Načítaj nastavenia z Firebase (rovnaká logika ako V1)
                        const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
                        const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
                        const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
                        const firebaseEmployeeName = data.employeeName ?? employeeName;
                        const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');
                        const firebaseDaysData = data.days || [];

                        // Aktualizuj globálne premenné (rovnaká logika ako V1)
                        hourlyWage = firebaseHourlyWage;
                        taxRate = firebaseTaxRatePercent / 100;
                        decimalPlaces = firebaseDecimalPlaces;
                        employeeName = firebaseEmployeeName;

                        // Aktualizuj UI nastavení (okrem fokusovaných) - rovnaká logika ako V1
                        if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
                        if (document.activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
                        decimalPlacesSelect.value = decimalPlaces;
                        if (document.activeElement !== employeeNameInput) employeeNameInput.value = employeeName;

                        // Priprav monthData na základe Firebase (rovnaká logika ako V1 vrátane noteVisible)
                        if (!monthData) monthData = {};
                        if (!monthData[currentYear]) monthData[currentYear] = {};
                        monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                             start: day.start || '', end: day.end || '', breakTime: day.breakTime || '',
                             note: day.note || '', noteVisible: day.noteVisible === true
                        }));

                        // OPTIMALIZOVANÁ AKTUALIZÁCIA UI RIADKOV (rovnaká logika ako V1)
                        const daysInMonth = getDaysInMonth(currentMonth);
                        let anyRowRecalculated = false;

                        for (let i = 1; i <= daysInMonth; i++) {
                            const dayIndex = i - 1;
                            const firebaseDayData = monthData[currentYear]?.[currentMonth]?.[dayIndex] || { start: '', end: '', breakTime: '', note: '', noteVisible: false };
                            const baseId = `${currentYear}-${currentMonth}-${i}`;
                            const startId = `start-${baseId}`; const endId = `end-${baseId}`; const breakId = `break-${baseId}`;
                            const noteId = `note-${baseId}`; const noteContainerId = `note-container-${baseId}`;
                            const noteButtonId = `note-toggle-${baseId}`; const noteIndicatorId = `note-indicator-${baseId}`;

                            const startElement = document.getElementById(startId);
                            const endElement = document.getElementById(endId);
                            const breakElement = document.getElementById(breakId);
                            const noteElement = document.getElementById(noteId);
                            const noteContainer = document.getElementById(noteContainerId);
                            const noteButton = document.getElementById(noteButtonId);
                            const noteIndicator = document.getElementById(noteIndicatorId);

                            if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
                                const newStart = firebaseDayData.start || ''; const newEnd = firebaseDayData.end || '';
                                const newBreak = firebaseDayData.breakTime || ''; const newNote = firebaseDayData.note || '';
                                const newNoteVisible = firebaseDayData.noteVisible === true;
                                let rowUpdatedByListener = false;

                                // Aktualizuj len ak nie je fokus a hodnota sa líši
                                if (startElement.value !== newStart && activeElementId !== startId) { startElement.value = newStart; rowUpdatedByListener = true; }
                                if (endElement.value !== newEnd && activeElementId !== endId) { endElement.value = newEnd; rowUpdatedByListener = true; }
                                if (breakElement.value !== newBreak && activeElementId !== breakId) { breakElement.value = newBreak; rowUpdatedByListener = true; }
                                if (noteElement.value !== newNote && activeElementId !== noteId) {
                                    noteElement.value = newNote;
                                    updateNoteIndicator(i); // Aktualizuj indikátor
                                }

                                // Aktualizuj viditeľnosť poznámky
                                const currentNoteVisible = noteContainer.classList.contains('visible');
                                if (currentNoteVisible !== newNoteVisible) {
                                    noteContainer.classList.toggle('visible', newNoteVisible);
                                    noteButton.textContent = newNoteVisible ? 'Skryť' : 'Poznámka';
                                }

                                if (rowUpdatedByListener) {
                                    calculateRow(i); anyRowRecalculated = true;
                                }
                            }
                        } // Koniec for cyklu

                        if (anyRowRecalculated) calculateTotal();
                        applyDarkMode(firebaseDarkMode); // Aplikuj dark mode z Firebase
                        updateWelcomeMessage();
                        updateDataSize();

                        // Notifikácia len ak dáta prišli zo servera (nie z cache počas offline)
                        if (!docSnap.metadata.fromCache) {
                            showSaveNotification("Dáta synchronizované");
                        }

                    } catch (processError) {
                        console.error(`Listener: Chyba pri spracovaní dát z Firestore pre ${currentYear}-${currentMonth}:`, processError);
                        showSaveNotification("Chyba: Nesprávny formát dát z Firebase", "error");
                    }
                } else {
                    // Dokument neexistuje vo Firestore
                    console.log(`Document ${docPath} does not exist in Firestore.`);
                    if (!monthData) monthData = {};
                    if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = []; // Prázdne pole pre daný mesiac

                    // Ulož prázdne dáta do localStorage, aby sme neťahali staré
                    localStorage.setItem('workDaysData', JSON.stringify(monthData));

                    // Načítaj nastavenia z localStorage (alebo default) a prekresli UI
                     loadFromLocalStorage(); // Toto zavolá createTable a ďalšie funkcie
                    // showSaveNotification("Žiadne dáta v cloude pre tento mesiac.", "warning");
                }

            }, (error) => {
                console.error(`Firestore listener ERROR for ${docPath}:`, error);
                showSaveNotification("Chyba: Nepodarilo sa pripojiť k Firebase", "error");
                // V prípade chyby listenera skúsime načítať aspoň lokálne dáta
                loadFromLocalStorage();
            });
            console.log(`Firestore listener attached for path: ${docPath}`);
        }

        // --- Ukladanie do Firebase (prepísané na v9) ---
        async function saveToFirebase() {
            if (!currentUser) {
                console.log("Cannot save to Firebase, no user logged in.");
                return;
            }
            const uid = currentUser.uid;
            const yearMonthDoc = `${currentYear}-${currentMonth}`;
            const docRef = doc(db, "users", uid, "calculatorData", yearMonthDoc);

            try {
                // Získanie aktuálnych dát vrátane poznámok (rovnaká logika ako V1)
                 const currentMonthWorkData = ((monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []).map(day => ({
                    start: day.start || '',
                    end: day.end || '',
                    breakTime: day.breakTime || '',
                    note: day.note || '',
                    noteVisible: day.noteVisible === true // Uloží boolean
                }));

                 const dataToSave = {
                    days: currentMonthWorkData,
                    hourlyWage: hourlyWage || 10,
                    taxRate: (taxRate * 100) || 2, // Ukladáme ako percento
                    decimalPlaces: decimalPlaces || 2,
                    employeeName: employeeName || '',
                    darkMode: document.body.classList.contains('dark-mode'),
                    timestamp: serverTimestamp() // Použijeme serverový timestamp
                };

                console.log(`Saving data to Firebase for ${yearMonthDoc}...`);
                await setDoc(docRef, dataToSave); // setDoc prepíše celý dokument
                console.log(`Data saved successfully to Firebase for ${yearMonthDoc}.`);
                // Notifikácia sa zobrazí v listeneri, keď sa dáta vrátia zo servera

            } catch (error) {
                console.error(`Chyba pri požiadavke na ukladanie do Firebase pre ${yearMonthDoc}:`, error);
                showSaveNotification("Chyba: Nepodarilo sa odoslať dáta do Firebase", "error");
            }
        }

        // --- Ukladanie do Local Storage (logika z V1, volá saveToFirebase) ---
        function saveToLocalStorage() {
            try {
                if (!monthData) monthData = {};
                if (!monthData[currentYear]) monthData[currentYear] = {};
                if (!monthData[currentYear][currentMonth]) { monthData[currentYear][currentMonth] = []; }

                // Ulož nastavenia
                localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); // Ukladáme ako percento
                localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
                localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                localStorage.setItem('employeeName', JSON.stringify(employeeName));
                localStorage.setItem('currentMonth', currentMonth.toString());
                localStorage.setItem('currentYear', currentYear.toString());

                // Uloží celé monthData, ktoré obsahuje aj poznámky a ich viditeľnosť
                const serializedMonthData = JSON.stringify(monthData);
                const bytes = new Blob([serializedMonthData]).size;

                // Kontrola veľkosti (rovnaká ako V1)
                if (bytes > MAX_DATA_SIZE * 0.9) { console.warn(`Veľkosť dát ('workDaysData') v localStorage sa blíži k limitu: ${bytes} bajtov`); }
                if (bytes > MAX_DATA_SIZE) {
                    alert(`Prekročili ste maximálnu veľkosť dát (~${MAX_DATA_SIZE_KB} KB) pre dáta mesiacov v localStorage. Ukladanie zlyhalo.`);
                    showSaveNotification("Chyba: Lokálne dáta sú príliš veľké!", "error");
                    return;
                }
                localStorage.setItem('workDaysData', serializedMonthData);
                updateDataSize();

                // --- VOLANIE ULOŽENIA DO FIREBASE ---
                 saveToFirebase(); // Odoslanie aktuálneho stavu do Firebase

                if (!navigator.onLine) {
                    showSaveNotification("Offline: Zmeny uložené lokálne", "warning");
                }
            } catch (error) {
                console.error('Chyba pri ukladaní (lokálne/spustení Firebase save):', error);
                showSaveNotification("Kritická chyba pri ukladaní!", "error");
            }
        }

        // Debounce verzia pre častejšie volania
        const debouncedSaveToLocalStorage = debounce(saveToLocalStorage, 1500); // Uloží 1.5s po poslednej zmene

        // --- Načítanie z Local Storage (logika z V1) ---
        function loadFromLocalStorage() {
            try {
                // Zistenie aktuálneho mesiaca/roka, ak nie sú definované
                if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                    const storedMonth = localStorage.getItem('currentMonth');
                    const storedYear = localStorage.getItem('currentYear');
                    const currentDate = new Date();
                    currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                    currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
                     console.log("Initializing month/year from localStorage or current date:", currentYear, currentMonth);
                }

                // Načítanie dát mesiacov
                const storedMonthData = localStorage.getItem('workDaysData');
                monthData = storedMonthData ? JSON.parse(storedMonthData) : {};

                // Zabezpečenie, že staré dáta bez noteVisible dostanú predvolenú hodnotu
                 if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) {
                     monthData[currentYear][currentMonth] = monthData[currentYear][currentMonth].map(day => ({
                         ...day, // Zachová existujúce vlastnosti
                         noteVisible: day.noteVisible === true // Predvolená hodnota false ak chýba
                     }));
                 } else {
                     // Ak pre aktuálny mesiac/rok dáta neexistujú, inicializuj prázdne pole
                     if (!monthData) monthData = {};
                     if (!monthData[currentYear]) monthData[currentYear] = {};
                     monthData[currentYear][currentMonth] = [];
                 }


                // Načítanie nastavení (rovnaké ako V1)
                hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02; // Načítame percento a predelíme
                const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2; // Default 2
                employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

                updateUIFromLoadedData(darkMode); // Aktualizácia UI

            } catch (error) {
                console.error(`Kritická chyba pri načítavaní/spracovaní dát z localStorage pre ${getMonthName(currentMonth)} ${currentYear}:`, error);
                showSaveNotification("Chyba pri načítaní lokálnych dát!", "error");
                monthData = {}; // Reset dát v prípade chyby
                 if (currentMonth === undefined || currentMonth === null) currentMonth = new Date().getMonth();
                 if (currentYear === undefined || currentYear === null) currentYear = new Date().getFullYear();
                createTable(); calculateTotal(); // Zobraz prázdnu tabuľku
            }
        }

        // --- Aktualizácia UI (logika z V1, vrátane poznámok) ---
        function updateUIFromLoadedData(darkModeValue) {
            try {
                console.log("Updating UI from loaded data for:", currentYear, currentMonth);
                // Nastav hodnoty inputov pre nastavenia
                hourlyWageInput.value = hourlyWage;
                taxRateInput.value = (taxRate * 100).toFixed(1); // Zobrazujeme ako percento
                decimalPlacesSelect.value = decimalPlaces;
                employeeNameInput.value = employeeName;

                // Nastav selecty pre mesiac a rok
                if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
                     monthSelect.value = currentMonth;
                } else {
                     monthSelect.value = new Date().getMonth();
                     currentMonth = parseInt(monthSelect.value);
                }
                 if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                     yearSelect.value = currentYear;
                 } else {
                     yearSelect.value = new Date().getFullYear();
                     currentYear = parseInt(yearSelect.value);
                     populateYearSelect(); // Znovu naplní, ak rok chýbal
                     yearSelect.value = currentYear;
                 }


                createTable(); // Vytvorí štruktúru tabuľky

                const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
                console.log("Data found for current month:", dataForCurrentMonth.length, "entries");

                // Naplnenie tabuľky dátami
                dataForCurrentMonth.forEach((day, index) => {
                    const i = index + 1;
                    const baseId = `${currentYear}-${currentMonth}-${i}`;
                    const startElement = document.getElementById(`start-${baseId}`);
                    const endElement = document.getElementById(`end-${baseId}`);
                    const breakElement = document.getElementById(`break-${baseId}`);
                    const noteElement = document.getElementById(`note-${baseId}`);
                    const noteContainer = document.getElementById(`note-container-${baseId}`);
                    const noteButton = document.getElementById(`note-toggle-${baseId}`);
                    const noteIndicator = document.getElementById(`note-indicator-${baseId}`);

                    if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
                        startElement.value = day.start || '';
                        endElement.value = day.end || '';
                        breakElement.value = day.breakTime || '';
                        noteElement.value = day.note || '';

                        // Vypočítaj hodnoty pre riadok
                        calculateRow(i);

                        // Nastavenie viditeľnosti poznámky
                        const isNoteVisible = day.noteVisible === true;
                        noteContainer.classList.toggle('visible', isNoteVisible);
                        noteButton.textContent = isNoteVisible ? 'Skryť' : 'Poznámka';

                        // Aktualizácia indikátora poznámky
                        updateNoteIndicator(i);

                         // Aplikácia dark mode na dynamické prvky poznámky
                        const isDarkModeActive = document.body.classList.contains('dark-mode');
                        if(noteElement) noteElement.classList.toggle('dark-mode', isDarkModeActive);
                        if(noteButton) noteButton.classList.toggle('dark-mode', isDarkModeActive);
                        if(noteIndicator) noteIndicator.classList.toggle('dark-mode', isDarkModeActive);

                    } else {
                        console.error(`Kritická chyba: Elementy pre deň ${i} v updateUIFromLoadedData neboli nájdené po createTable!`);
                    }
                });

                // Ak je menej dát než dní v mesiaci, resetuj zvyšné riadky
                const daysInMonth = getDaysInMonth(currentMonth);
                 for (let i = dataForCurrentMonth.length + 1; i <= daysInMonth; i++) {
                     if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        resetRow(i, false); // Nerobíme save pri tomto resete
                     }
                 }


                calculateTotal(); // Prepočítaj celkové súčty
                updateDataSize(); // Aktualizuj ukazovateľ veľkosti dát
                applyDarkMode(darkModeValue); // Aplikuj tmavý režim
                updateWelcomeMessage(); // Aktualizuj uvítanie

            } catch (error) {
                console.error("Chyba počas aktualizácie UI:", error);
                showSaveNotification("Chyba pri prekresľovaní UI!", "error");
            }
        }

        // --- Aplikovanie Dark Mode (logika z V1) ---
        function applyDarkMode(isDark) {
            const elementsToToggle = [
                document.body, document.querySelector('.container'), totalSalaryDiv,
                document.querySelector('.collapsible-settings summary'),
                ...document.querySelectorAll('table, th, td'),
                ...document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"], select'),
                ...document.querySelectorAll('.btn'), // Vrátane .highlight, lebo má .btn
                ...document.querySelectorAll('.toggle-note-btn'),
                ...document.querySelectorAll('.note-textarea'),
                ...document.querySelectorAll('.time-icon'),
                ...document.querySelectorAll('.note-indicator-icon')
            ];
             elementsToToggle.forEach(el => {
                 if (el) { // Kontrola, či element existuje
                     // Použijeme force parameter toggle metódy
                     el.classList.toggle('dark-mode', isDark);
                 } else {
                    // console.warn("Dark mode toggle: Element not found for selector used.");
                 }
             });

            // Špeciálne pre current-day
            const currentDayRows = document.querySelectorAll('.current-day'); // Môže byť viac? Radšej querySelectorAll
             currentDayRows.forEach(currentDayRow => {
                currentDayRow.classList.toggle('dark-mode', isDark);
                 currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn, .time-icon, .note-indicator-icon').forEach(el => {
                     if(el) el.classList.toggle('dark-mode', isDark);
                 });
             });
        }

        window.toggleDarkMode = () => { // Priradenie k window pre onclick
            const isDarkMode = document.body.classList.toggle('dark-mode');
            applyDarkMode(isDarkMode);
            localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
            // Ulož zmenu dark mode aj do Firebase
             if (currentUser) {
                 saveToFirebase(); // Uloží celý aktuálny stav vrátane darkMode
             }
        }


        // --- Vytváranie Tabuľky (logika z V1, vrátane poznámok a ikon) ---
        function getDayName(year, month, day) {
             try {
                // Pridáme +1 k dňu a potom nastavíme na 0, aby sme získali posledný deň predošlého mesiaca
                 // To ale nepotrebujeme, stačí vytvoriť dátum
                 const date = new Date(year, month, day);
                 // Skontrolujeme, či je dátum platný (napr. 31. Február by nebol platný)
                 if (isNaN(date.getTime())) {
                     return "N/A"; // Alebo iná indikácia neplatného dňa
                 }
                 const daysOfWeek = ["Ne", "Po", "Ut", "St", "Št", "Pi", "So"]; // Skrátené názvy
                 return daysOfWeek[date.getDay()];
             } catch (e) {
                 console.error("Error getting day name for", year, month, day, e);
                 return "Err";
             }
         }

        function createTable() {
             workDays.innerHTML = ''; // Vyčistí predchádzajúci obsah
             const tableHead = document.querySelector('table thead tr');
             // Uistíme sa, že hlavička pre poznámku existuje (z V1)
             if (tableHead && !tableHead.querySelector('.th-note')) {
                 const noteTh = document.createElement('th');
                 noteTh.textContent = 'Poznámka';
                 noteTh.classList.add('th-note');
                 const lastTh = tableHead.lastElementChild; // Nájdi posledný stĺpec (Akcia)
                 tableHead.insertBefore(noteTh, lastTh); // Vlož pred posledný
             }

             const daysInMonth = getDaysInMonth(currentMonth);
             if (isNaN(daysInMonth) || daysInMonth <= 0 || daysInMonth > 31) {
                 console.error("Invalid number of days in month:", daysInMonth, "for", currentYear, currentMonth);
                 workDays.innerHTML = `<tr><td colspan="9">Chyba: Neplatný počet dní pre ${getMonthName(currentMonth)} ${currentYear}.</td></tr>`;
                 return;
             }

             const today = new Date();
             const currentDayOfMonth = today.getDate();
             const currentMonthIndex = today.getMonth();
             const currentYearValue = today.getFullYear();

             for (let i = 1; i <= daysInMonth; i++) {
                 const row = document.createElement('tr');
                 if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
                     row.classList.add('current-day');
                 }

                 const dayName = getDayName(currentYear, currentMonth, i);
                 const baseId = `${currentYear}-${currentMonth}-${i}`;
                 const startId = `start-${baseId}`; const endId = `end-${baseId}`; const breakId = `break-${baseId}`;
                 const totalId = `total-${baseId}`; const grossId = `gross-${baseId}`; const netId = `net-${baseId}`;
                 const noteToggleId = `note-toggle-${baseId}`; const noteContainerId = `note-container-${baseId}`;
                 const noteTextareaId = `note-${baseId}`; const noteIndicatorId = `note-indicator-${baseId}`;

                 // HTML štruktúra riadku z V1 kódu (vrátane poznámok a ikon)
                 row.innerHTML = `
                     <td>${i}. (${dayName})</td>
                     <td>
                         <input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}', ${i})">
                         <span class="time-icon" title="Vložiť aktuálny čas" onclick="insertCurrentTime('${startId}')">⏰</span>
                     </td>
                     <td>
                         <input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}', ${i})">
                         <span class="time-icon" title="Vložiť aktuálny čas" onclick="insertCurrentTime('${endId}')">⏰</span>
                     </td>
                     <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td>
                     <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
                     <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="0.00" readonly></td>
                     <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="0.00" readonly></td>
                     <td>
                         <span class="note-indicator-icon" id="${noteIndicatorId}">📝</span>
                         <button id="${noteToggleId}" class="toggle-note-btn" onclick="toggleNote(${i})">Poznámka</button>
                         <div id="${noteContainerId}" class="note-container">
                             <textarea id="${noteTextareaId}" class="note-textarea" placeholder="Zadajte poznámku..." oninput="handleNoteInput(this, ${i})"></textarea>
                         </div>
                     </td>
                     <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
                 `;
                 workDays.appendChild(row);
             }
             // Aplikuje dark mode aj na novo vytvorené prvky
             applyDarkMode(document.body.classList.contains('dark-mode'));
         }


        // --- Vloženie Aktuálneho Času (funkcia z V1) ---
         window.insertCurrentTime = function(targetInputId) { // Priradenie k window pre onclick
             const now = new Date();
             const hours = now.getHours().toString().padStart(2, '0');
             const minutes = now.getMinutes().toString().padStart(2, '0');
             const formattedTime = `${hours}:${minutes}`;

             const targetInput = document.getElementById(targetInputId);
             if (targetInput) {
                 targetInput.value = formattedTime;
                 // Simulujeme input event, aby sa spustil handleInput a prepočty/ukladanie
                 const event = new Event('input', { bubbles: true, cancelable: true });
                 targetInput.dispatchEvent(event);
                 // Focus na ďalšie pole, ak je to príchod
                 if (targetInputId.startsWith('start-')) {
                    const nextId = targetInputId.replace('start-', 'end-');
                    moveNext(targetInput, nextId);
                 }
             } else {
                 console.error('Cieľový input pre vloženie času nebol nájdený:', targetInputId);
                 showSaveNotification('Chyba: Nepodarilo sa nájsť pole pre vloženie času.', 'error');
             }
         }

        // --- Funkcie pre Poznámky (z V1) ---
        window.toggleNote = (day) => { // Priradenie k window pre onclick
            const containerId = `note-container-${currentYear}-${currentMonth}-${day}`;
            const buttonId = `note-toggle-${currentYear}-${currentMonth}-${day}`;
            const noteContainer = document.getElementById(containerId);
            const toggleButton = document.getElementById(buttonId);

            if (noteContainer && toggleButton) {
                const isVisible = noteContainer.classList.toggle('visible');
                toggleButton.textContent = isVisible ? 'Skryť' : 'Poznámka';

                const dayIndex = day - 1;
                 // Zabezpečíme existenciu záznamu pre deň
                 ensureDayDataExists(dayIndex);

                if (monthData[currentYear][currentMonth][dayIndex]) {
                     monthData[currentYear][currentMonth][dayIndex].noteVisible = isVisible;
                     debouncedSaveToLocalStorage(); // Uložíme zmenu viditeľnosti (s debounce)
                } else {
                    console.warn(`toggleNote: Záznam pre deň ${dayIndex} stále neexistuje po ensureDayDataExists.`);
                }


                 // Aplikácia dark mode
                 if (document.body.classList.contains('dark-mode')) {
                     const textarea = noteContainer.querySelector('textarea');
                     if(textarea) textarea.classList.toggle('dark-mode', document.body.classList.contains('dark-mode'));
                     toggleButton.classList.toggle('dark-mode', document.body.classList.contains('dark-mode'));
                     // Note: Indikátor sa prepína v updateNoteIndicator
                 }
            } else {
                 console.warn(`toggleNote: Elementy pre poznámku dňa ${day} neboli nájdené.`);
            }
        }

        window.updateNoteIndicator = (day) => { // Priradenie k window (volá sa interne)
             const noteTextarea = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`);
             const indicatorIcon = document.getElementById(`note-indicator-${currentYear}-${currentMonth}-${day}`);
             if (noteTextarea && indicatorIcon) {
                 const hasContent = noteTextarea.value.trim() !== '';
                 indicatorIcon.style.display = hasContent ? 'inline-block' : 'none';
                 // Aplikuj dark mode na indikátor
                 indicatorIcon.classList.toggle('dark-mode', document.body.classList.contains('dark-mode'));
             }
         }
        // Pomocná funkcia na zabezpečenie existencie dátového záznamu
         function ensureDayDataExists(dayIndex) {
             if (!monthData) monthData = {};
             if (!monthData[currentYear]) monthData[currentYear] = {};
             if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
             while (dayIndex >= monthData[currentYear][currentMonth].length) {
                 monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '', noteVisible: false });
             }
             // Zabezpečí, že aj existujúci záznam má noteVisible
             if (typeof monthData[currentYear][currentMonth][dayIndex]?.noteVisible === 'undefined') {
                 if (monthData[currentYear][currentMonth][dayIndex]) {
                     monthData[currentYear][currentMonth][dayIndex].noteVisible = false;
                 } else {
                     // Toto by sa nemalo stať po cykle while vyššie, ale pre istotu
                      monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '', noteVisible: false };
                 }
             }
         }


        // --- Input Handling (logika z V1, vrátane poznámok) ---
        function isTimeValid(timeStr) { const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeStr); }

        window.handleInput = (input, nextId, day) => { // Priradenie k window pre oninput
             formatInput(input); // Formátovanie HH:MM
             updateMonthDataFromInput(input, day); // Aktualizácia monthData
             calculateRow(day); // Prepočet riadku
             calculateTotal(); // Prepočet súčtov
             debouncedSaveToLocalStorage(); // Uloženie s debounce
             // Automatický presun fokusu (rovnaký ako V1)
             if (input.type === 'tel' && input.value.length === 5 && isTimeValid(input.value)) {
                 moveNext(input, nextId);
             }
         }

        window.handleBreakInput = (day) => { // Priradenie k window pre oninput
             const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
             if (input && parseFloat(input.value) < 0) {
                 input.value = ''; // Zakáž záporné hodnoty
             }
             updateMonthDataFromInput(input, day);
             calculateRow(day);
             calculateTotal();
             debouncedSaveToLocalStorage();
         }

        window.handleNoteInput = (textarea, day) => { // Priradenie k window pre oninput
             updateMonthDataFromInput(textarea, day);
             updateNoteIndicator(day); // Aktualizuj ikonu indikátora
             debouncedSaveToLocalStorage(); // Uloží zmenu textu poznámky (s debounce)
         }

        // Aktualizácia monthData z inputu (logika z V1)
        function updateMonthDataFromInput(input, day) {
             if (!input) return;
             const dayIndex = day - 1;
             const fieldId = input.id;
             let field = 'unknown';

             if (fieldId.startsWith('start-')) field = 'start';
             else if (fieldId.startsWith('end-')) field = 'end';
             else if (fieldId.startsWith('break-')) field = 'breakTime';
             else if (fieldId.startsWith('note-')) field = 'note';

             const value = (field === 'breakTime') ? (input.value || '') : input.value; // Uložíme aj 0 pre prestávku

             if (field !== 'unknown') {
                ensureDayDataExists(dayIndex); // Zabezpečíme existenciu záznamu

                const currentValue = monthData[currentYear]?.[currentMonth]?.[dayIndex]?.[field];
                if (currentValue !== value) {
                     monthData[currentYear][currentMonth][dayIndex][field] = value;
                 }
             } else {
                 console.warn("updateMonthDataFromInput: Nerozpoznané pole pre input ID:", fieldId);
             }
         }

        // Formátovanie HH:MM (logika z V1)
        function formatInput(input) {
            if (!input || input.type !== 'tel') return;
            let value = input.value.replace(/[^\d:]/g, ''); // Povolí len čísla a dvojbodku

            // Automatické pridanie dvojbodky
             if (value.length === 3 && value.charAt(2) !== ':' && value.indexOf(':') === -1) {
                // Ak sú prvé 2 čísla platná hodina a 3. znak nie je dvojbodka
                 if (parseInt(value.slice(0, 2)) <= 23) {
                     value = value.slice(0, 2) + ':' + value.slice(2);
                 }
            } else if (value.length === 4 && value.indexOf(':') === -1) {
                 // Ak sú 4 čísla a žiadna dvojbodka -> HH:MM
                 value = value.slice(0, 2) + ':' + value.slice(2);
             } else if (value.length === 2 && input.value.length === 3 && input.value.endsWith(':')) {
                  // Ak používateľ zadal HH:, necháme tak
             } else if (value.length === 1 && parseInt(value) > 2) {
                 // Ak prvé číslo je > 2, pridáme 0 na začiatok a : (napr. 8 -> 08:)
                 value = '0' + value + ':';
             }


            // Odstránenie viacerých dvojbodiek
             const parts = value.split(':');
             if (parts.length > 2) {
                 value = parts[0] + ':' + parts.slice(1).join('');
             }

            // Obmedzenie dĺžky
             if (value.length > 5) {
                 value = value.slice(0, 5);
             }

            // Aktualizácia hodnoty inputu, ak sa zmenila
             if (input.value !== value) {
                 input.value = value;
             }

            // Validácia border (rovnaká ako V1)
             if (value.length > 0 && value.length < 5) {
                 if (input.style.border !== '') input.style.border = ''; // Reset border
             } else if (value.length === 5) {
                 if (isTimeValid(value)) {
                     if (input.style.border !== '') input.style.border = '';
                 } else {
                     input.style.border = '1px solid red';
                     // Odstránenie červeného okraja po chvíli
                      setTimeout(() => {
                          if (input.style.borderColor === 'red') { // Kontrola pre prípad, že by sa medzitým opravilo
                              input.style.border = '';
                          }
                      }, 2000);
                 }
             } else { // Prázdny alebo dĺžka 0
                 if (input.style.border !== '') input.style.border = '';
             }
        }

        // Presun fokusu (logika z V1)
         function moveNext(currentElement, nextId) {
            if (!nextId || !currentElement) return;
             // Nájdeme rodičovský TR element
             const currentRow = currentElement.closest('tr');
             if (!currentRow) return;

             let nextElement = document.getElementById(nextId);

             // Ak ďalší element neexistuje (napr. sme na konci riadku a bol to break input),
             // skúsime nájsť prvý input (start) v ďalšom riadku.
             if (!nextElement && nextId.startsWith('break-')) {
                 const nextRow = currentRow.nextElementSibling;
                 if (nextRow) {
                     const nextStartInput = nextRow.querySelector('input[id^="start-"]');
                     if (nextStartInput) {
                         nextElement = nextStartInput;
                     }
                 }
             }


             if (nextElement) {
                 // Presunúť focus len ak aktuálny element má focus
                 if (document.activeElement === currentElement) {
                    nextElement.focus();
                    // Označenie textu pre ľahké prepísanie (okrem number inputov)
                     if (nextElement.select && nextElement.type !== 'number') {
                         nextElement.select();
                    }
                }
            } else {
                // console.warn(`moveNext: Element s ID ${nextId} nebol nájdený.`);
            }
        }


        // --- Výpočty (logika z V1) ---
        function calculateRow(day) {
            const baseId = `${currentYear}-${currentMonth}-${day}`;
            const startTimeStr = document.getElementById(`start-${baseId}`)?.value;
            const endTimeStr = document.getElementById(`end-${baseId}`)?.value;
            const breakTimeInput = document.getElementById(`break-${baseId}`);
            const breakTime = parseFloat(breakTimeInput?.value) || 0;

            const totalCell = document.getElementById(`total-${baseId}`);
            const grossElement = document.getElementById(`gross-${baseId}`);
            const netElement = document.getElementById(`net-${baseId}`);

            if (!totalCell || !grossElement || !netElement) {
                 console.error(`Missing elements for row calculation, day ${day}`);
                 return; // Nemôžeme počítať bez elementov
            }

            // Reset, ak chýbajú časy
            if (!startTimeStr && !endTimeStr) {
                 totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
                 grossElement.value = (0).toFixed(decimalPlaces);
                 netElement.value = (0).toFixed(decimalPlaces);
                 return;
             }

            // Validácia formátu času
             if ((startTimeStr && !isTimeValid(startTimeStr)) || (endTimeStr && !isTimeValid(endTimeStr))) {
                 totalCell.textContent = 'Neplatný čas';
                 grossElement.value = (0).toFixed(decimalPlaces);
                 netElement.value = (0).toFixed(decimalPlaces);
                 return;
             }
             // Ak je zadaný len jeden čas, zobrazíme 0
            if (!startTimeStr || !endTimeStr) {
                totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
                grossElement.value = (0).toFixed(decimalPlaces);
                netElement.value = (0).toFixed(decimalPlaces);
                return;
            }


            // Výpočet rozdielu časov
            const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
            const [endHours, endMinutes] = endTimeStr.split(':').map(Number);

            // Použijeme fiktívny dátum pre jednoduchý výpočet rozdielu
            const startDate = new Date(2000, 0, 1, startHours, startMinutes);
            let endDate = new Date(2000, 0, 1, endHours, endMinutes);

            // Ak je koncový čas menší ako začiatočný (práca cez polnoc)
             if (endDate < startDate) {
                endDate.setDate(endDate.getDate() + 1); // Posuň o deň
            }

            const diffMilliseconds = endDate.getTime() - startDate.getTime();
            const diffMinutesTotal = diffMilliseconds / (1000 * 60); // Celkový rozdiel v minútach

             const breakMinutes = breakTime * 60; // Prestávka v minútach
             const workedMinutes = Math.max(0, diffMinutesTotal - breakMinutes); // Odpracované minúty

             const hours = Math.floor(workedMinutes / 60);
             const minutes = Math.round(workedMinutes % 60); // Zaokrúhlenie minút
             const decimalHours = workedMinutes / 60; // Odpracované hodiny ako desatinné číslo

             totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;

            // Výpočet mzdy
            const currentHourlyWage = hourlyWage; // Načítaj aktuálnu sadzbu
            const currentTaxRate = taxRate; // Načítaj aktuálnu daň

            const grossSalary = decimalHours * currentHourlyWage;
            grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);

            const netSalary = grossSalary * (1 - currentTaxRate);
            netElement.value = isFinite(netSalary) ? netSalary.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);
        }


        // Reset Riadku (logika z V1, vrátane poznámok)
        window.resetRow = (day) => { // Priradenie k window pre onclick
             const dayIndex = day - 1;
             const baseId = `${currentYear}-${currentMonth}-${day}`;
             const start = document.getElementById(`start-${baseId}`);
             const end = document.getElementById(`end-${baseId}`);
             const breakTime = document.getElementById(`break-${baseId}`);
             const total = document.getElementById(`total-${baseId}`);
             const gross = document.getElementById(`gross-${baseId}`);
             const net = document.getElementById(`net-${baseId}`);
             const note = document.getElementById(`note-${baseId}`);
             const noteContainer = document.getElementById(`note-container-${baseId}`);
             const noteToggle = document.getElementById(`note-toggle-${baseId}`);
             const noteIndicator = document.getElementById(`note-indicator-${baseId}`);

             if (start && end && breakTime && total && gross && net && note && noteContainer && noteToggle && noteIndicator) {
                 start.value = ''; end.value = ''; breakTime.value = ''; note.value = '';
                 total.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
                 gross.value = (0).toFixed(decimalPlaces); net.value = (0).toFixed(decimalPlaces);
                 noteContainer.classList.remove('visible'); noteToggle.textContent = 'Poznámka';
                 updateNoteIndicator(day); // Skryje indikátor

                 // Vynulovanie dát v monthData
                 ensureDayDataExists(dayIndex); // Zabezpečíme, že záznam existuje
                 if (monthData[currentYear][currentMonth][dayIndex]) {
                     monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '', noteVisible: false };
                 } else {
                     console.error(`resetRow: Chýba záznam pre deň ${dayIndex} v monthData aj po ensureDayDataExists.`);
                 }

                 calculateTotal(); // Prepočítať súčty
                 debouncedSaveToLocalStorage(); // Uložiť zmeny (s debounce)

             } else {
                 console.warn(`resetRow: Niektoré elementy pre deň ${day} neboli nájdené.`);
             }
         }

        // Reset Mesiaca (logika z V1)
        window.resetAll = () => { // Priradenie k window pre onclick
             if (confirm('Naozaj chcete resetovať všetky záznamy pre tento mesiac?')) {
                 if (!monthData) monthData = {};
                 if (!monthData[currentYear]) monthData[currentYear] = {};

                 const days = getDaysInMonth(currentMonth);
                 // Vytvorí pole s prázdnymi objektmi pre každý deň
                 monthData[currentYear][currentMonth] = Array.from({ length: days }, () => ({ start: '', end: '', breakTime: '', note: '', noteVisible: false }));

                 createTable(); // Prekreslí tabuľku (už bude prázdna)
                 calculateTotal(); // Vynuluje súčty
                 saveToLocalStorage(); // Uloží prázdne dáta (priamo, nie debounce)
                 showSaveNotification("Dáta pre aktuálny mesiac boli resetované.");
             }
         }

        // Výpočet Celkových Súčtov (logika z V1)
        function calculateTotal() {
            let grandTotalWorkedMinutes = 0;
            let grandTotalGrossSalary = 0;
            let grandTotalNetSalary = 0;
            let daysWithEntries = 0;

            const rows = workDays.querySelectorAll('tr');
            const currentHourlyWage = hourlyWage;
            const currentTaxRate = taxRate;
            const currentDecimalPlaces = decimalPlaces;

            rows.forEach((row, index) => {
                const dayIndex = index + 1;
                const baseId = `${currentYear}-${currentMonth}-${dayIndex}`;
                 const startTimeStr = document.getElementById(`start-${baseId}`)?.value;
                 const endTimeStr = document.getElementById(`end-${baseId}`)?.value;
                 const breakTimeInput = document.getElementById(`break-${baseId}`);
                 const grossInput = document.getElementById(`gross-${baseId}`);
                 const netInput = document.getElementById(`net-${baseId}`);

                 let rowWorkedMinutes = 0;
                 let rowGross = 0;
                 let rowNet = 0;
                 let hasEntry = false; // Indikátor, či sa má deň započítať

                 if (grossInput && netInput) {
                     rowGross = parseFloat(grossInput.value) || 0;
                     rowNet = parseFloat(netInput.value) || 0;
                 }

                 // Prepočet odpracovaných minút pre súčet (podobne ako v calculateRow)
                 if (startTimeStr && endTimeStr && isTimeValid(startTimeStr) && isTimeValid(endTimeStr)) {
                     const breakTime = parseFloat(breakTimeInput?.value) || 0;
                     const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
                     const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
                     const startDate = new Date(2000, 0, 1, startHours, startMinutes);
                     let endDate = new Date(2000, 0, 1, endHours, endMinutes);
                     if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); }
                     const diffMilliseconds = endDate.getTime() - startDate.getTime();
                     const diffMinutesTotal = diffMilliseconds / (1000 * 60);
                     const breakMinutes = breakTime * 60;
                     rowWorkedMinutes = Math.max(0, diffMinutesTotal - breakMinutes);
                     if (rowWorkedMinutes > 0) {
                         hasEntry = true; // Započítaj deň, ak sa reálne odpracovalo
                     }
                 }

                 // Započítaj deň aj vtedy, ak nie je čas, ale je zadaná poznámka alebo vynútená prestávka
                 const noteValue = document.getElementById(`note-${baseId}`)?.value;
                 const breakValue = breakTimeInput?.value;
                 if (!hasEntry && (noteValue || (breakValue && parseFloat(breakValue) > 0))) {
                     // Ak sme doteraz nezapočítali a je poznámka/prestávka, skontrolujme aspoň jeden čas
                     if (startTimeStr || endTimeStr) {
                         hasEntry = true;
                     }
                 }


                 grandTotalWorkedMinutes += rowWorkedMinutes;
                 grandTotalGrossSalary += rowGross;
                 grandTotalNetSalary += rowNet;
                 if (hasEntry) {
                     daysWithEntries++;
                 }
            });

             const grandTotalDecimalHours = grandTotalWorkedMinutes / 60;
             // Súčty sú už vypočítané priamo z inputov, aby sedeli so zaokrúhlením

             const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0;
             const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
             const averageHours = Math.floor(averageWorkedMinutes / 60);
             const averageMinutes = Math.round(averageWorkedMinutes % 60);
             const averageDecimalHours = averageWorkedMinutes / 60;

             const totalHours = Math.floor(grandTotalWorkedMinutes / 60);
             const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60); // Zaokrúhlené minúty pre zobrazenie

             totalSalaryDiv.innerHTML =
                 `Počet započítaných dní: ${daysWithEntries}<br>` +
                 `Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(currentDecimalPlaces)} h)<br>` +
                 `Celková hrubá mzda: ${grandTotalGrossSalary.toFixed(currentDecimalPlaces)} €<br>` +
                 `Celková čistá mzda: ${grandTotalNetSalary.toFixed(currentDecimalPlaces)} €<br>` +
                 `Priemerná čistá mzda na deň: ${averageNetSalary.toFixed(currentDecimalPlaces)} €<br>` +
                 `<strong>Priemerný odpracovaný čas na deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(currentDecimalPlaces)} h)</strong>`;
         }

        // --- Export do PDF (logika z V1, vrátane poznámok) ---
        window.exportToPDF = () => { // Priradenie k window pre onclick
             if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API?.autoTable === 'undefined') {
                 alert("Chyba: Knižnica jsPDF alebo autoTable nie je správne načítaná.");
                 console.error("jsPDF library or autoTable plugin is not loaded correctly.");
                 return;
             }
             const { jsPDF } = window.jspdf; // Destructuring pre jsPDF
             try {
                 const doc = new jsPDF();
                 // Pokus o pridanie fontu (ak zlyhá, použije sa default)
                 try {
                     // Skontrolujte, či font už nie je pridaný, aby ste predišli varovaniam
                     if (!doc.getFontList()['Roboto']) {
                         // Použite správnu cestu k fontu alebo CDN, ak je potrebné
                         // Tento príklad predpokladá, že font je dostupný; inak ho vynechajte alebo použite base64
                          // doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); // Môže byť blokované CORSom
                          console.warn("Roboto font not directly added, ensure it's available or use default fonts.");
                     }
                      doc.setFont('helvetica', 'normal'); // Použijeme štandardný font pre istotu
                 } catch(e) {
                      console.warn("Could not load/set Roboto font for PDF, using default.", e);
                      doc.setFont('helvetica', 'normal'); // Fallback na štandardný font
                 }

                 doc.setFontSize(18);
                 doc.text(`Bruno's Calculator - Výkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);

                 doc.setFontSize(12);
                 doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28);
                 doc.text(`Hodinová mzda: ${hourlyWage || 'N/A'} €`, 14, 34);
                 doc.text(`Daň (%): ${(taxRate * 100).toFixed(1) || 'N/A'}`, 100, 34); // Zobrazí 1 des. miesto

                 // Hlavička tabuľky (vrátane poznámky)
                 const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované", "Hrubá (€)", "Čistá (€)", "Poznámka"];
                 const tableRows = [];

                 const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];

                 dataForCurrentMonth.forEach((day, index) => {
                     // Zobrazí riadok len ak má nejaký vstup alebo poznámku
                      if (day.start || day.end || (day.breakTime && parseFloat(day.breakTime) > 0) || day.note) {
                         const dayNum = index + 1;
                         const dayName = getDayName(currentYear, currentMonth, dayNum);
                         const baseId = `${currentYear}-${currentMonth}-${dayNum}`;

                         const totalCell = document.getElementById(`total-${baseId}`);
                         const grossInput = document.getElementById(`gross-${baseId}`);
                         const netInput = document.getElementById(`net-${baseId}`);

                         // Získanie hodnôt priamo z elementov pre presnosť zobrazenia
                         const workedTimeText = totalCell ? totalCell.textContent.trim() : 'N/A';
                         // Získavame hodnoty z monthData pre istotu, ak by UI nebolo aktuálne
                         const grossValue = (day.start && day.end) ? (parseFloat(grossInput?.value || 0)).toFixed(decimalPlaces) : '0.00';
                         const netValue = (day.start && day.end) ? (parseFloat(netInput?.value || 0)).toFixed(decimalPlaces) : '0.00';
                         const noteText = day.note || ''; // Poznámka z dátového modelu

                         const rowData = [
                             `${dayNum}. (${dayName})`,
                             day.start || '-',
                             day.end || '-',
                             day.breakTime || '0',
                             workedTimeText,
                             grossValue,
                             netValue,
                             noteText // Pridaná poznámka
                         ];
                         tableRows.push(rowData);
                     }
                 });

                 doc.autoTable({
                     head: [tableColumn],
                     body: tableRows,
                     startY: 40,
                     theme: 'grid', // Alebo 'striped', 'plain'
                     styles: {
                         font: 'helvetica', // Použijeme štandardný font
                         fontSize: 8,
                         cellPadding: 2,
                         overflow: 'linebreak' // Zalomenie textu v bunkách
                     },
                     headStyles: {
                         fillColor: [41, 128, 185], // Modrá farba hlavičky
                         textColor: 255,
                         fontStyle: 'bold',
                         halign: 'center'
                     },
                     alternateRowStyles: {
                         fillColor: [240, 240, 240] // Svetlosivé striedanie riadkov
                     },
                     columnStyles: {
                         0: { cellWidth: 22, halign: 'left' }, // Deň
                         1: { cellWidth: 15, halign: 'center' }, // Príchod
                         2: { cellWidth: 15, halign: 'center' }, // Odchod
                         3: { cellWidth: 18, halign: 'center' }, // Prestávka
                         4: { cellWidth: 30, halign: 'center' }, // Odpracované
                         5: { cellWidth: 20, halign: 'right' }, // Hrubá
                         6: { cellWidth: 20, halign: 'right' }, // Čistá
                         7: { cellWidth: 'auto'} // Poznámka - auto šírka
                     }
                 });

                 const finalY = doc.lastAutoTable.finalY || 40; // Získanie pozície pod tabuľkou

                 doc.setFontSize(10);
                 // Odstránenie HTML tagov pre zobrazenie súčtov
                 const totalTextContent = totalSalaryDiv.innerHTML
                     .replace(/<br\s*\/?>/gi, '\n') // Nahradí <br> za nový riadok
                     .replace(/<\/?strong>/g, '');   // Odstráni <strong> tagy
                 doc.text(totalTextContent, 14, finalY + 10); // Zobrazí súčty

                 // Generovanie názvu súboru
                 const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-zA-Z0-9]/g, '_'); // Odstráni špeciálne znaky
                 const pdfFileName = `Vykaz-${safeEmployeeName}-${getMonthName(currentMonth)}-${currentYear}.pdf`;

                 doc.save(pdfFileName);
                 showSaveNotification("PDF exportované.");

             } catch (error) {
                 console.error("Chyba pri generovaní PDF v exportToPDF:", error);
                 alert("Nastala chyba pri vytváraní PDF súboru.");
                 showSaveNotification("Chyba pri exporte PDF.", "error");
             }
         }

        // Odoslanie PDF (logika z V1, vrátane poznámok)
        window.sendPDF = () => { // Priradenie k window pre onclick
             if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API?.autoTable === 'undefined') {
                  alert("Chyba: Knižnica jsPDF alebo autoTable nie je správne načítaná.");
                  console.error("jsPDF library or autoTable plugin is not loaded correctly.");
                  return;
              }
              const { jsPDF } = window.jspdf;
             try {
                 const doc = new jsPDF();
                 try {
                    // Nastavenie fontu (podobne ako pri exporte)
                      if (!doc.getFontList()['Roboto']) {
                         console.warn("Roboto font not directly added for sendPDF.");
                     }
                      doc.setFont('helvetica', 'normal');
                 } catch(e) {
                      console.warn("Could not load/set font for sendPDF, using default.", e);
                      doc.setFont('helvetica', 'normal');
                 }

                 doc.setFontSize(16);
                 doc.text(`Pracovný výkaz - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
                 doc.setFontSize(12);
                 doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28);

                 // Zjednodušená hlavička a dáta pre odoslanie
                 const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Poznámka"];
                 const tableRows = [];
                 const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];

                 dataForCurrentMonth.forEach((day, index) => {
                      if (day.start || day.end || (day.breakTime && parseFloat(day.breakTime) > 0) || day.note) {
                         const dayNum = index + 1;
                         const dayName = getDayName(currentYear, currentMonth, dayNum);
                         const noteText = day.note || '';
                         const rowData = [
                             `${dayNum}. (${dayName})`,
                             day.start || '-',
                             day.end || '-',
                             day.breakTime || '0',
                             noteText // Pridaná poznámka
                         ];
                         tableRows.push(rowData);
                     }
                 });

                 doc.autoTable({
                     head: [tableColumn],
                     body: tableRows,
                     startY: 35,
                     theme: 'grid',
                     styles: { font: 'helvetica', fontSize: 9, cellPadding: 2, overflow: 'linebreak' },
                     headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold', halign: 'center' },
                     alternateRowStyles: { fillColor: [240, 240, 240] },
                     columnStyles: {
                         0: { cellWidth: 30, halign: 'left' }, // Deň
                         1: { cellWidth: 25, halign: 'center' }, // Príchod
                         2: { cellWidth: 25, halign: 'center' }, // Odchod
                         3: { cellWidth: 25, halign: 'center' }, // Prestávka
                         4: { cellWidth: 'auto'} // Poznámka
                     }
                 });

                 const finalY = doc.lastAutoTable.finalY || 35;
                 doc.setFontSize(10);

                 // Pridanie počtu dní zo súčtov
                 const totalSalaryHTML = totalSalaryDiv.innerHTML;
                 let daysWithEntriesText = 'N/A';
                  const match = totalSalaryHTML.match(/Počet započítaných dní: (\d+)/); // Hľadáme nový text
                  if (match && match[1]) {
                      daysWithEntriesText = match[1];
                  }
                 const summaryText = `Počet započítaných dní: ${daysWithEntriesText}`;
                 doc.text(summaryText, 14, finalY + 10);


                 const pdfBlob = doc.output('blob'); // Získanie PDF ako Blob
                 const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
                 const pdfFileName = `Vykaz_odoslanie-${safeEmployeeName}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
                 const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

                 // Pokus o zdieľanie cez Web Share API
                 if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                     navigator.share({
                         files: [pdfFile],
                         title: `Pracovný výkaz ${getMonthName(currentMonth)} ${currentYear}`,
                         text: `Výkaz pre ${employeeName || 'pracovníka'} za ${getMonthName(currentMonth)} ${currentYear}.`
                     }).then(() => {
                         showSaveNotification("PDF pripravené na zdieľanie.");
                     }).catch((error) => {
                         // Ignorujeme AbortError, ktorý nastane, ak používateľ zruší zdieľanie
                         if (error.name !== 'AbortError') {
                             console.error('sendPDF: Chyba pri zdieľaní cez Web Share API:', error);
                             showSaveNotification('Chyba pri zdieľaní súboru.', "error");
                              // Fallback na stiahnutie, ak zdieľanie zlyhá z iného dôvodu
                              doc.save(pdfFileName);
                         } else {
                            console.log("Sharing aborted by user.");
                         }
                     });
                 } else {
                     // Fallback na stiahnutie, ak Web Share API nie je podporované
                     alert("Zdieľanie súborov nie je podporované vaším prehliadačom alebo systémom. Súbor bude stiahnutý.");
                     doc.save(pdfFileName);
                 }
             } catch (error) {
                 console.error("Chyba pri generovaní alebo zdieľaní PDF v sendPDF:", error);
                 alert("Nastala chyba pri vytváraní alebo zdieľaní PDF súboru.");
                 showSaveNotification("Chyba pri odosielaní PDF.", "error");
             }
         }

        // --- Ostatné Nastavenia (logika z V1) ---
         window.changeDecimalPlaces = () => { // Priradenie k window pre onchange
             const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
             if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) {
                 decimalPlaces = newDecimalPlaces;
                 // Prepočítať všetky riadky a súčty
                 const daysInMonth = getDaysInMonth(currentMonth);
                 for(let i = 1; i <= daysInMonth; i++) {
                    if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        calculateRow(i);
                    }
                 }
                 calculateTotal();
                 saveToLocalStorage(); // Uloží zmenu nastavenia a aktuálne dáta
             }
         }

        window.updateEmployeeName = () => { // Priradenie k window pre oninput
             employeeName = employeeNameInput.value;
             updateWelcomeMessage();
             saveToLocalStorage(); // Uloží zmenu mena a aktuálne dáta
         }

        window.updateSettings = () => { // Priradenie k window pre oninput
             const newHourlyWageStr = hourlyWageInput.value;
             const newTaxRateStr = taxRateInput.value;
             const newHourlyWage = parseFloat(newHourlyWageStr);
             const newTaxRatePercent = parseFloat(newTaxRateStr);
             let settingsChanged = false;

             // Update hourly wage
             if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
                 if (hourlyWage !== newHourlyWage) {
                     hourlyWage = newHourlyWage;
                     settingsChanged = true;
                 }
             } else if (newHourlyWageStr !== '') { // Ak je neplatné, ale nie prázdne, vráť starú hodnotu
                  hourlyWageInput.value = hourlyWage;
             }


             // Update tax rate
              if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) {
                  const newTaxRateDecimal = newTaxRatePercent / 100;
                  if (taxRate !== newTaxRateDecimal) {
                      taxRate = newTaxRateDecimal;
                      settingsChanged = true;
                  }
              } else if (newTaxRateStr !== '') { // Ak je neplatné, ale nie prázdne, vráť starú hodnotu
                   taxRateInput.value = (taxRate * 100).toFixed(1);
              }


             // Ak sa zmenila mzda alebo daň, prepočítaj všetko a ulož
             if (settingsChanged) {
                 const rows = workDays.querySelectorAll('tr');
                 rows.forEach((row, index) => calculateRow(index + 1));
                 calculateTotal();
                 saveToLocalStorage(); // Uloží nové nastavenia a prepočítané dáta
             }
         }

        window.changeMonth = () => { // Priradenie k window pre onchange
             const selectedMonth = parseInt(monthSelect.value);
             if (currentMonth !== selectedMonth) {
                 currentMonth = selectedMonth;
                 handleMonthYearChange();
             }
         }

        window.changeYear = () => { // Priradenie k window pre onchange
             const selectedYear = parseInt(yearSelect.value);
             if (currentYear !== selectedYear) {
                 currentYear = selectedYear;
                 handleMonthYearChange();
             }
         }

        function handleMonthYearChange() {
            console.log("Changing month/year to:", currentYear, currentMonth);
             localStorage.setItem('currentMonth', currentMonth.toString());
             localStorage.setItem('currentYear', currentYear.toString());
             // Pri zmene mesiaca/roka načítame dáta z localStorage (tie sa mohli načítať z Firebase predtým)
             loadFromLocalStorage();
             // A nastavíme nový listener pre Firebase
             if (currentUser) {
                 setupFirestoreListener();
             }
         }

        function getDaysInMonth(month) {
             if (month === undefined || month === null || currentYear === undefined || currentYear === null) {
                 console.warn("getDaysInMonth: Missing month or year, returning 31.");
                 return 31; // Fallback
             }
             // Vytvorí dátum pre nultý deň nasledujúceho mesiaca, čo je posledný deň aktuálneho mesiaca
             return new Date(currentYear, month + 1, 0).getDate();
         }

        function getMonthName(month) {
             const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
             return monthNames[month] || 'Neznámy';
         }

        function updateDataSize() {
             try {
                 const totalData = Object.entries(localStorage).reduce((acc, [key, value]) => {
                      // Počítajme len relevantné dáta (workDaysData a nastavenia)
                      if (key === 'workDaysData' || ['hourlyWage', 'taxRate', 'darkMode', 'decimalPlaces', 'employeeName', 'currentMonth', 'currentYear'].includes(key)) {
                          return acc + (value ? value.length * 2 : 0); // Približne 2 bajty na znak v UTF-16
                      }
                      return acc;
                  }, 0);

                 const kilobytes = (totalData / 1024).toFixed(2);
                 const percentageUsed = Math.min(((totalData / MAX_DATA_SIZE) * 100), 100);

                 dataSizeText.textContent = `Lokálne úložisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
                 dataSizeFill.style.width = `${percentageUsed}%`;

                 // Zmena farby podľa zaplnenia
                 if (percentageUsed > 90) {
                     dataSizeFill.style.backgroundColor = '#f44336'; // Červená
                 } else if (percentageUsed > 70) {
                     dataSizeFill.style.backgroundColor = '#ff9800'; // Oranžová
                 } else {
                     dataSizeFill.style.backgroundColor = '#4CAF50'; // Zelená
                 }
             } catch (error) {
                 console.error("Chyba pri výpočte veľkosti localStorage:", error);
                 dataSizeText.textContent = "Chyba pri výpočte veľkosti dát.";
             }
         }


        // --- Zálohovanie a Obnova (JSON formát - logika z V1) ---
        window.createBackup = () => { // Priradenie k window pre onclick
            try {
                 // Zhromaždíme všetky relevantné dáta z localStorage
                 const backupData = {
                     workDaysData: localStorage.getItem('workDaysData') || '{}', // Celé monthData
                     hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(10),
                     taxRate: localStorage.getItem('taxRate') || JSON.stringify(2), // Uložené ako percento
                     darkMode: localStorage.getItem('darkMode') || JSON.stringify(false),
                     decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(2),
                     employeeName: localStorage.getItem('employeeName') || JSON.stringify(''),
                     // Pridáme informácie o zálohe
                     backupVersion: 2, // Verzia štruktúry zálohy
                     backupTimestamp: new Date().toISOString()
                 };

                 // Vytvoríme Blob a URL pre stiahnutie
                 const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
                 const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                 a.download = `bruno-calculator-backup-${safeEmployeeName}-${timestamp}.json`; // Zmysluplný názov súboru
                 document.body.appendChild(a);
                 a.click(); // Spustí stiahnutie
                 document.body.removeChild(a); // Upratanie
                 URL.revokeObjectURL(url); // Uvoľnenie pamäte
                 showSaveNotification("Záloha úspešne vytvorená.");

             } catch (error) {
                 console.error("Chyba pri vytváraní zálohy:", error);
                 alert("Nastala chyba pri vytváraní záložného súboru.");
                 showSaveNotification("Chyba pri vytváraní zálohy.", "error");
             }
         }

        window.restoreBackup = () => { // Priradenie k window pre onclick
             const fileInput = document.createElement('input');
             fileInput.type = 'file';
             fileInput.accept = '.json,application/json'; // Prijímame len JSON

             fileInput.onchange = (event) => {
                 const file = event.target.files[0];
                 if (!file) return;

                 const reader = new FileReader();
                 reader.onload = (e) => {
                     try {
                         const backup = JSON.parse(e.target.result);

                         // Validácia základnej štruktúry zálohy
                          if (backup && typeof backup.workDaysData === 'string' &&
                              typeof backup.hourlyWage === 'string' && typeof backup.taxRate === 'string' &&
                              typeof backup.darkMode === 'string' && typeof backup.decimalPlaces === 'string' &&
                              typeof backup.employeeName === 'string')
                          {
                             // Overenie JSONu pre workDaysData
                             try {
                                 JSON.parse(backup.workDaysData); // Skús parsovať, či je to platný JSON
                             } catch (jsonError) {
                                 throw new Error("Nesprávny formát dát mesiacov (workDaysData) v zálohe.");
                             }


                             if (confirm("Naozaj chcete obnoviť dáta z tejto zálohy? Aktuálne neuložené zmeny v aplikácii budú stratené.")) {
                                 // Prepísanie localStorage dátami zo zálohy
                                 localStorage.setItem('workDaysData', backup.workDaysData);
                                 localStorage.setItem('hourlyWage', backup.hourlyWage);
                                 localStorage.setItem('taxRate', backup.taxRate); // Uložíme ako string percenta
                                 localStorage.setItem('darkMode', backup.darkMode);
                                 localStorage.setItem('decimalPlaces', backup.decimalPlaces);
                                 localStorage.setItem('employeeName', backup.employeeName);

                                 // Po obnovení musíme znovu načítať dáta do aplikácie
                                 loadFromLocalStorage();

                                 showSaveNotification("Záloha úspešne obnovená.");
                                 alert("Záloha bola úspešne obnovená. Dáta boli načítané.");

                                 // Ak je používateľ prihlásený, pokúsime sa uložiť obnovené dáta aj do Firebase
                                 if (currentUser) {
                                     saveToLocalStorage(); // Toto zavolá aj saveToFirebase
                                      showSaveNotification("Obnovené dáta sa ukladajú do cloudu...", "warning");
                                 }
                             }
                         } else {
                              throw new Error("Súbor zálohy má nesprávny formát alebo chýbajú kľúčové dáta.");
                         }
                     } catch (error) {
                         console.error("Chyba pri spracovaní alebo obnove zálohy:", error);
                         alert(`Chyba pri čítaní alebo obnove zálohy: ${error.message}`);
                         showSaveNotification("Chyba pri obnove zálohy.", "error");
                     }
                 };
                 reader.onerror = (e) => {
                     console.error("Chyba pri čítaní súboru zálohy:", e);
                     alert("Nastala chyba pri čítaní súboru zálohy.");
                     showSaveNotification("Chyba pri čítaní súboru zálohy.", "error");
                 };
                 reader.readAsText(file); // Čítame ako text (JSON)
             };
             fileInput.click(); // Otvorí dialóg na výber súboru
         }


        // --- Inicializácia Aplikácie ---
        function populateYearSelect() {
            const startYear = 2020;
            const endYear = new Date().getFullYear() + 5; // Do +5 rokov do budúcna
            const currentSelectedYear = yearSelect.value ? parseInt(yearSelect.value) : currentYear; // Uchováme vybraný rok
            yearSelect.innerHTML = '';
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
             // Skúsime nastaviť predtým vybraný rok, alebo aktuálny, ak nebol vybraný
             yearSelect.value = currentSelectedYear;
             if (yearSelect.value !== currentSelectedYear.toString()) { // Ak nastavenie zlyhalo (rok nebol v rozsahu)
                 yearSelect.value = new Date().getFullYear(); // Nastav aktuálny
                 currentYear = parseInt(yearSelect.value); // Aktualizuj globálnu premennú
             }
        }

        // Spustí sa po načítaní DOM
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed.");
            populateYearSelect();

            // Načítanie stavu z localStorage pri štarte (ešte pred overením auth stavu)
            // aby UI nevyzeralo "rozbité" kým sa neskončí onAuthStateChanged
            const initialDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
            applyDarkMode(initialDarkMode);
            const initialEmployeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
             employeeNameInput.value = initialEmployeeName; // Nastav meno hneď
             employeeName = initialEmployeeName; // Aktualizuj globálnu premennú
             updateWelcomeMessage(); // Zobraz uvítanie hneď

            // Ostatné nastavenia sa načítajú a aplikujú v onAuthStateChanged alebo loadFromLocalStorage

            // Service Worker registrácia zostáva v samostatnom skripte nižšie
        });

         // Pomocná funkcia pre debounce (prevzatá)
         function debounce(func, wait) {
             let timeout;
             return function executedFunction(...args) {
                 const later = () => {
                     clearTimeout(timeout);
                     func(...args);
                 };
                 clearTimeout(timeout);
                 timeout = setTimeout(later, wait);
             };
         }

    </script>

     <script>
         if ('serviceWorker' in navigator) {
             window.addEventListener('load', () => {
                 navigator.serviceWorker.register('./service-worker.js') // Uistite sa, že cesta je správna
                     .then(registration => {
                         console.log('ServiceWorker registration successful with scope: ', registration.scope);
                     })
                     .catch(error => {
                         console.error('ServiceWorker registration failed: ', error);
                     });
             });
         } else {
              console.warn("Service Worker is not supported in this browser.");
          }
     </script>

</body>
</html>
