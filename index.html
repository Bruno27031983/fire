<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator v2.0 s Firebase</title> <!-- Zmenen√Ω titulok -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <!-- Naƒç√≠tanie p√≠sma Roboto z Google Fonts (extern√° kni≈ænica) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">
  <!-- Ikony pre prep√≠naƒç hesla -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Firebase kni≈ænice -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF a autoTable - NEDOTKNUT√â -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- CSS ≈†t√Ωly --- */
    /* Z√°kladn√© ≈°t√Ωly */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; transition: background-color 0.3s ease, color 0.3s ease; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); position: relative; transition: background-color 0.3s ease, color 0.3s ease; }
    .autor-info { position: absolute; top: 10px; left: 15px; font-size: 0.85em; font-style: italic; color: #777; }

    /* Nadpisy */
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 5px; }
    h2 { text-align: center; color: #555; margin-top: 0; margin-bottom: 20px; font-size: 1.2em; }
    #welcomeMessage { font-weight: bold; color: #4CAF50; min-height: 1.2em; /* Aby nesk√°kal layout */}

    /* Nastavenia */
    .settings { margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; border-bottom: 1px solid #eee; padding-bottom: 20px; }
    .settings > div { flex: 1 1 200px; min-width: 180px; }
    .settings label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 0.9em; }
    .settings input[type="text"], .settings input[type="number"], .settings select { width: 100%; padding: 8px; box-sizing: border-box; background-color: #ffffdd; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; transition: border-color 0.2s ease, background-color 0.2s ease; }
    .settings input:focus, .settings select:focus { border-color: #4CAF50; outline: none; background-color: #fff; }
    .settings button { padding: 9px 15px; height: 35px; /* Zarovnanie s inputmi */ }

    /* Tabuƒæka */
    .table-container { overflow-x: auto; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th, td { padding: 10px 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: middle; }
    th { background-color: #e9e9e9; font-weight: bold; }
    tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    tbody tr:hover { background-color: #f1f1f1; }
    td input[type="tel"], td input[type="number"] { width: 100%; padding: 6px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
    td input[readonly] { background-color: #eee; cursor: not-allowed; }

    /* Tlaƒçidl√° */
    .btn-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 25px; }
    .btn { padding: 12px 18px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 15px; transition: background-color 0.3s ease, transform 0.1s ease; text-align: center; box-sizing: border-box; }
    .btn:hover { opacity: 0.9; }
    .btn:active { transform: scale(0.98); }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .toggle-dark-btn { background-color: #607D8B; } .toggle-dark-btn:hover { background-color: #455A64; }
    td .btn.reset-btn { padding: 5px 10px; font-size: 13px; width: auto; min-width: 80px; } /* Men≈°ie tlaƒçidlo v riadku */

    /* Zv√Ωraznenie */
    .highlight { background-color: #ffeb3b; color: #333; font-weight: bold; border: 1px solid #fbc02d; }

    /* Celkov√° mzda a Veƒækos≈• d√°t */
    #totalSalary { font-size: 1.1em; font-weight: bold; text-align: center; margin-top: 20px; padding: 15px; background-color: #e6f3ff; border-radius: 5px; border: 1px solid #b3d9ff; line-height: 1.8; }
    #dataSizeContainer { margin-top: 15px; text-align: center; font-size: 0.9em; color: #555; }
    #dataSizeText { margin-bottom: 5px; }
    #dataSizeBar { width: 90%; max-width: 400px; height: 10px; background-color: #e0e0e0; border-radius: 5px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.5s ease, background-color 0.5s ease; border-radius: 5px; }

    /* Aktu√°lny de≈à */
    .current-day { background-color: #e8dff5 !important; /* Zv√Ωraznenie */ }
    .current-day td:first-child { font-weight: bold; }
    .current-day input { background-color: #f0e6ff; } /* Svetlej≈°√≠ vstup */

    /* Anim√°cie */
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 8px rgba(255, 255, 255, 0.4), 0 0 15px rgba(255, 255, 255, 0.2), 0 0 25px rgba(255, 255, 255, 0.1); } 50% { text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 0 25px rgba(255, 255, 255, 0.7), 0 0 35px rgba(255, 255, 255, 0.5); } }

    /* Tmav√Ω re≈æim */
    body.dark-mode { background-color: #212121; color: #e0e0e0; }
    .container.dark-mode { background-color: #333; color: #e0e0e0; box-shadow: 0 2px 15px rgba(0,0,0,0.5); }
    .dark-mode .autor-info { color: #aaa; }
    .dark-mode h2 { color: #bbb; }
    .dark-mode #welcomeMessage { color: #81C784; }
    .dark-mode .settings { border-bottom-color: #444; }
    .dark-mode .settings label { color: #ccc; }
    .dark-mode .settings input[type="text"], .dark-mode .settings input[type="number"], .dark-mode .settings select { background-color: #555; color: #e0e0e0; border-color: #666; }
    .dark-mode .settings input:focus, .dark-mode .settings select:focus { border-color: #81C784; background-color: #666; }
    .dark-mode table { background-color: #424242; color: #e0e0e0; }
    .dark-mode th, .dark-mode td { border-color: #555; }
    .dark-mode th { background-color: #555; }
    .dark-mode tbody tr:nth-child(odd) { background-color: #474747; }
    .dark-mode tbody tr:hover { background-color: #505050; }
    .dark-mode td input[type="tel"], .dark-mode td input[type="number"] { background-color: #666; color: #e0e0e0; border-color: #777; }
    .dark-mode td input[readonly] { background-color: #555; }
    .dark-mode .btn { color: #fff; } /* V≈°etky tlaƒçidl√° maj√∫ biely text v tmavom re≈æime */
    .dark-mode .reset-btn { background-color: #e53935; } .dark-mode .reset-btn:hover { background-color: #c62828; }
    .dark-mode .export-btn { background-color: #43A047; } .dark-mode .export-btn:hover { background-color: #2E7D32; }
    .dark-mode .restore-btn { background-color: #8E24AA; } .dark-mode .restore-btn:hover { background-color: #6A1B9A; }
    .dark-mode .backup-btn { background-color: #FB8C00; } .dark-mode .backup-btn:hover { background-color: #EF6C00; }
    .dark-mode .toggle-dark-btn { background-color: #78909C; } .dark-mode .toggle-dark-btn:hover { background-color: #546E7A; }
    .dark-mode #totalSalary { background-color: #2c3e50; border-color: #34495e; }
    .dark-mode .current-day { background-color: #4a0e8f !important; }
    .dark-mode .current-day td { color: #fff; }
    .dark-mode .current-day input { background-color: #5c1db3; color: #fff; border-color: #7e4cc4; }
    .dark-mode #dataSizeContainer { color: #bbb; }
    .dark-mode #dataSizeBar { background-color: #555; }
    .dark-mode #auth-container { background-color: #444; }
    .dark-mode #auth-container h1, .dark-mode #auth-container h2 { color: #eee; }
    .dark-mode #auth-container input { background-color: #555; color: #eee; border-color: #666; }
    .dark-mode #auth-container button { background-color: #4CAF50; } .dark-mode #auth-container button:hover { background-color: #388e3c; }
    .dark-mode #forgot-password-link { color: #64b5f6; }

    /* Autentifik√°cia */
    #auth-container { max-width: 400px; margin: 30px auto; background: #fff; padding: 25px 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; transition: background-color 0.3s ease; }
    #auth-container h1 { font-size: 1.8em; margin-bottom: 15px; }
    #auth-container h2 { font-size: 1.3em; margin-top: 20px; margin-bottom: 10px; color: #666; }
    #auth-message { margin-bottom: 20px; font-weight: bold; }
    #auth-forms form { margin-bottom: 20px; }
    #auth-forms .input-group { position: relative; margin-bottom: 15px; } /* Pre ikonu hesla */
    #auth-forms input[type="email"], #auth-forms input[type="password"] { width: 100%; padding: 12px; box-sizing: border-box; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
    #auth-forms .password-toggle-icon { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer; color: #888; font-size: 1.1em; }
    #auth-forms button { width: 100%; padding: 12px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 1.1em; font-weight: bold; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; }
    #auth-forms button:hover { background-color: #45a049; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 0.9em; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }

    /* Notifik√°cie */
    #saveNotification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #4CAF50; color: white; padding: 12px 25px; border-radius: 5px; z-index: 1000; transition: opacity 0.5s ease, background-color 0.3s ease, transform 0.5s ease; opacity: 0; pointer-events: none; font-size: 1em; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    #saveNotification.show { opacity: 1; transform: translate(-50%, 0); pointer-events: auto; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }

    /* Loading */
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; /* Upraven√© pre text */ align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; text-align: center; padding: 20px; }
    #loading-container h1 { font-size: 1.5em; color: #555; background: none; -webkit-background-clip: unset; background-clip: unset; animation: none; text-shadow: none; } /* Vypnut√© efekty pre loading text */
    #loading-container.hidden { opacity: 0; pointer-events: none; }
    .dark-mode #loading-container { background-color: rgba(33, 33, 33, 0.9); }
    .dark-mode #loading-container h1 { color: #ccc; }

    /* √öprava valid√°cie inputu */
    input:invalid { border-color: #f44336; } /* Len jemn√© zv√Ωraznenie pre HTML5 valid√°ciu */
    input.error-border { border: 1px solid red !important; } /* Explicitn√° trieda pre chybu */

  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div id="loading-container">
      <h1> Tajomstvo √∫spechu je slu≈°nos≈• a √∫primnos≈•.<br> Akon√°hle sa ich zbav√≠te, dosiahnete v≈°etko. üòâ</h1>
      <p style="margin-top: 20px; font-size: 1.2em;">Naƒç√≠tavam...</p>
  </div>

  <!-- Auth Container -->
  <div id="auth-container" style="display:none;">
    <h1>Prihl√°senie / Registr√°cia</h1>
    <div id="auth-message">≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.</div>
    <div id="auth-forms">
      <form id="register-form" onsubmit="event.preventDefault(); register();">
        <h2>Registr√°cia</h2>
        <div class="input-group">
          <input type="email" id="registerEmail" placeholder="Email" required>
        </div>
        <div class="input-group">
          <input type="password" id="registerPassword" placeholder="Heslo (min. 6 znakov)" required minlength="6">
          <i class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('registerPassword', this)"></i>
        </div>
        <button type="submit">Registrova≈•</button>
      </form>
      <hr>
      <form id="login-form" onsubmit="event.preventDefault(); login();">
        <h2>Prihl√°senie</h2>
        <div class="input-group">
          <input type="email" id="loginEmail" placeholder="Email" required>
        </div>
        <div class="input-group">
          <input type="password" id="loginPassword" placeholder="Heslo" required>
           <i class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('loginPassword', this)"></i>
        </div>
        <button type="submit">Prihl√°si≈• sa</button>
        <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
      </form>
    </div>
  </div>

  <!-- Calculator Container -->
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>

    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovn√≠ka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Da≈àov√© percento (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Janu√°r</option><option value="1">Febru√°r</option><option value="2">Marec</option><option value="3">Apr√≠l</option><option value="4">M√°j</option><option value="5">J√∫n</option><option value="6">J√∫l</option><option value="7">August</option><option value="8">September</option><option value="9">Okt√≥ber</option><option value="10">November</option><option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
        <select id="yearSelect" onchange="changeYear()"></select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Desatinn√© miesta (ƒças):</label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option><option value="2">2</option>
        </select>
      </div>
      <button onclick="toggleDarkMode()" class="btn toggle-dark-btn">
          <i id="darkModeIcon" class="fas fa-moon"></i> Tmav√Ω Re≈æim
      </button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka (h)</th>
            <th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary">Naƒç√≠tavam s√∫hrn...</div>

    <div id="dataSizeContainer">
      <div id="dataSizeText">Lok√°lne √∫lo≈æisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>

    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetova≈• Mesiac</button>
      <button class="btn export-btn" onclick="exportToPDF()">Export PDF (Detail)</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF (Z√°klad)</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnovi≈• Z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• Z√°lohu</button>
      <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
    </div>
  </div>

  <!-- Save Notification Area -->
  <div id="saveNotification" aria-live="polite"></div>

  <script>
    // --- Konfigur√°cia a Inicializ√°cia Firebase ---
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try {
      firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true);
    } catch (error) {
      console.warn("Chyba pri aktiv√°cii Firebase App Check:", error);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Povolenie Firestore Offline Persistence
    db.enablePersistence().then(() => {
      console.log("Firestore offline persistence povolen√°.");
    }).catch((err) => {
      console.error("Firestore offline persistence chyba:", err.code, err.message, err);
      if (err.code == 'failed-precondition') {
        console.warn("Firestore offline persistence: Viacn√°sobn√© otvoren√© taby, povolen√© len v jednom.");
      } else if (err.code == 'unimplemented') {
        console.error("Firestore offline persistence: Prehliadaƒç nie je podporovan√Ω.");
      }
    });

    // --- Glob√°lne premenn√© a Konfigur√°cia ---
    const config = {
        MAX_DATA_SIZE: 4 * 1024 * 1024, // 4MB limit pre localStorage
        MAX_DATA_SIZE_KB: (4 * 1024 * 1024) / 1024,
        DEBOUNCE_TIME: 600 // ms
    };

    let state = {
        currentMonth: null,
        currentYear: null,
        decimalPlaces: 1,
        employeeName: '',
        hourlyWage: 10,
        taxRate: 0.02, // ulo≈æen√© ako desatinn√© ƒç√≠slo (napr. 0.02 pre 2%)
        monthData: {}, // ≈†trukt√∫ra: { ROK: { MESIAC: [ {start, end, breakTime}, ... ] } }
        firestoreListenerUnsubscribe: null,
        isDarkMode: false,
        userId: null
    };

    // --- Referencie na UI Elementy ---
    const uiElements = {
        loadingContainer: document.getElementById('loading-container'),
        authContainer: document.getElementById('auth-container'),
        calculatorContainer: document.getElementById('calculator-container'),
        authMessage: document.getElementById('auth-message'),
        registerEmail: document.getElementById('registerEmail'),
        registerPassword: document.getElementById('registerPassword'),
        loginEmail: document.getElementById('loginEmail'),
        loginPassword: document.getElementById('loginPassword'),
        welcomeMessage: document.getElementById('welcomeMessage'),
        employeeNameInput: document.getElementById('employeeNameInput'),
        hourlyWageInput: document.getElementById('hourlyWageInput'),
        taxRateInput: document.getElementById('taxRateInput'),
        monthSelect: document.getElementById('monthSelect'),
        yearSelect: document.getElementById('yearSelect'),
        decimalPlacesSelect: document.getElementById('decimalPlacesSelect'),
        workDays: document.getElementById('workDays'),
        totalSalaryDiv: document.getElementById('totalSalary'),
        dataSizeText: document.getElementById('dataSizeText'),
        dataSizeFill: document.getElementById('dataSizeFill'),
        dataSizeBar: document.getElementById('dataSizeBar'), // Pridan√© pre lep≈°iu kontrolu
        saveNotification: document.getElementById('saveNotification'),
        darkModeIcon: document.getElementById('darkModeIcon'),
        logoutBtn: document.getElementById('logout-btn') // Pridan√©
    };

    // --- Pomocn√© Funkcie ---

    /**
     * Vr√°ti n√°zov mesiaca podƒæa indexu (0-11).
     * @param {number} monthIndex Index mesiaca (0 = Janu√°r).
     * @returns {string} N√°zov mesiaca.
     */
    const getMonthName = (monthIndex) => {
      const monthNames = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
      return monthNames[monthIndex] || 'Nezn√°my';
    };

    /**
     * Vr√°ti poƒçet dn√≠ v danom mesiaci a roku.
     * @param {number} month Index mesiaca (0-11).
     * @param {number} year Rok.
     * @returns {number} Poƒçet dn√≠.
     */
    const getDaysInMonth = (month, year) => {
      if (month === undefined || month === null || year === undefined || year === null) {
        console.warn("getDaysInMonth: Ch√Ωba mesiac alebo rok, vraciam 31.");
        return 31;
      }
      // Mesiac v Date objekte je 0-indexovan√Ω, tak≈æe pre posledn√Ω de≈à mesiaca `month` potrebujeme `month + 1`
      return new Date(year, month + 1, 0).getDate();
    };

     /**
     * Vr√°ti n√°zov d≈àa v t√Ω≈ædni.
     * @param {number} year Rok.
     * @param {number} month Index mesiaca (0-11).
     * @param {number} day De≈à v mesiaci (1-31).
     * @returns {string} N√°zov d≈àa.
     */
    const getDayName = (year, month, day) => {
        const daysOfWeek = ["Nedeƒæa", "Pondelok", "Utorok", "Streda", "≈†tvrtok", "Piatok", "Sobota"];
        const date = new Date(year, month, day);
        return daysOfWeek[date.getDay()];
    };

    /**
     * Debounce funkcia na obmedzenie frekvencie volania inej funkcie.
     * @param {Function} func Funkcia na debouncovanie.
     * @param {number} wait ƒåas ƒçakania v ms.
     * @returns {Function} Debouncovan√° funkcia.
     */
    const debounce = (func, wait) => {
      let timeout;
      return function (...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    };

    /**
     * Zobraz√≠ notifik√°ciu v spodnej ƒçasti obrazovky.
     * @param {string} message Spr√°va na zobrazenie.
     * @param {'success' | 'error' | 'warning'} type Typ notifik√°cie.
     * @param {number} duration Trvanie zobrazenia v ms.
     */
    const showSaveNotification = (message, type = 'success', duration = 3000) => {
      if (!uiElements.saveNotification) return;
      uiElements.saveNotification.textContent = message;
      uiElements.saveNotification.className = 'show'; // Z√°kladn√° trieda pre zobrazenie
      if (type === 'error') {
        uiElements.saveNotification.classList.add('error');
      } else if (type === 'warning') {
        uiElements.saveNotification.classList.add('warning');
      }
      // Po ƒçase skry≈•
      setTimeout(() => {
          if (uiElements.saveNotification) {
             uiElements.saveNotification.classList.remove('show');
             // Odstr√°ni≈• ≈°pecifick√© triedy po skryt√≠ anim√°cie
             setTimeout(() => {
                 if (uiElements.saveNotification) {
                     uiElements.saveNotification.classList.remove('error', 'warning');
                 }
             }, 500); // ƒåas zodpovedaj√∫ci CSS transition
          }
      }, duration);
    };

    /**
     * Prep√≠na viditeƒænos≈• hesla v input poli.
     * @param {string} inputId ID input elementu pre heslo.
     * @param {HTMLElement} iconElement Element ikony (oka).
     */
    const togglePasswordVisibility = (inputId, iconElement) => {
        const passwordInput = document.getElementById(inputId);
        if (!passwordInput || !iconElement) return;

        if (passwordInput.type === "password") {
            passwordInput.type = "text";
            iconElement.classList.remove("fa-eye");
            iconElement.classList.add("fa-eye-slash");
        } else {
            passwordInput.type = "password";
            iconElement.classList.remove("fa-eye-slash");
            iconElement.classList.add("fa-eye");
        }
    };

    // --- Funkcie pre Autentifik√°ciu ---

    /** Registruje nov√©ho pou≈æ√≠vateƒæa. */
    const register = async () => {
      const email = uiElements.registerEmail.value;
      const password = uiElements.registerPassword.value;
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        console.log("Registrovan√Ω:", userCredential.user);
        showSaveNotification("Registr√°cia √∫spe≈°n√°!", "success");
        // Vyƒçisti≈• formul√°r po √∫spechu
        uiElements.registerEmail.value = '';
        uiElements.registerPassword.value = '';
      } catch (error) {
        console.error("Chyba pri registr√°cii:", error.message);
        showSaveNotification(`Chyba pri registr√°cii: ${error.message}`, "error", 5000);
      }
    };

    /** Prihl√°si existuj√∫ceho pou≈æ√≠vateƒæa. */
    const login = async () => {
      const email = uiElements.loginEmail.value;
      const password = uiElements.loginPassword.value;
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        console.log("Prihl√°sen√Ω:", userCredential.user);
        showSaveNotification("Prihl√°senie √∫spe≈°n√©!", "success");
         // Vyƒçisti≈• formul√°r po √∫spechu (okrem emailu pre pr√≠pad zabudnut√©ho hesla)
        // uiElements.loginEmail.value = '';
        uiElements.loginPassword.value = '';
      } catch (error) {
        console.error("Chyba pri prihl√°sen√≠:", error.message);
        showSaveNotification(`Chyba pri prihl√°sen√≠: ${error.message}`, "error", 5000);
      }
    };

    /** Odhl√°si aktu√°lneho pou≈æ√≠vateƒæa. */
    const logout = async () => {
      try {
        await auth.signOut();
        console.log("Odhl√°sen√Ω.");
        showSaveNotification("Odhl√°senie √∫spe≈°n√©!", "success");
        // Vyƒçisti≈• stav aplik√°cie po odhl√°sen√≠
        state.monthData = {};
        state.userId = null;
        // UI sa aktualizuje cez onAuthStateChanged listener
      } catch (error) {
        console.error("Chyba pri odhl√°sen√≠:", error.message);
        showSaveNotification(`Chyba pri odhl√°sen√≠: ${error.message}`, "error");
      }
    };

    /** Odo≈°le email na obnovenie hesla. */
    const forgotPassword = async () => {
      const email = uiElements.loginEmail.value;
      if (!email) {
        showSaveNotification("Pros√≠m, zadajte svoju e-mailov√∫ adresu do poƒæa pre prihl√°senie.", "warning");
        uiElements.loginEmail.focus();
        return;
      }
      try {
        await auth.sendPasswordResetEmail(email);
        console.log("E-mail na obnovenie hesla odoslan√Ω na:", email);
        showSaveNotification("Odkaz na obnovenie hesla bol odoslan√Ω na va≈°u e-mailov√∫ adresu. Skontrolujte si po≈°tu (aj Spam).", "success", 6000);
      } catch (error) {
        console.error("Chyba pri odosielan√≠ e-mailu na obnovenie hesla:", error);
        showSaveNotification(`Chyba pri odosielan√≠ e-mailu: ${error.message}`, "error", 5000);
      }
    };

    // --- Listener na Zmenu Stavu Autentifik√°cie ---
    auth.onAuthStateChanged(async user => {
        console.log("onAuthStateChanged: Stav zisten√Ω.", user ? `Pou≈æ√≠vateƒæ: ${user.email}` : "≈Ωiadny pou≈æ√≠vateƒæ.");

        // Skry≈• loading overlay
        if (uiElements.loadingContainer) {
            uiElements.loadingContainer.classList.add('hidden');
        }

        // Odhl√°senie predch√°dzaj√∫ceho listenera, ak existuje
        if (state.firestoreListenerUnsubscribe) {
            console.log("Odhlasujem predch√°dzaj√∫ci Firestore listener pri zmene Auth stavu.");
            state.firestoreListenerUnsubscribe();
            state.firestoreListenerUnsubscribe = null;
        }

        if (user) {
            // Pou≈æ√≠vateƒæ je prihl√°sen√Ω
            state.userId = user.uid;
            uiElements.authMessage.textContent = `Prihl√°sen√Ω: ${user.email}`;
            uiElements.authContainer.style.display = "none";
            uiElements.calculatorContainer.style.display = "block";
            console.log("Pou≈æ√≠vateƒæ prihl√°sen√Ω, nastavujem UI a listener...");

            // Naƒç√≠tanie posledn√©ho stavu z localStorage alebo defaultn√© hodnoty
            loadInitialSettings();
            await loadFromLocalStorage(); // Naƒç√≠ta d√°ta pre aktu√°lny mesiac/rok a nastavenia
            updateUIFromLoadedData();   // Vykresl√≠ naƒç√≠tan√© d√°ta
            setupFirestoreListener();   // Nastav√≠ listener na Firebase zmeny

            // Vytvorenie/overenie u≈æ√≠vateƒæsk√©ho dokumentu vo Firestore
            const userDocRef = db.collection("users").doc(state.userId);
            try {
                const userDocSnap = await userDocRef.get();
                if (!userDocSnap.exists) {
                    await userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true });
                    console.log("Vytvoren√Ω/aktualizovan√Ω dokument pre:", state.userId);
                } else {
                    console.log("Dokument pou≈æ√≠vateƒæa existuje:", state.userId);
                }
            } catch (err) {
                console.error("Chyba pri kontrole/vytv√°ran√≠ dokumentu pou≈æ√≠vateƒæa:", err);
                showSaveNotification("Chyba pri overovan√≠ pou≈æ√≠vateƒæsk√Ωch d√°t", "error");
            }

            // Mal√© oneskorenie pre pr√≠pad offline scen√°ra hneƒè po naƒç√≠tan√≠
             setTimeout(() => {
                 if (auth.currentUser && !navigator.onLine) {
                     console.log("onAuthStateChanged (setTimeout): Offline, vol√°m loadFromLocalStorage znova...");
                     loadFromLocalStorage().then(updateUIFromLoadedData);
                 }
             }, 200);


        } else {
            // Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω
            state.userId = null;
            uiElements.authMessage.textContent = "≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.";
            uiElements.authContainer.style.display = "block";
            uiElements.calculatorContainer.style.display = "none";
            console.log("Pou≈æ√≠vateƒæ odhl√°sen√Ω/neprihl√°sen√Ω.");

            // Vyƒçistenie UI kalkulaƒçky
            state.monthData = {};
            if(uiElements.workDays) uiElements.workDays.innerHTML = '';
            if(uiElements.totalSalaryDiv) uiElements.totalSalaryDiv.innerHTML = '';
            updateWelcomeMessage(); // Skryje pozdrav
        }
    });


    // --- Spr√°va D√°t (LocalStorage & Firebase) ---

    /** Naƒç√≠ta glob√°lne nastavenia (mzda, da≈à, atƒè.) a posledn√Ω mesiac/rok z localStorage alebo nastav√≠ defaultn√©. */
    const loadInitialSettings = () => {
        const storedMonth = localStorage.getItem('currentMonth');
        const storedYear = localStorage.getItem('currentYear');
        const storedDarkMode = localStorage.getItem('darkMode');
        const storedDecimalPlaces = localStorage.getItem('decimalPlaces');
        const storedEmployeeName = localStorage.getItem('employeeName');
        const storedHourlyWage = localStorage.getItem('hourlyWage');
        const storedTaxRate = localStorage.getItem('taxRate'); // Ulo≈æen√© ako percento

        const currentDate = new Date();
        state.currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
        state.currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
        state.isDarkMode = storedDarkMode ? JSON.parse(storedDarkMode) : false;
        state.decimalPlaces = storedDecimalPlaces ? parseInt(storedDecimalPlaces) : 1;
        state.employeeName = storedEmployeeName ? JSON.parse(storedEmployeeName) : '';
        state.hourlyWage = storedHourlyWage ? parseFloat(JSON.parse(storedHourlyWage)) : 10;
        // Naƒç√≠tame percento a prepoƒç√≠tame na desatinn√© ƒç√≠slo pre intern√© pou≈æitie
        const taxRatePercent = storedTaxRate ? parseFloat(JSON.parse(storedTaxRate)) : 2;
        state.taxRate = taxRatePercent / 100;

        // Aktualiz√°cia selectov a inputov pre nastavenia
        uiElements.monthSelect.value = state.currentMonth;
        populateYearSelect(); // Najprv naplni≈•, potom nastavi≈•
        if (uiElements.yearSelect.querySelector(`option[value="${state.currentYear}"]`)) {
             uiElements.yearSelect.value = state.currentYear;
        } else {
             // Ak rok neexistuje (napr. star√° z√°loha), pridaj ho a nastav
             console.warn(`Rok ${state.currentYear} z localStorage nen√°jden√Ω, prid√°vam a pou≈æ√≠vam.`);
             const option = document.createElement('option');
             option.value = state.currentYear;
             option.textContent = state.currentYear;
             uiElements.yearSelect.appendChild(option);
             // Mo≈æno sortn√∫≈• roky? Pre jednoduchos≈• nech√°vam tak.
             uiElements.yearSelect.value = state.currentYear;
        }
        uiElements.decimalPlacesSelect.value = state.decimalPlaces;
        uiElements.employeeNameInput.value = state.employeeName;
        uiElements.hourlyWageInput.value = state.hourlyWage;
        uiElements.taxRateInput.value = state.taxRate * 100; // Zobrazi≈• ako percento

        applyDarkMode(state.isDarkMode);
        console.log("loadInitialSettings: Nastavenia naƒç√≠tan√©/inicializovan√©.");
    };


    /**
     * Naƒç√≠ta d√°ta pracovn√Ωch dn√≠ pre aktu√°lny mesiac/rok z localStorage.
     * @returns {Promise<void>}
     */
    const loadFromLocalStorage = async () => {
        console.log(`loadFromLocalStorage: Naƒç√≠tavam pre ${getMonthName(state.currentMonth)} ${state.currentYear}`);
        try {
            const storedMonthData = localStorage.getItem('workDaysData');
            state.monthData = storedMonthData ? JSON.parse(storedMonthData) : {};

            // Zabezpeƒçi≈• existenciu ≈°trukt√∫ry pre aktu√°lny rok/mesiac
            if (!state.monthData[state.currentYear]) {
                state.monthData[state.currentYear] = {};
            }
            if (!state.monthData[state.currentYear][state.currentMonth]) {
                state.monthData[state.currentYear][state.currentMonth] = [];
                console.log(`loadFromLocalStorage: Pre ${state.currentYear}-${state.currentMonth} neboli v localStorage n√°jden√© ≈æiadne z√°znamy, inicializovan√© pr√°zdne pole.`);
            } else {
                 console.log(`loadFromLocalStorage: Naƒç√≠tan√Ωch ${state.monthData[state.currentYear][state.currentMonth].length} z√°znamov pre ${state.currentYear}-${state.currentMonth} z localStorage.`);
            }
            updateDataSize(); // Aktualizova≈• ukazovateƒæ veƒækosti
        } catch (error) {
            console.error(`Kritick√° chyba pri naƒç√≠tavan√≠/spracovan√≠ d√°t z localStorage pre ${getMonthName(state.currentMonth)} ${state.currentYear}:`, error);
            showSaveNotification("Chyba pri naƒç√≠tan√≠ lok√°lnych d√°t!", "error");
            state.monthData = {}; // Reset v pr√≠pade chyby
        }
        // UI sa aktualizuje samostatne volan√≠m updateUIFromLoadedData()
    };

    /**
     * Ulo≈æ√≠ aktu√°lny stav (nastavenia a d√°ta dn√≠) do localStorage a spust√≠ ukladanie do Firebase.
     * Debouncovan√° verzia sa vol√° pri zmen√°ch.
     */
    const saveState = async () => {
        console.log("saveState: Spusten√© ukladanie...");
        try {
            // 1. Ulo≈æenie nastaven√≠ do localStorage
            localStorage.setItem('hourlyWage', JSON.stringify(state.hourlyWage));
            localStorage.setItem('taxRate', JSON.stringify(state.taxRate * 100)); // Ulo≈æi≈• ako percento
            localStorage.setItem('darkMode', JSON.stringify(state.isDarkMode));
            localStorage.setItem('decimalPlaces', JSON.stringify(state.decimalPlaces));
            localStorage.setItem('employeeName', JSON.stringify(state.employeeName));
            localStorage.setItem('currentMonth', state.currentMonth.toString());
            localStorage.setItem('currentYear', state.currentYear.toString());

            // 2. Ulo≈æenie d√°t dn√≠ (cel√° ≈°trukt√∫ra monthData) do localStorage
            const serializedMonthData = JSON.stringify(state.monthData);
            const bytes = new Blob([serializedMonthData]).size;
            if (bytes > config.MAX_DATA_SIZE * 0.9 && bytes <= config.MAX_DATA_SIZE) {
                console.warn(`Veƒækos≈• d√°t ('workDaysData') v localStorage (${(bytes / 1024).toFixed(2)} KB) sa bl√≠≈æi k limitu ${config.MAX_DATA_SIZE_KB} KB.`);
                showSaveNotification("Pozor: Lok√°lne √∫lo≈æisko je takmer pln√©!", "warning", 5000);
            } else if (bytes > config.MAX_DATA_SIZE) {
                console.error(`Prekroƒçili ste maxim√°lnu veƒækos≈• d√°t (${(bytes / 1024).toFixed(2)} KB > ${config.MAX_DATA_SIZE_KB} KB) pre d√°ta mesiacov v localStorage. Ukladanie zlyhalo.`);
                showSaveNotification(`Chyba: Lok√°lne d√°ta s√∫ pr√≠li≈° veƒæk√© (~${(bytes / 1024).toFixed(2)} KB)! Ukladanie zlyhalo. Sk√∫ste vymaza≈• star√© mesiace alebo vytvori≈• z√°lohu a resetova≈•.`, "error", 10000);
                return; // Neuklada≈•, ak je prekroƒçen√Ω limit
            }
            localStorage.setItem('workDaysData', serializedMonthData);
            updateDataSize(); // Aktualizova≈• ukazovateƒæ

            // 3. Spustenie ukladania do Firebase (ak je pou≈æ√≠vateƒæ prihl√°sen√Ω)
            if (state.userId) {
                 await saveToFirebase();
                 // Notifik√°cia o √∫spe≈°nom ulo≈æen√≠ sa zobraz√≠, keƒè Firebase potvrd√≠ (v listeneri)
                 // alebo ak sme offline
                 if (!navigator.onLine) {
                    showSaveNotification("Offline: Zmeny ulo≈æen√© lok√°lne", "warning");
                 }
            } else {
                console.log("saveState: Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω, uklad√°m len lok√°lne.");
                showSaveNotification("Zmeny ulo≈æen√© lok√°lne (neprihl√°sen√Ω)", "success");
            }

        } catch (error) {
            console.error('Chyba pri ukladan√≠ stavu (lok√°lne/spusten√≠ Firebase save):', error);
            showSaveNotification("Kritick√° chyba pri ukladan√≠!", "error", 5000);
        }
    };
    // Vytvorenie debouncovanej verzie saveState
    const debouncedSaveState = debounce(saveState, config.DEBOUNCE_TIME);


    /** Ulo≈æ√≠ d√°ta *aktu√°lneho* mesiaca a nastavenia do Firebase. */
    const saveToFirebase = async () => {
        if (!state.userId) {
            console.log("saveToFirebase: Nikto nie je prihl√°sen√Ω.");
            return;
        }
        if (state.currentMonth === null || state.currentYear === null) {
            console.error("saveToFirebase: Ch√Ωba aktu√°lny mesiac alebo rok.");
            return;
        }

        try {
            // Pripravi≈• d√°ta na ulo≈æenie - len aktu√°lny mesiac + glob√°lne nastavenia
            const currentMonthWorkData = state.monthData?.[state.currentYear]?.[state.currentMonth] || [];
            // Oƒçistenie d√°t pred ulo≈æen√≠m (odstr√°nenie null/undefined hodn√¥t)
            const cleanMonthWorkData = currentMonthWorkData.map(day => ({
                start: day.start || '',
                end: day.end || '',
                breakTime: day.breakTime || '' // Uklad√°me ako string, aj keƒè je to ƒç√≠slo v inpute? Zjednot√≠me na string.
            }));

            console.log(`saveToFirebase: Pripravujem na ulo≈æenie ${cleanMonthWorkData.length} z√°znamov pre ${state.currentYear}-${state.currentMonth}.`);

            const dataToSave = {
                days: cleanMonthWorkData,
                hourlyWage: state.hourlyWage || 10,
                taxRate: (state.taxRate * 100) || 2, // Ulo≈æi≈• ako percento
                decimalPlaces: state.decimalPlaces || 1,
                employeeName: state.employeeName || '',
                darkMode: state.isDarkMode || false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // ƒåasov√° znaƒçka poslednej √∫pravy
            };

            const yearMonthDoc = `${state.currentYear}-${state.currentMonth}`;
            const docRef = db.collection("users").doc(state.userId).collection("calculatorData").doc(yearMonthDoc);

            // Pou≈æijeme set s merge=true, aby sme neprepisovali ostatn√© polia, ak by existovali,
            // ale v tomto pr√≠pade chceme prep√≠sa≈• cel√Ω dokument pre dan√Ω mesiac
            await docRef.set(dataToSave);
            console.log(`saveToFirebase: Po≈æiadavka na ulo≈æenie d√°t pre ${yearMonthDoc} odoslan√°.`);
            // Notifik√°cia o √∫spechu sa zvyƒçajne zobraz√≠ v listeneri, keƒè d√°ta dorazia sp√§≈•

        } catch (error) {
            console.error(`Chyba pri po≈æiadavke na ukladanie do Firebase pre ${state.currentYear}-${state.currentMonth}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa odosla≈• d√°ta do Firebase", "error", 5000);
        }
    };


    /** Nastav√≠ Firestore listener pre aktu√°lny mesiac a rok. */
    const setupFirestoreListener = () => {
        // Odhl√°si≈• star√Ω listener, ak existuje
        if (state.firestoreListenerUnsubscribe) {
            console.log("setupFirestoreListener: Odhlasujem predch√°dzaj√∫ci listener.");
            state.firestoreListenerUnsubscribe();
            state.firestoreListenerUnsubscribe = null;
        }

        if (!state.userId) {
            console.log("setupFirestoreListener: Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω, listener sa nenastavuje.");
            return;
        }
        if (state.currentMonth === null || state.currentYear === null) {
            console.error("setupFirestoreListener: Ch√Ωba aktu√°lny mesiac alebo rok.");
            return; // Nem√¥≈æeme nastavi≈• listener bez platn√©ho mesiaca/roka
        }

        const docPath = `users/${state.userId}/calculatorData/${state.currentYear}-${state.currentMonth}`;
        const docRef = db.doc(docPath);
        console.log(`setupFirestoreListener: Nastavujem listener pre ${docPath}`);

        state.firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
            console.log(`Firestore listener: Prijat√Ω snapshot pre ${docPath}. Metadata: fromCache=${docSnap.metadata.fromCache}, hasPendingWrites=${docSnap.metadata.hasPendingWrites}`);

            // Ignorova≈• prv√© volanie z cache, ak m√°me d√°ta zo servera (prevencia dvojit√©ho spracovania)
            // POZN: Toto m√¥≈æe by≈• zlo≈æit√©, hasPendingWrites je spoƒæahlivej≈°ie na ignorovanie lok√°lnych zmien
             if (docSnap.metadata.hasPendingWrites) {
                 console.log("Listener: Detekovan√° lok√°lna zmena ƒçakaj√∫ca na z√°pis. Preskakujem aktualiz√°ciu UI z tohto snapshotu.");
                 // M√¥≈æeme zobrazi≈• indik√°tor synchroniz√°cie
                 showSaveNotification("Synchronizujem lok√°lne zmeny...", "warning", 1500);
                 // Aj keƒè preskakujeme UI update, m√¥≈æeme chcie≈• aktualizova≈• localStorage, aby zodpovedal tomu, ƒço sa *malo* ulo≈æi≈•
                 if (docSnap.exists) {
                     try {
                        const localData = docSnap.data({ serverTimestamps: 'estimate' }); // estimate pre pending writes
                        const localDaysData = localData.days || [];
                         if (!state.monthData) state.monthData = {};
                         if (!state.monthData[state.currentYear]) state.monthData[state.currentYear] = {};
                         state.monthData[state.currentYear][state.currentMonth] = localDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '' }));
                         localStorage.setItem('workDaysData', JSON.stringify(state.monthData));
                         console.log("Listener (pending): Aktualizovan√Ω localStorage podƒæa lok√°lneho snapshotu.");
                     } catch(e) { console.error("Listener (pending): Chyba pri spracovan√≠ lok√°lneho snapshotu", e);}
                 }
                 return; // D√¥le≈æit√© - neaktualizova≈• UI/state z lok√°lneho echa
             }

            // Spracovanie d√°t zo servera alebo z cache (ak nie s√∫ pending writes)
            if (docSnap.exists) {
                const data = docSnap.data(); // { serverTimestamps: 'estimate' } nie je nutn√©, ak nie s√∫ pending writes
                console.log(`Listener: Dokument ${state.currentYear}-${state.currentMonth} existuje (server/cache). Naƒç√≠tan√© d√°ta:`, data);

                try {
                    // Naƒç√≠tanie nastaven√≠ z Firebase - POU≈ΩI≈§ LEN AK CHCEME, ABY FIREBASE PREPISOVAL LOK√ÅLNE NASTAVENIA
                    // ƒåasto je lep≈°ie necha≈• lok√°lne nastavenia ako "master", pokiaƒæ pou≈æ√≠vateƒæ explicitne neobnov√≠
                    // Ak chceme synchronizova≈• nastavenia cez Firebase:
                    const fbHourlyWage = data.hourlyWage ?? state.hourlyWage;
                    const fbTaxRatePercent = data.taxRate ?? (state.taxRate * 100);
                    const fbDecimalPlaces = data.decimalPlaces ?? state.decimalPlaces;
                    const fbEmployeeName = data.employeeName ?? state.employeeName;
                    const fbDarkMode = data.darkMode ?? state.isDarkMode;

                    let settingsChanged = false;
                    if (state.hourlyWage !== fbHourlyWage) { state.hourlyWage = fbHourlyWage; settingsChanged = true; }
                    if (state.taxRate * 100 !== fbTaxRatePercent) { state.taxRate = fbTaxRatePercent / 100; settingsChanged = true; }
                    if (state.decimalPlaces !== fbDecimalPlaces) { state.decimalPlaces = fbDecimalPlaces; settingsChanged = true; }
                    if (state.employeeName !== fbEmployeeName) { state.employeeName = fbEmployeeName; settingsChanged = true; }
                    if (state.isDarkMode !== fbDarkMode) { state.isDarkMode = fbDarkMode; settingsChanged = true; }

                    // Naƒç√≠tanie d√°t dn√≠ z Firebase
                    const firebaseDaysData = data.days || [];
                    if (!state.monthData) state.monthData = {};
                    if (!state.monthData[state.currentYear]) state.monthData[state.currentYear] = {};
                    // Porovnanie, ƒçi sa d√°ta dn√≠ re√°lne zmenili, aby sme zbytoƒçne neprepisovali
                    const currentLocalDaysString = JSON.stringify(state.monthData[state.currentYear][state.currentMonth] || []);
                    const firebaseDaysString = JSON.stringify(firebaseDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '' })));

                    let daysChanged = false;
                    if (currentLocalDaysString !== firebaseDaysString) {
                        state.monthData[state.currentYear][state.currentMonth] = firebaseDaysData.map(day => ({
                            start: day.start || '',
                            end: day.end || '',
                            breakTime: day.breakTime || '' // Uisti≈• sa, ≈æe breakTime je string? Alebo ƒç√≠slo? Zjednoti≈•. Tu nech√°vam string.
                        }));
                        daysChanged = true;
                        console.log(`Listener: D√°ta dn√≠ pre ${state.currentYear}-${state.currentMonth} aktualizovan√© z Firebase.`);
                    } else {
                         console.log(`Listener: D√°ta dn√≠ pre ${state.currentYear}-${state.currentMonth} sa nezhoduj√∫ s Firebase.`);
                    }


                    // Ak sa ƒçokoƒævek zmenilo (nastavenia alebo dni), aktualizuj localStorage a UI
                    if (settingsChanged || daysChanged) {
                        console.log("Listener: Detekovan√© zmeny z Firebase, aktualizujem localStorage a UI.");
                        // Ulo≈æi≈• V≈†ETKY aktu√°lne naƒç√≠tan√©/aktualizovan√© nastavenia a d√°ta do localStorage
                        localStorage.setItem('hourlyWage', JSON.stringify(state.hourlyWage));
                        localStorage.setItem('taxRate', JSON.stringify(state.taxRate * 100));
                        localStorage.setItem('darkMode', JSON.stringify(state.isDarkMode));
                        localStorage.setItem('decimalPlaces', JSON.stringify(state.decimalPlaces));
                        localStorage.setItem('employeeName', JSON.stringify(state.employeeName));
                        localStorage.setItem('workDaysData', JSON.stringify(state.monthData)); // Ulo≈æi≈• cel√∫ ≈°trukt√∫ru
                        console.log("Listener: Zmeny z Firebase ulo≈æen√© do localStorage.");

                        // Aktualizova≈• UI s nov√Ωmi d√°tami (funkcia by mala by≈• schopn√° spracova≈• aktu√°lny `state`)
                        updateUIFromLoadedData(true); // true = signalizuje, ≈æe ide o update z listenera
                    } else {
                        console.log("Listener: Prijat√© d√°ta z Firebase s√∫ rovnak√© ako lok√°lne, UI sa neaktualizuje.");
                    }

                     // Zobrazi≈• notifik√°ciu o √∫spe≈°nej synchroniz√°cii, len ak d√°ta pri≈°li zo servera
                     if (!docSnap.metadata.fromCache) {
                         console.log("Listener: D√°ta prijat√© priamo zo SERVERA.");
                         // Zobraz notifik√°ciu len ak boli re√°lne zmeny (aby nespamovala pri ka≈ædom potvrden√≠)
                         if(settingsChanged || daysChanged) {
                             showSaveNotification("D√°ta synchronizovan√© s cloudom", "success", 2000);
                         }
                     }

                } catch (processError) {
                    console.error(`Listener: Chyba pri spracovan√≠ d√°t z Firestore pre ${state.currentYear}-${state.currentMonth}:`, processError);
                    showSaveNotification("Chyba: Nespr√°vny form√°t d√°t z Firebase", "error");
                }
            } else {
                // Dokument na Firebase neexistuje
                console.log(`Listener: Dokument neexistuje (server/cache) na Firebase pre ${state.currentYear}-${state.currentMonth}.`);
                // Ak dokument neexistuje na serveri, mali by sme vymaza≈• lok√°lne d√°ta pre tento mesiac?
                // ALEBO predpoklada≈•, ≈æe lok√°lne d√°ta s√∫ spr√°vne a nahra≈• ich?
                // S√∫ƒçasn√© spr√°vanie: Nech√° lok√°lne d√°ta, ak existuj√∫, a zobraz√≠ ich. Ak neexistuj√∫, zobraz√≠ pr√°zdnu tabuƒæku.
                // Ak chceme, aby sa lok√°lne d√°ta automaticky nahrali, ak na serveri niƒç nie je:
                /*
                if (state.monthData?.[state.currentYear]?.[state.currentMonth]?.length > 0) {
                    console.log("Listener: Dokument na Firebase neexistuje, ale m√°me lok√°lne d√°ta. Nahr√°vam ich...");
                    saveToFirebase(); // Pozor na mo≈æn√© nekoneƒçn√© cykly, ak save zlyh√°
                } else {
                    // Ak neexistuje ani na serveri, ani lok√°lne, resetn√∫≈• v state pre istotu
                     if (!state.monthData) state.monthData = {};
                     if (!state.monthData[state.currentYear]) state.monthData[state.currentYear] = {};
                     state.monthData[state.currentYear][state.currentMonth] = [];
                     localStorage.setItem('workDaysData', JSON.stringify(state.monthData));
                     updateUIFromLoadedData(true); // Prekresli≈• (pr√°zdnu) tabuƒæku
                }
                */
                // S√∫ƒçasn√Ω k√≥d implicitne nech√°va lok√°lne d√°ta, ak existuj√∫, ƒço je asi bezpeƒçnej≈°ie.
                // Ak lok√°lne d√°ta neexistuj√∫ a na serveri tie≈æ nie, `loadFromLocalStorage` u≈æ vytvoril pr√°zdne pole.
                // M√¥≈æeme ale explicitne zabezpeƒçi≈•, ≈æe ak dokument zmizne zo servera, vyma≈æe sa aj lok√°lne:
                 if (state.monthData?.[state.currentYear]?.[state.currentMonth]?.length > 0) {
                     console.log(`Listener: Dokument ${state.currentYear}-${state.currentMonth} zmizol z Firebase. Resetujem lok√°lne d√°ta pre tento mesiac.`);
                     if (!state.monthData) state.monthData = {};
                     if (!state.monthData[state.currentYear]) state.monthData[state.currentYear] = {};
                     state.monthData[state.currentYear][state.currentMonth] = [];
                     localStorage.setItem('workDaysData', JSON.stringify(state.monthData)); // Ulo≈æi≈• zmenu
                     updateUIFromLoadedData(true); // Prekresli≈• UI (pr√°zdne)
                     showSaveNotification(`D√°ta pre ${getMonthName(state.currentMonth)} ${state.currentYear} boli odstr√°nen√© zo servera.`, "warning", 4000);
                 }

            }
        }, (error) => {
            console.error(`Firestore listener chyba pre ${docPath}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa pripoji≈• k Firebase", "error", 5000);
            // Fallback na lok√°lne d√°ta v pr√≠pade chyby listenera
            console.log("Listener chyba, sna≈æ√≠m sa naƒç√≠ta≈• z localStorage ako fallback...");
            loadFromLocalStorage().then(() => updateUIFromLoadedData());
        });
    };


    // --- Funkcie pre UI a V√Ωpoƒçty ---

    /**
     * Aktualizuje UI elementy (inputy, selecty) na z√°klade aktu√°lneho stavu (state).
     * @param {boolean} fromListener - Indikuje, ƒçi volanie poch√°dza z Firestore listenera (pre pr√≠padn√© odli≈°n√© spr√°vanie).
     */
    const updateUIFromLoadedData = (fromListener = false) => {
        console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(state.currentMonth)} ${state.currentYear}. Volan√© z listenera: ${fromListener}`);
        try {
            // Aktualiz√°cia glob√°lnych nastaven√≠ v UI (len ak nie je element pr√°ve fokusovan√Ω, aby sa nepreru≈°ilo p√≠sanie)
            if (document.activeElement !== uiElements.hourlyWageInput) {
                uiElements.hourlyWageInput.value = state.hourlyWage;
            }
            if (document.activeElement !== uiElements.taxRateInput) {
                uiElements.taxRateInput.value = state.taxRate * 100;
            }
            if (document.activeElement !== uiElements.decimalPlacesSelect) {
                uiElements.decimalPlacesSelect.value = state.decimalPlaces;
            }
            if (document.activeElement !== uiElements.employeeNameInput) {
                uiElements.employeeNameInput.value = state.employeeName;
            }

            // Aktualiz√°cia selectov mesiaca a roka (tie by nemali by≈• fokusovan√© poƒças zmeny)
            if (uiElements.monthSelect.value != state.currentMonth) { // != kv√¥li porovnaniu string vs number
                uiElements.monthSelect.value = state.currentMonth;
            }
             if (uiElements.yearSelect.value != state.currentYear) {
                if (uiElements.yearSelect.querySelector(`option[value="${state.currentYear}"]`)) {
                    uiElements.yearSelect.value = state.currentYear;
                } else {
                    // Rok sa nenach√°dza, mohol by≈• zmenen√Ω externe? Rad≈°ej reloadn√∫≈• cel√© nastavenia
                    console.warn(`Rok ${state.currentYear} v stave nen√°jden√Ω v selecte pri updateUI. Reloadujem nastavenia.`);
                    loadInitialSettings(); // Reloadne vsetky nastavenia a updatne UI spravne
                }
            }

            // Vytvorenie alebo aktualiz√°cia tabuƒæky
            createTable(); // V≈ædy prekresl√≠ ≈°trukt√∫ru tabuƒæky pre dan√Ω mesiac

            // Naplnenie d√°t do vytvorenej tabuƒæky
            const dataForCurrentMonth = state.monthData?.[state.currentYear]?.[state.currentMonth] || [];
            console.log(`updateUIFromLoadedData: Poƒçet z√°znamov v state pre ${state.currentYear}-${state.currentMonth} pri plnen√≠ UI: ${dataForCurrentMonth.length}`);

            const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
            for (let i = 1; i <= daysInMonth; i++) {
                const dayData = dataForCurrentMonth[i - 1]; // D√°ta s√∫ 0-indexovan√©
                const startElement = document.getElementById(`start-${state.currentYear}-${state.currentMonth}-${i}`);
                const endElement = document.getElementById(`end-${state.currentYear}-${state.currentMonth}-${i}`);
                const breakElement = document.getElementById(`break-${state.currentYear}-${state.currentMonth}-${i}`);

                if (startElement && endElement && breakElement) {
                    const currentStart = dayData?.start || '';
                    const currentEnd = dayData?.end || '';
                    const currentBreak = dayData?.breakTime || ''; // Predpoklad√°me string

                    // Aktualizuj hodnotu len ak sa l√≠≈°i A element nie je akt√≠vny (aby listener neprepisoval pr√°ve menen√© pole)
                     if (startElement.value !== currentStart && document.activeElement !== startElement) {
                         startElement.value = currentStart;
                     }
                     if (endElement.value !== currentEnd && document.activeElement !== endElement) {
                         endElement.value = currentEnd;
                     }
                     if (breakElement.value !== currentBreak && document.activeElement !== breakElement) {
                         breakElement.value = currentBreak;
                     }
                    calculateRow(i); // Prepoƒç√≠taj odpracovan√Ω ƒças a mzdu pre riadok
                } else if (document.getElementById(`total-${state.currentYear}-${state.currentMonth}-${i}`)) {
                     // Ak existuje aspo≈à total bunka, ale inputy ch√Ωbaj√∫, je to chyba
                     console.error(`Kritick√° chyba: Elementy (start/end/break) pre de≈à ${i} v updateUIFromLoadedData neboli n√°jden√© po createTable!`);
                }
            }

            calculateTotal(); // Prepoƒç√≠taj celkov√Ω s√∫hrn
            updateDataSize(); // Aktualizuj veƒækos≈• d√°t
            applyDarkMode(state.isDarkMode); // Aplikuj tmav√Ω re≈æim
            updateWelcomeMessage(); // Aktualizuj pozdrav
            console.log("UI aktualizovan√©.");

        } catch (error) {
            console.error("Chyba poƒças aktualiz√°cie UI:", error);
            showSaveNotification("Chyba pri prekresƒæovan√≠ UI!", "error");
        }
    };


    /** Aplikuje alebo odstr√°ni triedy pre tmav√Ω re≈æim. */
    const applyDarkMode = (isDark) => {
        state.isDarkMode = isDark; // Ulo≈æenie aktu√°lneho stavu
        const body = document.body;
        const container = uiElements.calculatorContainer;
        const authCont = uiElements.authContainer;
        // Dynamicky n√°jdeme v≈°etky relevantn√© elementy, ktor√© potrebuj√∫ zmenu triedy
        const elementsToToggle = [
            body, container, authCont,
            uiElements.totalSalaryDiv,
            ...document.querySelectorAll('table, th, td'), // Tabuƒæka
            ...document.querySelectorAll('input[type="text"], input[type="number"], input[type="tel"], input[type="email"], input[type="password"], select'), // V≈°etky inputy a selecty
            ...document.querySelectorAll('.btn'), // V≈°etky tlaƒçidl√°
            uiElements.authMessage, ...document.querySelectorAll('#auth-container h1, #auth-container h2'), // Auth texty
             document.querySelector('.autor-info'), uiElements.welcomeMessage, // Ostatn√© texty
        ];

        if (isDark) {
            elementsToToggle.forEach(el => el?.classList.add('dark-mode'));
            if (uiElements.darkModeIcon) uiElements.darkModeIcon.classList.replace('fa-moon', 'fa-sun');
        } else {
            elementsToToggle.forEach(el => el?.classList.remove('dark-mode'));
             if (uiElements.darkModeIcon) uiElements.darkModeIcon.classList.replace('fa-sun', 'fa-moon');
        }
        // ≈†peci√°lne o≈°etrenie pre aktu√°lny de≈à, ak existuje
        const currentDayRow = document.querySelector('.current-day');
        if (currentDayRow) {
            if (isDark) currentDayRow.classList.add('dark-mode');
            else currentDayRow.classList.remove('dark-mode');
        }
    };

    /** Prepne tmav√Ω re≈æim. */
    const toggleDarkMode = () => {
        const newDarkModeState = !state.isDarkMode;
        applyDarkMode(newDarkModeState);
        localStorage.setItem('darkMode', JSON.stringify(newDarkModeState)); // Ulo≈æ hneƒè
        // Ak je pou≈æ√≠vateƒæ prihl√°sen√Ω, po≈°li zmenu aj do Firebase (cez debounced save)
        if (state.userId) {
            debouncedSaveState(); // Spust√≠ ukladanie cel√©ho stavu vr√°tane darkMode
        }
    };


    /** Vytvor√≠ ≈°trukt√∫ru tabuƒæky pre aktu√°lny mesiac a rok. */
    const createTable = () => {
        if (!uiElements.workDays) return;
        uiElements.workDays.innerHTML = ''; // Vyƒçisti≈• star√∫ tabuƒæku
        const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
        const today = new Date();
        const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth();
        const currentYearValue = today.getFullYear();
        const fragment = document.createDocumentFragment(); // Pre lep≈°√≠ v√Ωkon

        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            const isCurrentDay = (i === currentDayOfMonth && state.currentMonth === currentMonthIndex && state.currentYear === currentYearValue);
            if (isCurrentDay) {
                row.classList.add('current-day');
            }

            const dayName = getDayName(state.currentYear, state.currentMonth, i);
            const year = state.currentYear; // Pou≈æijeme aktu√°lny rok zo stavu
            const month = state.currentMonth; // Pou≈æijeme aktu√°lny mesiac zo stavu

            // Pou≈æitie template literals pre lep≈°iu ƒçitateƒænos≈•
            row.innerHTML = `
                <td>De≈à ${i} (${dayName})</td>
                <td><input type="tel" id="start-${year}-${month}-${i}" maxlength="5" pattern="([01]\\d|2[0-3]):[0-5]\\d" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, 'end-${year}-${month}-${i}', ${i})"></td>
                <td><input type="tel" id="end-${year}-${month}-${i}" maxlength="5" pattern="([01]\\d|2[0-3]):[0-5]\\d" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, 'break-${year}-${month}-${i}', ${i})"></td>
                <td><input type="number" id="break-${year}-${month}-${i}" min="0" step="0.1" placeholder="hodiny" oninput="handleBreakInput(${i})"></td>
                <td id="total-${year}-${month}-${i}">0h 0m (${(0).toFixed(state.decimalPlaces)} h)</td>
                <td><input type="number" id="gross-${year}-${month}-${i}" min="0" step="0.01" placeholder="Hrub√° Mzda" readonly></td>
                <td><input type="number" id="net-${year}-${month}-${i}" min="0" step="0.01" placeholder="ƒåist√° Mzda" readonly></td>
                <td><button class="btn reset-btn" onclick="resetRow(${i})">Reset</button></td>
            `;
            fragment.appendChild(row);
        }
        uiElements.workDays.appendChild(fragment);
        // Aplikova≈• tmav√Ω re≈æim na novovytvoren√© elementy tabuƒæky
        applyDarkMode(state.isDarkMode);
    };


    /**
     * Spracuje vstup do pol√≠ pre ƒças (Pr√≠chod, Odchod).
     * Form√°tuje vstup, aktualizuje stav a prepoƒç√≠ta riadok.
     * @param {HTMLInputElement} input Element inputu.
     * @param {string} nextId ID nasleduj√∫ceho elementu pre focus.
     * @param {number} day De≈à v mesiaci (1-based).
     */
    const handleTimeInput = (input, nextId, day) => {
        formatTimeInput(input); // Form√°tovanie HH:MM
        updateStateFromInput(input, day); // Ulo≈æenie hodnoty do state.monthData
        calculateRow(day); // Prepoƒç√≠tanie hod√≠n a mzdy pre riadok
        debouncedSaveState(); // Spustenie (debouncovan√©ho) ukladania

        // Automatick√Ω presun na ƒèal≈°ie pole po zadan√≠ 5 znakov (HH:MM)
        if (input.value.length === 5 && isTimeValid(input.value)) {
             moveFocus(input, nextId);
        } else if (input.value.length === 5 && !isTimeValid(input.value)) {
            // Oznaƒçi≈• chybu, ak form√°t je HH:MM, ale ƒças je neplatn√Ω (napr. 25:00)
            input.classList.add('error-border');
            setTimeout(() => input.classList.remove('error-border'), 2000);
        } else {
             input.classList.remove('error-border'); // Odstr√°ni≈• chybu, ak sa oprav√≠
        }
    };

    /**
     * Spracuje vstup do poƒæa pre prest√°vku.
     * Aktualizuje stav a prepoƒç√≠ta riadok.
     * @param {number} day De≈à v mesiaci (1-based).
     */
    const handleBreakInput = (day) => {
        const input = document.getElementById(`break-${state.currentYear}-${state.currentMonth}-${day}`);
        if (!input) return;
        updateStateFromInput(input, day); // Ulo≈æenie hodnoty do state.monthData
        calculateRow(day); // Prepoƒç√≠tanie hod√≠n a mzdy pre riadok
        debouncedSaveState(); // Spustenie (debouncovan√©ho) ukladania

        // Po zadan√≠ prest√°vky m√¥≈æeme presun√∫≈• fokus na zaƒçiatok ƒèal≈°ieho d≈àa
        // (Toto je voliteƒæn√©, m√¥≈æe by≈• otravn√©)
        /*
        const nextDay = day + 1;
        const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
        if (nextDay <= daysInMonth) {
            const nextInputElementId = `start-${state.currentYear}-${state.currentMonth}-${nextDay}`;
            moveFocus(input, nextInputElementId);
        }
        */
    };

    /**
     * Aktualizuje `state.monthData` na z√°klade hodnoty z input elementu.
     * @param {HTMLInputElement} input Element inputu.
     * @param {number} day De≈à v mesiaci (1-based).
     */
    const updateStateFromInput = (input, day) => {
        if (!input) return;
        const dayIndex = day - 1; // Index v poli (0-based)
        const fieldId = input.id; // napr. start-2023-11-15
        let fieldKey = 'unknown'; // Kƒæ√∫ƒç v objekte d≈àa ('start', 'end', 'breakTime')

        if (fieldId.startsWith('start-')) fieldKey = 'start';
        else if (fieldId.startsWith('end-')) fieldKey = 'end';
        else if (fieldId.startsWith('break-')) fieldKey = 'breakTime';

        const value = input.value;

        if (fieldKey !== 'unknown') {
            // Zabezpeƒçenie existencie ≈°trukt√∫ry v state
            if (!state.monthData) state.monthData = {};
            if (!state.monthData[state.currentYear]) state.monthData[state.currentYear] = {};
            if (!state.monthData[state.currentYear][state.currentMonth]) state.monthData[state.currentYear][state.currentMonth] = [];

            // Doplnenie pr√°zdnych objektov dn√≠, ak pole nie je dos≈• dlh√©
            while (state.monthData[state.currentYear][state.currentMonth].length <= dayIndex) {
                state.monthData[state.currentYear][state.currentMonth].push({ start: '', end: '', breakTime: '' });
            }

            // Aktualiz√°cia hodnoty v state
            if (state.monthData[state.currentYear][state.currentMonth][dayIndex]) {
                state.monthData[state.currentYear][state.currentMonth][dayIndex][fieldKey] = value;
                 // console.log(`State updated: Day ${day}, Field ${fieldKey}, Value ${value}`);
            } else {
                // Toto by nemalo nasta≈• vƒèaka while cyklu hore, ale pre istotu logujeme
                console.error(`updateStateFromInput: Ch√Ωba z√°znam pre de≈à ${dayIndex} (${day}) v state.monthData po inicializ√°cii!`);
                // Sk√∫sime vytvori≈• objekt pre tento de≈à
                 state.monthData[state.currentYear][state.currentMonth][dayIndex] = { start: '', end: '', breakTime: '', [fieldKey]: value };
            }
        } else {
            console.warn("updateStateFromInput: Nerozpoznan√© pole pre input ID:", fieldId);
        }
    };

    /**
     * Form√°tuje vstup v ƒçasovom poli na HH:MM poƒças p√≠sania.
     * @param {HTMLInputElement} input Cieƒæov√Ω input element.
     */
    const formatTimeInput = (input) => {
        if (!input || input.type !== 'tel') return;
        let value = input.value.replace(/[^\d]/g, ''); // Odstr√°ni v≈°etko okrem ƒç√≠sel

        if (value.length > 4) {
            value = value.slice(0, 4); // Max 4 ƒç√≠sla
        }

        if (value.length === 3) {
            // Ak pou≈æ√≠vateƒæ zad√° napr. "123", predpoklad√°me "12:3"
            value = value.slice(0, 2) + ':' + value.slice(2);
        } else if (value.length === 4) {
            // Ak pou≈æ√≠vateƒæ zad√° "1234", form√°tujeme na "12:34"
            value = value.slice(0, 2) + ':' + value.slice(2);
        }
        // Neform√°tujeme, ak je dƒ∫≈æka 1 alebo 2, nech√°me pou≈æ√≠vateƒæa p√≠sa≈• hodiny

        input.value = value; // Nastav√≠me upraven√∫ hodnotu sp√§≈• do inputu
    };

    /**
     * Skontroluje, ƒçi re≈•azec zodpoved√° platn√©mu form√°tu ƒçasu HH:MM (00:00 - 23:59).
     * @param {string} timeStr Re≈•azec na kontrolu.
     * @returns {boolean} True, ak je platn√Ω, inak false.
     */
    const isTimeValid = (timeStr) => {
        if (!timeStr) return false;
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        return timeRegex.test(timeStr);
    };

    /**
     * Presunie focus na nasleduj√∫ci element, ak existuje.
     * @param {HTMLElement} currentElement Aktu√°lny element, z ktor√©ho sa pres√∫va focus.
     * @param {string | null} nextId ID nasleduj√∫ceho elementu.
     */
    const moveFocus = (currentElement, nextId) => {
        if (!nextId || !currentElement) return;
        const nextElement = document.getElementById(nextId);
        if (nextElement) {
            // Presun√∫≈• focus len ak ho m√° aktu√°lny element
            if (document.activeElement === currentElement) {
                console.log(`moveFocus: Pres√∫vam fokus z ${currentElement.id} na ${nextId}`);
                nextElement.focus();
                // Ak je to input, m√¥≈æeme ho aj vyselektova≈•
                if (nextElement.select) {
                    nextElement.select();
                }
            } else {
                 console.log(`moveFocus: Aktu√°lny element ${currentElement.id} u≈æ nem√° fokus, presun preskoƒçen√Ω.`);
            }
        } else {
            console.warn(`moveFocus: Element s ID ${nextId} nebol n√°jden√Ω.`);
        }
    };

    /**
     * Vypoƒç√≠ta odpracovan√Ω ƒças, hrub√∫ a ƒçist√∫ mzdu pre dan√Ω riadok (de≈à) a aktualizuje pr√≠slu≈°n√© bunky.
     * @param {number} day De≈à v mesiaci (1-based).
     */
    const calculateRow = (day) => {
        const year = state.currentYear;
        const month = state.currentMonth;
        const startInput = document.getElementById(`start-${year}-${month}-${day}`);
        const endInput = document.getElementById(`end-${year}-${month}-${day}`);
        const breakInput = document.getElementById(`break-${year}-${month}-${day}`);
        const totalCell = document.getElementById(`total-${year}-${month}-${day}`);
        const grossElement = document.getElementById(`gross-${year}-${month}-${day}`);
        const netElement = document.getElementById(`net-${year}-${month}-${day}`);

        // Z√°kladn√° kontrola existencie elementov
        if (!startInput || !endInput || !breakInput || !totalCell || !grossElement || !netElement) {
             console.error(`Chyba v calculateRow(${day}): Jeden alebo viac elementov nen√°jden√Ωch.`);
             return;
        }

        const startTimeStr = startInput.value;
        const endTimeStr = endInput.value;
        // Prest√°vka je v hodin√°ch (napr. 0.5), pre v√Ωpoƒçet potrebujeme min√∫ty
        const breakTimeHours = parseFloat(breakInput.value) || 0;
        const breakMinutes = breakTimeHours * 60;

        // Ak ch√Ωba pr√≠chod alebo odchod, alebo nie s√∫ platn√©, vynuluj v√Ωsledky
        if (!isTimeValid(startTimeStr) || !isTimeValid(endTimeStr)) {
            totalCell.textContent = `0h 0m (${(0).toFixed(state.decimalPlaces)} h)`;
            grossElement.value = '0.00';
            netElement.value = '0.00';
            startInput.classList.toggle('error-border', startTimeStr.length > 0 && !isTimeValid(startTimeStr));
            endInput.classList.toggle('error-border', endTimeStr.length > 0 && !isTimeValid(endTimeStr));
            return;
        }

        // Odstr√°ni≈• pr√≠padn√© chybov√© oznaƒçenie, ak s√∫ ƒçasy platn√©
        startInput.classList.remove('error-border');
        endInput.classList.remove('error-border');


        // V√Ωpoƒçet odpracovan√©ho ƒçasu v min√∫tach
        const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
        const [endHours, endMinutes] = endTimeStr.split(':').map(Number);

        const startTotalMinutes = startHours * 60 + startMinutes;
        let endTotalMinutes = endHours * 60 + endMinutes;

        // O≈°etrenie pr√°ce cez polnoc
        if (endTotalMinutes < startTotalMinutes) {
            endTotalMinutes += 24 * 60; // Pridaj 24 hod√≠n v min√∫tach
        }

        const diffMinutes = endTotalMinutes - startTotalMinutes;
        const workedMinutes = Math.max(0, diffMinutes - breakMinutes); // Celkov√Ω odpracovan√Ω ƒças v min√∫tach

        // Prevod na hodiny a min√∫ty pre zobrazenie
        const hours = Math.floor(workedMinutes / 60);
        const minutes = Math.round(workedMinutes % 60); // Zaokr√∫hli≈• min√∫ty
        const decimalHours = workedMinutes / 60; // Desatinn√© hodiny pre v√Ωpoƒçet mzdy

        // Aktualiz√°cia bunky s odpracovan√Ωm ƒçasom
        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(state.decimalPlaces)} h)`;

        // V√Ωpoƒçet mzdy
        const currentHourlyWage = state.hourlyWage;
        const currentTaxRate = state.taxRate; // Pou≈æi≈• desatinn√© ƒç√≠slo
        const grossSalary = decimalHours * currentHourlyWage;
        const netSalary = grossSalary * (1 - currentTaxRate);

        // Aktualiz√°cia inputov pre mzdu (form√°tovan√© na 2 des. miesta)
        grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00';
        netElement.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00';
    };

     /** Resetuje hodnoty pre dan√Ω riadok (de≈à) v UI a v stave. */
    const resetRow = (day) => {
        const year = state.currentYear;
        const month = state.currentMonth;
        const dayIndex = day - 1;

        // Resetovanie inputov v UI
        const startInput = document.getElementById(`start-${year}-${month}-${day}`);
        const endInput = document.getElementById(`end-${year}-${month}-${day}`);
        const breakInput = document.getElementById(`break-${year}-${month}-${day}`);
        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
        if (breakInput) breakInput.value = '';

        // Resetovanie v stave
        if (state.monthData?.[year]?.[month]?.[dayIndex]) {
            state.monthData[year][month][dayIndex] = { start: '', end: '', breakTime: '' };
            console.log(`resetRow: Stav pre de≈à ${day} resetovan√Ω.`);
        } else {
            // Ak z√°znam neexistuje, nemus√≠me robi≈• niƒç, ale m√¥≈æeme logova≈•
            console.log(`resetRow: Z√°znam pre de≈à ${day} v stave neexistoval.`);
        }

        // Prepoƒç√≠tanie riadku (vynuluje ƒças a mzdu) a celkov√©ho s√∫ƒçtu
        calculateRow(day);
        calculateTotal();

        // Ulo≈æenie zmien
        debouncedSaveState();
        showSaveNotification(`Riadok pre de≈à ${day} bol vynulovan√Ω.`, "success", 1500);
    };

    /** Resetuje v≈°etky d√°ta pre aktu√°lny mesiac v UI a v stave. */
    const resetAll = () => {
        // Pou≈æijeme p√¥vodn√© confirm, k√Ωm nem√°me lep≈°√≠ modal
        if (confirm(`Naozaj chcete resetova≈• v≈°etky z√°znamy pre ${getMonthName(state.currentMonth)} ${state.currentYear}? T√°to akcia je nevratn√°!`)) {
            const year = state.currentYear;
            const month = state.currentMonth;

            // Reset v stave
            if (!state.monthData) state.monthData = {};
            if (!state.monthData[year]) state.monthData[year] = {};
            state.monthData[year][month] = []; // Vytvor√≠ pr√°zdne pole pre dan√Ω mesiac
            console.log(`resetAll: V≈°etky d√°ta pre ${year}-${month} resetovan√© v stave.`);

            // Reset v UI (prekreslen√≠m tabuƒæky a prepoƒç√≠tan√≠m)
            createTable(); // Vytvor√≠ pr√°zdnu tabuƒæku
            calculateTotal(); // Vynuluje s√∫ƒçty

            // Ulo≈æenie zmien
            debouncedSaveState();
            showSaveNotification(`D√°ta pre ${getMonthName(month)} ${year} boli resetovan√©.`, "success");
        } else {
            showSaveNotification("Resetovanie zru≈°en√©.", "warning", 1500);
        }
    };

    /** Vypoƒç√≠ta celkov√Ω s√∫hrn (odpracovan√Ω ƒças, mzdy, priemery) pre aktu√°lny mesiac. */
    const calculateTotal = () => {
        let grandTotalWorkedMinutes = 0;
        let totalGrossSalary = 0;
        let totalNetSalary = 0;
        let daysWithEntries = 0;

        const year = state.currentYear;
        const month = state.currentMonth;
        const daysInMonth = getDaysInMonth(month, year);

        // Iterujeme cez dni v mesiaci
        for (let day = 1; day <= daysInMonth; day++) {
            const startInput = document.getElementById(`start-${year}-${month}-${day}`);
            const endInput = document.getElementById(`end-${year}-${month}-${day}`);
            const breakInput = document.getElementById(`break-${year}-${month}-${day}`);
            const grossInput = document.getElementById(`gross-${year}-${month}-${day}`); // Naƒç√≠tame priamo vypoƒç√≠tan√∫ hrub√∫ mzdu
            const netInput = document.getElementById(`net-${year}-${month}-${day}`);   // Naƒç√≠tame priamo vypoƒç√≠tan√∫ ƒçist√∫ mzdu

            // Ak s√∫ ƒçasy platn√© (podƒæa `calculateRow`)
             if (startInput && endInput && breakInput && grossInput && netInput && isTimeValid(startInput.value) && isTimeValid(endInput.value)) {
                const startTimeStr = startInput.value;
                const endTimeStr = endInput.value;
                const breakTimeHours = parseFloat(breakInput.value) || 0;
                const breakMinutes = breakTimeHours * 60;

                const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
                const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
                const startTotalMinutes = startHours * 60 + startMinutes;
                let endTotalMinutes = endHours * 60 + endMinutes;
                if (endTotalMinutes < startTotalMinutes) {
                    endTotalMinutes += 24 * 60;
                }
                const diffMinutes = endTotalMinutes - startTotalMinutes;
                const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes);

                if (workedMinutesForRow > 0) {
                    grandTotalWorkedMinutes += workedMinutesForRow;
                    daysWithEntries++;
                     // Sƒç√≠tanie miezd priamo z inputov (ktor√© s√∫ u≈æ .toFixed(2))
                     totalGrossSalary += parseFloat(grossInput.value) || 0;
                     totalNetSalary += parseFloat(netInput.value) || 0;
                } else if (startTimeStr && endTimeStr) {
                     // Ak s√∫ ƒçasy zadan√©, ale v√Ωsledok je 0 alebo menej (napr. prest√°vka dlh≈°ia ako pr√°ca),
                     // st√°le poƒç√≠tame ako de≈à so z√°znamom pre priemer. Mzda bude 0.
                     daysWithEntries++;
                     totalGrossSalary += parseFloat(grossInput.value) || 0; // Mala by by≈• 0
                     totalNetSalary += parseFloat(netInput.value) || 0;   // Mala by by≈• 0
                }
             }
        }

        // Celkov√Ω ƒças
        const totalHours = Math.floor(grandTotalWorkedMinutes / 60);
        const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60);
        const grandTotalDecimalHours = grandTotalWorkedMinutes / 60;

        // Priemery
        const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
        const averageHours = Math.floor(averageWorkedMinutes / 60);
        const averageMinutes = Math.round(averageWorkedMinutes % 60);
        const averageDecimalHours = averageWorkedMinutes / 60;
        const averageNetSalary = daysWithEntries > 0 ? totalNetSalary / daysWithEntries : 0;

        // Aktualiz√°cia divu so s√∫hrnom
        if(uiElements.totalSalaryDiv) {
             uiElements.totalSalaryDiv.innerHTML = `
                Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntries}<br>
                Celkov√Ω odpracovan√Ω ƒças: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(state.decimalPlaces)} h)<br>
                Celkov√° hrub√° mzda: ${totalGrossSalary.toFixed(2)} ‚Ç¨<br>
                Celkov√° ƒçist√° mzda: ${totalNetSalary.toFixed(2)} ‚Ç¨<br>
                Priemern√° ƒçist√° mzda na de≈à: ${averageNetSalary.toFixed(2)} ‚Ç¨<br>
                <strong>Priemern√Ω odpracovan√Ω ƒças na de≈à: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(state.decimalPlaces)} h)</strong>
            `;
        }
    };


    /** Aktualizuje ukazovateƒæ vyu≈æitia localStorage. */
    const updateDataSize = () => {
        if (!uiElements.dataSizeText || !uiElements.dataSizeFill || !uiElements.dataSizeBar) return;
        try {
            const totalData = Object.values(localStorage).reduce((acc, value) => acc + (value ? new Blob([value]).size : 0), 0);
            const kilobytes = (totalData / 1024).toFixed(2);
            const percentageUsed = Math.min(((totalData / config.MAX_DATA_SIZE) * 100), 100);

            uiElements.dataSizeText.textContent = `Lok√°lne √∫lo≈æisko: ~${kilobytes} KB / ${config.MAX_DATA_SIZE_KB} KB`;
            uiElements.dataSizeFill.style.width = `${percentageUsed}%`;

            // Zmena farby podƒæa zaplnenia
            if (percentageUsed > 90) {
                uiElements.dataSizeFill.style.backgroundColor = '#f44336'; // ƒåerven√°
                 uiElements.dataSizeBar.style.borderColor = '#d32f2f';
            } else if (percentageUsed > 70) {
                uiElements.dataSizeFill.style.backgroundColor = '#ff9800'; // Oran≈æov√°
                 uiElements.dataSizeBar.style.borderColor = '#f57c00';
            } else {
                uiElements.dataSizeFill.style.backgroundColor = '#4CAF50'; // Zelen√°
                 uiElements.dataSizeBar.style.borderColor = '#ddd'; // ≈†ed√° pre norm√°lny stav
            }
        } catch (error) {
            console.error("Chyba pri v√Ωpoƒçte veƒækosti localStorage:", error);
            uiElements.dataSizeText.textContent = "Chyba pri v√Ωpoƒçte veƒækosti d√°t.";
            uiElements.dataSizeFill.style.width = '0%';
        }
    };

    /** Z√≠ska prv√© meno z cel√©ho mena. */
    const getFirstName = (fullName) => {
        if (!fullName || typeof fullName !== 'string') return '';
        const trimmedName = fullName.trim();
        if (!trimmedName) return '';
        return trimmedName.split(' ')[0];
    };

    /** Aktualizuje uv√≠taciu spr√°vu. */
    const updateWelcomeMessage = () => {
        if (!uiElements.welcomeMessage) return;
        const firstName = getFirstName(state.employeeName);
        if (firstName) {
            uiElements.welcomeMessage.textContent = `Vitaj sp√§≈•, ${firstName}! üëã`;
        } else {
            uiElements.welcomeMessage.textContent = 'Vitajte!'; // V≈°eobecn√Ω pozdrav, ak nie je meno
        }
    };


    // --- Funkcie pre Nastavenia ---

    /** Aktualizuje nastavenia hodinovej mzdy a dane na z√°klade inputov. */
    const updateSettings = () => {
        const newHourlyWageStr = uiElements.hourlyWageInput.value;
        const newTaxRateStr = uiElements.taxRateInput.value; // Percento
        const newHourlyWage = parseFloat(newHourlyWageStr);
        const newTaxRatePercent = parseFloat(newTaxRateStr);

        let changed = false;

        // Valid√°cia a aktualiz√°cia hodinovej mzdy
        if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
            if (state.hourlyWage !== newHourlyWage) {
                state.hourlyWage = newHourlyWage;
                changed = true;
            }
        } else if (newHourlyWageStr !== '') { // Ak je neplatn√©, ale nie pr√°zdne, oznaƒç chybu
             uiElements.hourlyWageInput.classList.add('error-border');
        } else {
             uiElements.hourlyWageInput.classList.remove('error-border');
        }

        // Valid√°cia a aktualiz√°cia da≈àovej sadzby
        if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) {
            const newTaxRateDecimal = newTaxRatePercent / 100;
            if (state.taxRate !== newTaxRateDecimal) {
                state.taxRate = newTaxRateDecimal;
                changed = true;
            }
             uiElements.taxRateInput.classList.remove('error-border');
        } else if (newTaxRateStr !== '') { // Ak je neplatn√©, ale nie pr√°zdne, oznaƒç chybu
            uiElements.taxRateInput.classList.add('error-border');
        } else {
            uiElements.taxRateInput.classList.remove('error-border');
        }

        // Ak do≈°lo k zmene, prepoƒç√≠taj v≈°etky riadky a celkov√Ω s√∫ƒçet a ulo≈æ stav
        if (changed) {
            console.log("updateSettings: Zmenen√° mzda alebo da≈à. Prepoƒç√≠tavam...");
             uiElements.taxRateInput.classList.remove('error-border'); // Odstr√°ni≈• chybu pri platnej zmene
             uiElements.hourlyWageInput.classList.remove('error-border');

            const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
            for (let i = 1; i <= daysInMonth; i++) {
                calculateRow(i);
            }
            calculateTotal();
            debouncedSaveState(); // Ulo≈æi≈• zmenen√© nastavenia
        }
    };

     /** Aktualizuje meno pracovn√≠ka a ulo≈æ√≠ stav. */
    const updateEmployeeName = () => {
        const newName = uiElements.employeeNameInput.value;
        if (state.employeeName !== newName) {
            state.employeeName = newName;
            updateWelcomeMessage(); // Aktualizuj pozdrav hneƒè
            debouncedSaveState(); // Ulo≈æi≈• zmenu mena
        }
    };

    /** Zmen√≠ poƒçet desatinn√Ωch miest pre zobrazenie ƒçasu a ulo≈æ√≠ stav. */
    const changeDecimalPlaces = () => {
        const newDecimalPlaces = parseInt(uiElements.decimalPlacesSelect.value);
        if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) {
             if (state.decimalPlaces !== newDecimalPlaces) {
                state.decimalPlaces = newDecimalPlaces;
                calculateTotal(); // Prepoƒç√≠ta≈• zobrazenie v s√∫ƒçte
                // Prepoƒç√≠tanie zobrazenia v riadkoch (ak treba)
                 const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
                 for (let i = 1; i <= daysInMonth; i++) {
                     calculateRow(i); // calculateRow u≈æ pou≈æ√≠va state.decimalPlaces
                 }
                debouncedSaveState(); // Ulo≈æi≈• zmenu
             }
        }
    };


    /** Zmen√≠ aktu√°lny mesiac a naƒç√≠ta/zobraz√≠ jeho d√°ta. */
    const changeMonth = () => {
        const selectedMonth = parseInt(uiElements.monthSelect.value);
        if (state.currentMonth !== selectedMonth) {
            state.currentMonth = selectedMonth;
            console.log(`Zmenen√Ω mesiac na: ${getMonthName(state.currentMonth)} (${state.currentMonth})`);
            handleMonthYearChange();
        }
    };

    /** Zmen√≠ aktu√°lny rok a naƒç√≠ta/zobraz√≠ jeho d√°ta. */
    const changeYear = () => {
        const selectedYear = parseInt(uiElements.yearSelect.value);
         if (state.currentYear !== selectedYear) {
            state.currentYear = selectedYear;
            console.log(`Zmenen√Ω rok na: ${state.currentYear}`);
            handleMonthYearChange();
        }
    };

    /** Spoloƒçn√° logika po zmene mesiaca alebo roka. */
    const handleMonthYearChange = () => {
        console.log(`handleMonthYearChange: Naƒç√≠tavam d√°ta pre ${getMonthName(state.currentMonth)} ${state.currentYear}`);
        // Ulo≈æ aktu√°lny v√Ωber do localStorage, aby sa zachoval po reloade
        localStorage.setItem('currentMonth', state.currentMonth.toString());
        localStorage.setItem('currentYear', state.currentYear.toString());

        // Naƒç√≠taj d√°ta pre nov√Ω mesiac/rok z localStorage (ak existuj√∫)
        loadFromLocalStorage().then(() => {
            // Aktualizuj UI s naƒç√≠tan√Ωmi d√°tami
            updateUIFromLoadedData();
            // Ak je pou≈æ√≠vateƒæ prihl√°sen√Ω, resetuj a nastav nov√Ω Firestore listener
            if (state.userId) {
                setupFirestoreListener();
            } else {
                console.log("handleMonthYearChange: Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω, listener sa nenastavuje.");
            }
        });
    };

    /** Napln√≠ select pre v√Ωber roka. */
    const populateYearSelect = () => {
        const startYear = 2020;
        const endYear = new Date().getFullYear() + 2; // P√°r rokov do bud√∫cnosti
        uiElements.yearSelect.innerHTML = ''; // Vyƒçisti≈• existuj√∫ce options
        for (let year = startYear; year <= endYear; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            uiElements.yearSelect.appendChild(option);
        }
        // Nastavi≈• aktu√°lny rok, ak u≈æ je v state
        if (state.currentYear) {
            uiElements.yearSelect.value = state.currentYear;
        }
    };

    // --- Funkcie pre Z√°lohovanie a Obnovu ---

    /** Vytvor√≠ a stiahne z√°lo≈æn√Ω JSON s√∫bor. */
    const createBackup = () => {
        try {
            // Zhroma≈ædenie v≈°etk√Ωch relevantn√Ωch d√°t z localStorage
            const backupData = {
                workDaysData: localStorage.getItem('workDaysData') || '{}', // V≈°etky mesiace
                hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(state.hourlyWage),
                taxRate: localStorage.getItem('taxRate') || JSON.stringify(state.taxRate * 100), // Ulo≈æi≈• %
                darkMode: localStorage.getItem('darkMode') || JSON.stringify(state.isDarkMode),
                decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(state.decimalPlaces),
                employeeName: localStorage.getItem('employeeName') || JSON.stringify(state.employeeName),
                // Prida≈• verziu a ƒçasov√∫ znaƒçku pre bud√∫ce pou≈æitie
                backupVersion: 3, // Zv√Ω≈°i≈• verziu pri zmene ≈°trukt√∫ry
                backupTimestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().slice(0, 10);
            const filename = `bruno-calculator-backup-${dateStr}.json`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSaveNotification("Z√°loha √∫spe≈°ne vytvoren√° a stiahnut√°.", "success");

        } catch (error) {
            console.error("Chyba pri vytv√°ran√≠ z√°lohy:", error);
            showSaveNotification("Nastala chyba pri vytv√°ran√≠ z√°lo≈æn√©ho s√∫boru.", "error");
        }
    };

    /** Naƒç√≠ta z√°lo≈æn√Ω s√∫bor a obnov√≠ d√°ta v localStorage a stave. */
    const restoreBackup = () => {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json,application/json';

        fileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const backup = JSON.parse(e.target.result);

                    // Z√°kladn√° valid√°cia ≈°trukt√∫ry z√°lohy
                    if (backup && typeof backup.workDaysData === 'string' &&
                        typeof backup.hourlyWage === 'string' && typeof backup.taxRate === 'string' &&
                        typeof backup.darkMode === 'string' && typeof backup.decimalPlaces === 'string' &&
                        typeof backup.employeeName === 'string')
                    {
                        // Prep√≠sanie localStorage d√°tami zo z√°lohy
                        localStorage.setItem('workDaysData', backup.workDaysData);
                        localStorage.setItem('hourlyWage', backup.hourlyWage);
                        localStorage.setItem('taxRate', backup.taxRate); // Ulo≈æen√© ako %
                        localStorage.setItem('darkMode', backup.darkMode);
                        localStorage.setItem('decimalPlaces', backup.decimalPlaces);
                        localStorage.setItem('employeeName', backup.employeeName);
                        // Neprepisujeme currentMonth/Year, tie si riadi pou≈æ√≠vateƒæ v√Ωberom

                        // Naƒç√≠ta≈• obnoven√© nastavenia a d√°ta do stavu a UI
                        loadInitialSettings(); // Znovu naƒç√≠ta nastavenia z LS
                        await loadFromLocalStorage(); // Znovu naƒç√≠ta d√°ta dn√≠ z LS pre aktu√°lny mesiac/rok
                        updateUIFromLoadedData(); // Aktualizuje cel√© UI

                        showSaveNotification("Z√°loha √∫spe≈°ne obnoven√°. D√°ta boli naƒç√≠tan√©.", "success", 4000);

                        // Ak je pou≈æ√≠vateƒæ prihl√°sen√Ω, spust√≠me ulo≈æenie obnoven√Ωch d√°t
                        // pre AKTU√ÅLNE ZOBRAZEN√ù mesiac do Firebase
                        if (state.userId) {
                            console.log("Obnova z√°lohy: Uklad√°m obnoven√© d√°ta pre aktu√°lny mesiac do Firebase...");
                            // Pou≈æijeme priame volanie saveState, nie debounced, aby sa vykonalo hneƒè
                            await saveState();
                        }
                    } else {
                         console.error("Chyba obnovy: S√∫bor z√°lohy m√° nespr√°vny form√°t alebo ch√Ωbaj√∫ kƒæ√∫ƒçov√© d√°ta.", backup);
                         showSaveNotification("Chyba: S√∫bor z√°lohy m√° nespr√°vny form√°t.", "error", 5000);
                    }
                } catch (error) {
                    console.error("Chyba pri spracovan√≠ alebo obnove z√°lohy:", error);
                    showSaveNotification("Chyba pri ƒç√≠tan√≠/obnove z√°lohy. S√∫bor m√¥≈æe by≈• po≈°koden√Ω.", "error", 5000);
                }
            };

            reader.onerror = (e) => {
                console.error("Chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy:", e);
                showSaveNotification("Nastala chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy.", "error");
            };

            reader.readAsText(file);
        };
        fileInput.click(); // Otvor√≠ dial√≥g na v√Ωber s√∫boru
    };


    // --- Export do PDF (NEDOTKNUT√â podƒæa po≈æiadavky) ---
    /** Exportuje detailn√Ω v√Ωkaz do PDF. */
    const exportToPDF = () => { /* K√ìD ZOST√ÅVA NEZMENEN√ù */ console.log("exportToPDF: Spusten√©..."); if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { showSaveNotification("Chyba: Kni≈ænica jsPDF alebo autoTable nie je spr√°vne naƒç√≠tan√°.", "error"); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; } const { jsPDF } = window.jspdf; try { const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("Could not load Roboto font for PDF, using default.", e); } doc.setFontSize(18); doc.text(`Bruno's Calculator - V√Ωkaz (${getMonthName(state.currentMonth)} ${state.currentYear})`, 14, 20); doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${state.employeeName || 'Nezadan√©'}`, 14, 28); doc.text(`Hodinov√° mzda: ${state.hourlyWage || 'N/A'} ‚Ç¨`, 14, 34); doc.text(`Da≈à (%): ${state.taxRate*100 || 'N/A'}`, 100, 34); const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Odpracovan√©", "Hrub√° Mzda (‚Ç¨)", "ƒåist√° Mzda (‚Ç¨)"]; const tableRows = []; const dataForCurrentMonth = (state.monthData && state.monthData[state.currentYear] && state.monthData[state.currentYear][state.currentMonth]) || []; dataForCurrentMonth.forEach((day, index) => { if (day.start || day.end) { const dayNum = index + 1; const dayName = getDayName(state.currentYear, state.currentMonth, dayNum); const totalCell = document.getElementById(`total-${state.currentYear}-${state.currentMonth}-${dayNum}`); const grossInput = document.getElementById(`gross-${state.currentYear}-${state.currentMonth}-${dayNum}`); const netInput = document.getElementById(`net-${state.currentYear}-${state.currentMonth}-${dayNum}`); const workedTimeText = totalCell ? totalCell.textContent : 'N/A'; const grossValue = grossInput ? parseFloat(grossInput.value).toFixed(2) : '0.00'; const netValue = netInput ? parseFloat(netInput.value).toFixed(2) : '0.00'; const rowData = [ `De≈à ${dayNum} (${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0', workedTimeText, grossValue, netValue ]; tableRows.push(rowData); } }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName }, styles: { font: doc.getFont().fontName, fontSize: 9 }, alternateRowStyles: { fillColor: [240, 240, 240] } }); const finalY = doc.lastAutoTable.finalY || 40; doc.setFontSize(10); const totalTextContent = uiElements.totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, ''); doc.text(totalTextContent, 14, finalY + 10); const pdfFileName = `Vykaz-${state.employeeName || 'pracovnik'}-${getMonthName(state.currentMonth)}-${state.currentYear}.pdf`; doc.save(pdfFileName); showSaveNotification("PDF exportovan√©.", "success"); } catch (error) { console.error("Chyba pri generovan√≠ PDF v exportToPDF:", error); showSaveNotification("Nastala chyba pri vytv√°ran√≠ PDF s√∫boru.", "error"); } };
    /** Vygeneruje z√°kladn√© PDF a pok√∫si sa ho zdieƒæa≈•/stiahnu≈•. */
    const sendPDF = () => { /* K√ìD ZOST√ÅVA NEZMENEN√ù */ console.log("sendPDF: Spusten√©..."); if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { showSaveNotification("Chyba: Kni≈ænica jsPDF alebo autoTable nie je spr√°vne naƒç√≠tan√°.", "error"); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; } const { jsPDF } = window.jspdf; try { const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("sendPDF: Could not load Roboto font, using default.", e); } doc.setFontSize(16); doc.text(`Pracovn√Ω v√Ωkaz - ${getMonthName(state.currentMonth)} ${state.currentYear}`, 14, 20); doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${state.employeeName || 'Nezadan√©'}`, 14, 28); const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)"]; const tableRows = []; const dataForCurrentMonth = (state.monthData && state.monthData[state.currentYear] && state.monthData[state.currentYear][state.currentMonth]) || []; dataForCurrentMonth.forEach((day, index) => { if (day.start || day.end) { const dayNum = index + 1; const dayName = getDayName(state.currentYear, state.currentMonth, dayNum); const rowData = [ `De≈à ${dayNum} (${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0' ]; tableRows.push(rowData); } }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 35, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName }, styles: { font: doc.getFont().fontName, fontSize: 9 }, alternateRowStyles: { fillColor: [240, 240, 240] } }); const finalY = doc.lastAutoTable.finalY || 35; doc.setFontSize(10); const totalSalaryHTML = uiElements.totalSalaryDiv.innerHTML; let daysWithEntriesText = 'N/A'; const match = totalSalaryHTML.match(/Poƒçet odpracovan√Ωch dn√≠: (\d+)/); if (match && match[1]) { daysWithEntriesText = match[1]; } const summaryText = `Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntriesText}`; doc.text(summaryText, 14, finalY + 10); const pdfBlob = doc.output('blob'); const pdfFileName = `Vykaz_odoslanie-${state.employeeName || 'pracovnik'}-${getMonthName(state.currentMonth)}-${state.currentYear}.pdf`; const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' }); if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) { navigator.share({ files: [pdfFile], title: `Pracovn√Ω v√Ωkaz ${getMonthName(state.currentMonth)} ${state.currentYear}`, text: `V√Ωkaz pre ${state.employeeName || 'pracovn√≠ka'} za ${getMonthName(state.currentMonth)} ${state.currentYear}.` }).then(() => { showSaveNotification("PDF pripraven√© na zdieƒæanie.", "success"); }).catch((error) => { if (error.name !== 'AbortError') { console.error('sendPDF: Chyba pri zdieƒæan√≠ cez Web Share API:', error); showSaveNotification('Chyba pri zdieƒæan√≠ s√∫boru.', "error"); } else { console.log('sendPDF: Zdieƒæanie PDF zru≈°en√© pou≈æ√≠vateƒæom.'); showSaveNotification('Zdieƒæanie zru≈°en√©.', 'warning'); } }); } else { showSaveNotification("Zdieƒæanie s√∫borov nie je podporovan√©. S√∫bor bude stiahnut√Ω.", "warning"); const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = pdfFileName; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); } } catch (error) { console.error("Chyba pri generovan√≠ alebo zdieƒæan√≠ PDF v sendPDF:", error); showSaveNotification("Nastala chyba pri vytv√°ran√≠ alebo zdieƒæan√≠ PDF s√∫boru.", "error"); } };


    // --- Inicializ√°cia Aplik√°cie ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM naƒç√≠tan√Ω, inicializujem...");

        // Zobrazi≈• loading overlay hneƒè
        if (uiElements.loadingContainer) {
             uiElements.loadingContainer.classList.remove('hidden');
        } else {
            console.error("Loading container element not found!");
        }

        // Poƒçk√°me na Firebase Auth stav, ktor√Ω spust√≠ zvy≈°ok inicializ√°cie (v onAuthStateChanged)
        // Ale m√¥≈æeme naƒç√≠ta≈• z√°kladn√© veci ako tmav√Ω re≈æim a roky hneƒè
        const initialDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        applyDarkMode(initialDarkMode);
        populateYearSelect();

        // Registr√°cia Service Workera pre PWA funkcie
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js') // Uistite sa, ≈æe cesta je spr√°vna
                    .then(registration => {
                        console.log('ServiceWorker zaregistrovan√Ω s rozsahom: ', registration.scope);
                    })
                    .catch(error => {
                        console.error('Registr√°cia ServiceWorker zlyhala: ', error);
                    });
            });
        } else {
            console.warn("Service Worker nie je podporovan√Ω v tomto prehliadaƒçi.");
        }

        console.log("Z√°kladn√° DOM inicializ√°cia dokonƒçen√°, ƒçak√°m na stav prihl√°senia...");
        // Hlavn√° logika naƒç√≠tania d√°t a UI sa deje v `onAuthStateChanged`
    });

  </script>
</body>
</html>
