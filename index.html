<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <!-- Google Fonts Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase knižnice -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF a autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- všetky tvoje štýly presne tak, ako boli --- */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; }
    .settings > div { flex: 1 1 200px; margin: 5px; }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 800px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode { background-color: #666; color: white; }
    .btn.dark-mode { color: #333; }
    .reset-btn.dark-mode { background-color: #d32f2f; }
    .export-btn.dark-mode { background-color: #388e3c; }
    .restore-btn.dark-mode { background-color: #7B1FA2; }
    .backup-btn.dark-mode { background-color: #E68900; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
    #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
    #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }

    #forgot-password-link {
        display: block;
        margin-top: 15px;
        font-size: 14px;
        color: #007bff;
        text-decoration: none;
        cursor: pointer;
    }
    #forgot-password-link:hover {
        text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- Loading obrazovka -->
  <div id="loading-container"><h1>Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte, dosiahnete všetko.</h1></div>

  <!-- Auth formulár -->
  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>

  <!-- Kalkulačka -->
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>
    <div class="settings">
      <div><label for="employeeNameInput">Meno pracovníka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()"></div>
      <div><label for="hourlyWageInput">Hodinová mzda (€): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div>
      <div><label for="taxRateInput">Daňové percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"></div>
      <div><label for="monthSelect">Mesiac: </label><select id="monthSelect" onchange="changeMonth()"><option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option><option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option><option value="6">Júl</option><option value="7">August</option><option value="8">September</option><option value="9">Október</option><option value="10">November</option><option value="11">December</option></select></div>
      <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div>
      <div><label for="decimalPlacesSelect">Počet desatinných miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2">2</option></select></div>
      <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>
    <div class="table-container">
      <table>
        <thead><tr><th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka</th><th>Odpracované</th><th>Hrubá Mzda (€)</th><th>Čistá Mzda (€)</th><th>Akcia</th></tr></thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
    </div>
  </div>

  <div id="saveNotification"></div>

  <script>
    // 1. Firebase Config & Init
    const firebaseConfig = {
      apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo",
      authDomain: "bruno-3cee2.firebaseapp.com",
      projectId: "bruno-3cee2",
      storageBucket: "bruno-3cee2.appspot.com",
      messagingSenderId: "155545319308",
      appId: "1:155545319308:web:5da498ff1cd3e1833888a9"
    };
    try {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase inicializovaný úspešne.");
    } catch(error) {
      console.error("Chyba inicializácie Firebase:", error);
      alert("Chyba konfigurácie Firebase. Skontroluj konzolu pre detaily.");
    }
    try {
      firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true);
    } catch (error) {
      console.warn("Chyba pri aktivácii Firebase App Check:", error);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // 2. Povolenie Firestore Offline Persistence
    db.enablePersistence().then(() => {
      console.log("Firestore offline persistence povolená.");
    }).catch((err) => {
      console.error("Firestore offline persistence chyba:", err.code, err.message, err);
      if (err.code == 'failed-precondition') {
        console.warn("Firestore offline persistence: Viacnásobné otvorené taby, povolené len v jednom.");
      } else if (err.code == 'unimplemented') {
        console.error("Firestore offline persistence: Prehliadač nie je podporovaný.");
      }
    });

    // 3. Globálne premenné
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
    let monthData = {};
    let firestoreListenerUnsubscribe = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const MAX_DATA_SIZE = 4 * 1024 * 1024;
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // 4. Auth funkcie
    function register() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          console.log("Registrovaný:", userCredential.user);
          alert("Registrácia úspešná!");
        })
        .catch(error => {
          console.error("Chyba pri registrácii:", error.message);
          alert("Chyba pri registrácii: " + error.message);
        });
    }
    function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          console.log("Prihlásený:", userCredential.user);
          alert("Prihlásenie úspešné!");
        })
        .catch(error => {
          console.error("Chyba pri prihlásení:", error.message);
          alert("Chyba pri prihlásení: " + error.message);
        });
    }
    function logout() {
      auth.signOut()
        .then(() => {
          console.log("Odhlásený.");
          alert("Odhlásenie úspešné!");
        })
        .catch(error => {
          console.error("Chyba pri odhlásení:", error.message);
          alert("Chyba pri odhlásení: " + error.message);
        });
    }

    // Funkcia Zabudli ste heslo
    function forgotPassword() {
      const emailInput = document.getElementById('loginEmail');
      const email = emailInput.value;
      if (!email) {
        alert("Prosím, zadajte svoju e-mailovú adresu do poľa pre prihlásenie.");
        emailInput.focus();
        return;
      }
      auth.sendPasswordResetEmail(email)
        .then(() => {
          console.log("E-mail na obnovenie hesla odoslaný na:", email);
          alert("Odkaz na obnovenie hesla bol odoslaný na vašu e-mailovú adresu. Skontrolujte si prosím poštu (aj priečinok Spam).");
        })
        .catch(error => {
          console.error("Chyba pri odosielaní e-mailu na obnovenie hesla:", error);
          alert("Chyba pri odosielaní e-mailu na obnovenie hesla: " + error.message);
        });
    }

    // 5. Auth State Change Listener
    auth.onAuthStateChanged(user => {
        console.log("onAuthStateChanged: Stav zistený.", user ? `Používateľ: ${user.email}` : "Žiadny používateľ.");
        const authContainer = document.getElementById('auth-container');
        const calculatorContainer = document.getElementById('calculator-container');
        const loadingContainer = document.getElementById('loading-container');
        if (loadingContainer) loadingContainer.classList.add('hidden');

        if (firestoreListenerUnsubscribe) {
            console.log("Odhlasujem predchádzajúci Firestore listener pri zmene Auth stavu.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        if (user) {
            document.getElementById('auth-message').textContent = "Prihlásený: " + user.email;
            authContainer.style.display = "none";
            calculatorContainer.style.display = "block";
            console.log("Používateľ prihlásený, nastavujem UI a listener...");

            const storedMonth = localStorage.getItem('currentMonth');
            const storedYear = localStorage.getItem('currentYear');
            const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
            const currentDate = new Date();
            currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
            currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
            monthSelect.value = currentMonth;
            if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
              yearSelect.value = currentYear;
            } else {
              console.warn(`Rok ${currentYear} z localStorage nenájdený v selecte, používam aktuálny rok.`);
              currentYear = currentDate.getFullYear();
              populateYearSelect();
              yearSelect.value = currentYear;
            }
            applyDarkMode(darkMode);
            hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
            taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
            decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
            employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = taxRate * 100;
            decimalPlacesSelect.value = decimalPlaces;
            employeeNameInput.value = employeeName;

            console.log("onAuthStateChanged: Prvé volanie loadFromLocalStorage...");
            loadFromLocalStorage(); // Prvé načítanie a vykreslenie

            setupFirestoreListener(); // Nastavenie listenera

            const uid = user.uid;
            const userDocRef = db.collection("users").doc(uid);
            userDocRef.get()
              .then(userDocSnap => {
                if (!userDocSnap.exists) {
                  userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true })
                    .then(() => console.log("Vytvorený/aktualizovaný dokument pre:", uid))
                    .catch(err => console.error("Chyba pri vytváraní/aktualizácii dokumentu používateľa:", err));
                } else {
                  console.log("Dokument používateľa existuje:", uid);
                }
              })
              .catch(err => {
                console.error("Chyba pri kontrole dokumentu používateľa (userDocRef.get):", err);
                showSaveNotification("Chyba pri overovaní používateľských dát", "error");
              });

            setTimeout(() => {
                 if (auth.currentUser && !navigator.onLine) {
                     console.log("onAuthStateChanged (setTimeout): Vynútené druhé volanie loadFromLocalStorage (offline)...");
                     loadFromLocalStorage();
                 } else if (auth.currentUser && navigator.onLine) {
                     console.log("onAuthStateChanged (setTimeout): Online, druhé volanie loadFromLocalStorage preskočené.");
                 }
            }, 150);

        } else {
            document.getElementById('auth-message').textContent = "Žiadny používateľ nie je prihlásený.";
            authContainer.style.display = "block";
            calculatorContainer.style.display = "none";
            console.log("Používateľ odhlásený/neprihlásený.");
            monthData = {};
            workDays.innerHTML = '';
            totalSalaryDiv.innerHTML = '';
            updateWelcomeMessage(); // Zabezpečí skrytie pozdravu pri odhlásení
        }
    });

    // 6. Utility funkcie (debounce, showSaveNotification)
    function debounce(func, wait) { let timeout; return function (...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), wait); }; }
    function showSaveNotification(message, type = 'success') { const notification = document.getElementById('saveNotification'); notification.textContent = message; notification.className = 'show'; if (type === 'error') { notification.classList.add('error'); } else if (type === 'warning') { notification.classList.add('warning'); } notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 3000); }

    // --- Funkcie pre pozdrav ---
    function getFirstName(fullName) {
      if (!fullName || typeof fullName !== 'string') return '';
      const parts = fullName.trim().split(' ');
      return parts[0] || '';
    }
    function updateWelcomeMessage() {
      const welcomeElement = document.getElementById('welcomeMessage');
      if (!welcomeElement) return;
      const firstName = getFirstName(employeeName);
      welcomeElement.textContent = firstName ? `Vitaj, ${firstName}!` : '';
    }
    // --- Koniec pozdravu ---

    // 7. Funkcia na nastavenie Firestore Listenera
    function setupFirestoreListener() {
        if (firestoreListenerUnsubscribe) {
            console.log("Odhlasujem predchádzajúci Firestore listener.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }
        const uid = auth.currentUser?.uid;
        if (!uid) { console.log("setupFirestoreListener: Nikto nie je prihlásený."); return; }
        if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
            const now = new Date();
            currentMonth = currentMonth ?? now.getMonth();
            currentYear = currentYear ?? now.getFullYear();
            console.warn("setupFirestoreListener: Chýba mesiac/rok.");
        }
        const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
        const docRef = db.doc(docPath);
        console.log(`setupFirestoreListener: Nastavujem listener pre ${docPath}`);

        firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
            console.log(`Firestore listener: Prijatý snapshot pre ${docPath}. Metadata:`, docSnap.metadata);
            const isLocalWrite = docSnap.metadata.hasPendingWrites;

            if (isLocalWrite) {
                console.log("Listener: Detekovaná lokálna zmena. Preskakujem aktualizáciu UI.");
                showSaveNotification("Synchronizujem lokálne zmeny...", "warning");
                if (docSnap.exists) {
                    const data = docSnap.data();
                    const firebaseDaysData = data.days || [];
                    if (!monthData) monthData = {};
                    if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '' }));
                    localStorage.setItem('workDaysData', JSON.stringify(monthData));
                }
                return;
            }

            if (docSnap.exists) {
                const data = docSnap.data();
                console.log("Listener: Dokument existuje (potvrdené dáta/cache), načítané dáta:", data);
                try {
                    const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
                    const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
                    const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
                    const firebaseEmployeeName = data.employeeName ?? employeeName;
                    const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');
                    const firebaseDaysData = data.days || [];

                    hourlyWage = firebaseHourlyWage;
                    taxRate = firebaseTaxRatePercent / 100;
                    decimalPlaces = firebaseDecimalPlaces;
                    employeeName = firebaseEmployeeName;

                    if (document.activeElement !== hourlyWageInput) {
                        hourlyWageInput.value = hourlyWage;
                    }
                    if (document.activeElement !== taxRateInput) {
                        taxRateInput.value = taxRate * 100;
                    }
                    decimalPlacesSelect.value = decimalPlaces;
                    if (document.activeElement !== employeeNameInput) {
                        employeeNameInput.value = employeeName;
                    }

                    if (!monthData) monthData = {};
                    if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '' }));
                    console.log(`Listener: monthData pre ${currentYear}-${currentMonth} aktualizované (potvrdené/cache). Počet dní: ${monthData[currentYear][currentMonth].length}`);
                    localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                    localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                    localStorage.setItem('darkMode', JSON.stringify(firebaseDarkMode));
                    localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                    localStorage.setItem('employeeName', JSON.stringify(employeeName));
                    localStorage.setItem('workDaysData', JSON.stringify(monthData));
                    console.log("Listener: Dáta uložené do localStorage (potvrdené/cache).");

                    console.log("Listener: Vykonávam cielenú aktualizáciu UI s kontrolou fokusu...");
                    const daysInMonth = getDaysInMonth(currentMonth);
                    const activeElementId = document.activeElement?.id;

                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayData = monthData[currentYear]?.[currentMonth]?.[i - 1] || {};
                        const startId = `start-${currentYear}-${currentMonth}-${i}`;
                        const endId   = `end-${currentYear}-${currentMonth}-${i}`;
                        const breakId = `break-${currentYear}-${currentMonth}-${i}`;

                        const startEl = document.getElementById(startId);
                        const endEl   = document.getElementById(endId);
                        const brEl    = document.getElementById(breakId);

                        if (startEl && endEl && brEl) {
                            const newStart = dayData.start || '';
                            const newEnd   = dayData.end   || '';
                            const newBreak = dayData.breakTime || '';

                            if (startEl.value !== newStart && activeElementId !== startId) startEl.value = newStart;
                            if (endEl.value   !== newEnd   && activeElementId !== endId)   endEl.value   = newEnd;
                            if (brEl.value    !== newBreak && activeElementId !== breakId) brEl.value    = newBreak;

                            calculateRow(i);
                        } else if (document.getElementById(`total-${currentYear}-${currentMonth}-${i}`)) {
                            console.warn(`Listener: Chýbajú input elementy pre deň ${i} pri cielenej aktualizácii.`);
                        }
                    }

                    calculateTotal();
                    applyDarkMode(firebaseDarkMode);
                    updateWelcomeMessage();
                    console.log("Listener: Cielená aktualizácia UI dokončená.");
                    if (!docSnap.metadata.fromCache) {
                        console.log("Listener: Dáta prijaté priamo zo SERVERA.");
                        showSaveNotification("Dáta synchronizované");
                    }
                } catch (processError) {
                    console.error(`Listener: Chyba pri spracovaní dát z Firestore pre ${currentYear}-${currentMonth}:`, processError);
                    showSaveNotification("Chyba: Nesprávny formát dát z Firebase", "error");
                }
            } else {
                console.log("Listener: Dokument neexistuje (potvrdené/cache) na Firebase pre ${currentYear}-${currentMonth}.");
                if (!monthData) monthData = {};
                if (!monthData[currentYear]) monthData[currentYear] = {};
                monthData[currentYear][currentMonth] = [];
                localStorage.setItem('workDaysData', JSON.stringify(monthData));

                // ak dokument neexistuje, načítame localStorage a zobrazíme UI
                hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                taxRate    = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
                const darkModeVal = JSON.parse(localStorage.getItem('darkMode')) || false;
                decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
                employeeName  = JSON.parse(localStorage.getItem('employeeName')) || '';
                hourlyWageInput.value = hourlyWage;
                taxRateInput.value    = taxRate * 100;
                decimalPlacesSelect.value = decimalPlaces;
                employeeNameInput.value   = employeeName;
                createTable();
                calculateTotal();
                applyDarkMode(darkModeVal);
                updateWelcomeMessage();
            }
        }, error => {
            console.error(`Firestore listener chyba pre ${docPath}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa pripojiť k Firebase", "error");
            console.log("Listener chyba, načítavam z localStorage ako fallback...");
            loadFromLocalStorage();
        });
    }

    // 8. saveToFirebase
    async function saveToFirebase() {
      const currentUser = auth.currentUser;
      if (!currentUser) { console.log("saveToFirebase: Nikto nie je prihlásený."); return; }
      try {
        const currentMonthWorkData = monthData[currentYear]?.[currentMonth] || [];
        console.log(`saveToFirebase: Ukladám ${currentMonthWorkData.length} záznamov pre ${currentYear}-${currentMonth}.`);
        const dataToSave = {
          days: currentMonthWorkData,
          hourlyWage: hourlyWage || 10,
          taxRate: (taxRate * 100) || 2,
          decimalPlaces: decimalPlaces || 1,
          employeeName: employeeName || '',
          darkMode: document.body.classList.contains('dark-mode'),
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        const yearMonthDoc = `${currentYear}-${currentMonth}`;
        const uid = currentUser.uid;
        const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);
        await docRef.set(dataToSave);
        console.log(`saveToFirebase: Požiadavka na uloženie dát pre ${yearMonthDoc} odoslaná/zaradená.`);
      } catch (error) {
        console.error(`Chyba pri požiadavke na ukladanie do Firebase pre ${currentYear}-${currentMonth}:`, error);
        showSaveNotification("Chyba: Nepodarilo sa odoslať dáta do Firebase", "error");
      }
    }

    // 9. saveToLocalStorage
    function saveToLocalStorage() {
      try {
        if (!monthData) monthData = {};
        if (!monthData[currentYear]) monthData[currentYear] = {};
        if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
        localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
        localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
        localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
        localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
        localStorage.setItem('employeeName', JSON.stringify(employeeName));
        localStorage.setItem('currentMonth', currentMonth.toString());
        localStorage.setItem('currentYear', currentYear.toString());
        const serializedMonthData = JSON.stringify(monthData);
        const bytes = new Blob([serializedMonthData]).size;
        if (bytes > MAX_DATA_SIZE * 0.9) {
          console.warn(`Veľkosť dát v localStorage sa blíži k limitu: ${bytes} bajtov`);
        }
        if (bytes > MAX_DATA_SIZE) {
          alert(`Prekročili ste maximálnu veľkosť dát (~${MAX_DATA_SIZE_KB} KB) pre dáta mesiacov v localStorage. Ukladanie zlyhalo.`);
          showSaveNotification("Chyba: Lokálne dáta sú príliš veľké!", "error");
          return;
        }
        localStorage.setItem('workDaysData', serializedMonthData);
        updateDataSize();
        saveToFirebase();
        if (!navigator.onLine) {
          showSaveNotification("Offline: Zmeny uložené lokálne", "warning");
        }
      } catch (error) {
        console.error('Chyba pri ukladaní (lokálne/spustení Firebase save):', error);
        showSaveNotification("Kritická chyba pri ukladaní!", "error");
      }
    }

    // 10. loadFromLocalStorage
    function loadFromLocalStorage() {
      try {
        if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
          const storedMonth = localStorage.getItem('currentMonth');
          const storedYear  = localStorage.getItem('currentYear');
          const now = new Date();
          currentMonth = storedMonth !== null ? parseInt(storedMonth) : now.getMonth();
          currentYear  = storedYear !== null ? parseInt(storedYear)  : now.getFullYear();
          console.log(`loadFromLocalStorage: Inicializujem mesiac=${currentMonth}, rok=${currentYear}`);
        }
        console.log(`loadFromLocalStorage: Načítavam pre ${getMonthName(currentMonth)} ${currentYear}`);
        const stored = localStorage.getItem('workDaysData');
        monthData = stored ? JSON.parse(stored) : {};
        if (monthData[currentYear] && monthData[currentYear][currentMonth]) {
          console.log(`loadFromLocalStorage: Načítaných ${monthData[currentYear][currentMonth].length} záznamov pre ${currentYear}-${currentMonth}.`);
        } else {
          console.log(`loadFromLocalStorage: Pre ${currentYear}-${currentMonth} neboli v localStorage nájdené žiadne záznamy.`);
        }
        hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
        taxRate    = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
        const darkModeVal = JSON.parse(localStorage.getItem('darkMode')) || false;
        decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
        employeeName  = JSON.parse(localStorage.getItem('employeeName')) || '';
        updateUIFromLoadedData(darkModeVal);
      } catch (error) {
        console.error(`Kritická chyba pri načítavaní/spracovaní dát z localStorage pre ${getMonthName(currentMonth)} ${currentYear}:`, error);
        showSaveNotification("Chyba pri načítaní lokálnych dát!", "error");
        monthData = {};
        createTable();
        calculateTotal();
      }
    }

    // 11. updateUIFromLoadedData
    function updateUIFromLoadedData(darkModeValue) {
      console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(currentMonth)} ${currentYear}`);
      try {
        hourlyWageInput.value = hourlyWage;
        taxRateInput.value    = taxRate * 100;
        decimalPlacesSelect.value = decimalPlaces;
        employeeNameInput.value   = employeeName;
        if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
          monthSelect.value = currentMonth;
        } else {
          console.warn(`Mesiac ${currentMonth} nenájdený v selecte.`);
          monthSelect.value = new Date().getMonth();
          currentMonth = parseInt(monthSelect.value);
        }
        if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
          yearSelect.value = currentYear;
        } else {
          console.warn(`Rok ${currentYear} nenájdený v selecte.`);
          yearSelect.value = new Date().getFullYear();
          currentYear = parseInt(yearSelect.value);
          populateYearSelect();
          yearSelect.value = currentYear;
        }
        createTable();
        const dataArr = monthData[currentYear]?.[currentMonth] || [];
        console.log(`updateUIFromLoadedData: Počet záznamov v monthData pre ${currentYear}-${currentMonth}: ${dataArr.length}`);
        dataArr.forEach((day, index) => {
          const i = index + 1;
          const startEl = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
          const endEl   = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
          const brEl    = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
          if (startEl && endEl && brEl) {
            startEl.value = day.start || '';
            endEl.value   = day.end   || '';
            brEl.value    = day.breakTime || '';
            calculateRow(i);
          } else {
            console.error(`Kritická chyba: Elementy pre deň ${i} v updateUIFromLoadedData neboli nájdené po createTable!`);
          }
        });
        calculateTotal();
        updateDataSize();
        applyDarkMode(darkModeValue);
        updateWelcomeMessage();
        console.log("UI aktualizované.");
      } catch (error) {
        console.error("Chyba počas aktualizácie UI:", error);
        showSaveNotification("Chyba pri prekresľovaní UI!", "error");
      }
    }

    // 12. applyDarkMode
    function applyDarkMode(isDark) {
      const elems = [
        document.body,
        document.querySelector('.container'),
        totalSalaryDiv,
        ...document.querySelectorAll('table, th, td, input'),
        ...document.querySelectorAll('.btn')
      ];
      const currentDayRow = document.querySelector('.current-day');
      if (currentDayRow) elems.push(currentDayRow);

      elems.forEach(el => el?.classList[isDark ? 'add' : 'remove']('dark-mode'));
    }

    // 13. createTable & súvisiace
    function getDayName(year, month, day) {
      const days = ["Nedeľa","Pondelok","Utorok","Streda","Štvrtok","Piatok","Sobota"];
      return days[new Date(year, month, day).getDay()];
    }
    function createTable() {
      workDays.innerHTML = '';
      const daysInMonth = getDaysInMonth(currentMonth);
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIdx = today.getMonth();
      const currentYearVal   = today.getFullYear();

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        if (i === currentDayOfMonth && currentMonth === currentMonthIdx && currentYear === currentYearVal) {
          row.classList.add('current-day');
        }
        const dayName = getDayName(currentYear, currentMonth, i);
        row.innerHTML = `
          <td>Deň ${i} (${dayName})</td>
          <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this,'end-${currentYear}-${currentMonth}-${i}', ${i})"></td>
          <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this,'break-${currentYear}-${currentMonth}-${i}', ${i})"></td>
          <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="prestávka" oninput="handleBreakInput(${i})"></td>
          <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
          <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Hrubá Mzda" readonly></td>
          <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Čistá Mzda" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>
        `;
        workDays.appendChild(row);
      }
      applyDarkMode(document.body.classList.contains('dark-mode'));
    }

    // 14. Input handling & calculateRow
    function processInputCompletion(inputId, nextId) {
      const inputEl = document.getElementById(inputId);
      calculateTotal();
      saveToLocalStorage();
      if (inputEl && inputEl.type === 'tel') {
        if (inputEl.value.length === 5 && isTimeValid(inputEl.value)) {
          moveNext(inputEl, nextId);
        }
      } else if (inputEl && inputEl.type === 'number' && inputId.startsWith('break-')) {
        moveNext(inputEl, nextId);
      }
    }
    const debouncedProcessInputCompletion = debounce(processInputCompletion, 500);
    function isTimeValid(timeStr) {
      return /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeStr);
    }
    function handleInput(input, nextId, day) {
      formatInput(input);
      updateMonthDataFromInput(input, day);
      calculateRow(day);
      debouncedProcessInputCompletion(input.id, nextId);
    }
    function handleBreakInput(day) {
      const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      updateMonthDataFromInput(input, day);
      calculateRow(day);
      const nextDay = day + 1;
      const nextInputId = nextDay <= getDaysInMonth(currentMonth)
        ? `start-${currentYear}-${currentMonth}-${nextDay}`
        : null;
      debouncedProcessInputCompletion(input.id, nextInputId);
    }
    function updateMonthDataFromInput(input, day) {
      if (!input) return;
      const idx = day - 1;
      const id = input.id;
      let field = 'unknown';
      if (id.startsWith('start-')) field = 'start';
      else if (id.startsWith('end-')) field = 'end';
      else if (id.startsWith('break-')) field = 'breakTime';
      const value = input.value;
      if (field !== 'unknown') {
        if (!monthData[currentYear]) monthData[currentYear] = {};
        if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
        while (monthData[currentYear][currentMonth].length <= idx) {
          monthData[currentYear][currentMonth].push({start:'',end:'',breakTime:''});
        }
        monthData[currentYear][currentMonth][idx][field] = value;
      }
    }
    function formatInput(input) {
      if (!input || input.type !== 'tel') return;
      let v = input.value.replace(/[^\d:]/g,'');
      if (v.length === 4 && !v.includes(':')) v = v.slice(0,2)+':'+v.slice(2);
      else if (v.length===3 && v.charAt(2) !== ':' && parseInt(v.slice(0,2),10)<=23)
        v = v.slice(0,2)+':'+v.slice(2);
      if (v.length>5) v = v.slice(0,5);
      input.value = v;
      if (v.length===5) {
        if (!isTimeValid(v)) {
          input.style.border = '1px solid red';
          setTimeout(()=>input.style.border='',2000);
        }
      }
    }
    function moveNext(curr, nextId) {
      if (!nextId) return;
      const nxt = document.getElementById(nextId);
      if (nxt && document.activeElement===curr) {
        nxt.focus();
        nxt.select?.();
      }
    }
    function calculateRow(day) {
      const s = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value;
      const e = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value;
      const b = parseFloat(document.getElementById(`break-${currentYear}-${currentMonth}-${day}`)?.value)||0;
      const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
      const grossEl = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
      const netEl   = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
      if (!s||!e) {
        totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
        grossEl.value = '0.00'; netEl.value = '0.00';
        return;
      }
      if (!isTimeValid(s)||!isTimeValid(e)) {
        totalCell.textContent = 'Neplatný čas';
        grossEl.value = '0.00'; netEl.value = '0.00';
        return;
      }
      const [sh,sm] = s.split(':').map(Number);
      let   [eh,em] = e.split(':').map(Number);
      let startM = sh*60+sm;
      let endM   = eh*60+em;
      if (endM<startM) endM += 24*60;
      const worked = Math.max(0, endM-startM - b*60);
      const h = Math.floor(worked/60), m = Math.round(worked%60), dec = worked/60;
      totalCell.textContent = `${h}h ${m}m (${dec.toFixed(decimalPlaces)} h)`;
      const gross = dec * hourlyWage;
      grossEl.value = isFinite(gross)?gross.toFixed(2):'0.00';
      const net = gross * (1 - taxRate);
      netEl.value = isFinite(net)?net.toFixed(2):'0.00';
    }

    // 15. resetRow, resetAll
    function resetRow(day) {
      const idx = day-1;
      const s = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
      const e = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
      const b = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      const t = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
      const g = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
      const n = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
      if (s&&e&&b&&t&&g&&n) {
        s.value = ''; e.value = ''; b.value = '';
        t.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
        g.value = '0.00'; n.value = '0.00';
        monthData[currentYear][currentMonth][idx] = {start:'',end:'',breakTime:''};
        debouncedProcessInputCompletion(`reset-${day}`, null);
      }
    }
    function resetAll() {
      if (confirm('Naozaj chcete resetovať všetky záznamy pre tento mesiac?')) {
        monthData[currentYear][currentMonth] = [];
        createTable();
        calculateTotal();
        debouncedProcessInputCompletion('reset-all', null);
        showSaveNotification("Dáta pre aktuálny mesiac boli resetované.");
      }
    }

    // 16. calculateTotal
    function calculateTotal() {
      let totalMin=0, daysCnt=0;
      const rows = workDays.querySelectorAll('tr');
      rows.forEach((row,idx)=>{
        const d=idx+1;
        const s = document.getElementById(`start-${currentYear}-${currentMonth}-${d}`)?.value;
        const e = document.getElementById(`end-${currentYear}-${currentMonth}-${d}`)?.value;
        const b = parseFloat(document.getElementById(`break-${currentYear}-${currentMonth}-${d}`)?.value)||0;
        if (s&&e && isTimeValid(s)&&isTimeValid(e)) {
          const [sh,sm]=s.split(':').map(Number);
          let [eh,em]=e.split(':').map(Number);
          let st=sh*60+sm, en=eh*60+em;
          if (en<st) en+=24*60;
          const worked = Math.max(0, en-st - b*60);
          totalMin += worked;
          if (worked>0) daysCnt++;
        }
      });
      const totalH = Math.floor(totalMin/60), totalM=Math.round(totalMin%60), decTot=totalMin/60;
      const grossTot = decTot * hourlyWage;
      const netTot   = grossTot * (1 - taxRate);
      const avgNet = daysCnt>0 ? netTot/daysCnt : 0;
      const avgMin = daysCnt>0 ? totalMin/daysCnt : 0;
      const avgH = Math.floor(avgMin/60), avgM=Math.round(avgMin%60), avgDec=avgMin/60;
      totalSalaryDiv.innerHTML = `
        Počet odpracovaných dní: ${daysCnt}<br>
        Celkový odpracovaný čas: ${totalH}h ${totalM}m (${decTot.toFixed(decimalPlaces)} h)<br>
        Celková hrubá mzda: ${grossTot.toFixed(2)}€<br>
        Celková čistá mzda: ${netTot.toFixed(2)}€<br>
        Priemerná čistá mzda na deň: ${avgNet.toFixed(2)}€<br>
        <strong>Priemerný odpracovaný čas na deň: ${avgH}h ${avgM}m (${avgDec.toFixed(decimalPlaces)} h)</strong>
      `;
    }

    // 17. Export do PDF
    function exportToPDF() {
      if (!window.jspdf?.jsPDF?.API?.autoTable) {
        alert("Chyba: Knižnica jsPDF alebo autoTable nie je načítaná.");
        return;
      }
      const { jsPDF } = window.jspdf;
      try {
        const doc = new jsPDF();
        try {
          doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf','Roboto','normal');
          doc.setFont('Roboto');
        } catch(e) {
          console.warn("Nepodarilo sa načítať Roboto font do PDF, použijem default.", e);
        }
        doc.setFontSize(18);
        doc.text(`Bruno's Calculator - Výkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
        doc.setFontSize(12);
        doc.text(`Meno pracovníka: ${employeeName||'Nezadané'}`, 14, 28);
        doc.text(`Hodinová mzda: ${hourlyWage} €`, 14, 34);
        doc.text(`Daň (%): ${taxRate*100}`, 100, 34);

        const cols = ["Deň","Príchod","Odchod","Prestávka (h)","Odpracované","Hrubá Mzda (€)","Čistá Mzda (€)"];
        const rows = [];
        const dataArr = monthData[currentYear]?.[currentMonth] || [];
        dataArr.forEach((day,idx)=>{
          if (day.start||day.end) {
            const dnum = idx+1;
            const dname= getDayName(currentYear,currentMonth,dnum);
            const tot = document.getElementById(`total-${currentYear}-${currentMonth}-${dnum}`)?.textContent||'';
            const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${dnum}`)?.value||'0.00';
            const net   = document.getElementById(`net-${currentYear}-${currentMonth}-${dnum}`)?.value||'0.00';
            rows.push([`Deň ${dnum} (${dname})`, day.start||'-', day.end||'-', day.breakTime||'0', tot, gross, net]);
          }
        });
        doc.autoTable({ head:[cols], body:rows, startY:40, headStyles:{fillColor:[41,128,185], textColor:255}, styles:{fontSize:9}, alternateRowStyles:{fillColor:[240,240,240]} });
        const finalY = doc.lastAutoTable.finalY||40;
        doc.setFontSize(10);
        const totalTxt = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi,'\n').replace(/<\/?strong>/g,'');
        doc.text(totalTxt,14,finalY+10);
        const fname = `Vykaz-${employeeName||'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
        doc.save(fname);
        showSaveNotification("PDF exportované.");
      } catch(error) {
        console.error("Chyba pri generovaní PDF v exportToPDF:", error);
        alert("Nastala chyba pri vytváraní PDF súboru.");
      }
    }
    function sendPDF() {
      if (!window.jspdf?.jsPDF?.API?.autoTable) {
        alert("Chyba: Knižnica jsPDF alebo autoTable nie je načítaná.");
        return;
      }
      const { jsPDF } = window.jspdf;
      try {
        const doc = new jsPDF();
        try {
          doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf','Roboto','normal');
          doc.setFont('Roboto');
        } catch(e) {
          console.warn("sendPDF: Nepodarilo sa načítať Roboto font, použijem default.", e);
        }
        doc.setFontSize(16);
        doc.text(`Pracovný výkaz - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
        doc.setFontSize(12);
        doc.text(`Meno pracovníka: ${employeeName||'Nezadané'}`, 14, 28);

        const cols = ["Deň","Príchod","Odchod","Prestávka (h)"];
        const rows = [];
        const dataArr = monthData[currentYear]?.[currentMonth] || [];
        dataArr.forEach((day,idx)=>{
          if (day.start||day.end) {
            const dnum = idx+1;
            const dname= getDayName(currentYear,currentMonth,dnum);
            rows.push([`Deň ${dnum} (${dname})`, day.start||'-', day.end||'-', day.breakTime||'0']);
          }
        });
        doc.autoTable({ head:[cols], body:rows, startY:35, headStyles:{fillColor:[41,128,185], textColor:255}, styles:{fontSize:9}, alternateRowStyles:{fillColor:[240,240,240]} });
        const finalY = doc.lastAutoTable.finalY||35;
        doc.setFontSize(10);
        const match = totalSalaryDiv.innerHTML.match(/Počet odpracovaných dní: (\d+)/);
        const daysCnt = match ? match[1] : 'N/A';
        doc.text(`Počet odpracovaných dní: ${daysCnt}`, 14, finalY+10);

        const blob = doc.output('blob');
        const fname = `Vykaz_odoslanie-${employeeName||'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
        const file = new File([blob], fname, { type:'application/pdf' });

        if (navigator.share && navigator.canShare({ files:[file] })) {
          navigator.share({ files:[file], title:`Pracovný výkaz ${getMonthName(currentMonth)} ${currentYear}`, text:`Výkaz pre ${employeeName||'pracovníka'} za ${getMonthName(currentMonth)} ${currentYear}.`})
            .then(()=> showSaveNotification("PDF pripravené na zdieľanie."))
            .catch(err=> {
              if (err.name!=='AbortError') {
                console.error("sendPDF share error:", err);
                alert("Chyba pri zdieľaní súboru.");
              }
            });
        } else {
          alert("Zdieľanie súborov nie je podporované tvojím prehliadačom. Súbor sa stiahne.");
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = fname; document.body.appendChild(a);
          a.click(); document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
      } catch(error) {
        console.error("Chyba pri generovaní alebo zdieľaní PDF v sendPDF:", error);
        alert("Nastala chyba pri generovaní alebo zdieľaní PDF súboru.");
      }
    }

    // 18. Backup & restore
    function createBackup() {
      try {
        const backupData = {
          workDaysData: localStorage.getItem('workDaysData')||'{}',
          hourlyWage: localStorage.getItem('hourlyWage')||JSON.stringify(10),
          taxRate: localStorage.getItem('taxRate')||JSON.stringify(2),
          darkMode: localStorage.getItem('darkMode')||JSON.stringify(false),
          decimalPlaces: localStorage.getItem('decimalPlaces')||JSON.stringify(1),
          employeeName: localStorage.getItem('employeeName')||JSON.stringify(''),
          backupVersion: 2,
          backupTimestamp: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(backupData,null,2)], { type:"application/json;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bruno-calculator-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showSaveNotification("Záloha úspešne vytvorená.");
      } catch(error) {
        console.error("Chyba pri vytváraní zálohy:", error);
        alert("Nastala chyba pri vytváraní záložného súboru.");
      }
    }
    function restoreBackup() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const backup = JSON.parse(ev.target.result);
            if (
              backup && typeof backup.workDaysData==='string' &&
              typeof backup.hourlyWage==='string' &&
              typeof backup.taxRate==='string' &&
              typeof backup.darkMode==='string' &&
              typeof backup.decimalPlaces==='string' &&
              typeof backup.employeeName==='string'
            ) {
              localStorage.setItem('workDaysData', backup.workDaysData);
              localStorage.setItem('hourlyWage', backup.hourlyWage);
              localStorage.setItem('taxRate', backup.taxRate);
              localStorage.setItem('darkMode', backup.darkMode);
              localStorage.setItem('decimalPlaces', backup.decimalPlaces);
              localStorage.setItem('employeeName', backup.employeeName);
              loadFromLocalStorage();
              showSaveNotification("Záloha úspešne obnovená.");
              alert("Záloha bola úspešne obnovená.");
              if (auth.currentUser) {
                console.log("Obnova zálohy: Ukladám obnovené dáta pre aktuálny mesiac do Firebase...");
                debouncedProcessInputCompletion('restore-backup', null);
              }
            } else {
              alert("Chyba: Súbor zálohy má nesprávny formát alebo chýbajú dáta.");
            }
          } catch(err) {
            console.error("Chyba pri spracovaní alebo obnove zálohy:", err);
            alert("Chyba pri čítaní záložného súboru. Môže byť poškodený.");
          }
        };
        reader.onerror = ev => {
          console.error("Chyba pri čítaní súboru zálohy:", ev);
          alert("Nastala chyba pri čítaní súboru zálohy.");
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // 19. Inicializácia
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM načítaný, inicializujem...");
      populateYearSelect();
      const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
      applyDarkMode(darkMode);
      updateWelcomeMessage();

      // --- AK STRÁNKA JE HNEĎ OFFLINE, NACÍTAJ LOKÁLNE ÚDAJE AUTOMATICKY ---
      if (!navigator.onLine) {
        console.log("Offline pri inicializácii: Načítavam lokálne dáta...");
        loadFromLocalStorage();
        showSaveNotification("Offline: Načítané lokálne dáta", "warning");
      }

      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(reg => console.log('ServiceWorker zaregistrovaný s rozsahom:', reg.scope))
            .catch(err => console.error('Registrácia ServiceWorker zlyhala:', err));
        });
      } else {
        console.warn("Service Worker nie je podporovaný v tomto prehliadači.");
      }
      console.log("Základná inicializácia dokončená, čakám na stav prihlásenia...");
    });

    function populateYearSelect() {
      const startYear = 2020;
      const endYear = new Date().getFullYear() + 2;
      yearSelect.innerHTML = '';
      for (let y = startYear; y <= endYear; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
      }
    }
    function changeDecimalPlaces() {
      const np = parseInt(decimalPlacesSelect.value);
      if (!isNaN(np) && np>=1 && np<=2) {
        decimalPlaces = np;
        calculateTotal();
        debouncedProcessInputCompletion('settings-change', null);
      }
    }
    function updateEmployeeName() {
      employeeName = employeeNameInput.value;
      updateWelcomeMessage();
      debouncedProcessInputCompletion('settings-change', null);
    }
    function updateSettings() {
      const nhw = parseFloat(hourlyWageInput.value);
      const ntp = parseFloat(taxRateInput.value);
      let changed=false;
      if (!isNaN(nhw)&&nhw>=0&&nhw!==hourlyWage) {
        hourlyWage=nhw; changed=true;
      }
      if (!isNaN(ntp)&&ntp>=0&&ntp<=100&&(ntp/100)!==taxRate) {
        taxRate = ntp/100; changed=true;
      }
      const rows = workDays.querySelectorAll('tr');
      rows.forEach((_,i)=>calculateRow(i+1));
      calculateTotal();
      if (changed) debouncedProcessInputCompletion('settings-change', null);
    }
    function changeMonth() {
      const sm = parseInt(monthSelect.value);
      if (sm!==currentMonth) {
        currentMonth=sm;
        console.log(`Zmenený mesiac na: ${getMonthName(currentMonth)}`);
        handleMonthYearChange();
      }
    }
    function changeYear() {
      const sy = parseInt(yearSelect.value);
      if (sy!==currentYear) {
        currentYear=sy;
        console.log(`Zmenený rok na: ${currentYear}`);
        handleMonthYearChange();
      }
    }
    function handleMonthYearChange() {
      console.log(`handleMonthYearChange: Spustené pre ${getMonthName(currentMonth)} ${currentYear}`);
      localStorage.setItem('currentMonth',currentMonth);
      localStorage.setItem('currentYear', currentYear);
      loadFromLocalStorage();
      if (auth.currentUser) setupFirestoreListener();
    }
    function getDaysInMonth(month) {
      if (month===undefined||currentYear===undefined) return 31;
      return new Date(currentYear, month+1, 0).getDate();
    }
    function getMonthName(m) {
      const names = ["Január","Február","Marec","Apríl","Máj","Jún","Júl","August","September","Október","November","December"];
      return names[m]||'Neznámy';
    }
    function updateDataSize() {
      try {
        const total = Object.values(localStorage).reduce((a,v)=>a+(v?v.length:0),0);
        const kb = (total/1024).toFixed(2);
        const pct = Math.min((total/MAX_DATA_SIZE)*100,100);
        dataSizeText.textContent = `Lokálne úložisko: ~${kb} KB / ${MAX_DATA_SIZE_KB} KB`;
        dataSizeFill.style.width = `${pct}%`;
        if (pct>90) dataSizeFill.style.backgroundColor='#f44336';
        else if (pct>70) dataSizeFill.style.backgroundColor='#ff9800';
        else dataSizeFill.style.backgroundColor='#4CAF50';
      } catch(e) {
        console.error("Chyba pri výpočte veľkosti localStorage:", e);
        dataSizeText.textContent = "Chyba pri výpočte veľkosti dát.";
      }
    }
    function toggleDarkMode() {
      const dm = document.body.classList.toggle('dark-mode');
      applyDarkMode(dm);
      localStorage.setItem('darkMode', JSON.stringify(dm));
      if (auth.currentUser) saveToFirebase();
    }
  </script>
</body>
</html>
