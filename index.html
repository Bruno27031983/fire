<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <!-- Google Fonts Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase knižnice -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF a autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- ŠTÝLY --- */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background: #f4f4f4; color: #333; }
    .container { max-width:1200px; margin:auto; background:#fff; padding:15px; border-radius:5px; box-shadow:0 0 10px rgba(0,0,0,0.1); position:relative; }
    .autor-info { position:absolute; top:10px; left:10px; font-size:14px; font-style:italic; color:#666; }
    h1 { text-align:center; font-size:2.5em; background:linear-gradient(90deg,#f00,#0f0,#00f,#ff0,#f0f); background-clip:text; -webkit-background-clip:text; color:transparent; animation:gradientText 5s ease infinite, textShadowPulse 2s ease infinite; margin-bottom:10px; }
    h2 { text-align:center; color:#555; margin-top:-10px; font-size:1.2em; }
    .settings { display:flex; flex-wrap:wrap; justify-content:space-between; margin-bottom:20px; align-items:center; }
    .settings > div { flex:1 1 200px; margin:5px; }
    .settings label { display:block; margin-bottom:5px; }
    .table-container { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; min-width:800px; margin-bottom:20px; }
    th, td { padding:8px; border:1px solid #ddd; font-size:0.9em; }
    th { background:#f2f2f2; }
    input[type="tel"],input[type="number"],input[type="text"] { width:100%; padding:5px; box-sizing:border-box; background:#ffffd0; border:1px solid #ccc; border-radius:3px; font-size:14px; }
    .btn-container { display:flex; flex-direction:column; gap:15px; margin-top:20px; }
    .btn { width:100%; padding:15px 20px; border:none; border-radius:5px; color:#fff; font-size:16px; cursor:pointer; transition:background 0.3s; text-align:center; }
    .reset-btn { background:#f44336; } .reset-btn:hover { background:#d32f2f; }
    .export-btn { background:#4caf50; } .export-btn:hover { background:#388e3c; }
    .restore-btn { background:#9c27b0; } .restore-btn:hover { background:#7b1fa2; }
    .backup-btn { background:#ffa500; } .backup-btn:hover { background:#e68900; }
    .highlight { background:#ffcc00; color:#333; font-weight:bold; border:2px solid #ffcc00; }
    #totalSalary { margin-top:20px; padding:10px; background:#e6f3ff; border-radius:5px; font-size:18px; font-weight:bold; text-align:center; }
    #dataSizeContainer { text-align:center; margin-top:10px; }
    #dataSizeText { color:#555; margin-bottom:5px; font-size:14px; }
    #dataSizeBar { width:80%; height:20px; background:#ddd; border-radius:10px; margin:0 auto; overflow:hidden; }
    #dataSizeFill { height:100%; width:0; background:#4caf50; transition:width 0.3s; }
    .current-day { background:#8a2be2; color:#fff; }
    .current-day input { background:#9932cc; color:#fff; }
    @keyframes gradientText { 0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%} }
    @keyframes textShadowPulse { 0%,100%{text-shadow:0 0 10px rgba(255,255,255,0.5),0 0 20px rgba(255,255,255,0.3),0 0 30px rgba(255,255,255,0.2);}50%{text-shadow:0 0 20px rgba(255,255,255,1),0 0 30px rgba(255,255,255,0.9),0 0 40px rgba(255,255,255,0.7);} }
    body.dark-mode { background:#333; color:#f4f4f4; }
    .container.dark-mode { background:#444; color:#f4f4f4; }
    table.dark-mode, th.dark-mode, td.dark-mode { background:#555; color:#f4f4f4; }
    input.dark-mode { background:#666; color:#fff; }
    .btn.dark-mode { color:#333; }
    .reset-btn.dark-mode { background:#d32f2f; }
    .export-btn.dark-mode { background:#388e3c; }
    .restore-btn.dark-mode { background:#7b1fa2; }
    .backup-btn.dark-mode { background:#e68900; }
    #totalSalary.dark-mode { background:#2c3e50; }
    .current-day.dark-mode { background:#4a0e8f; color:#fff; }
    #auth-container { max-width:400px; margin:20px auto; background:#fff; padding:20px; border-radius:5px; box-shadow:0 0 5px rgba(0,0,0,0.1); text-align:center; }
    #auth-container input { width:90%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:3px; }
    #auth-container button { width:95%; padding:10px; margin:10px 0; border:none; background:#4caf50; color:#fff; font-size:16px; border-radius:3px; cursor:pointer; }
    #auth-container button:hover { background:#45a049; }
    #saveNotification { position:fixed; bottom:20px; right:20px; padding:10px 20px; border-radius:5px; display:none; color:#fff; z-index:1000; }
    #saveNotification.show { display:block; }
    #saveNotification.error { background:#f44336; }
    #saveNotification.warning { background:#ff9800; }
    #loading-container { position:fixed; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#fff; z-index:9999; transition:opacity 0.5s; }
    #loading-container.hidden { opacity:0; pointer-events:none; }
    #forgot-password-link { display:block; margin-top:15px; font-size:14px; color:#007bff; cursor:pointer; }
    #forgot-password-link:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loading-container">
    <h1>Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte, dosiahnete všetko.</h1>
  </div>

  <!-- Auth container -->
  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>

  <!-- Calculator container -->
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>

    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option>
          <option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option>
          <option value="6">Júl</option><option value="7">August</option><option value="8">September</option>
          <option value="9">Október</option><option value="10">November</option><option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
        <select id="yearSelect" onchange="changeYear()"></select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Počet desatinných miest:</label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option><option value="2">2</option>
        </select>
      </div>
      <button class="btn highlight" onclick="toggleDarkMode()">Prepínať tmavý režim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka</th>
            <th>Odpracované</th><th>Hrubá Mzda (€)</th><th>Čistá Mzda (€)</th><th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div id="dataSizeContainer">
      <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>

    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
    </div>
  </div>

  <div id="saveNotification"></div>

  <script>
    // 1) Firebase config & init
    const firebaseConfig = {
      apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo",
      authDomain: "bruno-3cee2.firebaseapp.com",
      projectId: "bruno-3cee2",
      storageBucket: "bruno-3cee2.appspot.com",
      messagingSenderId: "155545319308",
      appId: "1:155545319308:web:5da498ff1cd3e1833888a9"
    };
    try {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase inicializovaný.");
    } catch(e) {
      console.error("Chyba init Firebase:", e);
      alert("Chyba konfigurácie Firebase – skontroluj konzolu.");
    }
    try {
      firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true);
    } catch(e) { console.warn("App Check:", e); }
    const db = firebase.firestore();
    const auth = firebase.auth();
    db.enablePersistence().catch(err => console.warn("Offline persistence:", err.code));

    // 2) Globálne premenne
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
    let monthData = {}, firestoreListenerUnsubscribe = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const MAX_DATA_SIZE = 4*1024*1024, MAX_DATA_SIZE_KB = MAX_DATA_SIZE/1024;

    // 3) Pomocné funkcie
    function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms);};}
    function showSaveNotification(msg,type='success'){ 
      const n=document.getElementById('saveNotification');
      n.textContent=msg; n.className='show';
      if(type==='error') n.classList.add('error');
      if(type==='warning') n.classList.add('warning');
      setTimeout(()=>n.classList.remove('show'),3000);
    }
    function getFirstName(full){ return full?.trim().split(' ')[0]||''; }
    function updateWelcomeMessage(){
      const el=document.getElementById('welcomeMessage'), fn=getFirstName(employeeName);
      el.textContent = fn?`Vitaj, ${fn}!`:'';
    }

    // 4) Pri načítaní DOM vždy načítaj localStorage + offline listener
    document.addEventListener('DOMContentLoaded',()=>{
      populateYearSelect();
      applyDarkMode(JSON.parse(localStorage.getItem('darkMode'))||false);
      loadFromLocalStorage();
      updateWelcomeMessage();
      window.addEventListener('offline',()=>{
        loadFromLocalStorage();
        showSaveNotification("Offline: načítané lokálne dáta","warning");
      });
      if('serviceWorker' in navigator){
        window.addEventListener('load',()=>navigator.serviceWorker.register('./service-worker.js'));
      }
    });

    // 5) Auth / Firestore listener / save / load / UI funkcie
    auth.onAuthStateChanged(user=>{
      const authC=document.getElementById('auth-container'),
            calcC=document.getElementById('calculator-container'),
            loadC=document.getElementById('loading-container');
      if(loadC) loadC.classList.add('hidden');
      if(firestoreListenerUnsubscribe){ firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe=null; }
      if(user){
        document.getElementById('auth-message').textContent="Prihlásený: "+user.email;
        authC.style.display='none'; calcC.style.display='block';
        const storedM=localStorage.getItem('currentMonth'),
              storedY=localStorage.getItem('currentYear'),
              now=new Date();
        currentMonth=storedM!=null?parseInt(storedM):now.getMonth();
        currentYear=storedY!=null?parseInt(storedY):now.getFullYear();
        monthSelect.value=currentMonth;
        if(!yearSelect.querySelector(`option[value="${currentYear}"]`)){
          currentYear=now.getFullYear(); populateYearSelect();
        }
        yearSelect.value=currentYear;
        hourlyWage=parseFloat(localStorage.getItem('hourlyWage'))||10;
        taxRate=(parseFloat(localStorage.getItem('taxRate'))||2)/100;
        decimalPlaces=parseInt(localStorage.getItem('decimalPlaces'))||1;
        employeeName=localStorage.getItem('employeeName')||'';
        hourlyWageInput.value=hourlyWage; taxRateInput.value=taxRate*100;
        decimalPlacesSelect.value=decimalPlaces; employeeNameInput.value=employeeName;
        loadFromLocalStorage();
        setupFirestoreListener();
      } else {
        document.getElementById('auth-message').textContent="Žiadny používateľ nie je prihlásený.";
        authC.style.display='block'; calcC.style.display='none';
        workDays.innerHTML=''; totalSalaryDiv.innerHTML='';
        updateWelcomeMessage();
      }
    });

    function setupFirestoreListener(){
      const uid=auth.currentUser?.uid; if(!uid) return;
      const docRef=db.doc(`users/${uid}/calculatorData/${currentYear}-${currentMonth}`);
      firestoreListenerUnsubscribe=docRef.onSnapshot(snap=>{
        const isLocal=snap.metadata.hasPendingWrites;
        if(isLocal){
          if(snap.exists) monthData[currentYear][currentMonth]=(snap.data().days||[]).map(d=>({start:d.start,end:d.end,breakTime:d.breakTime}));
          localStorage.setItem('workDaysData',JSON.stringify(monthData));
          return;
        }
        if(snap.exists){
          const data=snap.data();
          hourlyWage=data.hourlyWage||hourlyWage;
          taxRate=(data.taxRate||taxRate*100)/100;
          decimalPlaces=data.decimalPlaces||decimalPlaces;
          employeeName=data.employeeName||employeeName;
          if(!monthData[currentYear]) monthData[currentYear]={};
          monthData[currentYear][currentMonth]=(data.days||[]).map(d=>({start:d.start,end:d.end,breakTime:d.breakTime}));
          localStorage.setItem('hourlyWage',hourlyWage);
          localStorage.setItem('taxRate',taxRate*100);
          localStorage.setItem('decimalPlaces',decimalPlaces);
          localStorage.setItem('employeeName',employeeName);
          localStorage.setItem('workDaysData',JSON.stringify(monthData));
          updateUIFromLoadedData(data.darkMode||false);
          updateWelcomeMessage();
        } else {
          if(!monthData[currentYear]) monthData[currentYear]={};
          monthData[currentYear][currentMonth]=[];
          localStorage.setItem('workDaysData',JSON.stringify(monthData));
          updateUIFromLoadedData(JSON.parse(localStorage.getItem('darkMode'))||false);
        }
      },err=>{ console.error(err); loadFromLocalStorage(); });
    }

    function register(){const e=document.getElementById('registerEmail').value,p=document.getElementById('registerPassword').value;auth.createUserWithEmailAndPassword(e,p).then(()=>alert("Úspešne registrovaný!")).catch(err=>alert("Chyba: "+err.message));}
    function login(){const e=document.getElementById('loginEmail').value,p=document.getElementById('loginPassword').value;auth.signInWithEmailAndPassword(e,p).catch(err=>alert("Chyba: "+err.message));}
    function logout(){auth.signOut().catch(err=>alert("Chyba: "+err.message));}
    function forgotPassword(){const e=document.getElementById('loginEmail').value; if(!e){alert("Zadaj email.");return;} auth.sendPasswordResetEmail(e).catch(err=>alert("Chyba: "+err.message));}

    function saveToLocalStorage(){
      if(!monthData[currentYear]) monthData[currentYear]={};
      localStorage.setItem('hourlyWage',hourlyWage);
      localStorage.setItem('taxRate',taxRate*100);
      localStorage.setItem('decimalPlaces',decimalPlaces);
      localStorage.setItem('employeeName',employeeName);
      localStorage.setItem('currentMonth',currentMonth);
      localStorage.setItem('currentYear',currentYear);
      localStorage.setItem('workDaysData',JSON.stringify(monthData));
      updateDataSize();
    }

    function loadFromLocalStorage(){
      monthData=JSON.parse(localStorage.getItem('workDaysData'))||{};
      hourlyWage=parseFloat(localStorage.getItem('hourlyWage'))||10;
      taxRate=(parseFloat(localStorage.getItem('taxRate'))||2)/100;
      decimalPlaces=parseInt(localStorage.getItem('decimalPlaces'))||1;
      employeeName=localStorage.getItem('employeeName')||'';
      if(!monthSelect.querySelector(`option[value="${currentMonth}"]`)) populateYearSelect();
      monthSelect.value=currentMonth;
      yearSelect.value=currentYear;
      updateUIFromLoadedData(JSON.parse(localStorage.getItem('darkMode'))||false);
    }

    function updateUIFromLoadedData(isDark){
      hourlyWageInput.value=hourlyWage; taxRateInput.value=taxRate*100;
      decimalPlacesSelect.value=decimalPlaces; employeeNameInput.value=employeeName;
      createTable(); calculateTotal(); applyDarkMode(isDark);
    }

    function applyDarkMode(d){
      document.body.classList[d?'add':'remove']('dark-mode');
      document.querySelector('.container').classList[d?'add':'remove']('dark-mode');
      Array.from(document.querySelectorAll('input,table,th,td,.btn')).forEach(el=>el.classList[d?'add':'remove']('dark-mode'));
    }

    function createTable(){
      workDays.innerHTML='';
      const days=new Date(currentYear,currentMonth+1,0).getDate();
      const today=new Date(), isCurrMonth=(today.getFullYear()==currentYear&&today.getMonth()==currentMonth);
      for(let i=1;i<=days;i++){
        const tr=document.createElement('tr');
        if(isCurrMonth&&i==today.getDate()) tr.classList.add('current-day');
        const dname=["Nedeľa","Pondelok","Utorok","Streda","Štvrtok","Piatok","Sobota"][new Date(currentYear,currentMonth,i).getDay()];
        tr.innerHTML=`
          <td>Deň ${i} (${dname})</td>
          <td><input type="tel" id="start-${i}" placeholder="HH:MM" oninput="handleInput(this,'end-${i}',${i})"></td>
          <td><input type="tel" id="end-${i}" placeholder="HH:MM" oninput="handleInput(this,'break-${i}',${i})"></td>
          <td><input type="number" id="break-${i}" min="0" step="0.5" placeholder="hod" oninput="handleBreak(${i})"></td>
          <td id="total-${i}">0h 0m (0.0 h)</td>
          <td><input type="number" id="gross-${i}" readonly></td>
          <td><input type="number" id="net-${i}" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">Reset</button></td>
        `;
        workDays.appendChild(tr);
      }
      applyDarkMode(document.body.classList.contains('dark-mode'));
    }

    function isValidTime(s){return/^([01]\\d|2[0-3]):([0-5]\\d)$/.test(s);}
    const deb=debounce((id,next)=>{saveToLocalStorage(); if(id.startsWith('start')||id.startsWith('end')) calculateTotal(); if(next)document.getElementById(next).focus();},300);

    function handleInput(el,next,day){
      let v=el.value.replace(/[^\d:]/g,'');
      if(v.length==4&&!v.includes(':')) v=v.slice(0,2)+':'+v.slice(2);
      el.value=v.slice(0,5);
      calculateRow(day);
      deb(el.id,next);
    }

    function handleBreak(day){
      calculateRow(day); deb(`break-${day}`,null);
    }

    function calculateRow(day){
      const s=document.getElementById(`start-${day}`).value,
            e=document.getElementById(`end-${day}`).value,
            b=parseFloat(document.getElementById(`break-${day}`).value)||0,
            totEl=document.getElementById(`total-${day}`),
            grossEl=document.getElementById(`gross-${day}`),
            netEl=document.getElementById(`net-${day}`);
      if(!isValidTime(s)||!isValidTime(e)){ totEl.textContent='-'; grossEl.value=netEl.value='0.00'; return; }
      let [sh,sm]=s.split(':').map(Number), [eh,em]=e.split(':').map(Number);
      let start=sh*60+sm, end=eh*60+em;
      if(end<start) end+=1440;
      const worked=Math.max(0,end-start-b*60),
            h=Math.floor(worked/60), m=worked%60, dec=worked/60;
      totEl.textContent=`${h}h ${m}m (${dec.toFixed(decimalPlaces)} h)`;
      const gross=dec*hourlyWage, net=gross*(1-taxRate);
      grossEl.value=gross.toFixed(2); netEl.value=net.toFixed(2);
    }

    function calculateTotal(){
      let totalMin=0, count=0;
      for(let i=1;i<=new Date(currentYear,currentMonth+1,0).getDate();i++){
        const s=document.getElementById(`start-${i}`).value,
              e=document.getElementById(`end-${i}`).value,
              b=parseFloat(document.getElementById(`break-${i}`).value)||0;
        if(isValidTime(s)&&isValidTime(e)){
          let [sh,sm]=s.split(':').map(Number), [eh,em]=e.split(':').map(Number);
          let start=sh*60+sm, end=eh*60+em; if(end<start) end+=1440;
          const worked=Math.max(0,end-start-b*60);
          totalMin+=worked; if(worked>0) count++;
        }
      }
      const h=Math.floor(totalMin/60), m=totalMin%60, dec=totalMin/60;
      const gross=dec*hourlyWage, net=gross*(1-taxRate),
            avgNet=count?net/count:0, avgDec=count?totalMin/count/60:0,
            avgH=Math.floor(avgDec), avgM=Math.round((avgDec-avgH)*60);
      totalSalaryDiv.innerHTML=`
        Počet dní: ${count}<br>
        Celk. čas: ${h}h ${m}m (${dec.toFixed(decimalPlaces)}h)<br>
        Hrubá mzda: ${gross.toFixed(2)}€<br>
        Čistá mzda: ${net.toFixed(2)}€<br>
        Priem. čistá mzda: ${avgNet.toFixed(2)}€<br>
        <strong>Priem. čas: ${avgH}h ${avgM}m (${avgDec.toFixed(decimalPlaces)}h)</strong>
      `;
    }

    function resetRow(day){
      ['start','end','break'].forEach(f=>{const el=document.getElementById(`${f}-${day}`); if(el) el.value='';});
      calculateRow(day); calculateTotal(); saveToLocalStorage();
    }
    function resetAll(){
      if(confirm('Naozaj resetovať?')){ for(let i=1;i<=new Date(currentYear,currentMonth+1,0).getDate();i++) resetRow(i); }
    }

    function exportToPDF(){
      if(!window.jspdf?.jsPDF?.API?.autoTable){ alert('Chýba jsPDF'); return; }
      const { jsPDF }=window.jspdf, doc=new jsPDF();
      doc.setFontSize(18); doc.text(`Výkaz ${currentMonth+1}/${currentYear}`,14,20);
      doc.setFontSize(12); doc.text(`Meno: ${employeeName}`,14,28);
      const cols=["Deň","Príchod","Odchod","Prestávka","Odpracované","Hrubá","Čistá"], rows=[];
      for(let i=1;i<=new Date(currentYear,currentMonth+1,0).getDate();i++){
        const s=document.getElementById(`start-${i}`).value,
              e=document.getElementById(`end-${i}`).value,
              b=document.getElementById(`break-${i}`).value||'0',
              t=document.getElementById(`total-${i}`).textContent,
              g=document.getElementById(`gross-${i}`).value,
              n=document.getElementById(`net-${i}`).value;
        if(s||e) rows.push([i,s,e,b,t,g,n]);
      }
      doc.autoTable({ head:[cols], body:rows, startY:35 });
      doc.save(`Vykaz-${currentYear}-${currentMonth+1}.pdf`);
    }

    function sendPDF(){
      exportToPDF(); // zjednodušené
    }

    function createBackup(){
      const data={
        workDaysData:localStorage.getItem('workDaysData'),
        hourlyWage:localStorage.getItem('hourlyWage'),
        taxRate:localStorage.getItem('taxRate'),
        decimalPlaces:localStorage.getItem('decimalPlaces'),
        employeeName:localStorage.getItem('employeeName'),
        timestamp:new Date().toISOString()
      };
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}),
            url=URL.createObjectURL(blob),
            a=document.createElement('a');
      a.href=url; a.download=`backup-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
    }

    function restoreBackup(){
      const inp=document.createElement('input'); inp.type='file'; inp.accept='.json';
      inp.onchange=e=>{
        const file=e.target.files[0]; if(!file)return;
        const reader=new FileReader();
        reader.onload=ev=>{
          try{
            const b=JSON.parse(ev.target.result);
            ['workDaysData','hourlyWage','taxRate','decimalPlaces','employeeName'].forEach(k=>{
              localStorage.setItem(k,b[k]);
            });
            loadFromLocalStorage(); alert('Obnova hotová');
          }catch(err){alert('Chyba obnovy');}
        };
        reader.readAsText(file);
      };
      inp.click();
    }

    function populateYearSelect(){
      const ysel=yearSelect, cur=new Date().getFullYear();
      for(let y=2020;y<=cur+2;y++){
        const o=new Option(y,y);
        ysel.add(o);
      }
    }
    function changeMonth(){ currentMonth=parseInt(monthSelect.value); saveToLocalStorage(); createTable(); }
    function changeYear(){ currentYear=parseInt(yearSelect.value); saveToLocalStorage(); createTable(); }
    function changeDecimalPlaces(){ decimalPlaces=parseInt(decimalPlacesSelect.value); calculateTotal(); saveToLocalStorage(); }
    function updateEmployeeName(){ employeeName=employeeNameInput.value; updateWelcomeMessage(); saveToLocalStorage(); }
    function updateSettings(){ hourlyWage=parseFloat(hourlyWageInput.value)||hourlyWage; taxRate=(parseFloat(taxRateInput.value)||taxRate*100)/100; calculateTotal(); saveToLocalStorage(); }

  </script>
</body>
</html>
