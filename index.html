<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF + autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- CSS --- */
    body { font-family:'Roboto',sans-serif; margin:0; padding:10px; background:#f4f4f4; color:#333; }
    .container { max-width:1200px; margin:auto; background:#fff; padding:15px; border-radius:5px; box-shadow:0 0 10px rgba(0,0,0,0.1); position:relative; }
    .autor-info { position:absolute; top:10px; left:10px; font-style:italic; color:#666; }
    h1 { text-align:center; font-size:2.5em; background:linear-gradient(90deg,#f00,#0f0,#00f,#ff0,#f0f); -webkit-background-clip:text; color:transparent; animation:gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; }
    h2 { text-align:center; color:#555; font-size:1.2em; margin-top:-10px; }
    .settings { display:flex; flex-wrap:wrap; justify-content:space-between; margin-bottom:20px; }
    .settings>div { flex:1 1 200px; margin:5px; }
    label { display:block; margin-bottom:5px; }
    input, select { width:100%; padding:5px; box-sizing:border-box; background:#ffffd0; border:1px solid #ccc; border-radius:3px; font-size:14px; }
    .btn { padding:15px; border:none; border-radius:5px; color:#fff; cursor:pointer; font-size:16px; margin-top:5px; }
    .reset-btn { background:#f44336; } .reset-btn:hover { background:#d32f2f; }
    .export-btn { background:#4CAF50; } .export-btn:hover { background:#388e3c; }
    .restore-btn { background:#9C27B0; } .restore-btn:hover { background:#7B1FA2; }
    .backup-btn { background:#FFA500; } .backup-btn:hover { background:#E68900; }
    .highlight { background:#ffcc00; color:#333; font-weight:bold; border:2px solid #ffcc00; }
    table { width:100%; border-collapse:collapse; margin-bottom:20px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.9em; }
    th { background:#f2f2f2; }
    #totalSalary { background:#e6f3ff; padding:10px; border-radius:5px; font-weight:bold; text-align:center; }
    #dataSizeContainer { text-align:center; margin-top:10px; }
    #dataSizeBar { width:80%; height:20px; background:#ddd; border-radius:10px; margin:0 auto; overflow:hidden; }
    #dataSizeFill { height:100%; width:0; background:#4CAF50; transition:width .3s; }
    .btn-container { display:flex; flex-direction:column; gap:10px; margin-top:20px; }
    #saveNotification { position:fixed; bottom:20px; right:20px; padding:10px 20px; border-radius:5px; color:#fff; display:none; }
    #saveNotification.show { display:block; }
    #saveNotification.error { background:#f44336; }
    #saveNotification.warning { background:#ff9800; }
    @keyframes gradientText { 0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%} }
    @keyframes textShadowPulse { 0%,100%{text-shadow:0 0 10px rgba(255,255,255,.5)}50%{text-shadow:0 0 20px rgba(255,255,255,1)} }
    body.dark-mode { background:#333; color:#f4f4f4; }
    .dark-mode input, .dark-mode select { background:#666; color:#fff; }
    table.dark-mode, td.dark-mode { background:#555; color:#f4f4f4; }
    th.dark-mode { background:#666; }
    .dark-mode .reset-btn { background:#d32f2f; }
    .dark-mode .export-btn { background:#388e3c; }
    .dark-mode .restore-btn { background:#7B1FA2; }
    .dark-mode .backup-btn { background:#E68900; }
    .dark-mode #totalSalary { background:#2c3e50; }
    .current-day { background:#8a2be2; color:#fff; }
    .current-day input { background:#9932cc; color:#fff; }
  </style>
</head>
<body>

  <div id="loading-container">
    <h1>Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte, dosiahnete všetko.</h1>
  </div>

  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
    <h2>Registrácia</h2>
    <input type="email" id="registerEmail" placeholder="Email">
    <input type="password" id="registerPassword" placeholder="Heslo">
    <button class="btn export-btn" onclick="register()">Registrovať</button>
    <h2>Prihlásenie</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Heslo">
    <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
    <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
  </div>

  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>

    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daň (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option>
          <option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option>
          <option value="6">Júl</option><option value="7">August</option><option value="8">September</option>
          <option value="9">Október</option><option value="10">November</option><option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
        <select id="yearSelect" onchange="changeYear()"></select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Desatinných miest:</label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option><option value="2">2</option>
        </select>
      </div>
      <button class="btn highlight" onclick="toggleDarkMode()">Prepínať tmavý režim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka</th>
            <th>Odpracované</th><th>Hrubá mzda (€)</th><th>Čistá mzda (€)</th><th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary"></div>

    <div id="dataSizeContainer">
      <div id="dataSizeText">Lokálne úložisko: ~0 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>

    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
    </div>
  </div>

  <div id="saveNotification"></div>

  <script>
    // --- 1) Firebase Init ---
    const firebaseConfig = {
      apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo",
      authDomain: "bruno-3cee2.firebaseapp.com",
      projectId: "bruno-3cee2",
      storageBucket: "bruno-3cee2.appspot.com",
      messagingSenderId: "155545319308",
      appId: "1:155545319308:web:5da498ff1cd3e1833888a9"
    };
    firebase.initializeApp(firebaseConfig);
    try {
      firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true);
    } catch(e){ console.warn("AppCheck:",e) }
    const db = firebase.firestore(), auth = firebase.auth();
    db.enablePersistence().catch(err=>console.error("Offline persist:",err));

    // --- 2) Globálne ---
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
    let monthData = {}, firestoreListenerUnsubscribe = null;
    const workDays = document.getElementById('workDays'),
          totalSalaryDiv = document.getElementById('totalSalary'),
          dataSizeText = document.getElementById('dataSizeText'),
          dataSizeFill = document.getElementById('dataSizeFill'),
          hourlyWageInput = document.getElementById('hourlyWageInput'),
          taxRateInput = document.getElementById('taxRateInput'),
          monthSelect = document.getElementById('monthSelect'),
          yearSelect = document.getElementById('yearSelect'),
          decimalPlacesSelect = document.getElementById('decimalPlacesSelect'),
          employeeNameInput = document.getElementById('employeeNameInput'),
          MAX_DATA_SIZE = 4*1024*1024, MAX_DATA_SIZE_KB = MAX_DATA_SIZE/1024;

    // --- 3) Auth ---
    function register(){
      const e=document.getElementById('registerEmail').value,
            p=document.getElementById('registerPassword').value;
      auth.createUserWithEmailAndPassword(e,p)
        .then(()=>alert("Registrácia úspešná"))
        .catch(err=>alert("Chyba: "+err.message));
    }
    function login(){
      const e=document.getElementById('loginEmail').value,
            p=document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(e,p)
        .catch(err=>alert("Chyba: "+err.message));
    }
    function logout(){
      auth.signOut().then(()=>alert("Odhlásenie úspešné")).catch(err=>alert("Chyba: "+err.message));
    }
    function forgotPassword(){
      const e=document.getElementById('loginEmail').value;
      if(!e){ alert("Zadaj email"); return; }
      auth.sendPasswordResetEmail(e)
        .then(()=>alert("Email na reset odoslaný"))
        .catch(err=>alert("Chyba: "+err.message));
    }

    // --- 4) Auth state ---
    auth.onAuthStateChanged(user=>{
      document.getElementById('loading-container').classList.add('hidden');
      const aC=document.getElementById('auth-container'),
            cC=document.getElementById('calculator-container');
      if(firestoreListenerUnsubscribe){ firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe=null; }
      if(user){
        document.getElementById('auth-message').textContent="Prihlásený: "+user.email;
        aC.style.display='none'; cC.style.display='block';

        // načítaj nastavenia
        const sm=localStorage.getItem('currentMonth'),
              sy=localStorage.getItem('currentYear'),
              dm=JSON.parse(localStorage.getItem('darkMode'))||false,
              now=new Date();
        currentMonth=sm!==null?+sm:now.getMonth();
        currentYear=sy!==null?+sy:now.getFullYear();
        monthSelect.value=currentMonth;
        applyDarkMode(dm);

        hourlyWage = parseFloat(localStorage.getItem('hourlyWage'))||10;
        taxRate    = parseFloat(localStorage.getItem('taxRate'))/100||0.02;
        decimalPlaces = parseInt(localStorage.getItem('decimalPlaces'))||1;
        employeeName  = localStorage.getItem('employeeName')||'';

        hourlyWageInput.value=hourlyWage;
        taxRateInput.value=taxRate*100;
        decimalPlacesSelect.value=decimalPlaces;
        employeeNameInput.value=employeeName;

        loadFromLocalStorage();
        setupFirestoreListener();

        // železobetónové
        setTimeout(()=>{
          if(auth.currentUser && !navigator.onLine){
            console.log("Offline reload localStorage");
            loadFromLocalStorage();
          }
        },150);

      } else {
        aC.style.display='block'; cC.style.display='none';
        monthData={}; workDays.innerHTML=''; totalSalaryDiv.innerHTML='';
      }
    });

    // --- 5) Utils ---
    function debounce(fn,t){ let h; return(...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a),t); }; }
    function showSaveNotification(msg,type='success'){
      const n=document.getElementById('saveNotification');
      n.textContent=msg; n.className='show '+type;
      setTimeout(()=>n.className='hide',3000);
    }

    // prvé meno
    function getFirstName(full){
      if(!full)return'';
      const t=full.trim().split(' ');
      return t[0]||'';
    }
    function updateWelcomeMessage(){
      const w=document.getElementById('welcomeMessage');
      w.textContent = getFirstName(employeeName)?`Vitaj, ${getFirstName(employeeName)}!`:'';
    }

    // --- 6) Firestore listener ---
    function setupFirestoreListener(){
      const uid=auth.currentUser?.uid; if(!uid)return;
      const path=`users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
      const ref=db.doc(path);
      firestoreListenerUnsubscribe = ref.onSnapshot(doc=>{
        if(doc.metadata.hasPendingWrites){
          showSaveNotification("Lokálne zmeny...",'warning');
          return;
        }
        if(doc.exists){
          const data=doc.data();
          hourlyWage = data.hourlyWage||hourlyWage;
          taxRate    = (data.taxRate||taxRate*100)/100;
          decimalPlaces = data.decimalPlaces||decimalPlaces;
          employeeName  = data.employeeName||employeeName;
          localStorage.setItem('hourlyWage', hourlyWage);
          localStorage.setItem('taxRate', taxRate*100);
          localStorage.setItem('decimalPlaces', decimalPlaces);
          localStorage.setItem('employeeName', employeeName);

          monthData[currentYear] = monthData[currentYear]||{};
          monthData[currentYear][currentMonth] = data.days||[];
          localStorage.setItem('workDaysData', JSON.stringify(monthData));

          updateUIFromLoadedData(data.darkMode);
          showSaveNotification("Dáta synchronizované");
        } else {
          loadFromLocalStorage();
        }
      },err=>{
        console.error("Listener err:",err);
        loadFromLocalStorage();
      });
    }

    // --- 7) Local Storage load/save ---
    function loadFromLocalStorage(){
      try {
        const d=localStorage.getItem('workDaysData');
        monthData = d?JSON.parse(d):{};
        updateUIFromLoadedData(JSON.parse(localStorage.getItem('darkMode')));
      } catch(e){
        console.error("Load LS err:",e);
      }
    }
    function saveToLocalStorage(){
      try {
        localStorage.setItem('hourlyWage', hourlyWage);
        localStorage.setItem('taxRate', taxRate*100);
        localStorage.setItem('decimalPlaces', decimalPlaces);
        localStorage.setItem('employeeName', employeeName);
        localStorage.setItem('currentMonth', currentMonth);
        localStorage.setItem('currentYear', currentYear);

        monthData[currentYear] = monthData[currentYear]||{};
        localStorage.setItem('workDaysData', JSON.stringify(monthData));
        updateDataSize();
        saveToFirebase();
        if(!navigator.onLine) showSaveNotification("Offline uložené",'warning');
      } catch(err){
        console.error("Save LS err:",err);
        showSaveNotification("Chyba LS",'error');
      }
    }

    async function saveToFirebase(){
      const u=auth.currentUser; if(!u)return;
      const d = monthData[currentYear][currentMonth]||[];
      try {
        await db.collection("users").doc(u.uid)
          .collection("calculatorData")
          .doc(`${currentYear}-${currentMonth}`)
          .set({
            days:d,
            hourlyWage,
            taxRate:taxRate*100,
            decimalPlaces,
            employeeName,
            darkMode: document.body.classList.contains('dark-mode'),
            timestamp:firebase.firestore.FieldValue.serverTimestamp()
          });
      } catch(e){
        console.error("Save FB err:",e);
        showSaveNotification("Chyba Firebase",'error');
      }
    }

    // --- 8) UI aktualizácia ---
    function updateUIFromLoadedData(isDark){
      // aplikuje dark
      applyDarkMode(isDark);
      updateWelcomeMessage();
      createTable();
      const arr=(monthData[currentYear]||{})[currentMonth]||[];
      arr.forEach((day,i)=>{
        const idx=i+1;
        const s=document.getElementById(`start-${currentYear}-${currentMonth}-${idx}`);
        const e=document.getElementById(`end-${currentYear}-${currentMonth}-${idx}`);
        const b=document.getElementById(`break-${currentYear}-${currentMonth}-${idx}`);
        if(s) s.value=day.start||'';
        if(e) e.value=day.end||'';
        if(b) b.value=day.breakTime||'';
        calculateRow(idx);
      });
      calculateTotal();
    }

    // --- 9) Tvorba tabuľky ---
    function getDayName(y,m,d){
      return ["Ne","Po","Ut","St","Št","Pi","So"][new Date(y,m,d).getDay()];
    }
    function createTable(){
      workDays.innerHTML='';
      const days=new Date(currentYear,currentMonth+1,0).getDate();
      const today=new Date();
      for(let i=1;i<=days;i++){
        const tr=document.createElement('tr');
        if(i===today.getDate()&&currentMonth===today.getMonth()&&currentYear===today.getFullYear()){
          tr.classList.add('current-day');
        }
        tr.innerHTML=`
          <td>${i} (${getDayName(currentYear,currentMonth,i)})</td>
          <td><input id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" placeholder="HH:MM" oninput="handleInput(this,'end-${currentYear}-${currentMonth}-${i}',${i})"></td>
          <td><input id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" placeholder="HH:MM" oninput="handleInput(this,'break-${currentYear}-${currentMonth}-${i}',${i})"></td>
          <td><input id="break-${currentYear}-${currentMonth}-${i}" type="number" min="0" step="0.5" placeholder="h" oninput="handleBreakInput(${i})"></td>
          <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m</td>
          <td><input id="gross-${currentYear}-${currentMonth}-${i}" readonly></td>
          <td><input id="net-${currentYear}-${currentMonth}-${i}" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">✕</button></td>
        `;
        workDays.appendChild(tr);
      }
    }

    // --- 10) Input handlers ---
    function isTimeValid(t){ return /^([01]\d|2[0-3]):([0-5]\d)$/.test(t); }
    function handleInput(el,nextId,day){
      debouncedProcessInputCompletion(el.id,nextId);
    }
    function handleBreakInput(day){
      debouncedProcessInputCompletion(`break-${currentYear}-${currentMonth}-${day}`,null);
    }
    const debouncedProcessInputCompletion=debounce((id,nxt)=>{
      calculateRow(id.split('-').pop());
      saveToLocalStorage();
    },500);

    // --- 11) Výpočty ---
    function calculateRow(day){
      const s=document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value||'';
      const e=document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value||'';
      const b=parseFloat(document.getElementById(`break-${currentYear}-${currentMonth}-${day}`)?.value)||0;
      const totalCell=document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
      const grossEl=document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
      const netEl=document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
      if(!isTimeValid(s)||!isTimeValid(e)){
        totalCell.textContent='0h 0m';
        grossEl.value=netEl.value='0.00';
        return;
      }
      const [sh,sm]=s.split(':').map(Number), [eh,em]=e.split(':').map(Number);
      let start=sh*60+sm, end=eh*60+em;
      if(end<start) end+=1440;
      const worked=end-start - b*60;
      const h=Math.floor(worked/60), m=worked%60;
      totalCell.textContent=`${h}h ${m}m`;
      const dec=worked/60;
      const gross=dec*hourlyWage;
      grossEl.value=gross.toFixed(2);
      netEl.value=(gross*(1-taxRate)).toFixed(2);
      if(!monthData[currentYear]) monthData[currentYear]={};
      if(!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth]=[];
      monthData[currentYear][currentMonth][day-1]={ start:s,end:e,breakTime:b };
    }

    function calculateTotal(){
      let totalMin=0, days=0;
      for(let i=1;i<workDays.rows.length+1;i++){
        const s=document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value;
        const e=document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value;
        const b=parseFloat(document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value)||0;
        if(isTimeValid(s)&&isTimeValid(e)){
          let [sh,sm]=s.split(':').map(Number), [eh,em]=e.split(':').map(Number);
          let st=sh*60+sm, en=eh*60+em; if(en<st)en+=1440;
          const w=Math.max(0,en-st - b*60);
          totalMin+=w; days++;
        }
      }
      const h=Math.floor(totalMin/60), m=totalMin%60;
      const dec=totalMin/60;
      const gross=dec*hourlyWage, net=gross*(1-taxRate);
      document.getElementById('totalSalary').innerHTML=
        `Dni: ${days}<br>`+
        `Čas: ${h}h ${m}m<br>`+
        `Hrubá: ${gross.toFixed(2)}€<br>`+
        `Čistá: ${net.toFixed(2)}€`;
    }

    // --- 12) CSV / PDF ---
    function exportToPDF(){
      const { jsPDF }=window.jspdf;
      const doc=new jsPDF();
      doc.text(`Výkaz ${currentYear}-${currentMonth+1}`,14,20);
      doc.autoTable({ html:'table', startY:30 });
      doc.save(`vykaz-${currentYear}-${currentMonth+1}.pdf`);
    }
    function sendPDF(){ exportToPDF(); }

    // --- 13) Reset ---
    function resetRow(day){
      ['start','end','break','gross','net','total'].forEach(f=>{
        const el=document.getElementById(`${f}-${currentYear}-${currentMonth}-${day}`);
        if(el) el.value='';
      });
      if(monthData[currentYear]&&monthData[currentYear][currentMonth]){
        monthData[currentYear][currentMonth][day-1]={start:'',end:'',breakTime:0};
      }
      calculateTotal();
      saveToLocalStorage();
    }
    function resetAll(){
      if(confirm("Resetovať všetko?")){
        monthData[currentYear][currentMonth]=[];
        createTable();
        calculateTotal();
        saveToLocalStorage();
      }
    }

    // --- 14) Nastavenia ---
    function updateSettings(){
      hourlyWage = parseFloat(hourlyWageInput.value)||hourlyWage;
      taxRate    = (parseFloat(taxRateInput.value)||taxRate*100)/100;
      decimalPlaces = parseInt(decimalPlacesSelect.value)||decimalPlaces;
      calculateTotal();
      saveToLocalStorage();
    }
    function updateEmployeeName(){
      employeeName = employeeNameInput.value;
      updateWelcomeMessage();
      saveToLocalStorage();
    }
    function changeMonth(){
      currentMonth=+monthSelect.value;
      loadFromLocalStorage();
      setupFirestoreListener();
    }
    function changeYear(){
      currentYear=+yearSelect.value;
      loadFromLocalStorage();
      setupFirestoreListener();
    }

    // --- 15) Dark Mode ---
    function applyDarkMode(on){
      document.body.classList.toggle('dark-mode',on);
      localStorage.setItem('darkMode',on);
      saveToFirebase();
    }
    function toggleDarkMode(){
      applyDarkMode(!document.body.classList.contains('dark-mode'));
    }

    // --- 16) Data size bar ---
    function updateDataSize(){
      let tot=0;
      for(const v of Object.values(localStorage)) tot+=v.length;
      const kb=(tot/1024).toFixed(2);
      const pct=Math.min(100,tot/MAX_DATA_SIZE*100);
      dataSizeText.textContent=`Lokálne úložisko: ~${kb} KB / ${MAX_DATA_SIZE_KB} KB`;
      dataSizeFill.style.width=pct+'%';
    }

    // --- 17) Záloha/Obnova ---
    function createBackup(){
      const blob=new Blob([JSON.stringify({
        workDaysData:localStorage.getItem('workDaysData'),
        hourlyWage:localStorage.getItem('hourlyWage'),
        taxRate:localStorage.getItem('taxRate'),
        decimalPlaces:localStorage.getItem('decimalPlaces'),
        employeeName:localStorage.getItem('employeeName')
      },null,2)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`backup-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
    }
    function restoreBackup(){
      const inp=document.createElement('input');
      inp.type='file'; inp.accept='application/json';
      inp.onchange=e=>{
        const file=e.target.files[0];
        const r=new FileReader();
        r.onload=()=>{
          const b=JSON.parse(r.result);
          localStorage.setItem('workDaysData',b.workDaysData);
          localStorage.setItem('hourlyWage',b.hourlyWage);
          localStorage.setItem('taxRate',b.taxRate);
          localStorage.setItem('decimalPlaces',b.decimalPlaces);
          localStorage.setItem('employeeName',b.employeeName);
          loadFromLocalStorage();
        };
        r.readAsText(file);
      };
      inp.click();
    }

    // --- 18) Populate years ---
    function populateYearSelect(){
      const start=2020, end=new Date().getFullYear()+1;
      yearSelect.innerHTML='';
      for(let y=start;y<=end;y++){
        const o=document.createElement('option');
        o.value=y; o.textContent=y;
        yearSelect.appendChild(o);
      }
      yearSelect.value=new Date().getFullYear();
      currentYear=new Date().getFullYear();
    }

    // --- 19) Init ---
    document.addEventListener('DOMContentLoaded',()=>{
      populateYearSelect();
      updateDataSize();
    });
  </script>
</body>
</html>
