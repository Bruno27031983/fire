<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <!-- Načítanie písma Roboto z Google Fonts (externá knižnica) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase knižnice -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <!-- Pridaná knižnica pre Firebase App Check -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF a autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- NOVÉ ŠTÝLY PRE KONTROLU VIDITEĽNOSTI --- */
    body.auth-pending #auth-container,
    body.auth-pending #calculator-container {
      display: none; /* Skryjeme oba hlavné kontajnery počas overovania */
    }
    body.logged-out #calculator-container,
    body.logged-out #loading-indicator {
        display: none; /* Skryjeme kalkulačku a loading, ak je odhlásený */
    }
    body.logged-in #auth-container,
    body.logged-in #loading-indicator {
        display: none; /* Skryjeme prihlásenie a loading, ak je prihlásený */
    }
    #loading-indicator {
        text-align: center;
        padding: 40px;
        font-size: 1.2em;
        color: #555;
    }
    /* --- KONIEC NOVÝCH ŠTÝLOV --- */

    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    .autor-info {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 14px;
      font-style: italic;
      color: #666;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    .settings > div {
      flex: 1 1 200px;
      margin: 5px;
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f2;
    }
    input[type="tel"], input[type="number"], input[type="text"] {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .btn-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 15px;
      margin-top: 20px;
    }
    .btn {
      width: 100%;
      padding: 15px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
      text-align: center;
    }
    .reset-btn { background-color: #f44336; }
    .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; }
    .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; }
    .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; }
    .backup-btn:hover { background-color: #E68900; }
    .logout-btn { background-color: #dc3545; } /* Štýl pre odhlasovacie tlačidlo */
    .logout-btn:hover { background-color: #c82333; }
    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
    }
    #totalSalary {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
    #dataSizeContainer {
      margin-top: 10px;
      text-align: center;
    }
    #dataSizeText {
      margin-bottom: 5px;
      font-size: 14px;
      color: #555;
    }
    #dataSizeBar {
      width: 80%;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
    }
    #dataSizeFill {
      height: 100%;
      width: 0%;
      background-color: #4CAF50;
      transition: width 0.3s ease;
    }
    .current-day {
      background-color: #8a2be2;
      color: white;
    }
    .current-day input {
      background-color: #9932cc;
      color: white;
    }
    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% {
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5),
                     0 0 20px rgba(255, 255, 255, 0.3),
                     0 0 30px rgba(255, 255, 255, 0.2);
      }
      50% {
        text-shadow: 0 0 20px rgba(255, 255, 255, 1),
                     0 0 30px rgba(255, 255, 255, 0.9),
                     0 0 40px rgba(255, 255, 255, 0.7);
      }
    }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    body.dark-mode #loading-indicator { color: #bbb; } /* Loading v tmavom režime */
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode { background-color: #666; color: white; border-color: #888; }
    .btn.dark-mode { color: #eee; } /* Upravená farba textu tlačidiel v tmavom režime */
    .reset-btn.dark-mode { background-color: #c82333; }
    .reset-btn.dark-mode:hover { background-color: #a71d2a; }
    .export-btn.dark-mode { background-color: #388e3c; }
    .export-btn.dark-mode:hover { background-color: #2a6f2f; }
    .restore-btn.dark-mode { background-color: #7B1FA2; }
    .restore-btn.dark-mode:hover { background-color: #5a137d; }
    .backup-btn.dark-mode { background-color: #E68900; }
    .backup-btn.dark-mode:hover { background-color: #b86e00; }
    .logout-btn.dark-mode { background-color: #c82333; } /* Odhlásenie v tmavom režime */
    .logout-btn.dark-mode:hover { background-color: #a71d2a; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container {
      max-width: 400px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      text-align: center;
      /* display: none; riadené cez CSS triedu na body */
    }
    #auth-container input {
      width: 90%;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    #auth-container button {
      width: 95%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      background-color: #4CAF50;
      color: #fff;
      font-size: 16px;
      border-radius: 3px;
      cursor: pointer;
    }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
    #saveNotification.show { display: block; }

    /* Tmavý režim pre Auth kontajner */
    #auth-container.dark-mode {
        background-color: #444;
        color: #f4f4f4;
    }
    #auth-container.dark-mode h1,
    #auth-container.dark-mode h2 {
        color: #eee; /* Svetlejšia farba pre nadpisy */
    }
    #auth-container.dark-mode input {
        background-color: #666;
        color: white;
        border-color: #888;
    }
    #auth-container.dark-mode button {
        background-color: #388e3c; /* Tmavšia zelená */
    }
    #auth-container.dark-mode button:hover {
        background-color: #2a6f2f;
    }
    #auth-container.dark-mode #auth-message {
        color: #ccc; /* Svetlejšia farba pre správu */
    }

  </style>
</head>
<!-- Pridaná počiatočná trieda 'auth-pending' -->
<body class="auth-pending">

  <!-- Indikátor načítavania -->
  <div id="loading-indicator">Načítavam...</div>

  <!-- Kontajner pre prihlásenie/registráciu -->
  <!-- Odstránený inline style="display:none;" -->
  <div id="auth-container">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Prosím, prihláste sa alebo sa zaregistrujte.</div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
    </div>
  </div>

  <!-- Kontajner pre kalkulačku -->
  <!-- Odstránený inline style="display:none;" -->
  <div id="calculator-container" class="container">
    <div class="autor-info">Vytvoril a financoval Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2></h2> <!-- Tento h2 sa môže naplniť dynamicky, ak treba -->
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka: </label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€): </label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%): </label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac: </label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option>
          <option value="1">Február</option>
          <option value="2">Marec</option>
          <option value="3">Apríl</option>
          <option value="4">Máj</option>
          <option value="5">Jún</option>
          <option value="6">Júl</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">Október</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok: </label>
        <select id="yearSelect" onchange="changeYear()"></select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Počet desatinných miest: </label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
      <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka</th>
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Veľkosť dát: 0 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button class="btn export-btn" onclick="loadFromFirebase()">Načítať dáta z Firebase</button>
      <!-- Tlačidlo odhlásenia - jeho zobrazenie je riadené triedou na body -->
      <button id="logout-btn" class="btn logout-btn" onclick="logout()">Odhlásiť sa</button>
    </div>
  </div>

  <div id="saveNotification"></div>

  <script>
    // -----------------------
    // 1) Konfigurácia Firebase
    // -----------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo",
      authDomain: "bruno-3cee2.firebaseapp.com",
      projectId: "bruno-3cee2",
      storageBucket: "bruno-3cee2.firebasestorage.app",
      messagingSenderId: "155545319308",
      appId: "1:155545319308:web:5da498ff1cd3e1833888a9"
    };
    firebase.initializeApp(firebaseConfig);
    // Inicializácia Firebase App Check s použitím reCAPTCHA kľúča
    try {
        firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true);
    } catch (error) {
        console.error("Chyba pri aktivácii App Check:", error);
        // Môžete sem pridať ďalšiu logiku pre prípad chyby, napr. zobrazenie upozornenia
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // -----------------------
    // 2) Globálne premenné
    // -----------------------
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate, monthData;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const MAX_DATA_SIZE = 4 * 1024 * 1024;
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // Premenné pre kontajnery (pre lepšiu čitateľnosť v onAuthStateChanged)
    const authContainer = document.getElementById('auth-container');
    const calculatorContainer = document.getElementById('calculator-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const bodyElement = document.body; // Referencia na body element

    // -----------------------
    // 3) Prihlásenie / odhlásenie
    // -----------------------
    function register() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      if (!email || !password) {
        alert("Prosím, zadajte email aj heslo.");
        return;
      }
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log("Registrovaný:", userCredential.user);
          alert("Registrácia úspešná!");
          // onAuthStateChanged sa postará o zmenu zobrazenia
        })
        .catch((error) => {
          console.error("Chyba pri registrácii:", error.message);
          alert("Chyba pri registrácii: " + error.message);
        });
    }

    function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
       if (!email || !password) {
        alert("Prosím, zadajte email aj heslo.");
        return;
      }
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log("Prihlásený:", userCredential.user);
          alert("Prihlásenie úspešné!");
          // onAuthStateChanged sa postará o zmenu zobrazenia
        })
        .catch((error) => {
          console.error("Chyba pri prihlásení:", error.message);
          alert("Chyba pri prihlásení: " + error.message);
        });
    }

    function logout() {
      auth.signOut()
        .then(() => {
          console.log("Odhlásený.");
          // Nepotrebujeme alert, onAuthStateChanged zmení zobrazenie
          // alert("Odhlásenie úspešné!");
        })
        .catch((error) => {
          console.error("Chyba pri odhlásení:", error.message);
          alert("Chyba pri odhlásení: " + error.message);
        });
    }

    // --- UPRAVENÁ ČASŤ PRE onAuthStateChanged ---
    auth.onAuthStateChanged(async (user) => {
      console.log("Stav autentifikácie sa zmenil. Používateľ:", user ? user.email : 'žiadny');

      // Odstránime počiatočnú triedu
      bodyElement.classList.remove('auth-pending');

      if (user) {
        // Používateľ je prihlásený
        bodyElement.classList.remove('logged-out');
        bodyElement.classList.add('logged-in');

        // Aplikujeme tmavý režim na auth kontajner, ak je to potrebné (aj keď je skrytý)
        // To zabezpečí konzistenciu, ak by sa na moment zobrazil pri odhlasovaní
        if (bodyElement.classList.contains('dark-mode')) {
            if (authContainer) authContainer.classList.add('dark-mode');
        } else {
             if (authContainer) authContainer.classList.remove('dark-mode');
        }

        // Načítanie dát - len ak ešte neboli načítané v tejto session
        // (Flag 'data-loaded' pomáha predísť zbytočnému načítaniu pri každej zmene stavu)
        if (calculatorContainer && calculatorContainer.getAttribute('data-loaded') !== 'true') {
            console.log("Používateľ prihlásený, načítavam dáta...");
            const uid = user.uid;
            const userDocRef = db.collection("users").doc(uid);
            try {
                const userDocSnap = await userDocRef.get();
                if (!userDocSnap.exists) {
                  await userDocRef.set({ email: user.email, createdAt: new Date().toISOString() });
                  console.log("Vytvorený dokument pre nového používateľa:", uid);
                }
                await loadFromFirebase(); // Počkáme na dokončenie načítania
                calculatorContainer.setAttribute('data-loaded', 'true'); // Označíme, že dáta sú načítané
                console.log("Dáta úspešne načítané.");
            } catch (error) {
                console.error("Chyba pri kontrole/vytváraní user dokumentu alebo načítaní dát:", error);
                // Skúsime načítať aspoň z localStorage ako fallback
                loadFromLocalStorage();
                calculatorContainer.setAttribute('data-loaded', 'true'); // Označíme aj pri fallbacku
            }
        } else {
            console.log("Používateľ prihlásený, dáta už boli načítané skôr.");
            // Ak už dáta boli načítané, len skontrolujeme tmavý režim pre istotu
             applyDarkModeGlobally(bodyElement.classList.contains('dark-mode'));
        }

      } else {
        // Používateľ nie je prihlásený
        bodyElement.classList.remove('logged-in');
        bodyElement.classList.add('logged-out');
        console.log("Používateľ odhlásený, zobrazujem prihlasovací formulár.");

        // Resetujeme flag načítania dát
        if (calculatorContainer) calculatorContainer.setAttribute('data-loaded', 'false');

        // Resetujeme aj dáta v pamäti a localStorage, ak chceme čistý stav po odhlásení
        // (Voliteľné - záleží od požiadaviek)
        // localStorage.removeItem('workDaysData');
        // localStorage.removeItem('hourlyWage');
        // ...atď.
        // monthData = {};
        // V aktuálnom stave nechávame dáta v localStorage pre prípadné opätovné prihlásenie

        // Aplikujeme tmavý režim na auth kontajner, ak je aktívny
        if (bodyElement.classList.contains('dark-mode')) {
           if (authContainer) authContainer.classList.add('dark-mode');
        } else {
           if (authContainer) authContainer.classList.remove('dark-mode');
        }
      }
    });
    // --- KONIEC UPRAVENEJ ČASTI onAuthStateChanged ---


    // -----------------------
    // 4) Funkcie pre ukladanie
    // -----------------------
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait); // Opravené volanie func
      };
    }
    // Znížené oneskorenie pre rýchlejšiu odozvu pri ukladaní
    const debouncedSaveToLocalStorage = debounce(saveToLocalStorage, 500);

    function showSaveNotification(message) {
      const notification = document.getElementById('saveNotification');
      if (!notification) return;
      notification.textContent = message;
      notification.classList.add('show');
      // Skryjeme notifikáciu po 2 sekundách
      setTimeout(() => notification.classList.remove('show'), 2000);
    }

    async function saveToFirebase() {
      const currentUser = auth.currentUser;
      if (!currentUser) {
         // console.log("Používateľ nie je prihlásený, neukladám do Firebase.");
         return;
      }
      // Skontrolujeme, či sú dáta pripravené na uloženie (napr. či existuje monthData)
      if (typeof monthData === 'undefined' || typeof hourlyWage === 'undefined' || typeof taxRate === 'undefined' || typeof decimalPlaces === 'undefined' || typeof employeeName === 'undefined') {
          console.warn("Dáta ešte nie sú pripravené na uloženie do Firebase.");
          return;
      }

      try {
        const dataToSave = {
          // Zabezpečíme, aby aj prázdne hodnoty boli uložené ako platný JSON
          workDaysData: JSON.stringify(monthData || {}),
          hourlyWage: JSON.stringify(hourlyWage), // hourlyWage je číslo
          taxRate: JSON.stringify(taxRate * 100), // Ukladáme ako % číslo
          darkMode: JSON.stringify(bodyElement.classList.contains('dark-mode')),
          decimalPlaces: JSON.stringify(decimalPlaces), // decimalPlaces je číslo
          employeeName: JSON.stringify(employeeName || ''), // employeeName je string
          timestamp: firebase.firestore.FieldValue.serverTimestamp() // Použijeme serverový čas
        };
        const yearMonthDoc = `${currentYear}-${currentMonth}`;
        const uid = currentUser.uid;
        await db.collection("users").doc(uid)
          .collection("calculatorData").doc(yearMonthDoc).set(dataToSave, { merge: true }); // Použijeme merge pre prípadné budúce rozšírenie
        console.log("Dáta úspešne uložené do Firebase pre:", uid, yearMonthDoc);
        showSaveNotification("Uložené"); // Kratšia notifikácia
      } catch (error) {
        console.error("Chyba pri ukladaní do Firebase:", error);
        alert("Chyba pri automatickom ukladaní dát: " + error.message);
      }
    }

    function saveToLocalStorage() {
        // Táto funkcia by mala primárne aktualizovať objekt monthData a potom volať saveToFirebase
        // Samotné ukladanie do localStorage už nemusí byť hlavným mechanizmom, ak preferujeme Firebase
        try {
            const data = [];
            const daysInMonth = getDaysInMonth(currentMonth); // Použijeme aktuálne nastavenia
            for (let i = 1; i <= daysInMonth; i++) {
                const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
                const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
                const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
                // Hodnoty gross a net sa už neukladajú, lebo sa vždy vypočítajú
                data.push({ start, end, breakTime });
            }

            // Aktualizujeme globálny objekt monthData
            if (!monthData) monthData = {}; // Inicializácia, ak neexistuje
            if (!monthData[currentYear]) monthData[currentYear] = {};
            monthData[currentYear][currentMonth] = data;

            // Uložíme do localStorage (ako zálohu alebo pre offline)
            localStorage.setItem('workDaysData', JSON.stringify(monthData));
            localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
            localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); // Ukladáme %
            localStorage.setItem('darkMode', JSON.stringify(bodyElement.classList.contains('dark-mode')));
            localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
            localStorage.setItem('employeeName', JSON.stringify(employeeName || ''));

            updateDataSize(); // Aktualizujeme ukazovateľ veľkosti (aj keď primárne ukladáme do Firebase)

            // Zavoláme uloženie do Firebase
            saveToFirebase();

        } catch (error) {
            console.error('Chyba pri príprave dát na uloženie:', error);
            // alert("Chyba pri ukladaní dát: " + error.message);
        }
    }


    async function loadFromFirebase() {
        const uid = auth.currentUser?.uid;
        if (!uid) {
            console.log("Nikto nie je prihlásený, načítavam z localStorage.");
            loadFromLocalStorage(); // Fallback
            return;
        }

        // Zabezpečíme, že máme platný rok a mesiac pred načítaním
        if (typeof currentYear === 'undefined' || typeof currentMonth === 'undefined') {
             console.warn("Rok alebo mesiac nie je definovaný, prerušujem načítanie z Firebase.");
             // Nastavíme defaultné hodnoty, ak chýbajú
             const currentDate = new Date();
             currentYear = currentDate.getFullYear();
             currentMonth = currentDate.getMonth();
             yearSelect.value = currentYear;
             monthSelect.value = currentMonth;
        }

        const yearMonthDoc = `${currentYear}-${currentMonth}`;
        console.log(`Pokúšam sa načítať dáta z Firebase pre ${uid}/${yearMonthDoc}...`);
        const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);

        try {
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                console.log("Dáta nájdené vo Firebase, spracovávam...");
                const data = docSnap.data();

                // Načítanie dát a nastavenie globálnych premenných
                monthData = JSON.parse(data.workDaysData || '{}');
                hourlyWage = parseFloat(JSON.parse(data.hourlyWage || '10')); // Default 10
                taxRate = parseFloat(JSON.parse(data.taxRate || '2')) / 100; // Načítame %, prevedieme na desatinné
                decimalPlaces = parseInt(JSON.parse(data.decimalPlaces || '1')); // Default 1
                employeeName = JSON.parse(data.employeeName || '""'); // Default ""
                const darkMode = JSON.parse(data.darkMode || 'false');

                // Uložíme aj do localStorage ako lokálnu kópiu/zálohu
                localStorage.setItem('workDaysData', JSON.stringify(monthData));
                localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); // Ukladáme %
                localStorage.setItem('darkMode', JSON.stringify(darkMode));
                localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                localStorage.setItem('employeeName', JSON.stringify(employeeName));

                // Aktualizujeme UI
                updateUIFromLoadedData(darkMode);
                showSaveNotification("Dáta načítané");

            } else {
                console.log("Pre tento mesiac/rok neboli nájdené žiadne dáta vo Firebase.");
                // Ak na Firebase nič nie je, skúsime localStorage
                loadFromLocalStorage();
                 // A resetneme monthData pre tento mesiac, aby sme neťahali staré dáta z iného mesiaca
                monthData = JSON.parse(localStorage.getItem('workDaysData') || '{}'); // Znovu načítame z LS
                if (monthData[currentYear] && monthData[currentYear][currentMonth]) {
                    // Ak sú dáta v LS pre tento mesiac, použijeme ich
                } else {
                     // Ak ani v LS nie sú dáta pre tento mesiac, vytvoríme prázdnu štruktúru
                     if (!monthData[currentYear]) monthData[currentYear] = {};
                     monthData[currentYear][currentMonth] = [];
                     console.log("Vytvorená prázdna štruktúra dát pre aktuálny mesiac.");
                }
                // Po načítaní z LS (alebo vytvorení prázdnej štruktúry) aktualizujeme UI
                const darkModeFromLS = JSON.parse(localStorage.getItem('darkMode') || 'false');
                updateUIFromLoadedData(darkModeFromLS);
            }
        } catch (error) {
            console.error("Chyba pri načítavaní dát z Firebase:", error);
            alert("Chyba pri načítavaní dát z cloudu: " + error.message + "\nSkúšam načítať lokálne dáta.");
            loadFromLocalStorage(); // Fallback pri chybe
        }
    }

    function loadFromLocalStorage() {
        console.log("Načítavam dáta z localStorage...");
        try {
            monthData = JSON.parse(localStorage.getItem('workDaysData') || '{}');
            hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage') || '10'));
            taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate') || '2')) / 100; // Načítame %, prevedieme
            decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces') || '1'));
            employeeName = JSON.parse(localStorage.getItem('employeeName') || '""');
            const darkMode = JSON.parse(localStorage.getItem('darkMode') || 'false');

            updateUIFromLoadedData(darkMode);
            console.log("Dáta z localStorage úspešne načítané a UI aktualizované.");

        } catch (error) {
            console.error('Chyba pri načítavaní z localStorage:', error);
            alert("Chyba pri načítavaní lokálnych dát: " + error.message);
            // Reset na defaultné hodnoty v prípade vážnej chyby
            resetToDefaults();
            updateUIFromLoadedData(false); // Aktualizujeme UI s defaultnými hodnotami
        }
    }

    // Pomocná funkcia na resetovanie na defaultné hodnoty
    function resetToDefaults() {
        monthData = {};
        hourlyWage = 10;
        taxRate = 0.02;
        decimalPlaces = 1;
        employeeName = '';
        // Nesmieme zabudnúť resetnúť aj localStorage, ak chceme
        // localStorage.clear(); // Pozor, toto vymaže všetko! Radšej selektívne.
        localStorage.removeItem('workDaysData');
        localStorage.removeItem('hourlyWage');
        localStorage.removeItem('taxRate');
        localStorage.removeItem('decimalPlaces');
        localStorage.removeItem('employeeName');
         // Dark mode necháme podľa posledného stavu alebo default false
        // localStorage.setItem('darkMode', 'false');
        console.warn("Aplikácia resetovaná na predvolené hodnoty kvôli chybe pri načítaní.");
    }


    // Pomocná funkcia na aktualizáciu UI po načítaní dát (z Firebase alebo LS)
    function updateUIFromLoadedData(darkMode) {
        // Nastavenie hodnôt v inputoch a selectoch
        if (hourlyWageInput) hourlyWageInput.value = hourlyWage;
        if (taxRateInput) taxRateInput.value = taxRate * 100; // Zobrazujeme %
        if (decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces;
        if (employeeNameInput) employeeNameInput.value = employeeName;

        // Aplikácia tmavého režimu
        applyDarkModeGlobally(darkMode);

        // Vytvorenie tabuľky a naplnenie dátami
        createTable(); // Táto funkcia teraz automaticky načíta dáta z `monthData`

        // Výpočet celkových súm
        calculateTotal();

        // Aktualizácia ukazovateľa veľkosti dát
        updateDataSize();
    }

    // Pomocná funkcia na aplikáciu/odstránenie dark-mode tried globálne
    function applyDarkModeGlobally(isDarkMode) {
        const elementsToToggle = document.querySelectorAll(
            '.container, table, th, td, input[type="tel"], input[type="number"], input[type="text"], .btn, #totalSalary, #auth-container'
        );

        if (isDarkMode) {
            if (!bodyElement.classList.contains('dark-mode')) bodyElement.classList.add('dark-mode');
            elementsToToggle.forEach(el => el.classList.add('dark-mode'));
             // Špeciálne pre aktuálny deň
            const currentDayRow = document.querySelector('tr.current-day');
            if (currentDayRow) {
                currentDayRow.classList.add('dark-mode');
                currentDayRow.querySelectorAll('input').forEach(input => input.classList.add('dark-mode'));
            }
        } else {
            if (bodyElement.classList.contains('dark-mode')) bodyElement.classList.remove('dark-mode');
            elementsToToggle.forEach(el => el.classList.remove('dark-mode'));
             // Špeciálne pre aktuálny deň
            const currentDayRow = document.querySelector('tr.current-day');
            if (currentDayRow) {
                 currentDayRow.classList.remove('dark-mode');
                 currentDayRow.querySelectorAll('input').forEach(input => input.classList.remove('dark-mode'));
            }
        }
         // Uistíme sa, že .current-day má správne triedy aj po zmene režimu
        const currentDayRow = document.querySelector('tr.current-day');
         if(currentDayRow) {
             if(isDarkMode) currentDayRow.classList.add('dark-mode');
             else currentDayRow.classList.remove('dark-mode');
         }

    }


    // -----------------------
    // 5) Vytváranie tabuľky
    // -----------------------
    function getDayName(year, month, day) {
      const daysOfWeek = ["Ned", "Pon", "Uto", "Str", "Štv", "Pia", "Sob"]; // Skrátené názvy
      const date = new Date(year, month, day);
      // Skontrolujeme platnosť dátumu, keby nastal posun kvôli letnému času
      if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
          return daysOfWeek[date.getDay()];
      }
      return "???"; // Ak dátum nie je platný
    }


    function createTable() {
        if (!workDays) return; // Ak element neexistuje
        workDays.innerHTML = ''; // Vyčistíme tabuľku
        const currentDate = new Date();
        const currentDayOfMonth = currentDate.getDate();
        const currentMonthIndex = currentDate.getMonth();
        const currentYearValue = currentDate.getFullYear();
        const daysInSelectedMonth = getDaysInMonth(currentMonth); // Používame globálne currentMonth a currentYear
        const isDarkMode = bodyElement.classList.contains('dark-mode'); // Zistíme aktuálny režim

        // Získame dáta pre aktuálny mesiac/rok z globálnej premennej monthData
        const currentMonthWorkData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) ? monthData[currentYear][currentMonth] : [];

        for (let i = 1; i <= daysInSelectedMonth; i++) {
            const row = document.createElement('tr');
            const dayData = currentMonthWorkData[i - 1] || { start: '', end: '', breakTime: '' }; // Dáta pre konkrétny deň alebo default

            // Označenie aktuálneho dňa
            const isCurrentDay = (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue);
            if (isCurrentDay) {
                row.classList.add('current-day');
            }
            // Pridanie triedy pre tmavý režim
            if (isDarkMode) {
                row.classList.add('dark-mode');
            }

            const dayName = getDayName(currentYear, currentMonth, i);
            const rowIdPrefix = `${currentYear}-${currentMonth}-${i}`;

            row.innerHTML = `
              <td class="${isDarkMode ? 'dark-mode' : ''} ${isCurrentDay ? 'current-day-cell' : ''}">${i}. ${dayName}</td>
              <td class="${isDarkMode ? 'dark-mode' : ''}"><input type="tel" id="start-${rowIdPrefix}" value="${dayData.start}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${rowIdPrefix}')" class="${isDarkMode ? 'dark-mode' : ''}"></td>
              <td class="${isDarkMode ? 'dark-mode' : ''}"><input type="tel" id="end-${rowIdPrefix}" value="${dayData.end}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${rowIdPrefix}')" class="${isDarkMode ? 'dark-mode' : ''}"></td>
              <td class="${isDarkMode ? 'dark-mode' : ''}"><input type="number" id="break-${rowIdPrefix}" value="${dayData.breakTime}" min="0" step="0.5" placeholder="hod" oninput="handleBreakInput(${i})" class="${isDarkMode ? 'dark-mode' : ''}"></td>
              <td id="total-${rowIdPrefix}" class="${isDarkMode ? 'dark-mode' : ''}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
              <td class="${isDarkMode ? 'dark-mode' : ''}"><input type="text" id="gross-${rowIdPrefix}" placeholder="0.00" readonly class="${isDarkMode ? 'dark-mode' : ''}" style="background-color: #e9ecef; border: none;"></td>
              <td class="${isDarkMode ? 'dark-mode' : ''}"><input type="text" id="net-${rowIdPrefix}" placeholder="0.00" readonly class="${isDarkMode ? 'dark-mode' : ''}" style="background-color: #e9ecef; border: none;"></td>
              <td class="${isDarkMode ? 'dark-mode' : ''}"><button class="btn reset-btn ${isDarkMode ? 'dark-mode' : ''}" onclick="resetRow(${i})">X</button></td> <!-- Zmenšené tlačidlo -->
            `;
            workDays.appendChild(row);

            // Ihneď po pridaní riadku prepočítame jeho hodnoty (mzda, odprac. čas)
            calculateRow(i);
        }
        // Po vytvorení celej tabuľky prepočítame celkové súčty
        calculateTotal();
    }


    function handleInput(input, nextId) {
      formatAndMoveNext(input, nextId);
      // calculateAndUpdateTotals sa volá v rámci formatAndMoveNext alebo handleBreakInput
    }

    function handleBreakInput(day) {
      const breakInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      if (!breakInput) return;

      // Odstránime prípadné nečíselné znaky okrem bodky
      breakInput.value = breakInput.value.replace(/[^0-9.]/g, '');

      calculateRow(day); // Prepočítame riadok
      calculateAndUpdateTotals(); // Prepočítame celkom a uložíme

      // Presun na ďalší deň len ak je zadaná hodnota a nie je to posledný deň
      if (breakInput.value !== '' && day < getDaysInMonth(currentMonth)) {
          moveNext(breakInput, `start-${currentYear}-${currentMonth}-${day + 1}`);
      }
    }


    function calculateAndUpdateTotals() {
      calculateTotal(); // Vypočíta a zobrazí celkové sumy
      debouncedSaveToLocalStorage(); // Naplánuje uloženie dát
    }

    function formatAndMoveNext(input, nextId) {
      let value = input.value.replace(/[^\d:]/g, '');
      let move = false; // Flag pre rozhodnutie o presune

      // Automatické pridanie dvojbodky
      if (value.length === 2 && !value.includes(':')) {
          const hours = parseInt(value);
          if (hours >= 0 && hours < 24) {
              value += ':';
          } else {
              value = ''; // Neplatné hodiny
          }
      }

      // Obmedzenie dĺžky
      if (value.length > 5) {
          value = value.slice(0, 5);
      }

      input.value = value; // Aktualizujeme hodnotu v poli

      // Kontrola platnosti a rozhodnutie o presune
      if (value.length === 5) {
        const parts = value.split(':');
        if (parts.length === 2) {
          const hours = parseInt(parts[0]);
          const minutes = parseInt(parts[1]);
          if (!isNaN(hours) && !isNaN(minutes) && hours >= 0 && hours < 24 && minutes >= 0 && minutes < 60) {
             move = true; // Formát je správny a čas je platný
          }
        }
      }

      // Získanie čísla dňa z ID elementu
      const dayMatch = input.id.match(/-(\d+)$/);
      if (dayMatch) {
          const day = parseInt(dayMatch[1]);
          calculateRow(day); // Vždy prepočítame riadok po zmene
          calculateAndUpdateTotals(); // Vždy prepočítame celkom a uložíme
      }

      // Presun kurzora, ak je flag nastavený
      if (move) {
        moveNext(input, nextId);
      }
    }


    function moveNext(currentElement, nextId) {
      const nextElement = document.getElementById(nextId);
      if (nextElement) {
        nextElement.focus();
        // Snažíme sa označiť text v nasledujúcom poli
        try {
            nextElement.select();
        } catch (e) {
            // Niektoré typy inputov (napr. number) nemusia podporovať select()
            console.debug("Element select() not supported for:", nextId);
        }
      }
    }


    function calculateRow(day) {
        const rowIdPrefix = `${currentYear}-${currentMonth}-${day}`;
        const startTimeInput = document.getElementById(`start-${rowIdPrefix}`);
        const endTimeInput = document.getElementById(`end-${rowIdPrefix}`);
        const breakTimeInput = document.getElementById(`break-${rowIdPrefix}`);
        const totalCell = document.getElementById(`total-${rowIdPrefix}`);
        const grossElement = document.getElementById(`gross-${rowIdPrefix}`);
        const netElement = document.getElementById(`net-${rowIdPrefix}`);

        // Základná kontrola existencie elementov
        if (!startTimeInput || !endTimeInput || !breakTimeInput || !totalCell || !grossElement || !netElement) {
            console.warn(`Chýbajú elementy pre deň ${day}`);
            return;
        }

        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        const breakTime = parseFloat(breakTimeInput.value) || 0; // Prestávka v hodinách

        // Validácia formátu času HH:MM
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        if (!timeRegex.test(startTime) || !timeRegex.test(endTime)) {
            // Ak časy nie sú v správnom formáte, nastavíme nuly
            totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
            grossElement.value = (0).toFixed(decimalPlaces);
            netElement.value = (0).toFixed(decimalPlaces);
            return;
        }

        const [startHours, startMinutes] = startTime.split(':').map(Number);
        const [endHours, endMinutes] = endTime.split(':').map(Number);

        // Výpočet v minútach pre presnosť
        const startTotalMinutes = startHours * 60 + startMinutes;
        const endTotalMinutes = endHours * 60 + endMinutes;
        let diffMinutes = endTotalMinutes - startTotalMinutes;

        // Práca cez polnoc
        if (diffMinutes < 0) {
            diffMinutes += 24 * 60; // Pridáme 24 hodín v minútach
        }

        // Odpočítanie prestávky v minútach
        const breakMinutes = breakTime * 60;
        diffMinutes -= breakMinutes;

        // Zaokrúhlenie na celé minúty a zabezpečenie nezápornosti
        diffMinutes = Math.max(0, Math.round(diffMinutes));

        const hours = Math.floor(diffMinutes / 60);
        const minutes = diffMinutes % 60;
        const decimalHoursValue = diffMinutes / 60;

        // Zobrazenie odpracovaného času
        totalCell.textContent = `${hours}h ${minutes}m (${decimalHoursValue.toFixed(decimalPlaces)} h)`;

        // Výpočet a zobrazenie miezd
        const grossSalary = decimalHoursValue * hourlyWage;
        const netSalary = grossSalary * (1 - taxRate);

        grossElement.value = grossSalary.toFixed(decimalPlaces);
        netElement.value = netSalary.toFixed(decimalPlaces);
    }


    function resetRow(day) {
        const rowIdPrefix = `${currentYear}-${currentMonth}-${day}`;
        const startInput = document.getElementById(`start-${rowIdPrefix}`);
        const endInput = document.getElementById(`end-${rowIdPrefix}`);
        const breakInput = document.getElementById(`break-${rowIdPrefix}`);

        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
        if (breakInput) breakInput.value = '';

        // Prepočítame riadok (nastaví nuly) a potom celkové súčty a uložíme
        calculateRow(day);
        calculateAndUpdateTotals();
    }


    function resetAll() {
        const monthName = getMonthName(currentMonth);
        if (confirm(`Naozaj chcete vymazať všetky záznamy pre ${monthName} ${currentYear}?`)) {
            // Vymažeme dáta pre aktuálny mesiac/rok z objektu monthData
            if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) {
                monthData[currentYear][currentMonth] = []; // Nastavíme na prázdne pole
                console.log(`Dáta v pamäti pre ${monthName} ${currentYear} vymazané.`);
            }

            // Resetujeme všetky inputy v tabuľke
            const daysInMonth = getDaysInMonth(currentMonth);
            for (let i = 1; i <= daysInMonth; i++) {
                 const rowIdPrefix = `${currentYear}-${currentMonth}-${i}`;
                 const startInput = document.getElementById(`start-${rowIdPrefix}`);
                 const endInput = document.getElementById(`end-${rowIdPrefix}`);
                 const breakInput = document.getElementById(`break-${rowIdPrefix}`);
                 if (startInput) startInput.value = '';
                 if (endInput) endInput.value = '';
                 if (breakInput) breakInput.value = '';
                 // Prepočítame riadok, aby sa zobrazili nuly
                 calculateRow(i);
            }

            // Prepočítame celkové súčty (mali by byť nulové) a uložíme zmeny (prázdne dáta)
            calculateAndUpdateTotals();
            alert(`Všetky záznamy pre ${monthName} ${currentYear} boli vymazané.`);
        }
    }


    function calculateTotal() {
        if (!totalSalaryDiv) return; // Ak element neexistuje

        let totalMinutes = 0;
        let totalGrossSalary = 0;
        let totalNetSalary = 0;
        let daysWithWork = 0; // Počet dní s odpracovaným časom > 0

        const daysInMonth = getDaysInMonth(currentMonth);

        for (let i = 1; i <= daysInMonth; i++) {
            const rowIdPrefix = `${currentYear}-${currentMonth}-${i}`;
            const totalCell = document.getElementById(`total-${rowIdPrefix}`);
            const grossInput = document.getElementById(`gross-${rowIdPrefix}`);
            const netInput = document.getElementById(`net-${rowIdPrefix}`);

            if (totalCell && grossInput && netInput) {
                const totalText = totalCell.textContent;
                const match = totalText.match(/(\d+)h (\d+)m/); // Získame hodiny a minúty
                if (match) {
                    const hours = parseInt(match[1], 10) || 0;
                    const minutes = parseInt(match[2], 10) || 0;
                    const currentDayMinutes = hours * 60 + minutes;

                    if (currentDayMinutes > 0) {
                        daysWithWork++;
                        totalMinutes += currentDayMinutes;
                        totalGrossSalary += parseFloat(grossInput.value) || 0;
                        totalNetSalary += parseFloat(netInput.value) || 0;
                    }
                }
            }
        }

        const totalHours = Math.floor(totalMinutes / 60);
        const totalMinutesRemainder = totalMinutes % 60;
        const totalDecimalHours = totalMinutes / 60;

        const averageNetSalary = daysWithWork > 0 ? (totalNetSalary / daysWithWork) : 0;
        const averageWorkedMinutes = daysWithWork > 0 ? (totalMinutes / daysWithWork) : 0;
        const averageHours = Math.floor(averageWorkedMinutes / 60);
        const averageMinutes = Math.round(averageWorkedMinutes % 60);
        const averageDecimalHours = daysWithWork > 0 ? (averageWorkedMinutes / 60) : 0;

        // Formátovanie výstupu s desatinnými miestami podľa nastavenia
        totalSalaryDiv.innerHTML = `
          Odpracované dni: ${daysWithWork} |
          Celk. čas: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHours.toFixed(decimalPlaces)} h) |
          Hrubá mzda: ${totalGrossSalary.toFixed(decimalPlaces)} € |
          Čistá mzda: ${totalNetSalary.toFixed(decimalPlaces)} € <br>
          Priemer / deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(decimalPlaces)} h) |
          Priem. čistá mzda: ${averageNetSalary.toFixed(decimalPlaces)} €
        `;
    }


    // -----------------------
    // 7) Export do PDF so správnou diakritikou (Ponechaná opravená verzia)
    // -----------------------
     function exportToPDF() {
       // Kontrola načítania knižníc
       if (!window.jspdf || !window.jspdf.jsPDF) {
         alert("Knižnica jsPDF nie je načítaná.");
         return;
       }
       if (typeof window.jspdf.jsPDF.API.autoTable !== 'function') {
          alert("Funkcia autoTable (jspdf-autotable) nie je načítaná.");
          return;
       }

       const { jsPDF } = window.jspdf;
       const doc = new jsPDF();

       try {
           doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
           doc.setFont('Roboto', 'normal');
       } catch (e) {
           console.error("Chyba pri pridávaní alebo nastavovaní fontu Roboto:", e);
           alert("Nastala chyba pri príprave fontu pre PDF. Diakritika nemusí byť zobrazená správne.");
           doc.setFont('Helvetica', 'normal');
       }

       doc.setFontSize(18);
       doc.text(`Výkaz práce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
       doc.setFontSize(11); // Menšie písmo pre detaily
       doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 28);
       doc.text(`Hodinová mzda: ${hourlyWage.toFixed(decimalPlaces)} €`, 100, 28); // Vpravo
       doc.text(`Sadzba dane: ${(taxRate * 100).toFixed(1)} %`, 14, 34);


       const tableData = [];
       const daysInMonth = getDaysInMonth(currentMonth);
       let pdfTotalMinutes = 0;
       let pdfTotalGross = 0;
       let pdfTotalNet = 0;

       for (let i = 1; i <= daysInMonth; i++) {
         const rowIdPrefix = `${currentYear}-${currentMonth}-${i}`;
         const dayName = getDayName(currentYear, currentMonth, i);
         const start = document.getElementById(`start-${rowIdPrefix}`)?.value || '';
         const end = document.getElementById(`end-${rowIdPrefix}`)?.value || '';
         const breakTimeInput = document.getElementById(`break-${rowIdPrefix}`);
         const breakTimeValue = breakTimeInput ? (parseFloat(breakTimeInput.value) || 0) : 0;
         const totalCell = document.getElementById(`total-${rowIdPrefix}`);
         const totalText = totalCell?.textContent || '';
         const totalMatch = totalText.match(/\(([\d.,]+) h\)/);
         const decimalHours = totalMatch ? parseFloat(totalMatch[1].replace(',', '.')) : 0;

         // Získame čas v minútach pre súčet
         const timeMatch = totalText.match(/(\d+)h (\d+)m/);
         const currentMins = timeMatch ? (parseInt(timeMatch[1])*60 + parseInt(timeMatch[2])) : 0;

         const gross = parseFloat(document.getElementById(`gross-${rowIdPrefix}`)?.value) || 0;
         const net = parseFloat(document.getElementById(`net-${rowIdPrefix}`)?.value) || 0;

         // Zahrnieme riadok len ak bol zadaný príchod alebo odchod A bol odpracovaný nejaký čas
         if ((start || end) && decimalHours > 0) {
           pdfTotalMinutes += currentMins;
           pdfTotalGross += gross;
           pdfTotalNet += net;
           tableData.push([
             `${i}. ${dayName}`, // Deň
             start,             // Príchod
             end,               // Odchod
             breakTimeValue > 0 ? breakTimeValue.toFixed(1) : '', // Prestávka (hod)
             decimalHours.toFixed(decimalPlaces), // Odpracované (hod)
             gross.toFixed(decimalPlaces),       // Hrubá (€)
             net.toFixed(decimalPlaces)          // Čistá (€)
           ]);
         }
       }

       doc.autoTable({
         head: [['Deň', 'Príchod', 'Odchod', 'Prest.', 'Hod.', 'Hrubá', 'Čistá']], // Skrátené hlavičky
         body: tableData,
         startY: 40, // Začíname nižšie
         theme: 'grid',
         headStyles: { fillColor: [41, 128, 185], textColor: 255, font: 'Roboto', fontStyle: 'bold', fontSize: 9 },
         styles: { font: 'Roboto', fontSize: 8, cellPadding: 1.5 }, // Menšie písmo a padding
         alternateRowStyles: { fillColor: [240, 240, 240] },
         columnStyles: { // Úprava šírok stĺpcov
             0: { cellWidth: 25 }, // Deň
             1: { cellWidth: 18, halign: 'center' }, // Príchod
             2: { cellWidth: 18, halign: 'center' }, // Odchod
             3: { cellWidth: 15, halign: 'right' }, // Prest.
             4: { cellWidth: 15, halign: 'right' }, // Hod.
             5: { cellWidth: 20, halign: 'right' }, // Hrubá
             6: { cellWidth: 20, halign: 'right' }  // Čistá
         },
         // Pridanie riadku so súčtami do päty tabuľky
         didDrawPage: (data) => {
             // Footer - Súčty
             const finalY = doc.lastAutoTable.finalY || data.cursor.y;
             doc.setFontSize(9);
             doc.setFont('Roboto', 'bold');
             const totalHoursSum = Math.floor(pdfTotalMinutes / 60);
             const totalMinutesSum = pdfTotalMinutes % 60;
             const totalDecimalHoursSum = pdfTotalMinutes / 60;

             const summaryLine1 = `CELKOM: ${totalHoursSum}h ${totalMinutesSum}m (${totalDecimalHoursSum.toFixed(decimalPlaces)} hod) | Hrubá: ${pdfTotalGross.toFixed(decimalPlaces)} € | Čistá: ${pdfTotalNet.toFixed(decimalPlaces)} €`;
             doc.text(summaryLine1, data.settings.margin.left, finalY + 5);

              // Pridanie dátumu generovania
              const generatedDate = new Date().toLocaleDateString('sk-SK', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'});
              doc.setFontSize(8);
              doc.setFont('Roboto', 'normal');
              doc.text(`Vygenerované: ${generatedDate}`, data.settings.margin.left, finalY + 10);
         }
       });

       // Uloženie PDF
       const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-z0-9]/gi, '_').toLowerCase();
       doc.save(`vykaz-${safeEmployeeName}-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.pdf`);
     }


    function sendPDF() {
       // Kontrola načítania knižníc
       if (!window.jspdf || !window.jspdf.jsPDF) {
         alert("Knižnica jsPDF nie je načítaná.");
         return;
       }
        if (typeof window.jspdf.jsPDF.API.autoTable !== 'function') {
           alert("Funkcia autoTable (jspdf-autotable) nie je načítaná.");
           return;
        }

       const { jsPDF } = window.jspdf;
       const doc = new jsPDF();

       try {
           doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
           doc.setFont('Roboto', 'normal');
       } catch (e) {
           console.error("Chyba pri pridávaní alebo nastavovaní fontu Roboto:", e);
           alert("Nastala chyba pri príprave fontu pre PDF. Diakritika nemusí byť zobrazená správne.");
           doc.setFont('Helvetica', 'normal');
       }

        doc.setFontSize(18);
        doc.text(`Výkaz práce - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
        doc.setFontSize(11);
        doc.text(`Pracovník: ${employeeName || 'Nezadané'}`, 14, 28);
        doc.text(`Hodinová mzda: ${hourlyWage.toFixed(decimalPlaces)} €`, 100, 28);
        doc.text(`Sadzba dane: ${(taxRate * 100).toFixed(1)} %`, 14, 34);


       const tableData = [];
       let pdfTotalMinutes = 0;
       let pdfTotalGross = 0;
       let pdfTotalNet = 0;
       const daysInMonth = getDaysInMonth(currentMonth);
        for (let i = 1; i <= daysInMonth; i++) {
           const rowIdPrefix = `${currentYear}-${currentMonth}-${i}`;
           const dayName = getDayName(currentYear, currentMonth, i);
           const start = document.getElementById(`start-${rowIdPrefix}`)?.value || '';
           const end = document.getElementById(`end-${rowIdPrefix}`)?.value || '';
           const breakTimeInput = document.getElementById(`break-${rowIdPrefix}`);
           const breakTimeValue = breakTimeInput ? (parseFloat(breakTimeInput.value) || 0) : 0;
           const totalCell = document.getElementById(`total-${rowIdPrefix}`);
           const totalText = totalCell?.textContent || '';
           const totalMatch = totalText.match(/\(([\d.,]+) h\)/);
           const decimalHours = totalMatch ? parseFloat(totalMatch[1].replace(',', '.')) : 0;

           const timeMatch = totalText.match(/(\d+)h (\d+)m/);
           const currentMins = timeMatch ? (parseInt(timeMatch[1])*60 + parseInt(timeMatch[2])) : 0;

           const gross = parseFloat(document.getElementById(`gross-${rowIdPrefix}`)?.value) || 0;
           const net = parseFloat(document.getElementById(`net-${rowIdPrefix}`)?.value) || 0;

           if ((start || end) && decimalHours > 0) {
              pdfTotalMinutes += currentMins;
              pdfTotalGross += gross;
              pdfTotalNet += net;
              tableData.push([
                `${i}. ${dayName}`,
                start, end,
                breakTimeValue > 0 ? breakTimeValue.toFixed(1) : '',
                decimalHours.toFixed(decimalPlaces),
                gross.toFixed(decimalPlaces),
                net.toFixed(decimalPlaces)
              ]);
           }
        }

       doc.autoTable({
         head: [['Deň', 'Príchod', 'Odchod', 'Prest.', 'Hod.', 'Hrubá', 'Čistá']],
         body: tableData,
         startY: 40,
         theme: 'grid',
         headStyles: { fillColor: [41, 128, 185], textColor: 255, font: 'Roboto', fontStyle: 'bold', fontSize: 9 },
         styles: { font: 'Roboto', fontSize: 8, cellPadding: 1.5 },
         alternateRowStyles: { fillColor: [240, 240, 240] },
         columnStyles: {
             0: { cellWidth: 25 }, 1: { cellWidth: 18, halign: 'center' }, 2: { cellWidth: 18, halign: 'center' },
             3: { cellWidth: 15, halign: 'right' }, 4: { cellWidth: 15, halign: 'right' },
             5: { cellWidth: 20, halign: 'right' }, 6: { cellWidth: 20, halign: 'right' }
         },
          didDrawPage: (data) => {
              const finalY = doc.lastAutoTable.finalY || data.cursor.y;
              doc.setFontSize(9);
              doc.setFont('Roboto', 'bold');
              const totalHoursSum = Math.floor(pdfTotalMinutes / 60);
              const totalMinutesSum = pdfTotalMinutes % 60;
              const totalDecimalHoursSum = pdfTotalMinutes / 60;
              const summaryLine1 = `CELKOM: ${totalHoursSum}h ${totalMinutesSum}m (${totalDecimalHoursSum.toFixed(decimalPlaces)} hod) | Hrubá: ${pdfTotalGross.toFixed(decimalPlaces)} € | Čistá: ${pdfTotalNet.toFixed(decimalPlaces)} €`;
              doc.text(summaryLine1, data.settings.margin.left, finalY + 5);
              const generatedDate = new Date().toLocaleDateString('sk-SK', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'});
              doc.setFontSize(8);
              doc.setFont('Roboto', 'normal');
              doc.text(`Vygenerované: ${generatedDate}`, data.settings.margin.left, finalY + 10);
          }
       });

       // Vytvorenie Blob a File objektu pre zdieľanie
       const pdfBlob = doc.output('blob');
       const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-z0-9]/gi, '_').toLowerCase();
       const pdfFileName = `vykaz-${safeEmployeeName}-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}.pdf`;
       const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

       // Pokus o zdieľanie cez Web Share API
       if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
         navigator.share({
           files: [pdfFile],
           title: `Výkaz ${employeeName || 'pracovník'} - ${getMonthName(currentMonth)} ${currentYear}`,
           text: `V prílohe posielam výkaz práce za ${getMonthName(currentMonth)} ${currentYear}.`
         }).then(() => console.log('PDF úspešne zdieľané'))
           .catch(error => {
               if (error.name !== 'AbortError') {
                  console.error('Chyba pri zdieľaní:', error);
                  alert("Nepodarilo sa zdieľať súbor. Chyba: " + error.message);
               } else {
                  console.log("Zdieľanie zrušené používateľom.");
               }
           });
       } else {
         // Fallback - stiahnutie súboru
         console.log("Web Share API nie je podporované alebo nemôže zdieľať súbory. Súbor sa stiahne.");
         const url = URL.createObjectURL(pdfBlob);
         const a = document.createElement('a');
         a.href = url;
         a.download = pdfFileName;
         document.body.appendChild(a);
         a.click();
         document.body.removeChild(a);
         URL.revokeObjectURL(url);
         alert("Zdieľanie nie je podporované. Súbor bol stiahnutý.");
       }
     }


    // -----------------------
    // 8) Ostatné nastavenia
    // -----------------------
    function changeDecimalPlaces() {
      const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
      if (!isNaN(newDecimalPlaces) && (newDecimalPlaces === 1 || newDecimalPlaces === 2)) {
          decimalPlaces = newDecimalPlaces;
          localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
          // Prepočítame všetky riadky a celkové sumy s novým počtom miest
          const daysInMonth = getDaysInMonth(currentMonth);
          for (let i = 1; i <= daysInMonth; i++) {
              calculateRow(i);
          }
          calculateAndUpdateTotals();
      } else {
          // Vrátime pôvodnú hodnotu, ak je neplatná
          decimalPlacesSelect.value = decimalPlaces;
      }
    }

    function updateEmployeeName() {
      employeeName = employeeNameInput.value.trim();
      localStorage.setItem('employeeName', JSON.stringify(employeeName));
      debouncedSaveToLocalStorage(); // Uložíme len meno (resp. celé dáta s oneskorením)
    }

    function updateSettings() {
        const newHourlyWage = parseFloat(hourlyWageInput.value);
        const newTaxRatePercent = parseFloat(taxRateInput.value);
        let changed = false;

        if (!isNaN(newHourlyWage) && newHourlyWage >= 0 && newHourlyWage !== hourlyWage) {
            hourlyWage = newHourlyWage;
            localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
            changed = true;
        } else if (isNaN(newHourlyWage) || newHourlyWage < 0) {
            hourlyWageInput.value = hourlyWage; // Vrátime platnú hodnotu
        }

        if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0) {
            const newTaxRate = newTaxRatePercent / 100;
            if (newTaxRate !== taxRate) {
                taxRate = newTaxRate;
                localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); // Ukladáme %
                changed = true;
            }
        } else if (isNaN(newTaxRatePercent) || newTaxRatePercent < 0) {
            taxRateInput.value = taxRate * 100; // Vrátime platnú hodnotu
        }

        // Ak sa niečo zmenilo, prepočítame a uložíme
        if (changed) {
            const daysInMonth = getDaysInMonth(currentMonth);
            for (let i = 1; i <= daysInMonth; i++) {
                calculateRow(i);
            }
            calculateAndUpdateTotals(); // Prepočítať celkom a naplánovať uloženie
        }
    }


    function changeMonth() {
      // Uložíme aktuálny stav pred zmenou mesiaca
       saveToLocalStorage(); // Okamžité uloženie aktuálneho mesiaca

      currentMonth = parseInt(monthSelect.value);
      console.log(`Zmena mesiaca na: ${getMonthName(currentMonth)} (${currentMonth})`);
      // Nastavíme flag, že dáta pre nový mesiac ešte nie sú načítané
      if (calculatorContainer) calculatorContainer.setAttribute('data-loaded', 'false');
      // Načítame dáta pre nový mesiac/rok
      loadFromFirebase();
    }

    function changeYear() {
        // Uložíme aktuálny stav pred zmenou roka
        saveToLocalStorage(); // Okamžité uloženie aktuálneho mesiaca/roka

        currentYear = parseInt(yearSelect.value);
        console.log(`Zmena roku na: ${currentYear}`);
        // Nastavíme flag, že dáta pre nový rok ešte nie sú načítané
        if (calculatorContainer) calculatorContainer.setAttribute('data-loaded', 'false');
        // Načítame dáta pre nový mesiac/rok
        loadFromFirebase();
    }

    function getDaysInMonth(month) {
        // Zabezpečíme, aby currentYear a month mali platné hodnoty
        const year = currentYear || new Date().getFullYear();
        // Ak je mesiac neplatný, vrátime 0 alebo default (napr. 31)
        if (typeof month === 'undefined' || month < 0 || month > 11) {
            console.error("Neplatný mesiac v getDaysInMonth:", month);
            return 31; // Alebo vrátiť 0 a riešiť v cykle
        }
        return new Date(year, month + 1, 0).getDate();
    }


    function getMonthName(month) {
      const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      if (month >= 0 && month < monthNames.length) {
          return monthNames[month];
      }
      return "Neznámy";
    }


    function updateDataSize() {
        if (!dataSizeText || !dataSizeFill) return; // Ak elementy neexistujú
        try {
            let totalBytes = 0;
            // Zahrnieme len relevantné dáta pre odhad veľkosti
            const keysToEstimate = ['workDaysData', 'hourlyWage', 'taxRate', 'darkMode', 'decimalPlaces', 'employeeName'];
            keysToEstimate.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                     // Približný odhad: dĺžka stringu * 2 bajty (pre UTF-16)
                    totalBytes += value.length * 2;
                }
            });

            const kilobytes = (totalBytes / 1024).toFixed(2);
            const percentageUsed = Math.min(((totalBytes / MAX_DATA_SIZE) * 100), 100);

            dataSizeText.textContent = `Lokálne úložisko: ${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
            dataSizeFill.style.width = `${percentageUsed.toFixed(2)}%`;

            if (percentageUsed > 90) dataSizeFill.style.backgroundColor = '#f44336';
            else if (percentageUsed > 70) dataSizeFill.style.backgroundColor = '#ff9800';
            else dataSizeFill.style.backgroundColor = '#4CAF50';
        } catch (error) {
            console.error("Chyba pri výpočte veľkosti lokálnych dát:", error);
            dataSizeText.textContent = "Chyba pri odhade veľkosti dát.";
            dataSizeFill.style.width = `0%`;
        }
    }

    function toggleDarkMode() {
        const isDarkMode = !bodyElement.classList.contains('dark-mode');
        applyDarkModeGlobally(isDarkMode); // Aplikuje zmenu na všetky relevantné elementy
        localStorage.setItem('darkMode', JSON.stringify(isDarkMode)); // Uložíme stav
        debouncedSaveToLocalStorage(); // Naplánujeme uloženie do Firebase
    }


    // -----------------------
    // 9) Zálohovanie a obnova
    // -----------------------
     function createBackup() {
       try {
         // Zahrnieme všetky relevantné localStorage položky do zálohy
         const backupData = {};
         const keysToBackup = ['workDaysData', 'hourlyWage', 'taxRate', 'darkMode', 'decimalPlaces', 'employeeName'];
         keysToBackup.forEach(key => {
             backupData[key] = localStorage.getItem(key);
         });

         // Odstránime null hodnoty (ak by nejaký kľúč neexistoval v LS)
         Object.keys(backupData).forEach(key => {
             if (backupData[key] === null) {
                 delete backupData[key];
             }
         });

         const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
         const url = URL.createObjectURL(blob);
         const a = document.createElement('a');
         a.href = url;
         const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
         const safeEmployeeName = (employeeName || 'global').replace(/[^a-z0-9]/gi, '_').toLowerCase();
         a.download = `bruno-calc-zaloha-${safeEmployeeName}-${timestamp}.json`;
         document.body.appendChild(a);
         a.click();
         document.body.removeChild(a);
         URL.revokeObjectURL(url);
         alert("Záloha lokálnych dát bola vytvorená.");
       } catch (error) {
           console.error("Chyba pri vytváraní zálohy:", error);
           alert("Nastala chyba pri vytváraní zálohy: " + error.message);
       }
     }

    function restoreBackup() {
       const fileInput = document.createElement('input');
       fileInput.type = 'file';
       fileInput.accept = '.json,application/json';
       fileInput.onchange = (event) => {
         const file = event.target.files[0];
         if (!file) return;
         if (file.type !== 'application/json') {
             alert("Nesprávny typ súboru. Vyberte prosím súbor JSON (.json).");
             return;
         }

         const reader = new FileReader();
         reader.onload = (e) => {
           try {
             const backup = JSON.parse(e.target.result);
             const expectedKeys = ['workDaysData', 'hourlyWage', 'taxRate', 'darkMode', 'decimalPlaces', 'employeeName'];
             const actualKeys = Object.keys(backup);

             // Jednoduchá kontrola, či súbor vyzerá ako naša záloha
             if (!expectedKeys.some(key => actualKeys.includes(key))) {
                 throw new Error("Súbor nevyzerá ako platná záloha tejto aplikácie.");
             }

             // Uložíme dáta zo zálohy do localStorage
             let restoredSomething = false;
             expectedKeys.forEach(key => {
                  if (backup[key] !== undefined) { // Ukladáme len kľúče, ktoré sú v zálohe
                      localStorage.setItem(key, backup[key]);
                      restoredSomething = true;
                  }
             });

             if (!restoredSomething) {
                 throw new Error("V zálohe sa nenašli žiadne platné dáta na obnovu.");
             }

             // Po úspešnom načítaní zálohy do localStorage znovu načítame dáta do aplikácie
             console.log("Záloha načítaná do localStorage, obnovujem stav aplikácie...");
             loadFromLocalStorage(); // Táto funkcia aktualizuje UI

             alert("Záloha bola úspešne obnovená.");

             // Po úspešnej obnove synchronizujeme stav s Firebase
             // saveToFirebase(); // saveToLocalStorage už volá saveToFirebase
             saveToLocalStorage();


           } catch (error) {
             console.error("Chyba pri spracovaní zálohy:", error);
             alert("Chyba pri obnove zálohy: " + error.message);
           }
         };
         reader.onerror = (error) => {
             console.error("Chyba pri čítaní súboru:", error);
             alert("Nepodarilo sa prečítať súbor zálohy.");
         };
         reader.readAsText(file, 'UTF-8');
       };
       fileInput.click();
     }

    // -----------------------
    // 10) Inicializácia
    // -----------------------
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM načítaný, prebieha inicializácia UI...");

      // Najprv nastavíme rok a mesiac pre selectboxy
      populateYearSelect(); // Naplníme roky
      const currentDate = new Date();
      // Skúsime načítať posledne zvolený rok/mesiac z LS, inak aktuálny
      currentYear = parseInt(localStorage.getItem('lastYear')) || currentDate.getFullYear();
      currentMonth = parseInt(localStorage.getItem('lastMonth')) || currentDate.getMonth();

       // Overíme, či načítaný rok je v rozsahu selectu, ak nie, použijeme aktuálny
      const yearOptions = Array.from(yearSelect.options).map(opt => parseInt(opt.value));
      if (!yearOptions.includes(currentYear)) {
          currentYear = currentDate.getFullYear();
          localStorage.setItem('lastYear', currentYear); // Uložíme aktuálny ako posledný
      }

      // Nastavíme selectboxy
      yearSelect.value = currentYear;
      monthSelect.value = currentMonth;

      // Načítanie ostatných nastavení z LS alebo default
      // Tieto hodnoty sa môžu prepísať pri načítaní z Firebase/LS v onAuthStateChanged -> load...
      decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces') || '1'));
      employeeName = JSON.parse(localStorage.getItem('employeeName') || '""');
      hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage') || '10'));
      taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate') || '2')) / 100;
      const darkMode = JSON.parse(localStorage.getItem('darkMode') || 'false');

      // Nastavenie hodnôt v UI (predbežné, môže sa prepísať)
      decimalPlacesSelect.value = decimalPlaces;
      employeeNameInput.value = employeeName;
      hourlyWageInput.value = hourlyWage;
      taxRateInput.value = taxRate * 100;

      // Aplikujeme tmavý režim (predbežne)
      applyDarkModeGlobally(darkMode);

      // Pridanie listenerov na uloženie posledného mesiaca/roka pri zmene
       monthSelect.addEventListener('change', () => localStorage.setItem('lastMonth', monthSelect.value));
       yearSelect.addEventListener('change', () => localStorage.setItem('lastYear', yearSelect.value));


      // Výpočet veľkosti dát a celkových súm sa udeje až po načítaní dát v onAuthStateChanged
      console.log("Inicializácia UI dokončená. Čaká sa na stav autentifikácie pre načítanie dát.");
    });

    function populateYearSelect() {
      const currentYearValue = new Date().getFullYear();
      const startYear = currentYearValue - 5; // 5 rokov dozadu
      const endYear = currentYearValue + 5;   // 5 rokov dopredu
      if (!yearSelect) return;
      yearSelect.innerHTML = '';
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
    }

  </script>
</body>
</html>
