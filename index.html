<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* CSS ≈°t√Ωly zost√°vaj√∫ rovnak√© */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start; /* Zmenen√© na flex-start pre lep≈°ie zarovnanie s details */
        gap: 10px; /* Pridan√Ω gap pre medzery */
    }
    /* Priame deti .settings (div, details, button) */
    .settings > div,
    .settings > details,
    .settings > button {
        flex: 1 1 200px; /* Zachovanie flex basis */
        margin: 0; /* Odstr√°nen√Ω margin, pou≈æ√≠vame gap */
    }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 900px; /* Mierne zv√§ƒç≈°en√° min-width kv√¥li nov√©mu stƒ∫pcu */ }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; /* Zarovnaj obsah buniek hore */ }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea /* Pridan√Ω select a .note-textarea */ {
        width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px;
    }
    /* Uprav ≈°√≠rky stƒ∫pcov podƒæa potreby */
    th:nth-child(1), td:nth-child(1) { min-width: 50px; } /* De≈à */
    th:nth-child(2), td:nth-child(2) { min-width: 80px; } /* Pr√≠chod */
    th:nth-child(3), td:nth-child(3) { min-width: 80px; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* Prest√°vka */
    th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* Odpracovan√© */
    th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* Hrub√° Mzda */
    th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* ƒåist√° Mzda */
    th:nth-child(8), td:nth-child(8) { min-width: 120px; } /* Pozn√°mka - nov√Ω stƒ∫pec */
    th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia - posledn√Ω stƒ∫pec */

    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input, .current-day .note-textarea /* Pridan√© .note-textarea pre current-day */ { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode /* Pridan√Ω select a .note-textarea */ {
        background-color: #666; color: white; border-color: #888; /* Pridan√° farba okraja pre dark mode */
    }
    .btn.dark-mode { color: #333; }
    .reset-btn.dark-mode { background-color: #d32f2f; }
    .export-btn.dark-mode { background-color: #388e3c; }
    .restore-btn.dark-mode { background-color: #7B1FA2; }
    .backup-btn.dark-mode { background-color: #E68900; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input, .current-day.dark-mode .note-textarea /* Pridan√© .note-textarea pre current-day dark mode */ { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
    #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
    #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }

    /* --- ≈†T√ùLY PRE ZBALITEƒΩN√ö ƒåAS≈§ (nezmenen√©) --- */
    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
    .collapsible-settings summary:hover { background-color: #eee; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
    body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
    body.dark-mode .collapsible-content { border-top-color: #666; }

    /* --- NOV√â ≈†T√ùLY PRE POZN√ÅMKY --- */
    .note-container {
        display: none; /* ≈†tandardne skryt√© */
        margin-top: 5px;
    }
    .note-container.visible {
        display: block; /* Zobrazen√© po kliknut√≠ */
    }
    .note-textarea {
        width: 95%; /* Trochu men≈°ia ≈°√≠rka kv√¥li paddingu bunky */
        min-height: 40px; /* Minim√°lna v√Ω≈°ka */
        resize: vertical; /* Povoli≈• len vertik√°lnu zmenu veƒækosti */
        box-sizing: border-box;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 13px; /* Trochu men≈°ie p√≠smo pre pozn√°mky */
        background-color: #f0f0f0; /* Svetl√© pozadie pre odl√≠≈°enie */
        /* Dedi vlastnosti z nadraden√©ho pravidla pre inputy */
    }
    .toggle-note-btn {
        background-color: #6c757d; /* ≈†ed√° farba */
        color: white;
        padding: 3px 8px; /* Men≈°√≠ padding */
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px; /* Men≈°ie p√≠smo */
        transition: background-color 0.2s ease;
        margin-bottom: 2px; /* Mal√Ω odstup od textarea, ak je viditeƒæn√° */
    }
    .toggle-note-btn:hover {
        background-color: #5a6268;
    }
    /* Dark mode pre pozn√°mky */
    .note-textarea.dark-mode {
        background-color: #555;
        color: #f4f4f4;
        border-color: #777;
    }
    .toggle-note-btn.dark-mode {
        background-color: #828a91;
    }
    .toggle-note-btn.dark-mode:hover {
        background-color: #70777d;
    }
    /* --- KONIEC NOV√ùCH ≈†T√ùLOV PRE POZN√ÅMKY --- */

  </style>
</head>
<body>
  <div id="loading-container"><h1> Tajomstvo √∫spechu je slu≈°nos≈• a √∫primnos≈•. Akon√°hle sa ich zbav√≠te, dosiahnete v≈°etko. </h1></div>
  <div id="auth-container" style="display:none;">
    <h1>Prihl√°senie / Registr√°cia</h1>
    <div id="auth-message">≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.</div>
    <div id="auth-forms">
      <h2>Registr√°cia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrova≈•</button>
      <h2>Prihl√°senie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihl√°si≈• sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2> <div class="settings">
        <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
                <option value="0">Janu√°r</option>
                <option value="1">Febru√°r</option>
                <option value="2">Marec</option>
                <option value="3">Apr√≠l</option>
                <option value="4">M√°j</option>
                <option value="5">J√∫n</option>
                <option value="6">J√∫l</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">Okt√≥ber</option>
                <option value="10">November</option>
                <option value="11">December</option>
            </select>
        </div>

        <details class="collapsible-settings">
            <summary>ƒéal≈°ie nastavenia</summary>
            <div class="collapsible-content">
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka: </label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
                    <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%): </label>
                    <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="yearSelect">Rok: </label>
                    <select id="yearSelect" onchange="changeYear()"></select>
                </div>
                <div>
                    <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
                    <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>
            </div>
        </details>

        <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th class="th-note">Pozn√°mka</th> <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lok√°lne √∫lo≈æisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetova≈• v≈°etko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈•</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
      <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
    </div>
  </div>
  <div id="saveNotification"></div>

  <script>
    // 1. Firebase Config & Init - Nezmenen√©
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktiv√°cii Firebase App Check:", error); }
    const db = firebase.firestore(); const auth = firebase.auth();

    // 2. Povolenie Firestore Offline Persistence - Nezmenen√©
    db.enablePersistence().then(() => { console.log("Firestore offline persistence povolen√°."); }).catch((err) => { console.error("Firestore offline persistence chyba:", err.code, err.message, err); if (err.code == 'failed-precondition') { console.warn("Firestore offline persistence: Viacn√°sobn√© otvoren√© taby, povolen√© len v jednom."); } else if (err.code == 'unimplemented') { console.error("Firestore offline persistence: Prehliadaƒç nie je podporovan√Ω."); } });

    // 3. Glob√°lne premenn√© - Nezmenen√©
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate; let monthData = {}; let firestoreListenerUnsubscribe = null;
    const workDays = document.getElementById('workDays'); const totalSalaryDiv = document.getElementById('totalSalary'); const dataSizeText = document.getElementById('dataSizeText'); const dataSizeFill = document.getElementById('dataSizeFill'); const hourlyWageInput = document.getElementById('hourlyWageInput'); const taxRateInput = document.getElementById('taxRateInput'); const monthSelect = document.getElementById('monthSelect'); const yearSelect = document.getElementById('yearSelect'); const decimalPlacesSelect = document.getElementById('decimalPlacesSelect'); const employeeNameInput = document.getElementById('employeeNameInput'); const MAX_DATA_SIZE = 4 * 1024 * 1024; const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // 4. Auth funkcie (Register, Login, Logout, Forgot Password) - Nezmenen√©
    function register() { const email = document.getElementById('registerEmail').value; const password = document.getElementById('registerPassword').value; auth.createUserWithEmailAndPassword(email, password).then((userCredential) => { console.log("Registrovan√Ω:", userCredential.user); alert("Registr√°cia √∫spe≈°n√°!"); }).catch((error) => { console.error("Chyba pri registr√°cii:", error.message); alert("Chyba pri registr√°cii: " + error.message); }); }
    function login() { const email = document.getElementById('loginEmail').value; const password = document.getElementById('loginPassword').value; auth.signInWithEmailAndPassword(email, password).then((userCredential) => { console.log("Prihl√°sen√Ω:", userCredential.user); alert("Prihl√°senie √∫spe≈°n√©!"); }).catch((error) => { console.error("Chyba pri prihl√°sen√≠:", error.message); alert("Chyba pri prihl√°sen√≠: " + error.message); }); }
    function logout() { auth.signOut().then(() => { console.log("Odhl√°sen√Ω."); alert("Odhl√°senie √∫spe≈°n√©!"); }).catch((error) => { console.error("Chyba pri odhl√°sen√≠:", error.message); alert("Chyba pri odhl√°sen√≠: " + error.message); }); }
    function forgotPassword() {
      const emailInput = document.getElementById('loginEmail');
      const email = emailInput.value;
      if (!email) {
        alert("Pros√≠m, zadajte svoju e-mailov√∫ adresu do poƒæa pre prihl√°senie.");
        emailInput.focus();
        return;
      }
      auth.sendPasswordResetEmail(email)
        .then(() => {
          console.log("E-mail na obnovenie hesla odoslan√Ω na:", email);
          alert("Odkaz na obnovenie hesla bol odoslan√Ω na va≈°u e-mailov√∫ adresu. Skontrolujte si pros√≠m po≈°tu (aj prieƒçinok Spam).");
        })
        .catch((error) => {
          console.error("Chyba pri odosielan√≠ e-mailu na obnovenie hesla:", error);
          alert("Chyba pri odosielan√≠ e-mailu na obnovenie hesla: " + error.message);
        });
    }

    // 5. Auth State Change Listener - Nezmenen√©
    auth.onAuthStateChanged(user => {
        console.log("onAuthStateChanged: Stav zisten√Ω.", user ? `Pou≈æ√≠vateƒæ: ${user.email}` : "≈Ωiadny pou≈æ√≠vateƒæ.");
        const authContainer = document.getElementById('auth-container');
        const calculatorContainer = document.getElementById('calculator-container');
        const loadingContainer = document.getElementById('loading-container');
        if (loadingContainer) loadingContainer.classList.add('hidden');

        if (firestoreListenerUnsubscribe) {
            console.log("Odhlasujem predch√°dzaj√∫ci Firestore listener pri zmene Auth stavu.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        if (user) {
            document.getElementById('auth-message').textContent = "Prihl√°sen√Ω: " + user.email;
            authContainer.style.display = "none";
            calculatorContainer.style.display = "block";
            console.log("Pou≈æ√≠vateƒæ prihl√°sen√Ω, nastavujem UI a listener...");

            const storedMonth = localStorage.getItem('currentMonth'); const storedYear = localStorage.getItem('currentYear');
            const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false; const currentDate = new Date();
            currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
            currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
            monthSelect.value = currentMonth;
            if (yearSelect.querySelector(`option[value="${currentYear}"]`)) { yearSelect.value = currentYear; }
            else { console.warn(`Rok ${currentYear} z localStorage nen√°jden√Ω v selecte, pou≈æ√≠vam aktu√°lny rok.`); currentYear = currentDate.getFullYear(); populateYearSelect(); yearSelect.value = currentYear; }
            applyDarkMode(darkMode);
            hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10; taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02; decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1; employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
            hourlyWageInput.value = hourlyWage; taxRateInput.value = taxRate * 100; decimalPlacesSelect.value = decimalPlaces; employeeNameInput.value = employeeName;

            console.log("onAuthStateChanged: Prv√© volanie loadFromLocalStorage...");
            loadFromLocalStorage(); // Prv√© naƒç√≠tanie a vykreslenie

            setupFirestoreListener(); // Nastavenie listenera

            const uid = user.uid; const userDocRef = db.collection("users").doc(uid);
            userDocRef.get().then(userDocSnap => { if (!userDocSnap.exists) { userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true }).then(() => console.log("Vytvoren√Ω/aktualizovan√Ω dokument pre:", uid)).catch(err => console.error("Chyba pri vytv√°ran√≠/aktualiz√°cii dokumentu pou≈æ√≠vateƒæa:", err)); } else { console.log("Dokument pou≈æ√≠vateƒæa existuje:", uid); } }).catch(err => { console.error("Chyba pri kontrole dokumentu pou≈æ√≠vateƒæa (userDocRef.get):", err); showSaveNotification("Chyba pri overovan√≠ pou≈æ√≠vateƒæsk√Ωch d√°t", "error"); });

            setTimeout(() => {
                 if (auth.currentUser && !navigator.onLine) {
                     console.log("onAuthStateChanged (setTimeout): Vyn√∫ten√© druh√© volanie loadFromLocalStorage (offline)...");
                     loadFromLocalStorage();
                 } else if (auth.currentUser && navigator.onLine) {
                     console.log("onAuthStateChanged (setTimeout): Online, druh√© volanie loadFromLocalStorage preskoƒçen√©.");
                 }
            }, 150);

        } else {
            document.getElementById('auth-message').textContent = "≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.";
            authContainer.style.display = "block";
            calculatorContainer.style.display = "none";
            console.log("Pou≈æ√≠vateƒæ odhl√°sen√Ω/neprihl√°sen√Ω.");
            monthData = {}; workDays.innerHTML = ''; totalSalaryDiv.innerHTML = '';
            updateWelcomeMessage(); // Zabezpeƒç√≠ skrytie pozdravu pri odhl√°sen√≠
        }
    });

    // 6. Utility funkcie (debounce, showSaveNotification, getFirstName, updateWelcomeMessage) - Nezmenen√©
    function debounce(func, wait) { let timeout; return function (...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), wait); }; }
    function showSaveNotification(message, type = 'success') { const notification = document.getElementById('saveNotification'); notification.textContent = message; notification.className = 'show'; if (type === 'error') { notification.classList.add('error'); } else if (type === 'warning') { notification.classList.add('warning'); } notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 3000); }
    function getFirstName(fullName) { if (!fullName || typeof fullName !== 'string') { return ''; } const trimmedName = fullName.trim(); if (!trimmedName) { return ''; } const parts = trimmedName.split(' '); return parts[0]; }
    function updateWelcomeMessage() { const welcomeElement = document.getElementById('welcomeMessage'); if (!welcomeElement) return; const firstName = getFirstName(employeeName); if (firstName) { welcomeElement.textContent = `Vitaj sp√§≈•, ${firstName}! üëã`; } else { welcomeElement.textContent = ''; } }

    // 7. Funkcia na nastavenie Firestore Listenera - **S LOGOVAN√çM**
    function setupFirestoreListener() {
        if (firestoreListenerUnsubscribe) { console.log("Odhlasujem predch√°dzaj√∫ci Firestore listener."); firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; }
        const uid = auth.currentUser?.uid; if (!uid) { console.log("setupFirestoreListener: Nikto nie je prihl√°sen√Ω."); return; }
        if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) { const now = new Date(); currentMonth = currentMonth ?? now.getMonth(); currentYear = currentYear ?? now.getFullYear(); console.warn("setupFirestoreListener: Ch√Ωba mesiac/rok."); }
        const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`; const docRef = db.doc(docPath);
        console.log(`setupFirestoreListener: Nastavujem listener pre ${docPath}`);

        firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
            // --- ZAƒåIATOK ROZ≈†√çREN√âHO LOGOVANIA ---
            const source = docSnap.metadata.fromCache ? 'Cache' : 'Server';
            const hasPending = docSnap.metadata.hasPendingWrites;
            const activeElementId = document.activeElement?.id; // Z√≠skaj ID akt√≠vneho elementu
            // Pou≈æi groupCollapsed pre prehƒæadnos≈•, rozklikni ak treba
            console.groupCollapsed(
                `%cFirestore Snapshot Received%c @ ${new Date().toLocaleTimeString()} %c| Path: ${docPath} | Source: ${source} | PendingWrites: ${hasPending}`,
                'color: #2e8b57; font-weight: bold;', // Zelen√° farba pre n√°zov
                'color: grey; font-weight: normal;',   // Siv√° pre ƒças
                'color: black; font-weight: normal;'   // ƒåierna pre detaily
            );
            console.log("Active Element ID:", activeElementId || 'None'); // Vyp√≠≈° ID akt√≠vneho elementu
            console.log("Document Exists:", docSnap.exists);
            if(docSnap.exists) {
                // Loguj d√°ta ako string pre jednoduch√© porovnanie (alebo ako objekt ak preferuje≈°)
                try {
                     console.log("Received Data:", JSON.stringify(docSnap.data()));
                } catch (e) {
                     console.log("Received Data (non-serializable):", docSnap.data());
                }

            }
            // --- KONIEC ROZ≈†√çREN√âHO LOGOVANIA ---


            // console.log(`Firestore listener: Prijat√Ω snapshot pre ${docPath}. Metadata:`, docSnap.metadata); // P√¥vodn√Ω log m√¥≈æeme necha≈• alebo zakomentova≈•
            const isLocalWrite = docSnap.metadata.hasPendingWrites; // hasPendingWrites je spoƒæahlivej≈°ie

            if (isLocalWrite) {
                console.log("%cListener: Detekovan√° lok√°lna zmena (hasPendingWrites=true). Ignorujem d√°ta zo snapshotu pre UI update.", "color: purple;");
                // Spracuj lok√°lny z√°pis ako predt√Ωm, ale neaktualizuj inputy
                 if (docSnap.exists) {
                    const data = docSnap.data(); const firebaseDaysData = data.days || [];
                    if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                    // Ulo≈æenie do monthData aj s pozn√°mkou (aj keƒè UI neaktualizujeme hneƒè)
                    monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                        start: day.start || '',
                        end: day.end || '',
                        breakTime: day.breakTime || '',
                        note: day.note || '' // <<< Pridan√© note
                    }));
                    // localStorage.setItem('workDaysData', JSON.stringify(monthData)); // Lok√°lne ukladanie rie≈°i saveToLocalStorage
                    console.log("Listener (Local Write): monthData aktualizovan√© na z√°klade lok√°lneho snapshotu.");
                } else {
                     console.log("Listener (Local Write): Dokument poƒças lok√°lneho z√°pisu neexistuje (napr. pri prvom vytvoren√≠).");
                }
                console.groupEnd(); // Zavri skupinu pre tento snapshot
                return; // D√¥le≈æit√© - ukonƒçi spracovanie tu
            }

            // Ak to nie je lok√°lny z√°pis, pokraƒçuj v spracovan√≠
            if (docSnap.exists) {
                const data = docSnap.data();
                console.log(`Listener: Dokument existuje (zdroj: ${source}). Sprac√∫vam d√°ta pre UI...`);

                try {
                    // Naƒç√≠taj nastavenia z Firebase, ale pou≈æi lok√°lne ako default ak ch√Ωbaj√∫
                    const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
                    const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
                    const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
                    const firebaseEmployeeName = data.employeeName ?? employeeName;
                    const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');
                    const firebaseDaysData = data.days || [];

                    // Aktualizuj glob√°lne premenn√© z Firebase
                    hourlyWage = firebaseHourlyWage;
                    taxRate = firebaseTaxRatePercent / 100;
                    decimalPlaces = firebaseDecimalPlaces;
                    employeeName = firebaseEmployeeName;

                    // Aktualizuj UI pre nastavenia (okrem t√Ωch, ktor√© maj√∫ fokus)
                    if (document.activeElement !== hourlyWageInput) { hourlyWageInput.value = hourlyWage; }
                    if (document.activeElement !== taxRateInput) { taxRateInput.value = taxRate * 100; }
                    decimalPlacesSelect.value = decimalPlaces; // Select nem√° probl√©m s fokusom
                    if (document.activeElement !== employeeNameInput) { employeeNameInput.value = employeeName; }

                    // Priprav monthData na z√°klade Firebase
                    if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                        start: day.start || '',
                        end: day.end || '',
                        breakTime: day.breakTime || '',
                        note: day.note || ''
                    }));
                    console.log(`Listener: monthData pre ${currentYear}-${currentMonth} aktualizovan√© z Firebase. Poƒçet dn√≠: ${monthData[currentYear][currentMonth].length}`);

                    // Ulo≈æ aktu√°lne nastavenia a d√°ta do localStorage (ako potvrdenie z Firebase)
                    localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                    localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                    localStorage.setItem('darkMode', JSON.stringify(firebaseDarkMode));
                    localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                    localStorage.setItem('employeeName', JSON.stringify(employeeName));
                    // Ukladaj workDaysData len ak sa naozaj zmenili oproti predch√°dzaj√∫cemu stavu? Zatiaƒæ uklad√°me v≈ædy.
                    localStorage.setItem('workDaysData', JSON.stringify(monthData));
                    console.log("Listener: D√°ta z Firebase ulo≈æen√© do localStorage.");


                    // --- ROZ≈†√çREN√â LOGOVANIE POƒåAS AKTUALIZ√ÅCIE UI ---
                    console.log("Listener: Kontrolujem a aktualizujem riadky tabuƒæky...");
                    const daysInMonth = getDaysInMonth(currentMonth);
                    // const currentDaysData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []; // Naƒç√≠tan√© vy≈°≈°ie

                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayIndex = i - 1;
                        // D√°ta z Firebase pre tento de≈à (u≈æ m√°me v monthData[currentYear][currentMonth])
                        const firebaseDayData = monthData[currentYear]?.[currentMonth]?.[dayIndex] || { start: '', end: '', breakTime: '', note: '' };

                        const startId = `start-${currentYear}-${currentMonth}-${i}`;
                        const endId = `end-${currentYear}-${currentMonth}-${i}`;
                        const breakId = `break-${currentYear}-${currentMonth}-${i}`;
                        const noteId = `note-${currentYear}-${currentMonth}-${i}`;

                        const startElement = document.getElementById(startId);
                        const endElement = document.getElementById(endId);
                        const breakElement = document.getElementById(breakId);
                        const noteElement = document.getElementById(noteId);

                        if (startElement && endElement && breakElement && noteElement) {
                            const newStart = firebaseDayData.start || '';
                            const newEnd = firebaseDayData.end || '';
                            const newBreak = firebaseDayData.breakTime || '';
                            const newNote = firebaseDayData.note || '';

                            // Kontrola a logovanie pre START
                            if (startElement.value !== newStart) {
                                if (activeElementId === startId) {
                                    console.warn(`%cListener: CHCEM aktualizova≈• ${startId} na "${newStart}", ALE M√Å FOKUS. Preskakujem update. (Aktu√°lna hodnota: "${startElement.value}")`, "color: red;");
                                } else {
                                    // Loguj len ak sa hodnota l√≠≈°i od toho, ƒço pri≈°lo
                                    if (startElement.value !== newStart) {
                                        console.log(`Listener: Aktualizujem ${startId} z "${startElement.value}" na "${newStart}" (Firestore)`);
                                        startElement.value = newStart;
                                    }
                                }
                            }
                             // Kontrola a logovanie pre END (podobne)
                             if (endElement.value !== newEnd) {
                                if (activeElementId === endId) {
                                    console.warn(`%cListener: CHCEM aktualizova≈• ${endId} na "${newEnd}", ALE M√Å FOKUS. Preskakujem update. (Aktu√°lna hodnota: "${endElement.value}")`, "color: red;");
                                } else {
                                     if (endElement.value !== newEnd) {
                                        console.log(`Listener: Aktualizujem ${endId} z "${endElement.value}" na "${newEnd}" (Firestore)`);
                                        endElement.value = newEnd;
                                    }
                                }
                            }
                             // Kontrola a logovanie pre BREAK (podobne)
                             // Porovn√°vame stringy, keƒè≈æe breakElement.value je string
                             if (breakElement.value !== newBreak) {
                                if (activeElementId === breakId) {
                                    console.warn(`%cListener: CHCEM aktualizova≈• ${breakId} na "${newBreak}", ALE M√Å FOKUS. Preskakujem update. (Aktu√°lna hodnota: "${breakElement.value}")`, "color: red;");
                                } else {
                                     if (breakElement.value !== newBreak) {
                                        console.log(`Listener: Aktualizujem ${breakId} z "${breakElement.value}" na "${newBreak}" (Firestore)`);
                                        breakElement.value = newBreak;
                                    }
                                }
                            }
                             // Kontrola a logovanie pre NOTE (podobne)
                             if (noteElement.value !== newNote) {
                                if (activeElementId === noteId) {
                                    console.warn(`%cListener: CHCEM aktualizova≈• ${noteId} na "${newNote.substring(0,20)}...", ALE M√Å FOKUS. Preskakujem update. (Aktu√°lna hodnota: "${noteElement.value.substring(0,20)}...")`, "color: red;");
                                } else {
                                    if (noteElement.value !== newNote) {
                                        console.log(`Listener: Aktualizujem ${noteId} z "${noteElement.value.substring(0,20)}..." na "${newNote.substring(0,20)}..." (Firestore)`);
                                        noteElement.value = newNote;
                                    }
                                }
                            }


                            // Prepoƒç√≠taj riadok PO aktualiz√°cii hodn√¥t z Firebase
                            calculateRow(i);

                        } else {
                           // console.warn(`Listener: Elementy pre de≈à ${i} neboli n√°jden√© pri aktualiz√°cii UI.`); // Odkomentuj ak treba
                        }
                    }
                     console.log("Listener: Aktualiz√°cia riadkov tabuƒæky dokonƒçen√°.");

                    // Aplikuj ostatn√© UI zmeny
                    calculateTotal();
                    applyDarkMode(firebaseDarkMode); // Pou≈æi hodnotu z Firebase
                    updateWelcomeMessage();
                    updateDataSize(); // Aktualizuj veƒækos≈• d√°t po ulo≈æen√≠

                    if (!docSnap.metadata.fromCache) {
                       console.log("%cListener: D√°ta prijat√© priamo zo SERVERA.", "font-weight: bold;");
                       showSaveNotification("D√°ta synchronizovan√©");
                    }

                } catch (processError) {
                    console.error(`%cListener: Chyba pri spracovan√≠ d√°t z Firestore pre ${currentYear}-${currentMonth}:`, 'color: red; font-weight: bold;', processError);
                    showSaveNotification("Chyba: Nespr√°vny form√°t d√°t z Firebase", "error");
                }
            } else {
                // Dokument neexistuje
                console.log(`Listener: Dokument neexistuje (zdroj: ${source}) na Firebase pre ${currentYear}-${currentMonth}. Resetujem lok√°lne d√°ta pre mesiac.`);
                 if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = []; // Resetuj d√°ta pre mesiac
                 localStorage.setItem('workDaysData', JSON.stringify(monthData)); // Ulo≈æ pr√°zdne d√°ta lok√°lne

                 // Naƒç√≠taj nastavenia z localStorage a zobraz UI (lebo z Firebase niƒç nepri≈°lo)
                 hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                 taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
                 const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                 decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
                 employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

                 hourlyWageInput.value = hourlyWage;
                 taxRateInput.value = taxRate * 100;
                 decimalPlacesSelect.value = decimalPlaces;
                 employeeNameInput.value = employeeName;

                 createTable(); // Vytvor pr√°zdnu tabuƒæku
                 calculateTotal(); // Prepoƒç√≠taj (bude nula)
                 applyDarkMode(darkMode);
                 updateWelcomeMessage();
                 updateDataSize();
            }

            console.groupEnd(); // Zavri hlavn√∫ skupinu pre tento snapshot

        }, (error) => {
            console.error(`%cFirestore listener CHYBA pre ${docPath}:`, 'color: red; font-weight: bold;', error);
            showSaveNotification("Chyba: Nepodarilo sa pripoji≈• k Firebase", "error");
            console.log("Listener chyba, naƒç√≠tavam z localStorage ako fallback...");
            loadFromLocalStorage();
            // Pr√≠padne groupEnd() aj tu, ak by chyba nastala pred koncom skupiny
             if (console.groupEnd) { console.groupEnd(); } // Bezpeƒçnostn√© ukonƒçenie skupiny v pr√≠pade chyby
        });
    }


    // 8. Funkcia na ukladanie do Firebase - **S LOGOVAN√çM**
    async function saveToFirebase() {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            console.log("saveToFirebase: Nikto nie je prihl√°sen√Ω.");
            return;
        }
        try {
            const currentMonthWorkData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            console.log(`saveToFirebase: Pripravujem d√°ta pre ${currentYear}-${currentMonth}. Poƒçet z√°znamov v poli 'days': ${currentMonthWorkData.length}.`); // Upresnen√Ω log

            const dataToSave = {
                days: currentMonthWorkData,
                hourlyWage: hourlyWage || 10,
                taxRate: (taxRate * 100) || 2,
                decimalPlaces: decimalPlaces || 1,
                employeeName: employeeName || '',
                darkMode: document.body.classList.contains('dark-mode'),
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // ServerTimestamp je ok
            };

            const yearMonthDoc = `${currentYear}-${currentMonth}`;
            const uid = currentUser.uid;
            const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);

            // ===== PRIDAN√ù LOG SEM =====
            try {
                 // Pou≈æi JSON.stringify s null a 2 pre pekn√© form√°tovanie a ƒæah≈°iu ƒçitateƒænos≈• v konzole
                 console.log('%csaveToFirebase: D√°ta pripraven√© na odoslanie do Firebase:', 'color: #3498db;', JSON.stringify(dataToSave, null, 2));
            } catch (e) {
                 console.error("Chyba pri logovan√≠ dataToSave (stringify):", e);
                 console.log('%csaveToFirebase: D√°ta pripraven√© na odoslanie (objekt):', 'color: #3498db;', dataToSave);
            }
            // ==========================

            await docRef.set(dataToSave);
            console.log(`saveToFirebase: Po≈æiadavka na ulo≈æenie d√°t pre ${yearMonthDoc} odoslan√°/zaraden√°.`);

        } catch (error) {
            console.error(`Chyba pri po≈æiadavke na ukladanie do Firebase pre ${currentYear}-${currentMonth}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa odosla≈• d√°ta do Firebase", "error");
        }
    }


    // 9. Funkcia na ukladanie do Local Storage - Nezmenen√©
    function saveToLocalStorage() { try { if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; if (!monthData[currentYear][currentMonth]) { monthData[currentYear][currentMonth] = []; console.warn(`saveToLocalStorage: Inicializovan√© pr√°zdne pole pre ${currentYear}-${currentMonth}, lebo ch√Ωbalo.`); } localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage)); localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode'))); localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces)); localStorage.setItem('employeeName', JSON.stringify(employeeName)); localStorage.setItem('currentMonth', currentMonth.toString()); localStorage.setItem('currentYear', currentYear.toString()); const serializedMonthData = JSON.stringify(monthData); const bytes = new Blob([serializedMonthData]).size; if (bytes > MAX_DATA_SIZE * 0.9) { console.warn(`Veƒækos≈• d√°t ('workDaysData') v localStorage sa bl√≠≈æi k limitu: ${bytes} bajtov`); } if (bytes > MAX_DATA_SIZE) { alert(`Prekroƒçili ste maxim√°lnu veƒækos≈• d√°t (~${MAX_DATA_SIZE_KB} KB) pre d√°ta mesiacov v localStorage. Ukladanie zlyhalo.`); showSaveNotification("Chyba: Lok√°lne d√°ta s√∫ pr√≠li≈° veƒæk√©!", "error"); return; } localStorage.setItem('workDaysData', serializedMonthData); updateDataSize(); saveToFirebase(); if (!navigator.onLine) { showSaveNotification("Offline: Zmeny ulo≈æen√© lok√°lne", "warning"); } } catch (error) { console.error('Chyba pri ukladan√≠ (lok√°lne/spusten√≠ Firebase save):', error); showSaveNotification("Kritick√° chyba pri ukladan√≠!", "error"); } }

    // 10. Funkcia na naƒç√≠tanie z Local Storage - Nezmenen√©
    function loadFromLocalStorage() { try { if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) { const storedMonth = localStorage.getItem('currentMonth'); const storedYear = localStorage.getItem('currentYear'); const currentDate = new Date(); currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth(); currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear(); console.log(`loadFromLocalStorage: Inicializujem mesiac=${currentMonth}, rok=${currentYear}`); } console.log(`loadFromLocalStorage: Naƒç√≠tavam pre ${getMonthName(currentMonth)} ${currentYear}`); const storedMonthData = localStorage.getItem('workDaysData'); monthData = storedMonthData ? JSON.parse(storedMonthData) : {}; if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) { console.log(`loadFromLocalStorage: Naƒç√≠tan√Ωch ${monthData[currentYear][currentMonth].length} z√°znamov pre ${currentYear}-${currentMonth} z localStorage.`); } else { console.log(`loadFromLocalStorage: Pre ${currentYear}-${currentMonth} neboli v localStorage n√°jden√© ≈æiadne z√°znamy alebo ≈°trukt√∫ra ch√Ωba.`); } hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10; taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02; const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false; decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1; employeeName = JSON.parse(localStorage.getItem('employeeName')) || ''; updateUIFromLoadedData(darkMode); } catch (error) { console.error(`Kritick√° chyba pri naƒç√≠tavan√≠/spracovan√≠ d√°t z localStorage pre ${getMonthName(currentMonth)} ${currentYear}:`, error); showSaveNotification("Chyba pri naƒç√≠tan√≠ lok√°lnych d√°t!", "error"); monthData = {}; createTable(); calculateTotal(); } }

    // 11. Funkcia na aktualiz√°ciu UI - Nezmenen√©
    function updateUIFromLoadedData(darkModeValue) {
        console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(currentMonth)} ${currentYear}`);
        try {
            hourlyWageInput.value = hourlyWage; taxRateInput.value = taxRate * 100; decimalPlacesSelect.value = decimalPlaces; employeeNameInput.value = employeeName;
            if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) { monthSelect.value = currentMonth; } else { console.warn(`Mesiac ${currentMonth} nen√°jden√Ω v selecte.`); monthSelect.value = new Date().getMonth(); currentMonth = parseInt(monthSelect.value); }
            if (yearSelect.querySelector(`option[value="${currentYear}"]`)) { yearSelect.value = currentYear; } else { console.warn(`Rok ${currentYear} nen√°jden√Ω v selecte.`); yearSelect.value = new Date().getFullYear(); currentYear = parseInt(yearSelect.value); populateYearSelect(); yearSelect.value = currentYear;}
            createTable(); // Vytvor√≠ ≈°trukt√∫ru vr√°tane pozn√°mok
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            console.log(`updateUIFromLoadedData: Poƒçet z√°znamov v monthData pre ${currentYear}-${currentMonth} pri plnen√≠ UI: ${dataForCurrentMonth.length}`);
            dataForCurrentMonth.forEach((day, index) => {
                const i = index + 1;
                const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`); // <<< Z√≠skanie elementu pozn√°mky

                if (startElement && endElement && breakElement && noteElement) { // <<< Kontrola aj noteElement
                    startElement.value = day.start || '';
                    endElement.value = day.end || '';
                    breakElement.value = day.breakTime || '';
                    noteElement.value = day.note || ''; // <<< Naplnenie pozn√°mky
                    calculateRow(i);
                } else {
                    console.error(`Kritick√° chyba: Elementy pre de≈à ${i} v updateUIFromLoadedData neboli n√°jden√© po createTable!`);
                }
            });
            calculateTotal(); updateDataSize(); applyDarkMode(darkModeValue); updateWelcomeMessage();
            console.log("UI aktualizovan√©.");
        } catch (error) {
            console.error("Chyba poƒças aktualiz√°cie UI:", error); showSaveNotification("Chyba pri prekresƒæovan√≠ UI!", "error");
        }
    }

    // 12. Funkcia pre aplikovanie Dark Mode - Nezmenen√©
    function applyDarkMode(isDark) {
        const elementsToToggle = [
            document.body,
            document.querySelector('.container'),
            totalSalaryDiv,
            document.querySelector('.collapsible-settings summary'),
            ...document.querySelectorAll('table, th, td'),
            ...document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"], select'),
            ...document.querySelectorAll('.btn'), // V≈°eobecn√© tlaƒçidl√°
            ...document.querySelectorAll('.toggle-note-btn'), // <<< Pridan√© tlaƒçidl√° pozn√°mok
            ...document.querySelectorAll('.note-textarea')    // <<< Pridan√© textarey pozn√°mok
        ];

        if (isDark) {
            elementsToToggle.forEach(el => el?.classList.add('dark-mode'));
        } else {
            elementsToToggle.forEach(el => el?.classList.remove('dark-mode'));
        }
        // Aplikuj ≈°peci√°lne na aktu√°lny de≈à (ak existuje)
        const currentDayRow = document.querySelector('.current-day');
        if (currentDayRow) {
            if (isDark) {
                 currentDayRow.classList.add('dark-mode');
                 // Pridan√© .note-textarea a .toggle-note-btn
                 currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn').forEach(el => el?.classList.add('dark-mode'));
            } else {
                 currentDayRow.classList.remove('dark-mode');
                 // Pridan√© .note-textarea a .toggle-note-btn
                 currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn').forEach(el => el?.classList.remove('dark-mode'));
            }
        }
    }

    // 13) Vytv√°ranie tabuƒæky (a s√∫visiace funkcie) - Nezmenen√©
    function getDayName(year, month, day) { const daysOfWeek = ["Nedeƒæa", "Pondelok", "Utorok", "Streda", "≈†tvrtok", "Piatok", "Sobota"]; return daysOfWeek[new Date(year, month, day).getDay()]; }
    function createTable() {
        workDays.innerHTML = '';
        // Pridaj nov√Ω header pre pozn√°mky (ak e≈°te neexistuje - pre istotu)
        const tableHead = document.querySelector('table thead tr');
        if (tableHead && !tableHead.querySelector('.th-note')) {
            const noteTh = document.createElement('th');
            noteTh.textContent = 'Pozn√°mka';
            noteTh.classList.add('th-note');
            const lastTh = tableHead.lastElementChild; // N√°jdeme posledn√Ω header (Akcia)
            tableHead.insertBefore(noteTh, lastTh);    // Vlo≈æ√≠me nov√Ω header pred posledn√Ω
        }

        const daysInMonth = getDaysInMonth(currentMonth);
        const today = new Date();
        const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth();
        const currentYearValue = today.getFullYear();

        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
                row.classList.add('current-day');
            }
            const dayName = getDayName(currentYear, currentMonth, i);

            // Unik√°tne ID pre tento de≈à
            const baseId = `${currentYear}-${currentMonth}-${i}`;
            const startId = `start-${baseId}`;
            const endId = `end-${baseId}`;
            const breakId = `break-${baseId}`;
            const totalId = `total-${baseId}`;
            const grossId = `gross-${baseId}`;
            const netId = `net-${baseId}`;
            const noteToggleId = `note-toggle-${baseId}`; // <<< ID pre tlaƒçidlo pozn√°mky
            const noteContainerId = `note-container-${baseId}`; // <<< ID pre kontajner pozn√°mky
            const noteTextareaId = `note-${baseId}`; // <<< ID pre textarea pozn√°mky

            // Vytvor HTML pre riadok vr√°tane novej bunky pre pozn√°mky
            row.innerHTML = `
                <td>De≈à ${i} (${dayName})</td>
                <td><input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}', ${i})"></td>
                <td><input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}', ${i})"></td>
                <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="prest√°vka" oninput="handleBreakInput(${i})"></td>
                <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces || 1)} h)</td>
                <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="Hrub√° Mzda" readonly></td>
                <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="ƒåist√° Mzda" readonly></td>
                <td> <button id="${noteToggleId}" class="toggle-note-btn" onclick="toggleNote(${i})">Pozn√°mka</button>
                    <div id="${noteContainerId}" class="note-container">
                        <textarea id="${noteTextareaId}" class="note-textarea" placeholder="Zadajte pozn√°mku..." oninput="handleNoteInput(this, ${i})"></textarea>
                    </div>
                </td>
                <td> <button class="btn reset-btn" onclick="resetRow(${i})">Vynulova≈•</button>
                </td>
            `;
            workDays.appendChild(row);
        }
        applyDarkMode(document.body.classList.contains('dark-mode'));
    }

    // --- NOV√â FUNKCIE PRE POZN√ÅMKY --- Nezmenen√©
    function toggleNote(day) {
        const containerId = `note-container-${currentYear}-${currentMonth}-${day}`;
        const buttonId = `note-toggle-${currentYear}-${currentMonth}-${day}`;
        const noteContainer = document.getElementById(containerId);
        const toggleButton = document.getElementById(buttonId);

        if (noteContainer && toggleButton) {
            const isVisible = noteContainer.classList.toggle('visible');
            toggleButton.textContent = isVisible ? 'Skry≈•' : 'Pozn√°mka';
            // Aplikuj dark mode, ak je akt√≠vny
            if (document.body.classList.contains('dark-mode')) {
                 const textarea = noteContainer.querySelector('textarea');
                 if(textarea) {
                     if (isVisible) textarea.classList.add('dark-mode'); else textarea.classList.remove('dark-mode');
                 }
                 if (isVisible) toggleButton.classList.add('dark-mode'); else toggleButton.classList.remove('dark-mode');
            }
        } else {
            console.warn(`toggleNote: Elementy pre pozn√°mku d≈àa ${day} neboli n√°jden√©.`);
        }
    }
    function handleNoteInput(textarea, day) {
        updateMonthDataFromInput(textarea, day); // Pou≈æijeme existuj√∫cu funkciu
        debouncedProcessInputCompletion(textarea.id, null); // Ulo≈æ√≠me zmeny (bez presunu fokusu)
    }
    // --- KONIEC NOV√ùCH FUNKCI√ç PRE POZN√ÅMKY ---

    // Input handling funkcie - **S LOGOVAN√çM vo formatInput a updateMonthDataFromInput**
    function processInputCompletion(inputId, nextId) { console.log(`processInputCompletion: Spusten√© pre ${inputId}, ƒèal≈°√≠: ${nextId}`); const inputElement = document.getElementById(inputId); if (!inputElement && !(inputId === 'reset-all' || inputId.startsWith('reset-') || inputId === 'settings-change' || inputId === 'restore-backup' || inputId.startsWith('note-')) ) { console.warn(`processInputCompletion: Element ${inputId} nen√°jden√Ω.`); return; } calculateTotal(); saveToLocalStorage(); if (inputElement && inputElement.type === 'tel') { if (inputElement.value.length === 5 && isTimeValid(inputElement.value)) { moveNext(inputElement, nextId); } } else if (inputElement && inputElement.type === 'number' && inputId.startsWith('break-')) { moveNext(inputElement, nextId); } else if (inputElement && inputElement.tagName === 'TEXTAREA' && inputId.startsWith('note-')) { /* Pri pozn√°mke nepres√∫vame fokus automaticky */ } }
    const debouncedProcessInputCompletion = debounce(processInputCompletion, 500);
    function isTimeValid(timeStr) { const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeStr); }
    function handleInput(input, nextId, day) { formatInput(input); updateMonthDataFromInput(input, day); calculateRow(day); debouncedProcessInputCompletion(input.id, nextId); }
    function handleBreakInput(day) { const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); updateMonthDataFromInput(input, day); calculateRow(day); const nextDay = day + 1; let nextInputElementId = null; if (nextDay <= getDaysInMonth(currentMonth)) { nextInputElementId = `start-${currentYear}-${currentMonth}-${nextDay}`; } debouncedProcessInputCompletion(input.id, nextInputElementId); }

    // ===== ZAƒåIATOK updateMonthDataFromInput s FIN√ÅLNYM LOGOVAN√çM =====
    function updateMonthDataFromInput(input, day) {
        if (!input) return;
        const dayIndex = day - 1;
        const fieldId = input.id;
        let field = 'unknown';

        if (fieldId.startsWith('start-')) field = 'start';
        else if (fieldId.startsWith('end-')) field = 'end';
        else if (fieldId.startsWith('break-')) field = 'breakTime';
        else if (fieldId.startsWith('note-')) field = 'note';

        const value = input.value; // Naƒç√≠taj aktu√°lnu hodnotu z inputu

        if (field !== 'unknown') {
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];

            // Zabezpeƒç, ≈æe pole m√° dostatok z√°znamov (s novou ≈°trukt√∫rou)
            // Prid√°vaj len ak je dayIndex v√§ƒç≈°√≠ alebo rovn√Ω aktu√°lnej dƒ∫≈æke
            while (dayIndex >= monthData[currentYear][currentMonth].length) {
                 console.log(`updateMonthDataFromInput: Roz≈°irujem pole monthData pre ${currentYear}-${currentMonth}, lebo index ${dayIndex} je mimo rozsahu (dƒ∫≈æka ${monthData[currentYear][currentMonth].length}).`);
                 monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '' });
            }


            // Aktualizuj alebo vytvor z√°znam pre de≈à
            if (!monthData[currentYear][currentMonth][dayIndex]) {
                 console.error(`updateMonthDataFromInput: Ch√Ωba z√°znam pre de≈à ${dayIndex} v monthData aj po roz≈°√≠ren√≠. Vytv√°ram nov√Ω n√∫dzovo.`);
                 monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '' }; // <<< Inicializ√°cia s note
            }

            const currentValue = monthData[currentYear]?.[currentMonth]?.[dayIndex]?.[field];

            if (currentValue !== value) {
                console.log(`%cupdateMonthDataFromInput: Pokus o z√°pis do monthData[${currentYear}][${currentMonth}][${dayIndex}].${field}. Star√° hodnota: "${currentValue}", Nov√° hodnota: "${value}"`, 'color: #e67e22;');

                // Samotn√© priradenie
                monthData[currentYear][currentMonth][dayIndex][field] = value;

                // ===== NOV√ù KONTROLN√ù LOG HNEƒé PO PRIRADEN√ç =====
                const valueAfterAssignment = monthData[currentYear][currentMonth][dayIndex][field];
                if (valueAfterAssignment === value) {
                    console.log(`%cupdateMonthDataFromInput: KONTROLA - Hodnota v monthData √∫spe≈°ne nastaven√° na: "${valueAfterAssignment}"`, 'color: green; font-weight: bold;');
                } else {
                    console.error(`%cupdateMonthDataFromInput: KONTROLA ZLYHALA! - Hodnota v monthData je: "${valueAfterAssignment}" namiesto oƒçak√°vanej "${value}"!`, 'color: red; font-weight: bold;');
                }
                // ================================================

            }

        } else {
            console.warn("updateMonthDataFromInput: Nerozpoznan√© pole pre input ID:", fieldId);
        }
    }
    // ===== KONIEC updateMonthDataFromInput s FIN√ÅLNYM LOGOVAN√çM =====


    // ===== ZAƒåIATOK formatInput s LOGOVAN√çM =====
    function formatInput(input) {
        if (!input || input.type !== 'tel') return;
        // Loguj ID a p√¥vodn√∫ hodnotu na zaƒçiatku
        console.log(`%cformatInput START - ID: ${input.id}, Original Value: "${input.value}"`, 'color: blue;');

        let originalValueBeforeProcessing = input.value; // Uchov√°me si p√¥vodn√∫ hodnotu pre porovnanie na konci
        let value = input.value.replace(/[^\d:]/g, '');
        // Loguj po odstr√°nen√≠ neplatn√Ωch znakov
        if (value !== originalValueBeforeProcessing.replace(/[^\d:]/g, '')) {
            console.log(`  After replace non-digits/colon: "${value}"`);
        }


        let ruleApplied = false; // Flag na sledovanie, ƒçi sa aplikovalo pravidlo
        if (value.length === 4 && !value.includes(':')) {
            const originalValueBeforeColon = value;
            value = value.slice(0, 2) + ':' + value.slice(2);
            console.log(`%c  Applied HHMM -> HH:MM rule. Was: "${originalValueBeforeColon}", Now: "${value}"`, 'color: green;');
            ruleApplied = true;
        } else if (value.length === 3 && value.charAt(2) !== ':' && parseInt(value.slice(0, 2)) <= 23) {
            const originalValueBeforeColon = value;
            value = value.slice(0, 2) + ':' + value.slice(2);
            console.log(`%c  Applied HHM -> HH:M rule. Was: "${originalValueBeforeColon}", Now: "${value}"`, 'color: green;');
            ruleApplied = true;
        }

        if (value.length > 5) {
            const originalValueBeforeTruncate = value;
            value = value.slice(0, 5);
            console.log(`%c  Applied Truncate > 5 rule. Was: "${originalValueBeforeTruncate}", Now: "${value}"`, 'color: orange;');
            ruleApplied = true;
        }

        // Aktualizuj hodnotu v inpute LEN ak sa naozaj zmenila poƒças form√°tovania
        if (input.value !== value) {
             console.log(`  Updating input.value from "${input.value}" to "${value}"`);
             input.value = value;
        } else if (!ruleApplied) {
             // Loguj len ak sa neurobila ≈æiadna zmena pravidlom formatovania a hodnota sa nezmenila
             // console.log(`  No change needed for input.value ("${value}")`);
        }

        // Validation Border Logic (ponechaj ako je, pridaj log pre validitu)
        if (value.length > 0 && value.length < 5) {
            if(input.style.border !== '') input.style.border = ''; // Resetuj len ak bol nastaven√Ω
        } else if (value.length === 5) {
            if (isTimeValid(value)) {
                if(input.style.border !== '') input.style.border = ''; // Resetuj len ak bol nastaven√Ω
                 // console.log(`  Time "${value}" is valid.`); // M√¥≈æe by≈• pr√≠li≈° veƒæa logov, odkomentuj ak treba
            } else {
                input.style.border = '1px solid red';
                console.log(`%c  Time "${value}" is INVALID. Setting red border.`, 'color: red;');
                setTimeout(() => {
                    // Odstr√°≈à border len ak je st√°le ƒçerven√Ω (aby sme neprepisali in√Ω stav)
                     if(input.style.borderColor === 'red') {
                        input.style.border = '';
                     }
                }, 2000);
            }
        } else {
             if(input.style.border !== '') input.style.border = ''; // Resetuj len ak bol nastaven√Ω
        }
        // Loguj fin√°lnu hodnotu na konci
        console.log(`%cformatInput END - ID: ${input.id}, Final Value in Input: "${input.value}"`, 'color: blue;');
    }
    // ===== KONIEC formatInput s LOGOVAN√çM =====


    function moveNext(currentElement, nextId) { if (!nextId || !currentElement) return; const nextElement = document.getElementById(nextId); if (nextElement) { if (document.activeElement === currentElement) { console.log(`moveNext: Pres√∫vam fokus z ${currentElement.id} na ${nextId}`); nextElement.focus(); if (nextElement.select) { nextElement.select(); } } else { console.log(`moveNext: Aktu√°lny element ${currentElement.id} u≈æ nem√° fokus, presun preskoƒçen√Ω.`); } } else { console.warn(`moveNext: Element s ID ${nextId} nebol n√°jden√Ω.`); } }
    function calculateRow(day) { const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value; const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value; const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const breakTime = parseFloat(breakTimeInput?.value) || 0; const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!totalCell || !grossElement || !netElement) { /*console.warn(`calculateRow: Ch√Ωbaj√∫ elementy pre de≈à ${day}`);*/ return; } if (!startTimeStr && !endTimeStr) { totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`; grossElement.value = '0.00'; netElement.value = '0.00'; return; } const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; if (!timeRegex.test(startTimeStr) && startTimeStr !== '' || !timeRegex.test(endTimeStr) && endTimeStr !== '') { totalCell.textContent = 'Neplatn√Ω ƒças'; grossElement.value = '0.00'; netElement.value = '0.00'; return; } if(startTimeStr === '' || endTimeStr === '') { totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`; grossElement.value = '0.00'; netElement.value = '0.00'; return; } const [startHours, startMinutes] = startTimeStr.split(':').map(Number); const [endHours, endMinutes] = endTimeStr.split(':').map(Number); const startTotalMinutes = startHours * 60 + startMinutes; let endTotalMinutes = endHours * 60 + endMinutes; if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; } const diffMinutes = endTotalMinutes - startTotalMinutes; const breakMinutes = breakTime * 60; const workedMinutes = Math.max(0, diffMinutes - breakMinutes); const hours = Math.floor(workedMinutes / 60); const minutes = Math.round(workedMinutes % 60); const decimalHours = (workedMinutes / 60); totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces || 1)} h)`; const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate; const grossSalary = decimalHours * currentHourlyWage; grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00'; const netSalary = grossSalary * (1 - currentTaxRate); netElement.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00'; }
    function resetRow(day) { // <<< UPRAVEN√â pre pozn√°mky
        const dayIndex = day - 1;
        const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const total = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const net = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
        const note = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`); // <<< Z√≠skanie textarea pozn√°mky
        const noteContainer = document.getElementById(`note-container-${currentYear}-${currentMonth}-${day}`); // <<< Z√≠skanie kontajnera pozn√°mky
        const noteToggle = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${day}`); // <<< Z√≠skanie tlaƒçidla pozn√°mky

        if (start && end && breakTime && total && gross && net && note && noteContainer && noteToggle) { // <<< Kontrola aj elementov pozn√°mky
            start.value = ''; end.value = ''; breakTime.value = '';
            note.value = ''; // <<< Vymazanie obsahu pozn√°mky
            total.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
            gross.value = '0.00'; net.value = '0.00';

            // Resetovanie stavu pozn√°mky
            noteContainer.classList.remove('visible');
            noteToggle.textContent = 'Pozn√°mka';

            // Aktualiz√°cia monthData (s pr√°zdnou pozn√°mkou)
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
            // Zabezpeƒç√≠me, ≈æe pole existuje do indexu dayIndex
            while (dayIndex >= monthData[currentYear][currentMonth].length) {
                 monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '' });
            }

            if (monthData[currentYear][currentMonth][dayIndex]) {
                // Resetuj cel√Ω z√°znam vr√°tane pozn√°mky
                monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '' };
                 console.log(`resetRow: Resetovan√© d√°ta v monthData pre de≈à ${dayIndex}`);
            } else {
                console.error(`resetRow: Ch√Ωba z√°znam pre de≈à ${dayIndex} v monthData aj po pr√≠padnom roz≈°√≠ren√≠.`);
            }
            debouncedProcessInputCompletion(`reset-${day}`, null); // Spust√≠ ulo≈æenie
        } else {
             console.warn(`resetRow: Niektor√© elementy pre de≈à ${day} neboli n√°jden√©.`);
        }
    }
    function resetAll() { if (confirm('Naozaj chcete resetova≈• v≈°etky z√°znamy pre tento mesiac?')) { if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = []; /* T√Ωmto sa odstr√°nia aj v≈°etky pozn√°mky pre mesiac */ createTable(); calculateTotal(); debouncedProcessInputCompletion(`reset-all`, null); showSaveNotification("D√°ta pre aktu√°lny mesiac boli resetovan√©."); } }

    // 14) V√Ωpoƒçet celkov√Ωch s√∫ƒçtov - Nezmenen√©
    function calculateTotal() { let grandTotalWorkedMinutes = 0; let daysWithEntries = 0; const rows = workDays.querySelectorAll('tr'); const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate; const currentDecimalPlaces = decimalPlaces || 1; rows.forEach((row, index) => { const dayIndex = index + 1; const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`)?.value; const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`)?.value; const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`); if (startTimeStr && endTimeStr) { const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; if (timeRegex.test(startTimeStr) && timeRegex.test(endTimeStr)) { const breakTime = parseFloat(breakTimeInput?.value) || 0; const [startHours, startMinutes] = startTimeStr.split(':').map(Number); const [endHours, endMinutes] = endTimeStr.split(':').map(Number); const startTotalMinutes = startHours * 60 + startMinutes; let endTotalMinutes = endHours * 60 + endMinutes; if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; } const diffMinutes = endTotalMinutes - startTotalMinutes; const breakMinutes = breakTime * 60; const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes); grandTotalWorkedMinutes += workedMinutesForRow; if (workedMinutesForRow > 0 || (startTimeStr && endTimeStr)) { daysWithEntries++; } } } }); const grandTotalDecimalHours = grandTotalWorkedMinutes / 60; const grandTotalGrossSalary = grandTotalDecimalHours * currentHourlyWage; const grandTotalNetSalary = grandTotalGrossSalary * (1 - currentTaxRate); const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0; const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0; const averageHours = Math.floor(averageWorkedMinutes / 60); const averageMinutes = Math.round(averageWorkedMinutes % 60); const averageDecimalHours = (averageWorkedMinutes / 60); const totalHours = Math.floor(grandTotalWorkedMinutes / 60); const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60); totalSalaryDiv.innerHTML = `Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntries}<br>Celkov√Ω odpracovan√Ω ƒças: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(currentDecimalPlaces)} h)<br>Celkov√° hrub√° mzda: ${grandTotalGrossSalary.toFixed(2)}‚Ç¨<br>Celkov√° ƒçist√° mzda: ${grandTotalNetSalary.toFixed(2)}‚Ç¨<br>Priemern√° ƒçist√° mzda na de≈à: ${averageNetSalary.toFixed(2)}‚Ç¨<br><strong>Priemern√Ω odpracovan√Ω ƒças na de≈à: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(currentDecimalPlaces)} h)</strong>`; }

    // 15) Export do PDF (exportToPDF, sendPDF) - Nezmenen√©
    function exportToPDF() {
        console.log("exportToPDF: Spusten√©...");
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Kni≈ænica jsPDF alebo autoTable nie je spr√°vne naƒç√≠tan√°."); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; }
        const { jsPDF } = window.jspdf;
        try {
            const doc = new jsPDF();
            try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("Could not load Roboto font for PDF, using default.", e); }
            doc.setFontSize(18); doc.text(`Bruno's Calculator - V√Ωkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
            doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${employeeName || 'Nezadan√©'}`, 14, 28);
            doc.text(`Hodinov√° mzda: ${hourlyWage || 'N/A'} ‚Ç¨`, 14, 34); doc.text(`Da≈à (%): ${taxRate*100 || 'N/A'}`, 100, 34);
            // <<< Pridan√Ω stƒ∫pec "Pozn√°mka"
            const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Odpracovan√©", "Hrub√° Mzda (‚Ç¨)", "ƒåist√° Mzda (‚Ç¨)", "Pozn√°mka"];
            const tableRows = [];
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            dataForCurrentMonth.forEach((day, index) => {
                // Zahr≈à riadok, ak m√° ƒçasov√© √∫daje ALEBO pozn√°mku
                if (day.start || day.end || day.note) {
                    const dayNum = index + 1;
                    const dayName = getDayName(currentYear, currentMonth, dayNum);
                    const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${dayNum}`);
                    const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayNum}`);
                    const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayNum}`);
                    const workedTimeText = totalCell ? totalCell.textContent : 'N/A';
                    const grossValue = grossInput ? parseFloat(grossInput.value).toFixed(2) : '0.00';
                    const netValue = netInput ? parseFloat(netInput.value).toFixed(2) : '0.00';
                    const noteText = day.note || ''; // <<< Z√≠skanie textu pozn√°mky

                    const rowData = [
                        `De≈à ${dayNum} (${dayName})`,
                        day.start || '-',
                        day.end || '-',
                        day.breakTime || '0',
                        workedTimeText,
                        grossValue,
                        netValue,
                        noteText // <<< Pridanie pozn√°mky do d√°t riadku
                    ];
                    tableRows.push(rowData);
                }
            });
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName },
                styles: { font: doc.getFont().fontName, fontSize: 8 }, // Zmen≈°en√Ω font kv√¥li ≈°√≠rke
                alternateRowStyles: { fillColor: [240, 240, 240] },
                // M√¥≈æe by≈• potrebn√© explicitne nastavi≈• ≈°√≠rky stƒ∫pcov, ak sa nezmestia
                 columnStyles: {
                     7: { cellWidth: 'auto' } // Sk√∫sme auto pre pozn√°mku
                 }
            });
            const finalY = doc.lastAutoTable.finalY || 40;
            doc.setFontSize(10); const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, '');
            doc.text(totalTextContent, 14, finalY + 10);
            const pdfFileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
            doc.save(pdfFileName); showSaveNotification("PDF exportovan√©.");
        } catch (error) { console.error("Chyba pri generovan√≠ PDF v exportToPDF:", error); alert("Nastala chyba pri vytv√°ran√≠ PDF s√∫boru."); }
    }
    function sendPDF() {
        console.log("sendPDF: Spusten√©...");
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Kni≈ænica jsPDF alebo autoTable nie je spr√°vne naƒç√≠tan√°."); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; }
        const { jsPDF } = window.jspdf;
        try {
            const doc = new jsPDF();
            try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("sendPDF: Could not load Roboto font, using default.", e); }
            doc.setFontSize(16); doc.text(`Pracovn√Ω v√Ωkaz - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
            doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${employeeName || 'Nezadan√©'}`, 14, 28);
            // <<< Pridan√° Pozn√°mka do stƒ∫pcov
            const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Pozn√°mka"];
            const tableRows = [];
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            dataForCurrentMonth.forEach((day, index) => {
                 // Zahr≈à riadok, ak m√° ƒçasov√© √∫daje ALEBO pozn√°mku
                 if (day.start || day.end || day.note) {
                    const dayNum = index + 1;
                    const dayName = getDayName(currentYear, currentMonth, dayNum);
                    const noteText = day.note || ''; // <<< Z√≠skanie pozn√°mky
                    const rowData = [
                        `De≈à ${dayNum} (${dayName})`,
                        day.start || '-',
                        day.end || '-',
                        day.breakTime || '0',
                        noteText // <<< Pridanie pozn√°mky
                    ];
                    tableRows.push(rowData);
                }
            });
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 35,
                headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName },
                styles: { font: doc.getFont().fontName, fontSize: 9 }, // Font size m√¥≈æe by≈• potrebn√© upravi≈•
                alternateRowStyles: { fillColor: [240, 240, 240] },
                 // M√¥≈æe by≈• potrebn√© explicitne nastavi≈• ≈°√≠rky stƒ∫pcov
                 columnStyles: {
                     4: { cellWidth: 'auto' } // Sk√∫sme auto pre pozn√°mku
                 }
            });
            const finalY = doc.lastAutoTable.finalY || 35;
            doc.setFontSize(10);
            const totalSalaryHTML = totalSalaryDiv.innerHTML; let daysWithEntriesText = 'N/A';
            const match = totalSalaryHTML.match(/Poƒçet odpracovan√Ωch dn√≠: (\d+)/); if (match && match[1]) { daysWithEntriesText = match[1]; }
            const summaryText = `Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntriesText}`;
            doc.text(summaryText, 14, finalY + 10);
            const pdfBlob = doc.output('blob'); const pdfFileName = `Vykaz_odoslanie-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
            const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                navigator.share({ files: [pdfFile], title: `Pracovn√Ω v√Ωkaz ${getMonthName(currentMonth)} ${currentYear}`, text: `V√Ωkaz pre ${employeeName || 'pracovn√≠ka'} za ${getMonthName(currentMonth)} ${currentYear}.` }).then(() => { showSaveNotification("PDF pripraven√© na zdieƒæanie."); }).catch((error) => { if (error.name !== 'AbortError') { console.error('sendPDF: Chyba pri zdieƒæan√≠ cez Web Share API:', error); alert('Chyba pri zdieƒæan√≠ s√∫boru.'); } else { console.log('sendPDF: Zdieƒæanie PDF zru≈°en√© pou≈æ√≠vateƒæom.'); } });
            } else { alert("Zdieƒæanie s√∫borov nie je podporovan√© va≈°√≠m prehliadaƒçom alebo syst√©mom. S√∫bor bude stiahnut√Ω."); const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = pdfFileName; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); }
        } catch (error) { console.error("Chyba pri generovan√≠ alebo zdieƒæan√≠ PDF v sendPDF:", error); alert("Nastala chyba pri vytv√°ran√≠ alebo zdieƒæan√≠ PDF s√∫boru."); }
    }


    // 16) Ostatn√© nastavenia - Nezmenen√©
    function changeDecimalPlaces() { const newDecimalPlaces = parseInt(decimalPlacesSelect.value); if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) { decimalPlaces = newDecimalPlaces; calculateTotal(); debouncedProcessInputCompletion('settings-change', null); } }
    function updateEmployeeName() { employeeName = employeeNameInput.value; updateWelcomeMessage(); debouncedProcessInputCompletion('settings-change', null); }
    function updateSettings() { const newHourlyWageStr = hourlyWageInput.value; const newTaxRateStr = taxRateInput.value; const newHourlyWage = parseFloat(newHourlyWageStr); const newTaxRatePercent = parseFloat(newTaxRateStr); let hourlyWageChanged = false; let taxRateChanged = false; if (!isNaN(newHourlyWage) && newHourlyWage >= 0) { if (hourlyWage !== newHourlyWage) { hourlyWage = newHourlyWage; hourlyWageChanged = true; } } if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) { const newTaxRateDecimal = newTaxRatePercent / 100; if (taxRate !== newTaxRateDecimal) { taxRate = newTaxRateDecimal; taxRateChanged = true; } } const rows = workDays.querySelectorAll('tr'); rows.forEach((row, index) => calculateRow(index + 1)); calculateTotal(); if (hourlyWageChanged || taxRateChanged) { debouncedProcessInputCompletion('settings-change', null); } }
    function changeMonth() { const selectedMonth = parseInt(monthSelect.value); if (currentMonth !== selectedMonth) { currentMonth = selectedMonth; console.log(`Zmenen√Ω mesiac na: ${getMonthName(currentMonth)}`); handleMonthYearChange(); } }
    function changeYear() { const selectedYear = parseInt(yearSelect.value); if (currentYear !== selectedYear) { currentYear = selectedYear; console.log(`Zmenen√Ω rok na: ${currentYear}`); handleMonthYearChange(); } }
    function handleMonthYearChange() { console.log(`handleMonthYearChange: Spusten√© pre ${getMonthName(currentMonth)} ${currentYear}`); localStorage.setItem('currentMonth', currentMonth.toString()); localStorage.setItem('currentYear', currentYear.toString()); loadFromLocalStorage(); if (auth.currentUser) { setupFirestoreListener(); } else { console.log("handleMonthYearChange: Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω."); } }
    function getDaysInMonth(month) { if (month === undefined || month === null || currentYear === undefined || currentYear === null) { console.warn("getDaysInMonth: Ch√Ωba mesiac alebo rok, vraciam 31."); return 31; } return new Date(currentYear, month + 1, 0).getDate(); }
    function getMonthName(month) { const monthNames = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"]; return monthNames[month] || 'Nezn√°my'; }
    function updateDataSize() { try { const totalData = Object.values(localStorage).reduce((acc, value) => acc + (value ? value.length : 0), 0); const kilobytes = (totalData / 1024).toFixed(2); const percentageUsed = Math.min(((totalData / MAX_DATA_SIZE) * 100), 100); dataSizeText.textContent = `Lok√°lne √∫lo≈æisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`; dataSizeFill.style.width = `${percentageUsed}%`; if (percentageUsed > 90) { dataSizeFill.style.backgroundColor = '#f44336'; } else if (percentageUsed > 70) { dataSizeFill.style.backgroundColor = '#ff9800'; } else { dataSizeFill.style.backgroundColor = '#4CAF50'; } } catch (error) { console.error("Chyba pri v√Ωpoƒçte veƒækosti localStorage:", error); dataSizeText.textContent = "Chyba pri v√Ωpoƒçte veƒækosti d√°t."; } }
    function toggleDarkMode() { const isDarkMode = document.body.classList.toggle('dark-mode'); applyDarkMode(isDarkMode); localStorage.setItem('darkMode', JSON.stringify(isDarkMode)); if (auth.currentUser) { saveToFirebase(); } }

    // 17) Z√°lohovanie a obnova - Nezmenen√©
    function createBackup() { try { const backupData = { workDaysData: localStorage.getItem('workDaysData') || '{}', hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(10), taxRate: localStorage.getItem('taxRate') || JSON.stringify(2), darkMode: localStorage.getItem('darkMode') || JSON.stringify(false), decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(1), employeeName: localStorage.getItem('employeeName') || JSON.stringify(''), backupVersion: 2, backupTimestamp: new Date().toISOString() }; const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `bruno-calculator-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showSaveNotification("Z√°loha √∫spe≈°ne vytvoren√°."); } catch (error) { console.error("Chyba pri vytv√°ran√≠ z√°lohy:", error); alert("Nastala chyba pri vytv√°ran√≠ z√°lo≈æn√©ho s√∫boru."); } }
    function restoreBackup() {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.json,application/json';
      fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const backup = JSON.parse(e.target.result);
            // Kontrola z√°kladn√Ωch pol√≠, 'note' bude v 'workDaysData'
            if (backup && typeof backup.workDaysData === 'string' && typeof backup.hourlyWage === 'string' && typeof backup.taxRate === 'string' && typeof backup.darkMode === 'string' && typeof backup.decimalPlaces === 'string' && typeof backup.employeeName === 'string') {
              localStorage.setItem('workDaysData', backup.workDaysData);
              localStorage.setItem('hourlyWage', backup.hourlyWage);
              localStorage.setItem('taxRate', backup.taxRate);
              localStorage.setItem('darkMode', backup.darkMode);
              localStorage.setItem('decimalPlaces', backup.decimalPlaces);
              localStorage.setItem('employeeName', backup.employeeName);
              loadFromLocalStorage(); // Naƒç√≠ta v≈°etky d√°ta vr√°tane pozn√°mok a aktualizuje UI
              showSaveNotification("Z√°loha √∫spe≈°ne obnoven√°.");
              alert("Z√°loha bola √∫spe≈°ne obnoven√°. D√°ta boli naƒç√≠tan√©.");
              if (auth.currentUser) {
                console.log("Obnova z√°lohy: Uklad√°m obnoven√© d√°ta pre aktu√°lny mesiac do Firebase...");
                debouncedProcessInputCompletion('restore-backup', null); // Spust√≠ ulo≈æenie obnoven√Ωch d√°t
              }
            } else {
              alert("Chyba: S√∫bor z√°lohy m√° nespr√°vny form√°t alebo ch√Ωbaj√∫ d√°ta.");
            }
          } catch (error) {
            console.error("Chyba pri spracovan√≠ alebo obnove z√°lohy:", error);
            alert("Chyba pri ƒç√≠tan√≠ alebo obnove z√°lohy. S√∫bor m√¥≈æe by≈• po≈°koden√Ω alebo ma≈• nespr√°vny form√°t.");
          }
        };
        reader.onerror = (e) => {
          console.error("Chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy:", e);
          alert("Nastala chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy.");
        };
        reader.readAsText(file);
      };
      fileInput.click();
    }

    // 18) Inicializ√°cia - Nezmenen√©
     document.addEventListener('DOMContentLoaded', () => {
         console.log("DOM naƒç√≠tan√Ω, inicializujem...");
         populateYearSelect();
         const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
         applyDarkMode(darkMode);
         updateWelcomeMessage();
         if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(registration => { console.log('ServiceWorker zaregistrovan√Ω s rozsahom: ', registration.scope); }).catch(error => { console.error('Registr√°cia ServiceWorker zlyhala: ', error); }); }); } else { console.warn("Service Worker nie je podporovan√Ω v tomto prehliadaƒçi."); }
         console.log("Z√°kladn√° inicializ√°cia dokonƒçen√°, ƒçak√°m na stav prihl√°senia...");
     });
     function populateYearSelect() { const startYear = 2020; const endYear = new Date().getFullYear() + 2; yearSelect.innerHTML = ''; for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); } }

  </script>
</body>
</html>
