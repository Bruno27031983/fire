<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator v3</title> <!-- Zmena názvu pre odlíšenie -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* CSS - bez zmien */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; }
    .settings > div { flex: 1 1 200px; margin: 5px; }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 800px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode { background-color: #666; color: white; }
    .btn.dark-mode { color: #333; }
    .reset-btn.dark-mode { background-color: #d32f2f; }
    .export-btn.dark-mode { background-color: #388e3c; }
    .restore-btn.dark-mode { background-color: #7B1FA2; }
    .backup-btn.dark-mode { background-color: #E68900; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
    #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
    #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <!-- HTML -->
  <div id="loading-container"><h1>Loading...</h1></div>
  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator v3</h1>
    <h2 id="welcomeMessage"></h2>
    <div class="settings">
      <div><label for="employeeNameInput">Meno pracovníka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="handleSettingChange(this)"></div>
      <div><label for="hourlyWageInput">Hodinová mzda (€): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="handleSettingChange(this)"></div>
      <div><label for="taxRateInput">Daňové percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="handleSettingChange(this)"></div>
      <div><label for="monthSelect">Mesiac: </label><select id="monthSelect" onchange="handleMonthYearChange()"><option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option><option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option><option value="6">Júl</option><option value="7">August</option><option value="8">September</option><option value="9">Október</option><option value="10">November</option><option value="11">December</option></select></div>
      <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="handleMonthYearChange()"></select></div>
      <div><label for="decimalPlacesSelect">Počet desatinných miest: </label><select id="decimalPlacesSelect" onchange="handleSettingChange(this)"><option value="1">1</option><option value="2">2</option></select></div>
      <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>
    <div class="table-container">
      <table>
        <thead><tr><th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka</th><th>Odpracované</th><th>Hrubá Mzda (€)</th><th>Čistá Mzda (€)</th><th>Akcia</th></tr></thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
    </div>
  </div>
  <div id="saveNotification"></div>

  <script>
    // --- Constants ---
    const MAX_DATA_SIZE = 4 * 1024 * 1024;
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;
    const DEFAULT_HOURLY_WAGE = 10;
    const DEFAULT_TAX_RATE_PERCENT = 2;
    const DEFAULT_DECIMAL_PLACES = 1;

    // --- Firebase Init ---
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("App Check activation failed:", error); }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- Firestore Persistence ---
    let persistenceEnabled = false;
    db.enablePersistence()
      .then(() => { persistenceEnabled = true; console.log("Firestore offline persistence enabled."); })
      .catch((err) => { console.error("Firestore offline persistence error:", err); });

    // --- Global State ---
    let currentMonth;
    let currentYear;
    let workDaysData = {}; // Holds data for all loaded months { year: { month: [...] } }
    let appSettings = {
        hourlyWage: DEFAULT_HOURLY_WAGE,
        taxRatePercent: DEFAULT_TAX_RATE_PERCENT,
        decimalPlaces: DEFAULT_DECIMAL_PLACES,
        employeeName: '',
        darkMode: false
    };
    let firestoreListenerUnsubscribe = null;
    let isSaving = false; // Flag to prevent loops during save

    // --- DOM Elements ---
    const workDaysTbody = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const loadingContainer = document.getElementById('loading-container');
    const authContainer = document.getElementById('auth-container');
    const calculatorContainer = document.getElementById('calculator-container');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const saveNotification = document.getElementById('saveNotification');

    // --- Utility Functions ---
    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    function showSaveNotification(message, type = 'success', duration = 3000) {
        saveNotification.textContent = message;
        saveNotification.className = 'show'; // Base class
        if (type === 'error') saveNotification.classList.add('error');
        else if (type === 'warning') saveNotification.classList.add('warning');
        setTimeout(() => {
            saveNotification.classList.remove('show', 'error', 'warning');
        }, duration);
    }

    function getFirstName(fullName) {
        return String(fullName || '').trim().split(' ')[0];
    }

    function getDayName(year, month, day) {
        const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"];
        return daysOfWeek[new Date(year, month, day).getDay()];
    }

    function getDaysInMonth(year, month) {
        if (month === undefined || month === null || year === undefined || year === null) {
            console.warn("getDaysInMonth: Missing year or month, returning 31.");
            return 31;
        }
        return new Date(year, month + 1, 0).getDate();
    }

    function getMonthName(month) {
        const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
        return monthNames[month] || 'Neznámy';
    }

    function isTimeValid(timeStr) {
        return /^([01]\d|2[0-3]):([0-5]\d)$/.test(timeStr);
    }

    // --- Core Application Logic ---

    /** Loads settings and work data for the current month/year from localStorage */
    function loadStateFromLocalStorage() {
        console.log(`loadStateFromLocalStorage: Loading state for ${getMonthName(currentMonth)} ${currentYear}`);
        try {
            // Load Settings
            const storedSettings = JSON.parse(localStorage.getItem('appSettings') || '{}');
            appSettings = {
                hourlyWage: storedSettings.hourlyWage ?? DEFAULT_HOURLY_WAGE,
                taxRatePercent: storedSettings.taxRatePercent ?? DEFAULT_TAX_RATE_PERCENT,
                decimalPlaces: storedSettings.decimalPlaces ?? DEFAULT_DECIMAL_PLACES,
                employeeName: storedSettings.employeeName || '',
                darkMode: storedSettings.darkMode || false
            };

            // Load Work Data (all months)
            workDaysData = JSON.parse(localStorage.getItem('workDaysData') || '{}');

            console.log("Loaded settings:", appSettings);
            // Data for current month will be accessed via workDaysData[currentYear]?.[currentMonth]
        } catch (error) {
            console.error("Error loading state from localStorage:", error);
            showSaveNotification("Chyba pri načítaní lokálnych dát!", "error");
            // Reset to defaults if loading fails
            workDaysData = {};
            appSettings = { /* defaults */ };
        }
        // Update UI after loading
        updateSettingsUI();
        updateWorkDataTable();
        updateDataSizeUI();
    }

    /** Saves current settings and work data (all loaded months) to localStorage */
    function saveStateToLocalStorage() {
        if (isSaving) return; // Prevent recursive saves if called from within save logic
        console.log("saveStateToLocalStorage: Saving state...");
        isSaving = true; // Set saving flag
        try {
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
            localStorage.setItem('workDaysData', JSON.stringify(workDaysData));
            localStorage.setItem('currentMonth', currentMonth.toString());
            localStorage.setItem('currentYear', currentYear.toString());
            updateDataSizeUI();
            console.log("State saved to localStorage.");

            // Trigger Firestore save if user is logged in
            if (auth.currentUser) {
                saveMonthDataToFirestore(); // Save only the current month's data to Firestore
            }
        } catch (error) {
            console.error("Error saving state to localStorage:", error);
            showSaveNotification("Chyba pri ukladaní lokálnych dát!", "error");
            if (error.name === 'QuotaExceededError') {
                 alert("Chyba: Lokálne úložisko je plné! Nie je možné uložiť ďalšie dáta.");
            }
        } finally {
             isSaving = false; // Reset saving flag
        }
    }
    // Debounced version for frequent calls (like input changes)
    const debouncedSaveStateToLocalStorage = debounce(saveStateToLocalStorage, 600);

    /** Updates the settings section of the UI based on appSettings */
    function updateSettingsUI() {
        console.log("updateSettingsUI: Updating settings inputs.");
        hourlyWageInput.value = appSettings.hourlyWage;
        taxRateInput.value = appSettings.taxRatePercent;
        decimalPlacesSelect.value = appSettings.decimalPlaces;
        employeeNameInput.value = appSettings.employeeName;
        monthSelect.value = currentMonth;
        yearSelect.value = currentYear;
        applyDarkMode(appSettings.darkMode);
        updateWelcomeMessage();
    }

    /** Updates the data size indicator UI */
    function updateDataSizeUI() {
        try {
            const settingsSize = localStorage.getItem('appSettings')?.length || 0;
            const workDataSize = localStorage.getItem('workDaysData')?.length || 0;
            const otherSize = (localStorage.getItem('currentMonth')?.length || 0) + (localStorage.getItem('currentYear')?.length || 0);
            const totalData = settingsSize + workDataSize + otherSize;

            const kilobytes = (totalData / 1024).toFixed(2);
            const percentageUsed = Math.min(((totalData / MAX_DATA_SIZE) * 100), 100);
            dataSizeText.textContent = `Lokálne úložisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
            dataSizeFill.style.width = `${percentageUsed}%`;
            dataSizeFill.style.backgroundColor = percentageUsed > 90 ? '#f44336' : percentageUsed > 70 ? '#ff9800' : '#4CAF50';
        } catch (error) {
            console.error("Error calculating localStorage size:", error);
            dataSizeText.textContent = "Chyba pri výpočte veľkosti dát.";
        }
    }

    /** Updates the welcome message */
    function updateWelcomeMessage() {
        const firstName = getFirstName(appSettings.employeeName);
        welcomeMessage.textContent = firstName ? `Vitaj, ${firstName}!` : '';
    }

     /** Applies dark mode based on the provided boolean */
    function applyDarkMode(isDark) {
        const elementsToToggle = [
            document.body, document.querySelector('.container'), totalSalaryDiv,
            ...document.querySelectorAll('table, th, td'), // Include table elements directly
            ...document.querySelectorAll('input'), // All inputs
            ...document.querySelectorAll('.btn') // All buttons with .btn class
        ];
        // Add current-day row specifically if it exists
        const currentDayRow = document.querySelector('.current-day');
        if (currentDayRow) elementsToToggle.push(currentDayRow);

        elementsToToggle.forEach(el => {
            if (el) { // Ensure element exists
                if (isDark) { el.classList.add('dark-mode'); }
                else { el.classList.remove('dark-mode'); }
            }
        });
        console.log(`Dark mode ${isDark ? 'applied' : 'removed'}.`);
    }

    /** Creates or updates the work data table for the current month/year */
    function updateWorkDataTable() {
        console.log(`updateWorkDataTable: Updating table for ${getMonthName(currentMonth)} ${currentYear}`);
        const daysInTable = getDaysInMonth(currentYear, currentMonth);
        const currentMonthData = workDaysData[currentYear]?.[currentMonth] || [];
        const today = new Date();
        const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth();
        const currentYearValue = today.getFullYear();

        let tableHTML = '';
        for (let i = 1; i <= daysInTable; i++) {
            const dayData = currentMonthData[i - 1] || { start: '', end: '', breakTime: '' };
            const isCurrentDay = (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue);
            const dayName = getDayName(currentYear, currentMonth, i);

            // Calculate work details for the row (needed for display)
            const { hours, minutes, decimalHours, grossSalary, netSalary } = calculateWorkDetails(dayData.start, dayData.end, dayData.breakTime);
            const workedTimeText = `${hours}h ${minutes}m (${decimalHours.toFixed(appSettings.decimalPlaces)} h)`;
            const grossStr = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00';
            const netStr = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00';

            tableHTML += `
                <tr class="${isCurrentDay ? 'current-day' : ''}">
                    <td>Deň ${i} (${dayName})</td>
                    <td><input type="tel" id="start-${i}" value="${dayData.start}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleCellInput(this, ${i}, 'start')"></td>
                    <td><input type="tel" id="end-${i}" value="${dayData.end}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleCellInput(this, ${i}, 'end')"></td>
                    <td><input type="number" id="break-${i}" value="${dayData.breakTime}" min="0" step="0.5" placeholder="prestávka" oninput="handleCellInput(this, ${i}, 'breakTime')"></td>
                    <td id="total-${i}">${workedTimeText}</td>
                    <td><input type="number" id="gross-${i}" value="${grossStr}" readonly></td>
                    <td><input type="number" id="net-${i}" value="${netStr}" readonly></td>
                    <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>
                </tr>
            `;
        }
        workDaysTbody.innerHTML = tableHTML;
        calculateTotalSalary(); // Recalculate totals after updating table
        applyDarkMode(appSettings.darkMode); // Re-apply dark mode to new rows
    }

    /**
     * Calculates worked hours, decimal hours, gross and net salary for given times.
     * @returns {object} Object with hours, minutes, decimalHours, grossSalary, netSalary.
     */
    function calculateWorkDetails(startTimeStr, endTimeStr, breakTimeStr) {
        let hours = 0, minutes = 0, decimalHours = 0, grossSalary = 0, netSalary = 0;
        const breakTime = parseFloat(breakTimeStr) || 0;

        if (startTimeStr && endTimeStr && isTimeValid(startTimeStr) && isTimeValid(endTimeStr)) {
            const [startH, startM] = startTimeStr.split(':').map(Number);
            const [endH, endM] = endTimeStr.split(':').map(Number);
            let startTotalMinutes = startH * 60 + startM;
            let endTotalMinutes = endH * 60 + endM;
            if (endTotalMinutes < startTotalMinutes) { // Handle overnight work
                endTotalMinutes += 24 * 60;
            }
            const diffMinutes = endTotalMinutes - startTotalMinutes;
            const breakMinutes = breakTime * 60;
            const workedMinutes = Math.max(0, diffMinutes - breakMinutes);

            hours = Math.floor(workedMinutes / 60);
            minutes = Math.round(workedMinutes % 60);
            decimalHours = workedMinutes / 60;
            grossSalary = decimalHours * appSettings.hourlyWage;
            netSalary = grossSalary * (1 - (appSettings.taxRatePercent / 100));
        }
        return { hours, minutes, decimalHours, grossSalary, netSalary };
    }

     /** Recalculates and updates a single row in the table */
    function updateTableRowUI(dayIndex) {
        const dayData = workDaysData[currentYear]?.[currentMonth]?.[dayIndex - 1] || {};
        const { hours, minutes, decimalHours, grossSalary, netSalary } = calculateWorkDetails(dayData.start, dayData.end, dayData.breakTime);

        const totalCell = document.getElementById(`total-${dayIndex}`);
        const grossInput = document.getElementById(`gross-${dayIndex}`);
        const netInput = document.getElementById(`net-${dayIndex}`);

        if (totalCell) {
            totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(appSettings.decimalPlaces)} h)`;
        }
        if (grossInput) {
            grossInput.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00';
        }
        if (netInput) {
            netInput.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00';
        }
    }


    /** Calculates and displays the total salary summary */
    function calculateTotalSalary() {
        const currentMonthData = workDaysData[currentYear]?.[currentMonth] || [];
        let grandTotalWorkedMinutes = 0;
        let daysWithEntries = 0;

        currentMonthData.forEach(day => {
            if (day.start && day.end && isTimeValid(day.start) && isTimeValid(day.end)) {
                const { decimalHours } = calculateWorkDetails(day.start, day.end, day.breakTime);
                if(decimalHours > 0) {
                    grandTotalWorkedMinutes += decimalHours * 60;
                    daysWithEntries++;
                } else if(day.start || day.end){ // Count day if times are entered, even if hours are 0 after break
                     daysWithEntries++;
                }
            } else if (day.start || day.end) { // Count if at least one time is entered
                 daysWithEntries++;
            }
        });

        const grandTotalDecimalHours = grandTotalWorkedMinutes / 60;
        const grandTotalGrossSalary = grandTotalDecimalHours * appSettings.hourlyWage;
        const grandTotalNetSalary = grandTotalGrossSalary * (1 - (appSettings.taxRatePercent / 100));
        const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0;
        const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
        const averageHours = Math.floor(averageWorkedMinutes / 60);
        const averageMinutes = Math.round(averageWorkedMinutes % 60);
        const averageDecimalHours = averageWorkedMinutes / 60;
        const totalHours = Math.floor(grandTotalWorkedMinutes / 60);
        const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60);

        totalSalaryDiv.innerHTML = `
            Počet dní so záznamom: ${daysWithEntries}<br>
            Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(appSettings.decimalPlaces)} h)<br>
            Celková hrubá mzda: ${grandTotalGrossSalary.toFixed(2)}€<br>
            Celková čistá mzda: ${grandTotalNetSalary.toFixed(2)}€<br>
            Priemerná čistá mzda na deň: ${averageNetSalary.toFixed(2)}€<br>
            <strong>Priemerný odpracovaný čas na deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(appSettings.decimalPlaces)} h)</strong>
        `;
    }

    /** Handles input changes in the work data table cells */
    function handleCellInput(inputElement, dayIndex, field) {
        // Format time input HH:MM
        if (inputElement.type === 'tel') {
             let value = inputElement.value.replace(/[^\d:]/g, '');
             if (value.length === 4 && !value.includes(':')) { value = value.slice(0, 2) + ':' + value.slice(2); }
             else if (value.length === 3 && value.charAt(2) !== ':' && parseInt(value.slice(0, 2)) <= 23) { value = value.slice(0, 2) + ':' + value.slice(2); }
             if (value.length > 5) { value = value.slice(0, 5); }
             inputElement.value = value;
        }

        // Ensure data structure exists
        if (!workDaysData[currentYear]) workDaysData[currentYear] = {};
        if (!workDaysData[currentYear][currentMonth]) workDaysData[currentYear][currentMonth] = [];
        // Ensure array has enough elements (pad with empty objects if needed)
        while (workDaysData[currentYear][currentMonth].length < dayIndex) {
            workDaysData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '' });
        }

        // Update data in memory
        workDaysData[currentYear][currentMonth][dayIndex - 1][field] = inputElement.value;

        // Update the calculated values in the specific row UI
        updateTableRowUI(dayIndex);

        // Recalculate totals
        calculateTotalSalary();

        // Save state (debounced)
        debouncedSaveStateToLocalStorage();

        // Auto-tab (optional, can be added back if desired)
         if (field === 'start' && inputElement.value.length === 5 && isTimeValid(inputElement.value)) {
             document.getElementById(`end-${dayIndex}`)?.focus();
         } else if (field === 'end' && inputElement.value.length === 5 && isTimeValid(inputElement.value)) {
             document.getElementById(`break-${dayIndex}`)?.focus();
         } else if (field === 'breakTime' && inputElement.value !== '') { // Move to next day's start
              const nextDayStart = document.getElementById(`start-${dayIndex + 1}`);
              nextDayStart?.focus();
         }
    }

    /** Handles changes in the settings inputs */
    function handleSettingChange(inputElement) {
         const { id, value, type } = inputElement;
         let requiresRecalculation = false;

         switch (id) {
            case 'hourlyWageInput':
                const wage = parseFloat(value);
                if (!isNaN(wage) && wage >= 0) {
                    appSettings.hourlyWage = wage;
                    requiresRecalculation = true;
                }
                break;
            case 'taxRateInput':
                const rate = parseFloat(value);
                 if (!isNaN(rate) && rate >= 0 && rate <= 100) {
                    appSettings.taxRatePercent = rate;
                    requiresRecalculation = true;
                 }
                break;
            case 'decimalPlacesSelect':
                const places = parseInt(value);
                 if (!isNaN(places)) {
                    appSettings.decimalPlaces = places;
                    requiresRecalculation = true; // Need to update display format
                 }
                break;
            case 'employeeNameInput':
                appSettings.employeeName = value;
                updateWelcomeMessage(); // Update greeting immediately
                break;
         }

         if (requiresRecalculation) {
             // Redraw the entire table if decimal places changed, otherwise just update rows/total
             if (id === 'decimalPlacesSelect') {
                  updateWorkDataTable(); // Easiest way to update format everywhere
             } else {
                 // Update all row calculations
                 const daysInTable = getDaysInMonth(currentYear, currentMonth);
                 for (let i = 1; i <= daysInTable; i++) {
                     updateTableRowUI(i);
                 }
                 calculateTotalSalary();
             }
         }
         debouncedSaveStateToLocalStorage();
    }

     /** Resets a single row */
    function resetRow(dayIndex) {
        const startInput = document.getElementById(`start-${dayIndex}`);
        const endInput = document.getElementById(`end-${dayIndex}`);
        const breakInput = document.getElementById(`break-${dayIndex}`);

        if(startInput) startInput.value = '';
        if(endInput) endInput.value = '';
        if(breakInput) breakInput.value = '';

        // Update data in memory
        if (workDaysData[currentYear]?.[currentMonth]?.[dayIndex - 1]) {
             workDaysData[currentYear][currentMonth][dayIndex - 1] = { start: '', end: '', breakTime: '' };
        }

        updateTableRowUI(dayIndex);
        calculateTotalSalary();
        debouncedSaveStateToLocalStorage();
    }

    /** Resets all data for the current month */
    function resetAll() {
        if (confirm(`Naozaj chcete vymazať všetky záznamy pre ${getMonthName(currentMonth)} ${currentYear}?`)) {
            if (workDaysData[currentYear]) {
                workDaysData[currentYear][currentMonth] = []; // Clear data for the month
            }
            updateWorkDataTable(); // Redraw empty table
            calculateTotalSalary(); // Recalculate (should be zero)
            saveStateToLocalStorage(); // Save the empty state immediately
            showSaveNotification("Dáta pre aktuálny mesiac boli vymazané.");
        }
    }

    /** Handles month or year change */
    function handleMonthYearChange() {
        const selectedMonth = parseInt(monthSelect.value);
        const selectedYear = parseInt(yearSelect.value);

        if (selectedMonth !== currentMonth || selectedYear !== currentYear) {
             console.log(`handleMonthYearChange: Changing to ${getMonthName(selectedMonth)} ${selectedYear}`);
             currentMonth = selectedMonth;
             currentYear = selectedYear;
             // Load state for the new month/year from localStorage first
             loadStateFromLocalStorage(); // This will update UI
             // Detach old listener and attach new one if logged in
             if (auth.currentUser) {
                 setupFirestoreListener();
             }
        }
    }

    /** Toggles dark mode */
    function toggleDarkMode() {
        appSettings.darkMode = !appSettings.darkMode;
        applyDarkMode(appSettings.darkMode);
        saveStateToLocalStorage(); // Save setting change immediately
    }

    // --- Firestore Interaction ---

    /** Gets the Firestore document reference for the current user and month/year */
    function getFirestoreDocRef() {
        const uid = auth.currentUser?.uid;
        if (!uid) {
            console.log("getFirestoreDocRef: User not logged in.");
            return null;
        }
        // Ensure month/year are set (should be by now)
        if (currentMonth === undefined || currentYear === undefined) {
            console.error("getFirestoreDocRef: currentMonth or currentYear is undefined!");
            // Attempt to recover from localStorage or defaults
            const storedMonth = localStorage.getItem('currentMonth');
            const storedYear = localStorage.getItem('currentYear');
            currentMonth = storedMonth !== null ? parseInt(storedMonth) : new Date().getMonth();
            currentYear = storedYear !== null ? parseInt(storedYear) : new Date().getFullYear();
        }
        const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
        return db.doc(docPath);
    }

    /** Saves the current month's data and settings to Firestore */
    function saveMonthDataToFirestore() {
        const docRef = getFirestoreDocRef();
        if (!docRef) return;

        const currentMonthLocalData = workDaysData[currentYear]?.[currentMonth] || [];
        const dataToSave = {
            // Include settings in the document as well
            settings: appSettings,
            // Save only the days array for the current month
            days: currentMonthLocalData,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        console.log(`saveMonthDataToFirestore: Saving data for ${docRef.path}`);
        docRef.set(dataToSave, { merge: true }) // Use merge to avoid overwriting other fields if structure changes
            .then(() => {
                console.log(`Firestore save successful for ${docRef.path}.`);
                // Optional: Show subtle success indicator only if online?
                // if(navigator.onLine) showSaveNotification("Synchronizované", "success", 1500);
            })
            .catch(error => {
                console.error(`Firestore save error for ${docRef.path}:`, error);
                showSaveNotification("Chyba synchronizácie s online úložiskom!", "error");
            });
    }

    /** Sets up the Firestore listener for the current month/year */
    function setupFirestoreListener() {
        if (firestoreListenerUnsubscribe) {
            console.log("Detaching previous Firestore listener.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        const docRef = getFirestoreDocRef();
        if (!docRef) return; // Exit if user not logged in or ref failed

        console.log(`setupFirestoreListener: Attaching listener to ${docRef.path}`);
        firestoreListenerUnsubscribe = docRef.onSnapshot(
            (docSnap) => {
                console.log(`Firestore listener: Snapshot received for ${docRef.path}. fromCache: ${docSnap.metadata.fromCache}, hasPendingWrites: ${docSnap.metadata.hasPendingWrites}`);

                if (isSaving) {
                    console.log("Firestore listener: Skipping update during save operation.");
                    return;
                }

                if (!docSnap.exists) {
                    console.log("Firestore listener: Document does not exist.");
                    // If doc doesn't exist on Firestore, ensure local data is cleared for this month
                    // (unless we have local unsaved changes, handled by hasPendingWrites check below)
                    if (!docSnap.metadata.hasPendingWrites) {
                        if (workDaysData[currentYear]?.[currentMonth]?.length > 0) {
                             console.log("Firestore listener: Clearing local data for non-existent Firestore doc.");
                             workDaysData[currentYear][currentMonth] = [];
                             saveStateToLocalStorage(); // Save the cleared state
                             updateWorkDataTable(); // Update UI to be empty
                        }
                         // Ensure settings are loaded from localStorage in case they were missing
                        loadStateFromLocalStorage();
                    } else {
                        console.log("Firestore listener: Document doesn't exist, but has pending writes (likely creating it).");
                    }
                    return;
                }

                const firestoreData = docSnap.data();
                console.log("Firestore data:", firestoreData);
                const firestoreSettings = firestoreData.settings || {};
                const firestoreDays = firestoreData.days || [];

                // --- Compare and Update Logic ---
                let settingsChanged = JSON.stringify(appSettings) !== JSON.stringify(firestoreSettings);
                // Compare only current month's data
                let currentMonthLocalData = workDaysData[currentYear]?.[currentMonth] || [];
                let daysChanged = JSON.stringify(currentMonthLocalData) !== JSON.stringify(firestoreDays);

                // If received data is different from local state AND it's not just reflecting a pending local write
                if ((settingsChanged || daysChanged) && !docSnap.metadata.hasPendingWrites) {
                    console.log("Firestore listener: Detected changes from Firestore. Updating local state.");
                    showSaveNotification("Aktualizujem dáta...", "warning", 1500);

                    // Update local state with data from Firestore
                    appSettings = { ...appSettings, ...firestoreSettings }; // Merge settings, Firestore takes precedence
                    if (!workDaysData[currentYear]) workDaysData[currentYear] = {};
                    workDaysData[currentYear][currentMonth] = firestoreDays;

                    // Save the updated state back to localStorage
                    saveStateToLocalStorage();

                    // Update the UI to reflect the changes from Firestore
                    updateSettingsUI();
                    updateWorkDataTable(); // Redraw table with new data

                } else if (docSnap.metadata.hasPendingWrites) {
                    console.log("Firestore listener: Snapshot reflects local pending writes. No UI update needed from listener.");
                    // Ensure local state is saved (might be redundant but safe)
                    // debouncedSaveStateToLocalStorage(); // Avoid calling save again here
                } else {
                    console.log("Firestore listener: No changes detected compared to local state.");
                }

            },
            (error) => {
                console.error(`Firestore listener error for ${docRef.path}:`, error);
                showSaveNotification("Chyba pripojenia k online úložisku.", "error");
                // Don't detach listener on error, SDK might recover
            }
        );
    }


    // --- Backup & Restore ---
    function createBackup() {
         try {
            // Include all data in the backup
            const backupData = {
                appSettings: appSettings,
                workDaysData: workDaysData,
                // Store current view for convenience, but it's not critical
                currentView: { month: currentMonth, year: currentYear },
                backupVersion: 3, // Increment version if format changes significantly
                backupTimestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bruno-calculator-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSaveNotification("Záloha úspešne vytvorená.");
        } catch (error) {
            console.error("Chyba pri vytváraní zálohy:", error);
            alert("Nastala chyba pri vytváraní záložného súboru.");
        }
    }

    function restoreBackup() {
         const fileInput = document.createElement('input');
         fileInput.type = 'file';
         fileInput.accept = '.json,application/json';
         fileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    // Basic validation for new structure
                    if (backup && typeof backup.appSettings === 'object' && typeof backup.workDaysData === 'object') {

                        // --- Critical: Update state first ---
                        appSettings = backup.appSettings;
                        workDaysData = backup.workDaysData;
                        // Set current view from backup if available, otherwise use last known
                        currentMonth = backup.currentView?.month ?? currentMonth;
                        currentYear = backup.currentView?.year ?? currentYear;
                        // --- ---

                        // --- Save restored state to localStorage ---
                        saveStateToLocalStorage(); // This now also triggers Firestore save if online
                        // --- ---

                        // --- Update UI ---
                        // Ensure year exists in dropdown
                         if (!yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                             populateYearSelect();
                         }
                        updateSettingsUI();      // Updates inputs based on restored appSettings & current view
                        updateWorkDataTable();   // Redraws table based on restored workDaysData & current view
                        // --- ---

                        showSaveNotification("Záloha úspešne obnovená.");
                        alert("Záloha bola úspešne obnovená a uložená.");

                    } else {
                        alert("Chyba: Súbor zálohy má nesprávny formát alebo chýbajú dáta.");
                    }
                } catch (error) {
                    console.error("Chyba pri spracovaní alebo obnove zálohy:", error);
                    alert("Chyba pri čítaní alebo obnove zálohy. Súbor môže byť poškodený alebo mať nesprávny formát.");
                }
            };
            reader.onerror = (e) => { console.error("Chyba pri čítaní súboru zálohy:", e); alert("Nastala chyba pri čítaní súboru zálohy."); };
            reader.readAsText(file);
         };
         fileInput.click();
    }

    // --- PDF Export ---
    function exportToPDF() { /* ... kód bez zásadných zmien, používa appSettings a workDaysData ... */
        console.log("exportToPDF: Spustené..."); if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Knižnica jsPDF alebo autoTable nie je správne načítaná."); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; } const { jsPDF } = window.jspdf; try { const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("Could not load Roboto font for PDF, using default.", e); } doc.setFontSize(18); doc.text(`Bruno's Calculator - Výkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20); doc.setFontSize(12); doc.text(`Meno pracovníka: ${appSettings.employeeName || 'Nezadané'}`, 14, 28); doc.text(`Hodinová mzda: ${appSettings.hourlyWage || 'N/A'} €`, 14, 34); doc.text(`Daň (%): ${appSettings.taxRatePercent || 'N/A'}`, 100, 34); const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované", "Hrubá Mzda (€)", "Čistá Mzda (€)"]; const tableRows = []; const dataForCurrentMonth = workDaysData[currentYear]?.[currentMonth] || []; dataForCurrentMonth.forEach((day, index) => { if (day.start || day.end) { const dayNum = index + 1; const dayName = getDayName(currentYear, currentMonth, dayNum); const { hours, minutes, decimalHours, grossSalary, netSalary } = calculateWorkDetails(day.start, day.end, day.breakTime); const workedTimeText = `${hours}h ${minutes}m (${decimalHours.toFixed(appSettings.decimalPlaces)} h)`; const grossValue = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00'; const netValue = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00'; const rowData = [ `Deň ${dayNum} (${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0', workedTimeText, grossValue, netValue ]; tableRows.push(rowData); } }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName }, styles: { font: doc.getFont().fontName, fontSize: 9 }, alternateRowStyles: { fillColor: [240, 240, 240] } }); const finalY = doc.lastAutoTable.finalY || 40; doc.setFontSize(10); const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, ''); doc.text(totalTextContent, 14, finalY + 10); const pdfFileName = `Vykaz-${appSettings.employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`; doc.save(pdfFileName); showSaveNotification("PDF exportované."); } catch (error) { console.error("Chyba pri generovaní PDF v exportToPDF:", error); alert("Nastala chyba pri vytváraní PDF súboru."); }
    }
    function sendPDF() { /* ... kód bez zásadných zmien, používa appSettings a workDaysData ... */
         console.log("sendPDF: Spustené..."); if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Knižnica jsPDF alebo autoTable nie je správne načítaná."); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; } const { jsPDF } = window.jspdf; try { const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("sendPDF: Could not load Roboto font, using default.", e); } doc.setFontSize(16); doc.text(`Pracovný výkaz - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20); doc.setFontSize(12); doc.text(`Meno pracovníka: ${appSettings.employeeName || 'Nezadané'}`, 14, 28); const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)"]; const tableRows = []; const dataForCurrentMonth = workDaysData[currentYear]?.[currentMonth] || []; dataForCurrentMonth.forEach((day, index) => { if (day.start || day.end) { const dayNum = index + 1; const dayName = getDayName(currentYear, currentMonth, dayNum); const rowData = [ `Deň ${dayNum} (${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0' ]; tableRows.push(rowData); } }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 35, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName }, styles: { font: doc.getFont().fontName, fontSize: 9 }, alternateRowStyles: { fillColor: [240, 240, 240] } }); const finalY = doc.lastAutoTable.finalY || 35; doc.setFontSize(10); const totalSalaryHTML = totalSalaryDiv.innerHTML; let daysWithEntriesText = 'N/A'; const match = totalSalaryHTML.match(/Počet dní so záznamom: (\d+)/); if (match && match[1]) { daysWithEntriesText = match[1]; } const summaryText = `Počet odpracovaných dní: ${daysWithEntriesText}`; doc.text(summaryText, 14, finalY + 10); const pdfBlob = doc.output('blob'); const pdfFileName = `Vykaz_odoslanie-${appSettings.employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`; const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' }); if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) { navigator.share({ files: [pdfFile], title: `Pracovný výkaz ${getMonthName(currentMonth)} ${currentYear}`, text: `Výkaz pre ${appSettings.employeeName || 'pracovníka'} za ${getMonthName(currentMonth)} ${currentYear}.` }).then(() => { showSaveNotification("PDF pripravené na zdieľanie."); }).catch((error) => { if (error.name !== 'AbortError') { console.error('sendPDF: Chyba pri zdieľaní cez Web Share API:', error); alert('Chyba pri zdieľaní súboru.'); } else { console.log('sendPDF: Zdieľanie PDF zrušené používateľom.'); } }); } else { alert("Zdieľanie súborov nie je podporované vaším prehliadačom alebo systémom. Súbor bude stiahnutý."); const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = pdfFileName; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); } } catch (error) { console.error("Chyba pri generovaní alebo zdieľaní PDF v sendPDF:", error); alert("Nastala chyba pri vytváraní alebo zdieľaní PDF súboru."); }
    }

    // --- Online/Offline Status Handling ---
    function handleOfflineStatus() {
        console.log("Status: Offline");
        showSaveNotification("Ste offline. Pracujete s lokálne uloženými dátami.", "warning");
        // No action needed, UI should reflect localStorage already
    }

    function handleOnlineStatus() {
        console.log("Status: Online");
        showSaveNotification("Opäť online. Synchronizujem...", "success");
        // Restart listener to ensure sync with server
        if (auth.currentUser) {
            console.log("handleOnlineStatus: Restarting Firestore listener...");
            setupFirestoreListener();
        }
    }

    // --- App Initialization ---
    function initializeUI() {
         populateYearSelect();
         // Determine initial month/year
         const storedMonth = localStorage.getItem('currentMonth');
         const storedYear = localStorage.getItem('currentYear');
         const date = new Date();
         currentMonth = storedMonth !== null ? parseInt(storedMonth) : date.getMonth();
         currentYear = storedYear !== null ? parseInt(storedYear) : date.getFullYear();
         // Ensure year exists in select
         if (!yearSelect.querySelector(`option[value="${currentYear}"]`)) {
             populateYearSelect(); // Repopulate if needed
         }
         yearSelect.value = currentYear; // Set year value
         monthSelect.value = currentMonth; // Set month value

         // Load initial state from localStorage
         loadStateFromLocalStorage(); // This loads data and updates UI

         // Set up network status listeners
         window.addEventListener('offline', handleOfflineStatus);
         window.addEventListener('online', handleOnlineStatus);
         if (!navigator.onLine) { handleOfflineStatus(); } // Show initial status

         // Set up auth state listener (this will trigger login or load data for logged-in user)
         auth.onAuthStateChanged(handleAuthStateChange);

         // Register service worker
         if ('serviceWorker' in navigator) {
             window.addEventListener('load', () => {
                 navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service worker registered.', reg.scope))
                    .catch(err => console.error('Service worker registration failed:', err));
             });
         } else {
             console.warn("Service Worker not supported.");
         }

         // Hide loading indicator
         loadingContainer.classList.add('hidden');
         console.log("UI Initialized. Waiting for auth state...");
    }

    function handleAuthStateChange(user) {
        console.log("handleAuthStateChange: Auth state changed.", user ? `User: ${user.email}` : "No user.");

        if (firestoreListenerUnsubscribe) {
            console.log("Detaching Firestore listener due to auth change.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        if (user) {
            // User is logged in
            document.getElementById('auth-message').textContent = "Prihlásený: " + user.email;
            authContainer.style.display = "none";
            calculatorContainer.style.display = "block";

            // Load state from localStorage (might have been updated while logged out)
            // This ensures UI reflects the latest local data before listener starts
            loadStateFromLocalStorage();

            // Setup Firestore listener for real-time updates
            setupFirestoreListener();

            // Ensure user document exists (no change here)
             const uid = user.uid; const userDocRef = db.collection("users").doc(uid); userDocRef.get().then(userDocSnap => { if (!userDocSnap.exists) { userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true }).then(() => console.log("User document created/updated for:", uid)).catch(err => console.error("Error creating/updating user document:", err)); } else { console.log("User document exists for:", uid); } }).catch(err => { console.error("Error checking user document:", err); showSaveNotification("Chyba pri overovaní používateľských dát", "error"); });

        } else {
            // User is logged out
            document.getElementById('auth-message').textContent = "Žiadny používateľ nie je prihlásený.";
            authContainer.style.display = "block";
            calculatorContainer.style.display = "none";
            // Keep local data, but no syncing
            console.log("User logged out. Local data preserved.");
            // We might want to clear sensitive data on logout depending on requirements
            // For now, we keep it so login resumes state.
            // Optionally clear UI if needed:
            // workDaysTbody.innerHTML = '';
            // totalSalaryDiv.innerHTML = '';
            // updateWelcomeMessage();
        }
    }


    function populateYearSelect() {
         const startYear = 2020;
         const endYear = new Date().getFullYear() + 2; // Allow a couple of future years
         let currentVal = yearSelect.value; // Preserve current selection if possible
         yearSelect.innerHTML = ''; // Clear existing options
         for (let year = startYear; year <= endYear; year++) {
             const option = document.createElement('option');
             option.value = year;
             option.textContent = year;
             yearSelect.appendChild(option);
         }
         // Try to restore selection
         if (yearSelect.querySelector(`option[value="${currentVal}"]`)) {
             yearSelect.value = currentVal;
         } else if (yearSelect.options.length > 0) {
             // Fallback to the latest year if previous selection is gone
             yearSelect.value = yearSelect.options[yearSelect.options.length - 1].value;
         }
    }


    // --- Start the application ---
    document.addEventListener('DOMContentLoaded', initializeUI);

  </script>
</body>
</html>
