<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* CSS štýly zostávajú rovnaké */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; }
    .settings > div { flex: 1 1 200px; margin: 5px; }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 800px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"] { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode { background-color: #666; color: white; }
    .btn.dark-mode { color: #333; }
    .reset-btn.dark-mode { background-color: #d32f2f; }
    .export-btn.dark-mode { background-color: #388e3c; }
    .restore-btn.dark-mode { background-color: #7B1FA2; }
    .backup-btn.dark-mode { background-color: #E68900; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
    #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
    #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }

    #forgot-password-link {
        display: block;
        margin-top: 15px;
        font-size: 14px;
        color: #007bff;
        text-decoration: none;
        cursor: pointer;
    }
    #forgot-password-link:hover {
        text-decoration: underline;
    }

  </style>
</head>
<body>
  <div id="loading-container"><h1> Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte, dosiahnete všetko. </h1></div>
  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>
    <div class="settings">
      <div><label for="employeeNameInput">Meno pracovníka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()"></div>
      <div><label for="hourlyWageInput">Hodinová mzda (€): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div>
      <div><label for="taxRateInput">Daňové percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"></div>
      <div><label for="monthSelect">Mesiac: </label><select id="monthSelect" onchange="changeMonth()"><option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option><option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option><option value="6">Júl</option><option value="7">August</option><option value="8">September</option><option value="9">Október</option><option value="10">November</option><option value="11">December</option></select></div>
      <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div>
      <div><label for="decimalPlacesSelect">Počet desatinných miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2">2</option></select></div>
      <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>
    <div class="table-container">
      <table>
        <thead><tr><th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka</th><th>Odpracované</th><th>Hrubá Mzda (€)</th><th>Čistá Mzda (€)</th><th>Akcia</th></tr></thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
    </div>
  </div>
  <div id="saveNotification"></div>

  <script>
    // 1. Firebase Config & Init - Nezmenené
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktivácii Firebase App Check:", error); }
    const db = firebase.firestore(); const auth = firebase.auth();

    // 2. Povolenie Firestore Offline Persistence - Nezmenené
    // PRIDANÉ: Premenná na sledovanie stavu perzistencie
    let persistenceEnabled = false;
    db.enablePersistence().then(() => {
        console.log("Firestore offline persistence povolená.");
        persistenceEnabled = true;
    }).catch((err) => {
        console.error("Firestore offline persistence chyba:", err.code, err.message, err);
        if (err.code == 'failed-precondition') { console.warn("Firestore offline persistence: Viacnásobné otvorené taby, povolené len v jednom."); }
        else if (err.code == 'unimplemented') { console.error("Firestore offline persistence: Prehliadač nie je podporovaný."); }
    });

    // 3. Globálne premenné - Nezmenené
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate; let monthData = {}; let firestoreListenerUnsubscribe = null;
    const workDays = document.getElementById('workDays'); const totalSalaryDiv = document.getElementById('totalSalary'); const dataSizeText = document.getElementById('dataSizeText'); const dataSizeFill = document.getElementById('dataSizeFill'); const hourlyWageInput = document.getElementById('hourlyWageInput'); const taxRateInput = document.getElementById('taxRateInput'); const monthSelect = document.getElementById('monthSelect'); const yearSelect = document.getElementById('yearSelect'); const decimalPlacesSelect = document.getElementById('decimalPlacesSelect'); const employeeNameInput = document.getElementById('employeeNameInput'); const MAX_DATA_SIZE = 4 * 1024 * 1024; const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // 4. Auth funkcie (Register, Login, Logout) - Nezmenené
    function register() { const email = document.getElementById('registerEmail').value; const password = document.getElementById('registerPassword').value; auth.createUserWithEmailAndPassword(email, password).then((userCredential) => { console.log("Registrovaný:", userCredential.user); alert("Registrácia úspešná!"); }).catch((error) => { console.error("Chyba pri registrácii:", error.message); alert("Chyba pri registrácii: " + error.message); }); }
    function login() { const email = document.getElementById('loginEmail').value; const password = document.getElementById('loginPassword').value; auth.signInWithEmailAndPassword(email, password).then((userCredential) => { console.log("Prihlásený:", userCredential.user); alert("Prihlásenie úspešné!"); }).catch((error) => { console.error("Chyba pri prihlásení:", error.message); alert("Chyba pri prihlásení: " + error.message); }); }
    function logout() { auth.signOut().then(() => { console.log("Odhlásený."); alert("Odhlásenie úspešné!"); }).catch((error) => { console.error("Chyba pri odhlásení:", error.message); alert("Chyba pri odhlásení: " + error.message); }); }

    // Funkcia Zabudli ste heslo - Nezmenené
    function forgotPassword() {
      const emailInput = document.getElementById('loginEmail');
      const email = emailInput.value;
      if (!email) { alert("Prosím, zadajte svoju e-mailovú adresu do poľa pre prihlásenie."); emailInput.focus(); return; }
      auth.sendPasswordResetEmail(email).then(() => { console.log("E-mail na obnovenie hesla odoslaný na:", email); alert("Odkaz na obnovenie hesla bol odoslaný na vašu e-mailovú adresu. Skontrolujte si prosím poštu (aj priečinok Spam)."); }).catch((error) => { console.error("Chyba pri odosielaní e-mailu na obnovenie hesla:", error); alert("Chyba pri odosielaní e-mailu na obnovenie hesla: " + error.message); });
    }

    // 5. Auth State Change Listener - UPRAVENÉ: Pridaný pokus o explicitné čítanie z cache pri offline štarte
    auth.onAuthStateChanged(user => {
        console.log("onAuthStateChanged: Stav zistený.", user ? `Používateľ: ${user.email}` : "Žiadny používateľ.");
        const authContainer = document.getElementById('auth-container');
        const calculatorContainer = document.getElementById('calculator-container');
        const loadingContainer = document.getElementById('loading-container');
        if (loadingContainer) loadingContainer.classList.add('hidden');

        if (firestoreListenerUnsubscribe) {
            console.log("Odhlasujem predchádzajúci Firestore listener pri zmene Auth stavu.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        if (user) {
            document.getElementById('auth-message').textContent = "Prihlásený: " + user.email;
            authContainer.style.display = "none";
            calculatorContainer.style.display = "block";
            console.log("Používateľ prihlásený, nastavujem základné UI a spúšťam listener...");

            // --- Načítanie a aplikácia IBA NASTAVENÍ z localStorage ---
            const storedMonth = localStorage.getItem('currentMonth');
            const storedYear = localStorage.getItem('currentYear');
            const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
            const currentDate = new Date();
            currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
            currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
            hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
            taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
            decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
            employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

            monthSelect.value = currentMonth;
            if (!yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                console.warn(`Rok ${currentYear} z localStorage nenájdený v selecte, používam aktuálny rok.`);
                currentYear = currentDate.getFullYear();
                populateYearSelect();
            }
            yearSelect.value = currentYear;
            applyDarkMode(darkMode);
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = taxRate * 100;
            decimalPlacesSelect.value = decimalPlaces;
            employeeNameInput.value = employeeName;
            updateWelcomeMessage();
            // --- Koniec načítania nastavení ---

            // Vytvoríme prázdnu štruktúru tabuľky
            createTable();
            totalSalaryDiv.innerHTML = "Načítavam dáta...";

            // Spustíme listener
            console.log("onAuthStateChanged: Spúšťam Firestore listener...");
            setupFirestoreListener(); // Táto funkcia teraz vracia docRef

            // --- ZAČIATOK: Pokus o explicitné čítanie z cache, ak sme offline ---
            if (!navigator.onLine && persistenceEnabled) {
                console.log("onAuthStateChanged: Aplikácia je offline, pokus o explicitné načítanie z cache...");
                // Potrebujeme docRef, setupFirestoreListener ho teraz môže vrátiť
                const docRef = getFirestoreDocRef(); // Pomocná funkcia na získanie ref
                if (docRef) {
                    docRef.get({ source: 'cache' }).then((docSnap) => {
                        console.log("onAuthStateChanged: Výsledok explicitného get({ source: 'cache' })", docSnap.metadata);
                        if (docSnap.exists) {
                            console.log("onAuthStateChanged: Dáta nájdené v cache pri explicitnom get. Spracovávam...");
                            // Spracujeme dáta podobne ako v listeneri, ale bez ukladania do localStorage (to robí listener)
                            // a s kontrolou fokusu, aby sme predišli problémom, ak by sa to spustilo online
                            processFirestoreData(docSnap.data(), false); // false = nie je lokálny zápis
                        } else {
                            console.log("onAuthStateChanged: Dokument nenájdený v cache pri explicitnom get.");
                            // Ak neexistuje ani v cache, necháme stav "Načítavam dáta...", listener to potom potvrdí
                        }
                    }).catch((error) => {
                        console.error("onAuthStateChanged: Chyba pri explicitnom get({ source: 'cache' }):", error);
                    });
                } else {
                     console.error("onAuthStateChanged: Nepodarilo sa získať docRef pre explicitný get z cache.");
                }
            }
            // --- KONIEC: Pokus o explicitné čítanie z cache ---


            // Kontrola/vytvorenie používateľského dokumentu (zostáva)
            const uid = user.uid;
            const userDocRef = db.collection("users").doc(uid);
            userDocRef.get().then(userDocSnap => { /* ... ako predtým ... */
                if (!userDocSnap.exists) { userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true }).then(() => console.log("Vytvorený/aktualizovaný dokument pre:", uid)).catch(err => console.error("Chyba pri vytváraní/aktualizácii dokumentu používateľa:", err)); } else { console.log("Dokument používateľa existuje:", uid); }
            }).catch(err => { /* ... ako predtým ... */
                console.error("Chyba pri kontrole dokumentu používateľa (userDocRef.get):", err); showSaveNotification("Chyba pri overovaní používateľských dát", "error");
            });

        } else {
            // Blok pre odhláseného používateľa zostáva rovnaký
            document.getElementById('auth-message').textContent = "Žiadny používateľ nie je prihlásený.";
            authContainer.style.display = "block";
            calculatorContainer.style.display = "none";
            console.log("Používateľ odhlásený/neprihlásený.");
            monthData = {}; workDays.innerHTML = ''; totalSalaryDiv.innerHTML = ''; updateWelcomeMessage();
        }
    });


    // 6. Utility funkcie (debounce, showSaveNotification) - Nezmenené
    function debounce(func, wait) { let timeout; return function (...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), wait); }; }
    function showSaveNotification(message, type = 'success') { const notification = document.getElementById('saveNotification'); notification.textContent = message; notification.className = 'show'; if (type === 'error') { notification.classList.add('error'); } else if (type === 'warning') { notification.classList.add('warning'); } notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 3000); }

    // --- Funkcie pre pozdrav (Nezmenené) ---
    function getFirstName(fullName) { if (!fullName || typeof fullName !== 'string') { return ''; } const trimmedName = fullName.trim(); if (!trimmedName) { return ''; } const parts = trimmedName.split(' '); return parts[0]; }
    function updateWelcomeMessage() { const welcomeElement = document.getElementById('welcomeMessage'); if (!welcomeElement) return; const firstName = getFirstName(employeeName); if (firstName) { welcomeElement.textContent = `Vitaj, ${firstName}!`; } else { welcomeElement.textContent = ''; } }
    // --- KONIEC funkcií pre pozdrav ---

    // --- NOVÁ POMOCNÁ FUNKCIA ---
    // Pomocná funkcia na získanie referencie na aktuálny dokument
    function getFirestoreDocRef() {
        const uid = auth.currentUser?.uid;
        if (!uid) {
             console.error("getFirestoreDocRef: Používateľ nie je prihlásený.");
             return null;
        }
        // Zabezpečíme, že mesiac a rok sú platné
        if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
             const now = new Date();
             currentMonth = currentMonth ?? parseInt(localStorage.getItem('currentMonth')) ?? now.getMonth();
             currentYear = currentYear ?? parseInt(localStorage.getItem('currentYear')) ?? now.getFullYear();
             console.warn(`getFirestoreDocRef: Mesiac/rok neboli nastavené, použité hodnoty: ${currentMonth}/${currentYear}`);
        }
        const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
        return db.doc(docPath);
    }

    // --- NOVÁ FUNKCIA na spracovanie dát a aktualizáciu UI ---
    // Táto funkcia bude volaná z onSnapshot a z explicitného get({ source: 'cache' })
    // Argument isLocalWrite určuje, či sa má aktualizovať aj UI inputov (true = neaktualizovať)
    function processFirestoreData(data, isLocalWrite) {
        console.log(`processFirestoreData: Spracovávam dáta. isLocalWrite=${isLocalWrite}. Dáta:`, data);
        try {
            const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
            const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
            const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
            const firebaseEmployeeName = data.employeeName ?? employeeName;
            const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');
            const firebaseDaysData = data.days || [];

            // Aktualizácia globálnych premenných (vždy)
            hourlyWage = firebaseHourlyWage;
            taxRate = firebaseTaxRatePercent / 100;
            decimalPlaces = firebaseDecimalPlaces;
            employeeName = firebaseEmployeeName;

            // Aktualizácia monthData v pamäti (vždy)
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '' }));
            console.log(`processFirestoreData: monthData pre ${currentYear}-${currentMonth} aktualizované. Počet dní: ${monthData[currentYear][currentMonth].length}`);

            // Ak nejde o lokálny zápis, aktualizujeme aj localStorage a UI
            if (!isLocalWrite) {
                console.log("processFirestoreData: Aktualizujem localStorage a UI (nejde o lokálny zápis).");
                // Aktualizácia localStorage
                localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                localStorage.setItem('darkMode', JSON.stringify(firebaseDarkMode));
                localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                localStorage.setItem('employeeName', JSON.stringify(employeeName));
                localStorage.setItem('workDaysData', JSON.stringify(monthData)); // Uložíme aktuálne dáta dní

                // Cielená aktualizácia UI s kontrolou fokusu
                const activeElement = document.activeElement;
                const activeElementId = activeElement?.id;

                // 1. Aktualizácia nastavení
                if (activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
                if (activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
                if (activeElement !== decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces;
                if (activeElement !== employeeNameInput) employeeNameInput.value = employeeName;

                // 2. Aktualizácia tabuľky
                const daysInMonth = getDaysInMonth(currentMonth);
                if (workDays.children.length !== daysInMonth) {
                    console.warn("processFirestoreData: Počet riadkov nesedí, prekresľujem tabuľku.");
                    createTable();
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayData = monthData[currentYear]?.[currentMonth]?.[i - 1];
                    const startId = `start-${currentYear}-${currentMonth}-${i}`;
                    const endId = `end-${currentYear}-${currentMonth}-${i}`;
                    const breakId = `break-${currentYear}-${currentMonth}-${i}`;
                    const startElement = document.getElementById(startId);
                    const endElement = document.getElementById(endId);
                    const breakElement = document.getElementById(breakId);

                    if (startElement && endElement && breakElement) {
                        const newStart = dayData?.start || '';
                        const newEnd = dayData?.end || '';
                        const newBreak = dayData?.breakTime || '';
                        if (startElement.value !== newStart && activeElementId !== startId) startElement.value = newStart;
                        if (endElement.value !== newEnd && activeElementId !== endId) endElement.value = newEnd;
                        const currentBreakValue = breakElement.value || '';
                        if (currentBreakValue !== newBreak && activeElementId !== breakId) breakElement.value = newBreak;
                        calculateRow(i);
                    } else if (document.getElementById(`total-${currentYear}-${currentMonth}-${i}`)) {
                         console.warn(`processFirestoreData: Chýbajú input elementy pre deň ${i}.`);
                    } else {
                         console.warn(`processFirestoreData: Riadok pre deň ${i} neexistuje, volám createTable().`);
                         createTable();
                         break; // Po prekreslení tabuľky treba začať odznova
                    }
                }

                // 3. Ostatné aktualizácie
                calculateTotal();
                applyDarkMode(firebaseDarkMode);
                updateWelcomeMessage();
                console.log("processFirestoreData: Cielená aktualizácia UI dokončená.");
            } else {
                 console.log("processFirestoreData: Preskakujem aktualizáciu UI (isLocalWrite=true).");
                 // Pri lokálnom zápise len prepočítame total, ak treba (už by malo byť)
                 calculateTotal();
            }

        } catch (processError) {
            console.error(`processFirestoreData: Chyba pri spracovaní dát:`, processError);
            showSaveNotification("Chyba: Chyba pri spracovaní dát", "error");
        }
    }


    // 7. Funkcia na nastavenie Firestore Listenera - UPRAVENÁ: Používa processFirestoreData
    function setupFirestoreListener() {
        if (firestoreListenerUnsubscribe) {
            console.log("Odhlasujem predchádzajúci Firestore listener.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }
        const docRef = getFirestoreDocRef(); // Použijeme pomocnú funkciu
        if (!docRef) return null; // Ak sa nepodarilo získať ref, skončíme

        console.log(`setupFirestoreListener: Nastavujem listener pre ${docRef.path}`);

        firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
            console.log(`Firestore listener: Prijatý snapshot pre ${docRef.path}. Metadata:`, docSnap.metadata);
            const isLocalWrite = docSnap.metadata.hasPendingWrites;

            if (docSnap.exists) {
                // Spracujeme dáta vždy, funkcia processFirestoreData rozhodne o aktualizácii UI
                processFirestoreData(docSnap.data(), isLocalWrite);

                // Notifikácie podľa zdroja
                if (!isLocalWrite) {
                     if (!docSnap.metadata.fromCache) {
                         console.log("Listener: Dáta prijaté priamo zo SERVERA.");
                         // showSaveNotification("Dáta synchronizované"); // Voliteľné
                     } else {
                         console.log("Listener: Dáta načítané z LOKÁLNEJ CACHE.");
                     }
                } else {
                     console.log("Listener: Detekovaná lokálna zmena (hasPendingWrites=true).");
                }

            } else {
                // Dokument neexistuje
                console.log(`Listener: Dokument neexistuje (potvrdené/cache) na Firebase pre ${docRef.path}.`);
                // Vymažeme dáta pre daný mesiac v pamäti a localStorage
                if (!monthData) monthData = {};
                if (!monthData[currentYear]) monthData[currentYear] = {};
                monthData[currentYear][currentMonth] = [];
                localStorage.setItem('workDaysData', JSON.stringify(monthData)); // Uložíme prázdne pole

                // Zobrazíme prázdnu tabuľku a resetujeme súčty
                createTable();
                calculateTotal();
                console.log("Listener (dokument neexistuje): Zobrazená prázdna tabuľka.");
            }
        }, (error) => {
            console.error(`Firestore listener chyba pre ${docRef.path}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa pripojiť k Firebase", "error");
            // V prípade chyby necháme používateľa s tým, čo má, nezobrazujeme nič ďalšie
        });
        return docRef; // Vrátime ref pre prípadné použitie v onAuthStateChanged
    }


    // 8. Funkcia na ukladanie do Firebase - Nezmenené
    async function saveToFirebase() { const currentUser = auth.currentUser; if (!currentUser) { console.log("saveToFirebase: Nikto nie je prihlásený."); return; } try { const currentMonthWorkData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []; console.log(`saveToFirebase: Ukladám ${currentMonthWorkData.length} záznamov pre ${currentYear}-${currentMonth}.`); const dataToSave = { days: currentMonthWorkData, hourlyWage: hourlyWage || 10, taxRate: (taxRate * 100) || 2, decimalPlaces: decimalPlaces || 1, employeeName: employeeName || '', darkMode: document.body.classList.contains('dark-mode'), timestamp: firebase.firestore.FieldValue.serverTimestamp() }; const yearMonthDoc = `${currentYear}-${currentMonth}`; const uid = currentUser.uid; const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc); await docRef.set(dataToSave); console.log(`saveToFirebase: Požiadavka na uloženie dát pre ${yearMonthDoc} odoslaná/zaradená.`); } catch (error) { console.error(`Chyba pri požiadavke na ukladanie do Firebase pre ${currentYear}-${currentMonth}:`, error); showSaveNotification("Chyba: Nepodarilo sa odoslať dáta do Firebase", "error"); } }

    // 9. Funkcia na ukladanie do Local Storage - Nezmenené
    function saveToLocalStorage() { try { if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; if (!monthData[currentYear][currentMonth]) { monthData[currentYear][currentMonth] = []; console.warn(`saveToLocalStorage: Inicializované prázdne pole pre ${currentYear}-${currentMonth}, lebo chýbalo.`); } localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage)); localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode'))); localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces)); localStorage.setItem('employeeName', JSON.stringify(employeeName)); localStorage.setItem('currentMonth', currentMonth.toString()); localStorage.setItem('currentYear', currentYear.toString()); const serializedMonthData = JSON.stringify(monthData); const bytes = new Blob([serializedMonthData]).size; if (bytes > MAX_DATA_SIZE * 0.9) { console.warn(`Veľkosť dát ('workDaysData') v localStorage sa blíži k limitu: ${bytes} bajtov`); } if (bytes > MAX_DATA_SIZE) { alert(`Prekročili ste maximálnu veľkosť dát (~${MAX_DATA_SIZE_KB} KB) pre dáta mesiacov v localStorage. Ukladanie zlyhalo.`); showSaveNotification("Chyba: Lokálne dáta sú príliš veľké!", "error"); return; } localStorage.setItem('workDaysData', serializedMonthData); updateDataSize(); saveToFirebase(); if (!navigator.onLine) { showSaveNotification("Offline: Zmeny uložené lokálne", "warning"); } } catch (error) { console.error('Chyba pri ukladaní (lokálne/spustení Firebase save):', error); showSaveNotification("Kritická chyba pri ukladaní!", "error"); } }

    // 10. Funkcia na načítanie z Local Storage - Volaná len pri obnove zálohy a potenciálne pri zmene mesiaca/roka pre odhláseného
    function loadFromLocalStorage() {
        console.warn("loadFromLocalStorage: Táto funkcia by sa mala volať len pri obnove zálohy.");
        try {
             // Implementácia zostáva rovnaká, ale použitie je obmedzené
             if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) { const storedMonth = localStorage.getItem('currentMonth'); const storedYear = localStorage.getItem('currentYear'); const currentDate = new Date(); currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth(); currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear(); console.log(`loadFromLocalStorage: Inicializujem mesiac=${currentMonth}, rok=${currentYear}`); } console.log(`loadFromLocalStorage: Načítavam pre ${getMonthName(currentMonth)} ${currentYear}`); const storedMonthData = localStorage.getItem('workDaysData'); monthData = storedMonthData ? JSON.parse(storedMonthData) : {}; if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) { console.log(`loadFromLocalStorage: Načítaných ${monthData[currentYear][currentMonth].length} záznamov pre ${currentYear}-${currentMonth} z localStorage.`); } else { console.log(`loadFromLocalStorage: Pre ${currentYear}-${currentMonth} neboli v localStorage nájdené žiadne záznamy alebo štruktúra chýba.`); } hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10; taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02; const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false; decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1; employeeName = JSON.parse(localStorage.getItem('employeeName')) || ''; updateUIFromLoadedData(darkMode);
         } catch (error) { console.error(`Kritická chyba pri načítavaní/spracovaní dát z localStorage pre ${getMonthName(currentMonth)} ${currentYear}:`, error); showSaveNotification("Chyba pri načítaní lokálnych dát!", "error"); monthData = {}; createTable(); calculateTotal(); }
     }

    // 11. Funkcia na aktualizáciu UI - Nezmenená (volaná z loadFromLocalStorage a processFirestoreData)
    function updateUIFromLoadedData(darkModeValue) {
        console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(currentMonth)} ${currentYear}`);
        try {
            // Aktualizácia nastavení v UI
            hourlyWageInput.value = hourlyWage; taxRateInput.value = taxRate * 100; decimalPlacesSelect.value = decimalPlaces; employeeNameInput.value = employeeName;
            // Kontrola a nastavenie selectov mesiaca a roka
            if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) { monthSelect.value = currentMonth; } else { console.warn(`Mesiac ${currentMonth} nenájdený.`); monthSelect.value = new Date().getMonth(); currentMonth = parseInt(monthSelect.value); }
            if (yearSelect.querySelector(`option[value="${currentYear}"]`)) { yearSelect.value = currentYear; } else { console.warn(`Rok ${currentYear} nenájdený.`); yearSelect.value = new Date().getFullYear(); currentYear = parseInt(yearSelect.value); populateYearSelect(); yearSelect.value = currentYear;}
            // Vytvorenie tabuľky
            createTable();
            // Naplnenie dát do tabuľky
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            console.log(`updateUIFromLoadedData: Plním UI s ${dataForCurrentMonth.length} záznamami.`);
            dataForCurrentMonth.forEach((day, index) => { /* ... plnenie riadkov ... */
                const i = index + 1;
                const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                if (startElement && endElement && breakElement) {
                    startElement.value = day.start || ''; endElement.value = day.end || ''; breakElement.value = day.breakTime || '';
                    calculateRow(i);
                } else { console.error(`Kritická chyba: Elementy pre deň ${i} v updateUIFromLoadedData nenájdené!`); }
            });
            // Ostatné aktualizácie
            calculateTotal(); updateDataSize(); applyDarkMode(darkModeValue); updateWelcomeMessage();
            console.log("UI aktualizované cez updateUIFromLoadedData.");
        } catch (error) { console.error("Chyba počas aktualizácie UI:", error); showSaveNotification("Chyba pri prekresľovaní UI!", "error"); }
    }

    // 12. Funkcia pre aplikovanie Dark Mode - Nezmenené
    function applyDarkMode(isDark) { const elementsToToggle = [ document.body, document.querySelector('.container'), totalSalaryDiv, ...document.querySelectorAll('table, th, td, input'), ...document.querySelectorAll('.btn') ]; const currentDayRow = document.querySelector('.current-day'); if (currentDayRow) elementsToToggle.push(currentDayRow); if (isDark) { elementsToToggle.forEach(el => el?.classList.add('dark-mode')); } else { elementsToToggle.forEach(el => el?.classList.remove('dark-mode')); } }

    // 13) Vytváranie tabuľky (a súvisiace funkcie) - Nezmenené
    function getDayName(year, month, day) { const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"]; return daysOfWeek[new Date(year, month, day).getDay()]; }
    function createTable() { /* ... kód createTable zostáva rovnaký ... */
        console.log(`createTable: Vytváram tabuľku pre ${getMonthName(currentMonth)} ${currentYear}`);
        workDays.innerHTML = ''; const daysInMonth = getDaysInMonth(currentMonth);
        const today = new Date(); const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth(); const currentYearValue = today.getFullYear();
        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) { row.classList.add('current-day'); }
            const dayName = getDayName(currentYear, currentMonth, i);
            row.innerHTML = `<td>Deň ${i} (${dayName})</td><td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${currentYear}-${currentMonth}-${i}', ${i})"></td><td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${currentYear}-${currentMonth}-${i}', ${i})"></td><td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="prestávka" oninput="handleBreakInput(${i})"></td><td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces || 1)} h)</td><td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Hrubá Mzda" readonly></td><td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Čistá Mzda" readonly></td><td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>`;
            workDays.appendChild(row);
        }
        applyDarkMode(document.body.classList.contains('dark-mode'));
    }
    // Input handling funkcie - Nezmenené
    function processInputCompletion(inputId, nextId) { /* ... kód processInputCompletion zostáva rovnaký ... */ calculateTotal(); saveToLocalStorage(); if (document.getElementById(inputId)?.type === 'tel' && document.getElementById(inputId).value.length === 5 && isTimeValid(document.getElementById(inputId).value)) { moveNext(document.getElementById(inputId), nextId); } else if (document.getElementById(inputId)?.type === 'number' && inputId.startsWith('break-')) { moveNext(document.getElementById(inputId), nextId); } }
    const debouncedProcessInputCompletion = debounce(processInputCompletion, 500);
    function isTimeValid(timeStr) { const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeStr); }
    function handleInput(input, nextId, day) { formatInput(input); updateMonthDataFromInput(input, day); calculateRow(day); debouncedProcessInputCompletion(input.id, nextId); }
    function handleBreakInput(day) { const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); updateMonthDataFromInput(input, day); calculateRow(day); const nextDay = day + 1; let nextInputElementId = null; if (nextDay <= getDaysInMonth(currentMonth)) { nextInputElementId = `start-${currentYear}-${currentMonth}-${nextDay}`; } debouncedProcessInputCompletion(input.id, nextInputElementId); }
    function updateMonthDataFromInput(input, day) { /* ... kód updateMonthDataFromInput zostáva rovnaký ... */ if (!input) return; const dayIndex = day - 1; const fieldId = input.id; let field = 'unknown'; if (fieldId.startsWith('start-')) field = 'start'; else if (fieldId.startsWith('end-')) field = 'end'; else if (fieldId.startsWith('break-')) field = 'breakTime'; const value = input.value; if (field !== 'unknown') { if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = []; while (monthData[currentYear][currentMonth].length <= dayIndex) { monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '' }); } if (monthData[currentYear][currentMonth][dayIndex]) { monthData[currentYear][currentMonth][dayIndex][field] = value; } else { console.error(`updateMonthDataFromInput: Chýba záznam pre deň ${dayIndex} v monthData.`); monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', [field]: value }; } } else { console.warn("updateMonthDataFromInput: Nerozpoznané pole pre input ID:", fieldId); } }
    function formatInput(input) { /* ... kód formatInput zostáva rovnaký ... */ if (!input || input.type !== 'tel') return; let value = input.value.replace(/[^\d:]/g, ''); if (value.length === 4 && !value.includes(':')) { value = value.slice(0, 2) + ':' + value.slice(2); } else if (value.length === 3 && value.charAt(2) !== ':' && parseInt(value.slice(0, 2)) <= 23) { value = value.slice(0, 2) + ':' + value.slice(2); } if (value.length > 5) { value = value.slice(0, 5); } input.value = value; if (value.length > 0 && value.length < 5) { input.style.border = ''; } else if (value.length === 5) { if (isTimeValid(value)) { input.style.border = ''; } else { input.style.border = '1px solid red'; setTimeout(() => { input.style.border = ''; }, 2000); } } else { input.style.border = ''; } }
    function moveNext(currentElement, nextId) { /* ... kód moveNext zostáva rovnaký ... */ if (!nextId || !currentElement) return; const nextElement = document.getElementById(nextId); if (nextElement) { if (document.activeElement === currentElement) { nextElement.focus(); if (nextElement.select) { nextElement.select(); } } } }
    function calculateRow(day) { /* ... kód calculateRow zostáva rovnaký ... */ const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value; const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value; const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const breakTime = parseFloat(breakTimeInput?.value) || 0; const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!totalCell || !grossElement || !netElement) { return; } if (!startTimeStr || !endTimeStr) { totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`; grossElement.value = '0.00'; netElement.value = '0.00'; return; } const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; if (!timeRegex.test(startTimeStr) || !timeRegex.test(endTimeStr)) { totalCell.textContent = 'Neplatný čas'; grossElement.value = '0.00'; netElement.value = '0.00'; return; } const [startHours, startMinutes] = startTimeStr.split(':').map(Number); const [endHours, endMinutes] = endTimeStr.split(':').map(Number); const startTotalMinutes = startHours * 60 + startMinutes; let endTotalMinutes = endHours * 60 + endMinutes; if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; } const diffMinutes = endTotalMinutes - startTotalMinutes; const breakMinutes = breakTime * 60; const workedMinutes = Math.max(0, diffMinutes - breakMinutes); const hours = Math.floor(workedMinutes / 60); const minutes = Math.round(workedMinutes % 60); const decimalHours = (workedMinutes / 60); totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces || 1)} h)`; const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate; const grossSalary = decimalHours * currentHourlyWage; grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00'; const netSalary = grossSalary * (1 - currentTaxRate); netElement.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00'; }
    function resetRow(day) { /* ... kód resetRow zostáva rovnaký ... */ const dayIndex = day - 1; const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const total = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const net = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (start && end && breakTime && total && gross && net) { start.value = ''; end.value = ''; breakTime.value = ''; total.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`; gross.value = '0.00'; net.value = '0.00'; if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = []; while (monthData[currentYear][currentMonth].length <= dayIndex) { monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '' }); } if (monthData[currentYear][currentMonth][dayIndex]) { monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '' }; } else { console.error(`resetRow: Chýba záznam pre deň ${dayIndex} v monthData.`); } debouncedProcessInputCompletion(`reset-${day}`, null); } }
    function resetAll() { /* ... kód resetAll zostáva rovnaký ... */ if (confirm('Naozaj chcete resetovať všetky záznamy pre tento mesiac?')) { if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = []; createTable(); calculateTotal(); debouncedProcessInputCompletion('reset-all', null); showSaveNotification("Dáta pre aktuálny mesiac boli resetované."); } }

    // 14) Výpočet celkových súčtov - Nezmenené
    function calculateTotal() { /* ... kód calculateTotal zostáva rovnaký ... */ let grandTotalWorkedMinutes = 0; let daysWithEntries = 0; const rows = workDays.querySelectorAll('tr'); const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate; const currentDecimalPlaces = decimalPlaces || 1; rows.forEach((row, index) => { const dayIndex = index + 1; const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`)?.value; const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`)?.value; const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`); if (startTimeStr && endTimeStr) { const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; if (timeRegex.test(startTimeStr) && timeRegex.test(endTimeStr)) { const breakTime = parseFloat(breakTimeInput?.value) || 0; const [startHours, startMinutes] = startTimeStr.split(':').map(Number); const [endHours, endMinutes] = endTimeStr.split(':').map(Number); const startTotalMinutes = startHours * 60 + startMinutes; let endTotalMinutes = endHours * 60 + endMinutes; if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; } const diffMinutes = endTotalMinutes - startTotalMinutes; const breakMinutes = breakTime * 60; const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes); grandTotalWorkedMinutes += workedMinutesForRow; if (workedMinutesForRow > 0 || (startTimeStr && endTimeStr)) { daysWithEntries++; } } } }); const grandTotalDecimalHours = grandTotalWorkedMinutes / 60; const grandTotalGrossSalary = grandTotalDecimalHours * currentHourlyWage; const grandTotalNetSalary = grandTotalGrossSalary * (1 - currentTaxRate); const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0; const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0; const averageHours = Math.floor(averageWorkedMinutes / 60); const averageMinutes = Math.round(averageWorkedMinutes % 60); const averageDecimalHours = (averageWorkedMinutes / 60); const totalHours = Math.floor(grandTotalWorkedMinutes / 60); const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60); totalSalaryDiv.innerHTML = `Počet odpracovaných dní: ${daysWithEntries}<br>Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(currentDecimalPlaces)} h)<br>Celková hrubá mzda: ${grandTotalGrossSalary.toFixed(2)}€<br>Celková čistá mzda: ${grandTotalNetSalary.toFixed(2)}€<br>Priemerná čistá mzda na deň: ${averageNetSalary.toFixed(2)}€<br><strong>Priemerný odpracovaný čas na deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(currentDecimalPlaces)} h)</strong>`; }

    // 15) Export do PDF (exportToPDF, sendPDF) - Nezmenené
    function exportToPDF() { /* ... kód exportToPDF zostáva rovnaký ... */ }
    function sendPDF() { /* ... kód sendPDF zostáva rovnaký ... */ }

    // 16) Ostatné nastavenia - Nezmenené
    function changeDecimalPlaces() { const newDecimalPlaces = parseInt(decimalPlacesSelect.value); if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) { decimalPlaces = newDecimalPlaces; calculateTotal(); debouncedProcessInputCompletion('settings-change', null); } }
    function updateEmployeeName() { employeeName = employeeNameInput.value; updateWelcomeMessage(); debouncedProcessInputCompletion('settings-change', null); }
    function updateSettings() { /* ... kód updateSettings zostáva rovnaký ... */ const newHourlyWageStr = hourlyWageInput.value; const newTaxRateStr = taxRateInput.value; const newHourlyWage = parseFloat(newHourlyWageStr); const newTaxRatePercent = parseFloat(newTaxRateStr); let hourlyWageChanged = false; let taxRateChanged = false; if (!isNaN(newHourlyWage) && newHourlyWage >= 0) { if (hourlyWage !== newHourlyWage) { hourlyWage = newHourlyWage; hourlyWageChanged = true; } } if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) { const newTaxRateDecimal = newTaxRatePercent / 100; if (taxRate !== newTaxRateDecimal) { taxRate = newTaxRateDecimal; taxRateChanged = true; } } calculateTotal(); if (hourlyWageChanged || taxRateChanged) { debouncedProcessInputCompletion('settings-change', null); } }
    function changeMonth() { const selectedMonth = parseInt(monthSelect.value); if (currentMonth !== selectedMonth) { currentMonth = selectedMonth; console.log(`Zmenený mesiac na: ${getMonthName(currentMonth)}`); handleMonthYearChange(); } }
    function changeYear() { const selectedYear = parseInt(yearSelect.value); if (currentYear !== selectedYear) { currentYear = selectedYear; console.log(`Zmenený rok na: ${currentYear}`); handleMonthYearChange(); } }
    // UPRAVENÉ: handleMonthYearChange reštartuje listener
    function handleMonthYearChange() {
        console.log(`handleMonthYearChange: Spustené pre ${getMonthName(currentMonth)} ${currentYear}`);
        localStorage.setItem('currentMonth', currentMonth.toString());
        localStorage.setItem('currentYear', currentYear.toString());
        // Zobrazíme prázdnu tabuľku a placeholder, kým listener nenačíta nové dáta
        createTable();
        totalSalaryDiv.innerHTML = "Načítavam dáta...";
        if (auth.currentUser) {
            // Reštartujeme listener pre nový mesiac/rok
            setupFirestoreListener();
            // Pridáme pokus o explicitné čítanie z cache, ak sme offline
            if (!navigator.onLine && persistenceEnabled) {
                 console.log("handleMonthYearChange: Offline, pokus o explicitné načítanie z cache...");
                 const docRef = getFirestoreDocRef();
                 if (docRef) {
                     docRef.get({ source: 'cache' }).then((docSnap) => {
                         if (docSnap.exists) {
                             console.log("handleMonthYearChange: Cache get úspešný.");
                             processFirestoreData(docSnap.data(), false);
                         } else { console.log("handleMonthYearChange: Dokument nenájdený v cache."); }
                     }).catch((error) => { console.error("handleMonthYearChange: Cache get chyba:", error); });
                 }
            }
        } else {
            console.log("handleMonthYearChange: Používateľ nie je prihlásený.");
        }
    }
    function getDaysInMonth(month) { if (month === undefined || month === null || currentYear === undefined || currentYear === null) { console.warn("getDaysInMonth: Chýba mesiac alebo rok, vraciam 31."); return 31; } return new Date(currentYear, month + 1, 0).getDate(); }
    function getMonthName(month) { const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"]; return monthNames[month] || 'Neznámy'; }
    function updateDataSize() { /* ... kód updateDataSize zostáva rovnaký ... */ }
    function toggleDarkMode() { const isDarkMode = document.body.classList.toggle('dark-mode'); applyDarkMode(isDarkMode); localStorage.setItem('darkMode', JSON.stringify(isDarkMode)); if (auth.currentUser) { saveToFirebase(); } }

    // 17) Zálohovanie a obnova - Nezmenené
    function createBackup() { /* ... kód createBackup zostáva rovnaký ... */ }
    function restoreBackup() { /* ... kód restoreBackup zostáva rovnaký ... */ }

    // 18) Inicializácia - Pridané online/offline listenery
     document.addEventListener('DOMContentLoaded', () => {
         console.log("DOM načítaný, inicializujem...");
         populateYearSelect();
         const initialDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
         applyDarkMode(initialDarkMode);
         updateWelcomeMessage();

         // --- NOVÉ: Online/Offline Listenery ---
         window.addEventListener('offline', handleOfflineStatus);
         window.addEventListener('online', handleOnlineStatus);
         // Zobraziť počiatočný stav
         if (!navigator.onLine) {
             handleOfflineStatus();
         }
         // --- KONIEC: Online/Offline Listenery ---

         if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(registration => { console.log('ServiceWorker zaregistrovaný s rozsahom: ', registration.scope); }).catch(error => { console.error('Registrácia ServiceWorker zlyhala: ', error); }); }); } else { console.warn("Service Worker nie je podporovaný v tomto prehliadači."); }
         console.log("Základná inicializácia dokončená, čakám na stav prihlásenia (onAuthStateChanged)...");
     });

     function populateYearSelect() { const startYear = 2020; const endYear = new Date().getFullYear() + 2; yearSelect.innerHTML = ''; for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); } }

     // --- NOVÉ: Funkcie pre Online/Offline stav ---
     function handleOfflineStatus() {
         console.log("Status: Offline");
         showSaveNotification("Ste offline. Zobrazujú sa posledné dostupné dáta.", "warning");
         // Pokus o explicitné načítanie z cache, ak je používateľ prihlásený
         if (auth.currentUser && persistenceEnabled) {
             console.log("handleOfflineStatus: Pokus o explicitné načítanie z cache...");
             const docRef = getFirestoreDocRef();
             if (docRef) {
                 docRef.get({ source: 'cache' }).then((docSnap) => {
                     if (docSnap.exists) {
                         console.log("handleOfflineStatus: Cache get úspešný.");
                         // Skontrolujeme, či dáta v UI už zodpovedajú cache, aby sme zbytočne neprekresľovali
                         const dataFromCache = docSnap.data();
                         const currentDataInUI = monthData && monthData[currentYear] && monthData[currentYear][currentMonth];
                         // Jednoduché porovnanie počtu dní ako heuristika (mohlo by byť lepšie)
                         if (!currentDataInUI || currentDataInUI.length !== (dataFromCache.days || []).length) {
                            console.log("handleOfflineStatus: Dáta v UI sa líšia od cache, spracovávam dáta z cache...");
                            processFirestoreData(dataFromCache, false);
                         } else {
                            console.log("handleOfflineStatus: Dáta v UI už pravdepodobne zodpovedajú cache.");
                         }
                     } else { console.log("handleOfflineStatus: Dokument nenájdený v cache."); }
                 }).catch((error) => { console.error("handleOfflineStatus: Cache get chyba:", error); });
             }
         }
     }

     function handleOnlineStatus() {
         console.log("Status: Online");
         showSaveNotification("Opäť online. Synchronizujem...", "success");
         // Voliteľne môžeme reštartovať listener, aby sme si boli istí čerstvými dátami
         if (auth.currentUser) {
             console.log("handleOnlineStatus: Reštartujem Firestore listener...");
             setupFirestoreListener();
         }
     }
     // --- KONIEC: Funkcie pre Online/Offline stav ---

  </script>
</body>
</html>
