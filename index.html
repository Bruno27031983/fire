<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator v2</title> <!-- Zmenen√Ω titulok pre odl√≠≈°enie -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase & PDF kni≈ænice (bez zmien) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* CSS (bez zmien) */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .settings > div, .settings > details, .settings > button { flex: 1 1 200px; margin: 0; }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 900px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
    th:nth-child(1), td:nth-child(1) { min-width: 50px; } th:nth-child(2), td:nth-child(2) { min-width: 80px; } th:nth-child(3), td:nth-child(3) { min-width: 80px; } th:nth-child(4), td:nth-child(4) { min-width: 80px; } th:nth-child(5), td:nth-child(5) { min-width: 120px; } th:nth-child(6), td:nth-child(6) { min-width: 90px; } th:nth-child(7), td:nth-child(7) { min-width: 90px; } th:nth-child(8), td:nth-child(8) { min-width: 120px; } th:last-child, td:last-child { min-width: 90px; text-align: center; }
    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input, .current-day .note-textarea { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode { background-color: #666; color: white; border-color: #888; }
    .btn.dark-mode { color: #333; }
    .reset-btn.dark-mode { background-color: #d32f2f; }
    .export-btn.dark-mode { background-color: #388e3c; }
    .restore-btn.dark-mode { background-color: #7B1FA2; }
    .backup-btn.dark-mode { background-color: #E68900; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input, .current-day.dark-mode .note-textarea { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
    #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
    #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }
    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
    .collapsible-settings summary:hover { background-color: #eee; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
    body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
    body.dark-mode .collapsible-content { border-top-color: #666; }
    .note-container { display: none; margin-top: 5px; }
    .note-container.visible { display: block; }
    .note-textarea { width: 95%; min-height: 40px; resize: vertical; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; background-color: #f0f0f0; }
    .toggle-note-btn { background-color: #6c757d; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease; margin-bottom: 2px; }
    .toggle-note-btn:hover { background-color: #5a6268; }
    .note-textarea.dark-mode { background-color: #555; color: #f4f4f4; border-color: #777; }
    .toggle-note-btn.dark-mode { background-color: #828a91; }
    .toggle-note-btn.dark-mode:hover { background-color: #70777d; }
    /* Pridan√© pre event delegation - identifik√°cia elementov */
    [data-day] { /* Atrib√∫t prid√°me na TR */ }
    [data-action] { /* Atrib√∫t prid√°me na buttony/inputy */ }
    [data-field] { /* Atrib√∫t prid√°me na inputy/textarea */ }
    .invalid-time { border: 1px solid red !important; } /* Lep≈°ie ako inline ≈°t√Ωl */
  </style>
</head>
<body>
  <div id="loading-container"><h1> Tajomstvo √∫spechu je slu≈°nos≈• a √∫primnos≈•. Akon√°hle sa ich zbav√≠te, dosiahnete v≈°etko. </h1></div>

  <!-- Auth Container (HTML bez zmien, JS handlery sa presun√∫) -->
  <div id="auth-container" style="display:none;">
    <h1>Prihl√°senie / Registr√°cia</h1>
    <div id="auth-message">≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.</div>
    <div id="auth-forms">
      <h2>Registr√°cia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button id="registerButton">Registrova≈•</button> <!-- Pridan√© ID -->
      <h2>Prihl√°senie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button id="loginButton">Prihl√°si≈• sa</button> <!-- Pridan√© ID -->
      <a id="forgot-password-link" href="#">Zabudli ste heslo?</a> <!-- Odstr√°nen√Ω onclick -->
    </div>
  </div>

  <!-- Calculator Container (HTML bez on... handlerov) -->
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator v2</h1>
    <h2 id="welcomeMessage"></h2>
    <div class="settings">
        <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect"> <!-- Odstr√°nen√Ω onchange -->
                <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
                <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
                <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
                <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
            </select>
        </div>
        <details class="collapsible-settings">
            <summary>ƒéal≈°ie nastavenia</summary>
            <div class="collapsible-content">
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka: </label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka"> <!-- Odstr√°nen√Ω oninput -->
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
                    <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1"> <!-- Odstr√°nen√Ω oninput -->
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%): </label>
                    <input type="number" id="taxRateInput" value="2" min="0" step="0.1"> <!-- Odstr√°nen√Ω oninput -->
                </div>
                <div>
                    <label for="yearSelect">Rok: </label>
                    <select id="yearSelect"></select> <!-- Odstr√°nen√Ω onchange -->
                </div>
                <div>
                    <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
                    <select id="decimalPlacesSelect"> <!-- Odstr√°nen√Ω onchange -->
                        <option value="1">1</option> <option value="2">2</option>
                    </select>
                </div>
            </div>
        </details>
        <button id="toggleDarkModeButton" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button> <!-- Pridan√© ID -->
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th> <th>Pr√≠chod</th> <th>Odchod</th> <th>Prest√°vka</th>
            <th>Odpracovan√©</th> <th>Hrub√° Mzda (‚Ç¨)</th> <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th class="th-note">Pozn√°mka</th> <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody> <!-- Tu budeme delegova≈• eventy -->
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lok√°lne √∫lo≈æisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button id="resetAllButton" class="btn reset-btn">Resetova≈• v≈°etko</button> <!-- Pridan√© ID -->
      <button id="exportPdfButton" class="btn export-btn">Exportova≈• do PDF</button> <!-- Pridan√© ID -->
      <button id="sendPdfButton" class="btn export-btn">Odosla≈•</button> <!-- Pridan√© ID -->
      <button id="restoreBackupButton" class="btn restore-btn">Obnovi≈• z√°lohu</button> <!-- Pridan√© ID -->
      <button id="createBackupButton" class="btn backup-btn">Vytvori≈• z√°lohu</button> <!-- Pridan√© ID -->
      <button id="logoutButton" class="btn reset-btn">Odhl√°si≈• sa</button> <!-- Pridan√© ID -->
    </div>
  </div>
  <div id="saveNotification"></div>

  <script>
    // --- Kon≈°tanty ---
    const MAX_DATA_SIZE_KB = 4096;
    const MAX_DATA_SIZE = MAX_DATA_SIZE_KB * 1024;
    const LS_KEYS = { // LocalStorage Keys
        WORK_DATA: 'workDaysData',
        HOURLY_WAGE: 'hourlyWage',
        TAX_RATE: 'taxRate',
        DARK_MODE: 'darkMode',
        DECIMAL_PLACES: 'decimalPlaces',
        EMPLOYEE_NAME: 'employeeName',
        CURRENT_MONTH: 'currentMonth',
        CURRENT_YEAR: 'currentYear'
    };
    const DEFAULT_VALUES = {
        HOURLY_WAGE: 10,
        TAX_RATE_PERCENT: 2,
        DECIMAL_PLACES: 1,
        DARK_MODE: false,
        EMPLOYEE_NAME: '',
    };
    const CSS_CLASSES = {
        DARK_MODE: 'dark-mode',
        CURRENT_DAY: 'current-day',
        NOTE_VISIBLE: 'visible',
        INVALID_TIME: 'invalid-time',
    };
    const FIREBASE_COLLECTION = "calculatorData";
    const TIME_REGEX = /^([01]\d|2[0-3]):([0-5]\d)$/;
    const MONTH_NAMES = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
    const DAYS_OF_WEEK = ["Nedeƒæa", "Pondelok", "Utorok", "Streda", "≈†tvrtok", "Piatok", "Sobota"];

    // --- Firebase Inicializ√°cia ---
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try {
        firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true);
    } catch (error) {
        console.warn("Chyba pri aktiv√°cii Firebase App Check:", error);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Povolenie Offline Persistence
    db.enablePersistence().then(() => {
        console.log("Firestore offline persistence povolen√°.");
    }).catch((err) => {
        console.error("Firestore offline persistence chyba:", err.code, err.message);
        if (err.code === 'failed-precondition') {
            console.warn("Firestore offline persistence: Viacn√°sobn√© otvoren√© taby, povolen√© len v jednom.");
        } else if (err.code === 'unimplemented') {
            console.warn("Firestore offline persistence: Prehliadaƒç nie je podporovan√Ω."); // Warn namiesto Error
        }
    });

    // --- Glob√°lny stav aplik√°cie ---
    let state = {
        currentMonth: new Date().getMonth(),
        currentYear: new Date().getFullYear(),
        decimalPlaces: DEFAULT_VALUES.DECIMAL_PLACES,
        employeeName: DEFAULT_VALUES.EMPLOYEE_NAME,
        hourlyWage: DEFAULT_VALUES.HOURLY_WAGE,
        taxRate: DEFAULT_VALUES.TAX_RATE_PERCENT / 100,
        monthData: {}, // { year: { month: [dayData1, dayData2, ...] } }
        firestoreListenerUnsubscribe: null,
        isDarkMode: DEFAULT_VALUES.DARK_MODE,
        currentUser: null,
        activeElementId: null, // Na sledovanie fokusu pri Firestore update
    };

    // --- DOM Elementy (Cachovan√©) ---
    let uiElements; // Inicializovan√© v DOMContentLoaded

    // --- Utility Funkcie ---
    const showSaveNotification = (message, type = 'success') => {
        if (!uiElements?.saveNotification) return;
        const notification = uiElements.saveNotification;
        notification.textContent = message;
        notification.className = 'show'; // Reset class
        if (type === 'error') notification.classList.add('error');
        else if (type === 'warning') notification.classList.add('warning');
        notification.classList.add('show');
        setTimeout(() => notification.classList.remove('show'), 3000);
    };

    const getFirstName = (fullName) => {
        if (!fullName || typeof fullName !== 'string') return '';
        const trimmedName = fullName.trim();
        return trimmedName ? trimmedName.split(' ')[0] : '';
    };

    const updateWelcomeMessage = () => {
        if (!uiElements?.welcomeMessage) return;
        const firstName = getFirstName(state.employeeName);
        uiElements.welcomeMessage.textContent = firstName ? `Vitaj sp√§≈•, ${firstName}! üëã` : '';
    };

    const getDaysInMonth = (month, year) => {
        if (month === undefined || month === null || year === undefined || year === null) {
            console.warn("getDaysInMonth: Ch√Ωba mesiac alebo rok, vraciam 31.");
            return 31;
        }
        // Mesiac je 0-indexovan√Ω, pre Date potrebujeme +1
        return new Date(year, month + 1, 0).getDate();
    };

    const getMonthName = (month) => MONTH_NAMES[month] || 'Nezn√°my';
    const getDayName = (year, month, day) => DAYS_OF_WEEK[new Date(year, month, day).getDay()];

    const isTimeValid = (timeStr) => TIME_REGEX.test(timeStr);

    const parseTimeToMinutes = (timeStr) => {
        if (!isTimeValid(timeStr)) return 0;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    };

    const formatMinutesToHoursMinutes = (totalMinutes) => {
        if (isNaN(totalMinutes) || totalMinutes <= 0) return { h: 0, m: 0, dec: 0 };
        const hours = Math.floor(totalMinutes / 60);
        const minutes = Math.round(totalMinutes % 60);
        const decimalHours = totalMinutes / 60;
        return { h: hours, m: minutes, dec: decimalHours };
    };

    // Bezpeƒçnej≈°√≠ pr√≠stup k d√°tam mesiaca
    const getCurrentMonthData = (createIfNotExists = false) => {
        if (!state.monthData[state.currentYear]) {
            if (!createIfNotExists) return [];
            state.monthData[state.currentYear] = {};
        }
        if (!state.monthData[state.currentYear][state.currentMonth]) {
            if (!createIfNotExists) return [];
            state.monthData[state.currentYear][state.currentMonth] = [];
        }
        return state.monthData[state.currentYear][state.currentMonth];
    };

    // Bezpeƒçnej≈°√≠ pr√≠stup k d√°tam d≈àa
    const getDayData = (dayIndex, createIfNotExists = false) => {
        const monthArray = getCurrentMonthData(createIfNotExists);
        if (dayIndex >= monthArray.length) {
            if (!createIfNotExists) return null;
            // Dopl≈à ch√Ωbaj√∫ce dni pr√°zdnymi objektami
            while (dayIndex >= monthArray.length) {
                monthArray.push({ start: '', end: '', breakTime: '', note: '' });
            }
        }
        return monthArray[dayIndex];
    };


    // --- Perzistencia (LocalStorage & Firebase) ---

    const updateDataSize = () => {
        if (!uiElements?.dataSizeText || !uiElements?.dataSizeFill) return;
        try {
            const totalData = Object.entries(localStorage).reduce((acc, [key, value]) => acc + (key?.length || 0) + (value?.length || 0), 0);
            const kilobytes = (totalData / 1024).toFixed(2);
            const percentageUsed = Math.min(((totalData / MAX_DATA_SIZE) * 100), 100);

            uiElements.dataSizeText.textContent = `Lok√°lne √∫lo≈æisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
            uiElements.dataSizeFill.style.width = `${percentageUsed}%`;

            let barColor = '#4CAF50'; // Zelen√°
            if (percentageUsed > 90) barColor = '#f44336'; // ƒåerven√°
            else if (percentageUsed > 70) barColor = '#ff9800'; // Oran≈æov√°
            uiElements.dataSizeFill.style.backgroundColor = barColor;

        } catch (error) {
            console.error("Chyba pri v√Ωpoƒçte veƒækosti localStorage:", error);
            uiElements.dataSizeText.textContent = "Chyba pri v√Ωpoƒçte veƒækosti d√°t.";
        }
    };

    const saveToFirebase = async () => {
        if (!state.currentUser) return;
        const uid = state.currentUser.uid;
        const yearMonthDoc = `${state.currentYear}-${state.currentMonth}`;
        const docRef = db.collection("users").doc(uid).collection(FIREBASE_COLLECTION).doc(yearMonthDoc);

        const currentMonthWorkData = getCurrentMonthData() || []; // Z√≠skaj aktu√°lne d√°ta
        const dataToSave = {
            days: currentMonthWorkData,
            hourlyWage: state.hourlyWage,
            taxRate: state.taxRate * 100, // Ukladaj ako percento
            decimalPlaces: state.decimalPlaces,
            employeeName: state.employeeName,
            darkMode: state.isDarkMode,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await docRef.set(dataToSave);
            // console.log(`D√°ta pre ${yearMonthDoc} √∫spe≈°ne ulo≈æen√© do Firebase.`); // Len pre debug
        } catch (error) {
            console.error(`Chyba pri ukladan√≠ do Firebase pre ${yearMonthDoc}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa odosla≈• d√°ta na server", "error");
        }
    };

    const saveData = () => {
        try {
            // Ulo≈æenie nastaven√≠
            localStorage.setItem(LS_KEYS.HOURLY_WAGE, JSON.stringify(state.hourlyWage));
            localStorage.setItem(LS_KEYS.TAX_RATE, JSON.stringify(state.taxRate * 100)); // Ukladaj ako percento
            localStorage.setItem(LS_KEYS.DARK_MODE, JSON.stringify(state.isDarkMode));
            localStorage.setItem(LS_KEYS.DECIMAL_PLACES, JSON.stringify(state.decimalPlaces));
            localStorage.setItem(LS_KEYS.EMPLOYEE_NAME, JSON.stringify(state.employeeName));
            localStorage.setItem(LS_KEYS.CURRENT_MONTH, state.currentMonth.toString());
            localStorage.setItem(LS_KEYS.CURRENT_YEAR, state.currentYear.toString());

            // Ulo≈æenie d√°t o pracovn√Ωch d≈àoch (cel√Ω objekt monthData)
            const serializedMonthData = JSON.stringify(state.monthData);
            const bytes = new Blob([serializedMonthData]).size;

            if (bytes > MAX_DATA_SIZE * 0.95) { // Zv√Ω≈°en√° hranica pre warning
                 console.warn(`Veƒækos≈• d√°t ('${LS_KEYS.WORK_DATA}') v localStorage sa bl√≠≈æi k limitu: ${bytes} bajtov`);
                 showSaveNotification("Varovanie: Lok√°lne √∫lo≈æisko je takmer pln√©!", "warning");
            }
            if (bytes > MAX_DATA_SIZE) {
                alert(`Prekroƒçili ste maxim√°lnu veƒækos≈• d√°t (~${MAX_DATA_SIZE_KB} KB) v lok√°lnom √∫lo≈æisku. Ukladanie zlyhalo.`);
                showSaveNotification("Chyba: Lok√°lne d√°ta s√∫ pr√≠li≈° veƒæk√©!", "error");
                return; // Neukladaj ak je prekroƒçen√Ω limit
            }

            localStorage.setItem(LS_KEYS.WORK_DATA, serializedMonthData);

            updateDataSize();

            // Spusti ukladanie do Firebase (ak je online, Firebase to zvl√°dne)
            if (navigator.onLine) {
                 saveToFirebase();
            } else {
                 showSaveNotification("Offline: Zmeny ulo≈æen√© lok√°lne", "warning");
            }

        } catch (error) {
            console.error('Chyba pri ukladan√≠ d√°t:', error);
            showSaveNotification("Kritick√° chyba pri ukladan√≠ d√°t!", "error");
            // Sk√∫sme aspo≈à aktualizova≈• veƒækos≈•, ak zlyhalo ukladanie
            updateDataSize();
        }
    };

    const loadDataFromLocalStorage = () => {
        try {
            const storedMonth = localStorage.getItem(LS_KEYS.CURRENT_MONTH);
            const storedYear = localStorage.getItem(LS_KEYS.CURRENT_YEAR);
            const now = new Date();
            state.currentMonth = storedMonth !== null ? parseInt(storedMonth) : now.getMonth();
            state.currentYear = storedYear !== null ? parseInt(storedYear) : now.getFullYear();

            state.hourlyWage = parseFloat(JSON.parse(localStorage.getItem(LS_KEYS.HOURLY_WAGE) || JSON.stringify(DEFAULT_VALUES.HOURLY_WAGE)));
            // Naƒç√≠taj percento a prepoƒç√≠taj na desatinn√© ƒç√≠slo
            const storedTaxRatePercent = parseFloat(JSON.parse(localStorage.getItem(LS_KEYS.TAX_RATE) || JSON.stringify(DEFAULT_VALUES.TAX_RATE_PERCENT)));
            state.taxRate = storedTaxRatePercent / 100;

            state.isDarkMode = JSON.parse(localStorage.getItem(LS_KEYS.DARK_MODE) || JSON.stringify(DEFAULT_VALUES.DARK_MODE));
            state.decimalPlaces = parseInt(JSON.parse(localStorage.getItem(LS_KEYS.DECIMAL_PLACES) || JSON.stringify(DEFAULT_VALUES.DECIMAL_PLACES)));
            state.employeeName = JSON.parse(localStorage.getItem(LS_KEYS.EMPLOYEE_NAME) || JSON.stringify(DEFAULT_VALUES.EMPLOYEE_NAME));

            const storedMonthData = localStorage.getItem(LS_KEYS.WORK_DATA);
            state.monthData = storedMonthData ? JSON.parse(storedMonthData) : {};

            // Valid√°cia naƒç√≠tan√Ωch hodn√¥t (pr√≠klad pre mzdu a da≈à)
            if (isNaN(state.hourlyWage) || state.hourlyWage < 0) state.hourlyWage = DEFAULT_VALUES.HOURLY_WAGE;
            if (isNaN(state.taxRate) || state.taxRate < 0 || state.taxRate > 1) state.taxRate = DEFAULT_VALUES.TAX_RATE_PERCENT / 100;
            if (isNaN(state.decimalPlaces) || state.decimalPlaces < 1 || state.decimalPlaces > 2) state.decimalPlaces = DEFAULT_VALUES.DECIMAL_PLACES;

        } catch (error) {
            console.error("Kritick√° chyba pri naƒç√≠tavan√≠ d√°t z localStorage:", error);
            showSaveNotification("Chyba pri naƒç√≠tan√≠ lok√°lnych d√°t! Obnovujem predvolen√©.", "error");
            // Reset na defaultn√© hodnoty v pr√≠pade chyby
            state.hourlyWage = DEFAULT_VALUES.HOURLY_WAGE;
            state.taxRate = DEFAULT_VALUES.TAX_RATE_PERCENT / 100;
            state.isDarkMode = DEFAULT_VALUES.DARK_MODE;
            state.decimalPlaces = DEFAULT_VALUES.DECIMAL_PLACES;
            state.employeeName = DEFAULT_VALUES.EMPLOYEE_NAME;
            state.monthData = {};
        }
    };


    // --- UI Aktualiz√°cia ---

    const applyDarkMode = (isDark) => {
        state.isDarkMode = isDark; // Aktualizuj stav
        const body = document.body;
        const container = uiElements?.calculatorContainer;
        const totalSalary = uiElements?.totalSalaryDiv;
        const summary = document.querySelector('.collapsible-settings summary'); // Tento sa m√¥≈æe meni≈•

        body.classList.toggle(CSS_CLASSES.DARK_MODE, isDark);
        container?.classList.toggle(CSS_CLASSES.DARK_MODE, isDark);
        totalSalary?.classList.toggle(CSS_CLASSES.DARK_MODE, isDark);
        summary?.classList.toggle(CSS_CLASSES.DARK_MODE, isDark);

        // Aplikuj na tabuƒæku a jej bunky
        document.querySelectorAll('table, th, td').forEach(el => el.classList.toggle(CSS_CLASSES.DARK_MODE, isDark));
        // Aplikuj na inputy, selecty, textarey
        document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea').forEach(el => el.classList.toggle(CSS_CLASSES.DARK_MODE, isDark));
        // Aplikuj na tlaƒçidl√°
        document.querySelectorAll('.btn, .toggle-note-btn').forEach(el => el.classList.toggle(CSS_CLASSES.DARK_MODE, isDark));

        // ≈†peci√°lne pre aktu√°lny de≈à
        const currentDayRow = uiElements?.workDays.querySelector(`.${CSS_CLASSES.CURRENT_DAY}`);
        if (currentDayRow) {
             currentDayRow.classList.toggle(CSS_CLASSES.DARK_MODE, isDark);
             currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn').forEach(el => el.classList.toggle(CSS_CLASSES.DARK_MODE, isDark));
        }
    };

    const populateYearSelect = () => {
        if (!uiElements?.yearSelect) return;
        const startYear = 2020;
        const endYear = new Date().getFullYear() + 2;
        uiElements.yearSelect.innerHTML = ''; // Vyƒçisti pred naplnen√≠m
        for (let year = startYear; year <= endYear; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            uiElements.yearSelect.appendChild(option);
        }
    };

    // Vytv√°ra HTML pre jeden riadok tabuƒæky
    const createTableRowHtml = (day) => {
        const dayName = getDayName(state.currentYear, state.currentMonth, day);
        const today = new Date();
        const isCurrentDay = day === today.getDate() &&
                             state.currentMonth === today.getMonth() &&
                             state.currentYear === today.getFullYear();
        const rowClass = isCurrentDay ? CSS_CLASSES.CURRENT_DAY : '';
        const dayData = getDayData(day - 1) || { start: '', end: '', breakTime: '', note: '' }; // Z√≠skaj d√°ta pre predvyplnenie

        // Pou≈æitie data-* atrib√∫tov pre jednoduch≈°iu identifik√°ciu v event handleri
        return `
            <tr class="${rowClass}" data-day="${day}">
                <td>De≈à ${day} (${dayName})</td>
                <td><input type="tel" value="${dayData.start}" data-field="start" data-day="${day}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"></td>
                <td><input type="tel" value="${dayData.end}" data-field="end" data-day="${day}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM"></td>
                <td><input type="number" value="${dayData.breakTime}" data-field="breakTime" data-day="${day}" min="0" step="0.5" placeholder="prest√°vka"></td>
                <td data-field="total">0h 0m (${(0).toFixed(state.decimalPlaces)} h)</td>
                <td><input type="number" data-field="gross" value="0.00" min="0" step="0.01" placeholder="Hrub√° Mzda" readonly></td>
                <td><input type="number" data-field="net" value="0.00" min="0" step="0.01" placeholder="ƒåist√° Mzda" readonly></td>
                <td>
                    <button class="toggle-note-btn" data-action="toggleNote" data-day="${day}">Pozn√°mka</button>
                    <div class="note-container">
                        <textarea class="note-textarea" data-field="note" data-day="${day}" placeholder="Zadajte pozn√°mku...">${dayData.note}</textarea>
                    </div>
                </td>
                <td><button class="btn reset-btn" data-action="resetRow" data-day="${day}">Vynulova≈•</button></td>
            </tr>
        `;
    };

    // Generuje cel√∫ tabuƒæku
    const renderTable = () => {
        if (!uiElements?.workDays) return;
        const days = getDaysInMonth(state.currentMonth, state.currentYear);
        let tableHtml = '';
        for (let i = 1; i <= days; i++) {
            tableHtml += createTableRowHtml(i);
        }
        uiElements.workDays.innerHTML = tableHtml;

        // Po vyrenderovan√≠ tabuƒæky prepoƒç√≠taj v≈°etky riadky a celkov√Ω s√∫ƒçet
        recalculateAllRows();
        calculateTotal();

        // Aplikuj tmav√Ω re≈æim na novovytvoren√© elementy
        applyDarkMode(state.isDarkMode);
    };

    // Aktualizuje stav UI na z√°klade naƒç√≠tan√Ωch d√°t
    const updateUIFromState = () => {
        if (!uiElements) return; // Zabezpeƒçenie, ≈æe elementy s√∫ inicializovan√©

        // Nastavenia
        uiElements.hourlyWageInput.value = state.hourlyWage;
        uiElements.taxRateInput.value = state.taxRate * 100; // Zobrazuj ako percento
        uiElements.decimalPlacesSelect.value = state.decimalPlaces;
        uiElements.employeeNameInput.value = state.employeeName;
        uiElements.monthSelect.value = state.currentMonth;
        // Skontroluj, ƒçi rok existuje v selecte, ak nie, pridaj ho a vyber
        if (!uiElements.yearSelect.querySelector(`option[value="${state.currentYear}"]`)) {
            console.warn(`Rok ${state.currentYear} nebol v selecte, prid√°vam.`);
            populateYearSelect(); // Znovu napl≈à, ak by ch√Ωbal
        }
        uiElements.yearSelect.value = state.currentYear;

        applyDarkMode(state.isDarkMode);
        updateWelcomeMessage();
        updateDataSize();
        renderTable(); // Prekresl√≠ tabuƒæku s aktu√°lnymi d√°tami
    };


    // --- Kalkul√°cie ---

    const calculateRow = (day) => {
        const row = uiElements.workDays.querySelector(`tr[data-day="${day}"]`);
        if (!row) return; // Riadok neexistuje

        const startInput = row.querySelector('input[data-field="start"]');
        const endInput = row.querySelector('input[data-field="end"]');
        const breakInput = row.querySelector('input[data-field="breakTime"]');
        const totalCell = row.querySelector('td[data-field="total"]');
        const grossInput = row.querySelector('input[data-field="gross"]');
        const netInput = row.querySelector('input[data-field="net"]');

        if (!startInput || !endInput || !breakInput || !totalCell || !grossInput || !netInput) {
             console.error(`Ch√Ωbaj√∫ elementy pre v√Ωpoƒçet riadku ${day}`);
             return;
        }

        const startTimeStr = startInput.value;
        const endTimeStr = endInput.value;
        const breakTime = parseFloat(breakInput.value) || 0;

        let workedMinutes = 0;
        let displayTotal = `0h 0m (${(0).toFixed(state.decimalPlaces)} h)`;
        let isValid = true;

        startInput.classList.remove(CSS_CLASSES.INVALID_TIME);
        endInput.classList.remove(CSS_CLASSES.INVALID_TIME);

        if (startTimeStr || endTimeStr) { // Ak je aspo≈à jeden ƒças zadan√Ω
            const isStartValid = isTimeValid(startTimeStr);
            const isEndValid = isTimeValid(endTimeStr);

            if (!isStartValid && startTimeStr !== '') {
                startInput.classList.add(CSS_CLASSES.INVALID_TIME);
                isValid = false;
            }
            if (!isEndValid && endTimeStr !== '') {
                endInput.classList.add(CSS_CLASSES.INVALID_TIME);
                isValid = false;
            }

            if (isStartValid && isEndValid) {
                const startTotalMinutes = parseTimeToMinutes(startTimeStr);
                let endTotalMinutes = parseTimeToMinutes(endTimeStr);

                // Prechod cez polnoc
                if (endTotalMinutes < startTotalMinutes) {
                    endTotalMinutes += 24 * 60;
                }

                const diffMinutes = endTotalMinutes - startTotalMinutes;
                const breakMinutes = breakTime * 60;
                workedMinutes = Math.max(0, diffMinutes - breakMinutes);
                const formattedTime = formatMinutesToHoursMinutes(workedMinutes);
                displayTotal = `${formattedTime.h}h ${formattedTime.m}m (${formattedTime.dec.toFixed(state.decimalPlaces)} h)`;
            } else if (!isValid) {
                 displayTotal = 'Neplatn√Ω ƒças';
            }
        }

        totalCell.textContent = displayTotal;

        const decimalHours = workedMinutes / 60;
        const grossSalary = isValid ? decimalHours * state.hourlyWage : 0;
        const netSalary = isValid ? grossSalary * (1 - state.taxRate) : 0;

        grossInput.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00';
        netInput.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00';
    };

    const recalculateAllRows = () => {
        const rows = uiElements.workDays.querySelectorAll('tr[data-day]');
        rows.forEach(row => {
            const day = parseInt(row.dataset.day);
            if (!isNaN(day)) {
                calculateRow(day);
            }
        });
    };

    const calculateTotal = () => {
        if (!uiElements?.totalSalaryDiv) return;

        let grandTotalWorkedMinutes = 0;
        let daysWithEntries = 0;
        const rows = uiElements.workDays.querySelectorAll('tr[data-day]');

        rows.forEach(row => {
            const startInput = row.querySelector('input[data-field="start"]');
            const endInput = row.querySelector('input[data-field="end"]');
            const breakInput = row.querySelector('input[data-field="breakTime"]');

            const startTimeStr = startInput?.value || '';
            const endTimeStr = endInput?.value || '';

            // Poƒç√≠taj len validn√© a vyplnen√© riadky
            if (isTimeValid(startTimeStr) && isTimeValid(endTimeStr)) {
                const breakTime = parseFloat(breakInput?.value) || 0;
                const startTotalMinutes = parseTimeToMinutes(startTimeStr);
                let endTotalMinutes = parseTimeToMinutes(endTimeStr);
                if (endTotalMinutes < startTotalMinutes) endTotalMinutes += 24 * 60;

                const diffMinutes = endTotalMinutes - startTotalMinutes;
                const breakMinutes = breakTime * 60;
                const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes);

                grandTotalWorkedMinutes += workedMinutesForRow;
                if (workedMinutesForRow > 0) { // Poƒç√≠taj de≈à len ak sa re√°lne odpracovalo
                    daysWithEntries++;
                }
            } else if (startTimeStr || endTimeStr) {
                 // Ak je zadan√Ω aspo≈à jeden ƒças (aj nevalidn√Ω), poƒç√≠tajme to ako de≈à so z√°znamom pre priemer
                 // daysWithEntries++; // Alternat√≠va - poƒç√≠ta≈• aj dni s neplatn√Ωm ƒçasom
            }
        });

        const totalFormatted = formatMinutesToHoursMinutes(grandTotalWorkedMinutes);
        const grandTotalGrossSalary = totalFormatted.dec * state.hourlyWage;
        const grandTotalNetSalary = grandTotalGrossSalary * (1 - state.taxRate);

        const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
        const averageFormatted = formatMinutesToHoursMinutes(averageWorkedMinutes);
        const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0;


        uiElements.totalSalaryDiv.innerHTML = `
            Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntries}<br>
            Celkov√Ω odpracovan√Ω ƒças: ${totalFormatted.h}h ${totalFormatted.m}m (${totalFormatted.dec.toFixed(state.decimalPlaces)} h)<br>
            Celkov√° hrub√° mzda: ${grandTotalGrossSalary.toFixed(2)}‚Ç¨<br>
            Celkov√° ƒçist√° mzda: ${grandTotalNetSalary.toFixed(2)}‚Ç¨<br>
            Priemern√° ƒçist√° mzda na de≈à: ${averageNetSalary.toFixed(2)}‚Ç¨<br>
            <strong>Priemern√Ω odpracovan√Ω ƒças na de≈à: ${averageFormatted.h}h ${averageFormatted.m}m (${averageFormatted.dec.toFixed(state.decimalPlaces)} h)</strong>
        `;
    };


    // --- Firestore Listener ---

    const handleFirestoreUpdate = (docSnap) => {
         state.activeElementId = document.activeElement?.id; // Ulo≈æ ID akt√≠vneho elementu pred spracovan√≠m
        const hasPending = docSnap.metadata.hasPendingWrites;
        const isFromCache = docSnap.metadata.fromCache;

        if (hasPending) {
            // Lok√°lny z√°pis - len aktualizuj `state.monthData` potichu, neprekresƒæuj UI
            // aby si neprep√≠sal pr√°ve zad√°van√∫ hodnotu
            if (docSnap.exists) {
                const data = docSnap.data();
                const firebaseDaysData = data.days || [];
                const currentData = getCurrentMonthData(true); // Z√≠skaj alebo vytvor pole
                // Nahraƒè obsah poƒæa nov√Ωmi d√°tami
                currentData.length = 0; // Vypr√°zdni pole
                firebaseDaysData.forEach(day => currentData.push({...day})); // Skop√≠ruj d√°ta
            }
            state.activeElementId = null; // Resetuj po spracovan√≠
            return;
        }

        // Remote update or initial load
        if (docSnap.exists()) {
            const data = docSnap.data();
            let uiNeedsUpdate = false;
            let settingsChanged = false;

            // 1. Aktualizuj nastavenia v stave (ak sa zmenili)
            const fbHourlyWage = data.hourlyWage ?? state.hourlyWage;
            const fbTaxRatePercent = data.taxRate ?? (state.taxRate * 100);
            const fbDecimalPlaces = data.decimalPlaces ?? state.decimalPlaces;
            const fbEmployeeName = data.employeeName ?? state.employeeName;
            const fbDarkMode = data.darkMode ?? state.isDarkMode;
            const fbTaxRate = fbTaxRatePercent / 100;

            if (state.hourlyWage !== fbHourlyWage) { state.hourlyWage = fbHourlyWage; settingsChanged = true; }
            if (state.taxRate !== fbTaxRate) { state.taxRate = fbTaxRate; settingsChanged = true; }
            if (state.decimalPlaces !== fbDecimalPlaces) { state.decimalPlaces = fbDecimalPlaces; settingsChanged = true; }
            if (state.employeeName !== fbEmployeeName) { state.employeeName = fbEmployeeName; settingsChanged = true; }
            if (state.isDarkMode !== fbDarkMode) { state.isDarkMode = fbDarkMode; settingsChanged = true; } // Zmena dark modu je tie≈æ zmena nastaven√≠

            // 2. Aktualizuj d√°ta dn√≠ v stave
            const firebaseDaysData = data.days || [];
            const currentData = getCurrentMonthData(true);
            // Porovnaj dƒ∫≈æku a obsah predt√Ωm, ne≈æ nahrad√≠≈°
            if (currentData.length !== firebaseDaysData.length || JSON.stringify(currentData) !== JSON.stringify(firebaseDaysData)) {
                currentData.length = 0;
                firebaseDaysData.forEach(day => currentData.push({...day}));
                uiNeedsUpdate = true; // Ak sa zmenili dni, treba prekresli≈•
            }

            // 3. Aktualizuj UI (ak treba a neovplyvn√≠ to akt√≠vny input)
            if (settingsChanged) {
                // Update settings inputs only if not focused
                if (state.activeElementId !== uiElements?.hourlyWageInput.id) uiElements.hourlyWageInput.value = state.hourlyWage;
                if (state.activeElementId !== uiElements?.taxRateInput.id) uiElements.taxRateInput.value = state.taxRate * 100;
                if (state.activeElementId !== uiElements?.decimalPlacesSelect.id) uiElements.decimalPlacesSelect.value = state.decimalPlaces;
                if (state.activeElementId !== uiElements?.employeeNameInput.id) uiElements.employeeNameInput.value = state.employeeName;
                applyDarkMode(state.isDarkMode); // Dark mode aplikuj v≈ædy
                updateWelcomeMessage();
                uiNeedsUpdate = true; // Zmena nastaven√≠ si vy≈æaduje prepoƒçet
            }

            if (uiNeedsUpdate) {
                // Prekresli konkr√©tne riadky alebo cel√∫ tabuƒæku ak treba
                // Optimaliz√°cia: Ak sa zmenili len nastavenia, staƒç√≠ prepoƒç√≠ta≈•, netreba renderTable()
                if (settingsChanged && !data.days) { // Ak sa zmenili len nastavenia
                     recalculateAllRows();
                     calculateTotal();
                } else { // Ak sa zmenili dni (alebo aj nastavenia)
                     renderTable(); // Toto u≈æ vol√° recalculate a calculateTotal
                }
                 // Ulo≈æ potvrden√Ω stav z Firebase do localStorage
                 saveData();
            }

            if (!isFromCache) {
                showSaveNotification("D√°ta synchronizovan√© zo servera");
            }

        } else {
            // Dokument neexistuje na Firebase
            console.log(`Dokument pre ${state.currentYear}-${state.currentMonth} neexistuje na Firebase.`);
            // Naƒç√≠taj z localStorage ako fallback, alebo resetni ak LS je pr√°zdny
            loadDataFromLocalStorage(); // Naƒç√≠taj lok√°lny stav
             // Ak lok√°lny stav pre tento mesiac neexistuje, vyƒçisti ho
            if (!getCurrentMonthData()) {
                 if (state.monthData[state.currentYear]) {
                     state.monthData[state.currentYear][state.currentMonth] = [];
                 }
                 saveData(); // Ulo≈æ vyƒçisten√Ω stav
            }
            updateUIFromState(); // Zobraz aktu√°lny (lok√°lny alebo resetovan√Ω) stav
        }
         state.activeElementId = null; // Resetuj po spracovan√≠
    };

    const setupFirestoreListener = () => {
        // Odhl√°s predch√°dzaj√∫ci listener
        if (state.firestoreListenerUnsubscribe) {
            state.firestoreListenerUnsubscribe();
            state.firestoreListenerUnsubscribe = null;
        }

        if (!state.currentUser) return; // Nem√° zmysel poƒç√∫va≈• bez pou≈æ√≠vateƒæa

        const uid = state.currentUser.uid;
        const yearMonthDoc = `${state.currentYear}-${state.currentMonth}`;
        const docRef = db.collection("users").doc(uid).collection(FIREBASE_COLLECTION).doc(yearMonthDoc);
        console.log(`Nastavujem Firestore listener pre: ${docRef.path}`);

        state.firestoreListenerUnsubscribe = docRef.onSnapshot(
            handleFirestoreUpdate, // Hlavn√° logika spracovania
            (error) => {
                console.error(`Firestore listener CHYBA pre ${docRef.path}:`, error);
                showSaveNotification("Chyba: Nepodarilo sa pripoji≈• k datab√°ze", "error");
                // V pr√≠pade chyby spojenia sa spoliehame na lok√°lne d√°ta
                loadDataFromLocalStorage();
                updateUIFromState();
            }
        );
    };

    // --- Autentifik√°cia ---

    const handleAuthStateChanged = (user) => {
        const isLoading = !uiElements?.loadingContainer.classList.contains('hidden');
        if (isLoading) uiElements?.loadingContainer.classList.add('hidden');

        // Odhl√°s listener ak existuje
        if (state.firestoreListenerUnsubscribe) {
            state.firestoreListenerUnsubscribe();
            state.firestoreListenerUnsubscribe = null;
        }
        state.monthData = {}; // Resetuj d√°ta pri zmene pou≈æ√≠vateƒæa

        if (user) {
            // Prihl√°sen√Ω
            state.currentUser = user;
            uiElements.authMessage.textContent = "Prihl√°sen√Ω: " + user.email;
            uiElements.authContainer.style.display = "none";
            uiElements.calculatorContainer.style.display = "block";

            // Naƒç√≠taj d√°ta a nastav UI
            loadDataFromLocalStorage(); // Najprv lok√°lne
            updateUIFromState();       // Zobraz lok√°lne d√°ta
            setupFirestoreListener();  // Potom spusti listener pre synchroniz√°ciu

            // Over/vytvor u≈æ√≠vateƒæsk√Ω dokument (len raz)
            const userDocRef = db.collection("users").doc(user.uid);
            userDocRef.get().then(userDocSnap => {
                if (!userDocSnap.exists) {
                    userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true })
                        .catch(err => console.error("Chyba pri vytv√°ran√≠ dokumentu pou≈æ√≠vateƒæa:", err));
                }
            }).catch(err => {
                console.error("Chyba pri kontrole dokumentu pou≈æ√≠vateƒæa:", err);
                showSaveNotification("Chyba pri overovan√≠ pou≈æ√≠vateƒæsk√Ωch d√°t", "error");
            });

        } else {
            // Odhl√°sen√Ω
            state.currentUser = null;
            uiElements.authMessage.textContent = "≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.";
            uiElements.authContainer.style.display = "block";
            uiElements.calculatorContainer.style.display = "none";
            // Vyƒçisti UI kalkulaƒçky
            uiElements.workDays.innerHTML = '';
            uiElements.totalSalaryDiv.innerHTML = '';
            updateWelcomeMessage(); // Skryje pozdrav
        }
    };

    const registerUser = () => {
        const email = uiElements.registerEmailInput.value;
        const password = uiElements.registerPasswordInput.value;
        if (!email || !password) {
            alert("Pros√≠m, vypl≈àte email aj heslo pre registr√°ciu.");
            return;
        }
        auth.createUserWithEmailAndPassword(email, password)
            .then(() => alert("Registr√°cia √∫spe≈°n√°!"))
            .catch(error => {
                console.error("Chyba pri registr√°cii:", error.message);
                alert("Chyba pri registr√°cii: " + error.message);
            });
    };

    const loginUser = () => {
        const email = uiElements.loginEmailInput.value;
        const password = uiElements.loginPasswordInput.value;
         if (!email || !password) {
            alert("Pros√≠m, vypl≈àte email aj heslo pre prihl√°senie.");
            return;
        }
        auth.signInWithEmailAndPassword(email, password)
            .then(() => alert("Prihl√°senie √∫spe≈°n√©!"))
            .catch(error => {
                console.error("Chyba pri prihl√°sen√≠:", error.message);
                alert("Chyba pri prihl√°sen√≠: " + error.message);
            });
    };

    const logoutUser = () => {
        auth.signOut()
            .then(() => alert("Odhl√°senie √∫spe≈°n√©!"))
            .catch(error => {
                console.error("Chyba pri odhl√°sen√≠:", error.message);
                alert("Chyba pri odhl√°sen√≠: " + error.message);
            });
    };

    const sendPasswordReset = () => {
        const email = uiElements.loginEmailInput.value; // Pou≈æijeme email z login poƒæa
        if (!email) {
            alert("Pros√≠m, zadajte svoju e-mailov√∫ adresu do poƒæa pre prihl√°senie, aby sme v√°m mohli posla≈• odkaz na obnovu hesla.");
            uiElements.loginEmailInput.focus();
            return;
        }
        auth.sendPasswordResetEmail(email)
            .then(() => {
                alert("Odkaz na obnovenie hesla bol odoslan√Ω na va≈°u e-mailov√∫ adresu. Skontrolujte si pros√≠m po≈°tu (aj prieƒçinok Spam).");
            })
            .catch(error => {
                console.error("Chyba pri odosielan√≠ e-mailu na obnovenie hesla:", error);
                alert("Chyba pri odosielan√≠ e-mailu na obnovenie hesla: " + error.message);
            });
    };


    // --- Event Handlery ---

    const handleSettingsChange = (event) => {
        const target = event.target;
        let needsRecalculation = false;
        let needsSave = true; // V√§ƒç≈°ina zmien vy≈æaduje ulo≈æenie

        switch (target.id) {
            case 'monthSelect':
                state.currentMonth = parseInt(target.value);
                handleMonthYearChange(); // Naƒç√≠ta nov√© d√°ta a listener
                needsSave = false; // Ulo≈æ√≠ sa v handleMonthYearChange
                break;
            case 'yearSelect':
                state.currentYear = parseInt(target.value);
                handleMonthYearChange();
                needsSave = false;
                break;
            case 'employeeNameInput':
                state.employeeName = target.value;
                updateWelcomeMessage();
                break;
            case 'hourlyWageInput':
                const newWage = parseFloat(target.value);
                if (!isNaN(newWage) && newWage >= 0) {
                    state.hourlyWage = newWage;
                    needsRecalculation = true;
                }
                break;
            case 'taxRateInput':
                const newTaxPercent = parseFloat(target.value);
                if (!isNaN(newTaxPercent) && newTaxPercent >= 0 && newTaxPercent <= 100) {
                    state.taxRate = newTaxPercent / 100;
                    needsRecalculation = true;
                }
                break;
            case 'decimalPlacesSelect':
                state.decimalPlaces = parseInt(target.value);
                needsRecalculation = true;
                break;
        }

        if (needsRecalculation) {
            recalculateAllRows();
            calculateTotal();
        }
        if (needsSave) {
            saveData();
        }
    };

    const handleMonthYearChange = () => {
        // Ulo≈æ aktu√°lny v√Ωber pre bud√∫ce naƒç√≠tanie
        localStorage.setItem(LS_KEYS.CURRENT_MONTH, state.currentMonth.toString());
        localStorage.setItem(LS_KEYS.CURRENT_YEAR, state.currentYear.toString());
        // Naƒç√≠taj d√°ta pre nov√Ω mesiac/rok (z LS alebo vytvor√≠ pr√°zdne pole)
        loadDataFromLocalStorage(); // Toto nastav√≠ state.monthData spr√°vne
        updateUIFromState(); // Prekresl√≠ UI pre nov√Ω mesiac
        setupFirestoreListener(); // Nastav√≠ listener pre nov√Ω dokument
    };

    const handleTableInteraction = (event) => {
        const target = event.target;
        const action = target.dataset.action;
        const field = target.dataset.field;
        const dayStr = target.dataset.day || target.closest('tr')?.dataset.day; // Z√≠ska≈• de≈à z targetu alebo rodiƒçovsk√©ho TR

        if (!dayStr) return; // Nena≈°iel sa de≈à, ignoruj
        const day = parseInt(dayStr);
        if (isNaN(day)) return;

        const dayIndex = day - 1;

        // --- Spracovanie Inputov ---
        if (field && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA')) {
            const value = target.value;
            const dayDataObject = getDayData(dayIndex, true); // Z√≠skaj alebo vytvor d√°ta d≈àa

            if (!dayDataObject) {
                 console.error(`Nepodarilo sa z√≠ska≈•/vytvori≈• d√°ta pre de≈à ${day}`);
                 return;
            }

            // Aktualizuj d√°ta v stave
            if (dayDataObject[field] !== value) {
                 dayDataObject[field] = value;

                 // ≈†peci√°lna logika pre ƒçasov√© inputy
                 if (field === 'start' || field === 'end') {
                      formatTimeInput(target); // Form√°tovanie HH:MM
                      calculateRow(day); // Prepoƒç√≠taj len tento riadok
                      calculateTotal();  // A celkov√Ω s√∫ƒçet
                      // Automatick√Ω presun fokusu
                      if (field === 'start' && isTimeValid(value) && value.length === 5) {
                           const nextInput = target.closest('tr')?.querySelector('input[data-field="end"]');
                           nextInput?.focus();
                      } else if (field === 'end' && isTimeValid(value) && value.length === 5) {
                            const nextInput = target.closest('tr')?.querySelector('input[data-field="breakTime"]');
                            nextInput?.focus();
                      }

                 } else if (field === 'breakTime') {
                      calculateRow(day); // Prepoƒç√≠taj len tento riadok
                      calculateTotal();  // A celkov√Ω s√∫ƒçet
                      // Presun fokusu na ƒèal≈°√≠ de≈à po zadan√≠ prest√°vky?
                      // const nextRow = uiElements.workDays.querySelector(`tr[data-day="${day + 1}"]`);
                      // nextRow?.querySelector('input[data-field="start"]')?.focus();
                 }
                 // Pre pozn√°mku netreba prepoƒç√≠tava≈•

                 saveData(); // Ulo≈æ zmeny
            }
        }
        // --- Spracovanie Akci√≠ (Tlaƒçidl√°) ---
        else if (action) {
            switch (action) {
                case 'toggleNote':
                    toggleNoteVisibility(day);
                    break;
                case 'resetRow':
                    resetRow(day);
                    break;
            }
        }
    };

    const formatTimeInput = (input) => {
        if (input.type !== 'tel') return;
        let value = input.value.replace(/[^\d:]/g, ''); // Ponechaj len ƒç√≠sla a dvojbodku

        // Automatick√© pridanie dvojbodky
        if (value.length === 4 && !value.includes(':')) {
             value = value.slice(0, 2) + ':' + value.slice(2);
        } else if (value.length === 3 && value.charAt(2) !== ':' && parseInt(value.slice(0, 2)) <= 23) {
             value = value.slice(0, 2) + ':' + value.slice(2);
        }

        // Obmedzenie dƒ∫≈æky
        if (value.length > 5) {
            value = value.slice(0, 5);
        }

        // Aktualizuj hodnotu len ak sa zmenila
        if (input.value !== value) {
             input.value = value;
        }

        // Valid√°cia a vizu√°lna odozva
        if (value === '' || isTimeValid(value)) {
             input.classList.remove(CSS_CLASSES.INVALID_TIME);
        } else if (value.length === 5) { // Nevalidn√Ω form√°t pri plnej dƒ∫≈æke
             input.classList.add(CSS_CLASSES.INVALID_TIME);
        } else { // Ne√∫pln√Ω vstup
             input.classList.remove(CSS_CLASSES.INVALID_TIME); // E≈°te nie je chyba
        }
    };

    const toggleNoteVisibility = (day) => {
        const row = uiElements.workDays.querySelector(`tr[data-day="${day}"]`);
        if (!row) return;
        const container = row.querySelector('.note-container');
        const button = row.querySelector('button[data-action="toggleNote"]');
        if (!container || !button) return;

        const isVisible = container.classList.toggle(CSS_CLASSES.NOTE_VISIBLE);
        button.textContent = isVisible ? 'Skry≈•' : 'Pozn√°mka';
        // Synchronizuj dark mode pre textareu pri zobrazen√≠/skryt√≠
        if (isVisible) {
             const textarea = container.querySelector('.note-textarea');
             textarea?.classList.toggle(CSS_CLASSES.DARK_MODE, state.isDarkMode);
        }
    };

    const resetRow = (day) => {
        const dayIndex = day - 1;
        const dayDataObject = getDayData(dayIndex, false); // Len z√≠skaj, nevytv√°raj ak neexistuje

        // Vynuluj d√°ta v stave
        if (dayDataObject) {
             dayDataObject.start = '';
             dayDataObject.end = '';
             dayDataObject.breakTime = '';
             dayDataObject.note = '';
        }

        // Vynuluj UI
        const row = uiElements.workDays.querySelector(`tr[data-day="${day}"]`);
        if (row) {
            row.querySelector('input[data-field="start"]').value = '';
            row.querySelector('input[data-field="end"]').value = '';
            row.querySelector('input[data-field="breakTime"]').value = '';
            row.querySelector('textarea[data-field="note"]').value = '';
            row.querySelector('td[data-field="total"]').textContent = `0h 0m (${(0).toFixed(state.decimalPlaces)} h)`;
            row.querySelector('input[data-field="gross"]').value = '0.00';
            row.querySelector('input[data-field="net"]').value = '0.00';
            // Skry pozn√°mku
            row.querySelector('.note-container')?.classList.remove(CSS_CLASSES.NOTE_VISIBLE);
            row.querySelector('button[data-action="toggleNote"]').textContent = 'Pozn√°mka';
             // Odstr√°≈à pr√≠padn√∫ triedu nevalidn√©ho ƒçasu
            row.querySelector('input[data-field="start"]').classList.remove(CSS_CLASSES.INVALID_TIME);
            row.querySelector('input[data-field="end"]').classList.remove(CSS_CLASSES.INVALID_TIME);
        }

        calculateTotal(); // Prepoƒç√≠taj celkov√Ω s√∫ƒçet
        saveData();       // Ulo≈æ zmeny
    };

    const resetAllCurrentMonth = () => {
        if (confirm('Naozaj chcete resetova≈• v≈°etky z√°znamy pre tento mesiac?')) {
            // Vynuluj d√°ta len pre aktu√°lny mesiac a rok
            if (state.monthData[state.currentYear]) {
                state.monthData[state.currentYear][state.currentMonth] = []; // Nastav na pr√°zdne pole
            }
            renderTable(); // Prekresl√≠ pr√°zdnu tabuƒæku (a zavol√° prepoƒçty)
            saveData();    // Ulo≈æ pr√°zdne d√°ta
            showSaveNotification(`D√°ta pre ${getMonthName(state.currentMonth)} ${state.currentYear} boli resetovan√©.`);
        }
     };

    const toggleDarkMode = () => {
         applyDarkMode(!state.isDarkMode); // Preklop stav a aplikuj
         saveData(); // Ulo≈æ zmenu dark mode
    };


    // --- Z√°lohovanie a Obnova ---

    const createBackup = () => {
        try {
            const backupData = {
                // Uklad√°me cel√Ω state.monthData namiesto len workDaysData z localStorage
                monthData: state.monthData,
                settings: {
                    hourlyWage: state.hourlyWage,
                    taxRatePercent: state.taxRate * 100,
                    darkMode: state.isDarkMode,
                    decimalPlaces: state.decimalPlaces,
                    employeeName: state.employeeName,
                },
                backupVersion: 3, // Zv√Ω≈°en√° verzia kv√¥li zmene ≈°trukt√∫ry
                backupTimestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bruno-calc-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSaveNotification("Z√°loha √∫spe≈°ne vytvoren√°.");
        } catch (error) {
            console.error("Chyba pri vytv√°ran√≠ z√°lohy:", error);
            alert("Nastala chyba pri vytv√°ran√≠ z√°lo≈æn√©ho s√∫boru.");
        }
    };

    const restoreBackup = () => {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.json,application/json';

      fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();

        reader.onload = (e) => {
          try {
            const backup = JSON.parse(e.target.result);

            // Valid√°cia novej ≈°trukt√∫ry z√°lohy (v3)
            if (backup && backup.monthData && backup.settings &&
                typeof backup.settings.hourlyWage === 'number' &&
                typeof backup.settings.taxRatePercent === 'number' &&
                typeof backup.settings.darkMode === 'boolean' &&
                typeof backup.settings.decimalPlaces === 'number' &&
                typeof backup.settings.employeeName === 'string')
            {
              // Obnovenie stavu z backupu
              state.monthData = backup.monthData || {};
              state.hourlyWage = backup.settings.hourlyWage;
              state.taxRate = backup.settings.taxRatePercent / 100;
              state.isDarkMode = backup.settings.darkMode;
              state.decimalPlaces = backup.settings.decimalPlaces;
              state.employeeName = backup.settings.employeeName;

              // Ak z√°loha obsahuje d√°ta pre aktu√°lne zobrazen√Ω mesiac/rok,
              // nemus√≠me nutne meni≈• currentMonth/Year, ale mali by sme.
              // Pre jednoduchos≈• ostaneme na aktu√°lnom mesiaci/roku
              // a len obnov√≠me *v≈°etky* d√°ta a nastavenia.

              updateUIFromState(); // Aktualizuj cel√© UI podƒæa nov√©ho stavu
              saveData(); // Ulo≈æ obnoven√Ω stav do LS aj Firebase
              showSaveNotification("Z√°loha √∫spe≈°ne obnoven√°.");
              alert("Z√°loha bola √∫spe≈°ne obnoven√°. D√°ta boli naƒç√≠tan√© a ulo≈æen√©.");

            } else {
               // Sk√∫s validova≈• star√∫ ≈°trukt√∫ru (v2)
               if (backup && typeof backup.workDaysData === 'string' &&
                   typeof backup.hourlyWage === 'string' && typeof backup.taxRate === 'string' &&
                   typeof backup.darkMode === 'string' && typeof backup.decimalPlaces === 'string' &&
                   typeof backup.employeeName === 'string')
               {
                    console.warn("Naƒç√≠tava sa star√Ω form√°t z√°lohy (v2).");
                    state.monthData = JSON.parse(backup.workDaysData || '{}');
                    state.hourlyWage = parseFloat(JSON.parse(backup.hourlyWage));
                    state.taxRate = parseFloat(JSON.parse(backup.taxRate)) / 100;
                    state.isDarkMode = JSON.parse(backup.darkMode);
                    state.decimalPlaces = parseInt(JSON.parse(backup.decimalPlaces));
                    state.employeeName = JSON.parse(backup.employeeName);
                    // Valid√°cia po naƒç√≠tan√≠ star√©ho form√°tu
                    if (isNaN(state.hourlyWage)) state.hourlyWage = DEFAULT_VALUES.HOURLY_WAGE;
                    if (isNaN(state.taxRate)) state.taxRate = DEFAULT_VALUES.TAX_RATE_PERCENT / 100;
                    if (typeof state.isDarkMode !== 'boolean') state.isDarkMode = DEFAULT_VALUES.DARK_MODE;
                    if (isNaN(state.decimalPlaces)) state.decimalPlaces = DEFAULT_VALUES.DECIMAL_PLACES;
                    if (typeof state.employeeName !== 'string') state.employeeName = DEFAULT_VALUES.EMPLOYEE_NAME;

                    updateUIFromState();
                    saveData();
                    showSaveNotification("Star√° z√°loha (v2) √∫spe≈°ne obnoven√°.");
                    alert("Star√Ω form√°t z√°lohy bol obnoven√Ω. D√°ta boli naƒç√≠tan√© a ulo≈æen√©.");
               } else {
                    alert("Chyba: S√∫bor z√°lohy m√° nespr√°vny form√°t alebo ch√Ωbaj√∫ d√°ta.");
               }
            }
          } catch (error) {
            console.error("Chyba pri spracovan√≠ alebo obnove z√°lohy:", error);
            alert("Chyba pri ƒç√≠tan√≠ alebo obnove z√°lohy. S√∫bor m√¥≈æe by≈• po≈°koden√Ω alebo ma≈• nespr√°vny form√°t.");
          }
        };
        reader.onerror = (e) => {
            console.error("Chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy:", e);
            alert("Nastala chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy.");
        };
        reader.readAsText(file);
      };
      fileInput.click();
    };


    // --- Inicializ√°cia ---
    const initializeApp = () => {
        // Cachovanie DOM elementov
        uiElements = {
            loadingContainer: document.getElementById('loading-container'),
            authContainer: document.getElementById('auth-container'),
            calculatorContainer: document.getElementById('calculator-container'),
            authMessage: document.getElementById('auth-message'),
            registerEmailInput: document.getElementById('registerEmail'),
            registerPasswordInput: document.getElementById('registerPassword'),
            registerButton: document.getElementById('registerButton'),
            loginEmailInput: document.getElementById('loginEmail'),
            loginPasswordInput: document.getElementById('loginPassword'),
            loginButton: document.getElementById('loginButton'),
            forgotPasswordLink: document.getElementById('forgot-password-link'),
            welcomeMessage: document.getElementById('welcomeMessage'),
            monthSelect: document.getElementById('monthSelect'),
            yearSelect: document.getElementById('yearSelect'),
            employeeNameInput: document.getElementById('employeeNameInput'),
            hourlyWageInput: document.getElementById('hourlyWageInput'),
            taxRateInput: document.getElementById('taxRateInput'),
            decimalPlacesSelect: document.getElementById('decimalPlacesSelect'),
            toggleDarkModeButton: document.getElementById('toggleDarkModeButton'),
            workDays: document.getElementById('workDays'), // tbody
            totalSalaryDiv: document.getElementById('totalSalary'),
            dataSizeText: document.getElementById('dataSizeText'),
            dataSizeFill: document.getElementById('dataSizeFill'),
            resetAllButton: document.getElementById('resetAllButton'),
            exportPdfButton: document.getElementById('exportPdfButton'),
            sendPdfButton: document.getElementById('sendPdfButton'),
            restoreBackupButton: document.getElementById('restoreBackupButton'),
            createBackupButton: document.getElementById('createBackupButton'),
            logoutButton: document.getElementById('logoutButton'),
            saveNotification: document.getElementById('saveNotification')
        };

        populateYearSelect();

        // Pridanie Event Listenerov
        // Auth
        uiElements.registerButton.addEventListener('click', registerUser);
        uiElements.loginButton.addEventListener('click', loginUser);
        uiElements.logoutButton.addEventListener('click', logoutUser);
        uiElements.forgotPasswordLink.addEventListener('click', (e) => {
             e.preventDefault(); // Zabr√°ni skoku na #
             sendPasswordReset();
        });

        // Settings
        uiElements.monthSelect.addEventListener('change', handleSettingsChange);
        uiElements.yearSelect.addEventListener('change', handleSettingsChange);
        uiElements.employeeNameInput.addEventListener('input', handleSettingsChange);
        uiElements.hourlyWageInput.addEventListener('input', handleSettingsChange);
        uiElements.taxRateInput.addEventListener('input', handleSettingsChange);
        uiElements.decimalPlacesSelect.addEventListener('change', handleSettingsChange);
        uiElements.toggleDarkModeButton.addEventListener('click', toggleDarkMode);

        // Table (Event Delegation)
        uiElements.workDays.addEventListener('input', handleTableInteraction); // Pre inputy a textareu
        uiElements.workDays.addEventListener('click', handleTableInteraction); // Pre tlaƒçidl√°

        // General Buttons
        uiElements.resetAllButton.addEventListener('click', resetAllCurrentMonth);
        uiElements.createBackupButton.addEventListener('click', createBackup);
        uiElements.restoreBackupButton.addEventListener('click', restoreBackup);

        // PDF Buttons (ponechan√© ako predt√Ωm, ale cez addEventListener)
        uiElements.exportPdfButton.addEventListener('click', exportToPDF);
        uiElements.sendPdfButton.addEventListener('click', sendPDF);


        // Firebase Auth State Listener
        auth.onAuthStateChanged(handleAuthStateChanged);

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => { console.log('ServiceWorker registrovan√Ω:', registration); })
                    .catch(error => { console.error('Registr√°cia ServiceWorker zlyhala:', error); });
            });
        } else {
            console.warn("Service Worker nie je podporovan√Ω v tomto prehliadaƒçi.");
        }
    };

    // Spustenie inicializ√°cie po naƒç√≠tan√≠ DOMu
    document.addEventListener('DOMContentLoaded', initializeApp);


    // --- PDF Funkcie (bez zmien, ponechan√© pre funkƒçnos≈•) ---
    function exportToPDF() {
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Kni≈ænica jsPDF alebo autoTable nie je spr√°vne naƒç√≠tan√°."); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; }
        const { jsPDF } = window.jspdf;
        try {
            const doc = new jsPDF();
            try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("Could not load Roboto font for PDF, using default.", e); }
            doc.setFontSize(18); doc.text(`Bruno's Calculator - V√Ωkaz (${getMonthName(state.currentMonth)} ${state.currentYear})`, 14, 20);
            doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${state.employeeName || 'Nezadan√©'}`, 14, 28);
            doc.text(`Hodinov√° mzda: ${state.hourlyWage || 'N/A'} ‚Ç¨`, 14, 34); doc.text(`Da≈à (%): ${state.taxRate*100 || 'N/A'}`, 100, 34);
            const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Odpracovan√©", "Hrub√° Mzda (‚Ç¨)", "ƒåist√° Mzda (‚Ç¨)", "Pozn√°mka"];
            const tableRows = [];
            const dataForCurrentMonth = getCurrentMonthData(); // Pou≈æi helper
            dataForCurrentMonth.forEach((dayData, index) => {
                const dayNum = index + 1;
                // Ak m√° de≈à nejak√Ω z√°znam (ƒças alebo pozn√°mku)
                if (dayData.start || dayData.end || dayData.breakTime || dayData.note) {
                    const dayName = getDayName(state.currentYear, state.currentMonth, dayNum);
                    // Z√≠skaj vypoƒç√≠tan√© hodnoty priamo z UI (keƒè≈æe calculateRow ich tam zapisuje)
                    const rowElement = uiElements.workDays.querySelector(`tr[data-day="${dayNum}"]`);
                    const workedTimeText = rowElement?.querySelector('td[data-field="total"]')?.textContent || 'N/A';
                    const grossValue = parseFloat(rowElement?.querySelector('input[data-field="gross"]')?.value || '0').toFixed(2);
                    const netValue = parseFloat(rowElement?.querySelector('input[data-field="net"]')?.value || '0').toFixed(2);

                    const rowData = [
                        `De≈à ${dayNum} (${dayName})`,
                        dayData.start || '-',
                        dayData.end || '-',
                        dayData.breakTime || '0',
                        workedTimeText,
                        grossValue,
                        netValue,
                        dayData.note || ''
                    ];
                    tableRows.push(rowData);
                }
            });
            doc.autoTable({
                head: [tableColumn], body: tableRows, startY: 40,
                headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName },
                styles: { font: doc.getFont().fontName, fontSize: 8 }, alternateRowStyles: { fillColor: [240, 240, 240] },
                 columnStyles: { 7: { cellWidth: 'auto' } } // Pozn√°mka
            });
            const finalY = doc.lastAutoTable.finalY || 40;
            doc.setFontSize(10);
            const totalTextContent = uiElements.totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, '');
            doc.text(totalTextContent, 14, finalY + 10);
            const pdfFileName = `Vykaz-${state.employeeName || 'pracovnik'}-${getMonthName(state.currentMonth)}-${state.currentYear}.pdf`;
            doc.save(pdfFileName); showSaveNotification("PDF exportovan√©.");
        } catch (error) { console.error("Chyba pri generovan√≠ PDF v exportToPDF:", error); alert("Nastala chyba pri vytv√°ran√≠ PDF s√∫boru."); }
    }

    function sendPDF() {
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Kni≈ænica jsPDF alebo autoTable nie je spr√°vne naƒç√≠tan√°."); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; }
        const { jsPDF } = window.jspdf;
        try {
            const doc = new jsPDF();
            try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("sendPDF: Could not load Roboto font, using default.", e); }
            doc.setFontSize(16); doc.text(`Pracovn√Ω v√Ωkaz - ${getMonthName(state.currentMonth)} ${state.currentYear}`, 14, 20);
            doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${state.employeeName || 'Nezadan√©'}`, 14, 28);
            const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Pozn√°mka"];
            const tableRows = [];
            const dataForCurrentMonth = getCurrentMonthData();
            let daysWithEntriesCount = 0; // Poƒç√≠tadlo pre summary
            dataForCurrentMonth.forEach((dayData, index) => {
                 if (dayData.start || dayData.end || dayData.breakTime || dayData.note) {
                    const dayNum = index + 1;
                    const dayName = getDayName(state.currentYear, state.currentMonth, dayNum);
                    const rowData = [
                        `De≈à ${dayNum} (${dayName})`,
                        dayData.start || '-',
                        dayData.end || '-',
                        dayData.breakTime || '0',
                        dayData.note || ''
                    ];
                    tableRows.push(rowData);
                    // Ak m√° riadok ƒçasov√Ω √∫daj, r√°taj ako odpracovan√Ω de≈à pre summary
                    if (dayData.start && dayData.end) {
                         daysWithEntriesCount++;
                    }
                 }
            });
            doc.autoTable({
                head: [tableColumn], body: tableRows, startY: 35,
                headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName },
                styles: { font: doc.getFont().fontName, fontSize: 9 }, alternateRowStyles: { fillColor: [240, 240, 240] },
                 columnStyles: { 4: { cellWidth: 'auto' } } // Pozn√°mka
            });
            const finalY = doc.lastAutoTable.finalY || 35;
            doc.setFontSize(10);
            // Z√≠skaj poƒçet dn√≠ priamo z UI (totalSalaryDiv) - jednoduch≈°ie ako znovu poƒç√≠ta≈•
             let daysText = 'N/A';
             const totalHtml = uiElements.totalSalaryDiv.innerHTML;
             const match = totalHtml.match(/Poƒçet odpracovan√Ωch dn√≠: (\d+)/);
             if (match && match[1]) {
                 daysText = match[1];
             }
             const summaryText = `Poƒçet odpracovan√Ωch dn√≠: ${daysText}`;
             doc.text(summaryText, 14, finalY + 10);

            const pdfBlob = doc.output('blob');
            const pdfFileName = `Vykaz_odoslanie-${state.employeeName || 'pracovnik'}-${getMonthName(state.currentMonth)}-${state.currentYear}.pdf`;
            const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                navigator.share({
                    files: [pdfFile],
                    title: `Pracovn√Ω v√Ωkaz ${getMonthName(state.currentMonth)} ${state.currentYear}`,
                    text: `V√Ωkaz pre ${state.employeeName || 'pracovn√≠ka'} za ${getMonthName(state.currentMonth)} ${state.currentYear}.`
                }).then(() => { showSaveNotification("PDF pripraven√© na zdieƒæanie."); })
                  .catch((error) => {
                      if (error.name !== 'AbortError') { // Ignoruj ak pou≈æ√≠vateƒæ zru≈°il zdieƒæanie
                           console.error('sendPDF: Chyba pri zdieƒæan√≠ cez Web Share API:', error);
                           alert('Chyba pri zdieƒæan√≠ s√∫boru.');
                      }
                 });
            } else {
                alert("Zdieƒæanie s√∫borov nie je podporovan√© va≈°√≠m prehliadaƒçom alebo syst√©mom. S√∫bor bude stiahnut√Ω.");
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.style.display = 'none'; a.href = url; a.download = pdfFileName;
                document.body.appendChild(a); a.click();
                window.URL.revokeObjectURL(url); document.body.removeChild(a);
            }
        } catch (error) {
            console.error("Chyba pri generovan√≠ alebo zdieƒæan√≠ PDF v sendPDF:", error);
            alert("Nastala chyba pri vytv√°ran√≠ alebo zdieƒæan√≠ PDF s√∫boru.");
        }
    }

  </script>
</body>
</html>
