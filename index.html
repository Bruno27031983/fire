<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <!-- Načítanie písma Roboto z Google Fonts (externá knižnica) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase knižnice -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <!-- Pridaná knižnica pre Firebase App Check -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF a autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 10px;
      background-color: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    .autor-info {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 14px;
      font-style: italic;
      color: #666;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite;
      margin-bottom: 10px;
    }
    h2 {
      text-align: center;
      color: #555;
      margin-top: -10px;
      font-size: 1.2em;
    }
    .settings {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    .settings > div {
      flex: 1 1 200px;
      margin: 5px;
    }
    .settings label {
      display: block;
      margin-bottom: 5px;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 800px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 0.9em;
    }
    th {
      background-color: #f2f2f2;
    }
    input[type="tel"], input[type="number"], input[type="text"] {
      width: 100%;
      padding: 5px;
      box-sizing: border-box;
      background-color: #ffffd0;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    .btn-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 15px;
      margin-top: 20px;
    }
    .btn {
      width: 100%;
      padding: 15px 20px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
      text-align: center;
    }
    .reset-btn { background-color: #f44336; }
    .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; }
    .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; }
    .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; }
    .backup-btn:hover { background-color: #E68900; }
    .highlight {
      background-color: #ffcc00;
      color: #333;
      font-weight: bold;
      border: 2px solid #ffcc00;
    }
    #totalSalary {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background-color: #e6f3ff;
      border-radius: 5px;
    }
    #dataSizeContainer {
      margin-top: 10px;
      text-align: center;
    }
    #dataSizeText {
      margin-bottom: 5px;
      font-size: 14px;
      color: #555;
    }
    #dataSizeBar {
      width: 80%;
      height: 20px;
      background-color: #ddd;
      border-radius: 10px;
      margin: 0 auto;
      overflow: hidden;
    }
    #dataSizeFill {
      height: 100%;
      width: 0%;
      background-color: #4CAF50;
      transition: width 0.3s ease;
    }
    .current-day {
      background-color: #8a2be2;
      color: white;
    }
    .current-day input {
      background-color: #9932cc;
      color: white;
    }
    @keyframes gradientText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes textShadowPulse {
      0%, 100% {
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5),
                     0 0 20px rgba(255, 255, 255, 0.3),
                     0 0 30px rgba(255, 255, 255, 0.2);
      }
      50% {
        text-shadow: 0 0 20px rgba(255, 255, 255, 1),
                     0 0 30px rgba(255, 255, 255, 0.9),
                     0 0 40px rgba(255, 255, 255, 0.7);
      }
    }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode { background-color: #666; color: white; }
    .btn.dark-mode { color: #333; }
    .reset-btn.dark-mode { background-color: #d32f2f; }
    .export-btn.dark-mode { background-color: #388e3c; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container {
      max-width: 400px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    #auth-container input {
      width: 90%;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    #auth-container button {
      width: 95%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      background-color: #4CAF50;
      color: #fff;
      font-size: 16px;
      border-radius: 3px;
      cursor: pointer;
    }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #4CAF50; /* Default Green */
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
      transition: background-color 0.3s ease;
    }
    #saveNotification.show { display: block; }
    #saveNotification.error { background-color: #f44336; } /* Red for errors */
    #saveNotification.warning { background-color: #ff9800; } /* Orange for warnings (e.g., offline) */

    /* Štýl pre prekryvnú obrazovku s hlásením "Načítavam..." */
    #loading-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: white;
      display: flex; /* Defaultne zobrazené */
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out; /* Pridaná animácia miznutia */
    }
    #loading-container.hidden { /* Trieda na skrytie */
        opacity: 0;
        pointer-events: none; /* Aby neblokovala klikanie */
    }
  </style>
</head>
<body>
  <!-- Prekryvná obrazovka počas načítavania -->
  <div id="loading-container">
    <h1>Nitra 3 : Žilina 2</h1>
  </div>

  <!-- Prihlasovací formulár – skrytý, kým nie je potrebný -->
  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
    </div>
    <button onclick="logout()">Odhlásiť sa</button>
  </div>

  <!-- Kalkulačka – skrytá, kým nebude používateľ prihlásený -->
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2></h2>
    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka: </label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€): </label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%): </label>
        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac: </label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option>
          <option value="1">Február</option>
          <option value="2">Marec</option>
          <option value="3">Apríl</option>
          <option value="4">Máj</option>
          <option value="5">Jún</option>
          <option value="6">Júl</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">Október</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok: </label>
        <select id="yearSelect" onchange="changeYear()"></select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Počet desatinných miest: </label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option>
          <option value="2">2</option>
        </select>
      </div>
      <button onclick="toggleDarkMode()" class="btn highlight">Prepínať tmavý režim</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka</th>
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Veľkosť dát: 0 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať všetko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu</button>
      <!-- Odstránené tlačidlo Načítať dáta z Firebase, deje sa automaticky -->
      <!-- <button class="btn export-btn" onclick="loadFromFirebase()">Načítať dáta z Firebase</button> -->
    </div>
  </div>

  <div id="saveNotification"></div>

  <script>
    // -----------------------
    // 1) Konfigurácia Firebase
    // -----------------------
    const firebaseConfig = {
      apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", // Uistite sa, že je kľúč správny
      authDomain: "bruno-3cee2.firebaseapp.com",
      projectId: "bruno-3cee2",
      storageBucket: "bruno-3cee2.appspot.com", // Skontrolujte storage bucket názov v konzole
      messagingSenderId: "155545319308",
      appId: "1:155545319308:web:5da498ff1cd3e1833888a9"
    };
    firebase.initializeApp(firebaseConfig);

    // Pokus o aktiváciu App Check, ošetrenie chyby offline
    try {
      // Nahrďte 'YOUR_RECAPTCHA_SITE_KEY' vaším skutočným kľúčom reCAPTCHA v3 alebo v2
      firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true);
      console.log("Firebase App Check sa pokúša aktivovať.");
    } catch (error) {
      console.warn("Chyba pri aktivácii Firebase App Check (pravdepodobne offline alebo nesprávny kľúč):", error);
    }

    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- SKRYŤ LOADING SCREEN PO KRÁTKEJ CHVÍLI ALEBO KEĎ JE FIREBASE READY ---
    // Môžeme ho skryť hneď, alebo počkať na prvý auth state change
    // Skrytie hneď:
    // document.getElementById('loading-container').classList.add('hidden');
    // Lepšie: Skryjeme ho v onAuthStateChanged, keď vieme, čo zobraziť

    // -----------------------
    // 2) Globálne premenné
    // -----------------------
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate, monthData = {}; // Inicializuj monthData ako prázdny objekt
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const MAX_DATA_SIZE = 4 * 1024 * 1024; // 4MB
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // -----------------------
    // 3) Prihlásenie / odhlásenie
    // -----------------------
    function register() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log("Registrovaný:", userCredential.user);
          alert("Registrácia úspešná!");
          // Po úspešnej registrácii by sa mal spustiť onAuthStateChanged
        })
        .catch((error) => {
          console.error("Chyba pri registrácii:", error.message);
          alert("Chyba pri registrácii: " + error.message);
        });
    }

    function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log("Prihlásený:", userCredential.user);
          alert("Prihlásenie úspešné!");
           // Po úspešnom prihlásení by sa mal spustiť onAuthStateChanged
        })
        .catch((error) => {
          console.error("Chyba pri prihlásení:", error.message);
          alert("Chyba pri prihlásení: " + error.message);
        });
    }

    function logout() {
      auth.signOut()
        .then(() => {
          console.log("Odhlásený.");
          alert("Odhlásenie úspešné!");
          // Po odhlásení sa spustí onAuthStateChanged
        })
        .catch((error) => {
          console.error("Chyba pri odhlásení:", error.message);
          alert("Chyba pri odhlásení: " + error.message);
        });
    }

    // --- UPRAVENÝ LISTENER PRE AUTH STATE ---
    auth.onAuthStateChanged(user => {
      const authMessage = document.getElementById('auth-message');
      const authContainer = document.getElementById('auth-container');
      const calculatorContainer = document.getElementById('calculator-container');
      const loadingContainer = document.getElementById('loading-container');

      // Skry loading screen, keď máme prvú odpoveď o stave prihlásenia
      if (loadingContainer) loadingContainer.classList.add('hidden');

      if (user) {
        // Používateľ je prihlásený (alebo bol naposledy prihlásený - stav z cache)
        authMessage.textContent = "Prihlásený: " + user.email + (navigator.onLine ? "" : " (Offline)");
        authContainer.style.display = "none";
        calculatorContainer.style.display = "block";

        // Najprv VŽDY skús načítat z localStorage pre rýchle zobrazenie UI
        console.log("Stav prihlásenia zmenený (používateľ prihlásený), načítavam z localStorage...");
        loadFromLocalStorage(); // Načíta posledné lokálne dáta a aktualizuje UI

        // AŽ POTOM, ak sme online, skús načítať/synchronizovať z Firebase
        if (navigator.onLine) {
            console.log("Sme online, pokúšam sa načítať aktuálne dáta z Firebase...");
            loadFromFirebase().catch(error => { // loadFromFirebase už aktualizuje UI ak nájde dáta
                 console.error("Nepodarilo sa načítať dáta z Firebase po prihlásení (možno len dočasná chyba siete):", error);
                 showSaveNotification("Nepodarilo sa načítať z Firebase", "error");
            });
            // Overenie/vytvorenie používateľského dokumentu
            const uid = user.uid;
            const userDocRef = db.collection("users").doc(uid);
            userDocRef.get().then(userDocSnap => {
                 if (!userDocSnap.exists) {
                     userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true }) // Použi merge pre istotu
                         .then(() => console.log("Vytvorený/aktualizovaný dokument pre:", uid))
                         .catch(err => console.error("Chyba pri vytváraní/aktualizácii dokumentu používateľa:", err));
                 }
            }).catch(err => console.error("Chyba pri kontrole dokumentu používateľa:", err));
        } else {
             console.log("Sme offline, pracujem s dátami z localStorage.");
             showSaveNotification("Pracujete v offline režime", "warning");
        }

      } else {
        // Používateľ nie je prihlásený
        authMessage.textContent = "Žiadny používateľ nie je prihlásený.";
        authContainer.style.display = "block";
        calculatorContainer.style.display = "none";
        console.log("Používateľ odhlásený, zobrazujem prihlasovací formulár.");
        // Tu by sme mali resetnúť premenné a UI do východzieho stavu, ak treba
        // napr. resetCalculatorState();
      }
    });
    // --- KONIEC ÚPRAVY LISTENERU ---


    // -----------------------
    // 4) Funkcie pre ukladanie
    // -----------------------
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }

    function showSaveNotification(message, type = 'success') { // type can be 'success', 'error', 'warning'
      const notification = document.getElementById('saveNotification');
      notification.textContent = message;
      notification.className = 'show'; // Reset classes
      if (type === 'error') {
        notification.classList.add('error');
      } else if (type === 'warning') {
        notification.classList.add('warning');
      }
      // Add 'show' class last to trigger transition if needed
      notification.classList.add('show');

      setTimeout(() => notification.classList.remove('show'), 3000); // Zobraz na 3 sekundy
    }

    // --- UPRAVENÉ saveToFirebase ---
    async function saveToFirebase() {
      if (!navigator.onLine) {
          console.log("Offline, preskakujem ukladanie do Firebase.");
          // Notifikáciu zobrazí saveToLocalStorage
          return;
      }
      const currentUser = auth.currentUser;
      if (!currentUser) {
          console.log("Nikto nie je prihlásený, preskakujem ukladanie do Firebase.");
          return;
      }

      try {
        const dataToSave = {
          workDaysData: JSON.stringify(monthData || {}), // Uisti sa, že neukladáš undefined
          hourlyWage: JSON.stringify(hourlyWage),
          taxRate: JSON.stringify(taxRate * 100),
          darkMode: JSON.stringify(document.body.classList.contains('dark-mode')),
          decimalPlaces: JSON.stringify(decimalPlaces),
          employeeName: JSON.stringify(employeeName),
          // Použi serverový timestamp pre lepšiu konzistenciu
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        const yearMonthDoc = `${currentYear}-${currentMonth}`;
        const uid = currentUser.uid;
        await db.collection("users").doc(uid)
          .collection("calculatorData").doc(yearMonthDoc).set(dataToSave); // set prepíše celý dokument
        console.log("Uložené do Firebase:", uid, yearMonthDoc);
        showSaveNotification("Dáta uložené (lokálne aj Firebase)");
      } catch (error) {
        console.error("Chyba pri ukladaní do Firebase:", error);
        showSaveNotification("Chyba: Nepodarilo sa uložiť do Firebase", "error");
      }
    }
    // --- KONIEC ÚPRAVY ---

    // --- saveToLocalStorage volá upravenú saveToFirebase ---
    function saveToLocalStorage() {
      try {
        // Zozbieraj dáta z inputov do dočasného poľa
        const currentMonthWorkData = [];
        for (let i = 1; i <= getDaysInMonth(currentMonth); i++) {
          const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)?.value || '';
          const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`)?.value || '';
          const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`)?.value || '';
          const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`)?.value || '0.00'; // Tieto sú len pre info, neukladáme? Alebo áno? Ukladáš ich.
          const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`)?.value || '0.00'; // Tieto sú len pre info, neukladáme? Alebo áno? Ukladáš ich.
          currentMonthWorkData.push({ start, end, breakTime, gross, net });
        }

        // Aktualizuj globálnu premennú monthData
        if (!monthData) monthData = {}; // Inicializácia, ak by bola null/undefined
        if (!monthData[currentYear]) monthData[currentYear] = {};
        monthData[currentYear][currentMonth] = currentMonthWorkData;

        // Skontroluj veľkosť pred uložením
        const serializedMonthData = JSON.stringify(monthData);
        const otherSettingsData = JSON.stringify(hourlyWage) + JSON.stringify(taxRate * 100) +
                                  JSON.stringify(document.body.classList.contains('dark-mode')) +
                                  JSON.stringify(decimalPlaces) + JSON.stringify(employeeName);
        const totalDataString = serializedMonthData + otherSettingsData;
        const bytes = new Blob([totalDataString]).size;

        if (bytes > MAX_DATA_SIZE) {
          alert(`Prekročili ste maximálnu veľkosť dát (${MAX_DATA_SIZE_KB} KB) v localStorage. Ukladanie zlyhalo.`);
          showSaveNotification("Chyba: Dáta sú príliš veľké!", "error");
          return; // Neukladaj nič, ak je to príliš veľké
        }

        // Uloženie do localStorage
        localStorage.setItem('workDaysData', serializedMonthData); // Ulož aktualizovaný celý objekt
        localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
        localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
        localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
        localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
        localStorage.setItem('employeeName', JSON.stringify(employeeName));
        // Ulož aj aktuálny mesiac a rok pre budúce načítanie
        localStorage.setItem('currentMonth', currentMonth.toString());
        localStorage.setItem('currentYear', currentYear.toString());


        updateDataSize(); // Aktualizuj info o veľkosti

        // Zavolaj saveToFirebase (ktorá interne skontroluje, či sme online)
        saveToFirebase(); // saveToFirebase zobrazí vlastnú notifikáciu o úspechu/neúspechu online ukladania

        // Ak sme offline, zobraz špeciálnu notifikáciu
        if (!navigator.onLine) {
            showSaveNotification("Offline: Uložené len lokálne", "warning");
        }

      } catch (error) {
        console.error('Chyba pri ukladaní do localStorage:', error);
        showSaveNotification("Kritická chyba pri ukladaní lokálnych dát!", "error");
        // alert("Kritická chyba pri ukladaní lokálnych dát: " + error.message); // Možno alert nie je nutný
      }
    }
    // Použi debounce na saveToLocalStorage
    const debouncedSaveToLocalStorage = debounce(saveToLocalStorage, 500); // Interval 500ms

    // --- UPRAVENÉ loadFromFirebase ---
    async function loadFromFirebase() {
        // Táto funkcia sa teraz volá len ak sme online (viď onAuthStateChanged)
        const uid = auth.currentUser?.uid;
        if (!uid) {
          console.log("loadFromFirebase: Nikto nie je prihlásený.");
          return; // UI by malo byť už inicializované z localStorage
        }

        try {
            const docRef = db.collection("users").doc(uid)
              .collection("calculatorData").doc(`${currentYear}-${currentMonth}`);
            const docSnap = await docRef.get({ source: 'server' }); // Vynúť čítanie zo servera

            if (docSnap.exists) {
              const data = docSnap.data();
              console.log("Načítané aktuálne dáta z Firebase:", data);

              // Skús spracovať dáta, ošetri chyby pri parse
              try {
                  const firebaseMonthData = JSON.parse(data.workDaysData || '{}');
                  const firebaseHourlyWage = parseFloat(JSON.parse(data.hourlyWage)) || 10;
                  const firebaseTaxRate = parseFloat(JSON.parse(data.taxRate)) / 100 || 0.02;
                  const firebaseDecimalPlaces = parseInt(JSON.parse(data.decimalPlaces)) || 1;
                  const firebaseEmployeeName = JSON.parse(data.employeeName) || '';
                  const firebaseDarkMode = JSON.parse(data.darkMode) || false;

                  // Porovnaj timestamp (ak existuje lokálny a firebase má serverový)
                  // a aktualizuj len ak sú dáta z Firebase novšie
                  // (Toto je zložitejšie, pre jednoduchosť teraz vždy prepíšeme lokálne dáta dátami z Firebase)

                  // Aktualizuj globálne premenné
                  monthData = firebaseMonthData;
                  hourlyWage = firebaseHourlyWage;
                  taxRate = firebaseTaxRate;
                  decimalPlaces = firebaseDecimalPlaces;
                  employeeName = firebaseEmployeeName;

                  // Prepíš localStorage najnovšími dátami z Firebase
                  localStorage.setItem('workDaysData', JSON.stringify(monthData));
                  localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                  localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                  localStorage.setItem('darkMode', JSON.stringify(firebaseDarkMode));
                  localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                  localStorage.setItem('employeeName', JSON.stringify(employeeName));
                  localStorage.setItem('currentMonth', currentMonth.toString());
                  localStorage.setItem('currentYear', currentYear.toString());


                  // Aktualizuj celé UI na základe načítaných dát z Firebase
                  updateUIFromLoadedData(firebaseDarkMode);

                  showSaveNotification("Dáta synchronizované z Firebase");

              } catch (parseError) {
                  console.error("Chyba pri spracovaní dát načítaných z Firebase:", parseError);
                  showSaveNotification("Chyba: Nesprávny formát dát z Firebase", "error");
                  // V tomto prípade NESMIEŠ prepísať localStorage chybnými dátami
                  // Spoliehaj sa na dáta už načítané z localStorage
              }

            } else {
              console.log("Žiadne dáta na Firebase pre:", `${currentYear}-${currentMonth}`);
              // Ak na Firebase nič nie je, NEPREPISUJ localStorage.
              // UI by už malo byť nastavené podľa localStorage.
              // Môžeš zobraziť informatívnu správu
              // showSaveNotification("Na serveri zatiaľ žiadne dáta pre tento mesiac");
            }
        } catch (error) {
            console.error("Chyba pri načítavaní z Firebase:", error);
            showSaveNotification("Chyba: Nepodarilo sa načítať z Firebase", "error");
        }
    }
    // --- KONIEC ÚPRAVY ---

    // --- loadFromLocalStorage ostáva, ale volá updateUIFromLoadedData ---
    function loadFromLocalStorage() {
      try {
        console.log("Načítavam dáta z localStorage...");
        // Načítaj dáta alebo použi defaultné hodnoty
        const storedMonthData = localStorage.getItem('workDaysData');
        monthData = storedMonthData ? JSON.parse(storedMonthData) : {};

        hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
        taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
        const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
        employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
        // Načítaj aj posledný mesiac/rok, ak sú uložené
        const storedMonth = localStorage.getItem('currentMonth');
        const storedYear = localStorage.getItem('currentYear');
        const currentDate = new Date();
        currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
        currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();


        // Aktualizuj UI podľa načítaných lokálnych dát
        updateUIFromLoadedData(darkMode);

      } catch (error) {
        console.error('Kritická chyba pri načítavaní/spracovaní dát z localStorage:', error);
        showSaveNotification("Chyba pri načítaní lokálnych dát!", "error");
        alert("Chyba pri načítaní lokálnych dát. Skúste vymazať dáta aplikácie alebo obnoviť zálohu.");
        // Tu by bolo dobré resetnúť UI do bezpečného stavu
        // resetCalculatorState();
      }
    }

    // --- NOVÁ POMOCNÁ FUNKCIA na aktualizáciu UI ---
    function updateUIFromLoadedData(darkModeValue) {
        console.log("Aktualizujem UI z načítaných dát...");
        try {
            // Nastav inputy a selecty
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = taxRate * 100;
            decimalPlacesSelect.value = decimalPlaces;
            employeeNameInput.value = employeeName;
            // Uisti sa, že selecty existujú a majú danú hodnotu
            if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
                monthSelect.value = currentMonth;
            } else {
                 monthSelect.value = new Date().getMonth(); // Fallback na aktuálny mesiac
            }
            if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                 yearSelect.value = currentYear;
            } else {
                 yearSelect.value = new Date().getFullYear(); // Fallback na aktuálny rok
                 populateYearSelect(); // Prepopuluj roky ak treba
                 yearSelect.value = currentYear;
            }


            // Vytvor tabuľku pre aktuálny mesiac/rok
            createTable();

            // Naplň tabuľku dátami z monthData
            const dataForMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            dataForMonth.forEach((day, index) => {
              const i = index + 1;
              const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
              const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
              const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
              if (startElement && endElement && breakElement) {
                startElement.value = day.start || '';
                endElement.value = day.end || '';
                breakElement.value = day.breakTime || '';
                calculateRow(i); // Prepočítaj hneď aj mzdu pre daný riadok
              }
            });

            calculateTotal(); // Prepočítaj celkovú sumu
            updateDataSize(); // Aktualizuj veľkosť dát

            // Aplikuj tmavý režim
            applyDarkMode(darkModeValue);

            console.log("UI aktualizované.");
        } catch (error) {
             console.error("Chyba počas aktualizácie UI:", error);
             showSaveNotification("Chyba pri prekresľovaní UI!", "error");
        }
    }
    // --- KONIEC NOVEJ FUNKCIE ---

    // --- Funkcia na aplikovanie Dark Mode ---
    function applyDarkMode(isDark) {
        const elementsToToggle = [
            document.body,
            document.querySelector('.container'),
            totalSalaryDiv,
            ...document.querySelectorAll('table, th, td, input'),
            ...document.querySelectorAll('.btn')
        ];
        const currentDayRow = document.querySelector('.current-day');
        if (currentDayRow) elementsToToggle.push(currentDayRow);

        if (isDark) {
            elementsToToggle.forEach(el => el?.classList.add('dark-mode'));
        } else {
            elementsToToggle.forEach(el => el?.classList.remove('dark-mode'));
        }
    }


    // -----------------------
    // 5) Vytváranie tabuľky
    // -----------------------
    function getDayName(year, month, day) {
      const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"];
      return daysOfWeek[new Date(year, month, day).getDay()];
    }

    function createTable() {
      workDays.innerHTML = ''; // Vyčisti tabuľku
      const daysInMonth = getDaysInMonth(currentMonth);
      const today = new Date();
      const currentDayOfMonth = today.getDate();
      const currentMonthIndex = today.getMonth();
      const currentYearValue = today.getFullYear();

      for (let i = 1; i <= daysInMonth; i++) {
        const row = document.createElement('tr');
        // Zvýrazni aktuálny deň
        if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
          row.classList.add('current-day');
        }
        const dayName = getDayName(currentYear, currentMonth, i);
        row.innerHTML = `
          <td>Deň ${i} (${dayName})</td>
          <td><input type="tel" id="start-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${currentYear}-${currentMonth}-${i}', ${i})"></td>
          <td><input type="tel" id="end-${currentYear}-${currentMonth}-${i}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${currentYear}-${currentMonth}-${i}', ${i})"></td>
          <td><input type="number" id="break-${currentYear}-${currentMonth}-${i}" min="0" step="0.5" placeholder="prestávka" oninput="handleBreakInput(${i})"></td>
          <td id="total-${currentYear}-${currentMonth}-${i}">0h 0m (${(0).toFixed(decimalPlaces || 1)} h)</td>
          <td><input type="number" id="gross-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Hrubá Mzda" readonly></td>
          <td><input type="number" id="net-${currentYear}-${currentMonth}-${i}" min="0" step="0.01" placeholder="Čistá Mzda" readonly></td>
          <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>
        `;
        workDays.appendChild(row);
      }
       // Aplikuj dark mode aj na novovytvorenú tabuľku
       applyDarkMode(document.body.classList.contains('dark-mode'));
    }

    function handleInput(input, nextId, day) {
      formatAndMoveNext(input, nextId);
      calculateRow(day); // Prepočítaj len aktuálny riadok
      calculateAndUpdateTotals(); // Spusti debounced ukladanie a prepočet celkových súm
    }

    function handleBreakInput(day) {
      calculateRow(day); // Prepočítaj len aktuálny riadok
      // Presun kurzora na ďalší deň - logika môže zostať
      const currentInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      const nextDay = day + 1;
      if (nextDay <= getDaysInMonth(currentMonth)) {
          const nextInputElement = document.getElementById(`start-${currentYear}-${currentMonth}-${nextDay}`);
          if (nextInputElement) moveNext(currentInput, `start-${currentYear}-${currentMonth}-${nextDay}`);
      }
      calculateAndUpdateTotals(); // Spusti debounced ukladanie a prepočet celkových súm
    }

    function calculateAndUpdateTotals() {
      calculateTotal(); // Prepočítaj súčty
      debouncedSaveToLocalStorage(); // Ulož zmeny (lokálne + prípadne online)
    }

    function formatAndMoveNext(input, nextId) {
      let value = input.value.replace(/[^\d:]/g, ''); // Odstráň nečíselné znaky okrem ':'
      // Automatické pridanie ':' po dvoch číslach
      if (value.length === 2 && !value.includes(':')) {
        // Ak používateľ píše ďalej, pridá sa ':' neskôr
      } else if (value.length === 3 && value.charAt(2) !== ':') {
         value = value.slice(0, 2) + ':' + value.slice(2);
      } else if (value.length === 4 && !value.includes(':')) {
         value = value.slice(0, 2) + ':' + value.slice(2);
      }
      // Obmedzenie na 5 znakov (HH:MM)
      if (value.length > 5) {
          value = value.slice(0, 5);
      }
      input.value = value;

      // Validácia a presun kurzora po dokončení (HH:MM)
      if (value.length === 5) {
        const parts = value.split(':');
        if (parts.length === 2) {
          const hours = parseInt(parts[0], 10);
          const minutes = parseInt(parts[1], 10);
          if (!isNaN(hours) && hours >= 0 && hours < 24 && !isNaN(minutes) && minutes >= 0 && minutes < 60) {
             // Validný čas, presuň kurzor
             moveNext(input, nextId);
          } else {
            // Neplatný čas, upozorni alebo označ pole
            console.warn("Neplatný čas:", value);
            // Môžeš pridať vizuálnu indikáciu chyby
            input.style.border = '1px solid red';
            // A odstrániť ju po chvíli alebo pri ďalšej úprave
            setTimeout(() => { input.style.border = ''; }, 2000);
          }
        } else {
           input.style.border = '1px solid red'; // Neplatný formát
            setTimeout(() => { input.style.border = ''; }, 2000);
        }
      } else {
           input.style.border = ''; // Odstráň červený rámik, ak čas nie je kompletný
      }
    }

    function moveNext(currentElement, nextId) {
      const nextElement = document.getElementById(nextId);
      if (nextElement) {
          nextElement.focus();
          // Označ text v nasledujúcom inpute pre ľahšie prepísanie
          if (nextElement.select) {
              nextElement.select();
          }
      }
    }

    function calculateRow(day) {
      const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value;
      const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value;
      const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      const breakTime = parseFloat(breakTimeInput?.value) || 0;
      const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
      const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
      const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

      // Ak niektorý element chýba, skonči
      if (!startTimeStr || !endTimeStr || !totalCell || !grossElement || !netElement) {
          console.warn(`Elementy pre výpočet riadku ${day} neboli nájdené.`);
          return;
      }

      // Validácia časov
      const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
      if (!timeRegex.test(startTimeStr) || !timeRegex.test(endTimeStr)) {
          totalCell.textContent = 'Neplatný čas';
          grossElement.value = '0.00';
          netElement.value = '0.00';
          return; // Neplatný formát času
      }

      const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
      const [endHours, endMinutes] = endTimeStr.split(':').map(Number);

      // Výpočet rozdielu v minútach
      const startTotalMinutes = startHours * 60 + startMinutes;
      let endTotalMinutes = endHours * 60 + endMinutes;

      // Ak koncový čas je menší ako začiatočný (práca cez polnoc)
      if (endTotalMinutes < startTotalMinutes) {
          endTotalMinutes += 24 * 60; // Pridaj 24 hodín v minútach
      }

      const diffMinutes = endTotalMinutes - startTotalMinutes;
      const breakMinutes = breakTime * 60;
      const workedMinutes = Math.max(0, diffMinutes - breakMinutes); // Odpracované minúty nemôžu byť záporné

      const hours = Math.floor(workedMinutes / 60);
      const minutes = Math.round(workedMinutes % 60); // Zaokrúhli minúty
      const decimalHours = (workedMinutes / 60);

      totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces || 1)} h)`;

      // Výpočet mzdy
      const currentHourlyWage = parseFloat(hourlyWageInput.value) || 0; // Získaj aktuálnu hodinovú mzdu
      const currentTaxRate = (parseFloat(taxRateInput.value) || 0) / 100; // Získaj aktuálnu daňovú sadzbu

      const grossSalary = decimalHours * currentHourlyWage;
      grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(decimalPlaces || 1) : '0.00';
      const netSalary = grossSalary * (1 - currentTaxRate);
      netElement.value = isFinite(netSalary) ? netSalary.toFixed(decimalPlaces || 1) : '0.00';
    }

    function resetRow(day) {
      const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
      const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
      const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
      const total = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
      const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
      const net = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
      if (start && end && breakTime && total && gross && net) {
        start.value = '';
        end.value = '';
        breakTime.value = '';
        total.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
        gross.value = '0.00';
        net.value = '0.00';
        calculateAndUpdateTotals(); // Prepočítaj a ulož zmeny
      }
    }

    function resetAll() {
      if (confirm('Naozaj chcete resetovať všetky záznamy pre tento mesiac?')) {
        if (monthData && monthData[currentYear]) {
          delete monthData[currentYear][currentMonth]; // Odstráň dáta pre aktuálny mesiac z globálnej premennej
        }
        // Vyčisti aj tabuľku v UI
        createTable(); // Vytvorí prázdnu tabuľku
        calculateTotal(); // Prepočíta súčty (budú 0)
        // Ulož prázdny stav
        debouncedSaveToLocalStorage();
        showSaveNotification("Dáta pre aktuálny mesiac boli resetované.");
      }
    }

    function calculateTotal() {
      let totalMinutes = 0;
      let totalGrossSalary = 0;
      let totalNetSalary = 0;
      let daysWithEntries = 0;
      const rows = workDays.querySelectorAll('tr');

      rows.forEach((row, index) => {
          const dayIndex = index + 1; // Deň v mesiaci (1-based)
          const startInput = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`);
          const endInput = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`);
          const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayIndex}`);
          const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayIndex}`);

          // Započítaj len riadky, ktoré majú nejaký vstup času a platnú mzdu
          if (startInput?.value || endInput?.value) {
              const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${dayIndex}`);
              if (totalCell && totalCell.textContent !== 'Neplatný čas') {
                  // Extrahuj odpracované minúty z textu (napr. "8h 20m (...)")
                  const timeMatch = totalCell.textContent.match(/(\d+)h (\d+)m/);
                  if (timeMatch) {
                      const hours = parseInt(timeMatch[1]) || 0;
                      const minutes = parseInt(timeMatch[2]) || 0;
                      totalMinutes += hours * 60 + minutes;
                  }
              }

              const grossValue = parseFloat(grossInput?.value) || 0;
              const netValue = parseFloat(netInput?.value) || 0;
              if (grossValue > 0 || netValue > 0) { // Započítaj deň len ak má mzdu > 0
                  daysWithEntries++;
                  totalGrossSalary += grossValue;
                  totalNetSalary += netValue;
              }
          }
      });

      const totalHours = Math.floor(totalMinutes / 60);
      const totalMinutesRemainder = Math.round(totalMinutes % 60);
      const totalDecimalHours = (totalMinutes / 60).toFixed(decimalPlaces || 1);

      const averageNetSalary = daysWithEntries > 0 ? (totalNetSalary / daysWithEntries).toFixed(decimalPlaces || 1) : '0.00';
      const averageWorkedMinutes = daysWithEntries > 0 ? totalMinutes / daysWithEntries : 0;
      const averageHours = Math.floor(averageWorkedMinutes / 60);
      const averageMinutes = Math.round(averageWorkedMinutes % 60);
      const averageDecimalHours = (averageWorkedMinutes / 60).toFixed(decimalPlaces || 1);

      totalSalaryDiv.innerHTML = `
        Počet odpracovaných dní: ${daysWithEntries}<br>
        Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${totalDecimalHours} h)<br>
        Celková hrubá mzda: ${totalGrossSalary.toFixed(decimalPlaces || 1)}€<br>
        Celková čistá mzda: ${totalNetSalary.toFixed(decimalPlaces || 1)}€<br>
        Priemerná čistá mzda na deň: ${averageNetSalary}€<br>
        <strong>Priemerný odpracovaný čas na deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours} h)</strong>
      `;
    }


    // -----------------------
    // 7) Export do PDF
    // -----------------------
    function exportToPDF() {
      // Kontrola jsPDF knižníc
      if (typeof jspdf === 'undefined' || typeof jspdf.plugin.autotable === 'undefined') {
          alert("Chyba: Knižnica jsPDF alebo autoTable nie je načítaná.");
          console.error("jsPDF or autoTable is not loaded");
          return;
      }
       const { jsPDF } = window.jspdf; // Použi window.jspdf ak je globálne

      const doc = new jsPDF();

      // Pridanie fontu (skontroluj cestu alebo použi štandardný font)
      try {
          // Skús pridať font, ak zlyhá, použije sa defaultný
          doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
          doc.setFont('Roboto');
          console.log("Roboto font added to PDF.");
      } catch (e) {
          console.warn("Could not load Roboto font for PDF, using default font.", e);
          doc.setFont('helvetica'); // Fallback font
      }


      doc.setFontSize(18);
      doc.text(`Bruno's Calculator - Výkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
      doc.setFontSize(12); // Menšie písmo pre meno
      doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28);
      doc.text(`Hodinová mzda: ${hourlyWage || 'N/A'} €`, 14, 34); // Pridaj info o mzde
      doc.text(`Daň (%): ${taxRate*100 || 'N/A'}`, 100, 34); // Pridaj info o dani


      const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované", "Hrubá Mzda (€)", "Čistá Mzda (€)"];
      const tableRows = [];

      const dataForMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];

      dataForMonth.forEach((day, index) => {
          // Zobraz len dni, kde je nejaký záznam času
          if (day.start || day.end) {
              const dayNum = index + 1;
              const dayName = getDayName(currentYear, currentMonth, dayNum);
              // Načítaj odpracovaný čas z UI, lebo ten sa počíta dynamicky
              const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${dayNum}`);
              const workedTimeText = totalCell ? totalCell.textContent : 'N/A';

              const rowData = [
                  `Deň ${dayNum} (${dayName})`,
                  day.start || '-',
                  day.end || '-',
                  day.breakTime || '0',
                  workedTimeText,
                  day.gross || '0.00',
                  day.net || '0.00'
              ];
              tableRows.push(rowData);
          }
      });

      doc.autoTable({
          head: [tableColumn],
          body: tableRows,
          startY: 40, // Posuň tabuľku nižšie
          headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName }, // Použi aktuálny font
          styles: { font: doc.getFont().fontName, fontSize: 9 }, // Menšie písmo v tabuľke
          alternateRowStyles: { fillColor: [240, 240, 240] }
      });

      // Pridaj celkové súčty pod tabuľku
      const finalY = doc.lastAutoTable.finalY || 40; // Získaj pozíciu pod tabuľkou
      doc.setFontSize(10); // Menšie písmo pre súčty
      // Získaj text zo súčtového divu a odstráň HTML značky
      const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br>/g, '\n').replace(/<strong>|<\/strong>/g, '');
      doc.text(totalTextContent, 14, finalY + 10);

      // Ulož PDF
      doc.save(`Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`);
    }

    // --- Funkcia Send PDF (zdieľanie) ---
    function sendPDF() {
       // Kontrola jsPDF knižníc
       if (typeof jspdf === 'undefined' || typeof jspdf.plugin.autotable === 'undefined') {
           alert("Chyba: Knižnica jsPDF alebo autoTable nie je načítaná.");
           console.error("jsPDF or autoTable is not loaded");
           return;
       }
       const { jsPDF } = window.jspdf;
       const doc = new jsPDF();

       // Pridanie fontu (rovnako ako v exportToPDF)
       try {
           doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal');
           doc.setFont('Roboto');
       } catch (e) {
           console.warn("Could not load Roboto font for PDF, using default font.", e);
           doc.setFont('helvetica');
       }

       // Vygeneruj obsah PDF (rovnako ako v exportToPDF)
       doc.setFontSize(18);
       doc.text(`Bruno's Calculator - Výkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
       doc.setFontSize(12);
       doc.text(`Meno pracovníka: ${employeeName || 'Nezadané'}`, 14, 28);
       doc.text(`Hodinová mzda: ${hourlyWage || 'N/A'} €`, 14, 34);
       doc.text(`Daň (%): ${taxRate*100 || 'N/A'}`, 100, 34);


       const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované", "Hrubá Mzda (€)", "Čistá Mzda (€)"];
       const tableRows = [];
       const dataForMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
       dataForMonth.forEach((day, index) => {
           if (day.start || day.end) {
               const dayNum = index + 1;
               const dayName = getDayName(currentYear, currentMonth, dayNum);
               const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${dayNum}`);
               const workedTimeText = totalCell ? totalCell.textContent : 'N/A';
               const rowData = [ `Deň ${dayNum} (${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0', workedTimeText, day.gross || '0.00', day.net || '0.00' ];
               tableRows.push(rowData);
           }
       });
       doc.autoTable({
           head: [tableColumn], body: tableRows, startY: 40,
           headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName },
           styles: { font: doc.getFont().fontName, fontSize: 9 },
           alternateRowStyles: { fillColor: [240, 240, 240] }
       });
       const finalY = doc.lastAutoTable.finalY || 40;
       doc.setFontSize(10);
       const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br>/g, '\n').replace(/<strong>|<\/strong>/g, '');
       doc.text(totalTextContent, 14, finalY + 10);

       // Získaj PDF ako Blob
       try {
           const pdfBlob = doc.output('blob');
           const pdfFileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
           const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

           // Skontroluj, či je Web Share API dostupné
           if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
               navigator.share({
                   files: [pdfFile],
                   title: `Pracovný výkaz ${getMonthName(currentMonth)} ${currentYear}`,
                   text: `Výkaz pre ${employeeName || 'pracovníka'} za ${getMonthName(currentMonth)} ${currentYear}.`
               })
               .then(() => console.log('PDF úspešne zdieľané.'))
               .catch((error) => {
                    // Ignoruj AbortError, ktorý nastane, ak používateľ zruší zdieľanie
                    if (error.name !== 'AbortError') {
                        console.error('Chyba pri zdieľaní PDF:', error);
                        alert('Chyba pri zdieľaní súboru.');
                    } else {
                         console.log('Zdieľanie PDF zrušené používateľom.');
                    }
                });
           } else {
               // Fallback - stiahnutie súboru, ak zdieľanie nie je podporované
               console.log("Web Share API nie je podporované, sťahujem PDF.");
               alert("Zdieľanie súborov nie je podporované vaším prehliadačom alebo systémom. Súbor bude stiahnutý.");
               const url = URL.createObjectURL(pdfBlob);
               const a = document.createElement('a');
               a.href = url;
               a.download = pdfFileName;
               document.body.appendChild(a); // Pridaj do DOM pre Firefox
               a.click();
               document.body.removeChild(a); // Odstráň z DOM
               URL.revokeObjectURL(url); // Uvoľni pamäť
           }
       } catch (error) {
           console.error("Chyba pri generovaní alebo zdieľaní PDF:", error);
           alert("Nastala chyba pri vytváraní alebo zdieľaní PDF súboru.");
       }
    }

    // -----------------------
    // 8) Ostatné nastavenia
    // -----------------------
    function changeDecimalPlaces() {
      const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
      if (!isNaN(newDecimalPlaces)) {
          decimalPlaces = newDecimalPlaces;
          // Prepočítaj všetky riadky a súčty s novým počtom miest
          updateUIFromLoadedData(document.body.classList.contains('dark-mode')); // Prekreslí celé UI
          debouncedSaveToLocalStorage(); // Ulož zmenu nastavenia
      }
    }

    function updateEmployeeName() {
      employeeName = employeeNameInput.value.trim();
      debouncedSaveToLocalStorage(); // Ulož zmenu mena
    }

    function updateSettings() {
      const newHourlyWage = parseFloat(hourlyWageInput.value);
      const newTaxRatePercent = parseFloat(taxRateInput.value);

      if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
          hourlyWage = newHourlyWage;
      } else {
          hourlyWageInput.value = hourlyWage; // Vráť späť pôvodnú hodnotu, ak je neplatná
      }
      if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0) {
          taxRate = newTaxRatePercent / 100;
      } else {
           taxRateInput.value = taxRate * 100; // Vráť späť pôvodnú hodnotu
      }
      // Prepočítaj všetky riadky a súčty s novými nastaveniami
      updateUIFromLoadedData(document.body.classList.contains('dark-mode')); // Prekreslí celé UI
      debouncedSaveToLocalStorage(); // Ulož zmeny
    }


    function changeMonth() {
      const selectedMonth = parseInt(monthSelect.value);
      if (currentMonth !== selectedMonth) {
          currentMonth = selectedMonth;
          console.log(`Zmenený mesiac na: ${getMonthName(currentMonth)}`);
          // Načítaj dáta pre nový mesiac (najprv z localStorage, potom z Firebase ak online)
          handleMonthYearChange();
      }
    }

    function changeYear() {
      const selectedYear = parseInt(yearSelect.value);
       if (currentYear !== selectedYear) {
          currentYear = selectedYear;
          console.log(`Zmenený rok na: ${currentYear}`);
          // Načítaj dáta pre nový rok (najprv z localStorage, potom z Firebase ak online)
          handleMonthYearChange();
      }
    }

    function handleMonthYearChange() {
         // 1. Skús načítať z localStorage pre nový mesiac/rok
         loadFromLocalStorage(); // Toto načíta a prekreslí UI pre nový mesiac/rok

         // 2. Ak sme online, skús načítať z Firebase
         if (navigator.onLine && auth.currentUser) {
             console.log("Sme online, pokúšam načítať dáta z Firebase pre nový mesiac/rok...");
             loadFromFirebase().catch(error => {
                 console.error("Nepodarilo sa načítať dáta z Firebase po zmene mesiaca/roka:", error);
                  showSaveNotification("Nepodarilo sa načítať z Firebase", "error");
             });
         } else if (!auth.currentUser) {
             console.log("Používateľ nie je prihlásený, zobrazujem dáta z localStorage (ak existujú).");
         } else {
              console.log("Sme offline, zobrazujem dáta z localStorage.");
              showSaveNotification("Pracujete v offline režime", "warning");
         }
         // Ulož nový mesiac/rok do local storage, aby sa pamätal aj po refreshi
         localStorage.setItem('currentMonth', currentMonth.toString());
         localStorage.setItem('currentYear', currentYear.toString());
    }


    function getDaysInMonth(month) {
        // Mesiac je 0-indexed (0 = Január, 11 = December)
        // Rok je potrebný pre presný počet dní vo Februári
        return new Date(currentYear, month + 1, 0).getDate();
    }

    function getMonthName(month) {
      const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      return monthNames[month] || 'Neznámy'; // Vráť 'Neznámy', ak je index mimo rozsahu
    }

    function updateDataSize() {
      try {
          const totalData = Object.values(localStorage).reduce((acc, value) => acc + (value ? value.length : 0), 0);
          // Odhad veľkosti v bytoch (UTF-16 znaky môžu zaberať viac)
          // Presnejšie by bolo new Blob(Object.values(localStorage)).size, ale môže byť pomalšie
          const kilobytes = (totalData * 2 / 1024).toFixed(2); // Približný odhad v KB
          const percentageUsed = Math.min(((totalData * 2 / MAX_DATA_SIZE) * 100), 100);

          dataSizeText.textContent = `Lokálne úložisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
          dataSizeFill.style.width = `${percentageUsed}%`;
          // Farba podľa zaplnenia
          if (percentageUsed > 90) {
              dataSizeFill.style.backgroundColor = '#f44336'; // Červená
          } else if (percentageUsed > 70) {
              dataSizeFill.style.backgroundColor = '#ff9800'; // Oranžová
          } else {
              dataSizeFill.style.backgroundColor = '#4CAF50'; // Zelená
          }
      } catch (error) {
           console.error("Chyba pri výpočte veľkosti localStorage:", error);
           dataSizeText.textContent = "Chyba pri výpočte veľkosti dát.";
      }
    }

    function toggleDarkMode() {
      const isDarkMode = document.body.classList.toggle('dark-mode');
      applyDarkMode(isDarkMode); // Aplikuj zmeny na všetky elementy
      // Ulož nový stav dark mode
      localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
      // Ulož aj do Firebase (ak sme online)
      if (navigator.onLine && auth.currentUser) {
          const uid = auth.currentUser.uid;
          db.collection("users").doc(uid)
            .collection("calculatorData").doc(`${currentYear}-${currentMonth}`)
            .set({ darkMode: JSON.stringify(isDarkMode) }, { merge: true }) // Použi merge na aktualizáciu len tohto poľa
            .then(() => console.log("Dark mode stav uložený do Firebase."))
            .catch(error => console.error("Chyba pri ukladaní dark mode do Firebase:", error));
      }
       // Nepotrebujeme volať saveToLocalStorage tu, lebo meníme len vizuál a ukladáme priamo darkMode
       // Ale ak by saveToLocalStorage ukladalo VŽDY celý stav, tak by sme ju mali zavolať:
       // debouncedSaveToLocalStorage();
    }


    // -----------------------
    // 9) Zálohovanie a obnova
    // -----------------------
    function createBackup() {
      try {
          const backupData = {
              workDaysData: localStorage.getItem('workDaysData') || '{}', // Pošli string alebo prázdny objekt string
              hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(10),
              taxRate: localStorage.getItem('taxRate') || JSON.stringify(2),
              darkMode: localStorage.getItem('darkMode') || JSON.stringify(false),
              decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(1),
              employeeName: localStorage.getItem('employeeName') || JSON.stringify(''),
              // Môžeš pridať verziu alebo timestamp zálohy
              backupVersion: 1,
              backupTimestamp: new Date().toISOString()
          };
          const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `bruno-calculator-backup-${new Date().toISOString().slice(0,10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showSaveNotification("Záloha úspešne vytvorená.");
      } catch (error) {
           console.error("Chyba pri vytváraní zálohy:", error);
           alert("Nastala chyba pri vytváraní záložného súboru.");
      }
    }

    function restoreBackup() {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.json,application/json';
      fileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const backup = JSON.parse(e.target.result);
            // Validácia základnej štruktúry zálohy (voliteľné)
            if (backup && typeof backup.workDaysData === 'string' && typeof backup.hourlyWage === 'string') {
                // Prepíš localStorage dátami zo zálohy
                localStorage.setItem('workDaysData', backup.workDaysData);
                localStorage.setItem('hourlyWage', backup.hourlyWage);
                localStorage.setItem('taxRate', backup.taxRate);
                localStorage.setItem('darkMode', backup.darkMode);
                localStorage.setItem('decimalPlaces', backup.decimalPlaces);
                localStorage.setItem('employeeName', backup.employeeName);
                // Môžeš načítať aj mesiac/rok zo zálohy, ak tam sú
                // localStorage.setItem('currentMonth', ...);
                // localStorage.setItem('currentYear', ...);


                // Načítaj obnovené dáta do aplikácie a prekresli UI
                loadFromLocalStorage();
                showSaveNotification("Záloha úspešne obnovená.");
                alert("Záloha bola úspešne obnovená. Dáta boli načítané.");
                // Po obnove by bolo dobré spustiť aj uloženie do Firebase (ak online)
                saveToFirebase();

            } else {
                 alert("Chyba: Súbor zálohy má nesprávny formát.");
            }
          } catch (error) {
            console.error("Chyba pri spracovaní alebo obnove zálohy:", error);
            alert("Chyba pri čítaní alebo obnove zálohy. Súbor môže byť poškodený alebo mať nesprávny formát.");
          }
        };
         reader.onerror = (e) => {
             console.error("Chyba pri čítaní súboru zálohy:", e);
             alert("Nastala chyba pri čítaní súboru zálohy.");
         };
        reader.readAsText(file);
      };
      fileInput.click(); // Otvor dialóg na výber súboru
    }

    // -----------------------
    // 10) Inicializácia
    // -----------------------
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM načítaný, inicializujem...");

      // Nastav select pre roky HNEĎ
      populateYearSelect();

      // Ostatné UI prvky (ako inputy, tabuľka) sa nastavia/načítajú
      // v rámci loadFromLocalStorage(), ktorú zavolá onAuthStateChanged.
      // Nastavíme len základný stav, aby sa niečo zobrazilo, kým sa auth overí.
      hourlyWageInput.value = 10;
      taxRateInput.value = 2;
      decimalPlacesSelect.value = 1;
      employeeNameInput.value = '';
      monthSelect.value = new Date().getMonth(); // Default na aktuálny mesiac
      yearSelect.value = new Date().getFullYear(); // Default na aktuálny rok
      createTable(); // Vytvor prázdnu tabuľku
      calculateTotal(); // Vypočítaj nuly
      updateDataSize(); // Zobraz veľkosť localStorage

      // Service Worker registrácia (zostáva tu, ale vo window.load)
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { // Počkaj na úplné načítanie stránky
          navigator.serviceWorker.register('./service-worker.js')
            .then(registration => {
              console.log('ServiceWorker zaregistrovaný s rozsahom: ', registration.scope);
            })
            .catch(error => {
              console.error('Registrácia ServiceWorker zlyhala: ', error); // Použi console.error
            });
        });
      } else {
         console.warn("Service Worker nie je podporovaný v tomto prehliadači.");
      }
      console.log("Základná inicializácia dokončená, čakám na stav prihlásenia...");
    });

    function populateYearSelect() {
      const startYear = 2020;
      const endYear = new Date().getFullYear() + 2; // Ukáž aktuálny rok + 2 roky do budúcnosti
      yearSelect.innerHTML = ''; // Vyčisti predošlé možnosti
      for (let year = startYear; year <= endYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
    }

  </script>
</body>
</html>
