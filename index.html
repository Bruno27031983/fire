<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruno's Calculator s Firebase v9</title>
    <link rel="manifest" href="manifest.json"> <meta name="theme-color" content="#4CAF50">

    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

   <style>

Â  Â  /* CSS Å¡tÃ½ly zostÃ¡vajÃº rovnakÃ© */

Â  Â  body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }

Â  Â  .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }

Â  Â  .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }

Â  Â  h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }

Â  Â  h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }

Â  Â  .settings {

Â  Â  Â  Â  margin-bottom: 20px;

Â  Â  Â  Â  display: flex;

Â  Â  Â  Â  flex-wrap: wrap;

Â  Â  Â  Â  justify-content: space-between;

Â  Â  Â  Â  align-items: flex-start; /* ZmenenÃ© na flex-start pre lepÅ¡ie zarovnanie s details */

Â  Â  Â  Â  gap: 10px; /* PridanÃ½ gap pre medzery */

Â  Â  }

Â  Â  /* Priame deti .settings (div, details, button) */

Â  Â  .settings > div,

Â  Â  .settings > details,

Â  Â  .settings > button {

Â  Â  Â  Â  flex: 1 1 200px; /* Zachovanie flex basis */

Â  Â  Â  Â  margin: 0; /* OdstrÃ¡nenÃ½ margin, pouÅ¾Ã­vame gap */

Â  Â  }

Â  Â  .settings label { display: block; margin-bottom: 5px; }

Â  Â  .table-container { overflow-x: auto; }

Â  Â  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 950px; /* Mierne zvÃ¤ÄÅ¡enÃ¡ min-width kvÃ´li ikonÃ¡m */ }

Â  Â  th, td {

Â  Â  Â  Â  padding: 8px;

Â  Â  Â  Â  border: 1px solid #ddd;

Â  Â  Â  Â  text-align: left;

Â  Â  Â  Â  font-size: 0.9em;

Â  Â  Â  Â  vertical-align: top; /* Zarovnaj obsah buniek hore */

Â  Â  Â  Â  position: relative; /* Pozicovanie pre ikony */

Â  Â  }

Â  Â  th { background-color: #f2f2f2; }

Â  Â  input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea /* PridanÃ½ select a .note-textarea */ {

Â  Â  Â  Â  width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px;

Â  Â  }

Â  Â  /* Ãšprava paddingu pre tel inputy kvÃ´li ikone */

Â  Â  input[type="tel"] {

Â  Â  Â  Â  padding-right: 28px; /* Priestor pre ikonu */

Â  Â  }

Â  Â  /* Å tÃ½ly pre ikonu hodÃ­n */

Â  Â  .time-icon {

Â  Â  Â  Â  position: absolute;

Â  Â  Â  Â  right: 8px; /* Odsadenie od pravÃ©ho okraja bunky */

Â  Â  Â  Â  top: 50%;

Â  Â  Â  Â  transform: translateY(-50%); /* VertikÃ¡lne centrovanie */

Â  Â  Â  Â  cursor: pointer;

Â  Â  Â  Â  font-size: 1.2em; /* VeÄ¾kosÅ¥ ikony */

Â  Â  Â  Â  color: #555; /* Farba ikony */

Â  Â  Â  Â  user-select: none; /* ZabrÃ¡ni oznaÄeniu textu ikony */

Â  Â  Â  Â  z-index: 2; /* Aby bola nad inputom, ak by sa prekrÃ½vali */

Â  Â  }

Â  Â  .time-icon:hover {

Â  Â  Â  Â  color: #007bff; /* Zmena farby pri prejdenÃ­ myÅ¡ou */

Â  Â  Â  Â  opacity: 0.8;

Â  Â  }

Â  Â  body.dark-mode .time-icon {

Â  Â  Â  Â  color: #bbb; /* SvetlejÅ¡ia ikona v tmavom reÅ¾ime */

Â  Â  }

Â  Â  body.dark-mode .time-icon:hover {

Â  Â  Â  Â  color: #87cefa; /* SvetlomodrÃ¡ pri hover v tmavom reÅ¾ime */

Â  Â  }



Â  Â  /* --- NOVÃ‰: Å tÃ½ly pre ikonu indikÃ¡tora poznÃ¡mky --- */

Â  Â  Â .note-indicator-icon {

Â  Â  Â  Â  display: none; /* Å tandardne skrytÃ© */

Â  Â  Â  Â  font-size: 0.9em; /* Trochu menÅ¡ie */

Â  Â  Â  Â  margin-right: 4px; /* Medzera pred tlaÄidlom */

Â  Â  Â  Â  color: #28a745; /* ZelenÃ¡ pre indikÃ¡ciu */

Â  Â  Â  Â  vertical-align: middle; /* Zarovnanie s textom tlaÄidla */

Â  Â  Â  Â  cursor: default; /* Nie je klikateÄ¾nÃ¡ */

Â  Â  Â }

Â  Â  Â body.dark-mode .note-indicator-icon {

Â  Â  Â  Â  Â color: #6fbf7a; /* SvetlejÅ¡ia zelenÃ¡ v tmavom reÅ¾ime */

Â  Â  Â }

Â  Â  /* --- KONIEC novÃ½ch Å¡tÃ½lov pre ikonu indikÃ¡tora --- */





Â  Â  /* Uprav Å¡Ã­rky stÄºpcov podÄ¾a potreby */

Â  Â  th:nth-child(1), td:nth-child(1) { min-width: 50px; } /* DeÅˆ */

Â  Â  th:nth-child(2), td:nth-child(2) { min-width: 90px; } /* PrÃ­chod */

Â  Â  th:nth-child(3), td:nth-child(3) { min-width: 90px; } /* Odchod */

Â  Â  th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* PrestÃ¡vka */

Â  Â  th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* OdpracovanÃ© */

Â  Â  th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* HrubÃ¡ Mzda */

Â  Â  th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* ÄŒistÃ¡ Mzda */

Â  Â  th:nth-child(8), td:nth-child(8) { min-width: 130px; } /* PoznÃ¡mka - mierne Å¡irÅ¡Ã­ kvÃ´li ikone */

Â  Â  th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia */



Â  Â  .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }

Â  Â  .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }

Â  Â  .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }

Â  Â  .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }

Â  Â  .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }

Â  Â  .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }

Â  Â  .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }

Â  Â  #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }

Â  Â  #dataSizeContainer { margin-top: 10px; text-align: center; }

Â  Â  #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }

Â  Â  #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }

Â  Â  #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }

Â  Â  .current-day { background-color: #8a2be2; color: white; }

Â  Â  .current-day input, .current-day .note-textarea /* PridanÃ© .note-textarea pre current-day */ { background-color: #9932cc; color: white; }

Â  Â  @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

Â  Â  @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }

Â  Â  body.dark-mode { background-color: #333; color: #f4f4f4; }

Â  Â  .container.dark-mode { background-color: #444; color: #f4f4f4; }

Â  Â  table.dark-mode { background-color: #555; color: #f4f4f4; }

Â  Â  th.dark-mode { background-color: #666; }

Â  Â  td.dark-mode { background-color: #444; color: #f4f4f4; }

Â  Â  input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode /* PridanÃ½ select a .note-textarea */ {

Â  Â  Â  Â  background-color: #666; color: white; border-color: #888; /* PridanÃ¡ farba okraja pre dark mode */

Â  Â  }

Â  Â  .btn.dark-mode { color: #333; }

Â  Â  .reset-btn.dark-mode { background-color: #d32f2f; }

Â  Â  .export-btn.dark-mode { background-color: #388e3c; }

Â  Â  .restore-btn.dark-mode { background-color: #7B1FA2; }

Â  Â  .backup-btn.dark-mode { background-color: #E68900; }

Â  Â  #totalSalary.dark-mode { background-color: #2c3e50; }

Â  Â  .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }

Â  Â  .current-day.dark-mode input, .current-day.dark-mode .note-textarea /* PridanÃ© .note-textarea pre current-day dark mode */ { background-color: #5c1db3; color: #fff; }

Â  Â  body.dark-mode .autor-info { color: #aaa; }

Â  Â  #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }

Â  Â  #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }

Â  Â  #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }

Â  Â  #auth-container button:hover { background-color: #45a049; }

Â  Â  #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }

Â  Â  #saveNotification.show { display: block; opacity: 1; }

Â  Â  #saveNotification.error { background-color: #f44336; }

Â  Â  #saveNotification.warning { background-color: #ff9800; }

Â  Â  #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }

Â  Â  #loading-container.hidden { opacity: 0; pointer-events: none; }

Â  Â  #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }

Â  Â  #forgot-password-link:hover { text-decoration: underline; }



Â  Â  /* --- Å TÃLY PRE ZBALITEÄ½NÃš ÄŒASÅ¤ (nezmenenÃ©) --- */

Â  Â  .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }

Â  Â  .collapsible-settings summary:hover { background-color: #eee; }

Â  Â  .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }

Â  Â  .collapsible-content > div { flex: 1 1 200px; margin: 0; }

Â  Â  body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }

Â  Â  body.dark-mode .collapsible-settings summary:hover { background-color: #666; }

Â  Â  body.dark-mode .collapsible-content { border-top-color: #666; }



Â  Â  /* --- Å TÃLY PRE POZNÃMKY --- */

Â  Â  .note-container {

Â  Â  Â  Â  display: none; /* Å tandardne skrytÃ© */

Â  Â  Â  Â  margin-top: 5px;

Â  Â  }

Â  Â  .note-container.visible {

Â  Â  Â  Â  display: block; /* ZobrazenÃ© po kliknutÃ­ alebo naÄÃ­tanÃ­ */

Â  Â  }

Â  Â  .note-textarea {

Â  Â  Â  Â  width: 95%; /* Trochu menÅ¡ia Å¡Ã­rka kvÃ´li paddingu bunky */

Â  Â  Â  Â  min-height: 40px; /* MinimÃ¡lna vÃ½Å¡ka */

Â  Â  Â  Â  resize: vertical; /* PovoliÅ¥ len vertikÃ¡lnu zmenu veÄ¾kosti */

Â  Â  Â  Â  box-sizing: border-box;

Â  Â  Â  Â  padding: 5px;

Â  Â  Â  Â  border: 1px solid #ccc;

Â  Â  Â  Â  border-radius: 3px;

Â  Â  Â  Â  font-size: 13px; /* Trochu menÅ¡ie pÃ­smo pre poznÃ¡mky */

Â  Â  Â  Â  background-color: #f0f0f0; /* SvetlÃ© pozadie pre odlÃ­Å¡enie */

Â  Â  Â  Â  /* Dedi vlastnosti z nadradenÃ©ho pravidla pre inputy */

Â  Â  }

Â  Â  .toggle-note-btn {

Â  Â  Â  Â  background-color: #6c757d; /* Å edÃ¡ farba */

Â  Â  Â  Â  color: white;

Â  Â  Â  Â  padding: 3px 8px; /* MenÅ¡Ã­ padding */

Â  Â  Â  Â  border: none;

Â  Â  Â  Â  border-radius: 3px;

Â  Â  Â  Â  cursor: pointer;

Â  Â  Â  Â  font-size: 12px; /* MenÅ¡ie pÃ­smo */

Â  Â  Â  Â  transition: background-color 0.2s ease;

Â  Â  Â  Â  margin-bottom: 2px; /* MalÃ½ odstup od textarea, ak je viditeÄ¾nÃ¡ */

Â  Â  Â  Â  vertical-align: middle; /* Zarovnanie s ikonou */

Â  Â  }

Â  Â  .toggle-note-btn:hover {

Â  Â  Â  Â  background-color: #5a6268;

Â  Â  }

Â  Â  /* Dark mode pre poznÃ¡mky */

Â  Â  .note-textarea.dark-mode {

Â  Â  Â  Â  background-color: #555;

Â  Â  Â  Â  color: #f4f4f4;

Â  Â  Â  Â  border-color: #777;

Â  Â  }

Â  Â  .toggle-note-btn.dark-mode {

Â  Â  Â  Â  background-color: #828a91;

Â  Â  }

Â  Â  .toggle-note-btn.dark-mode:hover {

Â  Â  Â  Â  background-color: #70777d;

Â  Â  }

Â  Â  /* --- KONIEC Å TÃLOV PRE POZNÃMKY --- */



Â  </style>
        body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
        .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
        h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
        h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
        .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .settings > div, .settings > details, .settings > button { flex: 1 1 200px; margin: 0; }
        .settings label { display: block; margin-bottom: 5px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 950px; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; position: relative; }
        th { background-color: #f2f2f2; }
        input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
        input[type="tel"] { padding-right: 28px; }
        .time-icon { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2em; color: #555; user-select: none; z-index: 2; }
        .time-icon:hover { color: #007bff; opacity: 0.8; }
        .note-indicator-icon { display: none; font-size: 0.9em; margin-right: 4px; color: #28a745; vertical-align: middle; cursor: default; }
        th:nth-child(1), td:nth-child(1) { min-width: 50px; } /* DeÅˆ */
        th:nth-child(2), td:nth-child(2) { min-width: 90px; } /* PrÃ­chod */
        th:nth-child(3), td:nth-child(3) { min-width: 90px; } /* Odchod */
        th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* PrestÃ¡vka */
        th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* OdpracovanÃ© */
        th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* HrubÃ¡ Mzda */
        th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* ÄŒistÃ¡ Mzda */
        th:nth-child(8), td:nth-child(8) { min-width: 130px; } /* PoznÃ¡mka */
        th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia */
        .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
        .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
        .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
        .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
        .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
        .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
        .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
        #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
        #dataSizeContainer { margin-top: 10px; text-align: center; }
        #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
        #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
        #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
        .current-day { background-color: #8a2be2; color: white; }
        .current-day input, .current-day .note-textarea { background-color: #9932cc; color: white; }
        @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
        body.dark-mode { background-color: #333; color: #f4f4f4; }
        .container.dark-mode { background-color: #444; color: #f4f4f4; }
        table.dark-mode { background-color: #555; color: #f4f4f4; }
        th.dark-mode { background-color: #666; }
        td.dark-mode { background-color: #444; color: #f4f4f4; }
        input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode { background-color: #666; color: white; border-color: #888; }
        .btn.dark-mode { color: #333; }
        .reset-btn.dark-mode { background-color: #d32f2f; }
        .export-btn.dark-mode { background-color: #388e3c; }
        .restore-btn.dark-mode { background-color: #7B1FA2; }
        .backup-btn.dark-mode { background-color: #E68900; }
        #totalSalary.dark-mode { background-color: #2c3e50; }
        .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
        .current-day.dark-mode input, .current-day.dark-mode .note-textarea { background-color: #5c1db3; color: #fff; }
        body.dark-mode .autor-info { color: #aaa; }
        #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
        #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
        #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
        #auth-container button:hover { background-color: #45a049; }
        #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
        #saveNotification.show { display: block; opacity: 1; }
        #saveNotification.error { background-color: #f44336; }
        #saveNotification.warning { background-color: #ff9800; }
        #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
        #loading-container.hidden { opacity: 0; pointer-events: none; }
        #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
        #forgot-password-link:hover { text-decoration: underline; }
        .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
        .collapsible-settings summary:hover { background-color: #eee; }
        .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
        .collapsible-content > div { flex: 1 1 200px; margin: 0; }
        body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
        body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
        body.dark-mode .collapsible-content { border-top-color: #666; }
        .note-container { display: none; margin-top: 5px; }
        .note-container.visible { display: block; }
        .note-textarea { width: 95%; min-height: 40px; resize: vertical; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; background-color: #f0f0f0; }
        .toggle-note-btn { background-color: #6c757d; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease; margin-bottom: 2px; vertical-align: middle; }
        .toggle-note-btn:hover { background-color: #5a6268; }
        .note-textarea.dark-mode { background-color: #555; color: #f4f4f4; border-color: #777; }
        .toggle-note-btn.dark-mode { background-color: #828a91; }
        .toggle-note-btn.dark-mode:hover { background-color: #70777d; }
        body.dark-mode .time-icon { color: #bbb; }
        body.dark-mode .time-icon:hover { color: #87cefa; }
        body.dark-mode .note-indicator-icon { color: #6fbf7a; }

    </style>
</head>
<body>
    <div id="loading-container"><h1>Tajomstvo Ãºspechu je sluÅ¡nosÅ¥ a ÃºprimnosÅ¥. AkonÃ¡hle sa ich zbavÃ­te, dosiahnete vÅ¡etko.</h1></div>

    <div id="auth-container" style="display:none;">
        <h1>PrihlÃ¡senie / RegistrÃ¡cia</h1>
        <div id="auth-message">Å½iadny pouÅ¾Ã­vateÄ¾ nie je prihlÃ¡senÃ½.</div>
        <div id="auth-forms">
            <h2>RegistrÃ¡cia</h2>
            <input type="email" id="registerEmail" placeholder="Email">
            <input type="password" id="registerPassword" placeholder="Heslo">
            <button onclick="register()">RegistrovaÅ¥</button>
            <h2>PrihlÃ¡senie</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Heslo">
            <button onclick="login()">PrihlÃ¡siÅ¥ sa</button>
            <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
        </div>
    </div>

    <div id="calculator-container" class="container" style="display:none;">
        <div class="autor-info">Vytvoril Bruno</div>
        <h1 id="mainTitle">Bruno's Calculator</h1>
        <h2 id="welcomeMessage"></h2>
        <div class="settings">
            <div>
                <label for="monthSelect">Mesiac: </label>
                <select id="monthSelect" onchange="changeMonth()">
                    <option value="0">JanuÃ¡r</option> <option value="1">FebruÃ¡r</option> <option value="2">Marec</option>
                    <option value="3">AprÃ­l</option> <option value="4">MÃ¡j</option> <option value="5">JÃºn</option>
                    <option value="6">JÃºl</option> <option value="7">August</option> <option value="8">September</option>
                    <option value="9">OktÃ³ber</option> <option value="10">November</option> <option value="11">December</option>
                </select>
            </div>

            <details class="collapsible-settings">
                <summary>ÄalÅ¡ie nastavenia</summary>
                <div class="collapsible-content">
                    <div>
                        <label for="employeeNameInput">Meno pracovnÃ­ka: </label>
                        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovnÃ­ka" oninput="updateEmployeeName()">
                    </div>
                    <div>
                        <label for="hourlyWageInput">HodinovÃ¡ mzda (â‚¬): </label>
                        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
                    </div>
                    <div>
                        <label for="taxRateInput">DaÅˆovÃ© percento (%): </label>
                        <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
                    </div>
                    <div>
                        <label for="yearSelect">Rok: </label>
                        <select id="yearSelect" onchange="changeYear()"></select>
                    </div>
                    <div>
                        <label for="decimalPlacesSelect">PoÄet desatinnÃ½ch miest: </label>
                        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                            <option value="1">1</option>
                            <option value="2" selected>2</option> </select>
                    </div>
                </div>
            </details>

            <button onclick="toggleDarkMode()" class="btn highlight">PrepÃ­naÅ¥ tmavÃ½ reÅ¾im</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>DeÅˆ</th><th>PrÃ­chod</th><th>Odchod</th><th>PrestÃ¡vka</th>
                        <th>OdpracovanÃ©</th><th>HrubÃ¡ Mzda (â‚¬)</th><th>ÄŒistÃ¡ Mzda (â‚¬)</th>
                        <th class="th-note">PoznÃ¡mka</th><th>Akcia</th>
                    </tr>
                </thead>
                <tbody id="workDays"></tbody>
            </table>
        </div>
        <div id="totalSalary"></div>
        <div id="dataSizeContainer">
            <div id="dataSizeText">LokÃ¡lne ÃºloÅ¾isko: ~0.00 KB / 4096 KB</div>
            <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
        </div>
        <div class="btn-container">
            <button class="btn reset-btn" onclick="resetAll()">ResetovaÅ¥ vÅ¡etko</button>
            <button class="btn export-btn" onclick="exportToPDF()">ExportovaÅ¥ do PDF</button>
            <button class="btn export-btn" onclick="sendPDF()">OdoslaÅ¥ PDF</button>
            <button class="btn restore-btn" onclick="restoreBackup()">ObnoviÅ¥ zÃ¡lohu (JSON)</button>
            <button class="btn backup-btn" onclick="createBackup()">VytvoriÅ¥ zÃ¡lohu (JSON)</button>
            <button id="logout-btn" class="btn reset-btn" onclick="logout()" style="display: none;">OdhlÃ¡siÅ¥ sa</button>
        </div>
    </div>
    <div id="saveNotification"></div>

    <script type="module">
        // --- Firebase v9+ Importy ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, enableIndexedDbPersistence, doc, getDoc, setDoc, onSnapshot, serverTimestamp, collection, deleteDoc /* PrÃ­padne potrebnÃ© pre reset */ } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check.js";

        // --- Firebase KonfigurÃ¡cia (z vÃ¡Å¡ho prvÃ©ho kÃ³du) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", // <-- KÄ¾ÃºÄ z V1
            authDomain: "bruno-3cee2.firebaseapp.com",      // <-- DomÃ©na z V1
            projectId: "bruno-3cee2",                       // <-- ProjectID z V1
            storageBucket: "bruno-3cee2.appspot.com",       // <-- Storage Bucket z V1
            messagingSenderId: "155545319308",              // <-- SenderID z V1
            appId: "1:155545319308:web:5da498ff1cd3e1833888a9" // <-- AppID z V1
        };

        // --- Firebase InicializÃ¡cia ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // App Check InicializÃ¡cia (nahraÄte kÄ¾ÃºÄom!)
        try {
            initializeAppCheck(app, {
                provider: new ReCaptchaV3Provider('YOUR_RECAPTCHA_V3_SITE_KEY'), // <-- NAHRAÄTE VAÅ ÃM KÄ½ÃšÄŒOM!
                isTokenAutoRefreshEnabled: true
            });
            console.log("Firebase App Check initialized.");
        } catch (error) {
            console.warn("Firebase App Check failed to initialize:", error);
        }

        // Povolenie Firestore Offline Persistence
        enableIndexedDbPersistence(db)
            .then(() => {
                console.log("Firestore offline persistence enabled.");
            })
            .catch((err) => {
                console.error("Firestore offline persistence error:", err);
                if (err.code == 'failed-precondition') {
                    console.warn("Firestore offline persistence: Multiple tabs open, persistence can only be enabled in one tab at a time.");
                } else if (err.code == 'unimplemented') {
                    console.error("Firestore offline persistence: The current browser does not support all of the features required to enable persistence.");
                }
            });

        // --- GlobÃ¡lne PremennÃ© (z vÃ¡Å¡ho prvÃ©ho kÃ³du) ---
        let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
        let monthData = {}; // DÃ´leÅ¾itÃ© pre ukladanie dÃ¡t vrÃ¡tane poznÃ¡mok
        let firestoreListenerUnsubscribe = null;
        let currentUser = null; // Na uchovanie aktuÃ¡lne prihlÃ¡senÃ©ho pouÅ¾Ã­vateÄ¾a

        const workDays = document.getElementById('workDays');
        const totalSalaryDiv = document.getElementById('totalSalary');
        const dataSizeText = document.getElementById('dataSizeText');
        const dataSizeFill = document.getElementById('dataSizeFill');
        const hourlyWageInput = document.getElementById('hourlyWageInput');
        const taxRateInput = document.getElementById('taxRateInput');
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
        const employeeNameInput = document.getElementById('employeeNameInput');
        const logoutBtn = document.getElementById('logout-btn');
        const MAX_DATA_SIZE = 4 * 1024 * 1024; // 4MB limit pre localStorage
        const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

        // --- PomocnÃ© Funkcie (vÃ¤ÄÅ¡inou z V1 kÃ³du) ---
        function showSaveNotification(message, type = 'success') {
            const notification = document.getElementById('saveNotification');
            if (!notification) return;
            notification.textContent = message;
            notification.className = 'show'; // Reset class
            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            }
            notification.classList.add('show'); // Ensure 'show' is added
            setTimeout(() => {
                notification.classList.remove('show');
                // Ensure specific type classes are also removed if needed
                notification.classList.remove('error', 'warning');
            }, 3000);
        }

        function getFirstName(fullName) {
            if (!fullName || typeof fullName !== 'string') return '';
            const trimmedName = fullName.trim();
            if (!trimmedName) return '';
            const parts = trimmedName.split(' ');
            return parts[0];
        }

        function updateWelcomeMessage() {
            const welcomeElement = document.getElementById('welcomeMessage');
            if (!welcomeElement) return;
            const firstName = getFirstName(employeeName);
            welcomeElement.textContent = firstName ? `Vitaj spÃ¤Å¥, ${firstName}! ğŸ‘‹` : '';
        }

        // --- Auth Funkcie (prepÃ­sanÃ© na v9) ---
        window.register = async () => { // Priradenie k window pre onclick v HTML
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // VoliteÄ¾ne vytvor uÅ¾Ã­vateÄ¾skÃ½ dokument hneÄ po registrÃ¡cii
                const userDocRef = doc(db, "users", userCredential.user.uid);
                await setDoc(userDocRef, { email: userCredential.user.email, createdAt: new Date().toISOString() }, { merge: true });
                alert("RegistrÃ¡cia ÃºspeÅ¡nÃ¡!");
            } catch (error) {
                console.error("Chyba pri registrÃ¡cii:", error);
                showSaveNotification("Chyba pri registrÃ¡cii: " + error.message, "error");
                alert("Chyba pri registrÃ¡cii: " + error.message); // PonechanÃ½ alert pre priamu spÃ¤tnÃº vÃ¤zbu
            }
        }

        window.login = async () => { // Priradenie k window pre onclick v HTML
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                 alert("PrihlÃ¡senie ÃºspeÅ¡nÃ©!"); // PonechanÃ½ alert
            } catch (error) {
                console.error("Chyba pri prihlÃ¡senÃ­:", error);
                showSaveNotification("Chyba pri prihlÃ¡senÃ­: " + error.message, "error");
                 alert("Chyba pri prihlÃ¡senÃ­: " + error.message); // PonechanÃ½ alert
            }
        }

        window.logout = async () => { // Priradenie k window pre onclick v HTML
            try {
                await signOut(auth);
                // alert("OdhlÃ¡senie ÃºspeÅ¡nÃ©!"); // Alert nie je nutnÃ½, UI sa zmenÃ­
            } catch (error) {
                console.error("Chyba pri odhlÃ¡senÃ­:", error);
                showSaveNotification("Chyba pri odhlÃ¡senÃ­: " + error.message, "error");
                alert("Chyba pri odhlÃ¡senÃ­: " + error.message);
            }
        }

        window.forgotPassword = async () => { // Priradenie k window pre onclick v HTML
            const emailInput = document.getElementById('loginEmail');
            const email = emailInput.value;
            if (!email) {
                alert("ProsÃ­m, zadajte svoju e-mailovÃº adresu do poÄ¾a pre prihlÃ¡senie.");
                emailInput.focus();
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                alert("Odkaz na obnovenie hesla bol odoslanÃ½ na vaÅ¡u e-mailovÃº adresu. Skontrolujte si prosÃ­m poÅ¡tu (aj prieÄinok Spam).");
            } catch (error) {
                console.error("Chyba pri odosielanÃ­ e-mailu na obnovenie hesla:", error);
                showSaveNotification("Chyba pri odosielanÃ­ e-mailu na obnovenie hesla: " + error.message, "error");
                alert("Chyba pri odosielanÃ­ e-mailu na obnovenie hesla: " + error.message);
            }
        }

        // --- Auth State Change Listener (prepÃ­sanÃ½ na v9) ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user; // UloÅ¾enie aktuÃ¡lneho pouÅ¾Ã­vateÄ¾a
            const authContainer = document.getElementById('auth-container');
            const calculatorContainer = document.getElementById('calculator-container');
            const loadingContainer = document.getElementById('loading-container');

            if (loadingContainer) loadingContainer.classList.add('hidden');

            // Odpojenie predchÃ¡dzajÃºceho listenera, ak existuje
            if (firestoreListenerUnsubscribe) {
                firestoreListenerUnsubscribe();
                firestoreListenerUnsubscribe = null;
                console.log("Previous Firestore listener unsubscribed.");
            }

            if (user) {
                // PouÅ¾Ã­vateÄ¾ prihlÃ¡senÃ½
                document.getElementById('auth-message').textContent = "PrihlÃ¡senÃ½: " + user.email;
                authContainer.style.display = "none";
                calculatorContainer.style.display = "block";
                logoutBtn.style.display = "inline-block"; // Zobraz logout tlaÄidlo

                // NaÄÃ­tanie poslednÃ©ho stavu z localStorage (rovnakÃ© ako V1)
                const storedMonth = localStorage.getItem('currentMonth');
                const storedYear = localStorage.getItem('currentYear');
                const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                const currentDate = new Date();

                currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();

                // Overenie a nastavenie selectov (rovnakÃ© ako V1)
                monthSelect.value = currentMonth;
                if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                    yearSelect.value = currentYear;
                } else {
                    console.warn(`Rok ${currentYear} z localStorage nenÃ¡jdenÃ½ v selecte, pouÅ¾Ã­vam aktuÃ¡lny rok.`);
                    currentYear = currentDate.getFullYear();
                    populateYearSelect(); // Znovu naplnÃ­ select, ak by rok chÃ½bal
                    yearSelect.value = currentYear;
                }

                applyDarkMode(darkMode); // Aplikuj tmavÃ½ reÅ¾im

                // NaÄÃ­tanie ostatnÃ½ch nastavenÃ­ z localStorage (rovnakÃ© ako V1)
                hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
                decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2; // Default 2
                employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

                hourlyWageInput.value = hourlyWage;
                taxRateInput.value = taxRate * 100;
                decimalPlacesSelect.value = decimalPlaces;
                employeeNameInput.value = employeeName;

                loadFromLocalStorage(); // PrvÃ© naÄÃ­tanie UI z localStorage

                setupFirestoreListener(); // Nastavenie listenera pre real-time dÃ¡ta

                // Kontrola / vytvorenie uÅ¾Ã­vateÄ¾skÃ©ho dokumentu vo Firestore (v9 syntax)
                const userDocRef = doc(db, "users", user.uid);
                 getDoc(userDocRef).then(userDocSnap => {
                    if (!userDocSnap.exists()) {
                        setDoc(userDocRef, { email: user.email, createdAt: new Date().toISOString() }, { merge: true })
                            .catch(err => console.error("Chyba pri vytvÃ¡ranÃ­ dokumentu pouÅ¾Ã­vateÄ¾a:", err));
                    }
                }).catch(err => {
                    console.error("Chyba pri kontrole dokumentu pouÅ¾Ã­vateÄ¾a (getDoc):", err);
                    showSaveNotification("Chyba pri overovanÃ­ pouÅ¾Ã­vateÄ¾skÃ½ch dÃ¡t", "error");
                });

            } else {
                // PouÅ¾Ã­vateÄ¾ odhlÃ¡senÃ½
                currentUser = null; // VymaÅ¾ pouÅ¾Ã­vateÄ¾a
                document.getElementById('auth-message').textContent = "Å½iadny pouÅ¾Ã­vateÄ¾ nie je prihlÃ¡senÃ½.";
                authContainer.style.display = "block";
                calculatorContainer.style.display = "none";
                logoutBtn.style.display = "none"; // Skry logout tlaÄidlo

                // VyÄistenie dÃ¡t pri odhlÃ¡senÃ­
                monthData = {};
                workDays.innerHTML = '';
                totalSalaryDiv.innerHTML = '';
                updateWelcomeMessage(); // Skryje uvÃ­tanie
            }
        });

        // --- Firestore Listener (prepÃ­sanÃ½ na v9) ---
        function setupFirestoreListener() {
            if (firestoreListenerUnsubscribe) { // Odpojenie existujÃºceho
                 firestoreListenerUnsubscribe();
                 firestoreListenerUnsubscribe = null;
                 console.log("Existing Firestore listener detached before setting up new one.");
            }
            if (!currentUser) {
                console.log("No user logged in, cannot setup Firestore listener.");
                return;
            }
            const uid = currentUser.uid;

            if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                const now = new Date();
                currentMonth = currentMonth ?? now.getMonth();
                currentYear = currentYear ?? now.getFullYear();
                console.warn("setupFirestoreListener: Missing month/year. Using current.", currentYear, currentMonth);
            }

            const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
            const docRef = doc(db, docPath);
            console.log(`Setting up Firestore listener for path: ${docPath}`);

            firestoreListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                console.log("Firestore snapshot received. Source:", docSnap.metadata.fromCache ? "cache" : "server", "Pending writes:", docSnap.metadata.hasPendingWrites);
                const hasPending = docSnap.metadata.hasPendingWrites;
                const activeElementId = document.activeElement?.id; // AktÃ­vne fokusovanÃ½ element

                // ---- Logika spracovania snapshotu zostÃ¡va veÄ¾mi podobnÃ¡ V1 kÃ³du ----
                // ---- HlavnÃ½ rozdiel je, ako sa pristupuje k dÃ¡tam (`docSnap.data()`, `docSnap.exists()`) ----

                 if (hasPending) {
                     // LokÃ¡lny zÃ¡pis - len aktualizujeme internÃ½ stav `monthData`, neprepisujeme UI inputy
                     console.log("Processing pending write snapshot.");
                     if (docSnap.exists()) {
                         const data = docSnap.data();
                         const firebaseDaysData = data.days || [];
                         if (!monthData) monthData = {};
                         if (!monthData[currentYear]) monthData[currentYear] = {};
                         // UchovÃ¡me stav poznÃ¡mok
                         monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                             start: day.start || '',
                             end: day.end || '',
                             breakTime: day.breakTime || '',
                             note: day.note || '',
                             noteVisible: day.noteVisible === true // ZachovÃ¡me boolean
                         }));
                     }
                     // NeprekresÄ¾ujeme UI z pending writes, aby sme neprepisovali prÃ¡ve menenÃ© pole
                     return;
                 }

                // DÃ¡ta zo servera alebo cache (bez lokÃ¡lnych zmien)
                if (docSnap.exists()) {
                    console.log("Processing server/cache snapshot.");
                    const data = docSnap.data();
                    try {
                        // NaÄÃ­taj nastavenia z Firebase (rovnakÃ¡ logika ako V1)
                        const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
                        const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
                        const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
                        const firebaseEmployeeName = data.employeeName ?? employeeName;
                        const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');
                        const firebaseDaysData = data.days || [];

                        // Aktualizuj globÃ¡lne premennÃ© (rovnakÃ¡ logika ako V1)
                        hourlyWage = firebaseHourlyWage;
                        taxRate = firebaseTaxRatePercent / 100;
                        decimalPlaces = firebaseDecimalPlaces;
                        employeeName = firebaseEmployeeName;

                        // Aktualizuj UI nastavenÃ­ (okrem fokusovanÃ½ch) - rovnakÃ¡ logika ako V1
                        if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
                        if (document.activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
                        decimalPlacesSelect.value = decimalPlaces;
                        if (document.activeElement !== employeeNameInput) employeeNameInput.value = employeeName;

                        // Priprav monthData na zÃ¡klade Firebase (rovnakÃ¡ logika ako V1 vrÃ¡tane noteVisible)
                        if (!monthData) monthData = {};
                        if (!monthData[currentYear]) monthData[currentYear] = {};
                        monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                             start: day.start || '', end: day.end || '', breakTime: day.breakTime || '',
                             note: day.note || '', noteVisible: day.noteVisible === true
                        }));

                        // OPTIMALIZOVANÃ AKTUALIZÃCIA UI RIADKOV (rovnakÃ¡ logika ako V1)
                        const daysInMonth = getDaysInMonth(currentMonth);
                        let anyRowRecalculated = false;

                        for (let i = 1; i <= daysInMonth; i++) {
                            const dayIndex = i - 1;
                            const firebaseDayData = monthData[currentYear]?.[currentMonth]?.[dayIndex] || { start: '', end: '', breakTime: '', note: '', noteVisible: false };
                            const baseId = `${currentYear}-${currentMonth}-${i}`;
                            const startId = `start-${baseId}`; const endId = `end-${baseId}`; const breakId = `break-${baseId}`;
                            const noteId = `note-${baseId}`; const noteContainerId = `note-container-${baseId}`;
                            const noteButtonId = `note-toggle-${baseId}`; const noteIndicatorId = `note-indicator-${baseId}`;

                            const startElement = document.getElementById(startId);
                            const endElement = document.getElementById(endId);
                            const breakElement = document.getElementById(breakId);
                            const noteElement = document.getElementById(noteId);
                            const noteContainer = document.getElementById(noteContainerId);
                            const noteButton = document.getElementById(noteButtonId);
                            const noteIndicator = document.getElementById(noteIndicatorId);

                            if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
                                const newStart = firebaseDayData.start || ''; const newEnd = firebaseDayData.end || '';
                                const newBreak = firebaseDayData.breakTime || ''; const newNote = firebaseDayData.note || '';
                                const newNoteVisible = firebaseDayData.noteVisible === true;
                                let rowUpdatedByListener = false;

                                // Aktualizuj len ak nie je fokus a hodnota sa lÃ­Å¡i
                                if (startElement.value !== newStart && activeElementId !== startId) { startElement.value = newStart; rowUpdatedByListener = true; }
                                if (endElement.value !== newEnd && activeElementId !== endId) { endElement.value = newEnd; rowUpdatedByListener = true; }
                                if (breakElement.value !== newBreak && activeElementId !== breakId) { breakElement.value = newBreak; rowUpdatedByListener = true; }
                                if (noteElement.value !== newNote && activeElementId !== noteId) {
                                    noteElement.value = newNote;
                                    updateNoteIndicator(i); // Aktualizuj indikÃ¡tor
                                }

                                // Aktualizuj viditeÄ¾nosÅ¥ poznÃ¡mky
                                const currentNoteVisible = noteContainer.classList.contains('visible');
                                if (currentNoteVisible !== newNoteVisible) {
                                    noteContainer.classList.toggle('visible', newNoteVisible);
                                    noteButton.textContent = newNoteVisible ? 'SkryÅ¥' : 'PoznÃ¡mka';
                                }

                                if (rowUpdatedByListener) {
                                    calculateRow(i); anyRowRecalculated = true;
                                }
                            }
                        } // Koniec for cyklu

                        if (anyRowRecalculated) calculateTotal();
                        applyDarkMode(firebaseDarkMode); // Aplikuj dark mode z Firebase
                        updateWelcomeMessage();
                        updateDataSize();

                        // NotifikÃ¡cia len ak dÃ¡ta priÅ¡li zo servera (nie z cache poÄas offline)
                        if (!docSnap.metadata.fromCache) {
                            showSaveNotification("DÃ¡ta synchronizovanÃ©");
                        }

                    } catch (processError) {
                        console.error(`Listener: Chyba pri spracovanÃ­ dÃ¡t z Firestore pre ${currentYear}-${currentMonth}:`, processError);
                        showSaveNotification("Chyba: NesprÃ¡vny formÃ¡t dÃ¡t z Firebase", "error");
                    }
                } else {
                    // Dokument neexistuje vo Firestore
                    console.log(`Document ${docPath} does not exist in Firestore.`);
                    if (!monthData) monthData = {};
                    if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = []; // PrÃ¡zdne pole pre danÃ½ mesiac

                    // UloÅ¾ prÃ¡zdne dÃ¡ta do localStorage, aby sme neÅ¥ahali starÃ©
                    localStorage.setItem('workDaysData', JSON.stringify(monthData));

                    // NaÄÃ­taj nastavenia z localStorage (alebo default) a prekresli UI
                     loadFromLocalStorage(); // Toto zavolÃ¡ createTable a ÄalÅ¡ie funkcie
                    // showSaveNotification("Å½iadne dÃ¡ta v cloude pre tento mesiac.", "warning");
                }

            }, (error) => {
                console.error(`Firestore listener ERROR for ${docPath}:`, error);
                showSaveNotification("Chyba: Nepodarilo sa pripojiÅ¥ k Firebase", "error");
                // V prÃ­pade chyby listenera skÃºsime naÄÃ­taÅ¥ aspoÅˆ lokÃ¡lne dÃ¡ta
                loadFromLocalStorage();
            });
            console.log(`Firestore listener attached for path: ${docPath}`);
        }

        // --- Ukladanie do Firebase (prepÃ­sanÃ© na v9) ---
        async function saveToFirebase() {
            if (!currentUser) {
                console.log("Cannot save to Firebase, no user logged in.");
                return;
            }
            const uid = currentUser.uid;
            const yearMonthDoc = `${currentYear}-${currentMonth}`;
            const docRef = doc(db, "users", uid, "calculatorData", yearMonthDoc);

            try {
                // ZÃ­skanie aktuÃ¡lnych dÃ¡t vrÃ¡tane poznÃ¡mok (rovnakÃ¡ logika ako V1)
                 const currentMonthWorkData = ((monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []).map(day => ({
                    start: day.start || '',
                    end: day.end || '',
                    breakTime: day.breakTime || '',
                    note: day.note || '',
                    noteVisible: day.noteVisible === true // UloÅ¾Ã­ boolean
                }));

                 const dataToSave = {
                    days: currentMonthWorkData,
                    hourlyWage: hourlyWage || 10,
                    taxRate: (taxRate * 100) || 2, // UkladÃ¡me ako percento
                    decimalPlaces: decimalPlaces || 2,
                    employeeName: employeeName || '',
                    darkMode: document.body.classList.contains('dark-mode'),
                    timestamp: serverTimestamp() // PouÅ¾ijeme serverovÃ½ timestamp
                };

                console.log(`Saving data to Firebase for ${yearMonthDoc}...`);
                await setDoc(docRef, dataToSave); // setDoc prepÃ­Å¡e celÃ½ dokument
                console.log(`Data saved successfully to Firebase for ${yearMonthDoc}.`);
                // NotifikÃ¡cia sa zobrazÃ­ v listeneri, keÄ sa dÃ¡ta vrÃ¡tia zo servera

            } catch (error) {
                console.error(`Chyba pri poÅ¾iadavke na ukladanie do Firebase pre ${yearMonthDoc}:`, error);
                showSaveNotification("Chyba: Nepodarilo sa odoslaÅ¥ dÃ¡ta do Firebase", "error");
            }
        }

        // --- Ukladanie do Local Storage (logika z V1, volÃ¡ saveToFirebase) ---
        function saveToLocalStorage() {
            try {
                if (!monthData) monthData = {};
                if (!monthData[currentYear]) monthData[currentYear] = {};
                if (!monthData[currentYear][currentMonth]) { monthData[currentYear][currentMonth] = []; }

                // UloÅ¾ nastavenia
                localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); // UkladÃ¡me ako percento
                localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
                localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                localStorage.setItem('employeeName', JSON.stringify(employeeName));
                localStorage.setItem('currentMonth', currentMonth.toString());
                localStorage.setItem('currentYear', currentYear.toString());

                // UloÅ¾Ã­ celÃ© monthData, ktorÃ© obsahuje aj poznÃ¡mky a ich viditeÄ¾nosÅ¥
                const serializedMonthData = JSON.stringify(monthData);
                const bytes = new Blob([serializedMonthData]).size;

                // Kontrola veÄ¾kosti (rovnakÃ¡ ako V1)
                if (bytes > MAX_DATA_SIZE * 0.9) { console.warn(`VeÄ¾kosÅ¥ dÃ¡t ('workDaysData') v localStorage sa blÃ­Å¾i k limitu: ${bytes} bajtov`); }
                if (bytes > MAX_DATA_SIZE) {
                    alert(`PrekroÄili ste maximÃ¡lnu veÄ¾kosÅ¥ dÃ¡t (~${MAX_DATA_SIZE_KB} KB) pre dÃ¡ta mesiacov v localStorage. Ukladanie zlyhalo.`);
                    showSaveNotification("Chyba: LokÃ¡lne dÃ¡ta sÃº prÃ­liÅ¡ veÄ¾kÃ©!", "error");
                    return;
                }
                localStorage.setItem('workDaysData', serializedMonthData);
                updateDataSize();

                // --- VOLANIE ULOÅ½ENIA DO FIREBASE ---
                 saveToFirebase(); // Odoslanie aktuÃ¡lneho stavu do Firebase

                if (!navigator.onLine) {
                    showSaveNotification("Offline: Zmeny uloÅ¾enÃ© lokÃ¡lne", "warning");
                }
            } catch (error) {
                console.error('Chyba pri ukladanÃ­ (lokÃ¡lne/spustenÃ­ Firebase save):', error);
                showSaveNotification("KritickÃ¡ chyba pri ukladanÃ­!", "error");
            }
        }

        // Debounce verzia pre ÄastejÅ¡ie volania
        const debouncedSaveToLocalStorage = debounce(saveToLocalStorage, 1500); // UloÅ¾Ã­ 1.5s po poslednej zmene

        // --- NaÄÃ­tanie z Local Storage (logika z V1) ---
        function loadFromLocalStorage() {
            try {
                // Zistenie aktuÃ¡lneho mesiaca/roka, ak nie sÃº definovanÃ©
                if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                    const storedMonth = localStorage.getItem('currentMonth');
                    const storedYear = localStorage.getItem('currentYear');
                    const currentDate = new Date();
                    currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                    currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
                     console.log("Initializing month/year from localStorage or current date:", currentYear, currentMonth);
                }

                // NaÄÃ­tanie dÃ¡t mesiacov
                const storedMonthData = localStorage.getItem('workDaysData');
                monthData = storedMonthData ? JSON.parse(storedMonthData) : {};

                // ZabezpeÄenie, Å¾e starÃ© dÃ¡ta bez noteVisible dostanÃº predvolenÃº hodnotu
                 if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) {
                     monthData[currentYear][currentMonth] = monthData[currentYear][currentMonth].map(day => ({
                         ...day, // ZachovÃ¡ existujÃºce vlastnosti
                         noteVisible: day.noteVisible === true // PredvolenÃ¡ hodnota false ak chÃ½ba
                     }));
                 } else {
                     // Ak pre aktuÃ¡lny mesiac/rok dÃ¡ta neexistujÃº, inicializuj prÃ¡zdne pole
                     if (!monthData) monthData = {};
                     if (!monthData[currentYear]) monthData[currentYear] = {};
                     monthData[currentYear][currentMonth] = [];
                 }


                // NaÄÃ­tanie nastavenÃ­ (rovnakÃ© ako V1)
                hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02; // NaÄÃ­tame percento a predelÃ­me
                const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2; // Default 2
                employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

                updateUIFromLoadedData(darkMode); // AktualizÃ¡cia UI

            } catch (error) {
                console.error(`KritickÃ¡ chyba pri naÄÃ­tavanÃ­/spracovanÃ­ dÃ¡t z localStorage pre ${getMonthName(currentMonth)} ${currentYear}:`, error);
                showSaveNotification("Chyba pri naÄÃ­tanÃ­ lokÃ¡lnych dÃ¡t!", "error");
                monthData = {}; // Reset dÃ¡t v prÃ­pade chyby
                 if (currentMonth === undefined || currentMonth === null) currentMonth = new Date().getMonth();
                 if (currentYear === undefined || currentYear === null) currentYear = new Date().getFullYear();
                createTable(); calculateTotal(); // Zobraz prÃ¡zdnu tabuÄ¾ku
            }
        }

        // --- AktualizÃ¡cia UI (logika z V1, vrÃ¡tane poznÃ¡mok) ---
        function updateUIFromLoadedData(darkModeValue) {
            try {
                console.log("Updating UI from loaded data for:", currentYear, currentMonth);
                // Nastav hodnoty inputov pre nastavenia
                hourlyWageInput.value = hourlyWage;
                taxRateInput.value = (taxRate * 100).toFixed(1); // Zobrazujeme ako percento
                decimalPlacesSelect.value = decimalPlaces;
                employeeNameInput.value = employeeName;

                // Nastav selecty pre mesiac a rok
                if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
                     monthSelect.value = currentMonth;
                } else {
                     monthSelect.value = new Date().getMonth();
                     currentMonth = parseInt(monthSelect.value);
                }
                 if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                     yearSelect.value = currentYear;
                 } else {
                     yearSelect.value = new Date().getFullYear();
                     currentYear = parseInt(yearSelect.value);
                     populateYearSelect(); // Znovu naplnÃ­, ak rok chÃ½bal
                     yearSelect.value = currentYear;
                 }


                createTable(); // VytvorÃ­ Å¡truktÃºru tabuÄ¾ky

                const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
                console.log("Data found for current month:", dataForCurrentMonth.length, "entries");

                // Naplnenie tabuÄ¾ky dÃ¡tami
                dataForCurrentMonth.forEach((day, index) => {
                    const i = index + 1;
                    const baseId = `${currentYear}-${currentMonth}-${i}`;
                    const startElement = document.getElementById(`start-${baseId}`);
                    const endElement = document.getElementById(`end-${baseId}`);
                    const breakElement = document.getElementById(`break-${baseId}`);
                    const noteElement = document.getElementById(`note-${baseId}`);
                    const noteContainer = document.getElementById(`note-container-${baseId}`);
                    const noteButton = document.getElementById(`note-toggle-${baseId}`);
                    const noteIndicator = document.getElementById(`note-indicator-${baseId}`);

                    if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
                        startElement.value = day.start || '';
                        endElement.value = day.end || '';
                        breakElement.value = day.breakTime || '';
                        noteElement.value = day.note || '';

                        // VypoÄÃ­taj hodnoty pre riadok
                        calculateRow(i);

                        // Nastavenie viditeÄ¾nosti poznÃ¡mky
                        const isNoteVisible = day.noteVisible === true;
                        noteContainer.classList.toggle('visible', isNoteVisible);
                        noteButton.textContent = isNoteVisible ? 'SkryÅ¥' : 'PoznÃ¡mka';

                        // AktualizÃ¡cia indikÃ¡tora poznÃ¡mky
                        updateNoteIndicator(i);

                         // AplikÃ¡cia dark mode na dynamickÃ© prvky poznÃ¡mky
                        const isDarkModeActive = document.body.classList.contains('dark-mode');
                        if(noteElement) noteElement.classList.toggle('dark-mode', isDarkModeActive);
                        if(noteButton) noteButton.classList.toggle('dark-mode', isDarkModeActive);
                        if(noteIndicator) noteIndicator.classList.toggle('dark-mode', isDarkModeActive);

                    } else {
                        console.error(`KritickÃ¡ chyba: Elementy pre deÅˆ ${i} v updateUIFromLoadedData neboli nÃ¡jdenÃ© po createTable!`);
                    }
                });

                // Ak je menej dÃ¡t neÅ¾ dnÃ­ v mesiaci, resetuj zvyÅ¡nÃ© riadky
                const daysInMonth = getDaysInMonth(currentMonth);
                 for (let i = dataForCurrentMonth.length + 1; i <= daysInMonth; i++) {
                     if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        resetRow(i, false); // NerobÃ­me save pri tomto resete
                     }
                 }


                calculateTotal(); // PrepoÄÃ­taj celkovÃ© sÃºÄty
                updateDataSize(); // Aktualizuj ukazovateÄ¾ veÄ¾kosti dÃ¡t
                applyDarkMode(darkModeValue); // Aplikuj tmavÃ½ reÅ¾im
                updateWelcomeMessage(); // Aktualizuj uvÃ­tanie

            } catch (error) {
                console.error("Chyba poÄas aktualizÃ¡cie UI:", error);
                showSaveNotification("Chyba pri prekresÄ¾ovanÃ­ UI!", "error");
            }
        }

        // --- Aplikovanie Dark Mode (logika z V1) ---
        function applyDarkMode(isDark) {
            const elementsToToggle = [
                document.body, document.querySelector('.container'), totalSalaryDiv,
                document.querySelector('.collapsible-settings summary'),
                ...document.querySelectorAll('table, th, td'),
                ...document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"], select'),
                ...document.querySelectorAll('.btn'), // VrÃ¡tane .highlight, lebo mÃ¡ .btn
                ...document.querySelectorAll('.toggle-note-btn'),
                ...document.querySelectorAll('.note-textarea'),
                ...document.querySelectorAll('.time-icon'),
                ...document.querySelectorAll('.note-indicator-icon')
            ];
             elementsToToggle.forEach(el => {
                 if (el) { // Kontrola, Äi element existuje
                     // PouÅ¾ijeme force parameter toggle metÃ³dy
                     el.classList.toggle('dark-mode', isDark);
                 } else {
                    // console.warn("Dark mode toggle: Element not found for selector used.");
                 }
             });

            // Å peciÃ¡lne pre current-day
            const currentDayRows = document.querySelectorAll('.current-day'); // MÃ´Å¾e byÅ¥ viac? RadÅ¡ej querySelectorAll
             currentDayRows.forEach(currentDayRow => {
                currentDayRow.classList.toggle('dark-mode', isDark);
                 currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn, .time-icon, .note-indicator-icon').forEach(el => {
                     if(el) el.classList.toggle('dark-mode', isDark);
                 });
             });
        }

        window.toggleDarkMode = () => { // Priradenie k window pre onclick
            const isDarkMode = document.body.classList.toggle('dark-mode');
            applyDarkMode(isDarkMode);
            localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
            // UloÅ¾ zmenu dark mode aj do Firebase
             if (currentUser) {
                 saveToFirebase(); // UloÅ¾Ã­ celÃ½ aktuÃ¡lny stav vrÃ¡tane darkMode
             }
        }


        // --- VytvÃ¡ranie TabuÄ¾ky (logika z V1, vrÃ¡tane poznÃ¡mok a ikon) ---
        function getDayName(year, month, day) {
             try {
                // PridÃ¡me +1 k dÅˆu a potom nastavÃ­me na 0, aby sme zÃ­skali poslednÃ½ deÅˆ predoÅ¡lÃ©ho mesiaca
                 // To ale nepotrebujeme, staÄÃ­ vytvoriÅ¥ dÃ¡tum
                 const date = new Date(year, month, day);
                 // Skontrolujeme, Äi je dÃ¡tum platnÃ½ (napr. 31. FebruÃ¡r by nebol platnÃ½)
                 if (isNaN(date.getTime())) {
                     return "N/A"; // Alebo inÃ¡ indikÃ¡cia neplatnÃ©ho dÅˆa
                 }
                 const daysOfWeek = ["Ne", "Po", "Ut", "St", "Å t", "Pi", "So"]; // SkrÃ¡tenÃ© nÃ¡zvy
                 return daysOfWeek[date.getDay()];
             } catch (e) {
                 console.error("Error getting day name for", year, month, day, e);
                 return "Err";
             }
         }

        function createTable() {
             workDays.innerHTML = ''; // VyÄistÃ­ predchÃ¡dzajÃºci obsah
             const tableHead = document.querySelector('table thead tr');
             // UistÃ­me sa, Å¾e hlaviÄka pre poznÃ¡mku existuje (z V1)
             if (tableHead && !tableHead.querySelector('.th-note')) {
                 const noteTh = document.createElement('th');
                 noteTh.textContent = 'PoznÃ¡mka';
                 noteTh.classList.add('th-note');
                 const lastTh = tableHead.lastElementChild; // NÃ¡jdi poslednÃ½ stÄºpec (Akcia)
                 tableHead.insertBefore(noteTh, lastTh); // VloÅ¾ pred poslednÃ½
             }

             const daysInMonth = getDaysInMonth(currentMonth);
             if (isNaN(daysInMonth) || daysInMonth <= 0 || daysInMonth > 31) {
                 console.error("Invalid number of days in month:", daysInMonth, "for", currentYear, currentMonth);
                 workDays.innerHTML = `<tr><td colspan="9">Chyba: NeplatnÃ½ poÄet dnÃ­ pre ${getMonthName(currentMonth)} ${currentYear}.</td></tr>`;
                 return;
             }

             const today = new Date();
             const currentDayOfMonth = today.getDate();
             const currentMonthIndex = today.getMonth();
             const currentYearValue = today.getFullYear();

             for (let i = 1; i <= daysInMonth; i++) {
                 const row = document.createElement('tr');
                 if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
                     row.classList.add('current-day');
                 }

                 const dayName = getDayName(currentYear, currentMonth, i);
                 const baseId = `${currentYear}-${currentMonth}-${i}`;
                 const startId = `start-${baseId}`; const endId = `end-${baseId}`; const breakId = `break-${baseId}`;
                 const totalId = `total-${baseId}`; const grossId = `gross-${baseId}`; const netId = `net-${baseId}`;
                 const noteToggleId = `note-toggle-${baseId}`; const noteContainerId = `note-container-${baseId}`;
                 const noteTextareaId = `note-${baseId}`; const noteIndicatorId = `note-indicator-${baseId}`;

                 // HTML Å¡truktÃºra riadku z V1 kÃ³du (vrÃ¡tane poznÃ¡mok a ikon)
                 row.innerHTML = `
                     <td>${i}. (${dayName})</td>
                     <td>
                         <input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}', ${i})">
                         <span class="time-icon" title="VloÅ¾iÅ¥ aktuÃ¡lny Äas" onclick="insertCurrentTime('${startId}')">â°</span>
                     </td>
                     <td>
                         <input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}', ${i})">
                         <span class="time-icon" title="VloÅ¾iÅ¥ aktuÃ¡lny Äas" onclick="insertCurrentTime('${endId}')">â°</span>
                     </td>
                     <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td>
                     <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
                     <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="0.00" readonly></td>
                     <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="0.00" readonly></td>
                     <td>
                         <span class="note-indicator-icon" id="${noteIndicatorId}">ğŸ“</span>
                         <button id="${noteToggleId}" class="toggle-note-btn" onclick="toggleNote(${i})">PoznÃ¡mka</button>
                         <div id="${noteContainerId}" class="note-container">
                             <textarea id="${noteTextareaId}" class="note-textarea" placeholder="Zadajte poznÃ¡mku..." oninput="handleNoteInput(this, ${i})"></textarea>
                         </div>
                     </td>
                     <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
                 `;
                 workDays.appendChild(row);
             }
             // Aplikuje dark mode aj na novo vytvorenÃ© prvky
             applyDarkMode(document.body.classList.contains('dark-mode'));
         }


        // --- VloÅ¾enie AktuÃ¡lneho ÄŒasu (funkcia z V1) ---
         window.insertCurrentTime = function(targetInputId) { // Priradenie k window pre onclick
             const now = new Date();
             const hours = now.getHours().toString().padStart(2, '0');
             const minutes = now.getMinutes().toString().padStart(2, '0');
             const formattedTime = `${hours}:${minutes}`;

             const targetInput = document.getElementById(targetInputId);
             if (targetInput) {
                 targetInput.value = formattedTime;
                 // Simulujeme input event, aby sa spustil handleInput a prepoÄty/ukladanie
                 const event = new Event('input', { bubbles: true, cancelable: true });
                 targetInput.dispatchEvent(event);
                 // Focus na ÄalÅ¡ie pole, ak je to prÃ­chod
                 if (targetInputId.startsWith('start-')) {
                    const nextId = targetInputId.replace('start-', 'end-');
                    moveNext(targetInput, nextId);
                 }
             } else {
                 console.error('CieÄ¾ovÃ½ input pre vloÅ¾enie Äasu nebol nÃ¡jdenÃ½:', targetInputId);
                 showSaveNotification('Chyba: Nepodarilo sa nÃ¡jsÅ¥ pole pre vloÅ¾enie Äasu.', 'error');
             }
         }

        // --- Funkcie pre PoznÃ¡mky (z V1) ---
        window.toggleNote = (day) => { // Priradenie k window pre onclick
            const containerId = `note-container-${currentYear}-${currentMonth}-${day}`;
            const buttonId = `note-toggle-${currentYear}-${currentMonth}-${day}`;
            const noteContainer = document.getElementById(containerId);
            const toggleButton = document.getElementById(buttonId);

            if (noteContainer && toggleButton) {
                const isVisible = noteContainer.classList.toggle('visible');
                toggleButton.textContent = isVisible ? 'SkryÅ¥' : 'PoznÃ¡mka';

                const dayIndex = day - 1;
                 // ZabezpeÄÃ­me existenciu zÃ¡znamu pre deÅˆ
                 ensureDayDataExists(dayIndex);

                if (monthData[currentYear][currentMonth][dayIndex]) {
                     monthData[currentYear][currentMonth][dayIndex].noteVisible = isVisible;
                     debouncedSaveToLocalStorage(); // UloÅ¾Ã­me zmenu viditeÄ¾nosti (s debounce)
                } else {
                    console.warn(`toggleNote: ZÃ¡znam pre deÅˆ ${dayIndex} stÃ¡le neexistuje po ensureDayDataExists.`);
                }


                 // AplikÃ¡cia dark mode
                 if (document.body.classList.contains('dark-mode')) {
                     const textarea = noteContainer.querySelector('textarea');
                     if(textarea) textarea.classList.toggle('dark-mode', document.body.classList.contains('dark-mode'));
                     toggleButton.classList.toggle('dark-mode', document.body.classList.contains('dark-mode'));
                     // Note: IndikÃ¡tor sa prepÃ­na v updateNoteIndicator
                 }
            } else {
                 console.warn(`toggleNote: Elementy pre poznÃ¡mku dÅˆa ${day} neboli nÃ¡jdenÃ©.`);
            }
        }

        window.updateNoteIndicator = (day) => { // Priradenie k window (volÃ¡ sa interne)
             const noteTextarea = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`);
             const indicatorIcon = document.getElementById(`note-indicator-${currentYear}-${currentMonth}-${day}`);
             if (noteTextarea && indicatorIcon) {
                 const hasContent = noteTextarea.value.trim() !== '';
                 indicatorIcon.style.display = hasContent ? 'inline-block' : 'none';
                 // Aplikuj dark mode na indikÃ¡tor
                 indicatorIcon.classList.toggle('dark-mode', document.body.classList.contains('dark-mode'));
             }
         }
        // PomocnÃ¡ funkcia na zabezpeÄenie existencie dÃ¡tovÃ©ho zÃ¡znamu
         function ensureDayDataExists(dayIndex) {
             if (!monthData) monthData = {};
             if (!monthData[currentYear]) monthData[currentYear] = {};
             if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
             while (dayIndex >= monthData[currentYear][currentMonth].length) {
                 monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '', noteVisible: false });
             }
             // ZabezpeÄÃ­, Å¾e aj existujÃºci zÃ¡znam mÃ¡ noteVisible
             if (typeof monthData[currentYear][currentMonth][dayIndex]?.noteVisible === 'undefined') {
                 if (monthData[currentYear][currentMonth][dayIndex]) {
                     monthData[currentYear][currentMonth][dayIndex].noteVisible = false;
                 } else {
                     // Toto by sa nemalo staÅ¥ po cykle while vyÅ¡Å¡ie, ale pre istotu
                      monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '', noteVisible: false };
                 }
             }
         }


        // --- Input Handling (logika z V1, vrÃ¡tane poznÃ¡mok) ---
        function isTimeValid(timeStr) { const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeStr); }

        window.handleInput = (input, nextId, day) => { // Priradenie k window pre oninput
             formatInput(input); // FormÃ¡tovanie HH:MM
             updateMonthDataFromInput(input, day); // AktualizÃ¡cia monthData
             calculateRow(day); // PrepoÄet riadku
             calculateTotal(); // PrepoÄet sÃºÄtov
             debouncedSaveToLocalStorage(); // UloÅ¾enie s debounce
             // AutomatickÃ½ presun fokusu (rovnakÃ½ ako V1)
             if (input.type === 'tel' && input.value.length === 5 && isTimeValid(input.value)) {
                 moveNext(input, nextId);
             }
         }

        window.handleBreakInput = (day) => { // Priradenie k window pre oninput
             const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
             if (input && parseFloat(input.value) < 0) {
                 input.value = ''; // ZakÃ¡Å¾ zÃ¡pornÃ© hodnoty
             }
             updateMonthDataFromInput(input, day);
             calculateRow(day);
             calculateTotal();
             debouncedSaveToLocalStorage();
         }

        window.handleNoteInput = (textarea, day) => { // Priradenie k window pre oninput
             updateMonthDataFromInput(textarea, day);
             updateNoteIndicator(day); // Aktualizuj ikonu indikÃ¡tora
             debouncedSaveToLocalStorage(); // UloÅ¾Ã­ zmenu textu poznÃ¡mky (s debounce)
         }

        // AktualizÃ¡cia monthData z inputu (logika z V1)
        function updateMonthDataFromInput(input, day) {
             if (!input) return;
             const dayIndex = day - 1;
             const fieldId = input.id;
             let field = 'unknown';

             if (fieldId.startsWith('start-')) field = 'start';
             else if (fieldId.startsWith('end-')) field = 'end';
             else if (fieldId.startsWith('break-')) field = 'breakTime';
             else if (fieldId.startsWith('note-')) field = 'note';

             const value = (field === 'breakTime') ? (input.value || '') : input.value; // UloÅ¾Ã­me aj 0 pre prestÃ¡vku

             if (field !== 'unknown') {
                ensureDayDataExists(dayIndex); // ZabezpeÄÃ­me existenciu zÃ¡znamu

                const currentValue = monthData[currentYear]?.[currentMonth]?.[dayIndex]?.[field];
                if (currentValue !== value) {
                     monthData[currentYear][currentMonth][dayIndex][field] = value;
                 }
             } else {
                 console.warn("updateMonthDataFromInput: NerozpoznanÃ© pole pre input ID:", fieldId);
             }
         }

        // FormÃ¡tovanie HH:MM (logika z V1)
        function formatInput(input) {
            if (!input || input.type !== 'tel') return;
            let value = input.value.replace(/[^\d:]/g, ''); // PovolÃ­ len ÄÃ­sla a dvojbodku

            // AutomatickÃ© pridanie dvojbodky
             if (value.length === 3 && value.charAt(2) !== ':' && value.indexOf(':') === -1) {
                // Ak sÃº prvÃ© 2 ÄÃ­sla platnÃ¡ hodina a 3. znak nie je dvojbodka
                 if (parseInt(value.slice(0, 2)) <= 23) {
                     value = value.slice(0, 2) + ':' + value.slice(2);
                 }
            } else if (value.length === 4 && value.indexOf(':') === -1) {
                 // Ak sÃº 4 ÄÃ­sla a Å¾iadna dvojbodka -> HH:MM
                 value = value.slice(0, 2) + ':' + value.slice(2);
             } else if (value.length === 2 && input.value.length === 3 && input.value.endsWith(':')) {
                  // Ak pouÅ¾Ã­vateÄ¾ zadal HH:, nechÃ¡me tak
             } else if (value.length === 1 && parseInt(value) > 2) {
                 // Ak prvÃ© ÄÃ­slo je > 2, pridÃ¡me 0 na zaÄiatok a : (napr. 8 -> 08:)
                 value = '0' + value + ':';
             }


            // OdstrÃ¡nenie viacerÃ½ch dvojbodiek
             const parts = value.split(':');
             if (parts.length > 2) {
                 value = parts[0] + ':' + parts.slice(1).join('');
             }

            // Obmedzenie dÄºÅ¾ky
             if (value.length > 5) {
                 value = value.slice(0, 5);
             }

            // AktualizÃ¡cia hodnoty inputu, ak sa zmenila
             if (input.value !== value) {
                 input.value = value;
             }

            // ValidÃ¡cia border (rovnakÃ¡ ako V1)
             if (value.length > 0 && value.length < 5) {
                 if (input.style.border !== '') input.style.border = ''; // Reset border
             } else if (value.length === 5) {
                 if (isTimeValid(value)) {
                     if (input.style.border !== '') input.style.border = '';
                 } else {
                     input.style.border = '1px solid red';
                     // OdstrÃ¡nenie ÄervenÃ©ho okraja po chvÃ­li
                      setTimeout(() => {
                          if (input.style.borderColor === 'red') { // Kontrola pre prÃ­pad, Å¾e by sa medzitÃ½m opravilo
                              input.style.border = '';
                          }
                      }, 2000);
                 }
             } else { // PrÃ¡zdny alebo dÄºÅ¾ka 0
                 if (input.style.border !== '') input.style.border = '';
             }
        }

        // Presun fokusu (logika z V1)
         function moveNext(currentElement, nextId) {
            if (!nextId || !currentElement) return;
             // NÃ¡jdeme rodiÄovskÃ½ TR element
             const currentRow = currentElement.closest('tr');
             if (!currentRow) return;

             let nextElement = document.getElementById(nextId);

             // Ak ÄalÅ¡Ã­ element neexistuje (napr. sme na konci riadku a bol to break input),
             // skÃºsime nÃ¡jsÅ¥ prvÃ½ input (start) v ÄalÅ¡om riadku.
             if (!nextElement && nextId.startsWith('break-')) {
                 const nextRow = currentRow.nextElementSibling;
                 if (nextRow) {
                     const nextStartInput = nextRow.querySelector('input[id^="start-"]');
                     if (nextStartInput) {
                         nextElement = nextStartInput;
                     }
                 }
             }


             if (nextElement) {
                 // PresunÃºÅ¥ focus len ak aktuÃ¡lny element mÃ¡ focus
                 if (document.activeElement === currentElement) {
                    nextElement.focus();
                    // OznaÄenie textu pre Ä¾ahkÃ© prepÃ­sanie (okrem number inputov)
                     if (nextElement.select && nextElement.type !== 'number') {
                         nextElement.select();
                    }
                }
            } else {
                // console.warn(`moveNext: Element s ID ${nextId} nebol nÃ¡jdenÃ½.`);
            }
        }


        // --- VÃ½poÄty (logika z V1) ---
        function calculateRow(day) {
            const baseId = `${currentYear}-${currentMonth}-${day}`;
            const startTimeStr = document.getElementById(`start-${baseId}`)?.value;
            const endTimeStr = document.getElementById(`end-${baseId}`)?.value;
            const breakTimeInput = document.getElementById(`break-${baseId}`);
            const breakTime = parseFloat(breakTimeInput?.value) || 0;

            const totalCell = document.getElementById(`total-${baseId}`);
            const grossElement = document.getElementById(`gross-${baseId}`);
            const netElement = document.getElementById(`net-${baseId}`);

            if (!totalCell || !grossElement || !netElement) {
                 console.error(`Missing elements for row calculation, day ${day}`);
                 return; // NemÃ´Å¾eme poÄÃ­taÅ¥ bez elementov
            }

            // Reset, ak chÃ½bajÃº Äasy
            if (!startTimeStr && !endTimeStr) {
                 totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
                 grossElement.value = (0).toFixed(decimalPlaces);
                 netElement.value = (0).toFixed(decimalPlaces);
                 return;
             }

            // ValidÃ¡cia formÃ¡tu Äasu
             if ((startTimeStr && !isTimeValid(startTimeStr)) || (endTimeStr && !isTimeValid(endTimeStr))) {
                 totalCell.textContent = 'NeplatnÃ½ Äas';
                 grossElement.value = (0).toFixed(decimalPlaces);
                 netElement.value = (0).toFixed(decimalPlaces);
                 return;
             }
             // Ak je zadanÃ½ len jeden Äas, zobrazÃ­me 0
            if (!startTimeStr || !endTimeStr) {
                totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
                grossElement.value = (0).toFixed(decimalPlaces);
                netElement.value = (0).toFixed(decimalPlaces);
                return;
            }


            // VÃ½poÄet rozdielu Äasov
            const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
            const [endHours, endMinutes] = endTimeStr.split(':').map(Number);

            // PouÅ¾ijeme fiktÃ­vny dÃ¡tum pre jednoduchÃ½ vÃ½poÄet rozdielu
            const startDate = new Date(2000, 0, 1, startHours, startMinutes);
            let endDate = new Date(2000, 0, 1, endHours, endMinutes);

            // Ak je koncovÃ½ Äas menÅ¡Ã­ ako zaÄiatoÄnÃ½ (prÃ¡ca cez polnoc)
             if (endDate < startDate) {
                endDate.setDate(endDate.getDate() + 1); // PosuÅˆ o deÅˆ
            }

            const diffMilliseconds = endDate.getTime() - startDate.getTime();
            const diffMinutesTotal = diffMilliseconds / (1000 * 60); // CelkovÃ½ rozdiel v minÃºtach

             const breakMinutes = breakTime * 60; // PrestÃ¡vka v minÃºtach
             const workedMinutes = Math.max(0, diffMinutesTotal - breakMinutes); // OdpracovanÃ© minÃºty

             const hours = Math.floor(workedMinutes / 60);
             const minutes = Math.round(workedMinutes % 60); // ZaokrÃºhlenie minÃºt
             const decimalHours = workedMinutes / 60; // OdpracovanÃ© hodiny ako desatinnÃ© ÄÃ­slo

             totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;

            // VÃ½poÄet mzdy
            const currentHourlyWage = hourlyWage; // NaÄÃ­taj aktuÃ¡lnu sadzbu
            const currentTaxRate = taxRate; // NaÄÃ­taj aktuÃ¡lnu daÅˆ

            const grossSalary = decimalHours * currentHourlyWage;
            grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);

            const netSalary = grossSalary * (1 - currentTaxRate);
            netElement.value = isFinite(netSalary) ? netSalary.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);
        }


        // Reset Riadku (logika z V1, vrÃ¡tane poznÃ¡mok)
        window.resetRow = (day) => { // Priradenie k window pre onclick
             const dayIndex = day - 1;
             const baseId = `${currentYear}-${currentMonth}-${day}`;
             const start = document.getElementById(`start-${baseId}`);
             const end = document.getElementById(`end-${baseId}`);
             const breakTime = document.getElementById(`break-${baseId}`);
             const total = document.getElementById(`total-${baseId}`);
             const gross = document.getElementById(`gross-${baseId}`);
             const net = document.getElementById(`net-${baseId}`);
             const note = document.getElementById(`note-${baseId}`);
             const noteContainer = document.getElementById(`note-container-${baseId}`);
             const noteToggle = document.getElementById(`note-toggle-${baseId}`);
             const noteIndicator = document.getElementById(`note-indicator-${baseId}`);

             if (start && end && breakTime && total && gross && net && note && noteContainer && noteToggle && noteIndicator) {
                 start.value = ''; end.value = ''; breakTime.value = ''; note.value = '';
                 total.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
                 gross.value = (0).toFixed(decimalPlaces); net.value = (0).toFixed(decimalPlaces);
                 noteContainer.classList.remove('visible'); noteToggle.textContent = 'PoznÃ¡mka';
                 updateNoteIndicator(day); // Skryje indikÃ¡tor

                 // Vynulovanie dÃ¡t v monthData
                 ensureDayDataExists(dayIndex); // ZabezpeÄÃ­me, Å¾e zÃ¡znam existuje
                 if (monthData[currentYear][currentMonth][dayIndex]) {
                     monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '', noteVisible: false };
                 } else {
                     console.error(`resetRow: ChÃ½ba zÃ¡znam pre deÅˆ ${dayIndex} v monthData aj po ensureDayDataExists.`);
                 }

                 calculateTotal(); // PrepoÄÃ­taÅ¥ sÃºÄty
                 debouncedSaveToLocalStorage(); // UloÅ¾iÅ¥ zmeny (s debounce)

             } else {
                 console.warn(`resetRow: NiektorÃ© elementy pre deÅˆ ${day} neboli nÃ¡jdenÃ©.`);
             }
         }

        // Reset Mesiaca (logika z V1)
        window.resetAll = () => { // Priradenie k window pre onclick
             if (confirm('Naozaj chcete resetovaÅ¥ vÅ¡etky zÃ¡znamy pre tento mesiac?')) {
                 if (!monthData) monthData = {};
                 if (!monthData[currentYear]) monthData[currentYear] = {};

                 const days = getDaysInMonth(currentMonth);
                 // VytvorÃ­ pole s prÃ¡zdnymi objektmi pre kaÅ¾dÃ½ deÅˆ
                 monthData[currentYear][currentMonth] = Array.from({ length: days }, () => ({ start: '', end: '', breakTime: '', note: '', noteVisible: false }));

                 createTable(); // PrekreslÃ­ tabuÄ¾ku (uÅ¾ bude prÃ¡zdna)
                 calculateTotal(); // Vynuluje sÃºÄty
                 saveToLocalStorage(); // UloÅ¾Ã­ prÃ¡zdne dÃ¡ta (priamo, nie debounce)
                 showSaveNotification("DÃ¡ta pre aktuÃ¡lny mesiac boli resetovanÃ©.");
             }
         }

        // VÃ½poÄet CelkovÃ½ch SÃºÄtov (logika z V1)
        function calculateTotal() {
            let grandTotalWorkedMinutes = 0;
            let grandTotalGrossSalary = 0;
            let grandTotalNetSalary = 0;
            let daysWithEntries = 0;

            const rows = workDays.querySelectorAll('tr');
            const currentHourlyWage = hourlyWage;
            const currentTaxRate = taxRate;
            const currentDecimalPlaces = decimalPlaces;

            rows.forEach((row, index) => {
                const dayIndex = index + 1;
                const baseId = `${currentYear}-${currentMonth}-${dayIndex}`;
                 const startTimeStr = document.getElementById(`start-${baseId}`)?.value;
                 const endTimeStr = document.getElementById(`end-${baseId}`)?.value;
                 const breakTimeInput = document.getElementById(`break-${baseId}`);
                 const grossInput = document.getElementById(`gross-${baseId}`);
                 const netInput = document.getElementById(`net-${baseId}`);

                 let rowWorkedMinutes = 0;
                 let rowGross = 0;
                 let rowNet = 0;
                 let hasEntry = false; // IndikÃ¡tor, Äi sa mÃ¡ deÅˆ zapoÄÃ­taÅ¥

                 if (grossInput && netInput) {
                     rowGross = parseFloat(grossInput.value) || 0;
                     rowNet = parseFloat(netInput.value) || 0;
                 }

                 // PrepoÄet odpracovanÃ½ch minÃºt pre sÃºÄet (podobne ako v calculateRow)
                 if (startTimeStr && endTimeStr && isTimeValid(startTimeStr) && isTimeValid(endTimeStr)) {
                     const breakTime = parseFloat(breakTimeInput?.value) || 0;
                     const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
                     const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
                     const startDate = new Date(2000, 0, 1, startHours, startMinutes);
                     let endDate = new Date(2000, 0, 1, endHours, endMinutes);
                     if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); }
                     const diffMilliseconds = endDate.getTime() - startDate.getTime();
                     const diffMinutesTotal = diffMilliseconds / (1000 * 60);
                     const breakMinutes = breakTime * 60;
                     rowWorkedMinutes = Math.max(0, diffMinutesTotal - breakMinutes);
                     if (rowWorkedMinutes > 0) {
                         hasEntry = true; // ZapoÄÃ­taj deÅˆ, ak sa reÃ¡lne odpracovalo
                     }
                 }

                 // ZapoÄÃ­taj deÅˆ aj vtedy, ak nie je Äas, ale je zadanÃ¡ poznÃ¡mka alebo vynÃºtenÃ¡ prestÃ¡vka
                 const noteValue = document.getElementById(`note-${baseId}`)?.value;
                 const breakValue = breakTimeInput?.value;
                 if (!hasEntry && (noteValue || (breakValue && parseFloat(breakValue) > 0))) {
                     // Ak sme doteraz nezapoÄÃ­tali a je poznÃ¡mka/prestÃ¡vka, skontrolujme aspoÅˆ jeden Äas
                     if (startTimeStr || endTimeStr) {
                         hasEntry = true;
                     }
                 }


                 grandTotalWorkedMinutes += rowWorkedMinutes;
                 grandTotalGrossSalary += rowGross;
                 grandTotalNetSalary += rowNet;
                 if (hasEntry) {
                     daysWithEntries++;
                 }
            });

             const grandTotalDecimalHours = grandTotalWorkedMinutes / 60;
             // SÃºÄty sÃº uÅ¾ vypoÄÃ­tanÃ© priamo z inputov, aby sedeli so zaokrÃºhlenÃ­m

             const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0;
             const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
             const averageHours = Math.floor(averageWorkedMinutes / 60);
             const averageMinutes = Math.round(averageWorkedMinutes % 60);
             const averageDecimalHours = averageWorkedMinutes / 60;

             const totalHours = Math.floor(grandTotalWorkedMinutes / 60);
             const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60); // ZaokrÃºhlenÃ© minÃºty pre zobrazenie

             totalSalaryDiv.innerHTML =
                 `PoÄet zapoÄÃ­tanÃ½ch dnÃ­: ${daysWithEntries}<br>` +
                 `CelkovÃ½ odpracovanÃ½ Äas: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(currentDecimalPlaces)} h)<br>` +
                 `CelkovÃ¡ hrubÃ¡ mzda: ${grandTotalGrossSalary.toFixed(currentDecimalPlaces)} â‚¬<br>` +
                 `CelkovÃ¡ ÄistÃ¡ mzda: ${grandTotalNetSalary.toFixed(currentDecimalPlaces)} â‚¬<br>` +
                 `PriemernÃ¡ ÄistÃ¡ mzda na deÅˆ: ${averageNetSalary.toFixed(currentDecimalPlaces)} â‚¬<br>` +
                 `<strong>PriemernÃ½ odpracovanÃ½ Äas na deÅˆ: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(currentDecimalPlaces)} h)</strong>`;
         }

        // --- Export do PDF (logika z V1, vrÃ¡tane poznÃ¡mok) ---
        window.exportToPDF = () => { // Priradenie k window pre onclick
             if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API?.autoTable === 'undefined') {
                 alert("Chyba: KniÅ¾nica jsPDF alebo autoTable nie je sprÃ¡vne naÄÃ­tanÃ¡.");
                 console.error("jsPDF library or autoTable plugin is not loaded correctly.");
                 return;
             }
             const { jsPDF } = window.jspdf; // Destructuring pre jsPDF
             try {
                 const doc = new jsPDF();
                 // Pokus o pridanie fontu (ak zlyhÃ¡, pouÅ¾ije sa default)
                 try {
                     // Skontrolujte, Äi font uÅ¾ nie je pridanÃ½, aby ste prediÅ¡li varovaniam
                     if (!doc.getFontList()['Roboto']) {
                         // PouÅ¾ite sprÃ¡vnu cestu k fontu alebo CDN, ak je potrebnÃ©
                         // Tento prÃ­klad predpokladÃ¡, Å¾e font je dostupnÃ½; inak ho vynechajte alebo pouÅ¾ite base64
                          // doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); // MÃ´Å¾e byÅ¥ blokovanÃ© CORSom
                          console.warn("Roboto font not directly added, ensure it's available or use default fonts.");
                     }
                      doc.setFont('helvetica', 'normal'); // PouÅ¾ijeme Å¡tandardnÃ½ font pre istotu
                 } catch(e) {
                      console.warn("Could not load/set Roboto font for PDF, using default.", e);
                      doc.setFont('helvetica', 'normal'); // Fallback na Å¡tandardnÃ½ font
                 }

                 doc.setFontSize(18);
                 doc.text(`Bruno's Calculator - VÃ½kaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);

                 doc.setFontSize(12);
                 doc.text(`Meno pracovnÃ­ka: ${employeeName || 'NezadanÃ©'}`, 14, 28);
                 doc.text(`HodinovÃ¡ mzda: ${hourlyWage || 'N/A'} â‚¬`, 14, 34);
                 doc.text(`DaÅˆ (%): ${(taxRate * 100).toFixed(1) || 'N/A'}`, 100, 34); // ZobrazÃ­ 1 des. miesto

                 // HlaviÄka tabuÄ¾ky (vrÃ¡tane poznÃ¡mky)
                 const tableColumn = ["DeÅˆ", "PrÃ­chod", "Odchod", "PrestÃ¡vka (h)", "OdpracovanÃ©", "HrubÃ¡ (â‚¬)", "ÄŒistÃ¡ (â‚¬)", "PoznÃ¡mka"];
                 const tableRows = [];

                 const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];

                 dataForCurrentMonth.forEach((day, index) => {
                     // ZobrazÃ­ riadok len ak mÃ¡ nejakÃ½ vstup alebo poznÃ¡mku
                      if (day.start || day.end || (day.breakTime && parseFloat(day.breakTime) > 0) || day.note) {
                         const dayNum = index + 1;
                         const dayName = getDayName(currentYear, currentMonth, dayNum);
                         const baseId = `${currentYear}-${currentMonth}-${dayNum}`;

                         const totalCell = document.getElementById(`total-${baseId}`);
                         const grossInput = document.getElementById(`gross-${baseId}`);
                         const netInput = document.getElementById(`net-${baseId}`);

                         // ZÃ­skanie hodnÃ´t priamo z elementov pre presnosÅ¥ zobrazenia
                         const workedTimeText = totalCell ? totalCell.textContent.trim() : 'N/A';
                         // ZÃ­skavame hodnoty z monthData pre istotu, ak by UI nebolo aktuÃ¡lne
                         const grossValue = (day.start && day.end) ? (parseFloat(grossInput?.value || 0)).toFixed(decimalPlaces) : '0.00';
                         const netValue = (day.start && day.end) ? (parseFloat(netInput?.value || 0)).toFixed(decimalPlaces) : '0.00';
                         const noteText = day.note || ''; // PoznÃ¡mka z dÃ¡tovÃ©ho modelu

                         const rowData = [
                             `${dayNum}. (${dayName})`,
                             day.start || '-',
                             day.end || '-',
                             day.breakTime || '0',
                             workedTimeText,
                             grossValue,
                             netValue,
                             noteText // PridanÃ¡ poznÃ¡mka
                         ];
                         tableRows.push(rowData);
                     }
                 });

                 doc.autoTable({
                     head: [tableColumn],
                     body: tableRows,
                     startY: 40,
                     theme: 'grid', // Alebo 'striped', 'plain'
                     styles: {
                         font: 'helvetica', // PouÅ¾ijeme Å¡tandardnÃ½ font
                         fontSize: 8,
                         cellPadding: 2,
                         overflow: 'linebreak' // Zalomenie textu v bunkÃ¡ch
                     },
                     headStyles: {
                         fillColor: [41, 128, 185], // ModrÃ¡ farba hlaviÄky
                         textColor: 255,
                         fontStyle: 'bold',
                         halign: 'center'
                     },
                     alternateRowStyles: {
                         fillColor: [240, 240, 240] // SvetlosivÃ© striedanie riadkov
                     },
                     columnStyles: {
                         0: { cellWidth: 22, halign: 'left' }, // DeÅˆ
                         1: { cellWidth: 15, halign: 'center' }, // PrÃ­chod
                         2: { cellWidth: 15, halign: 'center' }, // Odchod
                         3: { cellWidth: 18, halign: 'center' }, // PrestÃ¡vka
                         4: { cellWidth: 30, halign: 'center' }, // OdpracovanÃ©
                         5: { cellWidth: 20, halign: 'right' }, // HrubÃ¡
                         6: { cellWidth: 20, halign: 'right' }, // ÄŒistÃ¡
                         7: { cellWidth: 'auto'} // PoznÃ¡mka - auto Å¡Ã­rka
                     }
                 });

                 const finalY = doc.lastAutoTable.finalY || 40; // ZÃ­skanie pozÃ­cie pod tabuÄ¾kou

                 doc.setFontSize(10);
                 // OdstrÃ¡nenie HTML tagov pre zobrazenie sÃºÄtov
                 const totalTextContent = totalSalaryDiv.innerHTML
                     .replace(/<br\s*\/?>/gi, '\n') // NahradÃ­ <br> za novÃ½ riadok
                     .replace(/<\/?strong>/g, '');   // OdstrÃ¡ni <strong> tagy
                 doc.text(totalTextContent, 14, finalY + 10); // ZobrazÃ­ sÃºÄty

                 // Generovanie nÃ¡zvu sÃºboru
                 const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-zA-Z0-9]/g, '_'); // OdstrÃ¡ni Å¡peciÃ¡lne znaky
                 const pdfFileName = `Vykaz-${safeEmployeeName}-${getMonthName(currentMonth)}-${currentYear}.pdf`;

                 doc.save(pdfFileName);
                 showSaveNotification("PDF exportovanÃ©.");

             } catch (error) {
                 console.error("Chyba pri generovanÃ­ PDF v exportToPDF:", error);
                 alert("Nastala chyba pri vytvÃ¡ranÃ­ PDF sÃºboru.");
                 showSaveNotification("Chyba pri exporte PDF.", "error");
             }
         }

        // Odoslanie PDF (logika z V1, vrÃ¡tane poznÃ¡mok)
        window.sendPDF = () => { // Priradenie k window pre onclick
             if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API?.autoTable === 'undefined') {
                  alert("Chyba: KniÅ¾nica jsPDF alebo autoTable nie je sprÃ¡vne naÄÃ­tanÃ¡.");
                  console.error("jsPDF library or autoTable plugin is not loaded correctly.");
                  return;
              }
              const { jsPDF } = window.jspdf;
             try {
                 const doc = new jsPDF();
                 try {
                    // Nastavenie fontu (podobne ako pri exporte)
                      if (!doc.getFontList()['Roboto']) {
                         console.warn("Roboto font not directly added for sendPDF.");
                     }
                      doc.setFont('helvetica', 'normal');
                 } catch(e) {
                      console.warn("Could not load/set font for sendPDF, using default.", e);
                      doc.setFont('helvetica', 'normal');
                 }

                 doc.setFontSize(16);
                 doc.text(`PracovnÃ½ vÃ½kaz - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
                 doc.setFontSize(12);
                 doc.text(`Meno pracovnÃ­ka: ${employeeName || 'NezadanÃ©'}`, 14, 28);

                 // ZjednoduÅ¡enÃ¡ hlaviÄka a dÃ¡ta pre odoslanie
                 const tableColumn = ["DeÅˆ", "PrÃ­chod", "Odchod", "PrestÃ¡vka (h)", "PoznÃ¡mka"];
                 const tableRows = [];
                 const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];

                 dataForCurrentMonth.forEach((day, index) => {
                      if (day.start || day.end || (day.breakTime && parseFloat(day.breakTime) > 0) || day.note) {
                         const dayNum = index + 1;
                         const dayName = getDayName(currentYear, currentMonth, dayNum);
                         const noteText = day.note || '';
                         const rowData = [
                             `${dayNum}. (${dayName})`,
                             day.start || '-',
                             day.end || '-',
                             day.breakTime || '0',
                             noteText // PridanÃ¡ poznÃ¡mka
                         ];
                         tableRows.push(rowData);
                     }
                 });

                 doc.autoTable({
                     head: [tableColumn],
                     body: tableRows,
                     startY: 35,
                     theme: 'grid',
                     styles: { font: 'helvetica', fontSize: 9, cellPadding: 2, overflow: 'linebreak' },
                     headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold', halign: 'center' },
                     alternateRowStyles: { fillColor: [240, 240, 240] },
                     columnStyles: {
                         0: { cellWidth: 30, halign: 'left' }, // DeÅˆ
                         1: { cellWidth: 25, halign: 'center' }, // PrÃ­chod
                         2: { cellWidth: 25, halign: 'center' }, // Odchod
                         3: { cellWidth: 25, halign: 'center' }, // PrestÃ¡vka
                         4: { cellWidth: 'auto'} // PoznÃ¡mka
                     }
                 });

                 const finalY = doc.lastAutoTable.finalY || 35;
                 doc.setFontSize(10);

                 // Pridanie poÄtu dnÃ­ zo sÃºÄtov
                 const totalSalaryHTML = totalSalaryDiv.innerHTML;
                 let daysWithEntriesText = 'N/A';
                  const match = totalSalaryHTML.match(/PoÄet zapoÄÃ­tanÃ½ch dnÃ­: (\d+)/); // HÄ¾adÃ¡me novÃ½ text
                  if (match && match[1]) {
                      daysWithEntriesText = match[1];
                  }
                 const summaryText = `PoÄet zapoÄÃ­tanÃ½ch dnÃ­: ${daysWithEntriesText}`;
                 doc.text(summaryText, 14, finalY + 10);


                 const pdfBlob = doc.output('blob'); // ZÃ­skanie PDF ako Blob
                 const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
                 const pdfFileName = `Vykaz_odoslanie-${safeEmployeeName}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
                 const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

                 // Pokus o zdieÄ¾anie cez Web Share API
                 if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                     navigator.share({
                         files: [pdfFile],
                         title: `PracovnÃ½ vÃ½kaz ${getMonthName(currentMonth)} ${currentYear}`,
                         text: `VÃ½kaz pre ${employeeName || 'pracovnÃ­ka'} za ${getMonthName(currentMonth)} ${currentYear}.`
                     }).then(() => {
                         showSaveNotification("PDF pripravenÃ© na zdieÄ¾anie.");
                     }).catch((error) => {
                         // Ignorujeme AbortError, ktorÃ½ nastane, ak pouÅ¾Ã­vateÄ¾ zruÅ¡Ã­ zdieÄ¾anie
                         if (error.name !== 'AbortError') {
                             console.error('sendPDF: Chyba pri zdieÄ¾anÃ­ cez Web Share API:', error);
                             showSaveNotification('Chyba pri zdieÄ¾anÃ­ sÃºboru.', "error");
                              // Fallback na stiahnutie, ak zdieÄ¾anie zlyhÃ¡ z inÃ©ho dÃ´vodu
                              doc.save(pdfFileName);
                         } else {
                            console.log("Sharing aborted by user.");
                         }
                     });
                 } else {
                     // Fallback na stiahnutie, ak Web Share API nie je podporovanÃ©
                     alert("ZdieÄ¾anie sÃºborov nie je podporovanÃ© vaÅ¡Ã­m prehliadaÄom alebo systÃ©mom. SÃºbor bude stiahnutÃ½.");
                     doc.save(pdfFileName);
                 }
             } catch (error) {
                 console.error("Chyba pri generovanÃ­ alebo zdieÄ¾anÃ­ PDF v sendPDF:", error);
                 alert("Nastala chyba pri vytvÃ¡ranÃ­ alebo zdieÄ¾anÃ­ PDF sÃºboru.");
                 showSaveNotification("Chyba pri odosielanÃ­ PDF.", "error");
             }
         }

        // --- OstatnÃ© Nastavenia (logika z V1) ---
         window.changeDecimalPlaces = () => { // Priradenie k window pre onchange
             const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
             if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) {
                 decimalPlaces = newDecimalPlaces;
                 // PrepoÄÃ­taÅ¥ vÅ¡etky riadky a sÃºÄty
                 const daysInMonth = getDaysInMonth(currentMonth);
                 for(let i = 1; i <= daysInMonth; i++) {
                    if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        calculateRow(i);
                    }
                 }
                 calculateTotal();
                 saveToLocalStorage(); // UloÅ¾Ã­ zmenu nastavenia a aktuÃ¡lne dÃ¡ta
             }
         }

        window.updateEmployeeName = () => { // Priradenie k window pre oninput
             employeeName = employeeNameInput.value;
             updateWelcomeMessage();
             saveToLocalStorage(); // UloÅ¾Ã­ zmenu mena a aktuÃ¡lne dÃ¡ta
         }

        window.updateSettings = () => { // Priradenie k window pre oninput
             const newHourlyWageStr = hourlyWageInput.value;
             const newTaxRateStr = taxRateInput.value;
             const newHourlyWage = parseFloat(newHourlyWageStr);
             const newTaxRatePercent = parseFloat(newTaxRateStr);
             let settingsChanged = false;

             // Update hourly wage
             if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
                 if (hourlyWage !== newHourlyWage) {
                     hourlyWage = newHourlyWage;
                     settingsChanged = true;
                 }
             } else if (newHourlyWageStr !== '') { // Ak je neplatnÃ©, ale nie prÃ¡zdne, vrÃ¡Å¥ starÃº hodnotu
                  hourlyWageInput.value = hourlyWage;
             }


             // Update tax rate
              if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) {
                  const newTaxRateDecimal = newTaxRatePercent / 100;
                  if (taxRate !== newTaxRateDecimal) {
                      taxRate = newTaxRateDecimal;
                      settingsChanged = true;
                  }
              } else if (newTaxRateStr !== '') { // Ak je neplatnÃ©, ale nie prÃ¡zdne, vrÃ¡Å¥ starÃº hodnotu
                   taxRateInput.value = (taxRate * 100).toFixed(1);
              }


             // Ak sa zmenila mzda alebo daÅˆ, prepoÄÃ­taj vÅ¡etko a uloÅ¾
             if (settingsChanged) {
                 const rows = workDays.querySelectorAll('tr');
                 rows.forEach((row, index) => calculateRow(index + 1));
                 calculateTotal();
                 saveToLocalStorage(); // UloÅ¾Ã­ novÃ© nastavenia a prepoÄÃ­tanÃ© dÃ¡ta
             }
         }

        window.changeMonth = () => { // Priradenie k window pre onchange
             const selectedMonth = parseInt(monthSelect.value);
             if (currentMonth !== selectedMonth) {
                 currentMonth = selectedMonth;
                 handleMonthYearChange();
             }
         }

        window.changeYear = () => { // Priradenie k window pre onchange
             const selectedYear = parseInt(yearSelect.value);
             if (currentYear !== selectedYear) {
                 currentYear = selectedYear;
                 handleMonthYearChange();
             }
         }

        function handleMonthYearChange() {
            console.log("Changing month/year to:", currentYear, currentMonth);
             localStorage.setItem('currentMonth', currentMonth.toString());
             localStorage.setItem('currentYear', currentYear.toString());
             // Pri zmene mesiaca/roka naÄÃ­tame dÃ¡ta z localStorage (tie sa mohli naÄÃ­taÅ¥ z Firebase predtÃ½m)
             loadFromLocalStorage();
             // A nastavÃ­me novÃ½ listener pre Firebase
             if (currentUser) {
                 setupFirestoreListener();
             }
         }

        function getDaysInMonth(month) {
             if (month === undefined || month === null || currentYear === undefined || currentYear === null) {
                 console.warn("getDaysInMonth: Missing month or year, returning 31.");
                 return 31; // Fallback
             }
             // VytvorÃ­ dÃ¡tum pre nultÃ½ deÅˆ nasledujÃºceho mesiaca, Äo je poslednÃ½ deÅˆ aktuÃ¡lneho mesiaca
             return new Date(currentYear, month + 1, 0).getDate();
         }

        function getMonthName(month) {
             const monthNames = ["JanuÃ¡r", "FebruÃ¡r", "Marec", "AprÃ­l", "MÃ¡j", "JÃºn", "JÃºl", "August", "September", "OktÃ³ber", "November", "December"];
             return monthNames[month] || 'NeznÃ¡my';
         }

        function updateDataSize() {
             try {
                 const totalData = Object.entries(localStorage).reduce((acc, [key, value]) => {
                      // PoÄÃ­tajme len relevantnÃ© dÃ¡ta (workDaysData a nastavenia)
                      if (key === 'workDaysData' || ['hourlyWage', 'taxRate', 'darkMode', 'decimalPlaces', 'employeeName', 'currentMonth', 'currentYear'].includes(key)) {
                          return acc + (value ? value.length * 2 : 0); // PribliÅ¾ne 2 bajty na znak v UTF-16
                      }
                      return acc;
                  }, 0);

                 const kilobytes = (totalData / 1024).toFixed(2);
                 const percentageUsed = Math.min(((totalData / MAX_DATA_SIZE) * 100), 100);

                 dataSizeText.textContent = `LokÃ¡lne ÃºloÅ¾isko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
                 dataSizeFill.style.width = `${percentageUsed}%`;

                 // Zmena farby podÄ¾a zaplnenia
                 if (percentageUsed > 90) {
                     dataSizeFill.style.backgroundColor = '#f44336'; // ÄŒervenÃ¡
                 } else if (percentageUsed > 70) {
                     dataSizeFill.style.backgroundColor = '#ff9800'; // OranÅ¾ovÃ¡
                 } else {
                     dataSizeFill.style.backgroundColor = '#4CAF50'; // ZelenÃ¡
                 }
             } catch (error) {
                 console.error("Chyba pri vÃ½poÄte veÄ¾kosti localStorage:", error);
                 dataSizeText.textContent = "Chyba pri vÃ½poÄte veÄ¾kosti dÃ¡t.";
             }
         }


        // --- ZÃ¡lohovanie a Obnova (JSON formÃ¡t - logika z V1) ---
        window.createBackup = () => { // Priradenie k window pre onclick
            try {
                 // ZhromaÅ¾dÃ­me vÅ¡etky relevantnÃ© dÃ¡ta z localStorage
                 const backupData = {
                     workDaysData: localStorage.getItem('workDaysData') || '{}', // CelÃ© monthData
                     hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(10),
                     taxRate: localStorage.getItem('taxRate') || JSON.stringify(2), // UloÅ¾enÃ© ako percento
                     darkMode: localStorage.getItem('darkMode') || JSON.stringify(false),
                     decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(2),
                     employeeName: localStorage.getItem('employeeName') || JSON.stringify(''),
                     // PridÃ¡me informÃ¡cie o zÃ¡lohe
                     backupVersion: 2, // Verzia Å¡truktÃºry zÃ¡lohy
                     backupTimestamp: new Date().toISOString()
                 };

                 // VytvorÃ­me Blob a URL pre stiahnutie
                 const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
                 const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                 a.download = `bruno-calculator-backup-${safeEmployeeName}-${timestamp}.json`; // ZmysluplnÃ½ nÃ¡zov sÃºboru
                 document.body.appendChild(a);
                 a.click(); // SpustÃ­ stiahnutie
                 document.body.removeChild(a); // Upratanie
                 URL.revokeObjectURL(url); // UvoÄ¾nenie pamÃ¤te
                 showSaveNotification("ZÃ¡loha ÃºspeÅ¡ne vytvorenÃ¡.");

             } catch (error) {
                 console.error("Chyba pri vytvÃ¡ranÃ­ zÃ¡lohy:", error);
                 alert("Nastala chyba pri vytvÃ¡ranÃ­ zÃ¡loÅ¾nÃ©ho sÃºboru.");
                 showSaveNotification("Chyba pri vytvÃ¡ranÃ­ zÃ¡lohy.", "error");
             }
         }

        window.restoreBackup = () => { // Priradenie k window pre onclick
             const fileInput = document.createElement('input');
             fileInput.type = 'file';
             fileInput.accept = '.json,application/json'; // PrijÃ­mame len JSON

             fileInput.onchange = (event) => {
                 const file = event.target.files[0];
                 if (!file) return;

                 const reader = new FileReader();
                 reader.onload = (e) => {
                     try {
                         const backup = JSON.parse(e.target.result);

                         // ValidÃ¡cia zÃ¡kladnej Å¡truktÃºry zÃ¡lohy
                          if (backup && typeof backup.workDaysData === 'string' &&
                              typeof backup.hourlyWage === 'string' && typeof backup.taxRate === 'string' &&
                              typeof backup.darkMode === 'string' && typeof backup.decimalPlaces === 'string' &&
                              typeof backup.employeeName === 'string')
                          {
                             // Overenie JSONu pre workDaysData
                             try {
                                 JSON.parse(backup.workDaysData); // SkÃºs parsovaÅ¥, Äi je to platnÃ½ JSON
                             } catch (jsonError) {
                                 throw new Error("NesprÃ¡vny formÃ¡t dÃ¡t mesiacov (workDaysData) v zÃ¡lohe.");
                             }


                             if (confirm("Naozaj chcete obnoviÅ¥ dÃ¡ta z tejto zÃ¡lohy? AktuÃ¡lne neuloÅ¾enÃ© zmeny v aplikÃ¡cii budÃº stratenÃ©.")) {
                                 // PrepÃ­sanie localStorage dÃ¡tami zo zÃ¡lohy
                                 localStorage.setItem('workDaysData', backup.workDaysData);
                                 localStorage.setItem('hourlyWage', backup.hourlyWage);
                                 localStorage.setItem('taxRate', backup.taxRate); // UloÅ¾Ã­me ako string percenta
                                 localStorage.setItem('darkMode', backup.darkMode);
                                 localStorage.setItem('decimalPlaces', backup.decimalPlaces);
                                 localStorage.setItem('employeeName', backup.employeeName);

                                 // Po obnovenÃ­ musÃ­me znovu naÄÃ­taÅ¥ dÃ¡ta do aplikÃ¡cie
                                 loadFromLocalStorage();

                                 showSaveNotification("ZÃ¡loha ÃºspeÅ¡ne obnovenÃ¡.");
                                 alert("ZÃ¡loha bola ÃºspeÅ¡ne obnovenÃ¡. DÃ¡ta boli naÄÃ­tanÃ©.");

                                 // Ak je pouÅ¾Ã­vateÄ¾ prihlÃ¡senÃ½, pokÃºsime sa uloÅ¾iÅ¥ obnovenÃ© dÃ¡ta aj do Firebase
                                 if (currentUser) {
                                     saveToLocalStorage(); // Toto zavolÃ¡ aj saveToFirebase
                                      showSaveNotification("ObnovenÃ© dÃ¡ta sa ukladajÃº do cloudu...", "warning");
                                 }
                             }
                         } else {
                              throw new Error("SÃºbor zÃ¡lohy mÃ¡ nesprÃ¡vny formÃ¡t alebo chÃ½bajÃº kÄ¾ÃºÄovÃ© dÃ¡ta.");
                         }
                     } catch (error) {
                         console.error("Chyba pri spracovanÃ­ alebo obnove zÃ¡lohy:", error);
                         alert(`Chyba pri ÄÃ­tanÃ­ alebo obnove zÃ¡lohy: ${error.message}`);
                         showSaveNotification("Chyba pri obnove zÃ¡lohy.", "error");
                     }
                 };
                 reader.onerror = (e) => {
                     console.error("Chyba pri ÄÃ­tanÃ­ sÃºboru zÃ¡lohy:", e);
                     alert("Nastala chyba pri ÄÃ­tanÃ­ sÃºboru zÃ¡lohy.");
                     showSaveNotification("Chyba pri ÄÃ­tanÃ­ sÃºboru zÃ¡lohy.", "error");
                 };
                 reader.readAsText(file); // ÄŒÃ­tame ako text (JSON)
             };
             fileInput.click(); // OtvorÃ­ dialÃ³g na vÃ½ber sÃºboru
         }


        // --- InicializÃ¡cia AplikÃ¡cie ---
        function populateYearSelect() {
            const startYear = 2020;
            const endYear = new Date().getFullYear() + 5; // Do +5 rokov do budÃºcna
            const currentSelectedYear = yearSelect.value ? parseInt(yearSelect.value) : currentYear; // UchovÃ¡me vybranÃ½ rok
            yearSelect.innerHTML = '';
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
             // SkÃºsime nastaviÅ¥ predtÃ½m vybranÃ½ rok, alebo aktuÃ¡lny, ak nebol vybranÃ½
             yearSelect.value = currentSelectedYear;
             if (yearSelect.value !== currentSelectedYear.toString()) { // Ak nastavenie zlyhalo (rok nebol v rozsahu)
                 yearSelect.value = new Date().getFullYear(); // Nastav aktuÃ¡lny
                 currentYear = parseInt(yearSelect.value); // Aktualizuj globÃ¡lnu premennÃº
             }
        }

        // SpustÃ­ sa po naÄÃ­tanÃ­ DOM
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed.");
            populateYearSelect();

            // NaÄÃ­tanie stavu z localStorage pri Å¡tarte (eÅ¡te pred overenÃ­m auth stavu)
            // aby UI nevyzeralo "rozbitÃ©" kÃ½m sa neskonÄÃ­ onAuthStateChanged
            const initialDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
            applyDarkMode(initialDarkMode);
            const initialEmployeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
             employeeNameInput.value = initialEmployeeName; // Nastav meno hneÄ
             employeeName = initialEmployeeName; // Aktualizuj globÃ¡lnu premennÃº
             updateWelcomeMessage(); // Zobraz uvÃ­tanie hneÄ

            // OstatnÃ© nastavenia sa naÄÃ­tajÃº a aplikujÃº v onAuthStateChanged alebo loadFromLocalStorage

            // Service Worker registrÃ¡cia zostÃ¡va v samostatnom skripte niÅ¾Å¡ie
        });

         // PomocnÃ¡ funkcia pre debounce (prevzatÃ¡)
         function debounce(func, wait) {
             let timeout;
             return function executedFunction(...args) {
                 const later = () => {
                     clearTimeout(timeout);
                     func(...args);
                 };
                 clearTimeout(timeout);
                 timeout = setTimeout(later, wait);
             };
         }

    </script>

     <script>
         if ('serviceWorker' in navigator) {
             window.addEventListener('load', () => {
                 navigator.serviceWorker.register('./service-worker.js') // Uistite sa, Å¾e cesta je sprÃ¡vna
                     .then(registration => {
                         console.log('ServiceWorker registration successful with scope: ', registration.scope);
                     })
                     .catch(error => {
                         console.error('ServiceWorker registration failed: ', error);
                     });
             });
         } else {
              console.warn("Service Worker is not supported in this browser.");
          }
     </script>

</body>
</html>
