<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator v2.0 s Firebase</title> <!-- Zmenený titulok -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <!-- Načítanie písma Roboto z Google Fonts (externá knižnica) -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">
  <!-- Ikony pre prepínač hesla -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Firebase knižnice -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF a autoTable - NEDOTKNUTÉ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- CSS Štýly --- */
    /* Základné štýly */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; transition: background-color 0.3s ease, color 0.3s ease; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); position: relative; transition: background-color 0.3s ease, color 0.3s ease; }
    .autor-info { position: absolute; top: 10px; left: 15px; font-size: 0.85em; font-style: italic; color: #777; }

    /* Nadpisy */
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 5px; }
    h2 { text-align: center; color: #555; margin-top: 0; margin-bottom: 20px; font-size: 1.2em; }
    #welcomeMessage { font-weight: bold; color: #4CAF50; min-height: 1.2em; /* Aby neskákal layout */}

    /* Nastavenia */
    .settings { margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; border-bottom: 1px solid #eee; padding-bottom: 20px; }
    .settings > div { flex: 1 1 200px; min-width: 180px; }
    .settings label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 0.9em; }
    .settings input[type="text"], .settings input[type="number"], .settings select { width: 100%; padding: 8px; box-sizing: border-box; background-color: #ffffdd; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; transition: border-color 0.2s ease, background-color 0.2s ease; }
    .settings input:focus, .settings select:focus { border-color: #4CAF50; outline: none; background-color: #fff; }
    .settings button { padding: 9px 15px; height: 35px; /* Zarovnanie s inputmi */ }

    /* Tabuľka */
    .table-container { overflow-x: auto; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th, td { padding: 10px 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: middle; }
    th { background-color: #e9e9e9; font-weight: bold; }
    tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    tbody tr:hover { background-color: #f1f1f1; }
    td input[type="tel"], td input[type="number"] { width: 100%; padding: 6px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; }
    td input[readonly] { background-color: #eee; cursor: not-allowed; }

    /* Tlačidlá */
    .btn-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 25px; }
    .btn { padding: 12px 18px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 15px; transition: background-color 0.3s ease, transform 0.1s ease; text-align: center; box-sizing: border-box; }
    .btn:hover { opacity: 0.9; }
    .btn:active { transform: scale(0.98); }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .toggle-dark-btn { background-color: #607D8B; } .toggle-dark-btn:hover { background-color: #455A64; }
    td .btn.reset-btn { padding: 5px 10px; font-size: 13px; width: auto; min-width: 80px; } /* Menšie tlačidlo v riadku */

    /* Zvýraznenie */
    .highlight { background-color: #ffeb3b; color: #333; font-weight: bold; border: 1px solid #fbc02d; }

    /* Celková mzda a Veľkosť dát */
    #totalSalary { font-size: 1.1em; font-weight: bold; text-align: center; margin-top: 20px; padding: 15px; background-color: #e6f3ff; border-radius: 5px; border: 1px solid #b3d9ff; line-height: 1.8; }
    #dataSizeContainer { margin-top: 15px; text-align: center; font-size: 0.9em; color: #555; }
    #dataSizeText { margin-bottom: 5px; }
    #dataSizeBar { width: 90%; max-width: 400px; height: 10px; background-color: #e0e0e0; border-radius: 5px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.5s ease, background-color 0.5s ease; border-radius: 5px; }

    /* Aktuálny deň */
    .current-day { background-color: #e8dff5 !important; /* Zvýraznenie */ }
    .current-day td:first-child { font-weight: bold; }
    .current-day input { background-color: #f0e6ff; } /* Svetlejší vstup */

    /* Animácie */
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 8px rgba(255, 255, 255, 0.4), 0 0 15px rgba(255, 255, 255, 0.2), 0 0 25px rgba(255, 255, 255, 0.1); } 50% { text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 0 25px rgba(255, 255, 255, 0.7), 0 0 35px rgba(255, 255, 255, 0.5); } }

    /* Tmavý režim */
    body.dark-mode { background-color: #212121; color: #e0e0e0; }
    .container.dark-mode { background-color: #333; color: #e0e0e0; box-shadow: 0 2px 15px rgba(0,0,0,0.5); }
    .dark-mode .autor-info { color: #aaa; }
    .dark-mode h2 { color: #bbb; }
    .dark-mode #welcomeMessage { color: #81C784; }
    .dark-mode .settings { border-bottom-color: #444; }
    .dark-mode .settings label { color: #ccc; }
    .dark-mode .settings input[type="text"], .dark-mode .settings input[type="number"], .dark-mode .settings select { background-color: #555; color: #e0e0e0; border-color: #666; }
    .dark-mode .settings input:focus, .dark-mode .settings select:focus { border-color: #81C784; background-color: #666; }
    .dark-mode table { background-color: #424242; color: #e0e0e0; }
    .dark-mode th, .dark-mode td { border-color: #555; }
    .dark-mode th { background-color: #555; }
    .dark-mode tbody tr:nth-child(odd) { background-color: #474747; }
    .dark-mode tbody tr:hover { background-color: #505050; }
    .dark-mode td input[type="tel"], .dark-mode td input[type="number"] { background-color: #666; color: #e0e0e0; border-color: #777; }
    .dark-mode td input[readonly] { background-color: #555; }
    .dark-mode .btn { color: #fff; } /* Všetky tlačidlá majú biely text v tmavom režime */
    .dark-mode .reset-btn { background-color: #e53935; } .dark-mode .reset-btn:hover { background-color: #c62828; }
    .dark-mode .export-btn { background-color: #43A047; } .dark-mode .export-btn:hover { background-color: #2E7D32; }
    .dark-mode .restore-btn { background-color: #8E24AA; } .dark-mode .restore-btn:hover { background-color: #6A1B9A; }
    .dark-mode .backup-btn { background-color: #FB8C00; } .dark-mode .backup-btn:hover { background-color: #EF6C00; }
    .dark-mode .toggle-dark-btn { background-color: #78909C; } .dark-mode .toggle-dark-btn:hover { background-color: #546E7A; }
    .dark-mode #totalSalary { background-color: #2c3e50; border-color: #34495e; }
    .dark-mode .current-day { background-color: #4a0e8f !important; }
    .dark-mode .current-day td { color: #fff; }
    .dark-mode .current-day input { background-color: #5c1db3; color: #fff; border-color: #7e4cc4; }
    .dark-mode #dataSizeContainer { color: #bbb; }
    .dark-mode #dataSizeBar { background-color: #555; }
    .dark-mode #auth-container { background-color: #444; }
    .dark-mode #auth-container h1, .dark-mode #auth-container h2 { color: #eee; }
    .dark-mode #auth-container input { background-color: #555; color: #eee; border-color: #666; }
    .dark-mode #auth-container button { background-color: #4CAF50; } .dark-mode #auth-container button:hover { background-color: #388e3c; }
    .dark-mode #forgot-password-link { color: #64b5f6; }

    /* Autentifikácia */
    #auth-container { max-width: 400px; margin: 30px auto; background: #fff; padding: 25px 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: center; transition: background-color 0.3s ease; }
    #auth-container h1 { font-size: 1.8em; margin-bottom: 15px; }
    #auth-container h2 { font-size: 1.3em; margin-top: 20px; margin-bottom: 10px; color: #666; }
    #auth-message { margin-bottom: 20px; font-weight: bold; }
    #auth-forms form { margin-bottom: 20px; }
    #auth-forms .input-group { position: relative; margin-bottom: 15px; } /* Pre ikonu hesla */
    #auth-forms input[type="email"], #auth-forms input[type="password"] { width: 100%; padding: 12px; box-sizing: border-box; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
    #auth-forms .password-toggle-icon { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer; color: #888; font-size: 1.1em; }
    #auth-forms button { width: 100%; padding: 12px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 1.1em; font-weight: bold; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; }
    #auth-forms button:hover { background-color: #45a049; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 0.9em; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }

    /* Notifikácie */
    #saveNotification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #4CAF50; color: white; padding: 12px 25px; border-radius: 5px; z-index: 1000; transition: opacity 0.5s ease, background-color 0.3s ease, transform 0.5s ease; opacity: 0; pointer-events: none; font-size: 1em; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    #saveNotification.show { opacity: 1; transform: translate(-50%, 0); pointer-events: auto; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }

    /* Loading */
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; /* Upravené pre text */ align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; text-align: center; padding: 20px; }
    #loading-container h1 { font-size: 1.5em; color: #555; background: none; -webkit-background-clip: unset; background-clip: unset; animation: none; text-shadow: none; } /* Vypnuté efekty pre loading text */
    #loading-container.hidden { opacity: 0; pointer-events: none; }
    .dark-mode #loading-container { background-color: rgba(33, 33, 33, 0.9); }
    .dark-mode #loading-container h1 { color: #ccc; }

    /* Úprava validácie inputu */
    input:invalid { border-color: #f44336; } /* Len jemné zvýraznenie pre HTML5 validáciu */
    input.error-border { border: 1px solid red !important; } /* Explicitná trieda pre chybu */

  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div id="loading-container">
      <h1> Tajomstvo úspechu je slušnosť a úprimnosť.<br> Akonáhle sa ich zbavíte, dosiahnete všetko. 😉</h1>
      <p style="margin-top: 20px; font-size: 1.2em;">Načítavam...</p>
  </div>

  <!-- Auth Container -->
  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
    <div id="auth-forms">
      <form id="register-form" onsubmit="event.preventDefault(); register();">
        <h2>Registrácia</h2>
        <div class="input-group">
          <input type="email" id="registerEmail" placeholder="Email" required>
        </div>
        <div class="input-group">
          <input type="password" id="registerPassword" placeholder="Heslo (min. 6 znakov)" required minlength="6">
          <i class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('registerPassword', this)"></i>
        </div>
        <button type="submit">Registrovať</button>
      </form>
      <hr>
      <form id="login-form" onsubmit="event.preventDefault(); login();">
        <h2>Prihlásenie</h2>
        <div class="input-group">
          <input type="email" id="loginEmail" placeholder="Email" required>
        </div>
        <div class="input-group">
          <input type="password" id="loginPassword" placeholder="Heslo" required>
           <i class="fas fa-eye password-toggle-icon" onclick="togglePasswordVisibility('loginPassword', this)"></i>
        </div>
        <button type="submit">Prihlásiť sa</button>
        <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
      </form>
    </div>
  </div>

  <!-- Calculator Container -->
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>

    <div class="settings">
      <div>
        <label for="employeeNameInput">Meno pracovníka:</label>
        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()">
      </div>
      <div>
        <label for="hourlyWageInput">Hodinová mzda (€):</label>
        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="taxRateInput">Daňové percento (%):</label>
        <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1" oninput="updateSettings()">
      </div>
      <div>
        <label for="monthSelect">Mesiac:</label>
        <select id="monthSelect" onchange="changeMonth()">
          <option value="0">Január</option><option value="1">Február</option><option value="2">Marec</option><option value="3">Apríl</option><option value="4">Máj</option><option value="5">Jún</option><option value="6">Júl</option><option value="7">August</option><option value="8">September</option><option value="9">Október</option><option value="10">November</option><option value="11">December</option>
        </select>
      </div>
      <div>
        <label for="yearSelect">Rok:</label>
        <select id="yearSelect" onchange="changeYear()"></select>
      </div>
      <div>
        <label for="decimalPlacesSelect">Desatinné miesta (čas):</label>
        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
          <option value="1">1</option><option value="2">2</option>
        </select>
      </div>
      <button onclick="toggleDarkMode()" class="btn toggle-dark-btn">
          <i id="darkModeIcon" class="fas fa-moon"></i> Tmavý Režim
      </button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th>
            <th>Príchod</th>
            <th>Odchod</th>
            <th>Prestávka (h)</th>
            <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th>
            <th>Čistá Mzda (€)</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <div id="totalSalary">Načítavam súhrn...</div>

    <div id="dataSizeContainer">
      <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>

    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať Mesiac</button>
      <button class="btn export-btn" onclick="exportToPDF()">Export PDF (Detail)</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF (Základ)</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť Zálohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť Zálohu</button>
      <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhlásiť sa</button>
    </div>
  </div>

  <!-- Save Notification Area -->
  <div id="saveNotification" aria-live="polite"></div>

  <script>
    // --- Konfigurácia a Inicializácia Firebase ---
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try {
      firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true);
    } catch (error) {
      console.warn("Chyba pri aktivácii Firebase App Check:", error);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Povolenie Firestore Offline Persistence
    db.enablePersistence().then(() => {
      console.log("Firestore offline persistence povolená.");
    }).catch((err) => {
      console.error("Firestore offline persistence chyba:", err.code, err.message, err);
      if (err.code == 'failed-precondition') {
        console.warn("Firestore offline persistence: Viacnásobné otvorené taby, povolené len v jednom.");
      } else if (err.code == 'unimplemented') {
        console.error("Firestore offline persistence: Prehliadač nie je podporovaný.");
      }
    });

    // --- Globálne premenné a Konfigurácia ---
    const config = {
        MAX_DATA_SIZE: 4 * 1024 * 1024, // 4MB limit pre localStorage
        MAX_DATA_SIZE_KB: (4 * 1024 * 1024) / 1024,
        DEBOUNCE_TIME: 600 // ms
    };

    let state = {
        currentMonth: null,
        currentYear: null,
        decimalPlaces: 1,
        employeeName: '',
        hourlyWage: 10,
        taxRate: 0.02, // uložené ako desatinné číslo (napr. 0.02 pre 2%)
        monthData: {}, // Štruktúra: { ROK: { MESIAC: [ {start, end, breakTime}, ... ] } }
        firestoreListenerUnsubscribe: null,
        isDarkMode: false,
        userId: null
    };

    // --- Referencie na UI Elementy ---
    const uiElements = {
        loadingContainer: document.getElementById('loading-container'),
        authContainer: document.getElementById('auth-container'),
        calculatorContainer: document.getElementById('calculator-container'),
        authMessage: document.getElementById('auth-message'),
        registerEmail: document.getElementById('registerEmail'),
        registerPassword: document.getElementById('registerPassword'),
        loginEmail: document.getElementById('loginEmail'),
        loginPassword: document.getElementById('loginPassword'),
        welcomeMessage: document.getElementById('welcomeMessage'),
        employeeNameInput: document.getElementById('employeeNameInput'),
        hourlyWageInput: document.getElementById('hourlyWageInput'),
        taxRateInput: document.getElementById('taxRateInput'),
        monthSelect: document.getElementById('monthSelect'),
        yearSelect: document.getElementById('yearSelect'),
        decimalPlacesSelect: document.getElementById('decimalPlacesSelect'),
        workDays: document.getElementById('workDays'),
        totalSalaryDiv: document.getElementById('totalSalary'),
        dataSizeText: document.getElementById('dataSizeText'),
        dataSizeFill: document.getElementById('dataSizeFill'),
        dataSizeBar: document.getElementById('dataSizeBar'), // Pridané pre lepšiu kontrolu
        saveNotification: document.getElementById('saveNotification'),
        darkModeIcon: document.getElementById('darkModeIcon'),
        logoutBtn: document.getElementById('logout-btn') // Pridané
    };

    // --- Pomocné Funkcie ---

    /**
     * Vráti názov mesiaca podľa indexu (0-11).
     * @param {number} monthIndex Index mesiaca (0 = Január).
     * @returns {string} Názov mesiaca.
     */
    const getMonthName = (monthIndex) => {
      const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"];
      return monthNames[monthIndex] || 'Neznámy';
    };

    /**
     * Vráti počet dní v danom mesiaci a roku.
     * @param {number} month Index mesiaca (0-11).
     * @param {number} year Rok.
     * @returns {number} Počet dní.
     */
    const getDaysInMonth = (month, year) => {
      if (month === undefined || month === null || year === undefined || year === null) {
        console.warn("getDaysInMonth: Chýba mesiac alebo rok, vraciam 31.");
        return 31;
      }
      // Mesiac v Date objekte je 0-indexovaný, takže pre posledný deň mesiaca `month` potrebujeme `month + 1`
      return new Date(year, month + 1, 0).getDate();
    };

     /**
     * Vráti názov dňa v týždni.
     * @param {number} year Rok.
     * @param {number} month Index mesiaca (0-11).
     * @param {number} day Deň v mesiaci (1-31).
     * @returns {string} Názov dňa.
     */
    const getDayName = (year, month, day) => {
        const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"];
        const date = new Date(year, month, day);
        return daysOfWeek[date.getDay()];
    };

    /**
     * Debounce funkcia na obmedzenie frekvencie volania inej funkcie.
     * @param {Function} func Funkcia na debouncovanie.
     * @param {number} wait Čas čakania v ms.
     * @returns {Function} Debouncovaná funkcia.
     */
    const debounce = (func, wait) => {
      let timeout;
      return function (...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    };

    /**
     * Zobrazí notifikáciu v spodnej časti obrazovky.
     * @param {string} message Správa na zobrazenie.
     * @param {'success' | 'error' | 'warning'} type Typ notifikácie.
     * @param {number} duration Trvanie zobrazenia v ms.
     */
    const showSaveNotification = (message, type = 'success', duration = 3000) => {
      if (!uiElements.saveNotification) return;
      uiElements.saveNotification.textContent = message;
      uiElements.saveNotification.className = 'show'; // Základná trieda pre zobrazenie
      if (type === 'error') {
        uiElements.saveNotification.classList.add('error');
      } else if (type === 'warning') {
        uiElements.saveNotification.classList.add('warning');
      }
      // Po čase skryť
      setTimeout(() => {
          if (uiElements.saveNotification) {
             uiElements.saveNotification.classList.remove('show');
             // Odstrániť špecifické triedy po skrytí animácie
             setTimeout(() => {
                 if (uiElements.saveNotification) {
                     uiElements.saveNotification.classList.remove('error', 'warning');
                 }
             }, 500); // Čas zodpovedajúci CSS transition
          }
      }, duration);
    };

    /**
     * Prepína viditeľnosť hesla v input poli.
     * @param {string} inputId ID input elementu pre heslo.
     * @param {HTMLElement} iconElement Element ikony (oka).
     */
    const togglePasswordVisibility = (inputId, iconElement) => {
        const passwordInput = document.getElementById(inputId);
        if (!passwordInput || !iconElement) return;

        if (passwordInput.type === "password") {
            passwordInput.type = "text";
            iconElement.classList.remove("fa-eye");
            iconElement.classList.add("fa-eye-slash");
        } else {
            passwordInput.type = "password";
            iconElement.classList.remove("fa-eye-slash");
            iconElement.classList.add("fa-eye");
        }
    };

    // --- Funkcie pre Autentifikáciu ---

    /** Registruje nového používateľa. */
    const register = async () => {
      const email = uiElements.registerEmail.value;
      const password = uiElements.registerPassword.value;
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        console.log("Registrovaný:", userCredential.user);
        showSaveNotification("Registrácia úspešná!", "success");
        // Vyčistiť formulár po úspechu
        uiElements.registerEmail.value = '';
        uiElements.registerPassword.value = '';
      } catch (error) {
        console.error("Chyba pri registrácii:", error.message);
        showSaveNotification(`Chyba pri registrácii: ${error.message}`, "error", 5000);
      }
    };

    /** Prihlási existujúceho používateľa. */
    const login = async () => {
      const email = uiElements.loginEmail.value;
      const password = uiElements.loginPassword.value;
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        console.log("Prihlásený:", userCredential.user);
        showSaveNotification("Prihlásenie úspešné!", "success");
         // Vyčistiť formulár po úspechu (okrem emailu pre prípad zabudnutého hesla)
        // uiElements.loginEmail.value = '';
        uiElements.loginPassword.value = '';
      } catch (error) {
        console.error("Chyba pri prihlásení:", error.message);
        showSaveNotification(`Chyba pri prihlásení: ${error.message}`, "error", 5000);
      }
    };

    /** Odhlási aktuálneho používateľa. */
    const logout = async () => {
      try {
        await auth.signOut();
        console.log("Odhlásený.");
        showSaveNotification("Odhlásenie úspešné!", "success");
        // Vyčistiť stav aplikácie po odhlásení
        state.monthData = {};
        state.userId = null;
        // UI sa aktualizuje cez onAuthStateChanged listener
      } catch (error) {
        console.error("Chyba pri odhlásení:", error.message);
        showSaveNotification(`Chyba pri odhlásení: ${error.message}`, "error");
      }
    };

    /** Odošle email na obnovenie hesla. */
    const forgotPassword = async () => {
      const email = uiElements.loginEmail.value;
      if (!email) {
        showSaveNotification("Prosím, zadajte svoju e-mailovú adresu do poľa pre prihlásenie.", "warning");
        uiElements.loginEmail.focus();
        return;
      }
      try {
        await auth.sendPasswordResetEmail(email);
        console.log("E-mail na obnovenie hesla odoslaný na:", email);
        showSaveNotification("Odkaz na obnovenie hesla bol odoslaný na vašu e-mailovú adresu. Skontrolujte si poštu (aj Spam).", "success", 6000);
      } catch (error) {
        console.error("Chyba pri odosielaní e-mailu na obnovenie hesla:", error);
        showSaveNotification(`Chyba pri odosielaní e-mailu: ${error.message}`, "error", 5000);
      }
    };

    // --- Listener na Zmenu Stavu Autentifikácie ---
    auth.onAuthStateChanged(async user => {
        console.log("onAuthStateChanged: Stav zistený.", user ? `Používateľ: ${user.email}` : "Žiadny používateľ.");

        // Skryť loading overlay
        if (uiElements.loadingContainer) {
            uiElements.loadingContainer.classList.add('hidden');
        }

        // Odhlásenie predchádzajúceho listenera, ak existuje
        if (state.firestoreListenerUnsubscribe) {
            console.log("Odhlasujem predchádzajúci Firestore listener pri zmene Auth stavu.");
            state.firestoreListenerUnsubscribe();
            state.firestoreListenerUnsubscribe = null;
        }

        if (user) {
            // Používateľ je prihlásený
            state.userId = user.uid;
            uiElements.authMessage.textContent = `Prihlásený: ${user.email}`;
            uiElements.authContainer.style.display = "none";
            uiElements.calculatorContainer.style.display = "block";
            console.log("Používateľ prihlásený, nastavujem UI a listener...");

            // Načítanie posledného stavu z localStorage alebo defaultné hodnoty
            loadInitialSettings();
            await loadFromLocalStorage(); // Načíta dáta pre aktuálny mesiac/rok a nastavenia
            updateUIFromLoadedData();   // Vykreslí načítané dáta
            setupFirestoreListener();   // Nastaví listener na Firebase zmeny

            // Vytvorenie/overenie užívateľského dokumentu vo Firestore
            const userDocRef = db.collection("users").doc(state.userId);
            try {
                const userDocSnap = await userDocRef.get();
                if (!userDocSnap.exists) {
                    await userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true });
                    console.log("Vytvorený/aktualizovaný dokument pre:", state.userId);
                } else {
                    console.log("Dokument používateľa existuje:", state.userId);
                }
            } catch (err) {
                console.error("Chyba pri kontrole/vytváraní dokumentu používateľa:", err);
                showSaveNotification("Chyba pri overovaní používateľských dát", "error");
            }

            // Malé oneskorenie pre prípad offline scenára hneď po načítaní
             setTimeout(() => {
                 if (auth.currentUser && !navigator.onLine) {
                     console.log("onAuthStateChanged (setTimeout): Offline, volám loadFromLocalStorage znova...");
                     loadFromLocalStorage().then(updateUIFromLoadedData);
                 }
             }, 200);


        } else {
            // Používateľ nie je prihlásený
            state.userId = null;
            uiElements.authMessage.textContent = "Žiadny používateľ nie je prihlásený.";
            uiElements.authContainer.style.display = "block";
            uiElements.calculatorContainer.style.display = "none";
            console.log("Používateľ odhlásený/neprihlásený.");

            // Vyčistenie UI kalkulačky
            state.monthData = {};
            if(uiElements.workDays) uiElements.workDays.innerHTML = '';
            if(uiElements.totalSalaryDiv) uiElements.totalSalaryDiv.innerHTML = '';
            updateWelcomeMessage(); // Skryje pozdrav
        }
    });


    // --- Správa Dát (LocalStorage & Firebase) ---

    /** Načíta globálne nastavenia (mzda, daň, atď.) a posledný mesiac/rok z localStorage alebo nastaví defaultné. */
    const loadInitialSettings = () => {
        const storedMonth = localStorage.getItem('currentMonth');
        const storedYear = localStorage.getItem('currentYear');
        const storedDarkMode = localStorage.getItem('darkMode');
        const storedDecimalPlaces = localStorage.getItem('decimalPlaces');
        const storedEmployeeName = localStorage.getItem('employeeName');
        const storedHourlyWage = localStorage.getItem('hourlyWage');
        const storedTaxRate = localStorage.getItem('taxRate'); // Uložené ako percento

        const currentDate = new Date();
        state.currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
        state.currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
        state.isDarkMode = storedDarkMode ? JSON.parse(storedDarkMode) : false;
        state.decimalPlaces = storedDecimalPlaces ? parseInt(storedDecimalPlaces) : 1;
        state.employeeName = storedEmployeeName ? JSON.parse(storedEmployeeName) : '';
        state.hourlyWage = storedHourlyWage ? parseFloat(JSON.parse(storedHourlyWage)) : 10;
        // Načítame percento a prepočítame na desatinné číslo pre interné použitie
        const taxRatePercent = storedTaxRate ? parseFloat(JSON.parse(storedTaxRate)) : 2;
        state.taxRate = taxRatePercent / 100;

        // Aktualizácia selectov a inputov pre nastavenia
        uiElements.monthSelect.value = state.currentMonth;
        populateYearSelect(); // Najprv naplniť, potom nastaviť
        if (uiElements.yearSelect.querySelector(`option[value="${state.currentYear}"]`)) {
             uiElements.yearSelect.value = state.currentYear;
        } else {
             // Ak rok neexistuje (napr. stará záloha), pridaj ho a nastav
             console.warn(`Rok ${state.currentYear} z localStorage nenájdený, pridávam a používam.`);
             const option = document.createElement('option');
             option.value = state.currentYear;
             option.textContent = state.currentYear;
             uiElements.yearSelect.appendChild(option);
             // Možno sortnúť roky? Pre jednoduchosť nechávam tak.
             uiElements.yearSelect.value = state.currentYear;
        }
        uiElements.decimalPlacesSelect.value = state.decimalPlaces;
        uiElements.employeeNameInput.value = state.employeeName;
        uiElements.hourlyWageInput.value = state.hourlyWage;
        uiElements.taxRateInput.value = state.taxRate * 100; // Zobraziť ako percento

        applyDarkMode(state.isDarkMode);
        console.log("loadInitialSettings: Nastavenia načítané/inicializované.");
    };


    /**
     * Načíta dáta pracovných dní pre aktuálny mesiac/rok z localStorage.
     * @returns {Promise<void>}
     */
    const loadFromLocalStorage = async () => {
        console.log(`loadFromLocalStorage: Načítavam pre ${getMonthName(state.currentMonth)} ${state.currentYear}`);
        try {
            const storedMonthData = localStorage.getItem('workDaysData');
            state.monthData = storedMonthData ? JSON.parse(storedMonthData) : {};

            // Zabezpečiť existenciu štruktúry pre aktuálny rok/mesiac
            if (!state.monthData[state.currentYear]) {
                state.monthData[state.currentYear] = {};
            }
            if (!state.monthData[state.currentYear][state.currentMonth]) {
                state.monthData[state.currentYear][state.currentMonth] = [];
                console.log(`loadFromLocalStorage: Pre ${state.currentYear}-${state.currentMonth} neboli v localStorage nájdené žiadne záznamy, inicializované prázdne pole.`);
            } else {
                 console.log(`loadFromLocalStorage: Načítaných ${state.monthData[state.currentYear][state.currentMonth].length} záznamov pre ${state.currentYear}-${state.currentMonth} z localStorage.`);
            }
            updateDataSize(); // Aktualizovať ukazovateľ veľkosti
        } catch (error) {
            console.error(`Kritická chyba pri načítavaní/spracovaní dát z localStorage pre ${getMonthName(state.currentMonth)} ${state.currentYear}:`, error);
            showSaveNotification("Chyba pri načítaní lokálnych dát!", "error");
            state.monthData = {}; // Reset v prípade chyby
        }
        // UI sa aktualizuje samostatne volaním updateUIFromLoadedData()
    };

    /**
     * Uloží aktuálny stav (nastavenia a dáta dní) do localStorage a spustí ukladanie do Firebase.
     * Debouncovaná verzia sa volá pri zmenách.
     */
    const saveState = async () => {
        console.log("saveState: Spustené ukladanie...");
        try {
            // 1. Uloženie nastavení do localStorage
            localStorage.setItem('hourlyWage', JSON.stringify(state.hourlyWage));
            localStorage.setItem('taxRate', JSON.stringify(state.taxRate * 100)); // Uložiť ako percento
            localStorage.setItem('darkMode', JSON.stringify(state.isDarkMode));
            localStorage.setItem('decimalPlaces', JSON.stringify(state.decimalPlaces));
            localStorage.setItem('employeeName', JSON.stringify(state.employeeName));
            localStorage.setItem('currentMonth', state.currentMonth.toString());
            localStorage.setItem('currentYear', state.currentYear.toString());

            // 2. Uloženie dát dní (celá štruktúra monthData) do localStorage
            const serializedMonthData = JSON.stringify(state.monthData);
            const bytes = new Blob([serializedMonthData]).size;
            if (bytes > config.MAX_DATA_SIZE * 0.9 && bytes <= config.MAX_DATA_SIZE) {
                console.warn(`Veľkosť dát ('workDaysData') v localStorage (${(bytes / 1024).toFixed(2)} KB) sa blíži k limitu ${config.MAX_DATA_SIZE_KB} KB.`);
                showSaveNotification("Pozor: Lokálne úložisko je takmer plné!", "warning", 5000);
            } else if (bytes > config.MAX_DATA_SIZE) {
                console.error(`Prekročili ste maximálnu veľkosť dát (${(bytes / 1024).toFixed(2)} KB > ${config.MAX_DATA_SIZE_KB} KB) pre dáta mesiacov v localStorage. Ukladanie zlyhalo.`);
                showSaveNotification(`Chyba: Lokálne dáta sú príliš veľké (~${(bytes / 1024).toFixed(2)} KB)! Ukladanie zlyhalo. Skúste vymazať staré mesiace alebo vytvoriť zálohu a resetovať.`, "error", 10000);
                return; // Neukladať, ak je prekročený limit
            }
            localStorage.setItem('workDaysData', serializedMonthData);
            updateDataSize(); // Aktualizovať ukazovateľ

            // 3. Spustenie ukladania do Firebase (ak je používateľ prihlásený)
            if (state.userId) {
                 await saveToFirebase();
                 // Notifikácia o úspešnom uložení sa zobrazí, keď Firebase potvrdí (v listeneri)
                 // alebo ak sme offline
                 if (!navigator.onLine) {
                    showSaveNotification("Offline: Zmeny uložené lokálne", "warning");
                 }
            } else {
                console.log("saveState: Používateľ nie je prihlásený, ukladám len lokálne.");
                showSaveNotification("Zmeny uložené lokálne (neprihlásený)", "success");
            }

        } catch (error) {
            console.error('Chyba pri ukladaní stavu (lokálne/spustení Firebase save):', error);
            showSaveNotification("Kritická chyba pri ukladaní!", "error", 5000);
        }
    };
    // Vytvorenie debouncovanej verzie saveState
    const debouncedSaveState = debounce(saveState, config.DEBOUNCE_TIME);


    /** Uloží dáta *aktuálneho* mesiaca a nastavenia do Firebase. */
    const saveToFirebase = async () => {
        if (!state.userId) {
            console.log("saveToFirebase: Nikto nie je prihlásený.");
            return;
        }
        if (state.currentMonth === null || state.currentYear === null) {
            console.error("saveToFirebase: Chýba aktuálny mesiac alebo rok.");
            return;
        }

        try {
            // Pripraviť dáta na uloženie - len aktuálny mesiac + globálne nastavenia
            const currentMonthWorkData = state.monthData?.[state.currentYear]?.[state.currentMonth] || [];
            // Očistenie dát pred uložením (odstránenie null/undefined hodnôt)
            const cleanMonthWorkData = currentMonthWorkData.map(day => ({
                start: day.start || '',
                end: day.end || '',
                breakTime: day.breakTime || '' // Ukladáme ako string, aj keď je to číslo v inpute? Zjednotíme na string.
            }));

            console.log(`saveToFirebase: Pripravujem na uloženie ${cleanMonthWorkData.length} záznamov pre ${state.currentYear}-${state.currentMonth}.`);

            const dataToSave = {
                days: cleanMonthWorkData,
                hourlyWage: state.hourlyWage || 10,
                taxRate: (state.taxRate * 100) || 2, // Uložiť ako percento
                decimalPlaces: state.decimalPlaces || 1,
                employeeName: state.employeeName || '',
                darkMode: state.isDarkMode || false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // Časová značka poslednej úpravy
            };

            const yearMonthDoc = `${state.currentYear}-${state.currentMonth}`;
            const docRef = db.collection("users").doc(state.userId).collection("calculatorData").doc(yearMonthDoc);

            // Použijeme set s merge=true, aby sme neprepisovali ostatné polia, ak by existovali,
            // ale v tomto prípade chceme prepísať celý dokument pre daný mesiac
            await docRef.set(dataToSave);
            console.log(`saveToFirebase: Požiadavka na uloženie dát pre ${yearMonthDoc} odoslaná.`);
            // Notifikácia o úspechu sa zvyčajne zobrazí v listeneri, keď dáta dorazia späť

        } catch (error) {
            console.error(`Chyba pri požiadavke na ukladanie do Firebase pre ${state.currentYear}-${state.currentMonth}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa odoslať dáta do Firebase", "error", 5000);
        }
    };


    /** Nastaví Firestore listener pre aktuálny mesiac a rok. */
    const setupFirestoreListener = () => {
        // Odhlásiť starý listener, ak existuje
        if (state.firestoreListenerUnsubscribe) {
            console.log("setupFirestoreListener: Odhlasujem predchádzajúci listener.");
            state.firestoreListenerUnsubscribe();
            state.firestoreListenerUnsubscribe = null;
        }

        if (!state.userId) {
            console.log("setupFirestoreListener: Používateľ nie je prihlásený, listener sa nenastavuje.");
            return;
        }
        if (state.currentMonth === null || state.currentYear === null) {
            console.error("setupFirestoreListener: Chýba aktuálny mesiac alebo rok.");
            return; // Nemôžeme nastaviť listener bez platného mesiaca/roka
        }

        const docPath = `users/${state.userId}/calculatorData/${state.currentYear}-${state.currentMonth}`;
        const docRef = db.doc(docPath);
        console.log(`setupFirestoreListener: Nastavujem listener pre ${docPath}`);

        state.firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
            console.log(`Firestore listener: Prijatý snapshot pre ${docPath}. Metadata: fromCache=${docSnap.metadata.fromCache}, hasPendingWrites=${docSnap.metadata.hasPendingWrites}`);

            // Ignorovať prvé volanie z cache, ak máme dáta zo servera (prevencia dvojitého spracovania)
            // POZN: Toto môže byť zložité, hasPendingWrites je spoľahlivejšie na ignorovanie lokálnych zmien
             if (docSnap.metadata.hasPendingWrites) {
                 console.log("Listener: Detekovaná lokálna zmena čakajúca na zápis. Preskakujem aktualizáciu UI z tohto snapshotu.");
                 // Môžeme zobraziť indikátor synchronizácie
                 showSaveNotification("Synchronizujem lokálne zmeny...", "warning", 1500);
                 // Aj keď preskakujeme UI update, môžeme chcieť aktualizovať localStorage, aby zodpovedal tomu, čo sa *malo* uložiť
                 if (docSnap.exists) {
                     try {
                        const localData = docSnap.data({ serverTimestamps: 'estimate' }); // estimate pre pending writes
                        const localDaysData = localData.days || [];
                         if (!state.monthData) state.monthData = {};
                         if (!state.monthData[state.currentYear]) state.monthData[state.currentYear] = {};
                         state.monthData[state.currentYear][state.currentMonth] = localDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '' }));
                         localStorage.setItem('workDaysData', JSON.stringify(state.monthData));
                         console.log("Listener (pending): Aktualizovaný localStorage podľa lokálneho snapshotu.");
                     } catch(e) { console.error("Listener (pending): Chyba pri spracovaní lokálneho snapshotu", e);}
                 }
                 return; // Dôležité - neaktualizovať UI/state z lokálneho echa
             }

            // Spracovanie dát zo servera alebo z cache (ak nie sú pending writes)
            if (docSnap.exists) {
                const data = docSnap.data(); // { serverTimestamps: 'estimate' } nie je nutné, ak nie sú pending writes
                console.log(`Listener: Dokument ${state.currentYear}-${state.currentMonth} existuje (server/cache). Načítané dáta:`, data);

                try {
                    // Načítanie nastavení z Firebase - POUŽIŤ LEN AK CHCEME, ABY FIREBASE PREPISOVAL LOKÁLNE NASTAVENIA
                    // Často je lepšie nechať lokálne nastavenia ako "master", pokiaľ používateľ explicitne neobnoví
                    // Ak chceme synchronizovať nastavenia cez Firebase:
                    const fbHourlyWage = data.hourlyWage ?? state.hourlyWage;
                    const fbTaxRatePercent = data.taxRate ?? (state.taxRate * 100);
                    const fbDecimalPlaces = data.decimalPlaces ?? state.decimalPlaces;
                    const fbEmployeeName = data.employeeName ?? state.employeeName;
                    const fbDarkMode = data.darkMode ?? state.isDarkMode;

                    let settingsChanged = false;
                    if (state.hourlyWage !== fbHourlyWage) { state.hourlyWage = fbHourlyWage; settingsChanged = true; }
                    if (state.taxRate * 100 !== fbTaxRatePercent) { state.taxRate = fbTaxRatePercent / 100; settingsChanged = true; }
                    if (state.decimalPlaces !== fbDecimalPlaces) { state.decimalPlaces = fbDecimalPlaces; settingsChanged = true; }
                    if (state.employeeName !== fbEmployeeName) { state.employeeName = fbEmployeeName; settingsChanged = true; }
                    if (state.isDarkMode !== fbDarkMode) { state.isDarkMode = fbDarkMode; settingsChanged = true; }

                    // Načítanie dát dní z Firebase
                    const firebaseDaysData = data.days || [];
                    if (!state.monthData) state.monthData = {};
                    if (!state.monthData[state.currentYear]) state.monthData[state.currentYear] = {};
                    // Porovnanie, či sa dáta dní reálne zmenili, aby sme zbytočne neprepisovali
                    const currentLocalDaysString = JSON.stringify(state.monthData[state.currentYear][state.currentMonth] || []);
                    const firebaseDaysString = JSON.stringify(firebaseDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '' })));

                    let daysChanged = false;
                    if (currentLocalDaysString !== firebaseDaysString) {
                        state.monthData[state.currentYear][state.currentMonth] = firebaseDaysData.map(day => ({
                            start: day.start || '',
                            end: day.end || '',
                            breakTime: day.breakTime || '' // Uistiť sa, že breakTime je string? Alebo číslo? Zjednotiť. Tu nechávam string.
                        }));
                        daysChanged = true;
                        console.log(`Listener: Dáta dní pre ${state.currentYear}-${state.currentMonth} aktualizované z Firebase.`);
                    } else {
                         console.log(`Listener: Dáta dní pre ${state.currentYear}-${state.currentMonth} sa nezhodujú s Firebase.`);
                    }


                    // Ak sa čokoľvek zmenilo (nastavenia alebo dni), aktualizuj localStorage a UI
                    if (settingsChanged || daysChanged) {
                        console.log("Listener: Detekované zmeny z Firebase, aktualizujem localStorage a UI.");
                        // Uložiť VŠETKY aktuálne načítané/aktualizované nastavenia a dáta do localStorage
                        localStorage.setItem('hourlyWage', JSON.stringify(state.hourlyWage));
                        localStorage.setItem('taxRate', JSON.stringify(state.taxRate * 100));
                        localStorage.setItem('darkMode', JSON.stringify(state.isDarkMode));
                        localStorage.setItem('decimalPlaces', JSON.stringify(state.decimalPlaces));
                        localStorage.setItem('employeeName', JSON.stringify(state.employeeName));
                        localStorage.setItem('workDaysData', JSON.stringify(state.monthData)); // Uložiť celú štruktúru
                        console.log("Listener: Zmeny z Firebase uložené do localStorage.");

                        // Aktualizovať UI s novými dátami (funkcia by mala byť schopná spracovať aktuálny `state`)
                        updateUIFromLoadedData(true); // true = signalizuje, že ide o update z listenera
                    } else {
                        console.log("Listener: Prijaté dáta z Firebase sú rovnaké ako lokálne, UI sa neaktualizuje.");
                    }

                     // Zobraziť notifikáciu o úspešnej synchronizácii, len ak dáta prišli zo servera
                     if (!docSnap.metadata.fromCache) {
                         console.log("Listener: Dáta prijaté priamo zo SERVERA.");
                         // Zobraz notifikáciu len ak boli reálne zmeny (aby nespamovala pri každom potvrdení)
                         if(settingsChanged || daysChanged) {
                             showSaveNotification("Dáta synchronizované s cloudom", "success", 2000);
                         }
                     }

                } catch (processError) {
                    console.error(`Listener: Chyba pri spracovaní dát z Firestore pre ${state.currentYear}-${state.currentMonth}:`, processError);
                    showSaveNotification("Chyba: Nesprávny formát dát z Firebase", "error");
                }
            } else {
                // Dokument na Firebase neexistuje
                console.log(`Listener: Dokument neexistuje (server/cache) na Firebase pre ${state.currentYear}-${state.currentMonth}.`);
                // Ak dokument neexistuje na serveri, mali by sme vymazať lokálne dáta pre tento mesiac?
                // ALEBO predpokladať, že lokálne dáta sú správne a nahrať ich?
                // Súčasné správanie: Nechá lokálne dáta, ak existujú, a zobrazí ich. Ak neexistujú, zobrazí prázdnu tabuľku.
                // Ak chceme, aby sa lokálne dáta automaticky nahrali, ak na serveri nič nie je:
                /*
                if (state.monthData?.[state.currentYear]?.[state.currentMonth]?.length > 0) {
                    console.log("Listener: Dokument na Firebase neexistuje, ale máme lokálne dáta. Nahrávam ich...");
                    saveToFirebase(); // Pozor na možné nekonečné cykly, ak save zlyhá
                } else {
                    // Ak neexistuje ani na serveri, ani lokálne, resetnúť v state pre istotu
                     if (!state.monthData) state.monthData = {};
                     if (!state.monthData[state.currentYear]) state.monthData[state.currentYear] = {};
                     state.monthData[state.currentYear][state.currentMonth] = [];
                     localStorage.setItem('workDaysData', JSON.stringify(state.monthData));
                     updateUIFromLoadedData(true); // Prekresliť (prázdnu) tabuľku
                }
                */
                // Súčasný kód implicitne necháva lokálne dáta, ak existujú, čo je asi bezpečnejšie.
                // Ak lokálne dáta neexistujú a na serveri tiež nie, `loadFromLocalStorage` už vytvoril prázdne pole.
                // Môžeme ale explicitne zabezpečiť, že ak dokument zmizne zo servera, vymaže sa aj lokálne:
                 if (state.monthData?.[state.currentYear]?.[state.currentMonth]?.length > 0) {
                     console.log(`Listener: Dokument ${state.currentYear}-${state.currentMonth} zmizol z Firebase. Resetujem lokálne dáta pre tento mesiac.`);
                     if (!state.monthData) state.monthData = {};
                     if (!state.monthData[state.currentYear]) state.monthData[state.currentYear] = {};
                     state.monthData[state.currentYear][state.currentMonth] = [];
                     localStorage.setItem('workDaysData', JSON.stringify(state.monthData)); // Uložiť zmenu
                     updateUIFromLoadedData(true); // Prekresliť UI (prázdne)
                     showSaveNotification(`Dáta pre ${getMonthName(state.currentMonth)} ${state.currentYear} boli odstránené zo servera.`, "warning", 4000);
                 }

            }
        }, (error) => {
            console.error(`Firestore listener chyba pre ${docPath}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa pripojiť k Firebase", "error", 5000);
            // Fallback na lokálne dáta v prípade chyby listenera
            console.log("Listener chyba, snažím sa načítať z localStorage ako fallback...");
            loadFromLocalStorage().then(() => updateUIFromLoadedData());
        });
    };


    // --- Funkcie pre UI a Výpočty ---

    /**
     * Aktualizuje UI elementy (inputy, selecty) na základe aktuálneho stavu (state).
     * @param {boolean} fromListener - Indikuje, či volanie pochádza z Firestore listenera (pre prípadné odlišné správanie).
     */
    const updateUIFromLoadedData = (fromListener = false) => {
        console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(state.currentMonth)} ${state.currentYear}. Volané z listenera: ${fromListener}`);
        try {
            // Aktualizácia globálnych nastavení v UI (len ak nie je element práve fokusovaný, aby sa neprerušilo písanie)
            if (document.activeElement !== uiElements.hourlyWageInput) {
                uiElements.hourlyWageInput.value = state.hourlyWage;
            }
            if (document.activeElement !== uiElements.taxRateInput) {
                uiElements.taxRateInput.value = state.taxRate * 100;
            }
            if (document.activeElement !== uiElements.decimalPlacesSelect) {
                uiElements.decimalPlacesSelect.value = state.decimalPlaces;
            }
            if (document.activeElement !== uiElements.employeeNameInput) {
                uiElements.employeeNameInput.value = state.employeeName;
            }

            // Aktualizácia selectov mesiaca a roka (tie by nemali byť fokusované počas zmeny)
            if (uiElements.monthSelect.value != state.currentMonth) { // != kvôli porovnaniu string vs number
                uiElements.monthSelect.value = state.currentMonth;
            }
             if (uiElements.yearSelect.value != state.currentYear) {
                if (uiElements.yearSelect.querySelector(`option[value="${state.currentYear}"]`)) {
                    uiElements.yearSelect.value = state.currentYear;
                } else {
                    // Rok sa nenachádza, mohol byť zmenený externe? Radšej reloadnúť celé nastavenia
                    console.warn(`Rok ${state.currentYear} v stave nenájdený v selecte pri updateUI. Reloadujem nastavenia.`);
                    loadInitialSettings(); // Reloadne vsetky nastavenia a updatne UI spravne
                }
            }

            // Vytvorenie alebo aktualizácia tabuľky
            createTable(); // Vždy prekreslí štruktúru tabuľky pre daný mesiac

            // Naplnenie dát do vytvorenej tabuľky
            const dataForCurrentMonth = state.monthData?.[state.currentYear]?.[state.currentMonth] || [];
            console.log(`updateUIFromLoadedData: Počet záznamov v state pre ${state.currentYear}-${state.currentMonth} pri plnení UI: ${dataForCurrentMonth.length}`);

            const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
            for (let i = 1; i <= daysInMonth; i++) {
                const dayData = dataForCurrentMonth[i - 1]; // Dáta sú 0-indexované
                const startElement = document.getElementById(`start-${state.currentYear}-${state.currentMonth}-${i}`);
                const endElement = document.getElementById(`end-${state.currentYear}-${state.currentMonth}-${i}`);
                const breakElement = document.getElementById(`break-${state.currentYear}-${state.currentMonth}-${i}`);

                if (startElement && endElement && breakElement) {
                    const currentStart = dayData?.start || '';
                    const currentEnd = dayData?.end || '';
                    const currentBreak = dayData?.breakTime || ''; // Predpokladáme string

                    // Aktualizuj hodnotu len ak sa líši A element nie je aktívny (aby listener neprepisoval práve menené pole)
                     if (startElement.value !== currentStart && document.activeElement !== startElement) {
                         startElement.value = currentStart;
                     }
                     if (endElement.value !== currentEnd && document.activeElement !== endElement) {
                         endElement.value = currentEnd;
                     }
                     if (breakElement.value !== currentBreak && document.activeElement !== breakElement) {
                         breakElement.value = currentBreak;
                     }
                    calculateRow(i); // Prepočítaj odpracovaný čas a mzdu pre riadok
                } else if (document.getElementById(`total-${state.currentYear}-${state.currentMonth}-${i}`)) {
                     // Ak existuje aspoň total bunka, ale inputy chýbajú, je to chyba
                     console.error(`Kritická chyba: Elementy (start/end/break) pre deň ${i} v updateUIFromLoadedData neboli nájdené po createTable!`);
                }
            }

            calculateTotal(); // Prepočítaj celkový súhrn
            updateDataSize(); // Aktualizuj veľkosť dát
            applyDarkMode(state.isDarkMode); // Aplikuj tmavý režim
            updateWelcomeMessage(); // Aktualizuj pozdrav
            console.log("UI aktualizované.");

        } catch (error) {
            console.error("Chyba počas aktualizácie UI:", error);
            showSaveNotification("Chyba pri prekresľovaní UI!", "error");
        }
    };


    /** Aplikuje alebo odstráni triedy pre tmavý režim. */
    const applyDarkMode = (isDark) => {
        state.isDarkMode = isDark; // Uloženie aktuálneho stavu
        const body = document.body;
        const container = uiElements.calculatorContainer;
        const authCont = uiElements.authContainer;
        // Dynamicky nájdeme všetky relevantné elementy, ktoré potrebujú zmenu triedy
        const elementsToToggle = [
            body, container, authCont,
            uiElements.totalSalaryDiv,
            ...document.querySelectorAll('table, th, td'), // Tabuľka
            ...document.querySelectorAll('input[type="text"], input[type="number"], input[type="tel"], input[type="email"], input[type="password"], select'), // Všetky inputy a selecty
            ...document.querySelectorAll('.btn'), // Všetky tlačidlá
            uiElements.authMessage, ...document.querySelectorAll('#auth-container h1, #auth-container h2'), // Auth texty
             document.querySelector('.autor-info'), uiElements.welcomeMessage, // Ostatné texty
        ];

        if (isDark) {
            elementsToToggle.forEach(el => el?.classList.add('dark-mode'));
            if (uiElements.darkModeIcon) uiElements.darkModeIcon.classList.replace('fa-moon', 'fa-sun');
        } else {
            elementsToToggle.forEach(el => el?.classList.remove('dark-mode'));
             if (uiElements.darkModeIcon) uiElements.darkModeIcon.classList.replace('fa-sun', 'fa-moon');
        }
        // Špeciálne ošetrenie pre aktuálny deň, ak existuje
        const currentDayRow = document.querySelector('.current-day');
        if (currentDayRow) {
            if (isDark) currentDayRow.classList.add('dark-mode');
            else currentDayRow.classList.remove('dark-mode');
        }
    };

    /** Prepne tmavý režim. */
    const toggleDarkMode = () => {
        const newDarkModeState = !state.isDarkMode;
        applyDarkMode(newDarkModeState);
        localStorage.setItem('darkMode', JSON.stringify(newDarkModeState)); // Ulož hneď
        // Ak je používateľ prihlásený, pošli zmenu aj do Firebase (cez debounced save)
        if (state.userId) {
            debouncedSaveState(); // Spustí ukladanie celého stavu vrátane darkMode
        }
    };


    /** Vytvorí štruktúru tabuľky pre aktuálny mesiac a rok. */
    const createTable = () => {
        if (!uiElements.workDays) return;
        uiElements.workDays.innerHTML = ''; // Vyčistiť starú tabuľku
        const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
        const today = new Date();
        const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth();
        const currentYearValue = today.getFullYear();
        const fragment = document.createDocumentFragment(); // Pre lepší výkon

        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            const isCurrentDay = (i === currentDayOfMonth && state.currentMonth === currentMonthIndex && state.currentYear === currentYearValue);
            if (isCurrentDay) {
                row.classList.add('current-day');
            }

            const dayName = getDayName(state.currentYear, state.currentMonth, i);
            const year = state.currentYear; // Použijeme aktuálny rok zo stavu
            const month = state.currentMonth; // Použijeme aktuálny mesiac zo stavu

            // Použitie template literals pre lepšiu čitateľnosť
            row.innerHTML = `
                <td>Deň ${i} (${dayName})</td>
                <td><input type="tel" id="start-${year}-${month}-${i}" maxlength="5" pattern="([01]\\d|2[0-3]):[0-5]\\d" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, 'end-${year}-${month}-${i}', ${i})"></td>
                <td><input type="tel" id="end-${year}-${month}-${i}" maxlength="5" pattern="([01]\\d|2[0-3]):[0-5]\\d" inputmode="numeric" placeholder="HH:MM" oninput="handleTimeInput(this, 'break-${year}-${month}-${i}', ${i})"></td>
                <td><input type="number" id="break-${year}-${month}-${i}" min="0" step="0.1" placeholder="hodiny" oninput="handleBreakInput(${i})"></td>
                <td id="total-${year}-${month}-${i}">0h 0m (${(0).toFixed(state.decimalPlaces)} h)</td>
                <td><input type="number" id="gross-${year}-${month}-${i}" min="0" step="0.01" placeholder="Hrubá Mzda" readonly></td>
                <td><input type="number" id="net-${year}-${month}-${i}" min="0" step="0.01" placeholder="Čistá Mzda" readonly></td>
                <td><button class="btn reset-btn" onclick="resetRow(${i})">Reset</button></td>
            `;
            fragment.appendChild(row);
        }
        uiElements.workDays.appendChild(fragment);
        // Aplikovať tmavý režim na novovytvorené elementy tabuľky
        applyDarkMode(state.isDarkMode);
    };


    /**
     * Spracuje vstup do polí pre čas (Príchod, Odchod).
     * Formátuje vstup, aktualizuje stav a prepočíta riadok.
     * @param {HTMLInputElement} input Element inputu.
     * @param {string} nextId ID nasledujúceho elementu pre focus.
     * @param {number} day Deň v mesiaci (1-based).
     */
    const handleTimeInput = (input, nextId, day) => {
        formatTimeInput(input); // Formátovanie HH:MM
        updateStateFromInput(input, day); // Uloženie hodnoty do state.monthData
        calculateRow(day); // Prepočítanie hodín a mzdy pre riadok
        debouncedSaveState(); // Spustenie (debouncovaného) ukladania

        // Automatický presun na ďalšie pole po zadaní 5 znakov (HH:MM)
        if (input.value.length === 5 && isTimeValid(input.value)) {
             moveFocus(input, nextId);
        } else if (input.value.length === 5 && !isTimeValid(input.value)) {
            // Označiť chybu, ak formát je HH:MM, ale čas je neplatný (napr. 25:00)
            input.classList.add('error-border');
            setTimeout(() => input.classList.remove('error-border'), 2000);
        } else {
             input.classList.remove('error-border'); // Odstrániť chybu, ak sa opraví
        }
    };

    /**
     * Spracuje vstup do poľa pre prestávku.
     * Aktualizuje stav a prepočíta riadok.
     * @param {number} day Deň v mesiaci (1-based).
     */
    const handleBreakInput = (day) => {
        const input = document.getElementById(`break-${state.currentYear}-${state.currentMonth}-${day}`);
        if (!input) return;
        updateStateFromInput(input, day); // Uloženie hodnoty do state.monthData
        calculateRow(day); // Prepočítanie hodín a mzdy pre riadok
        debouncedSaveState(); // Spustenie (debouncovaného) ukladania

        // Po zadaní prestávky môžeme presunúť fokus na začiatok ďalšieho dňa
        // (Toto je voliteľné, môže byť otravné)
        /*
        const nextDay = day + 1;
        const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
        if (nextDay <= daysInMonth) {
            const nextInputElementId = `start-${state.currentYear}-${state.currentMonth}-${nextDay}`;
            moveFocus(input, nextInputElementId);
        }
        */
    };

    /**
     * Aktualizuje `state.monthData` na základe hodnoty z input elementu.
     * @param {HTMLInputElement} input Element inputu.
     * @param {number} day Deň v mesiaci (1-based).
     */
    const updateStateFromInput = (input, day) => {
        if (!input) return;
        const dayIndex = day - 1; // Index v poli (0-based)
        const fieldId = input.id; // napr. start-2023-11-15
        let fieldKey = 'unknown'; // Kľúč v objekte dňa ('start', 'end', 'breakTime')

        if (fieldId.startsWith('start-')) fieldKey = 'start';
        else if (fieldId.startsWith('end-')) fieldKey = 'end';
        else if (fieldId.startsWith('break-')) fieldKey = 'breakTime';

        const value = input.value;

        if (fieldKey !== 'unknown') {
            // Zabezpečenie existencie štruktúry v state
            if (!state.monthData) state.monthData = {};
            if (!state.monthData[state.currentYear]) state.monthData[state.currentYear] = {};
            if (!state.monthData[state.currentYear][state.currentMonth]) state.monthData[state.currentYear][state.currentMonth] = [];

            // Doplnenie prázdnych objektov dní, ak pole nie je dosť dlhé
            while (state.monthData[state.currentYear][state.currentMonth].length <= dayIndex) {
                state.monthData[state.currentYear][state.currentMonth].push({ start: '', end: '', breakTime: '' });
            }

            // Aktualizácia hodnoty v state
            if (state.monthData[state.currentYear][state.currentMonth][dayIndex]) {
                state.monthData[state.currentYear][state.currentMonth][dayIndex][fieldKey] = value;
                 // console.log(`State updated: Day ${day}, Field ${fieldKey}, Value ${value}`);
            } else {
                // Toto by nemalo nastať vďaka while cyklu hore, ale pre istotu logujeme
                console.error(`updateStateFromInput: Chýba záznam pre deň ${dayIndex} (${day}) v state.monthData po inicializácii!`);
                // Skúsime vytvoriť objekt pre tento deň
                 state.monthData[state.currentYear][state.currentMonth][dayIndex] = { start: '', end: '', breakTime: '', [fieldKey]: value };
            }
        } else {
            console.warn("updateStateFromInput: Nerozpoznané pole pre input ID:", fieldId);
        }
    };

    /**
     * Formátuje vstup v časovom poli na HH:MM počas písania.
     * @param {HTMLInputElement} input Cieľový input element.
     */
    const formatTimeInput = (input) => {
        if (!input || input.type !== 'tel') return;
        let value = input.value.replace(/[^\d]/g, ''); // Odstráni všetko okrem čísel

        if (value.length > 4) {
            value = value.slice(0, 4); // Max 4 čísla
        }

        if (value.length === 3) {
            // Ak používateľ zadá napr. "123", predpokladáme "12:3"
            value = value.slice(0, 2) + ':' + value.slice(2);
        } else if (value.length === 4) {
            // Ak používateľ zadá "1234", formátujeme na "12:34"
            value = value.slice(0, 2) + ':' + value.slice(2);
        }
        // Neformátujeme, ak je dĺžka 1 alebo 2, necháme používateľa písať hodiny

        input.value = value; // Nastavíme upravenú hodnotu späť do inputu
    };

    /**
     * Skontroluje, či reťazec zodpovedá platnému formátu času HH:MM (00:00 - 23:59).
     * @param {string} timeStr Reťazec na kontrolu.
     * @returns {boolean} True, ak je platný, inak false.
     */
    const isTimeValid = (timeStr) => {
        if (!timeStr) return false;
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        return timeRegex.test(timeStr);
    };

    /**
     * Presunie focus na nasledujúci element, ak existuje.
     * @param {HTMLElement} currentElement Aktuálny element, z ktorého sa presúva focus.
     * @param {string | null} nextId ID nasledujúceho elementu.
     */
    const moveFocus = (currentElement, nextId) => {
        if (!nextId || !currentElement) return;
        const nextElement = document.getElementById(nextId);
        if (nextElement) {
            // Presunúť focus len ak ho má aktuálny element
            if (document.activeElement === currentElement) {
                console.log(`moveFocus: Presúvam fokus z ${currentElement.id} na ${nextId}`);
                nextElement.focus();
                // Ak je to input, môžeme ho aj vyselektovať
                if (nextElement.select) {
                    nextElement.select();
                }
            } else {
                 console.log(`moveFocus: Aktuálny element ${currentElement.id} už nemá fokus, presun preskočený.`);
            }
        } else {
            console.warn(`moveFocus: Element s ID ${nextId} nebol nájdený.`);
        }
    };

    /**
     * Vypočíta odpracovaný čas, hrubú a čistú mzdu pre daný riadok (deň) a aktualizuje príslušné bunky.
     * @param {number} day Deň v mesiaci (1-based).
     */
    const calculateRow = (day) => {
        const year = state.currentYear;
        const month = state.currentMonth;
        const startInput = document.getElementById(`start-${year}-${month}-${day}`);
        const endInput = document.getElementById(`end-${year}-${month}-${day}`);
        const breakInput = document.getElementById(`break-${year}-${month}-${day}`);
        const totalCell = document.getElementById(`total-${year}-${month}-${day}`);
        const grossElement = document.getElementById(`gross-${year}-${month}-${day}`);
        const netElement = document.getElementById(`net-${year}-${month}-${day}`);

        // Základná kontrola existencie elementov
        if (!startInput || !endInput || !breakInput || !totalCell || !grossElement || !netElement) {
             console.error(`Chyba v calculateRow(${day}): Jeden alebo viac elementov nenájdených.`);
             return;
        }

        const startTimeStr = startInput.value;
        const endTimeStr = endInput.value;
        // Prestávka je v hodinách (napr. 0.5), pre výpočet potrebujeme minúty
        const breakTimeHours = parseFloat(breakInput.value) || 0;
        const breakMinutes = breakTimeHours * 60;

        // Ak chýba príchod alebo odchod, alebo nie sú platné, vynuluj výsledky
        if (!isTimeValid(startTimeStr) || !isTimeValid(endTimeStr)) {
            totalCell.textContent = `0h 0m (${(0).toFixed(state.decimalPlaces)} h)`;
            grossElement.value = '0.00';
            netElement.value = '0.00';
            startInput.classList.toggle('error-border', startTimeStr.length > 0 && !isTimeValid(startTimeStr));
            endInput.classList.toggle('error-border', endTimeStr.length > 0 && !isTimeValid(endTimeStr));
            return;
        }

        // Odstrániť prípadné chybové označenie, ak sú časy platné
        startInput.classList.remove('error-border');
        endInput.classList.remove('error-border');


        // Výpočet odpracovaného času v minútach
        const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
        const [endHours, endMinutes] = endTimeStr.split(':').map(Number);

        const startTotalMinutes = startHours * 60 + startMinutes;
        let endTotalMinutes = endHours * 60 + endMinutes;

        // Ošetrenie práce cez polnoc
        if (endTotalMinutes < startTotalMinutes) {
            endTotalMinutes += 24 * 60; // Pridaj 24 hodín v minútach
        }

        const diffMinutes = endTotalMinutes - startTotalMinutes;
        const workedMinutes = Math.max(0, diffMinutes - breakMinutes); // Celkový odpracovaný čas v minútach

        // Prevod na hodiny a minúty pre zobrazenie
        const hours = Math.floor(workedMinutes / 60);
        const minutes = Math.round(workedMinutes % 60); // Zaokrúhliť minúty
        const decimalHours = workedMinutes / 60; // Desatinné hodiny pre výpočet mzdy

        // Aktualizácia bunky s odpracovaným časom
        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(state.decimalPlaces)} h)`;

        // Výpočet mzdy
        const currentHourlyWage = state.hourlyWage;
        const currentTaxRate = state.taxRate; // Použiť desatinné číslo
        const grossSalary = decimalHours * currentHourlyWage;
        const netSalary = grossSalary * (1 - currentTaxRate);

        // Aktualizácia inputov pre mzdu (formátované na 2 des. miesta)
        grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00';
        netElement.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00';
    };

     /** Resetuje hodnoty pre daný riadok (deň) v UI a v stave. */
    const resetRow = (day) => {
        const year = state.currentYear;
        const month = state.currentMonth;
        const dayIndex = day - 1;

        // Resetovanie inputov v UI
        const startInput = document.getElementById(`start-${year}-${month}-${day}`);
        const endInput = document.getElementById(`end-${year}-${month}-${day}`);
        const breakInput = document.getElementById(`break-${year}-${month}-${day}`);
        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
        if (breakInput) breakInput.value = '';

        // Resetovanie v stave
        if (state.monthData?.[year]?.[month]?.[dayIndex]) {
            state.monthData[year][month][dayIndex] = { start: '', end: '', breakTime: '' };
            console.log(`resetRow: Stav pre deň ${day} resetovaný.`);
        } else {
            // Ak záznam neexistuje, nemusíme robiť nič, ale môžeme logovať
            console.log(`resetRow: Záznam pre deň ${day} v stave neexistoval.`);
        }

        // Prepočítanie riadku (vynuluje čas a mzdu) a celkového súčtu
        calculateRow(day);
        calculateTotal();

        // Uloženie zmien
        debouncedSaveState();
        showSaveNotification(`Riadok pre deň ${day} bol vynulovaný.`, "success", 1500);
    };

    /** Resetuje všetky dáta pre aktuálny mesiac v UI a v stave. */
    const resetAll = () => {
        // Použijeme pôvodné confirm, kým nemáme lepší modal
        if (confirm(`Naozaj chcete resetovať všetky záznamy pre ${getMonthName(state.currentMonth)} ${state.currentYear}? Táto akcia je nevratná!`)) {
            const year = state.currentYear;
            const month = state.currentMonth;

            // Reset v stave
            if (!state.monthData) state.monthData = {};
            if (!state.monthData[year]) state.monthData[year] = {};
            state.monthData[year][month] = []; // Vytvorí prázdne pole pre daný mesiac
            console.log(`resetAll: Všetky dáta pre ${year}-${month} resetované v stave.`);

            // Reset v UI (prekreslením tabuľky a prepočítaním)
            createTable(); // Vytvorí prázdnu tabuľku
            calculateTotal(); // Vynuluje súčty

            // Uloženie zmien
            debouncedSaveState();
            showSaveNotification(`Dáta pre ${getMonthName(month)} ${year} boli resetované.`, "success");
        } else {
            showSaveNotification("Resetovanie zrušené.", "warning", 1500);
        }
    };

    /** Vypočíta celkový súhrn (odpracovaný čas, mzdy, priemery) pre aktuálny mesiac. */
    const calculateTotal = () => {
        let grandTotalWorkedMinutes = 0;
        let totalGrossSalary = 0;
        let totalNetSalary = 0;
        let daysWithEntries = 0;

        const year = state.currentYear;
        const month = state.currentMonth;
        const daysInMonth = getDaysInMonth(month, year);

        // Iterujeme cez dni v mesiaci
        for (let day = 1; day <= daysInMonth; day++) {
            const startInput = document.getElementById(`start-${year}-${month}-${day}`);
            const endInput = document.getElementById(`end-${year}-${month}-${day}`);
            const breakInput = document.getElementById(`break-${year}-${month}-${day}`);
            const grossInput = document.getElementById(`gross-${year}-${month}-${day}`); // Načítame priamo vypočítanú hrubú mzdu
            const netInput = document.getElementById(`net-${year}-${month}-${day}`);   // Načítame priamo vypočítanú čistú mzdu

            // Ak sú časy platné (podľa `calculateRow`)
             if (startInput && endInput && breakInput && grossInput && netInput && isTimeValid(startInput.value) && isTimeValid(endInput.value)) {
                const startTimeStr = startInput.value;
                const endTimeStr = endInput.value;
                const breakTimeHours = parseFloat(breakInput.value) || 0;
                const breakMinutes = breakTimeHours * 60;

                const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
                const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
                const startTotalMinutes = startHours * 60 + startMinutes;
                let endTotalMinutes = endHours * 60 + endMinutes;
                if (endTotalMinutes < startTotalMinutes) {
                    endTotalMinutes += 24 * 60;
                }
                const diffMinutes = endTotalMinutes - startTotalMinutes;
                const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes);

                if (workedMinutesForRow > 0) {
                    grandTotalWorkedMinutes += workedMinutesForRow;
                    daysWithEntries++;
                     // Sčítanie miezd priamo z inputov (ktoré sú už .toFixed(2))
                     totalGrossSalary += parseFloat(grossInput.value) || 0;
                     totalNetSalary += parseFloat(netInput.value) || 0;
                } else if (startTimeStr && endTimeStr) {
                     // Ak sú časy zadané, ale výsledok je 0 alebo menej (napr. prestávka dlhšia ako práca),
                     // stále počítame ako deň so záznamom pre priemer. Mzda bude 0.
                     daysWithEntries++;
                     totalGrossSalary += parseFloat(grossInput.value) || 0; // Mala by byť 0
                     totalNetSalary += parseFloat(netInput.value) || 0;   // Mala by byť 0
                }
             }
        }

        // Celkový čas
        const totalHours = Math.floor(grandTotalWorkedMinutes / 60);
        const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60);
        const grandTotalDecimalHours = grandTotalWorkedMinutes / 60;

        // Priemery
        const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
        const averageHours = Math.floor(averageWorkedMinutes / 60);
        const averageMinutes = Math.round(averageWorkedMinutes % 60);
        const averageDecimalHours = averageWorkedMinutes / 60;
        const averageNetSalary = daysWithEntries > 0 ? totalNetSalary / daysWithEntries : 0;

        // Aktualizácia divu so súhrnom
        if(uiElements.totalSalaryDiv) {
             uiElements.totalSalaryDiv.innerHTML = `
                Počet odpracovaných dní: ${daysWithEntries}<br>
                Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(state.decimalPlaces)} h)<br>
                Celková hrubá mzda: ${totalGrossSalary.toFixed(2)} €<br>
                Celková čistá mzda: ${totalNetSalary.toFixed(2)} €<br>
                Priemerná čistá mzda na deň: ${averageNetSalary.toFixed(2)} €<br>
                <strong>Priemerný odpracovaný čas na deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(state.decimalPlaces)} h)</strong>
            `;
        }
    };


    /** Aktualizuje ukazovateľ využitia localStorage. */
    const updateDataSize = () => {
        if (!uiElements.dataSizeText || !uiElements.dataSizeFill || !uiElements.dataSizeBar) return;
        try {
            const totalData = Object.values(localStorage).reduce((acc, value) => acc + (value ? new Blob([value]).size : 0), 0);
            const kilobytes = (totalData / 1024).toFixed(2);
            const percentageUsed = Math.min(((totalData / config.MAX_DATA_SIZE) * 100), 100);

            uiElements.dataSizeText.textContent = `Lokálne úložisko: ~${kilobytes} KB / ${config.MAX_DATA_SIZE_KB} KB`;
            uiElements.dataSizeFill.style.width = `${percentageUsed}%`;

            // Zmena farby podľa zaplnenia
            if (percentageUsed > 90) {
                uiElements.dataSizeFill.style.backgroundColor = '#f44336'; // Červená
                 uiElements.dataSizeBar.style.borderColor = '#d32f2f';
            } else if (percentageUsed > 70) {
                uiElements.dataSizeFill.style.backgroundColor = '#ff9800'; // Oranžová
                 uiElements.dataSizeBar.style.borderColor = '#f57c00';
            } else {
                uiElements.dataSizeFill.style.backgroundColor = '#4CAF50'; // Zelená
                 uiElements.dataSizeBar.style.borderColor = '#ddd'; // Šedá pre normálny stav
            }
        } catch (error) {
            console.error("Chyba pri výpočte veľkosti localStorage:", error);
            uiElements.dataSizeText.textContent = "Chyba pri výpočte veľkosti dát.";
            uiElements.dataSizeFill.style.width = '0%';
        }
    };

    /** Získa prvé meno z celého mena. */
    const getFirstName = (fullName) => {
        if (!fullName || typeof fullName !== 'string') return '';
        const trimmedName = fullName.trim();
        if (!trimmedName) return '';
        return trimmedName.split(' ')[0];
    };

    /** Aktualizuje uvítaciu správu. */
    const updateWelcomeMessage = () => {
        if (!uiElements.welcomeMessage) return;
        const firstName = getFirstName(state.employeeName);
        if (firstName) {
            uiElements.welcomeMessage.textContent = `Vitaj späť, ${firstName}! 👋`;
        } else {
            uiElements.welcomeMessage.textContent = 'Vitajte!'; // Všeobecný pozdrav, ak nie je meno
        }
    };


    // --- Funkcie pre Nastavenia ---

    /** Aktualizuje nastavenia hodinovej mzdy a dane na základe inputov. */
    const updateSettings = () => {
        const newHourlyWageStr = uiElements.hourlyWageInput.value;
        const newTaxRateStr = uiElements.taxRateInput.value; // Percento
        const newHourlyWage = parseFloat(newHourlyWageStr);
        const newTaxRatePercent = parseFloat(newTaxRateStr);

        let changed = false;

        // Validácia a aktualizácia hodinovej mzdy
        if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
            if (state.hourlyWage !== newHourlyWage) {
                state.hourlyWage = newHourlyWage;
                changed = true;
            }
        } else if (newHourlyWageStr !== '') { // Ak je neplatné, ale nie prázdne, označ chybu
             uiElements.hourlyWageInput.classList.add('error-border');
        } else {
             uiElements.hourlyWageInput.classList.remove('error-border');
        }

        // Validácia a aktualizácia daňovej sadzby
        if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) {
            const newTaxRateDecimal = newTaxRatePercent / 100;
            if (state.taxRate !== newTaxRateDecimal) {
                state.taxRate = newTaxRateDecimal;
                changed = true;
            }
             uiElements.taxRateInput.classList.remove('error-border');
        } else if (newTaxRateStr !== '') { // Ak je neplatné, ale nie prázdne, označ chybu
            uiElements.taxRateInput.classList.add('error-border');
        } else {
            uiElements.taxRateInput.classList.remove('error-border');
        }

        // Ak došlo k zmene, prepočítaj všetky riadky a celkový súčet a ulož stav
        if (changed) {
            console.log("updateSettings: Zmenená mzda alebo daň. Prepočítavam...");
             uiElements.taxRateInput.classList.remove('error-border'); // Odstrániť chybu pri platnej zmene
             uiElements.hourlyWageInput.classList.remove('error-border');

            const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
            for (let i = 1; i <= daysInMonth; i++) {
                calculateRow(i);
            }
            calculateTotal();
            debouncedSaveState(); // Uložiť zmenené nastavenia
        }
    };

     /** Aktualizuje meno pracovníka a uloží stav. */
    const updateEmployeeName = () => {
        const newName = uiElements.employeeNameInput.value;
        if (state.employeeName !== newName) {
            state.employeeName = newName;
            updateWelcomeMessage(); // Aktualizuj pozdrav hneď
            debouncedSaveState(); // Uložiť zmenu mena
        }
    };

    /** Zmení počet desatinných miest pre zobrazenie času a uloží stav. */
    const changeDecimalPlaces = () => {
        const newDecimalPlaces = parseInt(uiElements.decimalPlacesSelect.value);
        if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) {
             if (state.decimalPlaces !== newDecimalPlaces) {
                state.decimalPlaces = newDecimalPlaces;
                calculateTotal(); // Prepočítať zobrazenie v súčte
                // Prepočítanie zobrazenia v riadkoch (ak treba)
                 const daysInMonth = getDaysInMonth(state.currentMonth, state.currentYear);
                 for (let i = 1; i <= daysInMonth; i++) {
                     calculateRow(i); // calculateRow už používa state.decimalPlaces
                 }
                debouncedSaveState(); // Uložiť zmenu
             }
        }
    };


    /** Zmení aktuálny mesiac a načíta/zobrazí jeho dáta. */
    const changeMonth = () => {
        const selectedMonth = parseInt(uiElements.monthSelect.value);
        if (state.currentMonth !== selectedMonth) {
            state.currentMonth = selectedMonth;
            console.log(`Zmenený mesiac na: ${getMonthName(state.currentMonth)} (${state.currentMonth})`);
            handleMonthYearChange();
        }
    };

    /** Zmení aktuálny rok a načíta/zobrazí jeho dáta. */
    const changeYear = () => {
        const selectedYear = parseInt(uiElements.yearSelect.value);
         if (state.currentYear !== selectedYear) {
            state.currentYear = selectedYear;
            console.log(`Zmenený rok na: ${state.currentYear}`);
            handleMonthYearChange();
        }
    };

    /** Spoločná logika po zmene mesiaca alebo roka. */
    const handleMonthYearChange = () => {
        console.log(`handleMonthYearChange: Načítavam dáta pre ${getMonthName(state.currentMonth)} ${state.currentYear}`);
        // Ulož aktuálny výber do localStorage, aby sa zachoval po reloade
        localStorage.setItem('currentMonth', state.currentMonth.toString());
        localStorage.setItem('currentYear', state.currentYear.toString());

        // Načítaj dáta pre nový mesiac/rok z localStorage (ak existujú)
        loadFromLocalStorage().then(() => {
            // Aktualizuj UI s načítanými dátami
            updateUIFromLoadedData();
            // Ak je používateľ prihlásený, resetuj a nastav nový Firestore listener
            if (state.userId) {
                setupFirestoreListener();
            } else {
                console.log("handleMonthYearChange: Používateľ nie je prihlásený, listener sa nenastavuje.");
            }
        });
    };

    /** Naplní select pre výber roka. */
    const populateYearSelect = () => {
        const startYear = 2020;
        const endYear = new Date().getFullYear() + 2; // Pár rokov do budúcnosti
        uiElements.yearSelect.innerHTML = ''; // Vyčistiť existujúce options
        for (let year = startYear; year <= endYear; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            uiElements.yearSelect.appendChild(option);
        }
        // Nastaviť aktuálny rok, ak už je v state
        if (state.currentYear) {
            uiElements.yearSelect.value = state.currentYear;
        }
    };

    // --- Funkcie pre Zálohovanie a Obnovu ---

    /** Vytvorí a stiahne záložný JSON súbor. */
    const createBackup = () => {
        try {
            // Zhromaždenie všetkých relevantných dát z localStorage
            const backupData = {
                workDaysData: localStorage.getItem('workDaysData') || '{}', // Všetky mesiace
                hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(state.hourlyWage),
                taxRate: localStorage.getItem('taxRate') || JSON.stringify(state.taxRate * 100), // Uložiť %
                darkMode: localStorage.getItem('darkMode') || JSON.stringify(state.isDarkMode),
                decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(state.decimalPlaces),
                employeeName: localStorage.getItem('employeeName') || JSON.stringify(state.employeeName),
                // Pridať verziu a časovú značku pre budúce použitie
                backupVersion: 3, // Zvýšiť verziu pri zmene štruktúry
                backupTimestamp: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().slice(0, 10);
            const filename = `bruno-calculator-backup-${dateStr}.json`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSaveNotification("Záloha úspešne vytvorená a stiahnutá.", "success");

        } catch (error) {
            console.error("Chyba pri vytváraní zálohy:", error);
            showSaveNotification("Nastala chyba pri vytváraní záložného súboru.", "error");
        }
    };

    /** Načíta záložný súbor a obnoví dáta v localStorage a stave. */
    const restoreBackup = () => {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json,application/json';

        fileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const backup = JSON.parse(e.target.result);

                    // Základná validácia štruktúry zálohy
                    if (backup && typeof backup.workDaysData === 'string' &&
                        typeof backup.hourlyWage === 'string' && typeof backup.taxRate === 'string' &&
                        typeof backup.darkMode === 'string' && typeof backup.decimalPlaces === 'string' &&
                        typeof backup.employeeName === 'string')
                    {
                        // Prepísanie localStorage dátami zo zálohy
                        localStorage.setItem('workDaysData', backup.workDaysData);
                        localStorage.setItem('hourlyWage', backup.hourlyWage);
                        localStorage.setItem('taxRate', backup.taxRate); // Uložené ako %
                        localStorage.setItem('darkMode', backup.darkMode);
                        localStorage.setItem('decimalPlaces', backup.decimalPlaces);
                        localStorage.setItem('employeeName', backup.employeeName);
                        // Neprepisujeme currentMonth/Year, tie si riadi používateľ výberom

                        // Načítať obnovené nastavenia a dáta do stavu a UI
                        loadInitialSettings(); // Znovu načíta nastavenia z LS
                        await loadFromLocalStorage(); // Znovu načíta dáta dní z LS pre aktuálny mesiac/rok
                        updateUIFromLoadedData(); // Aktualizuje celé UI

                        showSaveNotification("Záloha úspešne obnovená. Dáta boli načítané.", "success", 4000);

                        // Ak je používateľ prihlásený, spustíme uloženie obnovených dát
                        // pre AKTUÁLNE ZOBRAZENÝ mesiac do Firebase
                        if (state.userId) {
                            console.log("Obnova zálohy: Ukladám obnovené dáta pre aktuálny mesiac do Firebase...");
                            // Použijeme priame volanie saveState, nie debounced, aby sa vykonalo hneď
                            await saveState();
                        }
                    } else {
                         console.error("Chyba obnovy: Súbor zálohy má nesprávny formát alebo chýbajú kľúčové dáta.", backup);
                         showSaveNotification("Chyba: Súbor zálohy má nesprávny formát.", "error", 5000);
                    }
                } catch (error) {
                    console.error("Chyba pri spracovaní alebo obnove zálohy:", error);
                    showSaveNotification("Chyba pri čítaní/obnove zálohy. Súbor môže byť poškodený.", "error", 5000);
                }
            };

            reader.onerror = (e) => {
                console.error("Chyba pri čítaní súboru zálohy:", e);
                showSaveNotification("Nastala chyba pri čítaní súboru zálohy.", "error");
            };

            reader.readAsText(file);
        };
        fileInput.click(); // Otvorí dialóg na výber súboru
    };


    // --- Export do PDF (NEDOTKNUTÉ podľa požiadavky) ---
    /** Exportuje detailný výkaz do PDF. */
    const exportToPDF = () => { /* KÓD ZOSTÁVA NEZMENENÝ */ console.log("exportToPDF: Spustené..."); if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { showSaveNotification("Chyba: Knižnica jsPDF alebo autoTable nie je správne načítaná.", "error"); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; } const { jsPDF } = window.jspdf; try { const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("Could not load Roboto font for PDF, using default.", e); } doc.setFontSize(18); doc.text(`Bruno's Calculator - Výkaz (${getMonthName(state.currentMonth)} ${state.currentYear})`, 14, 20); doc.setFontSize(12); doc.text(`Meno pracovníka: ${state.employeeName || 'Nezadané'}`, 14, 28); doc.text(`Hodinová mzda: ${state.hourlyWage || 'N/A'} €`, 14, 34); doc.text(`Daň (%): ${state.taxRate*100 || 'N/A'}`, 100, 34); const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)", "Odpracované", "Hrubá Mzda (€)", "Čistá Mzda (€)"]; const tableRows = []; const dataForCurrentMonth = (state.monthData && state.monthData[state.currentYear] && state.monthData[state.currentYear][state.currentMonth]) || []; dataForCurrentMonth.forEach((day, index) => { if (day.start || day.end) { const dayNum = index + 1; const dayName = getDayName(state.currentYear, state.currentMonth, dayNum); const totalCell = document.getElementById(`total-${state.currentYear}-${state.currentMonth}-${dayNum}`); const grossInput = document.getElementById(`gross-${state.currentYear}-${state.currentMonth}-${dayNum}`); const netInput = document.getElementById(`net-${state.currentYear}-${state.currentMonth}-${dayNum}`); const workedTimeText = totalCell ? totalCell.textContent : 'N/A'; const grossValue = grossInput ? parseFloat(grossInput.value).toFixed(2) : '0.00'; const netValue = netInput ? parseFloat(netInput.value).toFixed(2) : '0.00'; const rowData = [ `Deň ${dayNum} (${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0', workedTimeText, grossValue, netValue ]; tableRows.push(rowData); } }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName }, styles: { font: doc.getFont().fontName, fontSize: 9 }, alternateRowStyles: { fillColor: [240, 240, 240] } }); const finalY = doc.lastAutoTable.finalY || 40; doc.setFontSize(10); const totalTextContent = uiElements.totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, ''); doc.text(totalTextContent, 14, finalY + 10); const pdfFileName = `Vykaz-${state.employeeName || 'pracovnik'}-${getMonthName(state.currentMonth)}-${state.currentYear}.pdf`; doc.save(pdfFileName); showSaveNotification("PDF exportované.", "success"); } catch (error) { console.error("Chyba pri generovaní PDF v exportToPDF:", error); showSaveNotification("Nastala chyba pri vytváraní PDF súboru.", "error"); } };
    /** Vygeneruje základné PDF a pokúsi sa ho zdieľať/stiahnuť. */
    const sendPDF = () => { /* KÓD ZOSTÁVA NEZMENENÝ */ console.log("sendPDF: Spustené..."); if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { showSaveNotification("Chyba: Knižnica jsPDF alebo autoTable nie je správne načítaná.", "error"); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; } const { jsPDF } = window.jspdf; try { const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("sendPDF: Could not load Roboto font, using default.", e); } doc.setFontSize(16); doc.text(`Pracovný výkaz - ${getMonthName(state.currentMonth)} ${state.currentYear}`, 14, 20); doc.setFontSize(12); doc.text(`Meno pracovníka: ${state.employeeName || 'Nezadané'}`, 14, 28); const tableColumn = ["Deň", "Príchod", "Odchod", "Prestávka (h)"]; const tableRows = []; const dataForCurrentMonth = (state.monthData && state.monthData[state.currentYear] && state.monthData[state.currentYear][state.currentMonth]) || []; dataForCurrentMonth.forEach((day, index) => { if (day.start || day.end) { const dayNum = index + 1; const dayName = getDayName(state.currentYear, state.currentMonth, dayNum); const rowData = [ `Deň ${dayNum} (${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0' ]; tableRows.push(rowData); } }); doc.autoTable({ head: [tableColumn], body: tableRows, startY: 35, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName }, styles: { font: doc.getFont().fontName, fontSize: 9 }, alternateRowStyles: { fillColor: [240, 240, 240] } }); const finalY = doc.lastAutoTable.finalY || 35; doc.setFontSize(10); const totalSalaryHTML = uiElements.totalSalaryDiv.innerHTML; let daysWithEntriesText = 'N/A'; const match = totalSalaryHTML.match(/Počet odpracovaných dní: (\d+)/); if (match && match[1]) { daysWithEntriesText = match[1]; } const summaryText = `Počet odpracovaných dní: ${daysWithEntriesText}`; doc.text(summaryText, 14, finalY + 10); const pdfBlob = doc.output('blob'); const pdfFileName = `Vykaz_odoslanie-${state.employeeName || 'pracovnik'}-${getMonthName(state.currentMonth)}-${state.currentYear}.pdf`; const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' }); if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) { navigator.share({ files: [pdfFile], title: `Pracovný výkaz ${getMonthName(state.currentMonth)} ${state.currentYear}`, text: `Výkaz pre ${state.employeeName || 'pracovníka'} za ${getMonthName(state.currentMonth)} ${state.currentYear}.` }).then(() => { showSaveNotification("PDF pripravené na zdieľanie.", "success"); }).catch((error) => { if (error.name !== 'AbortError') { console.error('sendPDF: Chyba pri zdieľaní cez Web Share API:', error); showSaveNotification('Chyba pri zdieľaní súboru.', "error"); } else { console.log('sendPDF: Zdieľanie PDF zrušené používateľom.'); showSaveNotification('Zdieľanie zrušené.', 'warning'); } }); } else { showSaveNotification("Zdieľanie súborov nie je podporované. Súbor bude stiahnutý.", "warning"); const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = pdfFileName; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); } } catch (error) { console.error("Chyba pri generovaní alebo zdieľaní PDF v sendPDF:", error); showSaveNotification("Nastala chyba pri vytváraní alebo zdieľaní PDF súboru.", "error"); } };


    // --- Inicializácia Aplikácie ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM načítaný, inicializujem...");

        // Zobraziť loading overlay hneď
        if (uiElements.loadingContainer) {
             uiElements.loadingContainer.classList.remove('hidden');
        } else {
            console.error("Loading container element not found!");
        }

        // Počkáme na Firebase Auth stav, ktorý spustí zvyšok inicializácie (v onAuthStateChanged)
        // Ale môžeme načítať základné veci ako tmavý režim a roky hneď
        const initialDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        applyDarkMode(initialDarkMode);
        populateYearSelect();

        // Registrácia Service Workera pre PWA funkcie
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js') // Uistite sa, že cesta je správna
                    .then(registration => {
                        console.log('ServiceWorker zaregistrovaný s rozsahom: ', registration.scope);
                    })
                    .catch(error => {
                        console.error('Registrácia ServiceWorker zlyhala: ', error);
                    });
            });
        } else {
            console.warn("Service Worker nie je podporovaný v tomto prehliadači.");
        }

        console.log("Základná DOM inicializácia dokončená, čakám na stav prihlásenia...");
        // Hlavná logika načítania dát a UI sa deje v `onAuthStateChanged`
    });

  </script>
</body>
</html>
