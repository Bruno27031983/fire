<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* CSS štýly zostávajú rovnaké, okrem pridania štýlov pre poznámky a úpravy šírky stĺpcov */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start; /* Zmenené na flex-start pre lepšie zarovnanie s details */
        gap: 10px; /* Pridaný gap pre medzery */
    }
    /* Priame deti .settings (div, details, button) */
    .settings > div,
    .settings > details,
    .settings > button {
        flex: 1 1 200px; /* Zachovanie flex basis */
        margin: 0; /* Odstránený margin, používame gap */
    }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 900px; /* Mierne zväčšená min-width kvôli novému stĺpcu */ }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; /* Zarovnaj obsah buniek hore */ }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea /* Pridaný select a .note-textarea */ {
        width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px;
    }
    /* Uprav šírky stĺpcov podľa potreby */
    th:nth-child(1), td:nth-child(1) { min-width: 50px; } /* Deň */
    th:nth-child(2), td:nth-child(2) { min-width: 80px; } /* Príchod */
    th:nth-child(3), td:nth-child(3) { min-width: 80px; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* Prestávka */
    th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* Odpracované */
    th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* Hrubá Mzda */
    th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* Čistá Mzda */
    th:nth-child(8), td:nth-child(8) { min-width: 120px; } /* Poznámka - nový stĺpec */
    th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia - posledný stĺpec */

    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input, .current-day .note-textarea /* Pridané .note-textarea pre current-day */ { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode /* Pridaný select a .note-textarea */ {
        background-color: #666; color: white; border-color: #888; /* Pridaná farba okraja pre dark mode */
    }
    .btn.dark-mode { color: #eee; } /* Lepšia čitateľnosť v dark mode */
    .reset-btn.dark-mode { background-color: #c62828; } .reset-btn.dark-mode:hover { background-color: #b71c1c; }
    .export-btn.dark-mode { background-color: #2e7d32; } .export-btn.dark-mode:hover { background-color: #1b5e20; }
    .restore-btn.dark-mode { background-color: #6a1b9a; } .restore-btn.dark-mode:hover { background-color: #4a148c; }
    .backup-btn.dark-mode { background-color: #ef6c00; } .backup-btn.dark-mode:hover { background-color: #e65100; }
    #logout-btn.dark-mode { background-color: #c62828; } /* Farba odhlasovacieho tlačidla v dark mode */
    #logout-btn.login-prompt.dark-mode { background-color: #1976D2; } /* Farba prihlasovacieho promptu v dark mode */
    #logout-btn.login-prompt.dark-mode:hover { background-color: #0D47A1; }

    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input, .current-day.dark-mode .note-textarea /* Pridané .note-textarea pre current-day dark mode */ { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    /* Auth container štýly */
    #auth-container { max-width: 400px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); text-align: center; border: 1px solid #ccc; }
     body.dark-mode #auth-container { background-color: #555; border-color: #777; }
    #auth-container h1 { font-size: 1.8em; margin-bottom: 15px; }
    #auth-container h2 { font-size: 1.4em; margin-top: 20px; margin-bottom: 10px; color: #444; }
     body.dark-mode #auth-container h2 { color: #eee; }
    #auth-container input { width: 90%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
     body.dark-mode #auth-container input { background-color: #666; color: white; border-color: #888; }
    #auth-container button { width: 95%; padding: 12px; margin: 15px 0 5px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 1.1em; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
    #auth-container button:hover { background-color: #45a049; }
     /* Tlačidlo na zatvorenie formulára */
     #close-auth-btn { background-color: #aaa; margin-top: 10px; }
     #close-auth-btn:hover { background-color: #888; }
     body.dark-mode #close-auth-btn { background-color: #777; }
     body.dark-mode #close-auth-btn:hover { background-color: #666; }

    #auth-message { margin-bottom: 15px; font-weight: bold; color: #333; }
     body.dark-mode #auth-message { color: #eee; }
    #forgot-password-link { display: block; margin-top: 10px; font-size: 0.9em; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }
     body.dark-mode #forgot-password-link { color: #66b3ff; }


    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; text-align: center; padding: 20px; }
    #loading-container h1 { font-size: 1.5em; color: #555; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }


    /* --- ŠTÝLY PRE ZBALITEĽNÚ ČASŤ (nezmenené) --- */
    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
    .collapsible-settings summary:hover { background-color: #eee; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
    body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
    body.dark-mode .collapsible-content { border-top-color: #666; }

    /* --- ŠTÝLY PRE POZNÁMKY (nezmenené) --- */
    .note-container { display: none; margin-top: 5px; }
    .note-container.visible { display: block; }
    .note-textarea { width: 95%; min-height: 40px; resize: vertical; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; background-color: #f0f0f0; }
    .toggle-note-btn { background-color: #6c757d; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease; margin-bottom: 2px; }
    .toggle-note-btn:hover { background-color: #5a6268; }
    .note-textarea.dark-mode { background-color: #555; color: #f4f4f4; border-color: #777; }
    .toggle-note-btn.dark-mode { background-color: #828a91; }
    .toggle-note-btn.dark-mode:hover { background-color: #70777d; }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loading-container"><h1> Tajomstvo úspechu je slušnosť a úprimnosť. Akonáhle sa ich zbavíte, dosiahnete všetko. </h1></div>

  <!-- Auth container - štandardne skrytý -->
  <div id="auth-container" style="display:none;">
    <h1>Prihlásenie / Registrácia</h1>
    <p>Prihlásenie umožňuje synchronizáciu dát medzi zariadeniami.</p>
    <div id="auth-message"></div>
    <div id="auth-forms">
      <h2>Registrácia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrovať</button>
      <h2>Prihlásenie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihlásiť sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
    <button id="close-auth-btn" onclick="closeAuthForm()">Zavrieť</button>
  </div>

  <!-- Calculator container - štandardne viditeľný po načítaní -->
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>

    <!-- Nastavenia -->
    <div class="settings">
        <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
                <option value="0">Január</option> <option value="1">Február</option> <option value="2">Marec</option>
                <option value="3">Apríl</option> <option value="4">Máj</option> <option value="5">Jún</option>
                <option value="6">Júl</option> <option value="7">August</option> <option value="8">September</option>
                <option value="9">Október</option> <option value="10">November</option> <option value="11">December</option>
            </select>
        </div>
        <details class="collapsible-settings">
            <summary>Ďalšie nastavenia</summary>
            <div class="collapsible-content">
                <div><label for="employeeNameInput">Meno pracovníka: </label><input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovníka" oninput="updateEmployeeName()"></div>
                <div><label for="hourlyWageInput">Hodinová mzda (€): </label><input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></div>
                <div><label for="taxRateInput">Daňové percento (%): </label><input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"></div>
                <div><label for="yearSelect">Rok: </label><select id="yearSelect" onchange="changeYear()"></select></div>
                <div><label for="decimalPlacesSelect">Počet desatinných miest: </label><select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option value="1">1</option><option value="2">2</option></select></div>
            </div>
        </details>
        <button onclick="toggleDarkMode()" class="btn highlight">Tmavý režim</button>
    </div>

    <!-- Tabuľka -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Deň</th> <th>Príchod</th> <th>Odchod</th> <th>Prestávka</th> <th>Odpracované</th>
            <th>Hrubá Mzda (€)</th> <th>Čistá Mzda (€)</th> <th class="th-note">Poznámka</th> <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>

    <!-- Súčty a info -->
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lokálne úložisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>

    <!-- Tlačidlá -->
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetovať aktuálny mesiac</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportovať do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odoslať PDF</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnoviť zálohu (lokálnu)</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvoriť zálohu (lokálnu)</button>
      <!-- Toto tlačidlo teraz slúži na Odhlásenie aj ako výzva na Prihlásenie -->
      <button id="logout-btn" class="btn reset-btn" style="display: none;"></button>
    </div>
  </div>

  <!-- Notifikácia -->
  <div id="saveNotification"></div>

  <script>
    // 1. Firebase Config & Init - Nezmenené
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktivácii Firebase App Check:", error); }
    const db = firebase.firestore(); const auth = firebase.auth();

    // 2. Povolenie Firestore Offline Persistence - Nezmenené
    db.enablePersistence().then(() => { console.log("Firestore offline persistence povolená."); }).catch((err) => { console.error("Firestore offline persistence chyba:", err.code, err.message, err); if (err.code == 'failed-precondition') { console.warn("Firestore offline persistence: Viacnásobné otvorené taby, povolené len v jednom."); } else if (err.code == 'unimplemented') { console.error("Firestore offline persistence: Prehliadač nie je podporovaný."); } });

    // 3. Globálne premenné - Pridaná isLoggedIn
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
    let monthData = {};
    let firestoreListenerUnsubscribe = null;
    let isLoggedIn = false; // Nová premenná na sledovanie stavu prihlásenia
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const authContainer = document.getElementById('auth-container');
    const calculatorContainer = document.getElementById('calculator-container');
    const loadingContainer = document.getElementById('loading-container');
    const logoutBtn = document.getElementById('logout-btn'); // Tlačidlo pre login/logout
    const authMessage = document.getElementById('auth-message');
    const MAX_DATA_SIZE = 4 * 1024 * 1024;
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // 4. Auth funkcie (Register, Login, Logout, Forgot Password) - Upravené pre UI formulára
    function register() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log("Registrovaný:", userCredential.user);
          alert("Registrácia úspešná! Teraz ste prihlásený.");
          closeAuthForm(); // Zatvor formulár po úspechu
        })
        .catch((error) => {
          console.error("Chyba pri registrácii:", error.message);
          alert("Chyba pri registrácii: " + error.message);
        });
    }

    function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          console.log("Prihlásený:", userCredential.user);
          alert("Prihlásenie úspešné!");
          closeAuthForm(); // Zatvor formulár po úspechu
        })
        .catch((error) => {
          console.error("Chyba pri prihlásení:", error.message);
          alert("Chyba pri prihlásení: " + error.message);
        });
    }

    function logout() {
      auth.signOut()
        .then(() => {
          console.log("Odhlásený.");
          alert("Odhlásenie úspešné!");
          // UI sa aktualizuje cez onAuthStateChanged
        })
        .catch((error) => {
          console.error("Chyba pri odhlásení:", error.message);
          alert("Chyba pri odhlásení: " + error.message);
        });
    }

    function forgotPassword() {
      const emailInput = document.getElementById('loginEmail'); // Použijeme email z prihlasovacieho formulára
      const email = emailInput.value;
      if (!email) {
        alert("Prosím, zadajte svoju e-mailovú adresu do poľa pre prihlásenie.");
        emailInput.focus();
        return;
      }
      auth.sendPasswordResetEmail(email)
        .then(() => {
          console.log("E-mail na obnovenie hesla odoslaný na:", email);
          alert("Odkaz na obnovenie hesla bol odoslaný na vašu e-mailovú adresu. Skontrolujte si prosím poštu (aj priečinok Spam).");
        })
        .catch((error) => {
          console.error("Chyba pri odosielaní e-mailu na obnovenie hesla:", error);
          alert("Chyba pri odosielaní e-mailu na obnovenie hesla: " + error.message);
        });
    }

    // Funkcia na zatvorenie prihlasovacieho formulára
    function closeAuthForm() {
        authContainer.style.display = 'none';
    }

    // 5. Auth State Change Listener - *** KĽÚČOVÁ ÚPRAVA ***
    auth.onAuthStateChanged(user => {
        console.log("onAuthStateChanged: Stav zistený.", user ? `Používateľ: ${user.email}` : "Žiadny používateľ.");
        const wasLoggedIn = isLoggedIn; // Uložíme si predošlý stav
        isLoggedIn = !!user; // Aktualizujeme globálny stav

        // Vždy skryjeme loading a zobrazíme kalkulačku
        if (loadingContainer) loadingContainer.classList.add('hidden');
        calculatorContainer.style.display = "block";
        authContainer.style.display = "none"; // Prihlasovací formulár je štandardne skrytý

        // Odhlásime predchádzajúci listener, ak existoval A menil sa stav prihlásenia
        // alebo ak sa odhlasujeme
        if (firestoreListenerUnsubscribe && (!isLoggedIn || wasLoggedIn !== isLoggedIn)) {
            console.log("Odhlasujem predchádzajúci Firestore listener pri zmene Auth stavu alebo odhlásení.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        // --- Vždy vykonáme základnú inicializáciu UI z localStorage ---
        // (Dáta dní sa načítajú nižšie cez loadFromLocalStorage)
        console.log("onAuthStateChanged: Vykonávam základnú inicializáciu UI z localStorage.");
        const storedMonth = localStorage.getItem('currentMonth');
        const storedYear = localStorage.getItem('currentYear');
        const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        const currentDate = new Date();
        currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
        currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
        // Nastavenie selectov pre mesiac a rok
        if (monthSelect.value != currentMonth) monthSelect.value = currentMonth; // Nastav len ak sa líši
        if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
             if (yearSelect.value != currentYear) yearSelect.value = currentYear; // Nastav len ak sa líši
        } else {
            console.warn(`Rok ${currentYear} z localStorage nenájdený v selecte, používam aktuálny rok.`);
            currentYear = currentDate.getFullYear();
            populateYearSelect(); // Znovu naplní select, ak rok chýbal
            yearSelect.value = currentYear;
        }
        applyDarkMode(darkMode); // Aplikuje dark mode
        // Načítanie nastavení (mzda, daň, atď.)
        hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
        taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
        decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
        employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
        // Aktualizácia inputov nastavení (len ak nemajú focus)
        if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
        if (document.activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
        if (document.activeElement !== decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces;
        if (document.activeElement !== employeeNameInput) employeeNameInput.value = employeeName;
        updateWelcomeMessage(); // Aktualizuje pozdrav
        // --- Koniec základnej inicializácie UI ---

        // Načítanie dát dní z localStorage a vykreslenie tabuľky
        // Robíme to tu, aby sme mali aktuálne dáta pred prípadným spustením listenera
        console.log("onAuthStateChanged: Volanie loadFromLocalStorage pre načítanie dát dní.");
        loadFromLocalStorage();

        if (user) {
            // ----- POUŽÍVATEĽ JE PRIHLÁSENÝ -----
            authMessage.textContent = "Prihlásený: " + user.email; // Správa vo formulári (ak sa otvorí)
            logoutBtn.style.display = 'block'; // Zobrazíme tlačidlo
            logoutBtn.onclick = logout; // Priradíme funkciu odhlásenia
            logoutBtn.textContent = `Odhlásiť sa (${user.email.substring(0, user.email.indexOf('@') || 10)}...)`; // Zobrazíme časť emailu
            logoutBtn.classList.remove('login-prompt'); // Odstránime prípadnú triedu pre štýl prihlásenia
            logoutBtn.classList.add('reset-btn'); // Vrátime pôvodnú triedu (alebo inú pre odhlásenie)

            console.log("Používateľ prihlásený, nastavujem Firebase listener...");
            setupFirestoreListener(); // Nastavenie listenera pre synchronizáciu

            // Kontrola/vytvorenie užívateľského dokumentu
            const uid = user.uid;
            const userDocRef = db.collection("users").doc(uid);
            userDocRef.get().then(userDocSnap => {
                if (!userDocSnap.exists) {
                    userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true })
                        .then(() => console.log("Vytvorený/aktualizovaný dokument pre:", uid))
                        .catch(err => console.error("Chyba pri vytváraní/aktualizácii dokumentu používateľa:", err));
                } else { console.log("Dokument používateľa existuje:", uid); }
            }).catch(err => {
                console.error("Chyba pri kontrole dokumentu používateľa (userDocRef.get):", err);
                showSaveNotification("Chyba pri overovaní používateľských dát", "error");
            });

            // Logika pre offline načítanie (môže zostať)
            setTimeout(() => {
                 if (auth.currentUser && !navigator.onLine) {
                      console.log("onAuthStateChanged (setTimeout): Vynútené druhé volanie loadFromLocalStorage (offline)...");
                      loadFromLocalStorage();
                 }
            }, 200);

        } else {
            // ----- POUŽÍVATEĽ NIE JE PRIHLÁSENÝ -----
            authMessage.textContent = "Nie ste prihlásený. Dáta sa ukladajú len lokálne."; // Správa vo formulári
            // Upravíme "odhlasovacie" tlačidlo, aby slúžilo na zobrazenie prihlasovacieho formulára
            logoutBtn.style.display = 'block'; // Tlačidlo bude viditeľné
            logoutBtn.textContent = 'Prihlásiť sa / Registrovať';
            logoutBtn.onclick = () => { // Priradíme funkciu na zobrazenie formulára
                authContainer.style.display = 'block';
                authContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };
             logoutBtn.classList.remove('reset-btn'); // Odstránime triedu pre odhlásenie
             logoutBtn.classList.add('login-prompt'); // Pridáme triedu pre štýl prihlásenia (napr. modrá farba)
             // Ak chcete použiť inú farbu pre prihlasovací prompt, pridajte CSS:
             // #logout-btn.login-prompt { background-color: #2196F3; }
             // #logout-btn.login-prompt:hover { background-color: #1976D2; }

            console.log("Používateľ nie je prihlásený. Kalkulačka beží v lokálnom režime.");
            // Firestore listener sa nenastaví (už je odhlásený vyššie)
        }
         // Aplikujeme dark mode aj na tlačidlo login/logout
         applyDarkMode(document.body.classList.contains('dark-mode'));
    });


    // 6. Utility funkcie (debounce, showSaveNotification, getFirstName, updateWelcomeMessage) - Nezmenené
    function debounce(func, wait) { let timeout; return function (...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), wait); }; }
    function showSaveNotification(message, type = 'success') { const notification = document.getElementById('saveNotification'); notification.textContent = message; notification.className = 'show'; if (type === 'error') { notification.classList.add('error'); } else if (type === 'warning') { notification.classList.add('warning'); } notification.classList.add('show'); setTimeout(() => { notification.classList.remove('show'); notification.classList.remove('error'); notification.classList.remove('warning');}, 3000); }
    function getFirstName(fullName) { if (!fullName || typeof fullName !== 'string') { return ''; } const trimmedName = fullName.trim(); if (!trimmedName) { return ''; } const parts = trimmedName.split(' '); return parts[0]; }
    function updateWelcomeMessage() { const welcomeElement = document.getElementById('welcomeMessage'); if (!welcomeElement) return; const firstName = getFirstName(employeeName); if (firstName) { welcomeElement.textContent = `Vitaj späť, ${firstName}! 👋`; } else { welcomeElement.textContent = ''; } }

    // 7. Funkcia na nastavenie Firestore Listenera - Upravená (obsahuje logiku z predchádzajúcej verzie)
    function setupFirestoreListener() {
        if (!isLoggedIn || !auth.currentUser) { console.log("setupFirestoreListener: Používateľ nie je prihlásený, listener sa nenastavuje."); return; }
        // Odhlásenie starého listenera, ak existuje (presunuté sem pre istotu)
        if (firestoreListenerUnsubscribe) { console.log("setupFirestoreListener: Odhlasujem predchádzajúci listener."); firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; }

        const uid = auth.currentUser.uid;
        if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) { const now = new Date(); currentMonth = currentMonth ?? now.getMonth(); currentYear = currentYear ?? now.getFullYear(); console.warn("setupFirestoreListener: Chýba mesiac/rok, použité aktuálne."); }
        const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`; const docRef = db.doc(docPath);
        console.log(`setupFirestoreListener: Nastavujem listener pre ${docPath}`);

        firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
            console.log(`Firestore listener: Prijatý snapshot pre ${docPath}. Metadata:`, docSnap.metadata);
            const isLocalWrite = docSnap.metadata.hasPendingWrites;

            if (isLocalWrite) {
                 console.log("Listener: Detekovaná lokálna zmena (pending write). Preskakujem aktualizáciu UI z listenera.");
                 // Aktualizujeme lokálny stav z pending write pre konzistenciu
                 if (docSnap.exists) {
                     const data = docSnap.data(); const firebaseDaysData = data.days || [];
                     if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                     monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                         start: day.start || '', end: day.end || '', breakTime: day.breakTime || '', note: day.note || ''
                     }));
                     // Ukladáme aj nastavenia z pending write
                     hourlyWage = data.hourlyWage ?? hourlyWage;
                     taxRate = (data.taxRate ?? (taxRate * 100)) / 100;
                     decimalPlaces = data.decimalPlaces ?? decimalPlaces;
                     employeeName = data.employeeName ?? employeeName;
                     const fbDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');

                     localStorage.setItem('workDaysData', JSON.stringify(monthData));
                     localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                     localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                     localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                     localStorage.setItem('employeeName', JSON.stringify(employeeName));
                     localStorage.setItem('darkMode', JSON.stringify(fbDarkMode));
                     console.log("Listener (pending write): Dáta z lokálnej zmeny uložené do monthData a localStorage.");
                     updateDataSize();
                 }
                 return;
            }

            if (docSnap.exists) {
                // ----- DOKUMENT EXISTUJE -----
                const data = docSnap.data();
                console.log(`Listener: Dokument existuje (server/cache), načítané dáta:`, data);
                try {
                    // Načítanie nastavení z Firebase
                    const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
                    const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
                    const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
                    const firebaseEmployeeName = data.employeeName ?? employeeName;
                    const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');
                    const firebaseDaysData = data.days || [];

                    // Aktualizácia globálnych premenných
                    hourlyWage = firebaseHourlyWage;
                    taxRate = firebaseTaxRatePercent / 100;
                    decimalPlaces = firebaseDecimalPlaces;
                    employeeName = firebaseEmployeeName;

                    // Aktualizácia inputov (len ak nemajú fokus)
                    if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
                    if (document.activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
                    if (document.activeElement !== decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces;
                    if (document.activeElement !== employeeNameInput) employeeNameInput.value = employeeName;

                    // Aktualizácia monthData pre dni
                    if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                        start: day.start || '', end: day.end || '', breakTime: day.breakTime || '', note: day.note || ''
                    }));
                    console.log(`Listener: monthData pre ${currentYear}-${currentMonth} aktualizované z Firebase. Počet dní: ${monthData[currentYear][currentMonth].length}`);

                    // Uloženie načítaných dát do localStorage
                    localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                    localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                    localStorage.setItem('darkMode', JSON.stringify(firebaseDarkMode));
                    localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                    localStorage.setItem('employeeName', JSON.stringify(employeeName));
                    localStorage.setItem('workDaysData', JSON.stringify(monthData));
                    console.log("Listener: Dáta z Firebase uložené do localStorage.");

                    // Cielená aktualizácia UI
                    console.log("Listener: Vykonávam cielenú aktualizáciu UI...");
                    const daysInMonth = getDaysInMonth(currentMonth);
                    const activeElementId = document.activeElement?.id;
                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayData = monthData[currentYear]?.[currentMonth]?.[i - 1];
                        const startId = `start-${currentYear}-${currentMonth}-${i}`;
                        const endId = `end-${currentYear}-${currentMonth}-${i}`;
                        const breakId = `break-${currentYear}-${currentMonth}-${i}`;
                        const noteId = `note-${currentYear}-${currentMonth}-${i}`;
                        const startEl = document.getElementById(startId), endEl = document.getElementById(endId), breakEl = document.getElementById(breakId), noteEl = document.getElementById(noteId);
                        if (startEl && endEl && breakEl && noteEl) {
                            const newStart = dayData?.start || '', newEnd = dayData?.end || '', newBreak = dayData?.breakTime || '', newNote = dayData?.note || '';
                            if (startEl.value !== newStart && activeElementId !== startId) startEl.value = newStart;
                            if (endEl.value !== newEnd && activeElementId !== endId) endEl.value = newEnd;
                            if (breakEl.value !== newBreak && activeElementId !== breakId) breakEl.value = newBreak;
                            if (noteEl.value !== newNote && activeElementId !== noteId) noteEl.value = newNote;
                            calculateRow(i);
                        }
                    }
                    calculateTotal();
                    applyDarkMode(firebaseDarkMode);
                    updateWelcomeMessage();
                    updateDataSize();
                    console.log("Listener: Cielená aktualizácia UI dokončená.");
                    if (!docSnap.metadata.fromCache) { console.log("Listener: Dáta prijaté priamo zo SERVERA."); showSaveNotification("Dáta synchronizované"); }

                } catch (processError) {
                    console.error(`Listener: Chyba pri spracovaní dát z Firestore pre ${currentYear}-${currentMonth}:`, processError);
                    showSaveNotification("Chyba: Nesprávny formát dát z Firebase", "error");
                    loadFromLocalStorage(); // Fallback na lokálne dáta
                }
            } else {
                // ----- DOKUMENT NEEXISTUJE -----
                console.log(`Listener: Dokument neexistuje na Firebase pre ${currentYear}-${currentMonth}.`);
                const localDataForMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]);
                if (localDataForMonth && localDataForMonth.some(day => day.start || day.end || day.breakTime || day.note)) { // Kontrola, či lokálne dáta nie sú len prázdne pole
                    console.log(`Listener: Lokálne dáta pre ${currentYear}-${currentMonth} existujú. Nahrávam ich do Firebase...`);
                    saveToFirebase(); // Pokus o nahratie lokálnych dát
                } else {
                    console.log(`Listener: Pre ${currentYear}-${currentMonth} neexistujú dáta ani lokálne, ani vo Firebase.`);
                    // V tomto prípade nerobíme nič s lokálnymi dátami, UI už bolo vykreslené z lokálneho (pravdepodobne prázdneho) stavu
                }
            }
        }, (error) => {
            console.error(`Firestore listener chyba pre ${docPath}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa pripojiť k Firebase", "error");
            console.log("Listener chyba, spolieham sa na localStorage...");
            loadFromLocalStorage(); // Fallback pri chybe
        });
    }


    // 8. Funkcia na ukladanie do Firebase - Nezmenené (volá sa len ak je prihlásený)
    async function saveToFirebase() {
        // Kontrola je teraz v saveToLocalStorage, ale pre istotu aj tu
        if (!isLoggedIn || !auth.currentUser) { console.log("saveToFirebase: Preskočené, používateľ nie je prihlásený."); return; }
        const uid = auth.currentUser.uid;
        try {
            const currentMonthWorkData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            console.log(`saveToFirebase: Ukladám ${currentMonthWorkData.length} záznamov pre ${currentYear}-${currentMonth}.`);
            const dataToSave = {
                days: currentMonthWorkData,
                hourlyWage: hourlyWage || 10,
                taxRate: (taxRate * 100) || 2,
                decimalPlaces: decimalPlaces || 1,
                employeeName: employeeName || '',
                darkMode: document.body.classList.contains('dark-mode'),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            const yearMonthDoc = `${currentYear}-${currentMonth}`;
            const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);
            await docRef.set(dataToSave, { merge: true }); // Použijeme merge pre prípad, že by iné pole bolo pridané inde
            console.log(`saveToFirebase: Požiadavka na uloženie dát pre ${yearMonthDoc} odoslaná/zaradená.`);
        } catch (error) {
            console.error(`Chyba pri požiadavke na ukladanie do Firebase pre ${currentYear}-${currentMonth}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa odoslať dáta do Firebase", "error");
        }
    }

    // 9. Funkcia na ukladanie do Local Storage - **UPRAVENÉ** s kontrolou prihlásenia pred Firebase volaním
    function saveToLocalStorage() {
        try {
            // Inicializácia štruktúry monthData, ak neexistuje
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) {
                monthData[currentYear][currentMonth] = [];
                console.warn(`saveToLocalStorage: Inicializované prázdne pole pre ${currentYear}-${currentMonth}, lebo chýbalo.`);
            }

            // Uloženie nastavení
            localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
            localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
            localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
            localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
            localStorage.setItem('employeeName', JSON.stringify(employeeName));
            localStorage.setItem('currentMonth', currentMonth.toString());
            localStorage.setItem('currentYear', currentYear.toString());

            // Uloženie dát dní (monthData)
            const serializedMonthData = JSON.stringify(monthData);
            const bytes = new Blob([serializedMonthData]).size;
            if (bytes > MAX_DATA_SIZE * 0.9) { console.warn(`Veľkosť dát ('workDaysData') v localStorage (${(bytes/1024).toFixed(1)} KB) sa blíži k limitu ${MAX_DATA_SIZE_KB} KB`); }
            if (bytes > MAX_DATA_SIZE) {
                alert(`Prekročili ste maximálnu veľkosť dát (~${MAX_DATA_SIZE_KB} KB) pre dáta mesiacov v localStorage. Ukladanie zlyhalo.`);
                showSaveNotification("Chyba: Lokálne dáta sú príliš veľké!", "error");
                return;
            }
            localStorage.setItem('workDaysData', serializedMonthData);

            updateDataSize(); // Aktualizuj zobrazenie veľkosti

            // *** Kľúčová kontrola: Uloží do Firebase len ak je používateľ prihlásený ***
            if (isLoggedIn && auth.currentUser) {
                 saveToFirebase();
            }

            // Notifikácia pre offline režim
            if (!navigator.onLine) {
                 showSaveNotification("Offline: Zmeny uložené lokálne" + (isLoggedIn ? ", synchronizujú sa po pripojení" : ""), "warning");
            }

        } catch (error) {
            console.error('Chyba pri ukladaní (lokálne/spustení Firebase save):', error);
            showSaveNotification("Kritická chyba pri ukladaní!", "error");
        }
    }

    // 10. Funkcia na načítanie z Local Storage - Nezmenené (volá updateUIFromLoadedData)
    function loadFromLocalStorage() {
        try {
             // Nastavenie currentMonth a currentYear, ak ešte nie sú
             if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                 const storedMonth = localStorage.getItem('currentMonth');
                 const storedYear = localStorage.getItem('currentYear');
                 const currentDate = new Date();
                 currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                 currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
                 console.log(`loadFromLocalStorage: Inicializujem mesiac=${getMonthName(currentMonth)}, rok=${currentYear}`);
             }
             console.log(`loadFromLocalStorage: Načítavam lokálne dáta pre ${getMonthName(currentMonth)} ${currentYear}`);

             // Načítanie dát dní
             const storedMonthData = localStorage.getItem('workDaysData');
             try {
                 monthData = storedMonthData ? JSON.parse(storedMonthData) : {};
             } catch(e) {
                  console.error("Chyba pri parsovaní monthData z localStorage:", e);
                  monthData = {}; // Reset na prázdny objekt pri chybe
                  localStorage.removeItem('workDaysData'); // Odstránime poškodené dáta
             }


             // Inicializácia štruktúry pre aktuálny rok/mesiac, ak chýba
             if (!monthData) monthData = {};
             if (!monthData[currentYear]) monthData[currentYear] = {};
             if (!monthData[currentYear][currentMonth]) {
                 monthData[currentYear][currentMonth] = [];
                 console.log(`loadFromLocalStorage: Pre ${currentYear}-${currentMonth} vytvorené prázdne pole v monthData.`);
             } else {
                 console.log(`loadFromLocalStorage: Načítaných ${monthData[currentYear][currentMonth].length} záznamov dní z localStorage.`);
             }

             // Načítanie nastavení (už by mali byť načítané v onAuthStateChanged, ale pre istotu)
             hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
             taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
             const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
             decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
             employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

             // Aktualizácia UI na základe načítaných dát
             updateUIFromLoadedData(darkMode);

        } catch (error) {
             console.error(`Kritická chyba pri načítavaní/spracovaní dát z localStorage pre ${getMonthName(currentMonth)} ${currentYear}:`, error);
             showSaveNotification("Chyba pri načítaní lokálnych dát!", "error");
             // Reset na bezpečný stav v prípade chyby
             monthData = {}; hourlyWage = 10; taxRate = 0.02; decimalPlaces = 1; employeeName = ''; applyDarkMode(false);
             createTable(); calculateTotal(); updateDataSize();
        }
    }

    // 11. Funkcia na aktualizáciu UI - Nezmenené (pracuje s globálnymi premennými)
    function updateUIFromLoadedData(darkModeValue) {
        console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(currentMonth)} ${currentYear}`);
        try {
            // Aktualizácia inputov nastavení (len ak nemajú focus)
            if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
            if (document.activeElement !== taxRateInput) taxRateInput.value = taxRate * 100;
            if (document.activeElement !== decimalPlacesSelect) decimalPlacesSelect.value = decimalPlaces;
            if (document.activeElement !== employeeNameInput) employeeNameInput.value = employeeName;

            // Aktualizácia selectov mesiaca a roka (len ak sa líšia)
            if (monthSelect.value != currentMonth) monthSelect.value = currentMonth;
            if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                 if (yearSelect.value != currentYear) yearSelect.value = currentYear;
            } else {
                 console.warn(`Rok ${currentYear} nenájdený v selecte pri updateUI.`);
                 yearSelect.value = new Date().getFullYear(); currentYear = parseInt(yearSelect.value);
            }

            // Vytvorenie štruktúry tabuľky
            createTable();

            // Naplnenie tabuľky dátami dní
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            console.log(`updateUIFromLoadedData: Počet záznamov v monthData pre plnenie UI: ${dataForCurrentMonth.length}`);
            dataForCurrentMonth.forEach((day, index) => {
                const i = index + 1;
                const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);

                if (startElement && endElement && breakElement && noteElement) {
                    startElement.value = day.start || '';
                    endElement.value = day.end || '';
                    breakElement.value = day.breakTime || '';
                    noteElement.value = day.note || '';
                    calculateRow(i);
                } else {
                    console.error(`Kritická chyba: Elementy pre deň ${i} v updateUIFromLoadedData neboli nájdené po createTable!`);
                }
            });

            calculateTotal();
            updateDataSize();
            applyDarkMode(darkModeValue);
            updateWelcomeMessage();
            console.log("UI aktualizované.");
        } catch (error) {
            console.error("Chyba počas aktualizácie UI:", error);
            showSaveNotification("Chyba pri prekresľovaní UI!", "error");
        }
    }

    // 12. Funkcia pre aplikovanie Dark Mode - Upravená pre login/logout tlačidlo
    function applyDarkMode(isDark) {
        const elementsToToggle = [
            document.body,
            document.querySelector('.container'),
            totalSalaryDiv,
            document.querySelector('.collapsible-settings summary'),
            authContainer, // Pridaný auth container
            logoutBtn, // Pridané login/logout tlačidlo
            document.getElementById('close-auth-btn'), // Pridané tlačidlo zatvorenia auth
            ...document.querySelectorAll('table, th, td'),
            ...document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"], select'),
            ...document.querySelectorAll('.btn:not(#logout-btn)'), // Ostatné tlačidlá
            ...document.querySelectorAll('.toggle-note-btn'),
            ...document.querySelectorAll('.note-textarea')
        ];

        elementsToToggle.forEach(el => {
            if (el) {
                if (isDark) el.classList.add('dark-mode');
                else el.classList.remove('dark-mode');
            }
        });

        // Aplikuj špeciálne na aktuálny deň
        const currentDayRow = document.querySelector('.current-day');
        if (currentDayRow) {
            if (isDark) {
                 currentDayRow.classList.add('dark-mode');
                 currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn').forEach(el => el?.classList.add('dark-mode'));
            } else {
                currentDayRow.classList.remove('dark-mode');
                currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn').forEach(el => el?.classList.remove('dark-mode'));
            }
        }
    }


    // 13) Vytváranie tabuľky a súvisiace funkcie - Nezmenené
    function getDayName(year, month, day) { const daysOfWeek = ["Nedeľa", "Pondelok", "Utorok", "Streda", "Štvrtok", "Piatok", "Sobota"]; return daysOfWeek[new Date(year, month, day).getDay()]; }
    function createTable() {
        workDays.innerHTML = '';
        const tableHead = document.querySelector('table thead tr');
        if (tableHead && !tableHead.querySelector('.th-note')) {
            const noteTh = document.createElement('th');
            noteTh.textContent = 'Poznámka';
            noteTh.classList.add('th-note');
            const lastTh = tableHead.lastElementChild;
            tableHead.insertBefore(noteTh, lastTh);
        }

        const daysInMonth = getDaysInMonth(currentMonth);
        const today = new Date();
        const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth();
        const currentYearValue = today.getFullYear();

        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
                row.classList.add('current-day');
            }
            const dayName = getDayName(currentYear, currentMonth, i);
            const baseId = `${currentYear}-${currentMonth}-${i}`;
            const startId = `start-${baseId}`, endId = `end-${baseId}`, breakId = `break-${baseId}`;
            const totalId = `total-${baseId}`, grossId = `gross-${baseId}`, netId = `net-${baseId}`;
            const noteToggleId = `note-toggle-${baseId}`, noteContainerId = `note-container-${baseId}`, noteTextareaId = `note-${baseId}`;

            row.innerHTML = `
                <td>Deň ${i} (${dayName})</td>
                <td><input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}', ${i})"></td>
                <td><input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}', ${i})"></td>
                <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="prestávka" oninput="handleBreakInput(${i})"></td>
                <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces || 1)} h)</td>
                <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="Hrubá Mzda" readonly></td>
                <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="Čistá Mzda" readonly></td>
                <td>
                    <button id="${noteToggleId}" class="toggle-note-btn" onclick="toggleNote(${i})">Poznámka</button>
                    <div id="${noteContainerId}" class="note-container">
                        <textarea id="${noteTextareaId}" class="note-textarea" placeholder="Zadajte poznámku..." oninput="handleNoteInput(this, ${i})"></textarea>
                    </div>
                </td>
                <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulovať</button></td>
            `;
            workDays.appendChild(row);
        }
        applyDarkMode(document.body.classList.contains('dark-mode')); // Aplikuje dark mode na novovytvorené elementy
    }
    function toggleNote(day) {
        const containerId = `note-container-${currentYear}-${currentMonth}-${day}`;
        const buttonId = `note-toggle-${currentYear}-${currentMonth}-${day}`;
        const noteContainer = document.getElementById(containerId);
        const toggleButton = document.getElementById(buttonId);
        if (noteContainer && toggleButton) {
            const isVisible = noteContainer.classList.toggle('visible');
            toggleButton.textContent = isVisible ? 'Skryť' : 'Poznámka';
            if (document.body.classList.contains('dark-mode')) {
                 const textarea = noteContainer.querySelector('textarea');
                 if(textarea) textarea.classList.toggle('dark-mode', isVisible);
                 toggleButton.classList.toggle('dark-mode', isVisible);
            }
        } else { console.warn(`toggleNote: Elementy pre poznámku dňa ${day} neboli nájdené.`); }
    }
    function handleNoteInput(textarea, day) { updateMonthDataFromInput(textarea, day); debouncedProcessInputCompletion(textarea.id, null); }
    function processInputCompletion(inputId, nextId) { console.log(`processInputCompletion: Spustené pre ${inputId}, ďalší: ${nextId}`); const inputElement = document.getElementById(inputId); if (!inputElement && !(inputId === 'reset-all' || inputId.startsWith('reset-') || inputId === 'settings-change' || inputId === 'restore-backup' || inputId.startsWith('note-')) ) { console.warn(`processInputCompletion: Element ${inputId} nenájdený.`); return; } calculateTotal(); saveToLocalStorage(); if (inputElement?.type === 'tel') { if (inputElement.value.length === 5 && isTimeValid(inputElement.value)) { moveNext(inputElement, nextId); } } else if (inputElement?.type === 'number' && inputId.startsWith('break-')) { moveNext(inputElement, nextId); } }
    const debouncedProcessInputCompletion = debounce(processInputCompletion, 700); // Trochu dlhší debounce
    function isTimeValid(timeStr) { const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeStr); }
    function handleInput(input, nextId, day) { formatInput(input); updateMonthDataFromInput(input, day); calculateRow(day); debouncedProcessInputCompletion(input.id, nextId); }
    function handleBreakInput(day) { const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); updateMonthDataFromInput(input, day); calculateRow(day); const nextDay = day + 1; let nextInputElementId = null; if (nextDay <= getDaysInMonth(currentMonth)) { nextInputElementId = `start-${currentYear}-${currentMonth}-${nextDay}`; } debouncedProcessInputCompletion(input.id, nextInputElementId); }
    function updateMonthDataFromInput(input, day) {
        if (!input) return;
        const dayIndex = day - 1;
        const fieldId = input.id;
        let field = 'unknown';
        if (fieldId.startsWith('start-')) field = 'start';
        else if (fieldId.startsWith('end-')) field = 'end';
        else if (fieldId.startsWith('break-')) field = 'breakTime';
        else if (fieldId.startsWith('note-')) field = 'note';
        const value = input.value;
        if (field !== 'unknown') {
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
            while (monthData[currentYear][currentMonth].length <= dayIndex) {
                monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '' });
            }
            if (!monthData[currentYear][currentMonth][dayIndex]) {
                 console.error(`updateMonthDataFromInput: Chýba záznam pre deň ${dayIndex}. Vytváram.`);
                 monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '' };
            }
            monthData[currentYear][currentMonth][dayIndex][field] = value;
        } else { console.warn("updateMonthDataFromInput: Nerozpoznané pole pre input ID:", fieldId); }
    }
    function formatInput(input) { if (!input || input.type !== 'tel') return; let value = input.value.replace(/[^\d:]/g, ''); if (value.length === 4 && !value.includes(':')) { value = value.slice(0, 2) + ':' + value.slice(2); } else if (value.length === 3 && value.charAt(2) !== ':' && parseInt(value.slice(0, 2)) <= 23) { value = value.slice(0, 2) + ':' + value.slice(2); } if (value.length > 5) { value = value.slice(0, 5); } input.value = value; if (value.length > 0 && value.length < 5) { input.style.border = ''; } else if (value.length === 5) { if (isTimeValid(value)) { input.style.border = ''; } else { input.style.border = '1px solid red'; setTimeout(() => { input.style.border = ''; }, 2000); } } else { input.style.border = ''; } }
    function moveNext(currentElement, nextId) { if (!nextId || !currentElement) return; const nextElement = document.getElementById(nextId); if (nextElement) { if (document.activeElement === currentElement) { nextElement.focus(); if (nextElement.select) nextElement.select(); } } else { console.warn(`moveNext: Element s ID ${nextId} nebol nájdený.`); } }
    function calculateRow(day) {
        const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value;
        const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value;
        const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const breakTime = parseFloat(breakTimeInput?.value) || 0;
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
        if (!totalCell || !grossElement || !netElement) { return; }
        if (!startTimeStr || !endTimeStr || !isTimeValid(startTimeStr) || !isTimeValid(endTimeStr)) {
            totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
            grossElement.value = '0.00'; netElement.value = '0.00';
            if ((startTimeStr && !isTimeValid(startTimeStr)) || (endTimeStr && !isTimeValid(endTimeStr))) {
                 totalCell.textContent = 'Neplatný čas';
            }
            return;
        }
        const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
        const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
        const startTotalMinutes = startHours * 60 + startMinutes;
        let endTotalMinutes = endHours * 60 + endMinutes;
        if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; } // Prechod cez polnoc
        const diffMinutes = endTotalMinutes - startTotalMinutes;
        const breakMinutes = breakTime * 60;
        const workedMinutes = Math.max(0, diffMinutes - breakMinutes);
        const hours = Math.floor(workedMinutes / 60);
        const minutes = Math.round(workedMinutes % 60);
        const decimalHours = (workedMinutes / 60);
        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces || 1)} h)`;
        const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate;
        const grossSalary = decimalHours * currentHourlyWage;
        grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00';
        const netSalary = grossSalary * (1 - currentTaxRate);
        netElement.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00';
    }
    function resetRow(day) {
        const dayIndex = day - 1;
        const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const total = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const net = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
        const note = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`);
        const noteContainer = document.getElementById(`note-container-${currentYear}-${currentMonth}-${day}`);
        const noteToggle = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${day}`);

        if (start && end && breakTime && total && gross && net && note && noteContainer && noteToggle) {
            start.value = ''; end.value = ''; breakTime.value = ''; note.value = '';
            total.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
            gross.value = '0.00'; net.value = '0.00';
            noteContainer.classList.remove('visible'); noteToggle.textContent = 'Poznámka';

            if (!monthData?.[currentYear]?.[currentMonth]) {
                 console.error(`resetRow: Chýba pole pre mesiac ${currentMonth} v roku ${currentYear}`);
                 monthData[currentYear][currentMonth] = []; // Inicializuj pole
            }
            while (monthData[currentYear][currentMonth].length <= dayIndex) {
                 monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '' });
            }
            if (monthData[currentYear][currentMonth][dayIndex]) {
                monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '' };
            }
            debouncedProcessInputCompletion(`reset-${day}`, null);
        } else { console.warn(`resetRow: Niektoré elementy pre deň ${day} neboli nájdené.`); }
    }
    function resetAll() { if (confirm('Naozaj chcete resetovať všetky záznamy pre tento mesiac?')) { if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = []; createTable(); calculateTotal(); debouncedProcessInputCompletion(`reset-all`, null); showSaveNotification("Dáta pre aktuálny mesiac boli resetované."); } }

    // 14) Výpočet celkových súčtov - Nezmenené
    function calculateTotal() { let grandTotalWorkedMinutes = 0; let daysWithEntries = 0; const rows = workDays.querySelectorAll('tr'); const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate; const currentDecimalPlaces = decimalPlaces || 1; rows.forEach((row, index) => { const dayIndex = index + 1; const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`)?.value; const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`)?.value; const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`); if (startTimeStr && endTimeStr && isTimeValid(startTimeStr) && isTimeValid(endTimeStr)) { const breakTime = parseFloat(breakTimeInput?.value) || 0; const [startHours, startMinutes] = startTimeStr.split(':').map(Number); const [endHours, endMinutes] = endTimeStr.split(':').map(Number); const startTotalMinutes = startHours * 60 + startMinutes; let endTotalMinutes = endHours * 60 + endMinutes; if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; } const diffMinutes = endTotalMinutes - startTotalMinutes; const breakMinutes = breakTime * 60; const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes); grandTotalWorkedMinutes += workedMinutesForRow; if (workedMinutesForRow > 0 || (startTimeStr && endTimeStr)) { daysWithEntries++; } } }); const grandTotalDecimalHours = grandTotalWorkedMinutes / 60; const grandTotalGrossSalary = grandTotalDecimalHours * currentHourlyWage; const grandTotalNetSalary = grandTotalGrossSalary * (1 - currentTaxRate); const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0; const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0; const averageHours = Math.floor(averageWorkedMinutes / 60); const averageMinutes = Math.round(averageWorkedMinutes % 60); const averageDecimalHours = (averageWorkedMinutes / 60); const totalHours = Math.floor(grandTotalWorkedMinutes / 60); const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60); totalSalaryDiv.innerHTML = `Počet odpracovaných dní: ${daysWithEntries}<br>Celkový odpracovaný čas: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(currentDecimalPlaces)} h)<br>Celková hrubá mzda: ${grandTotalGrossSalary.toFixed(2)}€<br>Celková čistá mzda: ${grandTotalNetSalary.toFixed(2)}€<br>Priemerná čistá mzda na deň: ${averageNetSalary.toFixed(2)}€<br><strong>Priemerný odpracovaný čas na deň: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(currentDecimalPlaces)} h)</strong>`; }

    // 15) Export do PDF (exportToPDF, sendPDF) - Nezmenené (už obsahujú poznámky)
    function exportToPDF() { /* ... kód exportToPDF zostáva rovnaký ... */ }
    function sendPDF() { /* ... kód sendPDF zostáva rovnaký ... */ }

    // 16) Ostatné nastavenia - Upravené (obsahujú logiku z predchádzajúcej verzie)
    function changeDecimalPlaces() { const newDecimalPlaces = parseInt(decimalPlacesSelect.value); if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) { decimalPlaces = newDecimalPlaces; calculateTotal(); debouncedProcessInputCompletion('settings-change', null); } }
    function updateEmployeeName() { employeeName = employeeNameInput.value; updateWelcomeMessage(); debouncedProcessInputCompletion('settings-change', null); }
    function updateSettings() {
        const newHourlyWageStr = hourlyWageInput.value; const newTaxRateStr = taxRateInput.value;
        const newHourlyWage = parseFloat(newHourlyWageStr); const newTaxRatePercent = parseFloat(newTaxRateStr);
        let changed = false;
        if (!isNaN(newHourlyWage) && newHourlyWage >= 0 && hourlyWage !== newHourlyWage) { hourlyWage = newHourlyWage; changed = true; }
        if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) { const newTaxRateDecimal = newTaxRatePercent / 100; if (taxRate !== newTaxRateDecimal) { taxRate = newTaxRateDecimal; changed = true; } }
        if (changed) {
            const rows = workDays.querySelectorAll('tr'); rows.forEach((row, index) => calculateRow(index + 1));
            calculateTotal(); debouncedProcessInputCompletion('settings-change', null);
        }
    }
    function changeMonth() { const selectedMonth = parseInt(monthSelect.value); if (currentMonth !== selectedMonth) { currentMonth = selectedMonth; console.log(`Zmenený mesiac na: ${getMonthName(currentMonth)}`); handleMonthYearChange(); } }
    function changeYear() { const selectedYear = parseInt(yearSelect.value); if (currentYear !== selectedYear) { currentYear = selectedYear; console.log(`Zmenený rok na: ${currentYear}`); handleMonthYearChange(); } }
    function handleMonthYearChange() {
        console.log(`handleMonthYearChange: Spustené pre ${getMonthName(currentMonth)} ${currentYear}`);
        localStorage.setItem('currentMonth', currentMonth.toString());
        localStorage.setItem('currentYear', currentYear.toString());
        loadFromLocalStorage(); // Vždy načíta lokálne dáta pre nový mesiac/rok
        if (isLoggedIn && auth.currentUser) { // Nastaví listener len ak je prihlásený
            setupFirestoreListener(); // Táto funkcia už obsahuje odhlásenie starého listenera
        } else {
            console.log("handleMonthYearChange: Používateľ nie je prihlásený, listener pre Firebase sa nenastavuje.");
            // Uistíme sa, že listener je odhlásený
            if (firestoreListenerUnsubscribe) {
                firestoreListenerUnsubscribe();
                firestoreListenerUnsubscribe = null;
                console.log("handleMonthYearChange (neprihlásený): Predchádzajúci listener odhlásený.");
            }
        }
    }
    function getDaysInMonth(month) { if (month === undefined || month === null || currentYear === undefined || currentYear === null) { console.warn("getDaysInMonth: Chýba mesiac alebo rok, vraciam 31."); return 31; } return new Date(currentYear, month + 1, 0).getDate(); }
    function getMonthName(month) { const monthNames = ["Január", "Február", "Marec", "Apríl", "Máj", "Jún", "Júl", "August", "September", "Október", "November", "December"]; return monthNames[month] || 'Neznámy'; }
    function updateDataSize() { try { const totalData = Object.values(localStorage).reduce((acc, value) => acc + (value ? value.length : 0), 0); const kilobytes = (totalData / 1024).toFixed(2); const percentageUsed = Math.min(((totalData / MAX_DATA_SIZE) * 100), 100); dataSizeText.textContent = `Lokálne úložisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`; dataSizeFill.style.width = `${percentageUsed}%`; dataSizeFill.style.backgroundColor = percentageUsed > 90 ? '#f44336' : percentageUsed > 70 ? '#ff9800' : '#4CAF50'; } catch (error) { console.error("Chyba pri výpočte veľkosti localStorage:", error); dataSizeText.textContent = "Chyba pri výpočte veľkosti dát."; } }
    function toggleDarkMode() { const isDarkMode = document.body.classList.toggle('dark-mode'); applyDarkMode(isDarkMode); localStorage.setItem('darkMode', JSON.stringify(isDarkMode)); if (isLoggedIn && auth.currentUser) { saveToFirebase(); } } // Uloží zmenu dark mode do Firebase

    // 17) Zálohovanie a obnova - Upravené s kontrolou prihlásenia
    function createBackup() { /* ... kód createBackup zostáva rovnaký ... */ }
    function restoreBackup() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file'; fileInput.accept = '.json,application/json';
        fileInput.onchange = (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup && typeof backup.workDaysData === 'string' /*... a ďalšie kontroly ...*/) {
                        localStorage.setItem('workDaysData', backup.workDaysData);
                        localStorage.setItem('hourlyWage', backup.hourlyWage);
                        localStorage.setItem('taxRate', backup.taxRate);
                        localStorage.setItem('darkMode', backup.darkMode);
                        localStorage.setItem('decimalPlaces', backup.decimalPlaces);
                        localStorage.setItem('employeeName', backup.employeeName);
                        loadFromLocalStorage(); // Načíta a prekreslí UI
                        showSaveNotification("Záloha úspešne obnovená.");
                        alert("Záloha bola úspešne obnovená. Dáta boli načítané.");
                        // *** Kľúčová kontrola: Uloží do Firebase len ak je prihlásený ***
                        if (isLoggedIn && auth.currentUser) {
                             console.log("Obnova zálohy: Ukladám obnovené dáta pre aktuálny mesiac do Firebase...");
                             debouncedProcessInputCompletion('restore-backup', null); // Spustí uloženie
                        } else {
                             console.log("Obnova zálohy: Používateľ nie je prihlásený, dáta obnovené len lokálne.");
                        }
                    } else { alert("Chyba: Súbor zálohy má nesprávny formát alebo chýbajú dáta."); }
                } catch (error) { console.error("Chyba pri spracovaní zálohy:", error); alert("Chyba pri čítaní zálohy."); }
            };
            reader.onerror = (e) => { console.error("Chyba pri čítaní súboru:", e); alert("Nastala chyba pri čítaní súboru."); };
            reader.readAsText(file);
        };
        fileInput.click();
    }


    // 18) Inicializácia - Upravená
     document.addEventListener('DOMContentLoaded', () => {
         console.log("DOM načítaný, inicializujem...");
         populateYearSelect(); // Vždy naplníme roky

         // Service Worker registrácia zostáva
         if ('serviceWorker' in navigator) {
             window.addEventListener('load', () => {
                 navigator.serviceWorker.register('./service-worker.js')
                     .then(registration => { console.log('ServiceWorker zaregistrovaný s rozsahom: ', registration.scope); })
                     .catch(error => { console.error('Registrácia ServiceWorker zlyhala: ', error); });
             });
         } else { console.warn("Service Worker nie je podporovaný v tomto prehliadači."); }

         // Ostatná inicializácia (dark mode, načítanie dát, zobrazenie UI)
         // sa teraz riadi primárne cez onAuthStateChanged, ktorý sa spustí automaticky.
         console.log("Základná inicializácia dokončená, čakám na stav prihlásenia Firebase...");
     });
     function populateYearSelect() { const startYear = 2020; const endYear = new Date().getFullYear() + 2; yearSelect.innerHTML = ''; for (let year = startYear; year <= endYear; year++) { const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); } }

  </script>
</body>
</html>
