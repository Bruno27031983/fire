<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    /* CSS ≈°t√Ωly zost√°vaj√∫ rovnak√© ako v prvom k√≥de */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start; /* Zmenen√© na flex-start pre lep≈°ie zarovnanie s details */
        gap: 10px; /* Pridan√Ω gap pre medzery */
    }
    /* Priame deti .settings (div, details, button) */
    .settings > div,
    .settings > details,
    .settings > button {
        flex: 1 1 200px; /* Zachovanie flex basis */
        margin: 0; /* Odstr√°nen√Ω margin, pou≈æ√≠vame gap */
    }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 950px; /* Mierne zv√§ƒç≈°en√° min-width kv√¥li ikon√°m */ }
    th, td {
        padding: 8px;
        border: 1px solid #ddd;
        text-align: left;
        font-size: 0.9em;
        vertical-align: top; /* Zarovnaj obsah buniek hore */
        position: relative; /* Pozicovanie pre ikony */
    }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea /* Pridan√Ω select a .note-textarea */ {
        width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px;
    }
    /* √öprava paddingu pre tel inputy kv√¥li ikone */
    input[type="tel"] {
        padding-right: 28px; /* Priestor pre ikonu */
    }
    /* ≈†t√Ωly pre ikonu hod√≠n */
    .time-icon {
        position: absolute;
        right: 8px; /* Odsadenie od prav√©ho okraja bunky */
        top: 50%;
        transform: translateY(-50%); /* Vertik√°lne centrovanie */
        cursor: pointer;
        font-size: 1.2em; /* Veƒækos≈• ikony */
        color: #555; /* Farba ikony */
        user-select: none; /* Zabr√°ni oznaƒçeniu textu ikony */
        z-index: 2; /* Aby bola nad inputom, ak by sa prekr√Ωvali */
    }
    .time-icon:hover {
        color: #007bff; /* Zmena farby pri prejden√≠ my≈°ou */
        opacity: 0.8;
    }
    body.dark-mode .time-icon {
        color: #bbb; /* Svetlej≈°ia ikona v tmavom re≈æime */
    }
    body.dark-mode .time-icon:hover {
        color: #87cefa; /* Svetlomodr√° pri hover v tmavom re≈æime */
    }

    /* --- ≈†t√Ωly pre ikonu indik√°tora pozn√°mky --- */
      .note-indicator-icon {
        display: none; /* ≈†tandardne skryt√© */
        font-size: 0.9em; /* Trochu men≈°ie */
        margin-right: 4px; /* Medzera pred tlaƒçidlom */
        color: #28a745; /* Zelen√° pre indik√°ciu */
        vertical-align: middle; /* Zarovnanie s textom tlaƒçidla */
        cursor: default; /* Nie je klikateƒæn√° */
      }
      body.dark-mode .note-indicator-icon {
         color: #6fbf7a; /* Svetlej≈°ia zelen√° v tmavom re≈æime */
      }
    /* --- KONIEC ≈°t√Ωlov pre ikonu indik√°tora --- */


    /* Uprav ≈°√≠rky stƒ∫pcov podƒæa potreby */
    th:nth-child(1), td:nth-child(1) { min-width: 50px; } /* De≈à */
    th:nth-child(2), td:nth-child(2) { min-width: 90px; } /* Pr√≠chod */
    th:nth-child(3), td:nth-child(3) { min-width: 90px; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* Prest√°vka */
    th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* Odpracovan√© */
    th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* Hrub√° Mzda */
    th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* ƒåist√° Mzda */
    th:nth-child(8), td:nth-child(8) { min-width: 130px; } /* Pozn√°mka - mierne ≈°ir≈°√≠ kv√¥li ikone */
    th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia */

    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    /* --- Farby tlaƒçidiel pre z√°lohu/obnovu --- */
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #9C27B0; } .backup-btn:hover { background-color: #7B1FA2; }
    /* --- Koniec farieb --- */
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2; color: white; }
    .current-day input, .current-day .note-textarea { background-color: #9932cc; color: white; }
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    .container.dark-mode { background-color: #444; color: #f4f4f4; }
    table.dark-mode { background-color: #555; color: #f4f4f4; }
    th.dark-mode { background-color: #666; }
    td.dark-mode { background-color: #444; color: #f4f4f4; }
    input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode {
        background-color: #666; color: white; border-color: #888;
    }
    .btn.dark-mode { color: #333; }
    .reset-btn.dark-mode { background-color: #d32f2f; }
    .export-btn.dark-mode { background-color: #388e3c; }
    .restore-btn.dark-mode { background-color: #7B1FA2; }
    .backup-btn.dark-mode { background-color: #7B1FA2; }
    #totalSalary.dark-mode { background-color: #2c3e50; }
    .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
    .current-day.dark-mode input, .current-day.dark-mode .note-textarea { background-color: #5c1db3; color: #fff; }
    body.dark-mode .autor-info { color: #aaa; }
    #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
    #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
    #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
    #auth-container button:hover { background-color: #45a049; }
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
    #saveNotification.show { display: block; opacity: 1; }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }

    /* --- ≈†t√Ωly pre zbaliteƒæn√∫ ƒças≈• --- */
    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
    .collapsible-settings summary:hover { background-color: #eee; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
    body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
    body.dark-mode .collapsible-content { border-top-color: #666; }

    /* --- ≈†t√Ωly pre pozn√°mky --- */
    .note-container { display: none; margin-top: 5px; }
    .note-container.visible { display: block; }
    .note-textarea { width: 95%; min-height: 40px; resize: vertical; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; background-color: #f0f0f0; }
    .toggle-note-btn { background-color: #6c757d; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease; margin-bottom: 2px; vertical-align: middle; }
    .toggle-note-btn:hover { background-color: #5a6268; }
    .note-textarea.dark-mode { background-color: #555; color: #f4f4f4; border-color: #777; }
    .toggle-note-btn.dark-mode { background-color: #828a91; }
    .toggle-note-btn.dark-mode:hover { background-color: #70777d; }
    /* --- Koniec ≈°t√Ωlov pre pozn√°mky --- */
  </style>
</head>
<body>
  <div id="loading-container"><h1> Tajomstvo √∫spechu je slu≈°nos≈• a √∫primnos≈•. Akon√°hle sa ich zbav√≠te, dosiahnete v≈°etko. </h1></div>
  <div id="auth-container" style="display:none;">
    <h1>Prihl√°senie / Registr√°cia</h1>
    <div id="auth-message">≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.</div>
    <div id="auth-forms">
      <h2>Registr√°cia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="register()">Registrova≈•</button>
      <h2>Prihl√°senie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="login()">Prihl√°si≈• sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>
  <div id="calculator-container" class="container" style="display:none;">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2>
    <div class="settings">
        <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
                <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
                <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
                <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
                <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
            </select>
        </div>
        <details class="collapsible-settings">
            <summary>ƒéal≈°ie nastavenia</summary>
            <div class="collapsible-content">
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka: </label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
                    <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%): </label>
                    <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="yearSelect">Rok: </label>
                    <select id="yearSelect" onchange="changeYear()"></select>
                </div>
                <div>
                    <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
                    <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>
            </div>
        </details>
        <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th>
            <th>Pr√≠chod</th>
            <th>Odchod</th>
            <th>Prest√°vka</th>
            <th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th>
            <th>ƒåist√° Mzda (‚Ç¨)</th>
            <th class="th-note">Pozn√°mka</th>
            <th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lok√°lne √∫lo≈æisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetova≈• v≈°etko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈•</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu (.xlsx)</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu (.xlsx)</button>
      <button id="logout-btn" class="btn reset-btn" onclick="logout()">Odhl√°si≈• sa</button>
    </div>
  </div>
  <div id="saveNotification"></div>

  <script>
    // 1. Firebase Config & Init - Nezmenen√©
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktiv√°cii Firebase App Check:", error); }
    const db = firebase.firestore(); const auth = firebase.auth();

    // 2. Povolenie Firestore Offline Persistence - Nezmenen√©
    db.enablePersistence().then(() => { console.log("Firestore offline persistence povolen√°."); }).catch((err) => { console.error("Firestore offline persistence chyba:", err.code, err.message, err); if (err.code == 'failed-precondition') { console.warn("Firestore offline persistence: Viacn√°sobn√© otvoren√© taby, povolen√© len v jednom."); } else if (err.code == 'unimplemented') { console.error("Firestore offline persistence: Prehliadaƒç nie je podporovan√Ω."); } });

    // 3. Glob√°lne premenn√© - Nezmenen√©
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
    let monthData = {}; // Hlavn√Ω objekt na ukladanie d√°t v≈°etk√Ωch mesiacov
    let firestoreListenerUnsubscribe = null;
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const MAX_DATA_SIZE = 4 * 1024 * 1024; // 4MB limit pre localStorage
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // 4. Auth funkcie - Nezmenen√©
    function register() { const email = document.getElementById('registerEmail').value; const password = document.getElementById('registerPassword').value; auth.createUserWithEmailAndPassword(email, password).then((userCredential) => { alert("Registr√°cia √∫spe≈°n√°!"); }).catch((error) => { console.error("Chyba pri registr√°cii:", error.message); alert("Chyba pri registr√°cii: " + error.message); }); }
    function login() { const email = document.getElementById('loginEmail').value; const password = document.getElementById('loginPassword').value; auth.signInWithEmailAndPassword(email, password).then((userCredential) => { alert("Prihl√°senie √∫spe≈°n√©!"); }).catch((error) => { console.error("Chyba pri prihl√°sen√≠:", error.message); alert("Chyba pri prihl√°sen√≠: " + error.message); }); }
    function logout() { auth.signOut().then(() => { alert("Odhl√°senie √∫spe≈°n√©!"); }).catch((error) => { console.error("Chyba pri odhl√°sen√≠:", error.message); alert("Chyba pri odhl√°sen√≠: " + error.message); }); }
    function forgotPassword() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
      const emailInput = document.getElementById('loginEmail');
      const email = emailInput.value;
      if (!email) {
        alert("Pros√≠m, zadajte svoju e-mailov√∫ adresu do poƒæa pre prihl√°senie.");
        emailInput.focus();
        return;
      }
      auth.sendPasswordResetEmail(email)
        .then(() => {
          alert("Odkaz na obnovenie hesla bol odoslan√Ω na va≈°u e-mailov√∫ adresu. Skontrolujte si pros√≠m po≈°tu (aj prieƒçinok Spam).");
        })
        .catch((error) => {
          console.error("Chyba pri odosielan√≠ e-mailu na obnovenie hesla:", error);
          alert("Chyba pri odosielan√≠ e-mailu na obnovenie hesla: " + error.message);
        });
    }

    // 5. Auth State Change Listener - Nezmenen√©
    auth.onAuthStateChanged(user => { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const authContainer = document.getElementById('auth-container');
        const calculatorContainer = document.getElementById('calculator-container');
        const loadingContainer = document.getElementById('loading-container');
        if (loadingContainer) loadingContainer.classList.add('hidden');

        if (firestoreListenerUnsubscribe) {
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        if (user) {
            document.getElementById('auth-message').textContent = "Prihl√°sen√Ω: " + user.email;
            authContainer.style.display = "none";
            calculatorContainer.style.display = "block";

            const storedMonth = localStorage.getItem('currentMonth'); const storedYear = localStorage.getItem('currentYear');
            const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false; const currentDate = new Date();
            currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
            currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
            monthSelect.value = currentMonth;
            if (yearSelect.querySelector(`option[value="${currentYear}"]`)) { yearSelect.value = currentYear; }
            else { console.warn(`Rok ${currentYear} z localStorage nen√°jden√Ω v selecte, pou≈æ√≠vam aktu√°lny rok.`); currentYear = currentDate.getFullYear(); populateYearSelect(); yearSelect.value = currentYear; }
            applyDarkMode(darkMode);
            // Naƒç√≠tanie nastaven√≠ z localStorage pri prihl√°sen√≠
            hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
            taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
            decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
            employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
            // Aktualiz√°cia UI nastaven√≠
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = taxRate * 100;
            decimalPlacesSelect.value = decimalPlaces;
            employeeNameInput.value = employeeName;

            loadFromLocalStorage(); // Naƒç√≠ta monthData a ostatn√©, potom zavol√° updateUIFromLoadedData

            setupFirestoreListener();

            const uid = user.uid; const userDocRef = db.collection("users").doc(uid);
            userDocRef.get().then(userDocSnap => { if (!userDocSnap.exists) { userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true }).catch(err => console.error("Chyba pri vytv√°ran√≠/aktualiz√°cii dokumentu pou≈æ√≠vateƒæa:", err)); } }).catch(err => { console.error("Chyba pri kontrole dokumentu pou≈æ√≠vateƒæa (userDocRef.get):", err); showSaveNotification("Chyba pri overovan√≠ pou≈æ√≠vateƒæsk√Ωch d√°t", "error"); });

        } else {
            document.getElementById('auth-message').textContent = "≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.";
            authContainer.style.display = "block";
            calculatorContainer.style.display = "none";
            monthData = {}; // Vyma≈æeme d√°ta pri odhl√°sen√≠
            workDays.innerHTML = '';
            totalSalaryDiv.innerHTML = '';
            updateWelcomeMessage();
        }
    });

    // 6. Utility funkcie - Nezmenen√©
    function showSaveNotification(message, type = 'success') { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const notification = document.getElementById('saveNotification'); notification.textContent = message; notification.className = 'show'; if (type === 'error') { notification.classList.add('error'); } else if (type === 'warning') { notification.classList.add('warning'); } notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 3000);
    }
    function getFirstName(fullName) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        if (!fullName || typeof fullName !== 'string') { return ''; } const trimmedName = fullName.trim(); if (!trimmedName) { return ''; } const parts = trimmedName.split(' '); return parts[0];
    }
    function updateWelcomeMessage() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const welcomeElement = document.getElementById('welcomeMessage'); if (!welcomeElement) return; const firstName = getFirstName(employeeName); if (firstName) { welcomeElement.textContent = `Vitaj sp√§≈•, ${firstName}! üëã`; } else { welcomeElement.textContent = ''; }
    }

    // 7. Funkcia na nastavenie Firestore Listenera - Nezmenen√©
    function setupFirestoreListener() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        if (firestoreListenerUnsubscribe) {
             firestoreListenerUnsubscribe();
             firestoreListenerUnsubscribe = null;
        }
        const uid = auth.currentUser?.uid; if (!uid) { return; }
        if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) { const now = new Date(); currentMonth = currentMonth ?? now.getMonth(); currentYear = currentYear ?? now.getFullYear(); console.warn("setupFirestoreListener: Ch√Ωba mesiac/rok."); }
        const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`; const docRef = db.doc(docPath);

        firestoreListenerUnsubscribe = docRef.onSnapshot((docSnap) => {
            const hasPending = docSnap.metadata.hasPendingWrites;
            const activeElementId = document.activeElement?.id;

            if (hasPending) {
                 if (docSnap.exists) {
                     const data = docSnap.data(); const firebaseDaysData = data.days || [];
                     if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                     monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                         start: day.start || '', end: day.end || '', breakTime: day.breakTime || '', note: day.note || '', noteVisible: day.noteVisible === true
                     }));
                 }
                 return;
            }

            if (docSnap.exists) {
                const data = docSnap.data();
                try {
                    const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
                    const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
                    const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
                    const firebaseEmployeeName = data.employeeName ?? employeeName;
                    const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');
                    const firebaseDaysData = data.days || [];

                    hourlyWage = firebaseHourlyWage;
                    taxRate = firebaseTaxRatePercent / 100;
                    decimalPlaces = firebaseDecimalPlaces;
                    employeeName = firebaseEmployeeName;

                    if (document.activeElement !== hourlyWageInput) { hourlyWageInput.value = hourlyWage; }
                    if (document.activeElement !== taxRateInput) { taxRateInput.value = taxRate * 100; }
                    decimalPlacesSelect.value = decimalPlaces;
                    if (document.activeElement !== employeeNameInput) { employeeNameInput.value = employeeName; }

                    if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                        start: day.start || '', end: day.end || '', breakTime: day.breakTime || '', note: day.note || '', noteVisible: day.noteVisible === true
                    }));

                    const daysInMonth = getDaysInMonth(currentMonth);
                    let anyRowRecalculated = false;

                    for (let i = 1; i <= daysInMonth; i++) {
                        const dayIndex = i - 1;
                        const firebaseDayData = monthData[currentYear]?.[currentMonth]?.[dayIndex] || { start: '', end: '', breakTime: '', note: '', noteVisible: false };

                        const startId = `start-${currentYear}-${currentMonth}-${i}`;
                        const endId = `end-${currentYear}-${currentMonth}-${i}`;
                        const breakId = `break-${currentYear}-${currentMonth}-${i}`;
                        const noteId = `note-${currentYear}-${currentMonth}-${i}`;
                        const noteContainerId = `note-container-${currentYear}-${currentMonth}-${i}`;
                        const noteButtonId = `note-toggle-${currentYear}-${currentMonth}-${i}`;
                        const noteIndicatorId = `note-indicator-${currentYear}-${currentMonth}-${i}`;

                        const startElement = document.getElementById(startId);
                        const endElement = document.getElementById(endId);
                        const breakElement = document.getElementById(breakId);
                        const noteElement = document.getElementById(noteId);
                        const noteContainer = document.getElementById(noteContainerId);
                        const noteButton = document.getElementById(noteButtonId);
                        const noteIndicator = document.getElementById(noteIndicatorId);

                        if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
                            const newStart = firebaseDayData.start || '';
                            const newEnd = firebaseDayData.end || '';
                            const newBreak = firebaseDayData.breakTime || '';
                            const newNote = firebaseDayData.note || '';
                            const newNoteVisible = firebaseDayData.noteVisible === true;
                            let rowUpdatedByListener = false;

                            if (startElement.value !== newStart && activeElementId !== startId) { startElement.value = newStart; rowUpdatedByListener = true; }
                            if (endElement.value !== newEnd && activeElementId !== endId) { endElement.value = newEnd; rowUpdatedByListener = true; }
                            if (breakElement.value !== newBreak && activeElementId !== breakId) { breakElement.value = newBreak; rowUpdatedByListener = true; }
                            if (noteElement.value !== newNote && activeElementId !== noteId) { noteElement.value = newNote; updateNoteIndicator(i); }

                            const currentNoteVisible = noteContainer.classList.contains('visible');
                            if (currentNoteVisible !== newNoteVisible) {
                                noteContainer.classList.toggle('visible', newNoteVisible);
                                noteButton.textContent = newNoteVisible ? 'Skry≈•' : 'Pozn√°mka';
                            }

                            if (rowUpdatedByListener) { calculateRow(i); anyRowRecalculated = true; }
                        }
                    }

                    if (anyRowRecalculated) { calculateTotal(); }
                    applyDarkMode(firebaseDarkMode);
                    updateWelcomeMessage();
                    updateDataSize();

                    if (!docSnap.metadata.fromCache) { showSaveNotification("D√°ta synchronizovan√©"); }

                } catch (processError) {
                    console.error(`Listener: Chyba pri spracovan√≠ d√°t z Firestore pre ${currentYear}-${currentMonth}:`, processError);
                    showSaveNotification("Chyba: Nespr√°vny form√°t d√°t z Firebase", "error");
                }
            } else {
                 if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = [];
                 localStorage.setItem('workDaysData', JSON.stringify(monthData));

                 hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                 taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
                 const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                 decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
                 employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

                 hourlyWageInput.value = hourlyWage;
                 taxRateInput.value = taxRate * 100;
                 decimalPlacesSelect.value = decimalPlaces;
                 employeeNameInput.value = employeeName;

                 createTable(); calculateTotal(); applyDarkMode(darkMode); updateWelcomeMessage(); updateDataSize();
            }

        }, (error) => {
            console.error(`Firestore listener CHYBA pre ${docPath}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa pripoji≈• k Firebase", "error");
            loadFromLocalStorage(); // Fallback
        });
    }

    // 8. Funkcia na ukladanie do Firebase - Nezmenen√©
    async function saveToFirebase() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const currentUser = auth.currentUser;
        if (!currentUser) { return; }
        try {
            const currentMonthWorkData = ((monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []).map(day => ({
                start: day.start || '',
                end: day.end || '',
                breakTime: day.breakTime || '',
                note: day.note || '',
                noteVisible: day.noteVisible === true
            }));

            const dataToSave = {
                days: currentMonthWorkData,
                hourlyWage: hourlyWage || 10,
                taxRate: (taxRate * 100) || 2,
                decimalPlaces: decimalPlaces || 1,
                employeeName: employeeName || '',
                darkMode: document.body.classList.contains('dark-mode'),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            const yearMonthDoc = `${currentYear}-${currentMonth}`;
            const uid = currentUser.uid;
            const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);
            await docRef.set(dataToSave);
        } catch (error) {
            console.error(`Chyba pri po≈æiadavke na ukladanie do Firebase pre ${currentYear}-${currentMonth}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa odosla≈• d√°ta do Firebase", "error");
        }
    }

    // 9. Funkcia na ukladanie do Local Storage - Nezmenen√©
    function saveToLocalStorage() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        try {
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) { monthData[currentYear][currentMonth] = []; }
            localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
            localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); // Uklad√°me ako percento
            localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
            localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
            localStorage.setItem('employeeName', JSON.stringify(employeeName));
            localStorage.setItem('currentMonth', currentMonth.toString());
            localStorage.setItem('currentYear', currentYear.toString());

            const serializedMonthData = JSON.stringify(monthData); // Uklad√°me cel√Ω objekt monthData
            const bytes = new Blob([serializedMonthData]).size;
            if (bytes > MAX_DATA_SIZE * 0.9) { console.warn(`Veƒækos≈• d√°t ('workDaysData') v localStorage sa bl√≠≈æi k limitu: ${bytes} bajtov`); }
            if (bytes > MAX_DATA_SIZE) { alert(`Prekroƒçili ste maxim√°lnu veƒækos≈• d√°t (~${MAX_DATA_SIZE_KB} KB) pre d√°ta mesiacov v localStorage. Ukladanie zlyhalo.`); showSaveNotification("Chyba: Lok√°lne d√°ta s√∫ pr√≠li≈° veƒæk√©!", "error"); return; }
            localStorage.setItem('workDaysData', serializedMonthData); // Ulo≈æenie cel√©ho objektu
            updateDataSize();
            saveToFirebase(); // Volanie ulo≈æenia do Firebase
            if (!navigator.onLine) { showSaveNotification("Offline: Zmeny ulo≈æen√© lok√°lne", "warning"); }
         } catch (error) {
             console.error('Chyba pri ukladan√≠ (lok√°lne/spusten√≠ Firebase save):', error);
             showSaveNotification("Kritick√° chyba pri ukladan√≠!", "error");
         }
    }

    // 10. Funkcia na naƒç√≠tanie z Local Storage - Nezmenen√©
    function loadFromLocalStorage() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
         try {
            // Naƒç√≠tanie aktu√°lneho mesiaca a roku, ak nie s√∫ nastaven√©
            if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                const storedMonth = localStorage.getItem('currentMonth');
                const storedYear = localStorage.getItem('currentYear');
                const currentDate = new Date();
                currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
            }
            // Naƒç√≠tanie d√°t pre v≈°etky mesiace
            const storedMonthData = localStorage.getItem('workDaysData');
            monthData = storedMonthData ? JSON.parse(storedMonthData) : {}; // Naƒç√≠tame cel√Ω objekt monthData

            // Zabezpeƒçenie, ≈æe aktu√°lny mesiac/rok m√° pole v monthData
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];

             // Zabezpeƒçenie, ≈æe star√© d√°ta bez noteVisible dostan√∫ predvolen√∫ hodnotu
            if (monthData[currentYear]?.[currentMonth]) {
                 monthData[currentYear][currentMonth] = monthData[currentYear][currentMonth].map(day => ({
                     ...day,
                     noteVisible: day.noteVisible === true
                 }));
            }

            // Naƒç√≠tanie ostatn√Ωch nastaven√≠
            hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
            taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02; // Naƒç√≠tavame percento a del√≠me 100
            const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
            decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
            employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

            updateUIFromLoadedData(darkMode); // Aktualiz√°cia UI
         } catch (error) {
             console.error(`Kritick√° chyba pri naƒç√≠tavan√≠/spracovan√≠ d√°t z localStorage:`, error);
             showSaveNotification("Chyba pri naƒç√≠tan√≠ lok√°lnych d√°t!", "error");
             monthData = {}; // Reset v pr√≠pade chyby
             createTable();
             calculateTotal();
         }
    }

    // 11. Funkcia na aktualiz√°ciu UI - Nezmenen√©
    function updateUIFromLoadedData(darkModeValue) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        try {
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = (taxRate * 100); // Zobrazujeme ako percento
            decimalPlacesSelect.value = decimalPlaces;
            employeeNameInput.value = employeeName;
            if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) { monthSelect.value = currentMonth; } else { monthSelect.value = new Date().getMonth(); currentMonth = parseInt(monthSelect.value); }
            if (yearSelect.querySelector(`option[value="${currentYear}"]`)) { yearSelect.value = currentYear; } else { yearSelect.value = new Date().getFullYear(); currentYear = parseInt(yearSelect.value); populateYearSelect(); yearSelect.value = currentYear;}

            createTable(); // Vytvor√≠ pr√°zdnu tabuƒæku so spr√°vnym poƒçtom dn√≠

            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            const daysInTable = getDaysInMonth(currentMonth);

            // Prejdeme v≈°etky dni v tabuƒæke
            for (let i = 1; i <= daysInTable; i++) {
                 const dayIndex = i - 1;
                 const day = dataForCurrentMonth[dayIndex] || { start: '', end: '', breakTime: '', note: '', noteVisible: false }; // Ak d√°ta ch√Ωbaj√∫

                 const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                 const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                 const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                 const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);
                 const noteContainer = document.getElementById(`note-container-${currentYear}-${currentMonth}-${i}`);
                 const noteButton = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${i}`);
                 const noteIndicator = document.getElementById(`note-indicator-${currentYear}-${currentMonth}-${i}`);

                 if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
                     startElement.value = day.start || '';
                     endElement.value = day.end || '';
                     breakElement.value = day.breakTime || '';
                     noteElement.value = day.note || '';
                     calculateRow(i); // Prepoƒç√≠ta mzdu pre riadok

                     const isNoteVisible = day.noteVisible === true;
                     noteContainer.classList.toggle('visible', isNoteVisible);
                     noteButton.textContent = isNoteVisible ? 'Skry≈•' : 'Pozn√°mka';
                     updateNoteIndicator(i);

                     const isDarkModeActive = document.body.classList.contains('dark-mode');
                     if(noteElement) noteElement.classList.toggle('dark-mode', isDarkModeActive);
                     if(noteButton) noteButton.classList.toggle('dark-mode', isDarkModeActive);
                     if(noteIndicator) noteIndicator.classList.toggle('dark-mode', isDarkModeActive);
                 } else {
                     console.error(`Kritick√° chyba: Elementy pre de≈à ${i} v updateUIFromLoadedData neboli n√°jden√© po createTable!`);
                 }
            }
            calculateTotal();
            updateDataSize();
            applyDarkMode(darkModeValue);
            updateWelcomeMessage();
        } catch (error) {
            console.error("Chyba poƒças aktualiz√°cie UI:", error);
            showSaveNotification("Chyba pri prekresƒæovan√≠ UI!", "error");
        }
    }

    // 12. Funkcia pre aplikovanie Dark Mode - Nezmenen√©
    function applyDarkMode(isDark) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const elementsToToggle = [
            document.body, document.querySelector('.container'), totalSalaryDiv,
            document.querySelector('.collapsible-settings summary'),
            ...document.querySelectorAll('table, th, td'),
            ...document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"], select'),
            ...document.querySelectorAll('.btn'),
            ...document.querySelectorAll('.toggle-note-btn'),
            ...document.querySelectorAll('.note-textarea'),
            ...document.querySelectorAll('.time-icon'),
            ...document.querySelectorAll('.note-indicator-icon')
        ];
        elementsToToggle.forEach(el => el?.classList[isDark ? 'add' : 'remove']('dark-mode'));
        const currentDayRow = document.querySelector('.current-day');
        if (currentDayRow) {
            currentDayRow.classList[isDark ? 'add' : 'remove']('dark-mode');
            currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn').forEach(el => el?.classList[isDark ? 'add' : 'remove']('dark-mode'));
        }
    }

    // 13) Vytv√°ranie tabuƒæky a s√∫visiace funkcie - Nezmenen√©
    function getDayName(year, month, day) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const daysOfWeek = ["Nedeƒæa", "Pondelok", "Utorok", "Streda", "≈†tvrtok", "Piatok", "Sobota"];
        // Skontrolujeme, ƒçi je de≈à platn√Ω pre dan√Ω mesiac a rok
        const date = new Date(year, month, day);
        if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
            return daysOfWeek[date.getDay()];
        }
        return 'N/A'; // Alebo in√° indik√°cia neplatn√©ho d≈àa
    }
    function createTable() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        workDays.innerHTML = '';
        const tableHead = document.querySelector('table thead tr');
        if (tableHead && !tableHead.querySelector('.th-note')) {
            const noteTh = document.createElement('th');
            noteTh.textContent = 'Pozn√°mka'; noteTh.classList.add('th-note');
            const lastTh = tableHead.lastElementChild;
            tableHead.insertBefore(noteTh, lastTh);
        }
        const daysInMonth = getDaysInMonth(currentMonth);
        const today = new Date(); const currentDayOfMonth = today.getDate();
        const currentMonthIndex = today.getMonth(); const currentYearValue = today.getFullYear();
        if (isNaN(daysInMonth) || daysInMonth <= 0) {
             console.error("createTable: Neplatn√Ω poƒçet dn√≠ v mesiaci:", daysInMonth, "pre", currentMonth, currentYear);
             return;
        }
        for (let i = 1; i <= daysInMonth; i++) {
            const row = document.createElement('tr');
            if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) { row.classList.add('current-day'); }
            const dayName = getDayName(currentYear, currentMonth, i); // Pou≈æije sa validovan√° funkcia
            const baseId = `${currentYear}-${currentMonth}-${i}`;
            const startId = `start-${baseId}`; const endId = `end-${baseId}`; const breakId = `break-${baseId}`;
            const totalId = `total-${baseId}`; const grossId = `gross-${baseId}`; const netId = `net-${baseId}`;
            const noteToggleId = `note-toggle-${baseId}`; const noteContainerId = `note-container-${baseId}`; const noteTextareaId = `note-${baseId}`;
            const noteIndicatorId = `note-indicator-${baseId}`;

            row.innerHTML = `
                <td>De≈à ${i} (${dayName})</td>
                <td> <input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}', ${i})">
                  <span class="time-icon" title="Vlo≈æi≈• aktu√°lny ƒças" onclick="insertCurrentTime('${startId}')">‚è∞</span>
                </td>
                <td> <input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}', ${i})">
                  <span class="time-icon" title="Vlo≈æi≈• aktu√°lny ƒças" onclick="insertCurrentTime('${endId}')">‚è∞</span>
                </td>
                <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="prest√°vka" oninput="handleBreakInput(${i})"></td>
                <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces || 1)} h)</td>
                <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="Hrub√° Mzda" readonly></td>
                <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="ƒåist√° Mzda" readonly></td>
                <td>
                  <span class="note-indicator-icon" id="${noteIndicatorId}">üìù</span> <button id="${noteToggleId}" class="toggle-note-btn" onclick="toggleNote(${i})">Pozn√°mka</button>
                  <div id="${noteContainerId}" class="note-container"><textarea id="${noteTextareaId}" class="note-textarea" placeholder="Zadajte pozn√°mku..." oninput="handleNoteInput(this, ${i})"></textarea></div>
                </td>
                <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulova≈•</button></td>
            `;
            workDays.appendChild(row);
        }
        applyDarkMode(document.body.classList.contains('dark-mode'));
    }
    window.insertCurrentTime = function(targetInputId) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const formattedTime = `${hours}:${minutes}`;

        const targetInput = document.getElementById(targetInputId);
        if (targetInput) {
            targetInput.value = formattedTime;
            const dayPart = targetInputId.split('-').pop(); // Z√≠skame posledn√∫ ƒças≈• ID, ƒço by malo by≈• ƒç√≠slo d≈àa
            const day = parseInt(dayPart);
            if (!isNaN(day)) {
                updateMonthDataFromInput(targetInput, day);
                calculateRow(day);
                calculateTotal();
                saveToLocalStorage(); // Ulo≈æ√≠me zmenu
            } else {
                 console.error('insertCurrentTime: Nepodarilo sa z√≠ska≈• ƒç√≠slo d≈àa z ID:', targetInputId);
            }
        } else {
            console.error('Cieƒæov√Ω input pre vlo≈æenie ƒçasu nebol n√°jden√Ω:', targetInputId);
            showSaveNotification('Chyba: Nepodarilo sa n√°js≈• pole pre vlo≈æenie ƒçasu.', 'error');
        }
    }
    function toggleNote(day) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const containerId = `note-container-${currentYear}-${currentMonth}-${day}`;
        const buttonId = `note-toggle-${currentYear}-${currentMonth}-${day}`;
        const noteContainer = document.getElementById(containerId);
        const toggleButton = document.getElementById(buttonId);

        if (noteContainer && toggleButton) {
            const isVisible = noteContainer.classList.toggle('visible');
            toggleButton.textContent = isVisible ? 'Skry≈•' : 'Pozn√°mka';

            const dayIndex = day - 1;
            // Zabezpeƒç√≠me existenciu ≈°trukt√∫ry
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
             while (dayIndex >= monthData[currentYear][currentMonth].length) {
                 monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '', noteVisible: false });
             }

            if (monthData[currentYear][currentMonth][dayIndex]) {
                monthData[currentYear][currentMonth][dayIndex].noteVisible = isVisible;
                saveToLocalStorage(); // Ulo≈æ√≠me zmenu stavu viditeƒænosti
            } else {
                 console.warn(`toggleNote: Z√°znam pre de≈à ${dayIndex} nebol n√°jden√Ω pri ukladan√≠ viditeƒænosti.`);
            }

            if (document.body.classList.contains('dark-mode')) {
                 const textarea = noteContainer.querySelector('textarea');
                 if(textarea) { textarea.classList.toggle('dark-mode', isVisible); }
                 toggleButton.classList.toggle('dark-mode', isVisible); // Tie≈æ toggle dark mode pre button
            }
        } else { console.warn(`toggleNote: Elementy pre pozn√°mku d≈àa ${day} neboli n√°jden√©.`); }
    }
    function updateNoteIndicator(day) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const noteTextarea = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`);
        const indicatorIcon = document.getElementById(`note-indicator-${currentYear}-${currentMonth}-${day}`);
        if (noteTextarea && indicatorIcon) {
            const hasContent = noteTextarea.value.trim() !== '';
            indicatorIcon.style.display = hasContent ? 'inline-block' : 'none';
            indicatorIcon.classList.toggle('dark-mode', document.body.classList.contains('dark-mode'));
        }
    }
    function isTimeValid(timeStr) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeStr);
    }
    function handleInput(input, nextId, day) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        formatInput(input);
        const dayNum = parseInt(input.id.split('-').pop()); // Z√≠skame de≈à z ID
        if (isNaN(dayNum)) { console.error("handleInput: Nepodarilo sa z√≠ska≈• de≈à z ID:", input.id); return; }
        updateMonthDataFromInput(input, dayNum);
        calculateRow(dayNum);
        calculateTotal();
        saveToLocalStorage();
        if (input.type === 'tel' && input.value.length === 5 && isTimeValid(input.value)) {
           moveNext(input, nextId);
        }
    }
    function handleBreakInput(day) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        if (!input) { console.error("handleBreakInput: Input nen√°jden√Ω pre de≈à", day); return; }
        updateMonthDataFromInput(input, day);
        calculateRow(day);
        calculateTotal();
        saveToLocalStorage();
    }
    function handleNoteInput(textarea, day) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        updateMonthDataFromInput(textarea, day);
        saveToLocalStorage();
        updateNoteIndicator(day);
    }
    function updateMonthDataFromInput(input, day) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        if (!input) return;
        const dayIndex = day - 1; // 0-based index
        const fieldId = input.id;
        let field = 'unknown';

        if (fieldId.startsWith('start-')) field = 'start';
        else if (fieldId.startsWith('end-')) field = 'end';
        else if (fieldId.startsWith('break-')) field = 'breakTime';
        else if (fieldId.startsWith('note-')) field = 'note';

        const value = input.value;

        if (field !== 'unknown') {
            // Zabezpeƒç√≠me, ≈æe ≈°trukt√∫ra existuje
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];

            // Dopln√≠me ch√Ωbaj√∫ce dni, ak je to potrebn√©
            while (dayIndex >= monthData[currentYear][currentMonth].length) {
                 monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '', noteVisible: false });
            }

             // Zabezpeƒç√≠me existenciu objektu pre dan√Ω de≈à
             if (!monthData[currentYear][currentMonth][dayIndex]) {
                  monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '', noteVisible: false };
             }

             // Aktualizujeme hodnotu
             if (monthData[currentYear][currentMonth][dayIndex][field] !== value) {
                 monthData[currentYear][currentMonth][dayIndex][field] = value;
             }

             // Zabezpeƒç√≠me, ≈æe noteVisible existuje (pre star≈°ie d√°ta)
            if (typeof monthData[currentYear][currentMonth][dayIndex].noteVisible === 'undefined') {
                 monthData[currentYear][currentMonth][dayIndex].noteVisible = false;
            }

        } else {
             console.warn("updateMonthDataFromInput: Nerozpoznan√© pole pre input ID:", fieldId);
        }
    }
    function formatInput(input) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        if (!input || input.type !== 'tel') return;
        let value = input.value.replace(/[^\d:]/g, '');

        if (value.length === 4 && !value.includes(':')) {
            value = value.slice(0, 2) + ':' + value.slice(2);
        } else if (value.length === 3 && value.charAt(2) !== ':' && parseInt(value.slice(0, 2)) <= 23) {
            value = value.slice(0, 2) + ':' + value.slice(2);
        } else if (value.length === 2 && !value.includes(':') && input.value.length > 1 && input.selectionStart === 2) {
             // Automatick√© pridanie ':' po dvoch ƒç√≠sliciach, ak kurzor je na konci
             // Potrebujeme timeout, aby sa hodnota stihla zap√≠sa≈• pred pridan√≠m ':'
             setTimeout(() => {
                if (input.value.length === 2 && !input.value.includes(':')) {
                     input.value = input.value + ':';
                }
             }, 0);
        }


        if (value.length > 5) {
            value = value.slice(0, 5);
        }

        // Neaktualizujeme hodnotu priamo tu, ak sme pou≈æili setTimeout
        if (!value.endsWith(':') && input.value !== value) {
             input.value = value;
        }

        // Validation Border Logic
        if (value.length > 0 && value.length < 5) {
            if(input.style.border !== '') input.style.border = '';
        } else if (value.length === 5) {
            if (isTimeValid(value)) {
                if(input.style.border !== '') input.style.border = '';
            } else {
                input.style.border = '1px solid red';
                setTimeout(() => {
                    if(input.style.borderColor === 'red') { input.style.border = ''; }
                }, 2000);
            }
        } else {
             if(input.style.border !== '') input.style.border = '';
        }
    }
    function moveNext(currentElement, nextId) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        if (!nextId || !currentElement) return;
        const nextElement = document.getElementById(nextId);
        if (nextElement) {
            // D√°me focus len ak bol p√¥vodn√Ω element akt√≠vny (aby sme nepreskakovali pri naƒç√≠tan√≠ d√°t)
            if (document.activeElement === currentElement) {
                 nextElement.focus();
                 // Select textu len pre inputy, ktor√© nie s√∫ typu 'number'
                 if (nextElement.tagName === 'INPUT' && nextElement.type !== 'number' && typeof nextElement.select === 'function') {
                     nextElement.select();
                 }
            }
        } else {
             console.warn(`moveNext: Element s ID ${nextId} nebol n√°jden√Ω.`);
        }
     }
    function calculateRow(day) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value;
        const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value;
        const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const breakTime = parseFloat(breakTimeInput?.value) || 0;
        const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);

        if (!totalCell || !grossElement || !netElement) { return; } // Elementy neexistuj√∫

        if (!startTimeStr && !endTimeStr && breakTime === 0) { // Ak je v≈°etko pr√°zdne
            totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
            grossElement.value = (0).toFixed(2);
            netElement.value = (0).toFixed(2);
            return;
        }

        if (!isTimeValid(startTimeStr) || !isTimeValid(endTimeStr)) {
            // Ak aspo≈à jeden ƒças nie je platn√Ω (ale nieƒço je zadan√©)
            totalCell.textContent = (startTimeStr || endTimeStr) ? 'Neplatn√Ω ƒças' : `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
            grossElement.value = '0.00';
            netElement.value = '0.00';
            return;
        }

        // Oba ƒçasy s√∫ platn√©
        const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
        const [endHours, endMinutes] = endTimeStr.split(':').map(Number);

        // Pou≈æijeme Date objekty pre jednoduch≈°√≠ v√Ωpoƒçet rozdielu (aj cez polnoc)
        const startDate = new Date(2000, 0, 1, startHours, startMinutes); // Fikt√≠vny d√°tum
        let endDate = new Date(2000, 0, 1, endHours, endMinutes);

        if (endDate < startDate) { // Ak odchod je na druh√Ω de≈à
            endDate.setDate(endDate.getDate() + 1);
        }

        const diffMilliseconds = endDate - startDate;
        const diffMinutesTotal = diffMilliseconds / (1000 * 60);
        const breakMinutes = breakTime * 60;
        const workedMinutes = Math.max(0, diffMinutesTotal - breakMinutes);

        const hours = Math.floor(workedMinutes / 60);
        const minutes = Math.round(workedMinutes % 60); // Zaokr√∫hlime min√∫ty
        const decimalHours = (workedMinutes / 60);

        totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces || 1)} h)`;

        const currentHourlyWage = hourlyWage;
        const currentTaxRate = taxRate;
        const grossSalary = decimalHours * currentHourlyWage;
        grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(2) : '0.00';
        const netSalary = grossSalary * (1 - currentTaxRate);
        netElement.value = isFinite(netSalary) ? netSalary.toFixed(2) : '0.00';
    }
    function resetRow(day) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const dayIndex = day - 1;
        const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`);
        const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`);
        const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
        const total = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`);
        const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`);
        const net = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`);
        const note = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`);
        const noteContainer = document.getElementById(`note-container-${currentYear}-${currentMonth}-${day}`);
        const noteToggle = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${day}`);
        const noteIndicator = document.getElementById(`note-indicator-${currentYear}-${currentMonth}-${day}`);

        if (start && end && breakTime && total && gross && net && note && noteContainer && noteToggle && noteIndicator) {
            start.value = ''; end.value = ''; breakTime.value = ''; note.value = '';
            total.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
            gross.value = '0.00'; net.value = '0.00';
            noteContainer.classList.remove('visible'); noteToggle.textContent = 'Pozn√°mka';
            updateNoteIndicator(day);

            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
            while (dayIndex >= monthData[currentYear][currentMonth].length) {
                 monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '', noteVisible: false });
             }
            if (monthData[currentYear][currentMonth][dayIndex]) {
                 monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '', noteVisible: false };
            } else {
                 console.error(`resetRow: Ch√Ωba z√°znam pre de≈à ${dayIndex} v monthData.`);
            }

            calculateTotal();
            saveToLocalStorage(); // Ulo≈æ√≠me zmenu

        } else {
            console.warn(`resetRow: Niektor√© elementy pre de≈à ${day} neboli n√°jden√©.`);
        }
    }
    function resetAll() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        if (confirm('Naozaj chcete resetova≈• v≈°etky z√°znamy pre tento mesiac?')) {
            if (!monthData) monthData = {};
            if (!monthData[currentYear]) monthData[currentYear] = {};
            const days = getDaysInMonth(currentMonth);
            // Vytvor√≠me pole spr√°vnej dƒ∫≈æky s pr√°zdnymi objektmi
            monthData[currentYear][currentMonth] = Array.from({ length: days }, () => ({ start: '', end: '', breakTime: '', note: '', noteVisible: false }));

            // Prejdeme existuj√∫ce riadky v UI a resetneme ich hodnoty
            for (let i = 1; i <= days; i++) {
                const start = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                const end = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                const total = document.getElementById(`total-${currentYear}-${currentMonth}-${i}`);
                const gross = document.getElementById(`gross-${currentYear}-${currentMonth}-${i}`);
                const net = document.getElementById(`net-${currentYear}-${currentMonth}-${i}`);
                const note = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);
                const noteContainer = document.getElementById(`note-container-${currentYear}-${currentMonth}-${i}`);
                const noteToggle = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${i}`);

                if (start) start.value = '';
                if (end) end.value = '';
                if (breakTime) breakTime.value = '';
                if (note) note.value = '';
                if (noteContainer) noteContainer.classList.remove('visible');
                if (noteToggle) noteToggle.textContent = 'Pozn√°mka';
                if (total) total.textContent = `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`;
                if (gross) gross.value = '0.00';
                if (net) net.value = '0.00';
                updateNoteIndicator(i);
            }

            calculateTotal();
            saveToLocalStorage(); // Ulo≈æ√≠me resetovan√Ω stav
            showSaveNotification("D√°ta pre aktu√°lny mesiac boli resetovan√©.");
        }
     }

    // 14) V√Ωpoƒçet celkov√Ωch s√∫ƒçtov - Nezmenen√©
    function calculateTotal() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        let grandTotalWorkedMinutes = 0; let daysWithEntries = 0;
        const rows = workDays.querySelectorAll('tr');
        const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate; const currentDecimalPlaces = decimalPlaces || 1;

        rows.forEach((row, index) => {
            const dayIndex = index + 1; // De≈à je 1-based
            const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${dayIndex}`)?.value;
            const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${dayIndex}`)?.value;
            const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${dayIndex}`);

            if (startTimeStr && endTimeStr && isTimeValid(startTimeStr) && isTimeValid(endTimeStr)) {
                const breakTime = parseFloat(breakTimeInput?.value) || 0;
                const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
                const [endHours, endMinutes] = endTimeStr.split(':').map(Number);

                const startDate = new Date(2000, 0, 1, startHours, startMinutes);
                let endDate = new Date(2000, 0, 1, endHours, endMinutes);
                if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); }

                const diffMilliseconds = endDate - startDate;
                const diffMinutesTotal = diffMilliseconds / (1000 * 60);
                const breakMinutes = breakTime * 60;
                const workedMinutesForRow = Math.max(0, diffMinutesTotal - breakMinutes);

                grandTotalWorkedMinutes += workedMinutesForRow;
                if (workedMinutesForRow > 0) { // Poƒç√≠tame de≈à len ak sa re√°lne pracovalo
                    daysWithEntries++;
                }
            } else if (startTimeStr || endTimeStr || (breakTimeInput && parseFloat(breakTimeInput.value) > 0)) {
                 // Ak je zadan√Ω aspo≈à jeden ƒças alebo prest√°vka, r√°tame ako "dotknut√Ω" de≈à, aj keƒè v√Ωpoƒçet zlyhal
                 // (alternat√≠va: ner√°ta≈• v√¥bec, alebo r√°ta≈• len ak je validn√Ω v√Ωpoƒçet mo≈æn√Ω)
                 // Pre jednoduchos≈• teraz ner√°tame ako daysWithEntries, ak v√Ωpoƒçet nie je mo≈æn√Ω
            }
        });

        const grandTotalDecimalHours = grandTotalWorkedMinutes / 60;
        const grandTotalGrossSalary = grandTotalDecimalHours * currentHourlyWage;
        const grandTotalNetSalary = grandTotalGrossSalary * (1 - currentTaxRate);
        const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0;
        const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
        const averageHours = Math.floor(averageWorkedMinutes / 60);
        const averageMinutes = Math.round(averageWorkedMinutes % 60);
        const averageDecimalHours = (averageWorkedMinutes / 60);

        const totalHours = Math.floor(grandTotalWorkedMinutes / 60);
        const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60);

        totalSalaryDiv.innerHTML = `Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntries}<br>Celkov√Ω odpracovan√Ω ƒças: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(currentDecimalPlaces)} h)<br>Celkov√° hrub√° mzda: ${grandTotalGrossSalary.toFixed(2)}‚Ç¨<br>Celkov√° ƒçist√° mzda: ${grandTotalNetSalary.toFixed(2)}‚Ç¨<br>Priemern√° ƒçist√° mzda na de≈à: ${averageNetSalary.toFixed(2)}‚Ç¨<br><strong>Priemern√Ω odpracovan√Ω ƒças na de≈à: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(currentDecimalPlaces)} h)</strong>`;
    }

    // 15) Export do PDF (exportToPDF, sendPDF) - Nezmenen√©
    function exportToPDF() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Kni≈ænica jsPDF alebo autoTable nie je spr√°vne naƒç√≠tan√°."); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; }
        const { jsPDF } = window.jspdf;
        try {
            const doc = new jsPDF();
            try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("Could not load Roboto font for PDF, using default.", e); }
            doc.setFontSize(18); doc.text(`Bruno's Calculator - V√Ωkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);
            doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${employeeName || 'Nezadan√©'}`, 14, 28);
            doc.text(`Hodinov√° mzda: ${hourlyWage || 'N/A'} ‚Ç¨`, 14, 34); doc.text(`Da≈à (%): ${(taxRate*100).toFixed(1) || 'N/A'}`, 100, 34); // Zobraz√≠ da≈à z aktu√°lnej premennej
            const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Odpracovan√©", "Hrub√° Mzda (‚Ç¨)", "ƒåist√° Mzda (‚Ç¨)", "Pozn√°mka"];
            const tableRows = [];
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            dataForCurrentMonth.forEach((day, index) => {
                if (day.start || day.end || (day.breakTime && parseFloat(day.breakTime) > 0) || day.note) { // Zobraz√≠me riadok, ak m√° ak√Ωkoƒævek relevantn√Ω √∫daj
                    const dayNum = index + 1; const dayName = getDayName(currentYear, currentMonth, dayNum);
                    const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${dayNum}`);
                    const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayNum}`);
                    const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayNum}`);
                    // Z√≠skame vypoƒç√≠tan√© hodnoty z UI, ak s√∫ dostupn√©
                    const workedTimeText = totalCell ? totalCell.textContent : 'N/A';
                    const grossValue = grossInput ? parseFloat(grossInput.value).toFixed(2) : '0.00';
                    const netValue = netInput ? parseFloat(netInput.value).toFixed(2) : '0.00';
                    const noteText = day.note || '';
                    const rowData = [ `De≈à ${dayNum} (${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0', workedTimeText, grossValue, netValue, noteText ];
                    tableRows.push(rowData);
                }
            });
            doc.autoTable({
                head: [tableColumn], body: tableRows, startY: 40,
                headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName || 'helvetica' }, // Fallback font
                styles: { font: doc.getFont().fontName || 'helvetica', fontSize: 8, cellPadding: 1.5 },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                columnStyles: {
                     0: { cellWidth: 20 }, 1: { cellWidth: 15 }, 2: { cellWidth: 15 }, 3: { cellWidth: 15 },
                     4: { cellWidth: 25 }, 5: { cellWidth: 20, halign: 'right' }, 6: { cellWidth: 20, halign: 'right' },
                     7: { cellWidth: 'auto' } // Pozn√°mka automaticky
                 }
            });
            const finalY = doc.lastAutoTable.finalY || 40;
            doc.setFontSize(10); const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, '');
            doc.text(totalTextContent, 14, finalY + 10);
            const pdfFileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
            doc.save(pdfFileName); showSaveNotification("PDF exportovan√©.");
        } catch (error) { console.error("Chyba pri generovan√≠ PDF v exportToPDF:", error); alert("Nastala chyba pri vytv√°ran√≠ PDF s√∫boru."); }
    }
    function sendPDF() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API.autoTable === 'undefined') { alert("Chyba: Kni≈ænica jsPDF alebo autoTable nie je spr√°vne naƒç√≠tan√°."); console.error("jsPDF library or autoTable plugin is not loaded correctly."); return; }
        const { jsPDF } = window.jspdf;
        try {
            const doc = new jsPDF();
            try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("sendPDF: Could not load Roboto font, using default.", e); }
            doc.setFontSize(16); doc.text(`Pracovn√Ω v√Ωkaz - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
            doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${employeeName || 'Nezadan√©'}`, 14, 28);
            const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Pozn√°mka"];
            const tableRows = [];
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            dataForCurrentMonth.forEach((day, index) => {
                 if (day.start || day.end || (day.breakTime && parseFloat(day.breakTime) > 0) || day.note) {
                     const dayNum = index + 1; const dayName = getDayName(currentYear, currentMonth, dayNum); const noteText = day.note || '';
                     const rowData = [ `De≈à ${dayNum} (${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0', noteText ];
                     tableRows.push(rowData);
                 }
            });
            doc.autoTable({
                head: [tableColumn], body: tableRows, startY: 35,
                headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName || 'helvetica' },
                styles: { font: doc.getFont().fontName || 'helvetica', fontSize: 9, cellPadding: 2 },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                 columnStyles: {
                     0: { cellWidth: 35 }, 1: { cellWidth: 25 }, 2: { cellWidth: 25 }, 3: { cellWidth: 25 },
                     4: { cellWidth: 'auto' } // Pozn√°mka automaticky
                 }
            });
            const finalY = doc.lastAutoTable.finalY || 35;
            doc.setFontSize(10);
            const totalSalaryHTML = totalSalaryDiv.innerHTML; let daysWithEntriesText = 'N/A';
            const match = totalSalaryHTML.match(/Poƒçet odpracovan√Ωch dn√≠: (\d+)/); if (match && match[1]) { daysWithEntriesText = match[1]; }
            const summaryText = `Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntriesText}`;
            doc.text(summaryText, 14, finalY + 10);
            const pdfBlob = doc.output('blob'); const pdfFileName = `Vykaz_odoslanie-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
            const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                navigator.share({ files: [pdfFile], title: `Pracovn√Ω v√Ωkaz ${getMonthName(currentMonth)} ${currentYear}`, text: `V√Ωkaz pre ${employeeName || 'pracovn√≠ka'} za ${getMonthName(currentMonth)} ${currentYear}.` }).then(() => { showSaveNotification("PDF pripraven√© na zdieƒæanie."); }).catch((error) => { if (error.name !== 'AbortError') { console.error('sendPDF: Chyba pri zdieƒæan√≠ cez Web Share API:', error); alert('Chyba pri zdieƒæan√≠ s√∫boru.'); } });
            } else { alert("Zdieƒæanie s√∫borov nie je podporovan√© va≈°√≠m prehliadaƒçom alebo syst√©mom. S√∫bor bude stiahnut√Ω."); const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = pdfFileName; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); }
        } catch (error) { console.error("Chyba pri generovan√≠ alebo zdieƒæan√≠ PDF v sendPDF:", error); alert("Nastala chyba pri vytv√°ran√≠ alebo zdieƒæan√≠ PDF s√∫boru."); }
    }

    // 16) Ostatn√© nastavenia - Nezmenen√©
    function changeDecimalPlaces() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
        if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) {
            decimalPlaces = newDecimalPlaces;
            localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces)); // Ulo≈æ√≠me zmenu
            // Prepoƒç√≠tame a prekresl√≠me len relevantn√© ƒçasti
            const rows = workDays.querySelectorAll('tr');
            rows.forEach((row, index) => calculateRow(index + 1)); // Prepoƒç√≠ta zobrazenie odpr. ƒçasu
            calculateTotal(); // Prepoƒç√≠ta celkov√© s√∫ƒçty
            saveToLocalStorage(); // Ulo≈æ√≠me nov√Ω stav (obsahuje aj volanie saveToFirebase)
        }
     }
    function updateEmployeeName() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        employeeName = employeeNameInput.value;
        localStorage.setItem('employeeName', JSON.stringify(employeeName)); // Ulo≈æ√≠me zmenu
        updateWelcomeMessage();
        saveToLocalStorage(); // Ulo≈æ√≠me nov√Ω stav
    }
    function updateSettings() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const newHourlyWageStr = hourlyWageInput.value; const newTaxRateStr = taxRateInput.value;
        const newHourlyWage = parseFloat(newHourlyWageStr); const newTaxRatePercent = parseFloat(newTaxRateStr);
        let settingsChanged = false;

        if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
            if (hourlyWage !== newHourlyWage) { hourlyWage = newHourlyWage; settingsChanged = true; }
        } else { hourlyWageInput.value = hourlyWage; } // Vr√°ti platn√∫ hodnotu, ak je vstup neplatn√Ω

        if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) {
            const newTaxRateDecimal = newTaxRatePercent / 100;
            if (taxRate !== newTaxRateDecimal) { taxRate = newTaxRateDecimal; settingsChanged = true; }
        } else { taxRateInput.value = (taxRate * 100).toFixed(1); } // Vr√°ti platn√∫ hodnotu

        if (settingsChanged) {
            localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
            localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); // Uklad√°me percento
            const rows = workDays.querySelectorAll('tr');
            rows.forEach((row, index) => calculateRow(index + 1)); // Prepoƒç√≠ta mzdy v riadkoch
            calculateTotal(); // Prepoƒç√≠ta celkov√© s√∫ƒçty
            saveToLocalStorage(); // Ulo≈æ√≠me nov√Ω stav
        }
    }
    function changeMonth() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const selectedMonth = parseInt(monthSelect.value);
        if (currentMonth !== selectedMonth) {
            currentMonth = selectedMonth;
            localStorage.setItem('currentMonth', currentMonth.toString());
            loadFromLocalStorage(); // Naƒç√≠ta d√°ta pre nov√Ω mesiac
            if (auth.currentUser) { setupFirestoreListener(); } // Resetne listener pre nov√Ω mesiac
        }
    }
    function changeYear() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const selectedYear = parseInt(yearSelect.value);
        if (currentYear !== selectedYear) {
            currentYear = selectedYear;
            localStorage.setItem('currentYear', currentYear.toString());
            loadFromLocalStorage(); // Naƒç√≠ta d√°ta pre nov√Ω rok
            if (auth.currentUser) { setupFirestoreListener(); } // Resetne listener pre nov√Ω rok
        }
    }
    function handleMonthYearChange() { /* T√°to funkcia u≈æ nie je potrebn√°, logika je v changeMonth/changeYear */ }
    function getDaysInMonth(month) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        if (month === undefined || month === null || currentYear === undefined || currentYear === null || isNaN(month) || isNaN(currentYear)) {
             console.warn("getDaysInMonth: Ch√Ωba alebo je neplatn√Ω mesiac/rok, vraciam 31.", month, currentYear);
             return 31;
        }
        // Vr√°ti poƒçet dn√≠ pre mesiac (0=Jan, 11=Dec) v danom roku
        return new Date(currentYear, month + 1, 0).getDate();
    }
    function getMonthName(month) { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const monthNames = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
        return monthNames[month] || 'Nezn√°my';
    }
    function updateDataSize() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
         try {
             let totalBytes = 0;
             for (let i = 0; i < localStorage.length; i++) {
                 const key = localStorage.key(i);
                 const value = localStorage.getItem(key);
                 totalBytes += (key ? key.length : 0) * 2; // Odhad veƒækosti kƒæ√∫ƒça (UTF-16)
                 totalBytes += (value ? value.length : 0) * 2; // Odhad veƒækosti hodnoty (UTF-16)
             }
             const kilobytes = (totalBytes / 1024).toFixed(2);
             const percentageUsed = Math.min(((totalBytes / MAX_DATA_SIZE) * 100), 100);
             dataSizeText.textContent = `Lok√°lne √∫lo≈æisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
             dataSizeFill.style.width = `${percentageUsed}%`;
             if (percentageUsed > 90) { dataSizeFill.style.backgroundColor = '#f44336'; }
             else if (percentageUsed > 70) { dataSizeFill.style.backgroundColor = '#ff9800'; }
             else { dataSizeFill.style.backgroundColor = '#4CAF50'; }
         } catch (error) {
             console.error("Chyba pri v√Ωpoƒçte veƒækosti localStorage:", error);
             dataSizeText.textContent = "Chyba pri v√Ωpoƒçte veƒækosti d√°t.";
         }
     }
    function toggleDarkMode() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        const isDarkMode = document.body.classList.toggle('dark-mode');
        applyDarkMode(isDarkMode);
        localStorage.setItem('darkMode', JSON.stringify(isDarkMode)); // Ulo≈æ√≠me zmenu
        if (auth.currentUser) {
            // Ulo≈æ√≠me len zmenu dark mode do Firebase (ak chceme)
            // saveToFirebase(); // Toto by ulo≈æilo v≈°etky d√°ta, mo≈æno chceme len nastavenie?
             const userDocRef = db.collection("users").doc(auth.currentUser.uid).collection("calculatorData").doc(`${currentYear}-${currentMonth}`);
             userDocRef.set({ darkMode: isDarkMode }, { merge: true })
                .catch(err => console.error("Chyba pri ukladan√≠ dark mode do Firebase:", err));
        }
    }

    // ============================================================
    // === 17) Z√°lohovanie a obnova (.xlsx) - OPRAVEN√Å VERZIA    ===
    // ============================================================
    function createBackup() {
        // Pou≈æijeme aktu√°lne d√°ta z `monthData` a glob√°lnych premenn√Ωch
        const dataForCurrentMonth = monthData?.[currentYear]?.[currentMonth] || [];

        if (dataForCurrentMonth.length === 0 && !employeeName) {
            showSaveNotification('≈Ωiadne d√°ta na z√°lohu pre tento mesiac.', 'warning');
            return;
        }

        try {
            // Hlaviƒçka a d√°ta dn√≠
            const ws_data = [
                ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Pozn√°mka", "Hrub√° Mzda (‚Ç¨)", "ƒåist√° Mzda (‚Ç¨)"]
            ];

            const daysInMonth = getDaysInMonth(currentMonth);
            for (let i = 0; i < daysInMonth; i++) {
                const dayNum = i + 1;
                const day = dataForCurrentMonth[i] || { start: '', end: '', breakTime: '', note: '' };
                const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayNum}`);
                const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayNum}`);
                // Z√≠skame hodnoty priamo z UI pre presnos≈•, ak existuj√∫
                const grossValue = grossInput ? parseFloat(grossInput.value) : 0;
                const netValue = netInput ? parseFloat(netInput.value) : 0;

                if (day.start || day.end || day.breakTime || day.note) {
                     ws_data.push([
                        `${dayNum}. ${getDayName(currentYear, currentMonth, dayNum)}`,
                        day.start || "",
                        day.end || "",
                        day.breakTime || "",
                        day.note || "",
                        grossValue, // Uklad√°me ƒç√≠slo
                        netValue  // Uklad√°me ƒç√≠slo
                    ]);
                }
            }

            // Pridanie nastaven√≠ pod d√°ta
            ws_data.push(
                [],
                ["Nastavenia:", "Hodnota"],
                ["Hodinov√° mzda", hourlyWage],
                ["Da≈àov√© percento (%)", taxRate * 100],
                ["Meno pracovn√≠ka", employeeName],
                ["Poƒçet desatinn√Ωch miest", decimalPlaces],
                ["Mesiac (1-12)", currentMonth + 1], // Upraven√© pre pou≈æ√≠vateƒæa
                ["Rok", currentYear],
                ["Vytvoren√©", new Date().toLocaleString('sk-SK')]
            );

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // Form√°tovanie
            const mf = `0.00" ‚Ç¨"`;
            const tf = "hh:mm";
            const bf = "0.0";
            const noteIdx = 4;
            const grossIdx = 5;
            const netIdx = 6;

            // N√°jdeme riadok pred sekciou Nastavenia
            const dataEndRow = ws_data.findIndex(r => r.length > 0 && r[0] === "Nastavenia:");
            const lastDataRowIndex = (dataEndRow === -1 ? ws_data.length : dataEndRow) -1; // Index posledn√©ho d√°tov√©ho riadku (0-based)


            for (let R = 1; R <= lastDataRowIndex; ++R) { // Iterujeme cez d√°tov√© riadky (1 a≈æ lastDataRowIndex)
                if (ws[XLSX.utils.encode_cell({ c: 1, r: R })]) ws[XLSX.utils.encode_cell({ c: 1, r: R })].z = tf; // Pr√≠chod
                if (ws[XLSX.utils.encode_cell({ c: 2, r: R })]) ws[XLSX.utils.encode_cell({ c: 2, r: R })].z = tf; // Odchod
                if (ws[XLSX.utils.encode_cell({ c: 3, r: R })]) ws[XLSX.utils.encode_cell({ c: 3, r: R })].z = bf; // Prest√°vka
                 // Mzdy form√°tujeme len ak bunka existuje a obsahuje ƒç√≠slo
                 const grossCellRef = XLSX.utils.encode_cell({ c: grossIdx, r: R });
                 if (ws[grossCellRef] && typeof ws[grossCellRef].v === 'number') ws[grossCellRef].z = mf;
                 const netCellRef = XLSX.utils.encode_cell({ c: netIdx, r: R });
                 if (ws[netCellRef] && typeof ws[netCellRef].v === 'number') ws[netCellRef].z = mf;
            }

            // ≈†√≠rky stƒ∫pcov
            ws['!cols'] = [
                { wch: 15 }, { wch: 8 }, { wch: 8 }, { wch: 10 },
                { wch: 30 }, // Pozn√°mka
                { wch: 14 }, { wch: 14 }
            ];
             if (dataEndRow !== -1) { // Ak sme na≈°li sekciu nastaven√≠
                 ws['!cols'][0].wch = Math.max(ws['!cols'][0].wch, 25); // Roz≈°√≠rime prv√Ω stƒ∫pec
             }

            XLSX.utils.book_append_sheet(wb, ws, `V√Ωkaz ${getMonthName(currentMonth)} ${currentYear}`);

            const safeEmployeeName = (employeeName || 'Nezadane').replace(/[^a-zA-Z0-9_]/g, '_');
            const userFriendlyMonthName = getMonthName(currentMonth);
            const filename = `Zaloha_BrunoCalc_${safeEmployeeName}_${userFriendlyMonthName}_${currentYear}.xlsx`;

            XLSX.writeFile(wb, filename);
            showSaveNotification('Z√°loha (.xlsx) vytvoren√°.');

        } catch (err) {
            console.error("Chyba pri vytv√°ran√≠ .xlsx z√°lohy:", err);
            showSaveNotification(`Chyba pri vytv√°ran√≠ z√°lohy: ${err.message}`, 'error');
        }
    }

    function restoreBackup() {
        if (typeof XLSX === 'undefined') {
             showSaveNotification("Chyba: Kni≈ænica XLSX nie je naƒç√≠tan√°.", 'error');
             console.error("XLSX library is not defined.");
             return;
        }

        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel';

        fileInput.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true, cellNF: true });

                    const firstSheetName = workbook.SheetNames[0];
                    if (!firstSheetName) throw new Error("Zo≈°it neobsahuje ≈æiadne h√°rky.");

                    const worksheet = workbook.Sheets[firstSheetName];
                    const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", raw: false });

                    const headerIndex = rows.findIndex(r => r && r.some(cell => cell?.toString().toLowerCase().includes("de≈à")));
                    if (headerIndex === -1) throw new Error("Nepodarilo sa n√°js≈• hlaviƒçku tabuƒæky ('De≈à'). Skontrolujte form√°t s√∫boru.");

                    const headerRow = rows[headerIndex];
                    const findColIdx = (headers, keywords) => {
                         const lowerKeywords = keywords.map(k => k.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""));
                         for (let i = 0; i < headers.length; i++) {
                             if (headers[i]) {
                                 const lowerHeader = headers[i].toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                                 if (lowerKeywords.some(kw => lowerHeader.includes(kw))) {
                                     return i;
                                 }
                             }
                         }
                         return -1;
                    };

                    const dayColIdx = findColIdx(headerRow, ["de≈à", "den"]);
                    const startColIdx = findColIdx(headerRow, ["pr√≠chod", "prichod"]);
                    const endColIdx = findColIdx(headerRow, ["odchod"]);
                    const breakColIdx = findColIdx(headerRow, ["prest√°vka", "prestavka"]);
                    const noteColIdx = findColIdx(headerRow, ["pozn√°mka", "poznamka"]);

                    if ([dayColIdx, startColIdx, endColIdx, breakColIdx].includes(-1)) {
                         throw new Error("V hlaviƒçke ch√Ωbaj√∫ povinn√© stƒ∫pce (De≈à, Pr√≠chod, Odchod, Prest√°vka).");
                    }

                    const daysInTargetMonth = getDaysInMonth(currentMonth);
                    const targetMonthArray = Array.from({ length: daysInTargetMonth }, () => ({
                         start: "", end: "", breakTime: "", note: "", noteVisible: false // Zatvoren√© pozn√°mky
                    }));
                    let currentRowIndex = headerIndex + 1;
                    let rowsProcessed = 0;

                    for (; currentRowIndex < rows.length; currentRowIndex++) {
                        const row = rows[currentRowIndex];
                        if (!row || row.length === 0 || (row[0] && row[0].toString().toLowerCase().includes("nastavenia"))) break;

                        const dayStr = row[dayColIdx]?.toString();
                        const dayMatch = dayStr ? dayStr.match(/^(\d+)\.?/) : null;
                        const dayNum = dayMatch ? parseInt(dayMatch[1]) : 0;

                        if (dayNum >= 1 && dayNum <= daysInTargetMonth) {
                            const targetIndex = dayNum - 1;
                            let dayData = { start: "", end: "", breakTime: "", note: "", noteVisible: false }; // V≈ædy false na zaƒçiatku

                            let startTime = row[startColIdx]?.toString() || "";
                            let endTime = row[endColIdx]?.toString() || "";
                            let breakTimeStr = row[breakColIdx]?.toString().replace(',', '.') || "";

                            const tryFormatTime = (value) => {
                                if (!isNaN(parseFloat(value)) && parseFloat(value) >= 0 && parseFloat(value) < 1 && !value.includes(':') && value.includes('.')) { // Pridan√° kontrola desatinnej bodky
                                    try {
                                        if (typeof XLSX.SSF !== 'undefined' && XLSX.SSF.format) {
                                            return XLSX.SSF.format('hh:mm', parseFloat(value));
                                        } else {
                                            const totalMinutes = Math.round(parseFloat(value) * 24 * 60);
                                            const hours = Math.floor(totalMinutes / 60);
                                            const minutes = totalMinutes % 60;
                                            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                                        }
                                    } catch { /* Ignorujeme chybu form√°tovania */ }
                                }
                                return value;
                            };

                            startTime = tryFormatTime(startTime);
                            endTime = tryFormatTime(endTime);

                            dayData.start = isTimeValid(startTime) ? startTime : "";
                            dayData.end = isTimeValid(endTime) ? endTime : "";

                            const breakTimeNum = parseFloat(breakTimeStr);
                            dayData.breakTime = (!isNaN(breakTimeNum) && breakTimeNum >= 0) ? breakTimeNum.toString() : "";

                            if (noteColIdx !== -1) {
                               dayData.note = row[noteColIdx]?.toString() || "";
                            }
                            // noteVisible zost√°va false (nastaven√© pri inicializ√°cii dayData)

                            targetMonthArray[targetIndex] = dayData;
                            rowsProcessed++;
                        } else {
                             console.warn(`Restore: Riadok ${currentRowIndex+1} obsahuje neplatn√© ƒç√≠slo d≈àa '${dayStr}' alebo je mimo rozsahu cieƒæov√©ho mesiaca, bude preskoƒçen√Ω.`);
                        }
                    }

                    // Extrakcia nastaven√≠
                    let restoredSettings = {};
                    for (; currentRowIndex < rows.length; currentRowIndex++) {
                        const row = rows[currentRowIndex];
                        if (row && row.length > 1 && row[0]) {
                            const key = row[0].toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                            const value = row[1]?.toString().trim() || "";

                            if (key.includes("hodinova mzda")) restoredSettings.hourlyWage = parseFloat(value.replace(',', '.')) || undefined;
                            else if (key.includes("danove percento")) restoredSettings.taxRatePercent = parseFloat(value.replace(',', '.').replace('%', '')) || undefined;
                            else if (key.includes("meno pracovnika")) restoredSettings.employeeName = value || undefined;
                            else if (key.includes("pocet desatinnych miest")) restoredSettings.decimalPlaces = parseInt(value) || undefined;
                        }
                    }

                    if (!confirm(`Naozaj chcete obnovi≈• d√°ta (${rowsProcessed} dn√≠) a nastavenia z tohto s√∫boru pre ${getMonthName(currentMonth)} ${currentYear}? Lok√°lne neulo≈æen√© zmeny pre tento mesiac bud√∫ prep√≠san√©.`)) {
                        return;
                    }

                    // Aplik√°cia d√°t a nastaven√≠
                    if (!monthData) monthData = {};
                    if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = targetMonthArray;

                    if (restoredSettings.hourlyWage !== undefined) hourlyWage = restoredSettings.hourlyWage;
                    if (restoredSettings.taxRatePercent !== undefined) taxRate = restoredSettings.taxRatePercent / 100;
                    if (restoredSettings.employeeName !== undefined) employeeName = restoredSettings.employeeName;
                    if (restoredSettings.decimalPlaces !== undefined) decimalPlaces = restoredSettings.decimalPlaces;

                    // Ulo≈æenie do localStorage
                    localStorage.setItem('workDaysData', JSON.stringify(monthData));
                    localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                    localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                    localStorage.setItem('employeeName', JSON.stringify(employeeName));
                    localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));

                    loadFromLocalStorage(); // Znovu naƒç√≠tanie a prekreslenie UI

                    showSaveNotification('Z√°loha (.xlsx) √∫spe≈°ne obnoven√° a aplikovan√°.');

                    if (auth.currentUser && navigator.onLine) {
                        saveToFirebase();
                    }

                } catch (error) {
                    console.error("Chyba pri obnove .xlsx z√°lohy:", error);
                    showSaveNotification(`Chyba pri spracovan√≠ z√°lohy: ${error.message}`, 'error');
                }
            };

            reader.onerror = (e) => {
                console.error("Chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy:", e);
                showSaveNotification("Nastala chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy.", 'error');
            };

            reader.readAsArrayBuffer(file);
        };

        fileInput.click();
    }
    // ============================================================
    // === KONIEC SEKCIE Z√ÅLOHOVANIA A OBNOVY (.xlsx)           ===
    // ============================================================

    // 18) Inicializ√°cia - Nezmenen√©
     document.addEventListener('DOMContentLoaded', () => { /* ... (k√≥d funkcie nezmenen√Ω) ... */
        populateYearSelect();
        // Naƒç√≠tame d√°ta/nastavenia hneƒè po naƒç√≠tan√≠ DOM, e≈°te pred overen√≠m stavu prihl√°senia
        loadFromLocalStorage(); // T√Ωm zabezpeƒç√≠me, ≈æe aj neprihl√°sen√Ω pou≈æ√≠vateƒæ uvid√≠ posledn√© lok√°lne d√°ta
        const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        applyDarkMode(darkMode);
        updateWelcomeMessage(); // Zobraz√≠ pozdrav, ak je meno ulo≈æen√©

        if ('serviceWorker' in navigator) {
             window.addEventListener('load', () => {
                 navigator.serviceWorker.register('./service-worker.js')
                     .then(registration => { console.log('ServiceWorker Registration successful with scope: ', registration.scope); })
                     .catch(error => { console.error('ServiceWorker Registration failed: ', error); });
             });
        } else {
             console.warn("Service Worker nie je podporovan√Ω v tomto prehliadaƒçi.");
        }
     });
     function populateYearSelect() { /* ... (k√≥d funkcie nezmenen√Ω) ... */
         const startYear = 2020; const endYear = new Date().getFullYear() + 2;
         yearSelect.innerHTML = '';
         for (let year = startYear; year <= endYear; year++) {
             const option = document.createElement('option');
             option.value = year; option.textContent = year;
             yearSelect.appendChild(option);
         }
         // Nastav√≠me rok a≈æ po naƒç√≠tan√≠ z localStorage v loadFromLocalStorage alebo onAuthStateChanged
     }

  </script>
</body>
</html>
