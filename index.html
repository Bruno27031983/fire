<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Bruno's Calculator + Firebase</title>

  <!-- PWA + font -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <!-- ŠTÝLY – iba to podstatné, zvyšok nebol menený -->
  <style>
    body{font-family:Roboto,Arial,Helvetica,sans-serif;margin:0;padding:10px;background:#f4f4f4;color:#333}
    .container{max-width:1200px;margin:auto;background:#fff;padding:15px;border-radius:5px;box-shadow:0 0 10px rgba(0,0,0,.1);position:relative}
    .settings{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
    .settings>div{flex:1 1 200px}
    .btn{width:100%;padding:12px;border:0;border-radius:5px;font-size:16px;color:#fff;cursor:pointer}
    .reset-btn{background:#f44336}.export-btn{background:#4caf50}.restore-btn{background:#9c27b0}.backup-btn{background:#ffa500}
    table{width:100%;border-collapse:collapse;min-width:800px;margin-bottom:20px}
    th,td{border:1px solid #ddd;padding:8px;font-size:14px;text-align:left}
    th{background:#f2f2f2}
    input[type=tel],input[type=number],input[type=text]{width:100%;padding:5px;box-sizing:border-box;background:#ffffd0;border:1px solid #ccc;border-radius:3px}
    #loading-container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#fff;z-index:9999;transition:opacity .4s}
    #loading-container.hidden{opacity:0;pointer-events:none}
    #saveNotification{position:fixed;bottom:20px;right:20px;padding:10px 20px;border-radius:5px;display:none;color:#fff;background:#4caf50;z-index:999}
    #saveNotification.show{display:block}
    /* …ďalšie existujúce štýly ostávajú nezmenené… */
  </style>
</head>
<body>
<div id="loading-container"><h2>⏳ Načítavam…</h2></div>

<!-- AUTH -->
<div id="auth-container" style="display:none">
  <h1>Prihlásenie / Registrácia</h1>
  <div id="auth-message">Žiadny používateľ nie je prihlásený.</div>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Heslo">
  <button class="btn export-btn" onclick="login()">Prihlásiť sa</button>
  <hr>
  <input type="email" id="registerEmail" placeholder="Nový email">
  <input type="password" id="registerPassword" placeholder="Nové heslo">
  <button class="btn backup-btn" onclick="register()">Registrovať</button>
  <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
</div>

<!-- KALKULAČKA -->
<div id="calculator-container" class="container" style="display:none">
  <div class="autor-info">Vytvoril Bruno</div>
  <h1>Bruno's Calculator</h1>
  <h2 id="welcomeMessage"></h2>

  <div class="settings">
    <div><label>Meno: <input id="employeeNameInput" oninput="updateEmployeeName()"></label></div>
    <div><label>Mzda €: <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()"></label></div>
    <div><label>Daň %: <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()"></label></div>
    <div><label>Mesiac: <select id="monthSelect" onchange="changeMonth()"></select></label></div>
    <div><label>Rok: <select id="yearSelect" onchange="changeYear()"></select></label></div>
    <div><label>Desatiny: <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()"><option>1</option><option>2</option></select></label></div>
    <button class="btn backup-btn" onclick="toggleDarkMode()">Tmavý režim</button>
  </div>

  <div class="table-container">
    <table>
      <thead><tr><th>Deň</th><th>Príchod</th><th>Odchod</th><th>Prestávka</th><th>Odpracované</th><th>Hrubá</th><th>Čistá</th><th></th></tr></thead>
      <tbody id="workDays"></tbody>
    </table>
  </div>

  <div id="totalSalary"></div>

  <div class="btn-container">
    <button class="btn reset-btn"  onclick="resetAll()">Reset mesiaca</button>
    <button class="btn export-btn" onclick="exportToPDF()">Export PDF</button>
    <button class="btn export-btn" onclick="sendPDF()">Zdieľaj PDF</button>
    <button class="btn restore-btn" onclick="restoreBackup()">Obnov zálohu</button>
    <button class="btn backup-btn"  onclick="createBackup()">Zálohuj</button>
    <button class="btn reset-btn"  onclick="logout()">Odhlásiť</button>
  </div>
</div>

<div id="saveNotification"></div>

<script>
/* ---------- Firebase init ---------- */
const firebaseConfig={
  apiKey:"AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo",
  authDomain:"bruno-3cee2.firebaseapp.com",
  projectId:"bruno-3cee2",
  storageBucket:"bruno-3cee2.appspot.com",
  messagingSenderId:"155545319308",
  appId:"1:155545319308:web:5da498ff1cd3e1833888a9"
};
firebase.initializeApp(firebaseConfig);
try{firebase.appCheck().activate("6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv",true);}catch(e){}

const db=firebase.firestore();
const auth=firebase.auth();
db.enablePersistence().catch(()=>{});

/* ---------- Globálne premenné ---------- */
let currentMonth,currentYear,hourlyWage=10,taxRate=0.02,decimalPlaces=1,employeeName="";
let monthData={};
const workDays=document.getElementById("workDays");
const hourlyWageInput=document.getElementById("hourlyWageInput");
const taxRateInput=document.getElementById("taxRateInput");

/* ---------- Pomocné ---------- */
const debounce=(f,t)=>{let id;return(...a)=>{clearTimeout(id);id=setTimeout(()=>f(...a),t)}}
const showNotif=(msg,cls="")=>{
  const n=document.getElementById("saveNotification");
  n.textContent=msg;n.className="show"+(cls?` ${cls}`:"");
  setTimeout(()=>n.className="",3000);
}
const getMonthName=m=>["Január","Február","Marec","Apríl","Máj","Jún","Júl","August","September","Október","November","December"][m];

/* ---------- Inicializácia (offline‑first) ---------- */
document.addEventListener("DOMContentLoaded",()=>{
  populateYearSelect();
  loadLocalBasics();            // okamžite vykreslí tabuľku z localStorage
  if(!navigator.onLine){        // ak je offline, hneď zobraz kalkulačku
    document.getElementById("loading-container").classList.add("hidden");
    document.getElementById("calculator-container").style.display="block";
  }
  // Service‑worker pre PWA
  if("serviceWorker"in navigator)navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
});

/* ---------- Auth listener ---------- */
auth.onAuthStateChanged(user=>{
  document.getElementById("loading-container").classList.add("hidden");
  if(user){
    document.getElementById("auth-container").style.display="none";
    document.getElementById("calculator-container").style.display="block";
    loadLocalBasics();          // po prihlásení znova načíta lokálne
    setupFirestoreListener();   // a zapojí realtime sync
  }else{
    document.getElementById("auth-container").style.display="block";
    document.getElementById("calculator-container").style.display="none";
  }
});

/* ---------- Lokálne načítanie + UI ---------- */
function loadLocalBasics(){
  currentMonth = +localStorage.getItem("currentMonth") || new Date().getMonth();
  currentYear  = +localStorage.getItem("currentYear")  || new Date().getFullYear();
  hourlyWage   = +localStorage.getItem("hourlyWage")   || 10;
  taxRate      = (+localStorage.getItem("taxRate")||2)/100;
  decimalPlaces= +localStorage.getItem("decimalPlaces")||1;
  employeeName = localStorage.getItem("employeeName")||"";

  document.getElementById("monthSelect").value=currentMonth;
  document.getElementById("yearSelect").value=currentYear;
  hourlyWageInput.value=hourlyWage;
  taxRateInput.value=taxRate*100;
  document.getElementById("decimalPlacesSelect").value=decimalPlaces;
  document.getElementById("employeeNameInput").value=employeeName;

  monthData=JSON.parse(localStorage.getItem("workDaysData")||"{}");
  createTable();
  renderDays();
  calcTotals();
  updateWelcome();
}

/* ---------- Tabuľka ---------- */
function createTable(){
  workDays.innerHTML="";
  const d=new Date(currentYear,currentMonth+1,0).getDate();
  for(let i=1;i<=d;i++){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>Deň ${i}</td>
    <td><input type="tel" id="st-${i}" maxlength="5" placeholder="HH:MM" oninput="onTime(this,${i})"></td>
    <td><input type="tel" id="et-${i}" maxlength="5" placeholder="HH:MM" oninput="onTime(this,${i})"></td>
    <td><input type="number" id="br-${i}" min="0" step="0.5" placeholder="h" oninput="onBreak(${i})"></td>
    <td id="tt-${i}">0h 0m (0.0)</td>
    <td><input id="gr-${i}" readonly></td>
    <td><input id="nt-${i}" readonly></td>
    <td><button class="btn reset-btn" onclick="resetRow(${i})">×</button></td>`;
    workDays.appendChild(tr);
  }
}
function renderDays(){
  const arr=monthData[currentYear]?.[currentMonth]||[];
  arr.forEach((d,idx)=>{
    if(d){document.getElementById(`st-${idx+1}`).value=d.start||"";
         document.getElementById(`et-${idx+1}`).value=d.end||"";
         document.getElementById(`br-${idx+1}`).value=d.breakTime||"";calcRow(idx+1);}
  });
}

/* ---------- Vstupy ---------- */
function onTime(el,i){formatTime(el);saveDay(i);calcRow(i);debouncedSave();}
function onBreak(i){saveDay(i);calcRow(i);debouncedSave();}
const debouncedSave=debounce(saveAll,400);
function formatTime(el){let v=el.value.replace(/[^\d:]/g,"");if(v.length===4&&!v.includes(":"))v=v.slice(0,2)+":"+v.slice(2);if(v.length>5)v=v.slice(0,5);el.value=v;}
function saveDay(i){
  if(!monthData[currentYear])monthData[currentYear]={};
  if(!monthData[currentYear][currentMonth])monthData[currentYear][currentMonth]=[];
  const arr=monthData[currentYear][currentMonth];
  while(arr.length<i)arr.push({});
  arr[i-1]={
    start:document.getElementById(`st-${i}`).value,
    end:document.getElementById(`et-${i}`).value,
    breakTime:document.getElementById(`br-${i}`).value
  };
}

/* ---------- Výpočet riadku ---------- */
function calcRow(i){
  const s=document.getElementById(`st-${i}`).value;
  const e=document.getElementById(`et-${i}`).value;
  const br=+document.getElementById(`br-${i}`).value||0;
  if(!/\\d{2}:\\d{2}/.test(s)||!/\\d{2}:\\d{2}/.test(e)){document.getElementById(`tt-${i}`).textContent="–";return;}
  const [sh,sm]=s.split(":").map(Number),[eh,em]=e.split(":").map(Number);
  let mins=eh*60+em-(sh*60+sm);if(mins<0)mins+=24*60;mins=Math.max(0,mins-br*60);
  const dec=mins/60,h=Math.floor(mins/60),m=mins%60;
  document.getElementById(`tt-${i}`).textContent=`${h}h ${m}m (${dec.toFixed(decimalPlaces)})`;
  const gross=dec*hourlyWage,net=gross*(1-taxRate);
  document.getElementById(`gr-${i}`).value=gross.toFixed(2);
  document.getElementById(`nt-${i}`).value=net.toFixed(2);
  calcTotals();
}

/* ---------- Celkové súčty ---------- */
function calcTotals(){
  let mins=0,days=0;
  [...workDays.querySelectorAll("tr")].forEach((tr,idx)=>{
    const s=document.getElementById(`st-${idx+1}`).value;
    const e=document.getElementById(`et-${idx+1}`).value;
    const br=+document.getElementById(`br-${idx+1}`).value||0;
    if(/\\d{2}:\\d{2}/.test(s)&&/\\d{2}:\\d{2}/.test(e)){
      const [sh,sm]=s.split(":").map(Number),[eh,em]=e.split(":").map(Number);
      let m=eh*60+em-(sh*60+sm);if(m<0)m+=24*60;m=Math.max(0,m-br*60);
      mins+=m;if(m)days++;
    }
  });
  const dec=mins/60,gross=dec*hourlyWage,net=gross*(1-taxRate);
  document.getElementById("totalSalary").innerHTML=
    `Dní: <b>${days}</b> &nbsp; Celkom: <b>${Math.floor(mins/60)}h ${mins%60}m (${dec.toFixed(decimalPlaces)})</b><br>
     Čistá mzda: <b>${net.toFixed(2)} €</b>`;
}

/* ---------- Ukladanie ---------- */
function saveAll(){
  localStorage.setItem("currentMonth",currentMonth);
  localStorage.setItem("currentYear",currentYear);
  localStorage.setItem("hourlyWage",hourlyWage);
  localStorage.setItem("taxRate",taxRate*100);
  localStorage.setItem("decimalPlaces",decimalPlaces);
  localStorage.setItem("employeeName",employeeName);
  localStorage.setItem("workDaysData",JSON.stringify(monthData));
  showNotif("Uložené lokálne");
  if(auth.currentUser)pushToFirestore();
}
function pushToFirestore(){
  db.doc(`users/${auth.currentUser.uid}/calculatorData/${currentYear}-${currentMonth}`)
    .set({
      days:monthData[currentYear]?.[currentMonth]||[],
      hourlyWage,taxRate:taxRate*100,decimalPlaces,employeeName,
      darkMode:document.body.classList.contains("dark-mode"),
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>showNotif("Synchro OK")).catch(e=>showNotif("Firebase chyba","error"));
}

/* ---------- Firestore listener (online) ---------- */
function setupFirestoreListener(){
  const uid=auth.currentUser.uid;
  const ref=db.doc(`users/${uid}/calculatorData/${currentYear}-${currentMonth}`);
  ref.get({source:"cache"}).then(s=>s.exists&&applyRemote(s.data()));
  ref.onSnapshot(s=>s.exists&&applyRemote(s.data()));
}
function applyRemote(d){
  monthData[currentYear]={...[monthData[currentYear]], [currentMonth]:d.days||[] };
  hourlyWage=d.hourlyWage??hourlyWage;
  taxRate=(d.taxRate??taxRate*100)/100;
  decimalPlaces=d.decimalPlaces??decimalPlaces;
  employeeName=d.employeeName??employeeName;
  document.getElementById("hourlyWageInput").value=hourlyWage;
  document.getElementById("taxRateInput").value=taxRate*100;
  document.getElementById("decimalPlacesSelect").value=decimalPlaces;
  document.getElementById("employeeNameInput").value=employeeName;
  createTable();renderDays();calcTotals();updateWelcome();
  saveAll();                     // zapíš aj do localStorage
}

/* ---------- Ďalšie obslužné ---------- */
function populateYearSelect(){
  const y=document.getElementById("yearSelect");
  const cur=new Date().getFullYear();
  for(let i=2020;i<=cur+2;i++)y.innerHTML+=`<option>${i}</option>`;
}
function changeMonth(){currentMonth=+document.getElementById("monthSelect").value;createTable();renderDays();calcTotals();saveAll();setupFirestoreListener();}
function changeYear(){currentYear=+document.getElementById("yearSelect").value;createTable();renderDays();calcTotals();saveAll();setupFirestoreListener();}
function changeDecimalPlaces(){decimalPlaces=+document.getElementById("decimalPlacesSelect").value;calcTotals();saveAll();}
function updateSettings(){hourlyWage=+hourlyWageInput.value||0;taxRate=(+taxRateInput.value||0)/100;calcTotals();saveAll();}
function updateEmployeeName(){employeeName=document.getElementById("employeeNameInput").value;updateWelcome();saveAll();}
function updateWelcome(){const first=employeeName.trim().split(" ")[0]||"";document.getElementById("welcomeMessage").textContent=first?`Vitaj, ${first}!`:"";}

/* ---------- Reset/Záloha/Export – pôvodné funkcie ostávajú, skrátené pre prehľad ---------- */
function resetRow(i){document.getElementById(`st-${i}`).value='';document.getElementById(`et-${i}`).value='';document.getElementById(`br-${i}`).value='';saveDay(i);calcRow(i);saveAll();}
function resetAll(){if(confirm("Vymazať celý mesiac?")){monthData[currentYear][currentMonth]=[];createTable();calcTotals();saveAll();}}
function exportToPDF(){/* …pôvodný exportToPDF… */}
function sendPDF(){/* …pôvodný sendPDF… */}
function createBackup(){/* …pôvodná createBackup… */}
function restoreBackup(){/* …pôvodná restoreBackup… */}

/* ---------- Auth helpers ---------- */
function register(){auth.createUserWithEmailAndPassword(registerEmail.value,registerPassword.value).then(()=>alert("Registrácia OK")).catch(e=>alert(e.message))}
function login(){auth.signInWithEmailAndPassword(loginEmail.value,loginPassword.value).catch(e=>alert(e.message))}
function logout(){auth.signOut();}
function forgotPassword(){const em=loginEmail.value;if(em)auth.sendPasswordResetEmail(em).then(()=>alert("Mail odoslaný")).catch(e=>alert(e.message));}
function toggleDarkMode(){const on=!document.body.classList.toggle("dark-mode");localStorage.setItem("darkMode",!on);}

/* ---------- Service‑worker in‑page fallback (ak nemáš vlastný súbor) ---------- */
// (nepovinné – stačí ak máš service-worker.js v koreňovom priečinku)
</script>
</body>
</html>
