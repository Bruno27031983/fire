<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF a autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- ZAƒåIATOK CSS ≈†T√ùLOV --- */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; transition: background-color 0.3s, color 0.3s; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; transition: background-color 0.3s, color 0.3s; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .settings > div, .settings > details, .settings > button { flex: 1 1 200px; margin: 0; }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 900px; /* Upraven√° celkov√° min ≈°√≠rka */ }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }

    /* --- ≈†√çRKY STƒπPCOV --- */
    /* !!! TU SA MEN√ç ≈†√çRKA PRV√âHO STƒπPCA (De≈à) !!! */
    th:nth-child(1), td:nth-child(1) { min-width: 60px; } /* De≈à - Z√ö≈ΩEN√â */
    /* Ostatn√© ≈°√≠rky */
    th:nth-child(2), td:nth-child(2) { min-width: 80px; } /* Pr√≠chod */
    th:nth-child(3), td:nth-child(3) { min-width: 80px; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* Prest√°vka */
    th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* Odpracovan√© */
    th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* Hrub√° Mzda */
    th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* ƒåist√° Mzda */
    th:nth-child(8), td:nth-child(8) { min-width: 120px; } /* Pozn√°mka */
    th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia */
    /* --- KONIEC ≈†√çROK STƒπPCOV --- */

    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease, color 0.3s; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; } /* Tlaƒçidlo pre login/dark mode */
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; transition: background-color 0.3s; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2 !important; color: white !important; } /* !important pre prioritu */
    .current-day input, .current-day .note-textarea, .current-day .toggle-note-btn { background-color: #9932cc !important; color: white !important; border-color: #c57eed !important; }
    .current-day .toggle-note-btn:hover { background-color: #7a28a3 !important; } /* Hover pre current day note button */
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }

    /* Dark Mode */
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    body.dark-mode .container { background-color: #444; color: #f4f4f4; }
    body.dark-mode table { background-color: #555; color: #f4f4f4; }
    body.dark-mode th { background-color: #666; border-color: #777; }
    body.dark-mode td { background-color: #444; color: #f4f4f4; border-color: #555; }
    body.dark-mode input[type="tel"], body.dark-mode input[type="number"], body.dark-mode input[type="text"], body.dark-mode select, body.dark-mode .note-textarea { background-color: #666; color: white; border-color: #888; }
    body.dark-mode .btn:not(.highlight) { color: white; } /* Ostatn√© tlaƒçidl√° maj√∫ biely text */
    body.dark-mode .highlight { background-color: #e6c300; color: #222; border-color: #e6c300;} /* Tmav≈°√≠ highlight v dark mode */
    body.dark-mode .reset-btn { background-color: #c62828; } body.dark-mode .reset-btn:hover { background-color: #a32121; }
    body.dark-mode .export-btn { background-color: #2e7d32; } body.dark-mode .export-btn:hover { background-color: #1b5e20; }
    body.dark-mode .restore-btn { background-color: #6a1b9a; } body.dark-mode .restore-btn:hover { background-color: #4a148c; }
    body.dark-mode .backup-btn { background-color: #ef6c00; } body.dark-mode .backup-btn:hover { background-color: #cc5c00; }
    body.dark-mode #totalSalary { background-color: #2c3e50; }
    body.dark-mode .current-day { background-color: #4a0e8f !important; color: #fff !important; }
    body.dark-mode .current-day input, body.dark-mode .current-day .note-textarea, body.dark-mode .current-day .toggle-note-btn { background-color: #5c1db3 !important; color: #fff !important; border-color: #8e5ccf !important; }
    body.dark-mode .current-day .toggle-note-btn:hover { background-color: #4a148c !important; }
    body.dark-mode .autor-info { color: #aaa; }
    body.dark-mode h2 { color: #ccc; }
    body.dark-mode #dataSizeText { color: #bbb; }
    body.dark-mode #dataSizeBar { background-color: #555; }

    /* Auth Modal */
    #auth-modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 9990; }
    #auth-container { /* Teraz ako modal */ display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; max-width: 400px; width: 90%; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); text-align: center; }
    #auth-container h1 { font-size: 1.8em; margin-bottom: 15px; background: none; /* Odstr√°ni≈• gradient z modalu */ color: #333; animation: none; }
    #auth-container h2 { font-size: 1.1em; color: #444; margin-top: 15px; margin-bottom: 5px; }
    #auth-container input { width: calc(100% - 22px); /* Lep≈°ie zarovnanie */ padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; }
    #auth-container button { width: 100%; padding: 12px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
    #auth-container button:hover { background-color: #45a049; }
    #auth-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #888; line-height: 1; padding: 0; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }
    body.dark-mode #auth-container { background-color: #444; color: #f4f4f4; } /* Dark mode pre modal */
    body.dark-mode #auth-container h1 { color: #f4f4f4; }
    body.dark-mode #auth-container h2 { color: #ccc; }
    body.dark-mode #auth-container input { background-color: #666; color: white; border-color: #888; }
    body.dark-mode #auth-container button { background-color: #2e7d32; }
    body.dark-mode #auth-container button:hover { background-color: #1b5e20; }
    body.dark-mode #auth-close-btn { color: #bbb; }
    body.dark-mode #forgot-password-link { color: #4dabf7; }

    /* Notifik√°cia a Loading */
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 12px 25px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease, transform 0.3s ease-out; transform: translateY(20px); }
    #saveNotification.show { display: block; opacity: 1; transform: translateY(0); }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-container h1 { font-size: 1.5em; text-align: center; padding: 20px; max-width: 80%; background: none; color: #555; animation: none; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }
    body.dark-mode #loading-container { background-color: #333; } /* Dark mode pre loading */
    body.dark-mode #loading-container h1 { color: #ccc; }

    /* Collapsible settings */
    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
    .collapsible-settings summary:hover { background-color: #eee; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
    body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
    body.dark-mode .collapsible-content { border-top-color: #666; }

    /* Pozn√°mky */
    .note-container { display: none; margin-top: 5px; }
    .note-container.visible { display: block; }
    .note-textarea { width: 95%; min-height: 40px; resize: vertical; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; background-color: #f0f0f0; }
    .toggle-note-btn { background-color: #6c757d; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease; margin-bottom: 2px; display: inline-block; /* Aby bol vedƒæa textu */ }
    .toggle-note-btn:hover { background-color: #5a6268; }
    body.dark-mode .note-textarea { background-color: #555; color: #f4f4f4; border-color: #777; }
    body.dark-mode .toggle-note-btn { background-color: #828a91; }
    body.dark-mode .toggle-note-btn:hover { background-color: #70777d; }
    /* --- KONIEC CSS ≈†T√ùLOV --- */
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-container"><h1> Naƒç√≠tavam Bruno's Calculator... </h1></div>

  <!-- Auth Modal (skryt√Ω) -->
  <div id="auth-modal-backdrop" onclick="hideAuthModal()"></div>
  <div id="auth-container">
    <button id="auth-close-btn" onclick="hideAuthModal()">√ó</button>
    <h1>Prihl√°senie / Registr√°cia</h1>
    <div id="auth-message">Zadajte svoje √∫daje pre ukladanie a synchroniz√°ciu d√°t.</div>
    <div id="auth-forms">
      <h2>Registr√°cia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="registerAndClose()">Registrova≈•</button>
      <h2>Prihl√°senie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="loginAndClose()">Prihl√°si≈• sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>

  <!-- Hlavn√Ω kontajner kalkulaƒçky (viditeƒæn√Ω hneƒè) -->
  <div id="calculator-container" class="container">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2> <!-- Pozdrav sa napln√≠ dynamicky -->

    <!-- Stav prihl√°senia a ovl√°dacie prvky -->
    <div id="auth-status-container" style="text-align: center; margin-bottom: 15px; padding: 8px; background-color: #eee; border-radius: 4px;">
        <span id="auth-status-message">Pou≈æ√≠vate aplik√°ciu anonymne.</span>
        <button id="login-register-btn" class="btn highlight" onclick="showAuthModal()" style="padding: 5px 10px; font-size: 14px; margin-left: 10px; display: inline-block; width: auto;">Prihl√°si≈• / Registrova≈•</button>
        <button id="logout-btn-inline" class="btn reset-btn" onclick="logout()" style="padding: 5px 10px; font-size: 14px; margin-left: 10px; display: none; width: auto;">Odhl√°si≈• sa</button>
    </div>
    <!-- Dark mode pre status container -->
     <style> body.dark-mode #auth-status-container { background-color: #555; } </style>


    <div class="settings">
        <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
                <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
                <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
                <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
                <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
            </select>
        </div>
        <details class="collapsible-settings">
            <summary>ƒéal≈°ie nastavenia</summary>
            <div class="collapsible-content">
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka: </label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
                    <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%): </label>
                    <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="yearSelect">Rok: </label>
                    <select id="yearSelect" onchange="changeYear()"></select>
                </div>
                <div>
                    <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
                    <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                        <option value="1">1</option> <option value="2">2</option>
                    </select>
                </div>
            </div>
        </details>
        <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th><th>Pr√≠chod</th><th>Odchod</th><th>Prest√°vka</th><th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th><th>ƒåist√° Mzda (‚Ç¨)</th><th class="th-note">Pozn√°mka</th><th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lok√°lne √∫lo≈æisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetova≈• v≈°etko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈•</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
      <!-- P√¥vodn√© logout tlaƒçidlo tu u≈æ nie je potrebn√© -->
    </div>
  </div>

  <!-- Notifik√°cia -->
  <div id="saveNotification"></div>

  <script>
    // --- ZAƒåIATOK JAVASCRIPTU ---

    // 1. Firebase Config & Init
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktiv√°cii Firebase App Check:", error); }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // 2. Povolenie Firestore Offline Persistence
    db.enablePersistence().then(() => { console.log("Firestore offline persistence povolen√°."); }).catch((err) => { console.error("Firestore offline persistence chyba:", err.code, err.message, err); if (err.code == 'failed-precondition') { console.warn("Firestore offline persistence: Viacn√°sobn√© otvoren√© taby, povolen√© len v jednom."); } else if (err.code == 'unimplemented') { console.error("Firestore offline persistence: Prehliadaƒç nie je podporovan√Ω."); } });

    // 3. Glob√°lne premenn√©
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
    let monthData = {}; // Objekt na ukladanie d√°t pre r√¥zne mesiace/roky
    let firestoreListenerUnsubscribe = null; // Na odhl√°senie listenera

    // Elementy UI
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const MAX_DATA_SIZE = 4 * 1024 * 1024; // 4MB limit pre localStorage
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // 4. Auth Modal Funkcie
    function showAuthModal() {
        document.getElementById('auth-modal-backdrop').style.display = 'block';
        document.getElementById('auth-container').style.display = 'block';
        // Aplikuj dark mode na modal, ak je akt√≠vny
        if (document.body.classList.contains('dark-mode')) {
            document.getElementById('auth-container').classList.add('dark-mode');
        } else {
            document.getElementById('auth-container').classList.remove('dark-mode');
        }
    }

    function hideAuthModal() {
        document.getElementById('auth-modal-backdrop').style.display = 'none';
        document.getElementById('auth-container').style.display = 'none';
    }

    function registerAndClose() {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        if (!email || !password) {
            alert("Pros√≠m, zadajte email aj heslo.");
            return;
        }
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                console.log("Registrovan√Ω:", userCredential.user);
                alert("Registr√°cia √∫spe≈°n√°!");
                hideAuthModal();
            })
            .catch((error) => {
                console.error("Chyba pri registr√°cii:", error.message);
                alert("Chyba pri registr√°cii: " + error.message);
            });
    }

    function loginAndClose() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
         if (!email || !password) {
            alert("Pros√≠m, zadajte email aj heslo.");
            return;
        }
        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                console.log("Prihl√°sen√Ω:", userCredential.user);
                alert("Prihl√°senie √∫spe≈°n√©!");
                hideAuthModal();
            })
            .catch((error) => {
                console.error("Chyba pri prihl√°sen√≠:", error.message);
                alert("Chyba pri prihl√°sen√≠: " + error.message);
            });
    }

    function logout() {
        auth.signOut().then(() => {
            console.log("Odhl√°sen√Ω.");
            showSaveNotification("Odhl√°senie √∫spe≈°n√©."); // Pou≈æi notifik√°ciu namiesto alertu
        }).catch((error) => {
            console.error("Chyba pri odhl√°sen√≠:", error.message);
            showSaveNotification("Chyba pri odhl√°sen√≠: " + error.message, "error");
        });
    }

    function forgotPassword() {
      const emailInput = document.getElementById('loginEmail');
      const email = emailInput.value;
      if (!email) {
        alert("Pros√≠m, zadajte svoju e-mailov√∫ adresu do poƒæa pre prihl√°senie.");
        emailInput.focus();
        return;
      }
      auth.sendPasswordResetEmail(email)
        .then(() => {
          console.log("E-mail na obnovenie hesla odoslan√Ω na:", email);
          alert("Odkaz na obnovenie hesla bol odoslan√Ω na va≈°u e-mailov√∫ adresu. Skontrolujte si pros√≠m po≈°tu (aj prieƒçinok Spam).");
        })
        .catch((error) => {
          console.error("Chyba pri odosielan√≠ e-mailu na obnovenie hesla:", error);
          alert("Chyba pri odosielan√≠ e-mailu na obnovenie hesla: " + error.message);
        });
    }

    // 5. Auth State Change Listener (Kƒæ√∫ƒçov√° logika pre voliteƒæn√© prihl√°senie)
    auth.onAuthStateChanged(user => {
        console.log("onAuthStateChanged: Stav zisten√Ω.", user ? `Pou≈æ√≠vateƒæ: ${user.email}` : "≈Ωiadny pou≈æ√≠vateƒæ.");
        const loadingContainer = document.getElementById('loading-container');
        if (!loadingContainer.classList.contains('hidden')) {
             loadingContainer.classList.add('hidden'); // Skry loading screen, ak e≈°te nebol
        }

        const authStatusMsg = document.getElementById('auth-status-message');
        const loginRegBtn = document.getElementById('login-register-btn');
        const logoutBtnInline = document.getElementById('logout-btn-inline');

        // Odhl√°senie predch√°dzaj√∫ceho listenera
        if (firestoreListenerUnsubscribe) {
            console.log("Odhlasujem predch√°dzaj√∫ci Firestore listener pri zmene Auth stavu.");
            firestoreListenerUnsubscribe();
            firestoreListenerUnsubscribe = null;
        }

        if (user) {
            // --- STAV: PRIHL√ÅSEN√ù ---
            console.log("Pou≈æ√≠vateƒæ prihl√°sen√Ω, nastavujem UI a Firebase sync...");
            authStatusMsg.textContent = `Prihl√°sen√Ω: ${user.email}`;
            loginRegBtn.style.display = 'none';
            logoutBtnInline.style.display = 'inline-block';

            // Aktivuj Firebase listener pre aktu√°lny mesiac/rok
            setupFirestoreListener();

            // Skontroluj/vytvor u≈æ√≠vateƒæsk√Ω dokument v DB
            const uid = user.uid;
            const userDocRef = db.collection("users").doc(uid);
            userDocRef.get().then(userDocSnap => {
                if (!userDocSnap.exists) {
                    userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true })
                        .then(() => console.log("Vytvoren√Ω/aktualizovan√Ω dokument pre:", uid))
                        .catch(err => console.error("Chyba pri vytv√°ran√≠/aktualiz√°cii dokumentu pou≈æ√≠vateƒæa:", err));
                } else { console.log("Dokument pou≈æ√≠vateƒæa existuje:", uid); }
            }).catch(err => { console.error("Chyba pri kontrole dokumentu pou≈æ√≠vateƒæa:", err); });

            // Po prihl√°sen√≠ sk√∫s ulo≈æi≈• aktu√°lny stav (z localStorage) do Firebase.
            // Funkcia saveToLocalStorage u≈æ obsahuje volanie saveToFirebase pre prihl√°sen√Ωch.
            console.log("Sp√∫≈°≈•am saveToLocalStorage() po prihl√°sen√≠ na synchroniz√°ciu lok√°lnych d√°t.");
            saveToLocalStorage();

        } else {
            // --- STAV: NEPRIHL√ÅSEN√ù / ANONYMN√ù ---
            console.log("Pou≈æ√≠vateƒæ odhl√°sen√Ω/neprihl√°sen√Ω. Firebase sync deaktivovan√Ω.");
            authStatusMsg.textContent = "Pou≈æ√≠vate aplik√°ciu anonymne.";
            loginRegBtn.style.display = 'inline-block';
            logoutBtnInline.style.display = 'none';

            // Firestore listener bol odhl√°sen√Ω vy≈°≈°ie.
            // D√°ta z localStorage zost√°vaj√∫ naƒç√≠tan√© a pou≈æ√≠vateƒæ s nimi m√¥≈æe pracova≈•.
        }
         updateWelcomeMessage(); // Aktualizuj pozdrav v oboch pr√≠padoch
    });

    // 6. Utility funkcie
    function debounce(func, wait) { let timeout; return function (...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), wait); }; }
    function showSaveNotification(message, type = 'success') { const notification = document.getElementById('saveNotification'); notification.textContent = message; notification.className = ''; // Reset classes
        requestAnimationFrame(() => { // Force reflow for animation restart
            notification.className = 'show'; // Add show class
             if (type === 'error') { notification.classList.add('error'); }
             else if (type === 'warning') { notification.classList.add('warning'); }
             setTimeout(() => { notification.classList.remove('show'); notification.style.transform = 'translateY(20px)'; }, 3000); // Hide after 3s
             notification.style.transform = 'translateY(0)'; // Trigger show animation
        });
     }
    function getFirstName(fullName) { if (!fullName || typeof fullName !== 'string') { return ''; } const trimmedName = fullName.trim(); if (!trimmedName) { return ''; } const parts = trimmedName.split(' '); return parts[0]; }
    function updateWelcomeMessage() { const welcomeElement = document.getElementById('welcomeMessage'); if (!welcomeElement) return; const firstName = getFirstName(employeeName); if (firstName) { welcomeElement.textContent = `Vitaj sp√§≈•, ${firstName}! üëã`; } else { welcomeElement.textContent = ''; } }


    // 7. Funkcia na nastavenie Firestore Listenera (Vol√° sa len ak je user prihl√°sen√Ω)
    function setupFirestoreListener() {
        if (firestoreListenerUnsubscribe) { console.log("setupFirestoreListener: Odhlasujem existuj√∫ci listener."); firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; }
        const uid = auth.currentUser?.uid; if (!uid) { console.log("setupFirestoreListener: Nikto nie je prihl√°sen√Ω, listener sa nenastavuje."); return; }
        if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) { const now = new Date(); currentMonth = currentMonth ?? now.getMonth(); currentYear = currentYear ?? now.getFullYear(); console.warn("setupFirestoreListener: Ch√Ωba mesiac/rok, pou≈æ√≠vam aktu√°lne."); }
        const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`; const docRef = db.doc(docPath);
        console.log(`setupFirestoreListener: Nastavujem listener pre ${docPath}`);

        firestoreListenerUnsubscribe = docRef.onSnapshot({ includeMetadataChanges: true }, (docSnap) => { // includeMetadataChanges pre lep≈°ie info
            const source = docSnap.metadata.fromCache ? "cache" : "server";
            console.log(`Firestore listener: Prijat√Ω snapshot pre ${docPath} zo zdroja: ${source}. Pending writes: ${docSnap.metadata.hasPendingWrites}`);

            // Ignoruj lok√°lne zmeny pri aktualiz√°cii UI, aby sa neprepisoval pr√°ve editovan√Ω input
            if (docSnap.metadata.hasPendingWrites) {
                console.log("Listener: Detekovan√° lok√°lna zmena (pending write). Preskakujem aktualiz√°ciu UI.");
                 // Voliteƒæne m√¥≈æeme aktualizova≈• monthData aj tak, aby bolo konzistentn√©
                 if (docSnap.exists()) {
                     const data = docSnap.data(); const firebaseDaysData = data.days || [];
                     if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                     monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '', note: day.note || '' }));
                 }
                return;
            }

            if (docSnap.exists()) {
                const data = docSnap.data();
                console.log(`Listener: Dokument ${docPath} existuje (${source}), naƒç√≠tan√© d√°ta:`, data);
                try {
                    // Naƒç√≠taj d√°ta z Firebase
                    const firebaseHourlyWage = data.hourlyWage ?? 10;
                    const firebaseTaxRatePercent = data.taxRate ?? 2;
                    const firebaseDecimalPlaces = data.decimalPlaces ?? 1;
                    const firebaseEmployeeName = data.employeeName ?? '';
                    const firebaseDarkMode = data.darkMode ?? false;
                    const firebaseDaysData = data.days || [];

                    let uiNeedsUpdate = false; // Flag na kontrolu, ƒçi treba vola≈• funkcie na konci

                    // Aktualizuj glob√°lne premenn√© a UI inputy len ak sa l√≠≈°ia A nie s√∫ pr√°ve akt√≠vne
                    if (hourlyWage !== firebaseHourlyWage && document.activeElement !== hourlyWageInput) { hourlyWage = firebaseHourlyWage; hourlyWageInput.value = hourlyWage; uiNeedsUpdate = true; }
                    if (taxRate !== (firebaseTaxRatePercent / 100) && document.activeElement !== taxRateInput) { taxRate = firebaseTaxRatePercent / 100; taxRateInput.value = taxRate * 100; uiNeedsUpdate = true; }
                    if (decimalPlaces !== firebaseDecimalPlaces) { decimalPlaces = firebaseDecimalPlaces; decimalPlacesSelect.value = decimalPlaces; uiNeedsUpdate = true; } // Select m√¥≈æeme meni≈•
                    if (employeeName !== firebaseEmployeeName && document.activeElement !== employeeNameInput) { employeeName = firebaseEmployeeName; employeeNameInput.value = employeeName; updateWelcomeMessage(); uiNeedsUpdate = true; } // Meno aktualizuje aj pozdrav
                    if (document.body.classList.contains('dark-mode') !== firebaseDarkMode) { applyDarkMode(firebaseDarkMode); uiNeedsUpdate = true; } // Dark mode

                    // Porovnaj a aktualizuj monthData a tabuƒæku
                    const currentLocalData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
                    const firebaseDataMapped = firebaseDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '', note: day.note || '' }));

                    // Jednoduch√© porovnanie JSON stringov pre detekciu zmeny v d√°tach dn√≠
                    if (JSON.stringify(currentLocalData) !== JSON.stringify(firebaseDataMapped)) {
                        console.log("Listener: Detekovan√° zmena v d√°tach dn√≠. Aktualizujem monthData a UI tabuƒæky.");
                        if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                        monthData[currentYear][currentMonth] = firebaseDataMapped;

                        // Cielen√° aktualiz√°cia UI tabuƒæky
                        const daysInMonth = getDaysInMonth(currentMonth);
                        const activeElementId = document.activeElement?.id;
                        for (let i = 1; i <= daysInMonth; i++) {
                             const dayData = monthData[currentYear]?.[currentMonth]?.[i - 1];
                             const startId = `start-${currentYear}-${currentMonth}-${i}`; const endId = `end-${currentYear}-${currentMonth}-${i}`; const breakId = `break-${currentYear}-${currentMonth}-${i}`; const noteId = `note-${currentYear}-${currentMonth}-${i}`;
                             const startElement = document.getElementById(startId); const endElement = document.getElementById(endId); const breakElement = document.getElementById(breakId); const noteElement = document.getElementById(noteId);

                             if (startElement && endElement && breakElement && noteElement) {
                                 const newStart = dayData?.start || ''; const newEnd = dayData?.end || ''; const newBreak = dayData?.breakTime || ''; const newNote = dayData?.note || '';
                                 if (startElement.value !== newStart && activeElementId !== startId) startElement.value = newStart;
                                 if (endElement.value !== newEnd && activeElementId !== endId) endElement.value = newEnd;
                                 if (breakElement.value !== newBreak && activeElementId !== breakId) breakElement.value = newBreak;
                                 if (noteElement.value !== newNote && activeElementId !== noteId) noteElement.value = newNote;
                                 calculateRow(i); // Prepoƒç√≠taj riadok po aktualiz√°cii
                             }
                         }
                         uiNeedsUpdate = true; // Potrebujeme prepoƒç√≠ta≈• s√∫ƒçty
                    }

                    // Ulo≈æ aktu√°lny stav (z Firebase) do localStorage, aby boli synchronizovan√©
                    localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage)); localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode'))); localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces)); localStorage.setItem('employeeName', JSON.stringify(employeeName)); localStorage.setItem('workDaysData', JSON.stringify(monthData));
                    updateDataSize(); // Aktualizuj ukazovateƒæ veƒækosti

                    if (uiNeedsUpdate) {
                        console.log("Listener: Vykon√°vam z√°vereƒçn√© prepoƒçty UI (calculateTotal).");
                        calculateTotal();
                    }

                    if (source === "server") { console.log("Listener: D√°ta prijat√© priamo zo SERVERA."); /* showSaveNotification("D√°ta synchronizovan√©"); - m√¥≈æe by≈• zbytoƒçn√© */ }

                } catch (processError) { console.error(`Listener: Chyba pri spracovan√≠ d√°t z Firestore pre ${docPath}:`, processError); showSaveNotification("Chyba: Nespr√°vny form√°t d√°t z Firebase", "error"); }
            } else {
                 // Dokument na Firebase neexistuje pre tento mesiac/rok
                 console.log(`Listener: Dokument ${docPath} neexistuje (${source}). Skontrolujem lok√°lne d√°ta.`);
                 // Ak lok√°lne d√°ta pre tento mesiac existuj√∫, sk√∫sime ich nahra≈• (iba raz)
                 const localDataForMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]);
                 if (localDataForMonth && localDataForMonth.length > 0) {
                     console.log(`Listener: Lok√°lne d√°ta pre ${docPath} existuj√∫, pok√∫≈°am sa ich nahra≈• na Firebase.`);
                     saveToFirebase(); // Pokus o ulo≈æenie lok√°lnych d√°t
                 } else {
                      console.log(`Listener: Pre ${docPath} neexistuj√∫ ani lok√°lne d√°ta.`);
                 }
            }
        }, (error) => { console.error(`Firestore listener chyba pre ${docPath}:`, error); showSaveNotification("Chyba: Nepodarilo sa pripoji≈• k Firebase", "error"); console.log("Listener chyba, aplik√°cia pokraƒçuje s lok√°lnymi d√°tami."); });
    }


    // 8. Funkcia na ukladanie do Firebase (Vol√° sa len ak je user prihl√°sen√Ω)
    async function saveToFirebase() {
        const currentUser = auth.currentUser;
        if (!currentUser) { return; } // Skr√°ten√° kontrola
        try {
            const currentMonthWorkData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            console.log(`saveToFirebase: Pripravujem ${currentMonthWorkData.length} z√°znamov pre ${currentYear}-${currentMonth} pre UID: ${currentUser.uid}.`);
            const dataToSave = {
                days: currentMonthWorkData,
                hourlyWage: hourlyWage || 10, taxRate: (taxRate * 100) || 2, decimalPlaces: decimalPlaces || 1,
                employeeName: employeeName || '', darkMode: document.body.classList.contains('dark-mode'),
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // ƒåasov√° znaƒçka poslednej √∫pravy
            };
            const yearMonthDoc = `${currentYear}-${currentMonth}`;
            const uid = currentUser.uid;
            const docRef = db.collection("users").doc(uid).collection("calculatorData").doc(yearMonthDoc);
            console.log(`saveToFirebase: Odosielam po≈æiadavku na set pre ${docRef.path}`);
            await docRef.set(dataToSave, { merge: true }); // Pou≈æi merge, aby sa neprepisovali len ƒçiastoƒçne zmenen√© d√°ta (aj keƒè tu posielame v≈°etko)
            console.log(`saveToFirebase: Po≈æiadavka na ulo≈æenie d√°t pre ${yearMonthDoc} √∫spe≈°ne odoslan√°/zaraden√°.`);
        } catch (error) {
            console.error(`Chyba pri po≈æiadavke na ukladanie do Firebase pre ${currentYear}-${currentMonth}:`, error);
            showSaveNotification("Chyba: Nepodarilo sa odosla≈• d√°ta do Firebase", "error");
        }
    }

    // 9. Funkcia na ukladanie do Local Storage (Vol√° saveToFirebase podmienene)
    function saveToLocalStorage() {
        try {
            // Ulo≈æ nastavenia V≈ΩDY
            localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
            localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
            localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
            localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
            localStorage.setItem('employeeName', JSON.stringify(employeeName)); // Ulo≈æ√≠ meno aj anonymne
            localStorage.setItem('currentMonth', currentMonth.toString());
            localStorage.setItem('currentYear', currentYear.toString());

            // Ulo≈æ d√°ta mesiacov V≈ΩDY
            if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
            const serializedMonthData = JSON.stringify(monthData);
            const bytes = new Blob([serializedMonthData]).size;
            if (bytes > MAX_DATA_SIZE * 0.95) { showSaveNotification(`Pozor: Lok√°lne √∫lo≈æisko je takmer pln√©! (${(bytes / (1024*1024)).toFixed(1)} MB / ${MAX_DATA_SIZE_KB/1024} MB)`, "warning"); }
            if (bytes > MAX_DATA_SIZE) { alert(`Prekroƒçili ste maxim√°lnu veƒækos≈• d√°t (~${MAX_DATA_SIZE_KB} KB) v localStorage. Ukladanie zlyhalo.`); showSaveNotification("Chyba: Lok√°lne d√°ta s√∫ pr√≠li≈° veƒæk√©!", "error"); return; }
            localStorage.setItem('workDaysData', serializedMonthData);

            updateDataSize(); // Aktualizuj UI pre veƒækos≈•

            // Ak je pou≈æ√≠vateƒæ prihl√°sen√Ω, zavolaj ukladanie do Firebase
            if (auth.currentUser) {
                saveToFirebase();
            } else {
                console.log("saveToLocalStorage: Pou≈æ√≠vateƒæ nie je prihl√°sen√Ω, ulo≈æen√© len lok√°lne.");
            }
        } catch (error) {
            console.error('Chyba pri ukladan√≠ do localStorage:', error);
            showSaveNotification("Kritick√° chyba pri ukladan√≠ lok√°lnych d√°t!", "error");
        }
    }
    const debouncedSaveToLocalStorage = debounce(saveToLocalStorage, 600); // Debounce pre ukladanie

    // 10. Funkcia na naƒç√≠tanie z Local Storage (Vol√° sa pri ≈°tarte a zmene mesiaca/roka)
    function loadFromLocalStorage() {
        try {
            // Urƒçenie aktu√°lneho mesiaca/roka
            if (currentMonth === undefined || currentMonth === null) {
                 const storedMonth = localStorage.getItem('currentMonth');
                 currentMonth = storedMonth !== null ? parseInt(storedMonth) : new Date().getMonth();
            }
             if (currentYear === undefined || currentYear === null) {
                 const storedYear = localStorage.getItem('currentYear');
                 currentYear = storedYear !== null ? parseInt(storedYear) : new Date().getFullYear();
             }
            console.log(`loadFromLocalStorage: Naƒç√≠tavam pre ${getMonthName(currentMonth)} ${currentYear}`);

            // Naƒç√≠tanie d√°t mesiacov
            const storedMonthData = localStorage.getItem('workDaysData');
            monthData = storedMonthData ? JSON.parse(storedMonthData) : {}; // Ak niƒç nie je, zaƒçneme s pr√°zdnym objektom
            console.log(`loadFromLocalStorage: Poƒçet kƒæ√∫ƒçov rokov v monthData: ${Object.keys(monthData).length}`);

            // Naƒç√≠tanie nastaven√≠
            hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
            taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
            const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
            decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 1;
            employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

            // Aplik√°cia naƒç√≠tan√Ωch d√°t na UI
            updateUIFromLoadedData(darkMode);
        } catch (error) {
            console.error(`Kritick√° chyba pri naƒç√≠tavan√≠/spracovan√≠ d√°t z localStorage:`, error);
            showSaveNotification("Chyba pri naƒç√≠tan√≠ lok√°lnych d√°t!", "error");
            // Reset na defaultn√© hodnoty v pr√≠pade chyby
            monthData = {}; hourlyWage = 10; taxRate = 0.02; decimalPlaces = 1; employeeName = ''; darkMode = false;
            currentMonth = new Date().getMonth(); currentYear = new Date().getFullYear();
            updateUIFromLoadedData(darkMode); // Zobraz√≠ defaultn√© UI
        }
    }

    // 11. Funkcia na aktualiz√°ciu UI z glob√°lnych premenn√Ωch
    function updateUIFromLoadedData(darkModeValue) {
        console.log(`updateUIFromLoadedData: Aktualizujem UI pre ${getMonthName(currentMonth)} ${currentYear}`);
        try {
            // Nastavenie inputov/selectov
            hourlyWageInput.value = hourlyWage;
            taxRateInput.value = taxRate * 100;
            decimalPlacesSelect.value = decimalPlaces;
            employeeNameInput.value = employeeName;
            // Nastavenie selectov pre mesiac a rok (s kontrolou existencie option)
            if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) { monthSelect.value = currentMonth; }
            else { console.warn(`Mesiac ${currentMonth} nen√°jden√Ω v selecte, nastavujem aktu√°lny.`); monthSelect.value = new Date().getMonth(); currentMonth = parseInt(monthSelect.value); localStorage.setItem('currentMonth', currentMonth.toString()); }
            if (yearSelect.querySelector(`option[value="${currentYear}"]`)) { yearSelect.value = currentYear; }
            else { console.warn(`Rok ${currentYear} nen√°jden√Ω v selecte, nastavujem aktu√°lny.`); yearSelect.value = new Date().getFullYear(); currentYear = parseInt(yearSelect.value); localStorage.setItem('currentYear', currentYear.toString()); populateYearSelect(); yearSelect.value = currentYear;} // Ak rok neexistuje, znovu napln√≠me select

            // Vytvorenie tabuƒæky a naplnenie d√°tami
            createTable(); // Vytvor√≠ pr√°zdnu ≈°trukt√∫ru
            const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
            console.log(`updateUIFromLoadedData: Pln√≠m UI ${dataForCurrentMonth.length} z√°znamami.`);
            dataForCurrentMonth.forEach((day, index) => {
                const i = index + 1;
                const startElement = document.getElementById(`start-${currentYear}-${currentMonth}-${i}`);
                const endElement = document.getElementById(`end-${currentYear}-${currentMonth}-${i}`);
                const breakElement = document.getElementById(`break-${currentYear}-${currentMonth}-${i}`);
                const noteElement = document.getElementById(`note-${currentYear}-${currentMonth}-${i}`);
                if (startElement && endElement && breakElement && noteElement) {
                    startElement.value = day.start || ''; endElement.value = day.end || ''; breakElement.value = day.breakTime || ''; noteElement.value = day.note || '';
                    calculateRow(i); // Prepoƒç√≠taj riadok
                } else { console.error(`UI Update Error: Elementy pre de≈à ${i} nen√°jden√©!`); }
            });

            // Z√°vereƒçn√© aktualiz√°cie
            calculateTotal();
            updateDataSize();
            applyDarkMode(darkModeValue);
            updateWelcomeMessage();
            console.log("updateUIFromLoadedData: UI aktualizovan√©.");
        } catch (error) {
            console.error("Chyba poƒças updateUIFromLoadedData:", error);
            showSaveNotification("Chyba pri prekresƒæovan√≠ UI!", "error");
        }
    }

    // 12. Funkcia pre aplikovanie Dark Mode
    function applyDarkMode(isDark) {
        const body = document.body;
        const elementsToToggle = [
            body, document.querySelector('.container'), totalSalaryDiv, document.querySelector('.collapsible-settings summary'),
            ...document.querySelectorAll('table, th, td'), ...document.querySelectorAll('input, select, textarea'), // Zahrnie v≈°etky inputy, selecty, textarey
            ...document.querySelectorAll('.btn'), ...document.querySelectorAll('.toggle-note-btn'),
             document.getElementById('auth-status-container'), document.getElementById('auth-container') // Aj stavov√Ω riadok a modal
        ];
        if (isDark) { body.classList.add('dark-mode'); elementsToToggle.forEach(el => el?.classList.add('dark-mode')); }
        else { body.classList.remove('dark-mode'); elementsToToggle.forEach(el => el?.classList.remove('dark-mode')); }
        // ≈†peci√°lne pre aktu√°lny de≈à
        const currentDayRow = document.querySelector('.current-day');
        if (currentDayRow) { /* ≈†t√Ωly pre .current-day a jeho deti s√∫ rie≈°en√© v CSS cez !important */ }
    }

    // 13. Vytv√°ranie tabuƒæky a Input Handling
    function getDayName(year, month, day) { const daysOfWeek = ["Nedeƒæa", "Pondelok", "Utorok", "Streda", "≈†tvrtok", "Piatok", "Sobota"]; return daysOfWeek[new Date(year, month, day).getDay()]; }
    function createTable() {
        workDays.innerHTML = '';
        const tableHead = document.querySelector('table thead tr');
        if (tableHead && !tableHead.querySelector('.th-note')) { // Zabezpeƒçenie, aby sa header pridal len raz
            const noteTh = document.createElement('th'); noteTh.textContent = 'Pozn√°mka'; noteTh.classList.add('th-note');
            const lastTh = tableHead.lastElementChild; tableHead.insertBefore(noteTh, lastTh);
        }
        const daysInMonth = getDaysInMonth(currentMonth); const today = new Date(); const currentDayOfMonth = today.getDate(); const currentMonthIndex = today.getMonth(); const currentYearValue = today.getFullYear();
        let tableHTML = ''; // Build HTML string for performance
        for (let i = 1; i <= daysInMonth; i++) {
            const isCurrentDay = (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue);
            const dayName = getDayName(currentYear, currentMonth, i);
            const baseId = `${currentYear}-${currentMonth}-${i}`;
            const startId = `start-${baseId}`; const endId = `end-${baseId}`; const breakId = `break-${baseId}`; const totalId = `total-${baseId}`; const grossId = `gross-${baseId}`; const netId = `net-${baseId}`; const noteToggleId = `note-toggle-${baseId}`; const noteContainerId = `note-container-${baseId}`; const noteTextareaId = `note-${baseId}`;
            tableHTML += `
                <tr class="${isCurrentDay ? 'current-day' : ''}">
                    <td>De≈à ${i} (${dayName})</td>
                    <td><input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}', ${i})"></td>
                    <td><input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}', ${i})"></td>
                    <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="prest√°vka" oninput="handleBreakInput(${i})"></td>
                    <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces || 1)} h)</td>
                    <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="Hrub√° Mzda" readonly></td>
                    <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="ƒåist√° Mzda" readonly></td>
                    <td>
                        <button id="${noteToggleId}" class="toggle-note-btn" onclick="toggleNote(${i})">Pozn√°mka</button>
                        <div id="${noteContainerId}" class="note-container">
                            <textarea id="${noteTextareaId}" class="note-textarea" placeholder="Zadajte pozn√°mku..." oninput="handleNoteInput(this, ${i})"></textarea>
                        </div>
                    </td>
                    <td><button class="btn reset-btn" onclick="resetRow(${i})">Vynulova≈•</button></td>
                </tr>
            `;
        }
        workDays.innerHTML = tableHTML; // Insert the built HTML at once
        applyDarkMode(document.body.classList.contains('dark-mode')); // Aplikuj dark mode po vytvoren√≠ tabuƒæky
    }
    function toggleNote(day) {
        const containerId = `note-container-${currentYear}-${currentMonth}-${day}`; const buttonId = `note-toggle-${currentYear}-${currentMonth}-${day}`;
        const noteContainer = document.getElementById(containerId); const toggleButton = document.getElementById(buttonId);
        if (noteContainer && toggleButton) {
            const isVisible = noteContainer.classList.toggle('visible'); toggleButton.textContent = isVisible ? 'Skry≈•' : 'Pozn√°mka';
            // Dark mode pre dynamicky zobrazen√© prvky sa rie≈°i v applyDarkMode a CSS
        } else { console.warn(`toggleNote: Elementy pre pozn√°mku d≈àa ${day} neboli n√°jden√©.`); }
    }
    function handleNoteInput(textarea, day) { updateMonthDataFromInput(textarea, day); debouncedSaveToLocalStorage(); /* Ulo≈æ√≠me zmeny po kr√°tkej pauze */ }
    function isTimeValid(timeStr) { const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeStr); }
    function handleInput(input, nextId, day) { formatInput(input); updateMonthDataFromInput(input, day); calculateRow(day); debouncedSaveToLocalStorage(); if (input.value.length === 5 && isTimeValid(input.value)) { moveNext(input, nextId); } }
    function handleBreakInput(day) { const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); updateMonthDataFromInput(input, day); calculateRow(day); debouncedSaveToLocalStorage(); const nextDay = day + 1; let nextInputElementId = null; if (nextDay <= getDaysInMonth(currentMonth)) { nextInputElementId = `start-${currentYear}-${currentMonth}-${nextDay}`; } moveNext(input, nextInputElementId); /* Presun fokusu aj po zadan√≠ prest√°vky */ }
    function updateMonthDataFromInput(input, day) {
        if (!input) return; const dayIndex = day - 1; const fieldId = input.id; let field = 'unknown';
        if (fieldId.startsWith('start-')) field = 'start'; else if (fieldId.startsWith('end-')) field = 'end'; else if (fieldId.startsWith('break-')) field = 'breakTime'; else if (fieldId.startsWith('note-')) field = 'note';
        const value = input.value;
        if (field !== 'unknown') {
            if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
            while (monthData[currentYear][currentMonth].length <= dayIndex) { monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '' }); } // Inicializ√°cia s note
            if (!monthData[currentYear][currentMonth][dayIndex]) { monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '' }; } // Poistka
            monthData[currentYear][currentMonth][dayIndex][field] = value;
        } else { console.warn("updateMonthDataFromInput: Nerozpoznan√© pole pre input ID:", fieldId); }
        calculateTotal(); // Prepoƒç√≠taj s√∫ƒçty hneƒè po zmene d√°t
    }
    function formatInput(input) { if (!input || input.type !== 'tel') return; let value = input.value.replace(/[^\d:]/g, ''); if (value.length >= 2 && !value.includes(':')) { if (value.length > 2) { value = value.slice(0, 2) + ':' + value.slice(2); } } if (value.length === 3 && value.charAt(2) !== ':') { value = value.slice(0, 2) + ':' + value.slice(2); } if (value.length > 5) { value = value.slice(0, 5); } input.value = value; /* Valid√°cia a border sa teraz nerob√≠, zjednodu≈°enie */ }
    function moveNext(currentElement, nextId) { if (!nextId || !currentElement) return; const nextElement = document.getElementById(nextId); if (nextElement) { if (document.activeElement === currentElement) { nextElement.focus(); if (nextElement.select) { nextElement.select(); } } } }
    function calculateRow(day) { const startTimeStr = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`)?.value; const endTimeStr = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`)?.value; const breakTimeInput = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const breakTime = parseFloat(breakTimeInput?.value) || 0; const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); const grossElement = document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`); const netElement = document.getElementById(`net-${currentYear}-${currentMonth}-${day}`); if (!totalCell || !grossElement || !netElement) { return; } let workedMinutes = 0; let decimalHours = 0; let timeIsValid = false; if (startTimeStr && endTimeStr && isTimeValid(startTimeStr) && isTimeValid(endTimeStr)) { timeIsValid = true; const [startHours, startMinutes] = startTimeStr.split(':').map(Number); const [endHours, endMinutes] = endTimeStr.split(':').map(Number); const startTotalMinutes = startHours * 60 + startMinutes; let endTotalMinutes = endHours * 60 + endMinutes; if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; } const diffMinutes = endTotalMinutes - startTotalMinutes; const breakMinutes = breakTime * 60; workedMinutes = Math.max(0, diffMinutes - breakMinutes); decimalHours = (workedMinutes / 60); } const hours = Math.floor(workedMinutes / 60); const minutes = Math.round(workedMinutes % 60); totalCell.textContent = timeIsValid ? `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces || 1)} h)` : (startTimeStr || endTimeStr ? 'Neplatn√Ω ƒças' : `0h 0m (${(0).toFixed(decimalPlaces || 1)} h)`); const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate; const grossSalary = decimalHours * currentHourlyWage; grossElement.value = (timeIsValid && isFinite(grossSalary)) ? grossSalary.toFixed(2) : '0.00'; const netSalary = grossSalary * (1 - currentTaxRate); netElement.value = (timeIsValid && isFinite(netSalary)) ? netSalary.toFixed(2) : '0.00'; }
    function resetRow(day) {
        const dayIndex = day - 1; const start = document.getElementById(`start-${currentYear}-${currentMonth}-${day}`); const end = document.getElementById(`end-${currentYear}-${currentMonth}-${day}`); const breakTime = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); const note = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`); const noteContainer = document.getElementById(`note-container-${currentYear}-${currentMonth}-${day}`); const noteToggle = document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${day}`);
        if (start && end && breakTime && note && noteContainer && noteToggle) {
            start.value = ''; end.value = ''; breakTime.value = ''; note.value = '';
            noteContainer.classList.remove('visible'); noteToggle.textContent = 'Pozn√°mka';
            // Aktualizuj monthData
            if (monthData?.[currentYear]?.[currentMonth]?.[dayIndex]) { monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '' }; }
            calculateRow(day); // Prepoƒç√≠ta UI riadku (na nuly)
            calculateTotal(); // Prepoƒç√≠ta s√∫ƒçty
            debouncedSaveToLocalStorage(); // Ulo≈æ√≠ zmeny
        } else { console.warn(`resetRow: Niektor√© elementy pre de≈à ${day} neboli n√°jden√©.`); }
    }
    function resetAll() { if (confirm('Naozaj chcete resetova≈• v≈°etky z√°znamy pre tento mesiac?')) { if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = []; /* Vyma≈æe d√°ta pre mesiac */ createTable(); /* Vytvor√≠ pr√°zdnu tabuƒæku */ calculateTotal(); /* Vynuluje s√∫ƒçty */ debouncedSaveToLocalStorage(); /* Ulo≈æ√≠ pr√°zdne d√°ta */ showSaveNotification("D√°ta pre aktu√°lny mesiac boli resetovan√©."); } }

    // 14. V√Ωpoƒçet celkov√Ωch s√∫ƒçtov
    function calculateTotal() {
        let grandTotalWorkedMinutes = 0; let daysWithEntries = 0;
        const currentMonthData = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
        currentMonthData.forEach((dayData, index) => {
            if (dayData && dayData.start && dayData.end && isTimeValid(dayData.start) && isTimeValid(dayData.end)) {
                const breakTime = parseFloat(dayData.breakTime) || 0;
                const [startHours, startMinutes] = dayData.start.split(':').map(Number); const [endHours, endMinutes] = dayData.end.split(':').map(Number);
                const startTotalMinutes = startHours * 60 + startMinutes; let endTotalMinutes = endHours * 60 + endMinutes; if (endTotalMinutes < startTotalMinutes) { endTotalMinutes += 24 * 60; }
                const diffMinutes = endTotalMinutes - startTotalMinutes; const breakMinutes = breakTime * 60;
                const workedMinutesForRow = Math.max(0, diffMinutes - breakMinutes);
                grandTotalWorkedMinutes += workedMinutesForRow;
                if (workedMinutesForRow > 0) { daysWithEntries++; }
            } else if (dayData && (dayData.start || dayData.end)) {
                 // Ak je zadan√Ω len jeden ƒças alebo neplatn√Ω, poƒç√≠taj ako 0 min√∫t, ale de≈à sa m√¥≈æe r√°ta≈• ako "zadan√Ω" (voliteƒæn√©)
                 // daysWithEntries++; // Odkomentuj, ak chce≈° r√°ta≈• aj dni s ne√∫pln√Ωm z√°znamom
            }
        });
        const grandTotalDecimalHours = grandTotalWorkedMinutes / 60; const currentHourlyWage = hourlyWage; const currentTaxRate = taxRate; const currentDecimalPlaces = decimalPlaces || 1;
        const grandTotalGrossSalary = grandTotalDecimalHours * currentHourlyWage; const grandTotalNetSalary = grandTotalGrossSalary * (1 - currentTaxRate);
        const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0; const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
        const averageHours = Math.floor(averageWorkedMinutes / 60); const averageMinutes = Math.round(averageWorkedMinutes % 60); const averageDecimalHours = (averageWorkedMinutes / 60);
        const totalHours = Math.floor(grandTotalWorkedMinutes / 60); const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60);
        totalSalaryDiv.innerHTML = `Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntries}<br>Celkov√Ω odpracovan√Ω ƒças: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(currentDecimalPlaces)} h)<br>Celkov√° hrub√° mzda: ${grandTotalGrossSalary.toFixed(2)}‚Ç¨<br>Celkov√° ƒçist√° mzda: ${grandTotalNetSalary.toFixed(2)}‚Ç¨<br>Priemern√° ƒçist√° mzda na de≈à: ${averageNetSalary.toFixed(2)}‚Ç¨<br><strong>Priemern√Ω odpracovan√Ω ƒças na de≈à: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(currentDecimalPlaces)} h)</strong>`;
    }

    // 15. Export do PDF
    function exportToPDF() {
        if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF || !window.jspdf.jsPDF.API?.autoTable) { alert("Chyba: Kni≈ænica jsPDF nie je naƒç√≠tan√°."); return; }
        const { jsPDF } = window.jspdf; try {
            const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("Could not load Roboto font for PDF.", e); }
            doc.setFontSize(18); doc.text(`Bruno's Calculator - V√Ωkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20); doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${employeeName || 'Nezadan√©'}`, 14, 28); doc.text(`Hodinov√° mzda: ${hourlyWage || 'N/A'} ‚Ç¨`, 14, 34); doc.text(`Da≈à (%): ${(taxRate*100).toFixed(1) || 'N/A'}`, 100, 34);
            const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest.(h)", "Prac.", "Hrub√°(‚Ç¨)", "ƒåist√°(‚Ç¨)", "Pozn."]; // Skr√°ten√© hlaviƒçky
            const tableRows = []; const dataForCurrentMonth = (monthData?.[currentYear]?.[currentMonth]) || [];
            dataForCurrentMonth.forEach((day, index) => { if (day.start || day.end || day.note) {
                const dayNum = index + 1; const dayName = getDayName(currentYear, currentMonth, dayNum).substring(0,2); // Skr√°ten√Ω de≈à
                const totalCell = document.getElementById(`total-${currentYear}-${currentMonth}-${dayNum}`); const grossInput = document.getElementById(`gross-${currentYear}-${currentMonth}-${dayNum}`); const netInput = document.getElementById(`net-${currentYear}-${currentMonth}-${dayNum}`);
                let workedTimeText = '0h 0m'; let workedDecimal = '0.0'; if(totalCell){ const match = totalCell.textContent.match(/(\d+h \d+m) \((.*?)\s*h\)/); if(match){ workedTimeText = match[1]; workedDecimal = match[2]; } }
                const grossValue = grossInput ? parseFloat(grossInput.value).toFixed(2) : '0.00'; const netValue = netInput ? parseFloat(netInput.value).toFixed(2) : '0.00'; const noteText = day.note || '';
                const rowData = [ `${dayNum}(${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0', workedDecimal, grossValue, netValue, noteText ]; tableRows.push(rowData); } });
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName, fontSize: 8, cellPadding: 1.5 }, styles: { font: doc.getFont().fontName, fontSize: 8, cellPadding: 1.5, overflow: 'linebreak' }, alternateRowStyles: { fillColor: [240, 240, 240] }, columnStyles: { 7: { cellWidth: 40 } } /* ≈†√≠rka pozn√°mky */ });
            const finalY = doc.lastAutoTable.finalY || 40; doc.setFontSize(10); const totalTextContent = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, ''); doc.text(totalTextContent, 14, finalY + 10); const pdfFileName = `Vykaz-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`; doc.save(pdfFileName); showSaveNotification("PDF exportovan√©.");
        } catch (error) { console.error("Chyba pri generovan√≠ PDF:", error); alert("Nastala chyba pri vytv√°ran√≠ PDF s√∫boru."); }
    }
    function sendPDF() {
        if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF || !window.jspdf.jsPDF.API?.autoTable) { alert("Chyba: Kni≈ænica jsPDF nie je naƒç√≠tan√°."); return; }
        const { jsPDF } = window.jspdf; try {
            const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e) { console.warn("Could not load Roboto font for PDF.", e); }
            doc.setFontSize(16); doc.text(`Pracovn√Ω v√Ωkaz - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20); doc.setFontSize(12); doc.text(`Meno pracovn√≠ka: ${employeeName || 'Nezadan√©'}`, 14, 28);
            const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest.(h)", "Pozn."]; const tableRows = []; const dataForCurrentMonth = (monthData?.[currentYear]?.[currentMonth]) || [];
            dataForCurrentMonth.forEach((day, index) => { if (day.start || day.end || day.note) {
                const dayNum = index + 1; const dayName = getDayName(currentYear, currentMonth, dayNum).substring(0,2); const noteText = day.note || '';
                const rowData = [ `${dayNum}(${dayName})`, day.start || '-', day.end || '-', day.breakTime || '0', noteText ]; tableRows.push(rowData); } });
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 35, headStyles: { fillColor: [41, 128, 185], textColor: 255, font: doc.getFont().fontName, fontSize: 9, cellPadding: 1.5 }, styles: { font: doc.getFont().fontName, fontSize: 9, cellPadding: 1.5, overflow: 'linebreak' }, alternateRowStyles: { fillColor: [240, 240, 240] }, columnStyles: { 4: { cellWidth: 50 } } });
            const finalY = doc.lastAutoTable.finalY || 35; doc.setFontSize(10); const totalSalaryHTML = totalSalaryDiv.innerHTML; let daysWithEntriesText = 'N/A'; const match = totalSalaryHTML.match(/Poƒçet odpracovan√Ωch dn√≠: (\d+)/); if (match && match[1]) { daysWithEntriesText = match[1]; } const summaryText = `Poƒçet odpracovan√Ωch dn√≠: ${daysWithEntriesText}`; doc.text(summaryText, 14, finalY + 10);
            const pdfBlob = doc.output('blob'); const pdfFileName = `Vykaz_odoslanie-${employeeName || 'pracovnik'}-${getMonthName(currentMonth)}-${currentYear}.pdf`; const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) { navigator.share({ files: [pdfFile], title: `Pracovn√Ω v√Ωkaz ${getMonthName(currentMonth)} ${currentYear}`, text: `V√Ωkaz pre ${employeeName || 'pracovn√≠ka'} za ${getMonthName(currentMonth)} ${currentYear}.` }).then(() => { showSaveNotification("PDF pripraven√© na zdieƒæanie."); }).catch((error) => { if (error.name !== 'AbortError') { console.error('sendPDF: Chyba pri zdieƒæan√≠:', error); showSaveNotification('Chyba pri zdieƒæan√≠ s√∫boru.', 'error'); } else { console.log('sendPDF: Zdieƒæanie PDF zru≈°en√©.'); } }); }
            else { showSaveNotification("Zdieƒæanie nie je podporovan√©, s√∫bor sa s≈•ahuje.", "warning"); const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = pdfFileName; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); }
        } catch (error) { console.error("Chyba pri generovan√≠/zdieƒæan√≠ PDF:", error); alert("Nastala chyba pri vytv√°ran√≠ alebo zdieƒæan√≠ PDF s√∫boru."); }
    }

    // 16. Ostatn√© nastavenia a zmeny
    function changeDecimalPlaces() { const newDecimalPlaces = parseInt(decimalPlacesSelect.value); if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) { decimalPlaces = newDecimalPlaces; calculateTotal(); debouncedSaveToLocalStorage(); } }
    function updateEmployeeName() { employeeName = employeeNameInput.value; updateWelcomeMessage(); debouncedSaveToLocalStorage(); }
    function updateSettings() { const newHourlyWageStr = hourlyWageInput.value; const newTaxRateStr = taxRateInput.value; const newHourlyWage = parseFloat(newHourlyWageStr); const newTaxRatePercent = parseFloat(newTaxRateStr); let changed = false; if (!isNaN(newHourlyWage) && newHourlyWage >= 0 && hourlyWage !== newHourlyWage) { hourlyWage = newHourlyWage; changed = true; } if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) { const newTaxRateDecimal = newTaxRatePercent / 100; if (taxRate !== newTaxRateDecimal) { taxRate = newTaxRateDecimal; changed = true; } } if (changed) { /* Prepoƒç√≠tanie v≈°etk√Ωch riadkov je u≈æ v calculateTotal, ktor√© sa vol√° v updateMonthDataFromInput */ calculateTotal(); debouncedSaveToLocalStorage(); } }
    function changeMonth() { const selectedMonth = parseInt(monthSelect.value); if (!isNaN(selectedMonth) && currentMonth !== selectedMonth) { currentMonth = selectedMonth; console.log(`Zmenen√Ω mesiac na: ${getMonthName(currentMonth)}`); handleMonthYearChange(); } }
    function changeYear() { const selectedYear = parseInt(yearSelect.value); if (!isNaN(selectedYear) && currentYear !== selectedYear) { currentYear = selectedYear; console.log(`Zmenen√Ω rok na: ${currentYear}`); handleMonthYearChange(); } }
    function handleMonthYearChange() { console.log(`handleMonthYearChange: Spusten√© pre ${getMonthName(currentMonth)} ${currentYear}`); localStorage.setItem('currentMonth', currentMonth.toString()); localStorage.setItem('currentYear', currentYear.toString()); loadFromLocalStorage(); /* Naƒç√≠ta lok√°lne d√°ta */ if (auth.currentUser) { setupFirestoreListener(); /* Ak prihl√°sen√Ω, nastav√≠ nov√Ω listener */ } }
    function getDaysInMonth(month) { if (month === undefined || month === null || currentYear === undefined || currentYear === null) { console.warn("getDaysInMonth: Ch√Ωba mesiac alebo rok."); return 31; } return new Date(currentYear, month + 1, 0).getDate(); }
    function getMonthName(month) { const monthNames = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"]; return monthNames[month] || 'Nezn√°my'; }
    function updateDataSize() { try { let totalBytes = 0; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); const value = localStorage.getItem(key); totalBytes += (key?.length || 0) + (value?.length || 0); } const kilobytes = (totalBytes / 1024).toFixed(2); const percentageUsed = Math.min(((totalBytes / MAX_DATA_SIZE) * 100), 100); dataSizeText.textContent = `Lok√°lne √∫lo≈æisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`; dataSizeFill.style.width = `${percentageUsed}%`; if (percentageUsed > 90) { dataSizeFill.style.backgroundColor = '#f44336'; } else if (percentageUsed > 70) { dataSizeFill.style.backgroundColor = '#ff9800'; } else { dataSizeFill.style.backgroundColor = '#4CAF50'; } } catch (error) { console.error("Chyba pri v√Ωpoƒçte veƒækosti localStorage:", error); dataSizeText.textContent = "Chyba pri v√Ωpoƒçte veƒækosti."; } }
    function toggleDarkMode() { const isDarkMode = !document.body.classList.contains('dark-mode'); applyDarkMode(isDarkMode); localStorage.setItem('darkMode', JSON.stringify(isDarkMode)); debouncedSaveToLocalStorage(); /* Ulo≈æ√≠ zmenu (aj do Firebase, ak prihl√°sen√Ω) */ }

    // 17. Z√°lohovanie a Obnova
    function createBackup() { try { const backupData = { workDaysData: localStorage.getItem('workDaysData') || '{}', hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(10), taxRate: localStorage.getItem('taxRate') || JSON.stringify(2), darkMode: localStorage.getItem('darkMode') || JSON.stringify(false), decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(1), employeeName: localStorage.getItem('employeeName') || JSON.stringify(''), backupVersion: 3, /* Zv√Ω≈°en√° verzia kv√¥li ≈°trukt√∫re */ backupTimestamp: new Date().toISOString() }; const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `bruno-calc-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showSaveNotification("Z√°loha √∫spe≈°ne vytvoren√°."); } catch (error) { console.error("Chyba pri vytv√°ran√≠ z√°lohy:", error); alert("Nastala chyba pri vytv√°ran√≠ z√°lo≈æn√©ho s√∫boru."); } }
    function restoreBackup() {
        const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = '.json,application/json';
        fileInput.onchange = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = (e) => { try { const backup = JSON.parse(e.target.result);
                if (backup && typeof backup.workDaysData === 'string' && typeof backup.hourlyWage === 'string' && typeof backup.taxRate === 'string' && typeof backup.darkMode === 'string' && typeof backup.decimalPlaces === 'string' && typeof backup.employeeName === 'string') {
                    // Ulo≈æ v≈°etko do localStorage
                    localStorage.setItem('workDaysData', backup.workDaysData); localStorage.setItem('hourlyWage', backup.hourlyWage); localStorage.setItem('taxRate', backup.taxRate); localStorage.setItem('darkMode', backup.darkMode); localStorage.setItem('decimalPlaces', backup.decimalPlaces); localStorage.setItem('employeeName', backup.employeeName);
                    // Naƒç√≠taj UI z localStorage
                    loadFromLocalStorage();
                    showSaveNotification("Z√°loha √∫spe≈°ne obnoven√°."); alert("Z√°loha bola √∫spe≈°ne obnoven√°.");
                    // Spusti ulo≈æenie (ktor√© podmienene zavol√° Firebase sync)
                    saveToLocalStorage();
                } else { alert("Chyba: S√∫bor z√°lohy m√° nespr√°vny form√°t."); }
            } catch (error) { console.error("Chyba pri obnove z√°lohy:", error); alert("Chyba pri ƒç√≠tan√≠ z√°lohy."); } };
            reader.onerror = () => { alert("Chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy."); }; reader.readAsText(file); }; fileInput.click();
    }

    // 18. Inicializ√°cia aplik√°cie
     document.addEventListener('DOMContentLoaded', () => {
         console.log("DOM naƒç√≠tan√Ω, inicializujem Bruno's Calculator...");
         const loadingContainer = document.getElementById('loading-container');

         populateYearSelect(); // Napln√≠ roky

         // Naƒç√≠taj d√°ta z localStorage a zobraz UI HNEƒé
         loadFromLocalStorage();

         // Skry loading screen a≈æ po prvom vykreslen√≠
         if (loadingContainer) loadingContainer.classList.add('hidden');

         // Registr√°cia Service Worker
         if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(reg => console.log('SW zaregistrovan√Ω:', reg.scope)).catch(err => console.error('SW registr√°cia zlyhala:', err)); }); }
         else { console.warn("Service Worker nie je podporovan√Ω."); }

         // Firebase Auth listener sa postar√° o zvy≈°ok (UI pre prihl√°senie, Firebase sync)
         console.log("Inicializ√°cia dokonƒçen√°. ƒåak√°m na stav prihl√°senia...");
     });

     function populateYearSelect() { const startYear = 2020; const endYear = new Date().getFullYear() + 2; let optionsHTML = ''; for (let year = startYear; year <= endYear; year++) { optionsHTML += `<option value="${year}">${year}</option>`; } yearSelect.innerHTML = optionsHTML; /* Nastavenie aktu√°lneho roku sa deje v loadFromLocalStorage/updateUI */ }

    // --- KONIEC JAVASCRIPTU ---
  </script>
</body>
</html>
