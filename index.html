<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bruno's Calculator s Firebase v9</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">

    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- Kompletn√© CSS ≈°t√Ωly z va≈°ej prvej verzie k√≥du --- */
        body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
        .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
        h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
        h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
        .settings {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start; /* Zmenen√© na flex-start pre lep≈°ie zarovnanie s details */
            gap: 10px; /* Pridan√Ω gap pre medzery */
        }
        /* Priame deti .settings (div, details, button) */
        .settings > div,
        .settings > details,
        .settings > button {
            flex: 1 1 200px; /* Zachovanie flex basis */
            margin: 0; /* Odstr√°nen√Ω margin, pou≈æ√≠vame gap */
        }
        .settings label { display: block; margin-bottom: 5px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 950px; /* Mierne zv√§ƒç≈°en√° min-width kv√¥li ikon√°m */ }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
            font-size: 0.9em;
            vertical-align: top; /* Zarovnaj obsah buniek hore */
            position: relative; /* Pozicovanie pre ikony */
        }
        th { background-color: #f2f2f2; }
        input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea /* Pridan√Ω select a .note-textarea */ {
            width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px;
        }
        /* √öprava paddingu pre tel inputy kv√¥li ikone */
        input[type="tel"] {
            padding-right: 28px; /* Priestor pre ikonu */
        }
        /* ≈†t√Ωly pre ikonu hod√≠n */
        .time-icon {
            position: absolute;
            right: 8px; /* Odsadenie od prav√©ho okraja bunky */
            top: 50%;
            transform: translateY(-50%); /* Vertik√°lne centrovanie */
            cursor: pointer;
            font-size: 1.2em; /* Veƒækos≈• ikony */
            color: #555; /* Farba ikony */
            user-select: none; /* Zabr√°ni oznaƒçeniu textu ikony */
            z-index: 2; /* Aby bola nad inputom, ak by sa prekr√Ωvali */
        }
        .time-icon:hover {
            color: #007bff; /* Zmena farby pri prejden√≠ my≈°ou */
            opacity: 0.8;
        }
        body.dark-mode .time-icon {
            color: #bbb; /* Svetlej≈°ia ikona v tmavom re≈æime */
        }
        body.dark-mode .time-icon:hover {
            color: #87cefa; /* Svetlomodr√° pri hover v tmavom re≈æime */
        }

        /* --- NOV√â: ≈†t√Ωly pre ikonu indik√°tora pozn√°mky --- */
         .note-indicator-icon {
            display: none; /* ≈†tandardne skryt√© */
            font-size: 0.9em; /* Trochu men≈°ie */
            margin-right: 4px; /* Medzera pred tlaƒçidlom */
            color: #28a745; /* Zelen√° pre indik√°ciu */
            vertical-align: middle; /* Zarovnanie s textom tlaƒçidla */
            cursor: default; /* Nie je klikateƒæn√° */
         }
         body.dark-mode .note-indicator-icon {
             color: #6fbf7a; /* Svetlej≈°ia zelen√° v tmavom re≈æime */
         }
        /* --- KONIEC nov√Ωch ≈°t√Ωlov pre ikonu indik√°tora --- */


        /* Uprav ≈°√≠rky stƒ∫pcov podƒæa potreby */
        th:nth-child(1), td:nth-child(1) { min-width: 50px; } /* De≈à */
        th:nth-child(2), td:nth-child(2) { min-width: 90px; } /* Pr√≠chod */
        th:nth-child(3), td:nth-child(3) { min-width: 90px; } /* Odchod */
        th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* Prest√°vka */
        th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* Odpracovan√© */
        th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* Hrub√° Mzda */
        th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* ƒåist√° Mzda */
        th:nth-child(8), td:nth-child(8) { min-width: 130px; } /* Pozn√°mka - mierne ≈°ir≈°√≠ kv√¥li ikone */
        th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia */

        .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
        .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; text-align: center; box-sizing: border-box; }
        .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
        .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
        .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
        .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
        .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; }
        #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; }
        #dataSizeContainer { margin-top: 10px; text-align: center; }
        #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
        #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
        #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
        .current-day { background-color: #8a2be2; color: white; }
        .current-day input, .current-day .note-textarea /* Pridan√© .note-textarea pre current-day */ { background-color: #9932cc; color: white; }
        @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }
        body.dark-mode { background-color: #333; color: #f4f4f4; }
        .container.dark-mode { background-color: #444; color: #f4f4f4; }
        table.dark-mode { background-color: #555; color: #f4f4f4; }
        th.dark-mode { background-color: #666; }
        td.dark-mode { background-color: #444; color: #f4f4f4; border-color: #666; /* Upraven√° farba border pre dark mode */ }
        input[type="tel"].dark-mode, input[type="number"].dark-mode, input[type="text"].dark-mode, select.dark-mode, .note-textarea.dark-mode /* Pridan√Ω select a .note-textarea */ {
            background-color: #666; color: white; border-color: #888; /* Pridan√° farba okraja pre dark mode */
        }
        .btn.dark-mode { color: #f4f4f4; } /* Tlaƒçidl√° v dark mode by mali ma≈• svetl√Ω text */
        .reset-btn.dark-mode { background-color: #d32f2f; } .reset-btn.dark-mode:hover { background-color: #b71c1c; }
        .export-btn.dark-mode { background-color: #388e3c; } .export-btn.dark-mode:hover { background-color: #2e7d32; }
        .restore-btn.dark-mode { background-color: #7B1FA2; } .restore-btn.dark-mode:hover { background-color: #6a1b9a; }
        .backup-btn.dark-mode { background-color: #E68900; } .backup-btn.dark-mode:hover { background-color: #d87b00; }
        /* Highlight tlaƒçidlo v tmavom re≈æime */
         .highlight.dark-mode { background-color: #b8860b; color: #f4f4f4; border-color: #b8860b; }
         .highlight.dark-mode:hover { background-color: #a0740a; }

        #totalSalary.dark-mode { background-color: #2c3e50; }
        .current-day.dark-mode { background-color: #4a0e8f; color: #fff; }
        .current-day.dark-mode input, .current-day.dark-mode .note-textarea /* Pridan√© .note-textarea pre current-day dark mode */ { background-color: #5c1db3; color: #fff; border-color: #7a42b0; /* Svetlej≈°√≠ okraj pre inputy v current day */ }
        body.dark-mode .autor-info { color: #aaa; }
        #auth-container { max-width: 400px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); text-align: center; }
         /* Dark mode pre Auth container */
         body.dark-mode #auth-container { background-color: #444; box-shadow: 0 0 5px rgba(0,0,0,0.4); }
         body.dark-mode #auth-container input { background-color: #666; color: white; border-color: #888; }
         body.dark-mode #auth-container button { background-color: #388e3c; }
         body.dark-mode #auth-container button:hover { background-color: #2e7d32; }
         body.dark-mode #auth-message { color: #f4f4f4; }
         body.dark-mode #auth-forms h2 { color: #f4f4f4; }
         body.dark-mode #forgot-password-link { color: #87cefa; }


        #auth-container input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
        #auth-container button { width: 95%; padding: 10px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 3px; cursor: pointer; }
        #auth-container button:hover { background-color: #45a049; }
        #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 10px 20px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease; }
        #saveNotification.show { display: block; opacity: 1; }
        #saveNotification.error { background-color: #f44336; }
        #saveNotification.warning { background-color: #ff9800; }
        #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
        #loading-container.hidden { opacity: 0; pointer-events: none; }
        body.dark-mode #loading-container { background-color: #333; color: #f4f4f4;} /* Dark mode pre loading */

        #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
        #forgot-password-link:hover { text-decoration: underline; }

        /* --- ≈†T√ùLY PRE ZBALITEƒΩN√ö ƒåAS≈§ (nezmenen√©) --- */
        .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
        .collapsible-settings summary:hover { background-color: #eee; }
        .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
        .collapsible-content > div { flex: 1 1 200px; margin: 0; }
        body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
        body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
        body.dark-mode .collapsible-content { border-top-color: #666; }

        /* --- ≈†T√ùLY PRE POZN√ÅMKY --- */
        .note-container {
            display: none; /* ≈†tandardne skryt√© */
            margin-top: 5px;
        }
        .note-container.visible {
            display: block; /* Zobrazen√© po kliknut√≠ alebo naƒç√≠tan√≠ */
        }
        .note-textarea {
            width: 95%; /* Trochu men≈°ia ≈°√≠rka kv√¥li paddingu bunky */
            min-height: 40px; /* Minim√°lna v√Ω≈°ka */
            resize: vertical; /* Povoli≈• len vertik√°lnu zmenu veƒækosti */
            box-sizing: border-box;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 13px; /* Trochu men≈°ie p√≠smo pre pozn√°mky */
            background-color: #f0f0f0; /* Svetl√© pozadie pre odl√≠≈°enie */
            /* Dedi vlastnosti z nadraden√©ho pravidla pre inputy */
        }
        .toggle-note-btn {
            background-color: #6c757d; /* ≈†ed√° farba */
            color: white;
            padding: 3px 8px; /* Men≈°√≠ padding */
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px; /* Men≈°ie p√≠smo */
            transition: background-color 0.2s ease;
            margin-bottom: 2px; /* Mal√Ω odstup od textarea, ak je viditeƒæn√° */
            vertical-align: middle; /* Zarovnanie s ikonou */
        }
        .toggle-note-btn:hover {
            background-color: #5a6268;
        }
        /* Dark mode pre pozn√°mky */
        .note-textarea.dark-mode {
            background-color: #555;
            color: #f4f4f4;
            border-color: #777;
        }
        .toggle-note-btn.dark-mode {
            background-color: #828a91;
        }
        .toggle-note-btn.dark-mode:hover {
            background-color: #70777d;
        }
        /* --- KONIEC ≈†T√ùLOV PRE POZN√ÅMKY --- */

         /* Responzivita (z V1) */
         @media (max-width: 768px) {
             body { padding: 5px; }
             .container { padding: 10px; }
             h1 { font-size: 1.8em; }
             h2 { font-size: 1em; }
             .settings { flex-direction: column; align-items: stretch; }
             .settings > div, .settings > details, .settings > button { width: 100%; margin: 5px 0; flex-basis: auto; }
             .collapsible-content { flex-direction: column; align-items: stretch; }
             .collapsible-content > div { width: 100%; margin: 5px 0; flex-basis: auto; }
             table { min-width: 650px; /* Zmen≈°en√° min-width pre mobil */ }
             th, td { padding: 6px; font-size: 0.85em; } /* Mierne zv√§ƒç≈°en√© p√≠smo pre mobil */
             .btn-container { flex-direction: column; align-items: stretch; gap: 8px;}
             .btn { flex: 1 1 auto; font-size: 14px; padding: 10px 16px; margin: 5px 0; }
             #totalSalary { font-size: 16px; }
             input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea { font-size: 13px; }
             .time-icon { font-size: 1.1em; right: 5px; }
             input[type="tel"] { padding-right: 24px; }
             .note-indicator-icon { font-size: 0.8em; }
             .toggle-note-btn { font-size: 11px; padding: 2px 6px; }
         }
         @media (max-width: 480px) {
             h1 { font-size: 1.6em; animation: none; background: #555; color: #f4f4f4; } /* Jednoduch≈°√≠ titulok pre mal√© mobily */
             body.dark-mode h1 { background: #666; color: #f4f4f4;}
             h2 { font-size: 0.9em; }
             th, td { font-size: 0.8em; }
             .btn { font-size: 13px; padding: 8px 12px; }
             .settings label { font-size: 0.9em; }
             input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea { font-size: 12px; }
             table { min-width: 500px; /* E≈°te men≈°ia min-width */ }
             .time-icon { font-size: 1em; }
             input[type="tel"] { padding-right: 22px; }
             .toggle-note-btn { font-size: 10px; padding: 2px 5px; }
         }

    </style>
</head>
<body>
    <div id="loading-container"><h1>Tajomstvo √∫spechu je slu≈°nos≈• a √∫primnos≈•. Akon√°hle sa ich zbav√≠te, dosiahnete v≈°etko.</h1></div>

    <div id="auth-container" style="display:none;">
        <h1>Prihl√°senie / Registr√°cia</h1>
        <div id="auth-message">≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.</div>
        <div id="auth-forms">
            <h2>Registr√°cia</h2>
            <input type="email" id="registerEmail" placeholder="Email">
            <input type="password" id="registerPassword" placeholder="Heslo (min. 6 znakov)">
            <button onclick="register()">Registrova≈•</button>
            <h2>Prihl√°senie</h2>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Heslo">
            <button onclick="login()">Prihl√°si≈• sa</button>
            <a id="forgot-password-link" href="#" onclick="event.preventDefault(); forgotPassword();">Zabudli ste heslo?</a>
        </div>
    </div>

    <div id="calculator-container" class="container" style="display:none;">
        <div class="autor-info">Vytvoril Bruno</div>
        <h1 id="mainTitle">Bruno's Calculator</h1>
        <h2 id="welcomeMessage"></h2>

        <div class="settings">
            <div>
                <label for="monthSelect">Mesiac: </label>
                <select id="monthSelect" onchange="changeMonth()">
                    <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
                    <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
                    <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
                    <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
                </select>
            </div>

            <details class="collapsible-settings">
                <summary>ƒéal≈°ie nastavenia</summary>
                <div class="collapsible-content">
                    <div>
                        <label for="employeeNameInput">Meno pracovn√≠ka: </label>
                        <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
                    </div>
                    <div>
                        <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
                        <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
                    </div>
                    <div>
                        <label for="taxRateInput">Da≈àov√© percento (%): </label>
                        <input type="number" id="taxRateInput" value="2" min="0" max="100" step="0.1" oninput="updateSettings()">
                    </div>
                    <div>
                        <label for="yearSelect">Rok: </label>
                        <select id="yearSelect" onchange="changeYear()"></select>
                    </div>
                    <div>
                        <label for="decimalPlacesSelect">Desatinn√© miesta (mzda): </label>
                        <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                            <option value="1">1</option>
                            <option value="2" selected>2</option>
                        </select>
                    </div>
                </div>
            </details>

            <button onclick="toggleDarkMode()" class="btn highlight">Tmav√Ω/Svetl√Ω Re≈æim</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>De≈à</th>
                        <th>Pr√≠chod</th>
                        <th>Odchod</th>
                        <th>Prest√°vka (h)</th>
                        <th>Odpracovan√©</th>
                        <th>Hrub√° Mzda (‚Ç¨)</th>
                        <th>ƒåist√° Mzda (‚Ç¨)</th>
                        <th class="th-note">Pozn√°mka</th>
                        <th>Akcia</th>
                    </tr>
                </thead>
                <tbody id="workDays">
                    </tbody>
            </table>
        </div>

        <div id="totalSalary">Celkov√© s√∫ƒçty sa vypoƒç√≠taj√∫...</div>

        <div id="dataSizeContainer">
            <div id="dataSizeText">Lok√°lne √∫lo≈æisko: ~0.00 KB / 4096 KB</div>
            <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
        </div>

        <div class="btn-container">
            <button class="btn reset-btn" onclick="resetAll()">Resetova≈• cel√Ω mesiac</button>
            <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
            <button class="btn export-btn" onclick="sendPDF()">Odosla≈• PDF (Zjednodu≈°en√©)</button>
            <button class="btn restore-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu (JSON)</button>
            <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu (JSON)</button>
            <button id="logout-btn" class="btn reset-btn" onclick="logout()" style="display: none;">Odhl√°si≈• sa</button>
        </div>
    </div>

    <div id="saveNotification"></div>

    <script type="module">
        // --- Firebase v9+ Importy ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, enableIndexedDbPersistence, doc, getDoc, setDoc, onSnapshot, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check.js";

        // --- Firebase Konfigur√°cia (z v√°≈°ho prv√©ho k√≥du) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", // <-- Kƒæ√∫ƒç z V1
            authDomain: "bruno-3cee2.firebaseapp.com",      // <-- Dom√©na z V1
            projectId: "bruno-3cee2",                       // <-- ProjectID z V1
            storageBucket: "bruno-3cee2.appspot.com",       // <-- Storage Bucket z V1
            messagingSenderId: "155545319308",              // <-- SenderID z V1
            appId: "1:155545319308:web:5da498ff1cd3e1833888a9" // <-- AppID z V1
        };

        // --- Firebase Inicializ√°cia ---
        let app;
        let db;
        let auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase Initialized Successfully.");
        } catch (error) {
            console.error("FATAL: Firebase Initialization Failed!", error);
            alert("Kritick√° chyba: Nepodarilo sa inicializova≈• Firebase. Skontrolujte konfigur√°ciu a pripojenie.");
            // Pr√≠padne zobrazi≈• chybov√∫ spr√°vu v UI namiesto alertu
            const loadingContainer = document.getElementById('loading-container');
            if(loadingContainer) loadingContainer.innerHTML = "<h1>Chyba inicializ√°cie Firebase!</h1>";
        }


        // App Check Inicializ√°cia (nahraƒète kƒæ√∫ƒçom!)
        if (app) { // Pokraƒçuj len ak z√°kladn√° inicializ√°cia prebehla
            try {
                initializeAppCheck(app, {
                    provider: new ReCaptchaV3Provider('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv'), // <-- NAHRAƒéTE VA≈†√çM KƒΩ√öƒåOM!
                    isTokenAutoRefreshEnabled: true
                });
                console.log("Firebase App Check initialized.");
            } catch (error) {
                console.warn("Firebase App Check failed to initialize:", error);
                // App Check nie je kritick√Ω pre z√°kladn√∫ funkƒçnos≈•, ale odpor√∫ƒça sa
            }

            // Povolenie Firestore Offline Persistence
            enableIndexedDbPersistence(db)
                .then(() => {
                    console.log("Firestore offline persistence enabled.");
                })
                .catch((err) => {
                    console.error("Firestore offline persistence error:", err);
                    if (err.code == 'failed-precondition') {
                        console.warn("Firestore offline persistence: Multiple tabs open, persistence can only be enabled in one tab at a time.");
                    } else if (err.code == 'unimplemented') {
                        console.error("Firestore offline persistence: The current browser does not support all of the features required to enable persistence.");
                    }
                });
        }


        // --- Glob√°lne Premenn√© (z v√°≈°ho prv√©ho k√≥du) ---
        let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
        let monthData = {}; // D√¥le≈æit√© pre ukladanie d√°t vr√°tane pozn√°mok
        let firestoreListenerUnsubscribe = null;
        let currentUser = null; // Na uchovanie aktu√°lne prihl√°sen√©ho pou≈æ√≠vateƒæa

        const workDays = document.getElementById('workDays');
        const totalSalaryDiv = document.getElementById('totalSalary');
        const dataSizeText = document.getElementById('dataSizeText');
        const dataSizeFill = document.getElementById('dataSizeFill');
        const hourlyWageInput = document.getElementById('hourlyWageInput');
        const taxRateInput = document.getElementById('taxRateInput');
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
        const employeeNameInput = document.getElementById('employeeNameInput');
        const logoutBtn = document.getElementById('logout-btn');
        const MAX_DATA_SIZE = 4 * 1024 * 1024; // 4MB limit pre localStorage
        const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

        // --- Pomocn√© Funkcie (v√§ƒç≈°inou z V1 k√≥du) ---
        function showSaveNotification(message, type = 'success') {
            const notification = document.getElementById('saveNotification');
            if (!notification) return;
            notification.textContent = message;
            notification.className = 'show'; // Reset class
            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            }
            notification.classList.add('show'); // Ensure 'show' is added
            setTimeout(() => {
                notification.classList.remove('show');
                // Ensure specific type classes are also removed if needed
                notification.classList.remove('error', 'warning');
            }, 3000);
        }

        function getFirstName(fullName) {
            if (!fullName || typeof fullName !== 'string') return '';
            const trimmedName = fullName.trim();
            if (!trimmedName) return '';
            const parts = trimmedName.split(' ');
            return parts[0];
        }

        function updateWelcomeMessage() {
            const welcomeElement = document.getElementById('welcomeMessage');
            if (!welcomeElement) return;
            const firstName = getFirstName(employeeName);
            welcomeElement.textContent = firstName ? `Vitaj sp√§≈•, ${firstName}! üëã` : '';
        }

        // --- Auth Funkcie (prep√≠san√© na v9) ---
        window.register = async () => { // Priradenie k window pre onclick v HTML
            if(!auth) return showSaveNotification("Chyba: Autentifik√°cia nie je inicializovan√°.", "error");
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            if (!email || !password) return alert("Zadajte email aj heslo.");
            if (password.length < 6) return alert("Heslo mus√≠ ma≈• aspo≈à 6 znakov.");

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Voliteƒæne vytvor u≈æ√≠vateƒæsk√Ω dokument hneƒè po registr√°cii
                const userDocRef = doc(db, "users", userCredential.user.uid);
                await setDoc(userDocRef, { email: userCredential.user.email, createdAt: new Date().toISOString() }, { merge: true });
                alert("Registr√°cia √∫spe≈°n√°!");
            } catch (error) {
                console.error("Chyba pri registr√°cii:", error);
                const userMessage = mapFirebaseAuthError(error.code);
                showSaveNotification(`Chyba pri registr√°cii: ${userMessage}`, "error");
                alert(`Chyba pri registr√°cii: ${userMessage}`); // Ponechan√Ω alert pre priamu sp√§tn√∫ v√§zbu
            }
        }

        window.login = async () => { // Priradenie k window pre onclick v HTML
            if(!auth) return showSaveNotification("Chyba: Autentifik√°cia nie je inicializovan√°.", "error");
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) return alert("Zadajte email aj heslo.");
            try {
                await signInWithEmailAndPassword(auth, email, password);
                 alert("Prihl√°senie √∫spe≈°n√©!"); // Ponechan√Ω alert
            } catch (error) {
                console.error("Chyba pri prihl√°sen√≠:", error);
                const userMessage = mapFirebaseAuthError(error.code);
                showSaveNotification(`Chyba pri prihl√°sen√≠: ${userMessage}`, "error");
                 alert(`Chyba pri prihl√°sen√≠: ${userMessage}`); // Ponechan√Ω alert
            }
        }

        window.logout = async () => { // Priradenie k window pre onclick v HTML
             if(!auth) return showSaveNotification("Chyba: Autentifik√°cia nie je inicializovan√°.", "error");
            try {
                await signOut(auth);
                // alert("Odhl√°senie √∫spe≈°n√©!"); // Alert nie je nutn√Ω, UI sa zmen√≠
            } catch (error) {
                console.error("Chyba pri odhl√°sen√≠:", error);
                showSaveNotification("Chyba pri odhl√°sen√≠: " + error.message, "error");
                alert("Chyba pri odhl√°sen√≠: " + error.message);
            }
        }

        window.forgotPassword = async () => { // Priradenie k window pre onclick v HTML
             if(!auth) return showSaveNotification("Chyba: Autentifik√°cia nie je inicializovan√°.", "error");
            const emailInput = document.getElementById('loginEmail');
            const email = emailInput.value;
            if (!email) {
                alert("Pros√≠m, zadajte svoju e-mailov√∫ adresu do poƒæa pre prihl√°senie.");
                emailInput.focus();
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                alert("Odkaz na obnovenie hesla bol odoslan√Ω na va≈°u e-mailov√∫ adresu. Skontrolujte si pros√≠m po≈°tu (aj prieƒçinok Spam).");
            } catch (error) {
                console.error("Chyba pri odosielan√≠ e-mailu na obnovenie hesla:", error);
                 const userMessage = mapFirebaseAuthError(error.code);
                showSaveNotification(`Chyba pri odosielan√≠ e-mailu: ${userMessage}`, "error");
                alert(`Chyba pri odosielan√≠ e-mailu na obnovenie hesla: ${userMessage}`);
            }
        }

        // Preklad Firebase chybov√Ωch k√≥dov
        function mapFirebaseAuthError(code) {
             const errorMap = {
                 "auth/invalid-email": "Neplatn√Ω form√°t e-mailovej adresy.",
                 "auth/user-not-found": "Pou≈æ√≠vateƒæ s t√Ωmto e-mailom nebol n√°jden√Ω.",
                 "auth/wrong-password": "Nespr√°vne heslo.",
                 "auth/email-already-in-use": "T√°to e-mailov√° adresa je u≈æ zaregistrovan√°.",
                 "auth/weak-password": "Heslo je pr√≠li≈° slab√© (mus√≠ ma≈• aspo≈à 6 znakov).",
                 "auth/operation-not-allowed": "Prihl√°senie/registr√°cia e-mailom a heslom nie je povolen√°.",
                 "auth/requires-recent-login": "T√°to oper√°cia vy≈æaduje ned√°vne prihl√°senie.",
                 "auth/network-request-failed": "Chyba sie≈•ovej komunik√°cie. Skontrolujte pripojenie.",
                 "auth/too-many-requests": "Pr√≠li≈° veƒæa pokusov. Sk√∫ste nesk√¥r.",
                 "auth/missing-email": "Zadajte pros√≠m e-mailov√∫ adresu.",
                 "auth/internal-error": "Vn√∫torn√° chyba servera."
                 // M√¥≈æete prida≈• ƒèal≈°ie preklady podƒæa potreby
             };
             return errorMap[code] || code; // Vr√°ti preklad alebo p√¥vodn√Ω k√≥d chyby
         }


        // --- Auth State Change Listener (prep√≠san√Ω na v9) ---
         if (auth) { // Listener nastav√≠me len ak auth inicializ√°cia prebehla
             onAuthStateChanged(auth, (user) => {
                 currentUser = user; // Ulo≈æenie aktu√°lneho pou≈æ√≠vateƒæa
                 const authContainer = document.getElementById('auth-container');
                 const calculatorContainer = document.getElementById('calculator-container');
                 const loadingContainer = document.getElementById('loading-container');

                 if (loadingContainer) loadingContainer.classList.add('hidden');

                 // Odpojenie predch√°dzaj√∫ceho listenera, ak existuje
                 if (firestoreListenerUnsubscribe) {
                     firestoreListenerUnsubscribe();
                     firestoreListenerUnsubscribe = null;
                     console.log("Previous Firestore listener unsubscribed.");
                 }

                 if (user) {
                     // Pou≈æ√≠vateƒæ prihl√°sen√Ω
                     console.log("User logged in:", user.uid, user.email);
                     document.getElementById('auth-message').textContent = "Prihl√°sen√Ω: " + user.email;
                     authContainer.style.display = "none";
                     calculatorContainer.style.display = "block";
                     logoutBtn.style.display = "inline-block"; // Zobraz logout tlaƒçidlo

                     // Naƒç√≠tanie posledn√©ho stavu z localStorage (rovnak√© ako V1)
                     const storedMonth = localStorage.getItem('currentMonth');
                     const storedYear = localStorage.getItem('currentYear');
                     const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                     const currentDate = new Date();

                     currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                     currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();

                     // Overenie a nastavenie selectov (rovnak√© ako V1)
                     monthSelect.value = currentMonth;
                     if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                         yearSelect.value = currentYear;
                     } else {
                         console.warn(`Rok ${currentYear} z localStorage nen√°jden√Ω v selecte, pou≈æ√≠vam aktu√°lny rok.`);
                         currentYear = currentDate.getFullYear();
                         populateYearSelect(); // Znovu napln√≠ select, ak by rok ch√Ωbal
                         yearSelect.value = currentYear;
                     }

                     applyDarkMode(darkMode); // Aplikuj tmav√Ω re≈æim

                     // Naƒç√≠tanie ostatn√Ωch nastaven√≠ z localStorage (rovnak√© ako V1)
                     hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                     taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02;
                     decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2; // Default 2
                     employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

                     hourlyWageInput.value = hourlyWage;
                     taxRateInput.value = (taxRate * 100).toFixed(1); // Zobraz√≠ 1 des. miesto
                     decimalPlacesSelect.value = decimalPlaces;
                     employeeNameInput.value = employeeName;

                     loadFromLocalStorage(); // Prv√© naƒç√≠tanie UI z localStorage

                     setupFirestoreListener(); // Nastavenie listenera pre real-time d√°ta

                     // Kontrola / vytvorenie u≈æ√≠vateƒæsk√©ho dokumentu vo Firestore (v9 syntax)
                     const userDocRef = doc(db, "users", user.uid);
                     getDoc(userDocRef).then(userDocSnap => {
                         if (!userDocSnap.exists()) {
                             console.log("User document does not exist, creating...");
                             setDoc(userDocRef, { email: user.email, createdAt: new Date().toISOString() }, { merge: true })
                                 .then(() => console.log("User document created."))
                                 .catch(err => console.error("Chyba pri vytv√°ran√≠ dokumentu pou≈æ√≠vateƒæa:", err));
                         } else {
                            console.log("User document exists.");
                         }
                     }).catch(err => {
                         console.error("Chyba pri kontrole dokumentu pou≈æ√≠vateƒæa (getDoc):", err);
                         showSaveNotification("Chyba pri overovan√≠ pou≈æ√≠vateƒæsk√Ωch d√°t", "error");
                     });

                 } else {
                     // Pou≈æ√≠vateƒæ odhl√°sen√Ω
                     console.log("User logged out.");
                     currentUser = null; // Vyma≈æ pou≈æ√≠vateƒæa
                     document.getElementById('auth-message').textContent = "≈Ωiadny pou≈æ√≠vateƒæ nie je prihl√°sen√Ω.";
                     authContainer.style.display = "block";
                     calculatorContainer.style.display = "none";
                     logoutBtn.style.display = "none"; // Skry logout tlaƒçidlo

                     // Vyƒçistenie d√°t pri odhl√°sen√≠
                     monthData = {};
                     workDays.innerHTML = '';
                     totalSalaryDiv.innerHTML = '';
                     updateWelcomeMessage(); // Skryje uv√≠tanie
                 }
             });
         } else {
             // Fallback, ak Firebase Auth nebolo inicializovan√©
             console.error("Firebase Auth is not initialized. Cannot set up auth state listener.");
             const loadingContainer = document.getElementById('loading-container');
             if(loadingContainer) loadingContainer.classList.add('hidden');
             const authContainer = document.getElementById('auth-container');
             if(authContainer) {
                 authContainer.style.display = 'block';
                 document.getElementById('auth-message').textContent = "Chyba inicializ√°cie Firebase Auth!";
             }
         }


        // --- Firestore Listener (prep√≠san√Ω na v9) ---
        function setupFirestoreListener() {
            if (firestoreListenerUnsubscribe) { // Odpojenie existuj√∫ceho
                 firestoreListenerUnsubscribe();
                 firestoreListenerUnsubscribe = null;
                 console.log("Existing Firestore listener detached before setting up new one.");
            }
            if (!currentUser || !db) { // Skontroluj aj db
                console.log("No user logged in or DB not initialized, cannot setup Firestore listener.");
                return;
            }
            const uid = currentUser.uid;

            if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                const now = new Date();
                currentMonth = currentMonth ?? now.getMonth();
                currentYear = currentYear ?? now.getFullYear();
                console.warn("setupFirestoreListener: Missing month/year. Using current.", currentYear, currentMonth);
            }

            const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`;
            const docRef = doc(db, docPath);
            console.log(`Setting up Firestore listener for path: ${docPath}`);

            firestoreListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                // console.log("Firestore snapshot received. Source:", docSnap.metadata.fromCache ? "cache" : "server", "Pending writes:", docSnap.metadata.hasPendingWrites);
                const hasPending = docSnap.metadata.hasPendingWrites;
                const activeElementId = document.activeElement?.id; // Akt√≠vne fokusovan√Ω element

                // ---- Logika spracovania snapshotu zost√°va veƒæmi podobn√° V1 k√≥du ----
                // ---- Hlavn√Ω rozdiel je, ako sa pristupuje k d√°tam (`docSnap.data()`, `docSnap.exists()`) ----

                 if (hasPending) {
                     // Lok√°lny z√°pis - len aktualizujeme intern√Ω stav `monthData`, neprepisujeme UI inputy
                     // console.log("Processing pending write snapshot.");
                     if (docSnap.exists()) {
                         const data = docSnap.data();
                         const firebaseDaysData = data.days || [];
                         if (!monthData) monthData = {};
                         if (!monthData[currentYear]) monthData[currentYear] = {};
                         // Uchov√°me stav pozn√°mok
                         monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                             start: day.start || '',
                             end: day.end || '',
                             breakTime: day.breakTime || '',
                             note: day.note || '',
                             noteVisible: day.noteVisible === true // Zachov√°me boolean
                         }));
                     }
                     // Neprekresƒæujeme UI z pending writes, aby sme neprepisovali pr√°ve menen√© pole
                     return;
                 }

                // D√°ta zo servera alebo cache (bez lok√°lnych zmien)
                if (docSnap.exists()) {
                    // console.log("Processing server/cache snapshot.");
                    const data = docSnap.data();
                    try {
                        // Naƒç√≠taj nastavenia z Firebase (rovnak√° logika ako V1)
                        const firebaseHourlyWage = data.hourlyWage ?? hourlyWage;
                        const firebaseTaxRatePercent = data.taxRate ?? (taxRate * 100);
                        const firebaseDecimalPlaces = data.decimalPlaces ?? decimalPlaces;
                        const firebaseEmployeeName = data.employeeName ?? employeeName;
                        const firebaseDarkMode = data.darkMode ?? document.body.classList.contains('dark-mode');
                        const firebaseDaysData = data.days || [];

                        // Aktualizuj glob√°lne premenn√© (rovnak√° logika ako V1)
                        hourlyWage = firebaseHourlyWage;
                        taxRate = firebaseTaxRatePercent / 100;
                        decimalPlaces = firebaseDecimalPlaces;
                        employeeName = firebaseEmployeeName;

                        // Aktualizuj UI nastaven√≠ (okrem fokusovan√Ωch) - rovnak√° logika ako V1
                        if (document.activeElement !== hourlyWageInput) hourlyWageInput.value = hourlyWage;
                        if (document.activeElement !== taxRateInput) taxRateInput.value = (taxRate * 100).toFixed(1); // Zobraz ako percento
                        decimalPlacesSelect.value = decimalPlaces;
                        if (document.activeElement !== employeeNameInput) employeeNameInput.value = employeeName;

                        // Priprav monthData na z√°klade Firebase (rovnak√° logika ako V1 vr√°tane noteVisible)
                        if (!monthData) monthData = {};
                        if (!monthData[currentYear]) monthData[currentYear] = {};
                        monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({
                             start: day.start || '', end: day.end || '', breakTime: day.breakTime || '',
                             note: day.note || '', noteVisible: day.noteVisible === true
                        }));

                        // OPTIMALIZOVAN√Å AKTUALIZ√ÅCIA UI RIADKOV (rovnak√° logika ako V1)
                        const daysInMonth = getDaysInMonth(currentMonth);
                        let anyRowRecalculated = false;

                        // Najprv vytvor√≠me tabuƒæku, ak e≈°te neexistuje
                        if(workDays.children.length !== daysInMonth) {
                            console.log("Table structure mismatch, recreating table before applying snapshot data.");
                             createTable();
                        }

                        for (let i = 1; i <= daysInMonth; i++) {
                            const dayIndex = i - 1;
                            const firebaseDayData = monthData[currentYear]?.[currentMonth]?.[dayIndex] || { start: '', end: '', breakTime: '', note: '', noteVisible: false };
                            const baseId = `${currentYear}-${currentMonth}-${i}`;
                            const startId = `start-${baseId}`; const endId = `end-${baseId}`; const breakId = `break-${baseId}`;
                            const noteId = `note-${baseId}`; const noteContainerId = `note-container-${baseId}`;
                            const noteButtonId = `note-toggle-${baseId}`; const noteIndicatorId = `note-indicator-${baseId}`;

                            const startElement = document.getElementById(startId);
                            const endElement = document.getElementById(endId);
                            const breakElement = document.getElementById(breakId);
                            const noteElement = document.getElementById(noteId);
                            const noteContainer = document.getElementById(noteContainerId);
                            const noteButton = document.getElementById(noteButtonId);
                            const noteIndicator = document.getElementById(noteIndicatorId);

                            if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
                                const newStart = firebaseDayData.start || ''; const newEnd = firebaseDayData.end || '';
                                const newBreak = firebaseDayData.breakTime || ''; const newNote = firebaseDayData.note || '';
                                const newNoteVisible = firebaseDayData.noteVisible === true;
                                let rowUpdatedByListener = false;

                                // Aktualizuj len ak nie je fokus a hodnota sa l√≠≈°i
                                if (startElement.value !== newStart && activeElementId !== startId) { startElement.value = newStart; rowUpdatedByListener = true; }
                                if (endElement.value !== newEnd && activeElementId !== endId) { endElement.value = newEnd; rowUpdatedByListener = true; }
                                if (breakElement.value !== newBreak && activeElementId !== breakId) { breakElement.value = newBreak; rowUpdatedByListener = true; }
                                if (noteElement.value !== newNote && activeElementId !== noteId) {
                                    noteElement.value = newNote;
                                    updateNoteIndicator(i); // Aktualizuj indik√°tor
                                    // Zmena pozn√°mky nesp√¥sob√≠ prepoƒçet mzdy, preto rowUpdatedByListener=false
                                }

                                // Aktualizuj viditeƒænos≈• pozn√°mky
                                const currentNoteVisible = noteContainer.classList.contains('visible');
                                if (currentNoteVisible !== newNoteVisible) {
                                    noteContainer.classList.toggle('visible', newNoteVisible);
                                    noteButton.textContent = newNoteVisible ? 'Skry≈•' : 'Pozn√°mka';
                                }

                                if (rowUpdatedByListener) {
                                    calculateRow(i); anyRowRecalculated = true;
                                }
                            } else {
                                console.warn(`Snapshot listener: Elements for day ${i} not found.`);
                            }
                        } // Koniec for cyklu

                        if (anyRowRecalculated) calculateTotal();
                        applyDarkMode(firebaseDarkMode); // Aplikuj dark mode z Firebase
                        updateWelcomeMessage();
                        updateDataSize();

                        // Ulo≈æenie aktu√°lne naƒç√≠tan√Ωch d√°t do localStorage (aby boli konzistentn√©)
                        localStorage.setItem('workDaysData', JSON.stringify(monthData));
                        localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                        localStorage.setItem('taxRate', JSON.stringify(taxRate * 100));
                        localStorage.setItem('darkMode', JSON.stringify(firebaseDarkMode));
                        localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                        localStorage.setItem('employeeName', JSON.stringify(employeeName));


                        // Notifik√°cia len ak d√°ta pri≈°li zo servera (nie z cache poƒças offline)
                        if (!docSnap.metadata.fromCache) {
                            // Odstr√°nime timeout, ak n√°hodou be≈æal
                            // if (saveNotificationTimeout) clearTimeout(saveNotificationTimeout);
                            // Zobraz√≠me notifik√°ciu
                             showSaveNotification("D√°ta synchronizovan√©");
                        }

                    } catch (processError) {
                        console.error(`Listener: Chyba pri spracovan√≠ d√°t z Firestore pre ${currentYear}-${currentMonth}:`, processError);
                        showSaveNotification("Chyba: Nespr√°vny form√°t d√°t z Firebase", "error");
                    }
                } else {
                    // Dokument neexistuje vo Firestore
                    console.log(`Document ${docPath} does not exist in Firestore.`);
                    if (!monthData) monthData = {};
                    if (!monthData[currentYear]) monthData[currentYear] = {};
                    monthData[currentYear][currentMonth] = []; // Pr√°zdne pole pre dan√Ω mesiac

                    // Ulo≈æ pr√°zdne d√°ta do localStorage, aby sme ne≈•ahali star√©
                    localStorage.setItem('workDaysData', JSON.stringify(monthData));

                    // Naƒç√≠taj nastavenia z localStorage (alebo default) a prekresli UI
                     loadFromLocalStorage(); // Toto zavol√° createTable a ƒèal≈°ie funkcie
                    // showSaveNotification("≈Ωiadne d√°ta v cloude pre tento mesiac.", "warning");
                }

            }, (error) => {
                console.error(`Firestore listener ERROR for ${docPath}:`, error);
                showSaveNotification("Chyba: Nepodarilo sa pripoji≈• k Firebase", "error");
                // V pr√≠pade chyby listenera sk√∫sime naƒç√≠ta≈• aspo≈à lok√°lne d√°ta
                loadFromLocalStorage();
            });
            console.log(`Firestore listener attached for path: ${docPath}`);
        }

        // --- Ukladanie do Firebase (prep√≠san√© na v9) ---
        async function saveToFirebase() {
            if (!currentUser || !db) {
                console.log("Cannot save to Firebase, no user logged in or DB not initialized.");
                return;
            }
            const uid = currentUser.uid;
            const yearMonthDoc = `${currentYear}-${currentMonth}`;
            const docRef = doc(db, "users", uid, "calculatorData", yearMonthDoc);

            try {
                // Z√≠skanie aktu√°lnych d√°t vr√°tane pozn√°mok (rovnak√° logika ako V1)
                 const currentMonthWorkData = ((monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || []).map(day => ({
                    start: day.start || '',
                    end: day.end || '',
                    breakTime: day.breakTime || '',
                    note: day.note || '',
                    noteVisible: day.noteVisible === true // Ulo≈æ√≠ boolean
                }));

                 const dataToSave = {
                    days: currentMonthWorkData,
                    hourlyWage: hourlyWage || 10,
                    taxRate: (taxRate * 100), // Uklad√°me ako percento
                    decimalPlaces: decimalPlaces || 2,
                    employeeName: employeeName || '',
                    darkMode: document.body.classList.contains('dark-mode'),
                    timestamp: serverTimestamp() // Pou≈æijeme serverov√Ω timestamp
                };

                // console.log(`Saving data to Firebase for ${yearMonthDoc}...`);
                await setDoc(docRef, dataToSave); // setDoc prep√≠≈°e cel√Ω dokument
                // console.log(`Data saved successfully trigger to Firebase for ${yearMonthDoc}.`);
                // Notifik√°cia sa zobraz√≠ v listeneri, keƒè sa d√°ta vr√°tia zo servera (hasPending = false)

            } catch (error) {
                console.error(`Chyba pri po≈æiadavke na ukladanie do Firebase pre ${yearMonthDoc}:`, error);
                showSaveNotification("Chyba: Nepodarilo sa odosla≈• d√°ta do Firebase", "error");
            }
        }

        // --- Ukladanie do Local Storage (logika z V1, vol√° saveToFirebase) ---
        function saveToLocalStorage() {
            try {
                if (!monthData) monthData = {};
                if (!monthData[currentYear]) monthData[currentYear] = {};
                if (!monthData[currentYear][currentMonth]) { monthData[currentYear][currentMonth] = []; }

                // Ulo≈æ nastavenia
                localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage));
                localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); // Uklad√°me ako percento
                localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode')));
                localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces));
                localStorage.setItem('employeeName', JSON.stringify(employeeName));
                localStorage.setItem('currentMonth', currentMonth.toString());
                localStorage.setItem('currentYear', currentYear.toString());

                // Ulo≈æ√≠ cel√© monthData, ktor√© obsahuje aj pozn√°mky a ich viditeƒænos≈•
                const serializedMonthData = JSON.stringify(monthData);
                const bytes = new Blob([serializedMonthData]).size;

                // Kontrola veƒækosti (rovnak√° ako V1)
                if (bytes > MAX_DATA_SIZE * 0.9) { console.warn(`Veƒækos≈• d√°t ('workDaysData') v localStorage sa bl√≠≈æi k limitu: ${bytes} bajtov`); }
                if (bytes > MAX_DATA_SIZE) {
                    alert(`Prekroƒçili ste maxim√°lnu veƒækos≈• d√°t (~${MAX_DATA_SIZE_KB} KB) pre d√°ta mesiacov v localStorage. Ukladanie zlyhalo.`);
                    showSaveNotification("Chyba: Lok√°lne d√°ta s√∫ pr√≠li≈° veƒæk√©!", "error");
                    return;
                }
                localStorage.setItem('workDaysData', serializedMonthData);
                updateDataSize();

                // --- VOLANIE ULO≈ΩENIA DO FIREBASE ---
                 saveToFirebase(); // Odoslanie aktu√°lneho stavu do Firebase

                if (!navigator.onLine) {
                    showSaveNotification("Offline: Zmeny ulo≈æen√© lok√°lne", "warning");
                }
            } catch (error) {
                console.error('Chyba pri ukladan√≠ (lok√°lne/spusten√≠ Firebase save):', error);
                showSaveNotification("Kritick√° chyba pri ukladan√≠!", "error");
            }
        }

        // Debounce verzia pre ƒçastej≈°ie volania
        const debouncedSaveToLocalStorage = debounce(saveToLocalStorage, 1500); // Ulo≈æ√≠ 1.5s po poslednej zmene

        // --- Naƒç√≠tanie z Local Storage (logika z V1) ---
        function loadFromLocalStorage() {
            try {
                // Zistenie aktu√°lneho mesiaca/roka, ak nie s√∫ definovan√©
                if (currentMonth === undefined || currentMonth === null || currentYear === undefined || currentYear === null) {
                    const storedMonth = localStorage.getItem('currentMonth');
                    const storedYear = localStorage.getItem('currentYear');
                    const currentDate = new Date();
                    currentMonth = storedMonth !== null ? parseInt(storedMonth) : currentDate.getMonth();
                    currentYear = storedYear !== null ? parseInt(storedYear) : currentDate.getFullYear();
                     // console.log("Initializing month/year from localStorage or current date:", currentYear, currentMonth);
                }

                // Naƒç√≠tanie d√°t mesiacov
                const storedMonthData = localStorage.getItem('workDaysData');
                monthData = storedMonthData ? JSON.parse(storedMonthData) : {};

                // Zabezpeƒçenie, ≈æe star√© d√°ta bez noteVisible dostan√∫ predvolen√∫ hodnotu
                 if (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) {
                     monthData[currentYear][currentMonth] = monthData[currentYear][currentMonth].map(day => ({
                         ...day, // Zachov√° existuj√∫ce vlastnosti
                         noteVisible: day.noteVisible === true // Predvolen√° hodnota false ak ch√Ωba
                     }));
                 } else {
                     // Ak pre aktu√°lny mesiac/rok d√°ta neexistuj√∫, inicializuj pr√°zdne pole
                     if (!monthData) monthData = {};
                     if (!monthData[currentYear]) monthData[currentYear] = {};
                     monthData[currentYear][currentMonth] = [];
                 }


                // Naƒç√≠tanie nastaven√≠ (rovnak√© ako V1)
                hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage'))) || 10;
                taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate'))) / 100 || 0.02; // Naƒç√≠tame percento a predel√≠me
                const darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
                decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces'))) || 2; // Default 2
                employeeName = JSON.parse(localStorage.getItem('employeeName')) || '';

                updateUIFromLoadedData(darkMode); // Aktualiz√°cia UI

            } catch (error) {
                console.error(`Kritick√° chyba pri naƒç√≠tavan√≠/spracovan√≠ d√°t z localStorage pre ${getMonthName(currentMonth)} ${currentYear}:`, error);
                showSaveNotification("Chyba pri naƒç√≠tan√≠ lok√°lnych d√°t!", "error");
                monthData = {}; // Reset d√°t v pr√≠pade chyby
                 if (currentMonth === undefined || currentMonth === null) currentMonth = new Date().getMonth();
                 if (currentYear === undefined || currentYear === null) currentYear = new Date().getFullYear();
                createTable(); calculateTotal(); // Zobraz pr√°zdnu tabuƒæku
            }
        }

        // --- Aktualiz√°cia UI (logika z V1, vr√°tane pozn√°mok) ---
        function updateUIFromLoadedData(darkModeValue) {
            try {
                // console.log("Updating UI from loaded data for:", currentYear, currentMonth);
                // Nastav hodnoty inputov pre nastavenia
                hourlyWageInput.value = hourlyWage;
                taxRateInput.value = (taxRate * 100).toFixed(1); // Zobrazujeme ako percento
                decimalPlacesSelect.value = decimalPlaces;
                employeeNameInput.value = employeeName;

                // Nastav selecty pre mesiac a rok
                if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) {
                     monthSelect.value = currentMonth;
                } else {
                     monthSelect.value = new Date().getMonth();
                     currentMonth = parseInt(monthSelect.value);
                }
                 if (yearSelect.querySelector(`option[value="${currentYear}"]`)) {
                     yearSelect.value = currentYear;
                 } else {
                     yearSelect.value = new Date().getFullYear();
                     currentYear = parseInt(yearSelect.value);
                     populateYearSelect(); // Znovu napln√≠, ak rok ch√Ωbal
                     yearSelect.value = currentYear;
                 }


                createTable(); // Vytvor√≠ ≈°trukt√∫ru tabuƒæky

                const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];
                // console.log("Data found for current month:", dataForCurrentMonth.length, "entries");

                // Naplnenie tabuƒæky d√°tami
                dataForCurrentMonth.forEach((day, index) => {
                    const i = index + 1;
                    const baseId = `${currentYear}-${currentMonth}-${i}`;
                    const startElement = document.getElementById(`start-${baseId}`);
                    const endElement = document.getElementById(`end-${baseId}`);
                    const breakElement = document.getElementById(`break-${baseId}`);
                    const noteElement = document.getElementById(`note-${baseId}`);
                    const noteContainer = document.getElementById(`note-container-${baseId}`);
                    const noteButton = document.getElementById(`note-toggle-${baseId}`);
                    const noteIndicator = document.getElementById(`note-indicator-${baseId}`);

                    if (startElement && endElement && breakElement && noteElement && noteContainer && noteButton && noteIndicator) {
                        startElement.value = day.start || '';
                        endElement.value = day.end || '';
                        breakElement.value = day.breakTime || '';
                        noteElement.value = day.note || '';

                        // Vypoƒç√≠taj hodnoty pre riadok
                        calculateRow(i);

                        // Nastavenie viditeƒænosti pozn√°mky
                        const isNoteVisible = day.noteVisible === true;
                        noteContainer.classList.toggle('visible', isNoteVisible);
                        noteButton.textContent = isNoteVisible ? 'Skry≈•' : 'Pozn√°mka';

                        // Aktualiz√°cia indik√°tora pozn√°mky
                        updateNoteIndicator(i);

                         // Aplik√°cia dark mode na dynamick√© prvky pozn√°mky
                        const isDarkModeActive = document.body.classList.contains('dark-mode');
                        if(noteElement) noteElement.classList.toggle('dark-mode', isDarkModeActive);
                        if(noteButton) noteButton.classList.toggle('dark-mode', isDarkModeActive);
                        if(noteIndicator) noteIndicator.classList.toggle('dark-mode', isDarkModeActive);

                    } else {
                        console.error(`Kritick√° chyba: Elementy pre de≈à ${i} v updateUIFromLoadedData neboli n√°jden√© po createTable!`);
                    }
                });

                // Ak je menej d√°t ne≈æ dn√≠ v mesiaci, resetuj zvy≈°n√© riadky
                const daysInMonth = getDaysInMonth(currentMonth);
                 for (let i = dataForCurrentMonth.length + 1; i <= daysInMonth; i++) {
                     if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        resetRow(i, false); // Nerob√≠me save pri tomto resete
                     }
                 }


                calculateTotal(); // Prepoƒç√≠taj celkov√© s√∫ƒçty
                updateDataSize(); // Aktualizuj ukazovateƒæ veƒækosti d√°t
                applyDarkMode(darkModeValue); // Aplikuj tmav√Ω re≈æim
                updateWelcomeMessage(); // Aktualizuj uv√≠tanie

            } catch (error) {
                console.error("Chyba poƒças aktualiz√°cie UI:", error);
                showSaveNotification("Chyba pri prekresƒæovan√≠ UI!", "error");
            }
        }

        // --- Aplikovanie Dark Mode (logika z V1) ---
        function applyDarkMode(isDark) {
            const elementsToToggle = [
                document.body, document.querySelector('.container'), totalSalaryDiv,
                document.querySelector('.collapsible-settings summary'),
                ...document.querySelectorAll('table, th, td'),
                ...document.querySelectorAll('input[type="tel"], input[type="number"], input[type="text"], select'),
                ...document.querySelectorAll('.btn'), // Vr√°tane .highlight, lebo m√° .btn
                ...document.querySelectorAll('.toggle-note-btn'),
                ...document.querySelectorAll('.note-textarea'),
                ...document.querySelectorAll('.time-icon'),
                ...document.querySelectorAll('.note-indicator-icon')
            ];
             elementsToToggle.forEach(el => {
                 if (el) { // Kontrola, ƒçi element existuje
                     // Pou≈æijeme force parameter toggle met√≥dy
                     el.classList.toggle('dark-mode', isDark);
                 } else {
                    // console.warn("Dark mode toggle: Element not found for selector used.");
                 }
             });

            // ≈†peci√°lne pre current-day
            const currentDayRows = document.querySelectorAll('.current-day'); // M√¥≈æe by≈• viac? Rad≈°ej querySelectorAll
             currentDayRows.forEach(currentDayRow => {
                currentDayRow.classList.toggle('dark-mode', isDark);
                 currentDayRow.querySelectorAll('input, .note-textarea, .toggle-note-btn, .time-icon, .note-indicator-icon').forEach(el => {
                     if(el) el.classList.toggle('dark-mode', isDark);
                 });
             });
        }

        window.toggleDarkMode = () => { // Priradenie k window pre onclick
            const isDarkMode = document.body.classList.toggle('dark-mode');
            applyDarkMode(isDarkMode);
            localStorage.setItem('darkMode', JSON.stringify(isDarkMode));
            // Ulo≈æ zmenu dark mode aj do Firebase
             if (currentUser) {
                 saveToFirebase(); // Ulo≈æ√≠ cel√Ω aktu√°lny stav vr√°tane darkMode
             }
        }


        // --- Vytv√°ranie Tabuƒæky (logika z V1, vr√°tane pozn√°mok a ikon) ---
        function getDayName(year, month, day) {
             try {
                // Prid√°me +1 k d≈àu a potom nastav√≠me na 0, aby sme z√≠skali posledn√Ω de≈à predo≈°l√©ho mesiaca
                 // To ale nepotrebujeme, staƒç√≠ vytvori≈• d√°tum
                 const date = new Date(year, month, day);
                 // Skontrolujeme, ƒçi je d√°tum platn√Ω (napr. 31. Febru√°r by nebol platn√Ω)
                 if (isNaN(date.getTime())) {
                     return "N/A"; // Alebo in√° indik√°cia neplatn√©ho d≈àa
                 }
                 const daysOfWeek = ["Ne", "Po", "Ut", "St", "≈†t", "Pi", "So"]; // Skr√°ten√© n√°zvy
                 return daysOfWeek[date.getDay()];
             } catch (e) {
                 console.error("Error getting day name for", year, month, day, e);
                 return "Err";
             }
         }

        function createTable() {
             workDays.innerHTML = ''; // Vyƒçist√≠ predch√°dzaj√∫ci obsah
             const tableHead = document.querySelector('table thead tr');
             // Uist√≠me sa, ≈æe hlaviƒçka pre pozn√°mku existuje (z V1)
             if (tableHead && !tableHead.querySelector('.th-note')) {
                 const noteTh = document.createElement('th');
                 noteTh.textContent = 'Pozn√°mka';
                 noteTh.classList.add('th-note');
                 const lastTh = tableHead.lastElementChild; // N√°jdi posledn√Ω stƒ∫pec (Akcia)
                 tableHead.insertBefore(noteTh, lastTh); // Vlo≈æ pred posledn√Ω
             }

             const daysInMonth = getDaysInMonth(currentMonth);
             if (isNaN(daysInMonth) || daysInMonth <= 0 || daysInMonth > 31) {
                 console.error("Invalid number of days in month:", daysInMonth, "for", currentYear, currentMonth);
                 workDays.innerHTML = `<tr><td colspan="9">Chyba: Neplatn√Ω poƒçet dn√≠ pre ${getMonthName(currentMonth)} ${currentYear}.</td></tr>`;
                 return;
             }

             const today = new Date();
             const currentDayOfMonth = today.getDate();
             const currentMonthIndex = today.getMonth();
             const currentYearValue = today.getFullYear();

             for (let i = 1; i <= daysInMonth; i++) {
                 const row = document.createElement('tr');
                 if (i === currentDayOfMonth && currentMonth === currentMonthIndex && currentYear === currentYearValue) {
                     row.classList.add('current-day');
                 }

                 const dayName = getDayName(currentYear, currentMonth, i);
                 const baseId = `${currentYear}-${currentMonth}-${i}`;
                 const startId = `start-${baseId}`; const endId = `end-${baseId}`; const breakId = `break-${baseId}`;
                 const totalId = `total-${baseId}`; const grossId = `gross-${baseId}`; const netId = `net-${baseId}`;
                 const noteToggleId = `note-toggle-${baseId}`; const noteContainerId = `note-container-${baseId}`;
                 const noteTextareaId = `note-${baseId}`; const noteIndicatorId = `note-indicator-${baseId}`;

                 // HTML ≈°trukt√∫ra riadku z V1 k√≥du (vr√°tane pozn√°mok a ikon)
                 row.innerHTML = `
                     <td>${i}. (${dayName})</td>
                     <td>
                         <input type="tel" id="${startId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${endId}', ${i})">
                         <span class="time-icon" title="Vlo≈æi≈• aktu√°lny ƒças" onclick="insertCurrentTime('${startId}')">‚è∞</span>
                     </td>
                     <td>
                         <input type="tel" id="${endId}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, '${breakId}', ${i})">
                         <span class="time-icon" title="Vlo≈æi≈• aktu√°lny ƒças" onclick="insertCurrentTime('${endId}')">‚è∞</span>
                     </td>
                     <td><input type="number" id="${breakId}" min="0" step="0.5" placeholder="hod." oninput="handleBreakInput(${i})"></td>
                     <td id="${totalId}">0h 0m (${(0).toFixed(decimalPlaces)} h)</td>
                     <td><input type="number" id="${grossId}" min="0" step="0.01" placeholder="0.00" readonly></td>
                     <td><input type="number" id="${netId}" min="0" step="0.01" placeholder="0.00" readonly></td>
                     <td>
                         <span class="note-indicator-icon" id="${noteIndicatorId}">üìù</span>
                         <button id="${noteToggleId}" class="toggle-note-btn" onclick="toggleNote(${i})">Pozn√°mka</button>
                         <div id="${noteContainerId}" class="note-container">
                             <textarea id="${noteTextareaId}" class="note-textarea" placeholder="Zadajte pozn√°mku..." oninput="handleNoteInput(this, ${i})"></textarea>
                         </div>
                     </td>
                     <td><button class="btn reset-btn" onclick="resetRow(${i})">X</button></td>
                 `;
                 workDays.appendChild(row);
             }
             // Aplikuje dark mode aj na novo vytvoren√© prvky
             applyDarkMode(document.body.classList.contains('dark-mode'));
         }


        // --- Vlo≈æenie Aktu√°lneho ƒåasu (funkcia z V1) ---
         window.insertCurrentTime = function(targetInputId) { // Priradenie k window pre onclick
             const now = new Date();
             const hours = now.getHours().toString().padStart(2, '0');
             const minutes = now.getMinutes().toString().padStart(2, '0');
             const formattedTime = `${hours}:${minutes}`;

             const targetInput = document.getElementById(targetInputId);
             if (targetInput) {
                 targetInput.value = formattedTime;
                 // Simulujeme input event, aby sa spustil handleInput a prepoƒçty/ukladanie
                 const event = new Event('input', { bubbles: true, cancelable: true });
                 targetInput.dispatchEvent(event);
                 // Focus na ƒèal≈°ie pole, ak je to pr√≠chod
                 if (targetInputId.startsWith('start-')) {
                    const nextId = targetInputId.replace('start-', 'end-');
                    moveNext(targetInput, nextId);
                 }
             } else {
                 console.error('Cieƒæov√Ω input pre vlo≈æenie ƒçasu nebol n√°jden√Ω:', targetInputId);
                 showSaveNotification('Chyba: Nepodarilo sa n√°js≈• pole pre vlo≈æenie ƒçasu.', 'error');
             }
         }

        // --- Funkcie pre Pozn√°mky (z V1) ---
        window.toggleNote = (day) => { // Priradenie k window pre onclick
            const containerId = `note-container-${currentYear}-${currentMonth}-${day}`;
            const buttonId = `note-toggle-${currentYear}-${currentMonth}-${day}`;
            const noteContainer = document.getElementById(containerId);
            const toggleButton = document.getElementById(buttonId);

            if (noteContainer && toggleButton) {
                const isVisible = noteContainer.classList.toggle('visible');
                toggleButton.textContent = isVisible ? 'Skry≈•' : 'Pozn√°mka';

                const dayIndex = day - 1;
                 // Zabezpeƒç√≠me existenciu z√°znamu pre de≈à
                 ensureDayDataExists(dayIndex);

                if (monthData[currentYear]?.[currentMonth]?.[dayIndex]) {
                     monthData[currentYear][currentMonth][dayIndex].noteVisible = isVisible;
                     debouncedSaveToLocalStorage(); // Ulo≈æ√≠me zmenu viditeƒænosti (s debounce)
                } else {
                    console.warn(`toggleNote: Z√°znam pre de≈à ${dayIndex} st√°le neexistuje po ensureDayDataExists.`);
                }


                 // Aplik√°cia dark mode
                 if (document.body.classList.contains('dark-mode')) {
                     const textarea = noteContainer.querySelector('textarea');
                     if(textarea) textarea.classList.toggle('dark-mode', document.body.classList.contains('dark-mode'));
                     toggleButton.classList.toggle('dark-mode', document.body.classList.contains('dark-mode'));
                     // Note: Indik√°tor sa prep√≠na v updateNoteIndicator
                 }
            } else {
                 console.warn(`toggleNote: Elementy pre pozn√°mku d≈àa ${day} neboli n√°jden√©.`);
            }
        }

        window.updateNoteIndicator = (day) => { // Priradenie k window (vol√° sa interne)
             const noteTextarea = document.getElementById(`note-${currentYear}-${currentMonth}-${day}`);
             const indicatorIcon = document.getElementById(`note-indicator-${currentYear}-${currentMonth}-${day}`);
             if (noteTextarea && indicatorIcon) {
                 const hasContent = noteTextarea.value.trim() !== '';
                 indicatorIcon.style.display = hasContent ? 'inline-block' : 'none';
                 // Aplikuj dark mode na indik√°tor
                 indicatorIcon.classList.toggle('dark-mode', document.body.classList.contains('dark-mode'));
             }
         }
        // Pomocn√° funkcia na zabezpeƒçenie existencie d√°tov√©ho z√°znamu
         function ensureDayDataExists(dayIndex) {
             if (!monthData) monthData = {};
             if (!monthData[currentYear]) monthData[currentYear] = {};
             if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth] = [];
             while (dayIndex >= monthData[currentYear][currentMonth].length) {
                 monthData[currentYear][currentMonth].push({ start: '', end: '', breakTime: '', note: '', noteVisible: false });
             }
             // Zabezpeƒç√≠, ≈æe aj existuj√∫ci z√°znam m√° noteVisible
             if (typeof monthData[currentYear]?.[currentMonth]?.[dayIndex]?.noteVisible === 'undefined') {
                 if (monthData[currentYear]?.[currentMonth]?.[dayIndex]) {
                     monthData[currentYear][currentMonth][dayIndex].noteVisible = false;
                 } else {
                     // Toto by sa nemalo sta≈• po cykle while vy≈°≈°ie, ale pre istotu
                      monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '', noteVisible: false };
                 }
             }
         }


        // --- Input Handling (logika z V1, vr√°tane pozn√°mok) ---
        function isTimeValid(timeStr) { const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/; return timeRegex.test(timeStr); }

        window.handleInput = (input, nextId, day) => { // Priradenie k window pre oninput
             formatInput(input); // Form√°tovanie HH:MM
             updateMonthDataFromInput(input, day); // Aktualiz√°cia monthData
             calculateRow(day); // Prepoƒçet riadku
             calculateTotal(); // Prepoƒçet s√∫ƒçtov
             debouncedSaveToLocalStorage(); // Ulo≈æenie s debounce
             // Automatick√Ω presun fokusu (rovnak√Ω ako V1)
             if (input.type === 'tel' && input.value.length === 5 && isTimeValid(input.value)) {
                 moveNext(input, nextId);
             }
         }

        window.handleBreakInput = (day) => { // Priradenie k window pre oninput
             const input = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`);
             if (input && parseFloat(input.value) < 0) {
                 input.value = ''; // Zak√°≈æ z√°porn√© hodnoty
             }
             updateMonthDataFromInput(input, day);
             calculateRow(day);
             calculateTotal();
             debouncedSaveToLocalStorage();
         }

        window.handleNoteInput = (textarea, day) => { // Priradenie k window pre oninput
             updateMonthDataFromInput(textarea, day);
             updateNoteIndicator(day); // Aktualizuj ikonu indik√°tora
             debouncedSaveToLocalStorage(); // Ulo≈æ√≠ zmenu textu pozn√°mky (s debounce)
         }

        // Aktualiz√°cia monthData z inputu (logika z V1)
        function updateMonthDataFromInput(input, day) {
             if (!input) return;
             const dayIndex = day - 1;
             const fieldId = input.id;
             let field = 'unknown';

             if (fieldId.startsWith('start-')) field = 'start';
             else if (fieldId.startsWith('end-')) field = 'end';
             else if (fieldId.startsWith('break-')) field = 'breakTime';
             else if (fieldId.startsWith('note-')) field = 'note';

             const value = (field === 'breakTime') ? (input.value || '') : input.value; // Ulo≈æ√≠me '' ak je prest√°vka pr√°zdna

             if (field !== 'unknown') {
                ensureDayDataExists(dayIndex); // Zabezpeƒç√≠me existenciu z√°znamu

                const currentValue = monthData[currentYear]?.[currentMonth]?.[dayIndex]?.[field];
                if (currentValue !== value) {
                     monthData[currentYear][currentMonth][dayIndex][field] = value;
                 }
             } else {
                 console.warn("updateMonthDataFromInput: Nerozpoznan√© pole pre input ID:", fieldId);
             }
         }

        // Form√°tovanie HH:MM (logika z V1)
        function formatInput(input) {
            if (!input || input.type !== 'tel') return;
            let value = input.value.replace(/[^\d:]/g, ''); // Povol√≠ len ƒç√≠sla a dvojbodku
            const cursorPosition = input.selectionStart; // Zapam√§t√°me si poz√≠ciu kurzora

            // Automatick√© pridanie dvojbodky
             if (value.length === 3 && value.charAt(2) !== ':' && value.indexOf(':') === -1) {
                 if (parseInt(value.slice(0, 2)) <= 23) {
                     value = value.slice(0, 2) + ':' + value.slice(2);
                 }
            } else if (value.length === 4 && value.indexOf(':') === -1) {
                 value = value.slice(0, 2) + ':' + value.slice(2);
             } else if (value.length === 1 && parseInt(value) > 2 && cursorPosition === 1) {
                  // Ak prv√© ƒç√≠slo je > 2 a kurzor je za n√≠m, prid√°me 0 na zaƒçiatok
                  value = '0' + value;
             } else if (value.length === 2 && cursorPosition === 2 && input.value.length < 3) {
                 // Ak s√∫ zadan√© dve ƒç√≠sla HH a kurzor je na konci, pridaj dvojbodku
                  if (parseInt(value) <= 23) {
                    value = value + ':';
                  }
             }


            // Odstr√°nenie viacer√Ωch dvojbodiek
             const parts = value.split(':');
             if (parts.length > 2) {
                 value = parts[0] + ':' + parts.slice(1).join('');
             }

            // Obmedzenie dƒ∫≈æky
             if (value.length > 5) {
                 value = value.slice(0, 5);
             }

            // Aktualiz√°cia hodnoty inputu, ak sa zmenila
             if (input.value !== value) {
                const originalLength = input.value.length;
                input.value = value;
                // Pokus o obnovenie poz√≠cie kurzora
                 try {
                    // Ak sme pridali dvojbodku po HH, posunieme kurzor za ≈àu
                    if (value.length === 3 && originalLength === 2 && value.endsWith(':')) {
                         input.setSelectionRange(3, 3);
                    } else if (value.length > originalLength && cursorPosition < value.length) {
                         input.setSelectionRange(cursorPosition + (value.length - originalLength), cursorPosition + (value.length - originalLength));
                    } else if (cursorPosition <= value.length) {
                         input.setSelectionRange(cursorPosition, cursorPosition);
                    }
                 } catch (e) {
                     console.warn("Could not set cursor position.", e);
                 }
             }

            // Valid√°cia border (rovnak√° ako V1)
             if (value.length > 0 && value.length < 5) {
                 if (input.style.border !== '') input.style.border = ''; // Reset border
             } else if (value.length === 5) {
                 if (isTimeValid(value)) {
                     if (input.style.border !== '') input.style.border = '';
                 } else {
                     input.style.border = '1px solid red';
                     // Odstr√°nenie ƒçerven√©ho okraja po chv√≠li
                      setTimeout(() => {
                          if (input.style.borderColor === 'red') { // Kontrola pre pr√≠pad, ≈æe by sa medzit√Ωm opravilo
                              input.style.border = '';
                          }
                      }, 2000);
                 }
             } else { // Pr√°zdny alebo dƒ∫≈æka 0
                 if (input.style.border !== '') input.style.border = '';
             }
        }

        // Presun fokusu (logika z V1)
         function moveNext(currentElement, nextId) {
            if (!nextId || !currentElement) return;
             // N√°jdeme rodiƒçovsk√Ω TR element
             const currentRow = currentElement.closest('tr');
             if (!currentRow) return;

             let nextElement = document.getElementById(nextId);

             // Ak ƒèal≈°√≠ element neexistuje (napr. sme na konci riadku a bol to break input),
             // sk√∫sime n√°js≈• prv√Ω input (start) v ƒèal≈°om riadku.
             if (!nextElement && nextId.startsWith('break-')) {
                 const nextRow = currentRow.nextElementSibling;
                 if (nextRow) {
                     const nextStartInput = nextRow.querySelector('input[id^="start-"]');
                     if (nextStartInput) {
                         nextElement = nextStartInput;
                     }
                 }
             }


             if (nextElement) {
                 // Presun√∫≈• focus len ak aktu√°lny element m√° focus
                 if (document.activeElement === currentElement) {
                    nextElement.focus();
                    // Oznaƒçenie textu pre ƒæahk√© prep√≠sanie (okrem number inputov)
                     if (nextElement.select && nextElement.type !== 'number' && nextElement.type !== 'tel') {
                         nextElement.select();
                    } else if (nextElement.type === 'tel'){
                        // Pre tel inputy len nastav√≠me kurzor na zaƒçiatok
                         nextElement.setSelectionRange(0, 0);
                    }
                }
            } else {
                // console.warn(`moveNext: Element s ID ${nextId} nebol n√°jden√Ω.`);
            }
        }


        // --- V√Ωpoƒçty (logika z V1) ---
        function calculateRow(day) {
            const baseId = `${currentYear}-${currentMonth}-${day}`;
            const startTimeStr = document.getElementById(`start-${baseId}`)?.value;
            const endTimeStr = document.getElementById(`end-${baseId}`)?.value;
            const breakTimeInput = document.getElementById(`break-${baseId}`);
            const breakTime = parseFloat(breakTimeInput?.value) || 0;

            const totalCell = document.getElementById(`total-${baseId}`);
            const grossElement = document.getElementById(`gross-${baseId}`);
            const netElement = document.getElementById(`net-${baseId}`);

            if (!totalCell || !grossElement || !netElement) {
                 console.error(`Missing elements for row calculation, day ${day}`);
                 return; // Nem√¥≈æeme poƒç√≠ta≈• bez elementov
            }

            // Reset, ak ch√Ωbaj√∫ ƒçasy
            if (!startTimeStr && !endTimeStr) {
                 totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
                 grossElement.value = (0).toFixed(decimalPlaces);
                 netElement.value = (0).toFixed(decimalPlaces);
                 return;
             }

            // Valid√°cia form√°tu ƒçasu
             if ((startTimeStr && !isTimeValid(startTimeStr)) || (endTimeStr && !isTimeValid(endTimeStr))) {
                 totalCell.textContent = 'Neplatn√Ω ƒças';
                 grossElement.value = (0).toFixed(decimalPlaces);
                 netElement.value = (0).toFixed(decimalPlaces);
                 return;
             }
             // Ak je zadan√Ω len jeden ƒças, zobraz√≠me 0
            if (!startTimeStr || !endTimeStr) {
                totalCell.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
                grossElement.value = (0).toFixed(decimalPlaces);
                netElement.value = (0).toFixed(decimalPlaces);
                return;
            }


            // V√Ωpoƒçet rozdielu ƒçasov
            const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
            const [endHours, endMinutes] = endTimeStr.split(':').map(Number);

            // Pou≈æijeme fikt√≠vny d√°tum pre jednoduch√Ω v√Ωpoƒçet rozdielu
            const startDate = new Date(2000, 0, 1, startHours, startMinutes);
            let endDate = new Date(2000, 0, 1, endHours, endMinutes);

            // Ak je koncov√Ω ƒças men≈°√≠ ako zaƒçiatoƒçn√Ω (pr√°ca cez polnoc)
             if (endDate < startDate) {
                endDate.setDate(endDate.getDate() + 1); // Posu≈à o de≈à
            }

            const diffMilliseconds = endDate.getTime() - startDate.getTime();
            const diffMinutesTotal = diffMilliseconds / (1000 * 60); // Celkov√Ω rozdiel v min√∫tach

             const breakMinutes = breakTime * 60; // Prest√°vka v min√∫tach
             const workedMinutes = Math.max(0, diffMinutesTotal - breakMinutes); // Odpracovan√© min√∫ty

             const hours = Math.floor(workedMinutes / 60);
             const minutes = Math.round(workedMinutes % 60); // Zaokr√∫hlenie min√∫t
             const decimalHours = workedMinutes / 60; // Odpracovan√© hodiny ako desatinn√© ƒç√≠slo

             totalCell.textContent = `${hours}h ${minutes}m (${decimalHours.toFixed(decimalPlaces)} h)`;

            // V√Ωpoƒçet mzdy
            const currentHourlyWage = hourlyWage; // Naƒç√≠taj aktu√°lnu sadzbu
            const currentTaxRate = taxRate; // Naƒç√≠taj aktu√°lnu da≈à

            const grossSalary = decimalHours * currentHourlyWage;
            grossElement.value = isFinite(grossSalary) ? grossSalary.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);

            const netSalary = grossSalary * (1 - currentTaxRate);
            netElement.value = isFinite(netSalary) ? netSalary.toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);
        }


        // Reset Riadku (logika z V1, vr√°tane pozn√°mok)
        window.resetRow = (day, save = true) => { // Priradenie k window pre onclick, save parameter urƒçuje, ƒçi sa m√° hneƒè ulo≈æi≈•
             const dayIndex = day - 1;
             const baseId = `${currentYear}-${currentMonth}-${day}`;
             const start = document.getElementById(`start-${baseId}`);
             const end = document.getElementById(`end-${baseId}`);
             const breakTime = document.getElementById(`break-${baseId}`);
             const total = document.getElementById(`total-${baseId}`);
             const gross = document.getElementById(`gross-${baseId}`);
             const net = document.getElementById(`net-${baseId}`);
             const note = document.getElementById(`note-${baseId}`);
             const noteContainer = document.getElementById(`note-container-${baseId}`);
             const noteToggle = document.getElementById(`note-toggle-${baseId}`);
             const noteIndicator = document.getElementById(`note-indicator-${baseId}`);

             if (start && end && breakTime && total && gross && net && note && noteContainer && noteToggle && noteIndicator) {
                 start.value = ''; end.value = ''; breakTime.value = ''; note.value = '';
                 total.textContent = `0h 0m (${(0).toFixed(decimalPlaces)} h)`;
                 gross.value = (0).toFixed(decimalPlaces); net.value = (0).toFixed(decimalPlaces);
                 noteContainer.classList.remove('visible'); noteToggle.textContent = 'Pozn√°mka';
                 updateNoteIndicator(day); // Skryje indik√°tor

                 // Vynulovanie d√°t v monthData
                 ensureDayDataExists(dayIndex); // Zabezpeƒç√≠me, ≈æe z√°znam existuje
                 if (monthData[currentYear]?.[currentMonth]?.[dayIndex]) {
                     monthData[currentYear][currentMonth][dayIndex] = { start: '', end: '', breakTime: '', note: '', noteVisible: false };
                 } else {
                     console.error(`resetRow: Ch√Ωba z√°znam pre de≈à ${dayIndex} v monthData aj po ensureDayDataExists.`);
                 }

                 calculateTotal(); // Prepoƒç√≠ta≈• s√∫ƒçty
                 if (save) {
                     debouncedSaveToLocalStorage(); // Ulo≈æi≈• zmeny (s debounce)
                 }

             } else {
                 console.warn(`resetRow: Niektor√© elementy pre de≈à ${day} neboli n√°jden√©.`);
             }
         }

        // Reset Mesiaca (logika z V1)
        window.resetAll = () => { // Priradenie k window pre onclick
             if (confirm('Naozaj chcete resetova≈• v≈°etky z√°znamy pre tento mesiac?')) {
                 if (!monthData) monthData = {};
                 if (!monthData[currentYear]) monthData[currentYear] = {};

                 const days = getDaysInMonth(currentMonth);
                 // Vytvor√≠ pole s pr√°zdnymi objektmi pre ka≈æd√Ω de≈à
                 monthData[currentYear][currentMonth] = Array.from({ length: days }, () => ({ start: '', end: '', breakTime: '', note: '', noteVisible: false }));

                 createTable(); // Prekresl√≠ tabuƒæku (u≈æ bude pr√°zdna)
                 calculateTotal(); // Vynuluje s√∫ƒçty
                 saveToLocalStorage(); // Ulo≈æ√≠ pr√°zdne d√°ta (priamo, nie debounce)
                 showSaveNotification("D√°ta pre aktu√°lny mesiac boli resetovan√©.");
             }
         }

        // V√Ωpoƒçet Celkov√Ωch S√∫ƒçtov (logika z V1)
        function calculateTotal() {
            let grandTotalWorkedMinutes = 0;
            let grandTotalGrossSalary = 0;
            let grandTotalNetSalary = 0;
            let daysWithEntries = 0;

            const rows = workDays.querySelectorAll('tr');
            const currentHourlyWage = hourlyWage;
            const currentTaxRate = taxRate;
            const currentDecimalPlaces = decimalPlaces;

            rows.forEach((row, index) => {
                const dayIndex = index + 1;
                const baseId = `${currentYear}-${currentMonth}-${dayIndex}`;
                 const startTimeStr = document.getElementById(`start-${baseId}`)?.value;
                 const endTimeStr = document.getElementById(`end-${baseId}`)?.value;
                 const breakTimeInput = document.getElementById(`break-${baseId}`);
                 const grossInput = document.getElementById(`gross-${baseId}`);
                 const netInput = document.getElementById(`net-${baseId}`);

                 let rowWorkedMinutes = 0;
                 let rowGross = 0;
                 let rowNet = 0;
                 let hasEntry = false; // Indik√°tor, ƒçi sa m√° de≈à zapoƒç√≠ta≈•

                 if (grossInput && netInput) {
                     rowGross = parseFloat(grossInput.value) || 0;
                     rowNet = parseFloat(netInput.value) || 0;
                 }

                 // Prepoƒçet odpracovan√Ωch min√∫t pre s√∫ƒçet (podobne ako v calculateRow)
                 if (startTimeStr && endTimeStr && isTimeValid(startTimeStr) && isTimeValid(endTimeStr)) {
                     const breakTime = parseFloat(breakTimeInput?.value) || 0;
                     const [startHours, startMinutes] = startTimeStr.split(':').map(Number);
                     const [endHours, endMinutes] = endTimeStr.split(':').map(Number);
                     const startDate = new Date(2000, 0, 1, startHours, startMinutes);
                     let endDate = new Date(2000, 0, 1, endHours, endMinutes);
                     if (endDate < startDate) { endDate.setDate(endDate.getDate() + 1); }
                     const diffMilliseconds = endDate.getTime() - startDate.getTime();
                     const diffMinutesTotal = diffMilliseconds / (1000 * 60);
                     const breakMinutes = breakTime * 60;
                     rowWorkedMinutes = Math.max(0, diffMinutesTotal - breakMinutes);
                     if (rowWorkedMinutes > 0) {
                         hasEntry = true; // Zapoƒç√≠taj de≈à, ak sa re√°lne odpracovalo
                     }
                 }

                 // Zapoƒç√≠taj de≈à aj vtedy, ak nie je ƒças, ale je zadan√° pozn√°mka alebo vyn√∫ten√° prest√°vka
                 const noteValue = document.getElementById(`note-${baseId}`)?.value;
                 const breakValue = breakTimeInput?.value;
                 // Zmenen√° logika - zapoƒç√≠ta de≈à, ak m√° *ak√Ωkoƒævek* z√°pis (ƒças, prest√°vka > 0, alebo pozn√°mka)
                 if (startTimeStr || endTimeStr || (breakValue && parseFloat(breakValue) > 0) || noteValue) {
                     hasEntry = true;
                 }


                 grandTotalWorkedMinutes += rowWorkedMinutes;
                 grandTotalGrossSalary += rowGross;
                 grandTotalNetSalary += rowNet;
                 if (hasEntry) {
                     daysWithEntries++;
                 }
            });

             const grandTotalDecimalHours = grandTotalWorkedMinutes / 60;
             // S√∫ƒçty s√∫ u≈æ vypoƒç√≠tan√© priamo z inputov, aby sedeli so zaokr√∫hlen√≠m

             const averageNetSalary = daysWithEntries > 0 ? (grandTotalNetSalary / daysWithEntries) : 0;
             const averageWorkedMinutes = daysWithEntries > 0 ? grandTotalWorkedMinutes / daysWithEntries : 0;
             const averageHours = Math.floor(averageWorkedMinutes / 60);
             const averageMinutes = Math.round(averageWorkedMinutes % 60);
             const averageDecimalHours = averageWorkedMinutes / 60;

             const totalHours = Math.floor(grandTotalWorkedMinutes / 60);
             const totalMinutesRemainder = Math.round(grandTotalWorkedMinutes % 60); // Zaokr√∫hlen√© min√∫ty pre zobrazenie

             totalSalaryDiv.innerHTML =
                 `Poƒçet zapoƒç√≠tan√Ωch dn√≠: ${daysWithEntries}<br>` +
                 `Celkov√Ω odpracovan√Ω ƒças: ${totalHours}h ${totalMinutesRemainder}m (${grandTotalDecimalHours.toFixed(currentDecimalPlaces)} h)<br>` +
                 `Celkov√° hrub√° mzda: ${grandTotalGrossSalary.toFixed(currentDecimalPlaces)} ‚Ç¨<br>` +
                 `Celkov√° ƒçist√° mzda: ${grandTotalNetSalary.toFixed(currentDecimalPlaces)} ‚Ç¨<br>` +
                 `Priemern√° ƒçist√° mzda na de≈à: ${averageNetSalary.toFixed(currentDecimalPlaces)} ‚Ç¨<br>` +
                 `<strong>Priemern√Ω odpracovan√Ω ƒças na de≈à: ${averageHours}h ${averageMinutes}m (${averageDecimalHours.toFixed(currentDecimalPlaces)} h)</strong>`;
         }

        // --- Export do PDF (logika z V1, vr√°tane pozn√°mok) ---
        window.exportToPDF = () => { // Priradenie k window pre onclick
             if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API?.autoTable === 'undefined') {
                 alert("Chyba: Kni≈ænica jsPDF alebo autoTable nie je spr√°vne naƒç√≠tan√°.");
                 console.error("jsPDF library or autoTable plugin is not loaded correctly.");
                 return;
             }
             const { jsPDF } = window.jspdf; // Destructuring pre jsPDF
             try {
                 const doc = new jsPDF();
                 // Pokus o pridanie fontu (ak zlyh√°, pou≈æije sa default)
                 try {
                     // Skontrolujte, ƒçi font u≈æ nie je pridan√Ω, aby ste predi≈°li varovaniam
                     if (!doc.getFontList()['Roboto']) {
                         console.warn("Roboto font not directly added, ensure it's available or use default fonts.");
                     }
                      doc.setFont('helvetica', 'normal'); // Pou≈æijeme ≈°tandardn√Ω font pre istotu
                 } catch(e) {
                      console.warn("Could not load/set Roboto font for PDF, using default.", e);
                      doc.setFont('helvetica', 'normal'); // Fallback na ≈°tandardn√Ω font
                 }

                 doc.setFontSize(18);
                 doc.text(`Bruno's Calculator - V√Ωkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20);

                 doc.setFontSize(12);
                 doc.text(`Meno pracovn√≠ka: ${employeeName || 'Nezadan√©'}`, 14, 28);
                 doc.text(`Hodinov√° mzda: ${hourlyWage || 'N/A'} ‚Ç¨`, 14, 34);
                 doc.text(`Da≈à (%): ${(taxRate * 100).toFixed(1) || 'N/A'}`, 100, 34); // Zobraz√≠ 1 des. miesto

                 // Hlaviƒçka tabuƒæky (vr√°tane pozn√°mky)
                 const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Odpracovan√©", "Hrub√° (‚Ç¨)", "ƒåist√° (‚Ç¨)", "Pozn√°mka"];
                 const tableRows = [];

                 const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];

                 dataForCurrentMonth.forEach((day, index) => {
                     // Zobraz√≠ riadok len ak m√° nejak√Ω vstup alebo pozn√°mku
                      if (day.start || day.end || (day.breakTime && parseFloat(day.breakTime) > 0) || day.note) {
                         const dayNum = index + 1;
                         const dayName = getDayName(currentYear, currentMonth, dayNum);
                         const baseId = `${currentYear}-${currentMonth}-${dayNum}`;

                         const totalCell = document.getElementById(`total-${baseId}`);
                         const grossInput = document.getElementById(`gross-${baseId}`);
                         const netInput = document.getElementById(`net-${baseId}`);

                         // Z√≠skanie hodn√¥t priamo z elementov pre presnos≈• zobrazenia
                         const workedTimeText = totalCell ? totalCell.textContent.trim() : 'N/A';
                         // Z√≠skavame hodnoty z monthData pre istotu, ak by UI nebolo aktu√°lne
                         const grossValue = (day.start && day.end && grossInput) ? (parseFloat(grossInput.value || 0)).toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);
                         const netValue = (day.start && day.end && netInput) ? (parseFloat(netInput.value || 0)).toFixed(decimalPlaces) : (0).toFixed(decimalPlaces);
                         const noteText = day.note || ''; // Pozn√°mka z d√°tov√©ho modelu

                         const rowData = [
                             `${dayNum}. (${dayName})`,
                             day.start || '-',
                             day.end || '-',
                             day.breakTime || '0',
                             workedTimeText,
                             grossValue,
                             netValue,
                             noteText // Pridan√° pozn√°mka
                         ];
                         tableRows.push(rowData);
                     }
                 });

                 doc.autoTable({
                     head: [tableColumn],
                     body: tableRows,
                     startY: 40,
                     theme: 'grid', // Alebo 'striped', 'plain'
                     styles: {
                         font: 'helvetica', // Pou≈æijeme ≈°tandardn√Ω font
                         fontSize: 8,
                         cellPadding: 2,
                         overflow: 'linebreak' // Zalomenie textu v bunk√°ch
                     },
                     headStyles: {
                         fillColor: [41, 128, 185], // Modr√° farba hlaviƒçky
                         textColor: 255,
                         fontStyle: 'bold',
                         halign: 'center'
                     },
                     alternateRowStyles: {
                         fillColor: [240, 240, 240] // Svetlosiv√© striedanie riadkov
                     },
                     columnStyles: {
                         0: { cellWidth: 22, halign: 'left' }, // De≈à
                         1: { cellWidth: 15, halign: 'center' }, // Pr√≠chod
                         2: { cellWidth: 15, halign: 'center' }, // Odchod
                         3: { cellWidth: 18, halign: 'center' }, // Prest√°vka
                         4: { cellWidth: 30, halign: 'center' }, // Odpracovan√©
                         5: { cellWidth: 20, halign: 'right' }, // Hrub√°
                         6: { cellWidth: 20, halign: 'right' }, // ƒåist√°
                         7: { cellWidth: 'auto'} // Pozn√°mka - auto ≈°√≠rka
                     }
                 });

                 const finalY = doc.lastAutoTable.finalY || 40; // Z√≠skanie poz√≠cie pod tabuƒækou

                 doc.setFontSize(10);
                 // Odstr√°nenie HTML tagov pre zobrazenie s√∫ƒçtov
                 const totalTextContent = totalSalaryDiv.innerHTML
                     .replace(/<br\s*\/?>/gi, '\n') // Nahrad√≠ <br> za nov√Ω riadok
                     .replace(/<\/?strong>/g, '');   // Odstr√°ni <strong> tagy
                 doc.text(totalTextContent, 14, finalY + 10); // Zobraz√≠ s√∫ƒçty

                 // Generovanie n√°zvu s√∫boru
                 const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-zA-Z0-9]/g, '_'); // Odstr√°ni ≈°peci√°lne znaky
                 const pdfFileName = `Vykaz-${safeEmployeeName}-${getMonthName(currentMonth)}-${currentYear}.pdf`;

                 doc.save(pdfFileName);
                 showSaveNotification("PDF exportovan√©.");

             } catch (error) {
                 console.error("Chyba pri generovan√≠ PDF v exportToPDF:", error);
                 alert("Nastala chyba pri vytv√°ran√≠ PDF s√∫boru.");
                 showSaveNotification("Chyba pri exporte PDF.", "error");
             }
         }

        // Odoslanie PDF (logika z V1, vr√°tane pozn√°mok)
        window.sendPDF = () => { // Priradenie k window pre onclick
             if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.jsPDF.API?.autoTable === 'undefined') {
                  alert("Chyba: Kni≈ænica jsPDF alebo autoTable nie je spr√°vne naƒç√≠tan√°.");
                  console.error("jsPDF library or autoTable plugin is not loaded correctly.");
                  return;
              }
              const { jsPDF } = window.jspdf;
             try {
                 const doc = new jsPDF();
                 try {
                    // Nastavenie fontu (podobne ako pri exporte)
                      if (!doc.getFontList()['Roboto']) {
                         console.warn("Roboto font not directly added for sendPDF.");
                     }
                      doc.setFont('helvetica', 'normal');
                 } catch(e) {
                      console.warn("Could not load/set font for sendPDF, using default.", e);
                      doc.setFont('helvetica', 'normal');
                 }

                 doc.setFontSize(16);
                 doc.text(`Pracovn√Ω v√Ωkaz - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20);
                 doc.setFontSize(12);
                 doc.text(`Meno pracovn√≠ka: ${employeeName || 'Nezadan√©'}`, 14, 28);

                 // Zjednodu≈°en√° hlaviƒçka a d√°ta pre odoslanie
                 const tableColumn = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka (h)", "Pozn√°mka"];
                 const tableRows = [];
                 const dataForCurrentMonth = (monthData && monthData[currentYear] && monthData[currentYear][currentMonth]) || [];

                 dataForCurrentMonth.forEach((day, index) => {
                      if (day.start || day.end || (day.breakTime && parseFloat(day.breakTime) > 0) || day.note) {
                         const dayNum = index + 1;
                         const dayName = getDayName(currentYear, currentMonth, dayNum);
                         const noteText = day.note || '';
                         const rowData = [
                             `${dayNum}. (${dayName})`,
                             day.start || '-',
                             day.end || '-',
                             day.breakTime || '0',
                             noteText // Pridan√° pozn√°mka
                         ];
                         tableRows.push(rowData);
                     }
                 });

                 doc.autoTable({
                     head: [tableColumn],
                     body: tableRows,
                     startY: 35,
                     theme: 'grid',
                     styles: { font: 'helvetica', fontSize: 9, cellPadding: 2, overflow: 'linebreak' },
                     headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold', halign: 'center' },
                     alternateRowStyles: { fillColor: [240, 240, 240] },
                     columnStyles: {
                         0: { cellWidth: 30, halign: 'left' }, // De≈à
                         1: { cellWidth: 25, halign: 'center' }, // Pr√≠chod
                         2: { cellWidth: 25, halign: 'center' }, // Odchod
                         3: { cellWidth: 25, halign: 'center' }, // Prest√°vka
                         4: { cellWidth: 'auto'} // Pozn√°mka
                     }
                 });

                 const finalY = doc.lastAutoTable.finalY || 35;
                 doc.setFontSize(10);

                 // Pridanie poƒçtu dn√≠ zo s√∫ƒçtov
                 const totalSalaryHTML = totalSalaryDiv.innerHTML;
                 let daysWithEntriesText = 'N/A';
                  const match = totalSalaryHTML.match(/Poƒçet zapoƒç√≠tan√Ωch dn√≠: (\d+)/); // Hƒæad√°me nov√Ω text
                  if (match && match[1]) {
                      daysWithEntriesText = match[1];
                  }
                 const summaryText = `Poƒçet zapoƒç√≠tan√Ωch dn√≠: ${daysWithEntriesText}`;
                 doc.text(summaryText, 14, finalY + 10);


                 const pdfBlob = doc.output('blob'); // Z√≠skanie PDF ako Blob
                 const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
                 const pdfFileName = `Vykaz_odoslanie-${safeEmployeeName}-${getMonthName(currentMonth)}-${currentYear}.pdf`;
                 const pdfFile = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

                 // Pokus o zdieƒæanie cez Web Share API
                 if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                     navigator.share({
                         files: [pdfFile],
                         title: `Pracovn√Ω v√Ωkaz ${getMonthName(currentMonth)} ${currentYear}`,
                         text: `V√Ωkaz pre ${employeeName || 'pracovn√≠ka'} za ${getMonthName(currentMonth)} ${currentYear}.`
                     }).then(() => {
                         showSaveNotification("PDF pripraven√© na zdieƒæanie.");
                     }).catch((error) => {
                         // Ignorujeme AbortError, ktor√Ω nastane, ak pou≈æ√≠vateƒæ zru≈°√≠ zdieƒæanie
                         if (error.name !== 'AbortError') {
                             console.error('sendPDF: Chyba pri zdieƒæan√≠ cez Web Share API:', error);
                             showSaveNotification('Chyba pri zdieƒæan√≠ s√∫boru.', "error");
                              // Fallback na stiahnutie, ak zdieƒæanie zlyh√° z in√©ho d√¥vodu
                              doc.save(pdfFileName);
                         } else {
                            console.log("Sharing aborted by user.");
                         }
                     });
                 } else {
                     // Fallback na stiahnutie, ak Web Share API nie je podporovan√©
                     alert("Zdieƒæanie s√∫borov nie je podporovan√© va≈°√≠m prehliadaƒçom alebo syst√©mom. S√∫bor bude stiahnut√Ω.");
                     doc.save(pdfFileName);
                 }
             } catch (error) {
                 console.error("Chyba pri generovan√≠ alebo zdieƒæan√≠ PDF v sendPDF:", error);
                 alert("Nastala chyba pri vytv√°ran√≠ alebo zdieƒæan√≠ PDF s√∫boru.");
                 showSaveNotification("Chyba pri odosielan√≠ PDF.", "error");
             }
         }

        // --- Ostatn√© Nastavenia (logika z V1) ---
         window.changeDecimalPlaces = () => { // Priradenie k window pre onchange
             const newDecimalPlaces = parseInt(decimalPlacesSelect.value);
             if (!isNaN(newDecimalPlaces) && newDecimalPlaces >= 1 && newDecimalPlaces <= 2) {
                 decimalPlaces = newDecimalPlaces;
                 // Prepoƒç√≠ta≈• v≈°etky riadky a s√∫ƒçty
                 const daysInMonth = getDaysInMonth(currentMonth);
                 for(let i = 1; i <= daysInMonth; i++) {
                    if(document.getElementById(`start-${currentYear}-${currentMonth}-${i}`)) {
                        calculateRow(i);
                    }
                 }
                 calculateTotal();
                 saveToLocalStorage(); // Ulo≈æ√≠ zmenu nastavenia a aktu√°lne d√°ta
             }
         }

        window.updateEmployeeName = () => { // Priradenie k window pre oninput
             employeeName = employeeNameInput.value;
             updateWelcomeMessage();
             saveToLocalStorage(); // Ulo≈æ√≠ zmenu mena a aktu√°lne d√°ta
         }

        window.updateSettings = () => { // Priradenie k window pre oninput
             const newHourlyWageStr = hourlyWageInput.value;
             const newTaxRateStr = taxRateInput.value;
             const newHourlyWage = parseFloat(newHourlyWageStr);
             const newTaxRatePercent = parseFloat(newTaxRateStr);
             let settingsChanged = false;

             // Update hourly wage
             if (!isNaN(newHourlyWage) && newHourlyWage >= 0) {
                 if (hourlyWage !== newHourlyWage) {
                     hourlyWage = newHourlyWage;
                     settingsChanged = true;
                 }
             } else if (newHourlyWageStr !== '') { // Ak je neplatn√©, ale nie pr√°zdne, vr√°≈• star√∫ hodnotu
                  hourlyWageInput.value = hourlyWage;
             }


             // Update tax rate
              if (!isNaN(newTaxRatePercent) && newTaxRatePercent >= 0 && newTaxRatePercent <= 100) {
                  const newTaxRateDecimal = newTaxRatePercent / 100;
                  if (taxRate !== newTaxRateDecimal) {
                      taxRate = newTaxRateDecimal;
                      settingsChanged = true;
                  }
              } else if (newTaxRateStr !== '') { // Ak je neplatn√©, ale nie pr√°zdne, vr√°≈• star√∫ hodnotu
                   taxRateInput.value = (taxRate * 100).toFixed(1);
              }


             // Ak sa zmenila mzda alebo da≈à, prepoƒç√≠taj v≈°etko a ulo≈æ
             if (settingsChanged) {
                 const rows = workDays.querySelectorAll('tr');
                 rows.forEach((row, index) => calculateRow(index + 1));
                 calculateTotal();
                 saveToLocalStorage(); // Ulo≈æ√≠ nov√© nastavenia a prepoƒç√≠tan√© d√°ta
             }
         }

        window.changeMonth = () => { // Priradenie k window pre onchange
             const selectedMonth = parseInt(monthSelect.value);
             if (currentMonth !== selectedMonth) {
                 currentMonth = selectedMonth;
                 handleMonthYearChange();
             }
         }

        window.changeYear = () => { // Priradenie k window pre onchange
             const selectedYear = parseInt(yearSelect.value);
             if (currentYear !== selectedYear) {
                 currentYear = selectedYear;
                 handleMonthYearChange();
             }
         }

        function handleMonthYearChange() {
            console.log("Changing month/year to:", currentYear, currentMonth);
             localStorage.setItem('currentMonth', currentMonth.toString());
             localStorage.setItem('currentYear', currentYear.toString());
             // Pri zmene mesiaca/roka naƒç√≠tame d√°ta z localStorage (tie sa mohli naƒç√≠ta≈• z Firebase predt√Ωm)
             loadFromLocalStorage();
             // A nastav√≠me nov√Ω listener pre Firebase
             if (currentUser) {
                 setupFirestoreListener();
             }
         }

        function getDaysInMonth(month) {
             if (month === undefined || month === null || currentYear === undefined || currentYear === null) {
                 console.warn("getDaysInMonth: Missing month or year, returning 31.");
                 return 31; // Fallback
             }
             // Vytvor√≠ d√°tum pre nult√Ω de≈à nasleduj√∫ceho mesiaca, ƒço je posledn√Ω de≈à aktu√°lneho mesiaca
             return new Date(currentYear, month + 1, 0).getDate();
         }

        function getMonthName(month) {
             const monthNames = ["Janu√°r", "Febru√°r", "Marec", "Apr√≠l", "M√°j", "J√∫n", "J√∫l", "August", "September", "Okt√≥ber", "November", "December"];
             // Zabezpeƒç√≠me, ≈æe index je v platnom rozsahu
              if (month >= 0 && month < monthNames.length) {
                return monthNames[month];
              }
              return 'Nezn√°my';
         }

        function updateDataSize() {
             try {
                 const totalData = Object.entries(localStorage).reduce((acc, [key, value]) => {
                      // Poƒç√≠tajme len relevantn√© d√°ta (workDaysData a nastavenia)
                      if (key === 'workDaysData' || ['hourlyWage', 'taxRate', 'darkMode', 'decimalPlaces', 'employeeName', 'currentMonth', 'currentYear'].includes(key)) {
                          // Odhad veƒækosti - ka≈æd√Ω znak v JS stringu m√¥≈æe zabera≈• 1 alebo 2 bajty (UTF-16)
                          // Pou≈æijeme jednoduch√Ω odhad dƒ∫≈æky stringu ako aproxim√°ciu
                          return acc + (value ? value.length : 0);
                      }
                      return acc;
                  }, 0);

                 const kilobytes = (totalData / 1024).toFixed(2);
                 const percentageUsed = Math.min(((totalData / MAX_DATA_SIZE) * 100), 100);

                 dataSizeText.textContent = `Lok√°lne √∫lo≈æisko: ~${kilobytes} KB / ${MAX_DATA_SIZE_KB} KB`;
                 dataSizeFill.style.width = `${percentageUsed}%`;

                 // Zmena farby podƒæa zaplnenia
                 if (percentageUsed > 90) {
                     dataSizeFill.style.backgroundColor = '#f44336'; // ƒåerven√°
                 } else if (percentageUsed > 70) {
                     dataSizeFill.style.backgroundColor = '#ff9800'; // Oran≈æov√°
                 } else {
                     dataSizeFill.style.backgroundColor = '#4CAF50'; // Zelen√°
                 }
             } catch (error) {
                 console.error("Chyba pri v√Ωpoƒçte veƒækosti localStorage:", error);
                 dataSizeText.textContent = "Chyba pri v√Ωpoƒçte veƒækosti d√°t.";
             }
         }


        // --- Z√°lohovanie a Obnova (JSON form√°t - logika z V1) ---
        window.createBackup = () => { // Priradenie k window pre onclick
            try {
                 // Zhroma≈æd√≠me v≈°etky relevantn√© d√°ta z localStorage
                 const backupData = {
                     workDaysData: localStorage.getItem('workDaysData') || '{}', // Cel√© monthData
                     hourlyWage: localStorage.getItem('hourlyWage') || JSON.stringify(10),
                     taxRate: localStorage.getItem('taxRate') || JSON.stringify(2), // Ulo≈æen√© ako percento
                     darkMode: localStorage.getItem('darkMode') || JSON.stringify(false),
                     decimalPlaces: localStorage.getItem('decimalPlaces') || JSON.stringify(2),
                     employeeName: localStorage.getItem('employeeName') || JSON.stringify(''),
                     // Prid√°me inform√°cie o z√°lohe
                     backupVersion: 2, // Verzia ≈°trukt√∫ry z√°lohy
                     backupTimestamp: new Date().toISOString()
                 };

                 // Vytvor√≠me Blob a URL pre stiahnutie
                 const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json;charset=utf-8" });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 const safeEmployeeName = (employeeName || 'pracovnik').replace(/[^a-zA-Z0-9]/g, '_');
                 const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                 a.download = `bruno-calculator-backup-${safeEmployeeName}-${timestamp}.json`; // Zmyslupln√Ω n√°zov s√∫boru
                 document.body.appendChild(a);
                 a.click(); // Spust√≠ stiahnutie
                 document.body.removeChild(a); // Upratanie
                 URL.revokeObjectURL(url); // Uvoƒænenie pam√§te
                 showSaveNotification("Z√°loha √∫spe≈°ne vytvoren√°.");

             } catch (error) {
                 console.error("Chyba pri vytv√°ran√≠ z√°lohy:", error);
                 alert("Nastala chyba pri vytv√°ran√≠ z√°lo≈æn√©ho s√∫boru.");
                 showSaveNotification("Chyba pri vytv√°ran√≠ z√°lohy.", "error");
             }
         }

        window.restoreBackup = () => { // Priradenie k window pre onclick
             const fileInput = document.createElement('input');
             fileInput.type = 'file';
             fileInput.accept = '.json,application/json'; // Prij√≠mame len JSON

             fileInput.onchange = (event) => {
                 const file = event.target.files[0];
                 if (!file) return;

                 const reader = new FileReader();
                 reader.onload = (e) => {
                     try {
                         const backup = JSON.parse(e.target.result);

                         // Valid√°cia z√°kladnej ≈°trukt√∫ry z√°lohy
                          if (backup && typeof backup.workDaysData === 'string' &&
                              typeof backup.hourlyWage === 'string' && typeof backup.taxRate === 'string' &&
                              typeof backup.darkMode === 'string' && typeof backup.decimalPlaces === 'string' &&
                              typeof backup.employeeName === 'string')
                          {
                             // Overenie JSONu pre workDaysData
                             try {
                                 JSON.parse(backup.workDaysData); // Sk√∫s parsova≈•, ƒçi je to platn√Ω JSON
                             } catch (jsonError) {
                                 throw new Error("Nespr√°vny form√°t d√°t mesiacov (workDaysData) v z√°lohe.");
                             }


                             if (confirm("Naozaj chcete obnovi≈• d√°ta z tejto z√°lohy? Aktu√°lne neulo≈æen√© zmeny v aplik√°cii bud√∫ straten√©.")) {
                                 // Prep√≠sanie localStorage d√°tami zo z√°lohy
                                 localStorage.setItem('workDaysData', backup.workDaysData);
                                 localStorage.setItem('hourlyWage', backup.hourlyWage);
                                 localStorage.setItem('taxRate', backup.taxRate); // Ulo≈æ√≠me ako string percenta
                                 localStorage.setItem('darkMode', backup.darkMode);
                                 localStorage.setItem('decimalPlaces', backup.decimalPlaces);
                                 localStorage.setItem('employeeName', backup.employeeName);

                                 // Po obnoven√≠ mus√≠me znovu naƒç√≠ta≈• d√°ta do aplik√°cie
                                 // POZOR: Naƒç√≠tanie m√¥≈æe sp√¥sobi≈• probl√©my, ak z√°loha obsahuje d√°ta pre in√Ω mesiac/rok
                                 // ako je aktu√°lne zobrazen√Ω. Je bezpeƒçnej≈°ie len naƒç√≠ta≈• d√°ta
                                 // a necha≈• pou≈æ√≠vateƒæa manu√°lne prepn√∫≈• mesiac/rok, alebo obnovi≈• str√°nku.
                                 // Alebo m√¥≈æeme sk√∫si≈• naƒç√≠ta≈• mesiac/rok zo z√°lohy, ak tam s√∫.

                                 // Jednoduch≈°ia mo≈ænos≈•: reload str√°nky po obnove
                                 alert("Z√°loha bola √∫spe≈°ne obnoven√°. Aplik√°cia sa teraz znovu naƒç√≠ta.");
                                 window.location.reload();

                                 /* Alternat√≠va bez reloadu (komplexnej≈°ia):
                                 loadFromLocalStorage(); // Naƒç√≠ta obnoven√© d√°ta do UI
                                 showSaveNotification("Z√°loha √∫spe≈°ne obnoven√°.");
                                 alert("Z√°loha bola √∫spe≈°ne obnoven√°. D√°ta boli naƒç√≠tan√©.");
                                 // Ak je pou≈æ√≠vateƒæ prihl√°sen√Ω, pok√∫sime sa ulo≈æi≈• obnoven√© d√°ta aj do Firebase
                                 if (currentUser) {
                                     saveToLocalStorage(); // Toto zavol√° aj saveToFirebase
                                      showSaveNotification("Obnoven√© d√°ta sa ukladaj√∫ do cloudu...", "warning");
                                 }
                                 */
                             }
                         } else {
                              throw new Error("S√∫bor z√°lohy m√° nespr√°vny form√°t alebo ch√Ωbaj√∫ kƒæ√∫ƒçov√© d√°ta.");
                         }
                     } catch (error) {
                         console.error("Chyba pri spracovan√≠ alebo obnove z√°lohy:", error);
                         alert(`Chyba pri ƒç√≠tan√≠ alebo obnove z√°lohy: ${error.message}`);
                         showSaveNotification("Chyba pri obnove z√°lohy.", "error");
                     }
                 };
                 reader.onerror = (e) => {
                     console.error("Chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy:", e);
                     alert("Nastala chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy.");
                     showSaveNotification("Chyba pri ƒç√≠tan√≠ s√∫boru z√°lohy.", "error");
                 };
                 reader.readAsText(file); // ƒå√≠tame ako text (JSON)
             };
             fileInput.click(); // Otvor√≠ dial√≥g na v√Ωber s√∫boru
         }


        // --- Inicializ√°cia Aplik√°cie ---
        function populateYearSelect() {
            const startYear = 2020;
            const endYear = new Date().getFullYear() + 5; // Do +5 rokov do bud√∫cna
            const currentSelectedYearStr = yearSelect.value; // Uchov√°me aktu√°lne vybran√∫ hodnotu ako string
            yearSelect.innerHTML = '';
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
             // Sk√∫sime nastavi≈• predt√Ωm vybran√Ω rok, alebo aktu√°lny
             yearSelect.value = currentSelectedYearStr || currentYear.toString();
             // Ak sa hodnota nenastavila (napr. star√Ω rok u≈æ nie je v zozname), nastav aktu√°lny
             if (yearSelect.value !== currentSelectedYearStr && yearSelect.value !== currentYear.toString()) {
                 yearSelect.value = new Date().getFullYear().toString();
             }
              // Aktualizuj glob√°lnu premenn√∫ podƒæa fin√°lne nastavenej hodnoty
             currentYear = parseInt(yearSelect.value);
        }

        // Spust√≠ sa po naƒç√≠tan√≠ DOM
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed.");
            populateYearSelect();

            // Naƒç√≠tanie stavu z localStorage pri ≈°tarte (e≈°te pred overen√≠m auth stavu)
            // aby UI nevyzeralo "rozbit√©" k√Ωm sa neskonƒç√≠ onAuthStateChanged
            const initialDarkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
            applyDarkMode(initialDarkMode);
            const initialEmployeeName = JSON.parse(localStorage.getItem('employeeName')) || '';
             employeeNameInput.value = initialEmployeeName; // Nastav meno hneƒè
             employeeName = initialEmployeeName; // Aktualizuj glob√°lnu premenn√∫
             updateWelcomeMessage(); // Zobraz uv√≠tanie hneƒè

            // Ostatn√© nastavenia a d√°ta sa naƒç√≠taj√∫ a aplikuj√∫ v onAuthStateChanged alebo loadFromLocalStorage
            // Spustenie prv√©ho naƒç√≠tania/kontroly stavu - auth listener sa spust√≠ automaticky
        });

         // Pomocn√° funkcia pre debounce (prevzat√°)
         function debounce(func, wait) {
             let timeout;
             return function executedFunction(...args) {
                 const later = () => {
                     clearTimeout(timeout);
                     func(...args);
                 };
                 clearTimeout(timeout);
                 timeout = setTimeout(later, wait);
             };
         }

    </script>

     <script>
         if ('serviceWorker' in navigator) {
             window.addEventListener('load', () => {
                 // Pou≈æijeme relat√≠vnu cestu - predpoklad√°me, ≈æe sw.js je v rovnakom adres√°ri
                 navigator.serviceWorker.register('./service-worker.js') // Uistite sa, ≈æe cesta je spr√°vna
                     .then(registration => {
                         console.log('ServiceWorker registration successful with scope: ', registration.scope);
                     })
                     .catch(error => {
                         console.error('ServiceWorker registration failed: ', error);
                     });
             });
         } else {
              console.warn("Service Worker is not supported in this browser.");
          }
     </script>

</body>
</html>
