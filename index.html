<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bruno's Calculator s Firebase Auth</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap&subset=latin-ext" rel="stylesheet">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-check-compat.js"></script>

  <!-- jsPDF a autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* --- ZAƒåIATOK CSS ≈†T√ùLOV --- */
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; margin: 0; padding: 10px; background-color: #f4f4f4; color: #333; transition: background-color 0.3s, color 0.3s; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; transition: background-color 0.3s, color 0.3s; }
    .autor-info { position: absolute; top: 10px; left: 10px; font-size: 14px; font-style: italic; color: #666; }
    h1 { text-align: center; font-size: 2.5em; background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff); background-clip: text; -webkit-background-clip: text; color: transparent; animation: gradientText 5s ease-in-out infinite, textShadowPulse 2s ease-in-out infinite; margin-bottom: 10px; }
    h2 { text-align: center; color: #555; margin-top: -10px; font-size: 1.2em; }
    .settings { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .settings > div, .settings > details, .settings > button { flex: 1 1 200px; margin: 0; }
    .settings label { display: block; margin-bottom: 5px; }
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; min-width: 900px; /* M√¥≈æe≈° zn√≠≈æi≈•, ak s√∫ stƒ∫pce celkovo u≈æ≈°ie */ }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; vertical-align: top; }
    th { background-color: #f2f2f2; }
    input[type="tel"], input[type="number"], input[type="text"], select, .note-textarea { width: 100%; padding: 5px; box-sizing: border-box; background-color: #ffffd0; font-size: 14px; border: 1px solid #ccc; border-radius: 3px; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }

    /* --- ≈†√çRKY STƒπPCOV --- */
    /*
       *******************************************************
       *** TU M√î≈ΩE≈† UPRAVI≈§ ≈†√çRKU PRV√âHO STƒπPCA ("De≈à") ***
       *** Zme≈à hodnotu min-width (napr. 80px, 75px, 85px) ***
       *** k√Ωm nebude≈° spokojn√Ω so zalamovan√≠m textu a ≈°√≠rkou ***
       *******************************************************
    */
    th:nth-child(1), td:nth-child(1) {
         min-width: 80px; /* <<< EXPERIMENTUJ S TOUTO HODNOTOU */
         /* Nastavenie white-space: normal; je defaultn√©, ale pre istotu: */
         white-space: normal; /* Umo≈æn√≠ zalomenie textu */
         word-break: break-word; /* Pom√¥≈æe pri zalamovan√≠, ak je to potrebn√© */
    }

    /* Ostatn√© ≈°√≠rky (zost√°vaj√∫ ako boli) */
    th:nth-child(2), td:nth-child(2) { min-width: 80px; } /* Pr√≠chod */
    th:nth-child(3), td:nth-child(3) { min-width: 80px; } /* Odchod */
    th:nth-child(4), td:nth-child(4) { min-width: 80px; } /* Prest√°vka */
    th:nth-child(5), td:nth-child(5) { min-width: 120px; } /* Odpracovan√© */
    th:nth-child(6), td:nth-child(6) { min-width: 90px; } /* Hrub√° Mzda */
    th:nth-child(7), td:nth-child(7) { min-width: 90px; } /* ƒåist√° Mzda */
    th:nth-child(8), td:nth-child(8) { min-width: 120px; } /* Pozn√°mka */
    th:last-child, td:last-child { min-width: 90px; text-align: center; } /* Akcia */
    /* --- KONIEC ≈†√çROK STƒπPCOV --- */

    /* ... (ostatn√© CSS pravidl√° zost√°vaj√∫ rovnak√© ako v predch√°dzaj√∫cej verzii) ... */
    .btn-container { display: flex; flex-direction: column; width: 100%; gap: 15px; margin-top: 20px; }
    .btn { width: 100%; padding: 15px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease, color 0.3s; text-align: center; box-sizing: border-box; }
    .reset-btn { background-color: #f44336; } .reset-btn:hover { background-color: #d32f2f; }
    .export-btn { background-color: #4CAF50; } .export-btn:hover { background-color: #388e3c; }
    .restore-btn { background-color: #9C27B0; } .restore-btn:hover { background-color: #7B1FA2; }
    .backup-btn { background-color: #FFA500; } .backup-btn:hover { background-color: #E68900; }
    .highlight { background-color: #ffcc00; color: #333; font-weight: bold; border: 2px solid #ffcc00; } /* Tlaƒçidlo pre login/dark mode */
    #totalSalary { font-size: 18px; font-weight: bold; text-align: center; margin-top: 20px; padding: 10px; background-color: #e6f3ff; border-radius: 5px; transition: background-color 0.3s; }
    #dataSizeContainer { margin-top: 10px; text-align: center; }
    #dataSizeText { margin-bottom: 5px; font-size: 14px; color: #555; }
    #dataSizeBar { width: 80%; height: 20px; background-color: #ddd; border-radius: 10px; margin: 0 auto; overflow: hidden; }
    #dataSizeFill { height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s ease; }
    .current-day { background-color: #8a2be2 !important; color: white !important; } /* !important pre prioritu */
    .current-day input, .current-day .note-textarea, .current-day .toggle-note-btn { background-color: #9932cc !important; color: white !important; border-color: #c57eed !important; }
    .current-day .toggle-note-btn:hover { background-color: #7a28a3 !important; } /* Hover pre current day note button */
    @keyframes gradientText { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes textShadowPulse { 0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3), 0 0 30px rgba(255, 255, 255, 0.2); } 50% { text-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.9), 0 0 40px rgba(255, 255, 255, 0.7); } }

    /* Dark Mode */
    body.dark-mode { background-color: #333; color: #f4f4f4; }
    body.dark-mode .container { background-color: #444; color: #f4f4f4; }
    body.dark-mode table { background-color: #555; color: #f4f4f4; }
    body.dark-mode th { background-color: #666; border-color: #777; }
    body.dark-mode td { background-color: #444; color: #f4f4f4; border-color: #555; }
    body.dark-mode input[type="tel"], body.dark-mode input[type="number"], body.dark-mode input[type="text"], body.dark-mode select, body.dark-mode .note-textarea { background-color: #666; color: white; border-color: #888; }
    body.dark-mode .btn:not(.highlight) { color: white; } /* Ostatn√© tlaƒçidl√° maj√∫ biely text */
    body.dark-mode .highlight { background-color: #e6c300; color: #222; border-color: #e6c300;} /* Tmav≈°√≠ highlight v dark mode */
    body.dark-mode .reset-btn { background-color: #c62828; } body.dark-mode .reset-btn:hover { background-color: #a32121; }
    body.dark-mode .export-btn { background-color: #2e7d32; } body.dark-mode .export-btn:hover { background-color: #1b5e20; }
    body.dark-mode .restore-btn { background-color: #6a1b9a; } body.dark-mode .restore-btn:hover { background-color: #4a148c; }
    body.dark-mode .backup-btn { background-color: #ef6c00; } body.dark-mode .backup-btn:hover { background-color: #cc5c00; }
    body.dark-mode #totalSalary { background-color: #2c3e50; }
    body.dark-mode .current-day { background-color: #4a0e8f !important; color: #fff !important; }
    body.dark-mode .current-day input, body.dark-mode .current-day .note-textarea, body.dark-mode .current-day .toggle-note-btn { background-color: #5c1db3 !important; color: #fff !important; border-color: #8e5ccf !important; }
    body.dark-mode .current-day .toggle-note-btn:hover { background-color: #4a148c !important; }
    body.dark-mode .autor-info { color: #aaa; }
    body.dark-mode h2 { color: #ccc; }
    body.dark-mode #dataSizeText { color: #bbb; }
    body.dark-mode #dataSizeBar { background-color: #555; }

    /* Auth Modal */
    #auth-modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 9990; }
    #auth-container { /* Teraz ako modal */ display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; max-width: 400px; width: 90%; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); text-align: center; }
    #auth-container h1 { font-size: 1.8em; margin-bottom: 15px; background: none; /* Odstr√°ni≈• gradient z modalu */ color: #333; animation: none; }
    #auth-container h2 { font-size: 1.1em; color: #444; margin-top: 15px; margin-bottom: 5px; }
    #auth-container input { width: calc(100% - 22px); /* Lep≈°ie zarovnanie */ padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; }
    #auth-container button { width: 100%; padding: 12px; margin: 10px 0; border: none; background-color: #4CAF50; color: #fff; font-size: 16px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
    #auth-container button:hover { background-color: #45a049; }
    #auth-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #888; line-height: 1; padding: 0; }
    #forgot-password-link { display: block; margin-top: 15px; font-size: 14px; color: #007bff; text-decoration: none; cursor: pointer; }
    #forgot-password-link:hover { text-decoration: underline; }
    body.dark-mode #auth-container { background-color: #444; color: #f4f4f4; } /* Dark mode pre modal */
    body.dark-mode #auth-container h1 { color: #f4f4f4; }
    body.dark-mode #auth-container h2 { color: #ccc; }
    body.dark-mode #auth-container input { background-color: #666; color: white; border-color: #888; }
    body.dark-mode #auth-container button { background-color: #2e7d32; }
    body.dark-mode #auth-container button:hover { background-color: #1b5e20; }
    body.dark-mode #auth-close-btn { color: #bbb; }
    body.dark-mode #forgot-password-link { color: #4dabf7; }

    /* Notifik√°cia a Loading */
    #saveNotification { position: fixed; bottom: 20px; right: 20px; background-color: #4CAF50; color: white; padding: 12px 25px; border-radius: 5px; display: none; z-index: 1000; transition: background-color 0.3s ease, opacity 0.5s ease, transform 0.3s ease-out; transform: translateY(20px); }
    #saveNotification.show { display: block; opacity: 1; transform: translateY(0); }
    #saveNotification.error { background-color: #f44336; }
    #saveNotification.warning { background-color: #ff9800; }
    #loading-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease-out; }
    #loading-container h1 { font-size: 1.5em; text-align: center; padding: 20px; max-width: 80%; background: none; color: #555; animation: none; }
    #loading-container.hidden { opacity: 0; pointer-events: none; }
    body.dark-mode #loading-container { background-color: #333; } /* Dark mode pre loading */
    body.dark-mode #loading-container h1 { color: #ccc; }

    /* Collapsible settings */
    .collapsible-settings summary { cursor: pointer; padding: 8px; border: 1px solid #ccc; border-radius: 3px; background-color: #f8f8f8; margin-bottom: 5px; display: list-item; transition: background-color 0.2s ease; font-weight: bold; }
    .collapsible-settings summary:hover { background-color: #eee; }
    .collapsible-content { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; padding: 10px 5px 5px 5px; border-top: 1px solid #eee; margin-top: 5px; }
    .collapsible-content > div { flex: 1 1 200px; margin: 0; }
    body.dark-mode .collapsible-settings summary { background-color: #555; border-color: #777; color: #f4f4f4; }
    body.dark-mode .collapsible-settings summary:hover { background-color: #666; }
    body.dark-mode .collapsible-content { border-top-color: #666; }

    /* Pozn√°mky */
    .note-container { display: none; margin-top: 5px; }
    .note-container.visible { display: block; }
    .note-textarea { width: 95%; min-height: 40px; resize: vertical; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; background-color: #f0f0f0; }
    .toggle-note-btn { background-color: #6c757d; color: white; padding: 3px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease; margin-bottom: 2px; display: inline-block; /* Aby bol vedƒæa textu */ }
    .toggle-note-btn:hover { background-color: #5a6268; }
    body.dark-mode .note-textarea { background-color: #555; color: #f4f4f4; border-color: #777; }
    body.dark-mode .toggle-note-btn { background-color: #828a91; }
    body.dark-mode .toggle-note-btn:hover { background-color: #70777d; }
     /* --- KONIEC CSS ≈†T√ùLOV --- */
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-container"><h1> Naƒç√≠tavam Bruno's Calculator... </h1></div>

  <!-- Auth Modal (skryt√Ω) -->
  <div id="auth-modal-backdrop" onclick="hideAuthModal()"></div>
  <div id="auth-container">
    <button id="auth-close-btn" onclick="hideAuthModal()">√ó</button>
    <h1>Prihl√°senie / Registr√°cia</h1>
    <div id="auth-message">Zadajte svoje √∫daje pre ukladanie a synchroniz√°ciu d√°t.</div>
    <div id="auth-forms">
      <h2>Registr√°cia</h2>
      <input type="email" id="registerEmail" placeholder="Email">
      <input type="password" id="registerPassword" placeholder="Heslo">
      <button onclick="registerAndClose()">Registrova≈•</button>
      <h2>Prihl√°senie</h2>
      <input type="email" id="loginEmail" placeholder="Email">
      <input type="password" id="loginPassword" placeholder="Heslo">
      <button onclick="loginAndClose()">Prihl√°si≈• sa</button>
      <a id="forgot-password-link" onclick="forgotPassword()">Zabudli ste heslo?</a>
    </div>
  </div>

  <!-- Hlavn√Ω kontajner kalkulaƒçky (viditeƒæn√Ω hneƒè) -->
  <div id="calculator-container" class="container">
    <div class="autor-info">Vytvoril Bruno</div>
    <h1 id="mainTitle">Bruno's Calculator</h1>
    <h2 id="welcomeMessage"></h2> <!-- Pozdrav sa napln√≠ dynamicky -->

    <!-- Stav prihl√°senia a ovl√°dacie prvky -->
    <div id="auth-status-container" style="text-align: center; margin-bottom: 15px; padding: 8px; background-color: #eee; border-radius: 4px;">
        <span id="auth-status-message">Pou≈æ√≠vate aplik√°ciu anonymne.</span>
        <button id="login-register-btn" class="btn highlight" onclick="showAuthModal()" style="padding: 5px 10px; font-size: 14px; margin-left: 10px; display: inline-block; width: auto;">Prihl√°si≈• / Registrova≈•</button>
        <button id="logout-btn-inline" class="btn reset-btn" onclick="logout()" style="padding: 5px 10px; font-size: 14px; margin-left: 10px; display: none; width: auto;">Odhl√°si≈• sa</button>
    </div>
    <!-- Dark mode pre status container -->
     <style> body.dark-mode #auth-status-container { background-color: #555; } </style>


    <div class="settings">
        <div>
            <label for="monthSelect">Mesiac: </label>
            <select id="monthSelect" onchange="changeMonth()">
                <option value="0">Janu√°r</option> <option value="1">Febru√°r</option> <option value="2">Marec</option>
                <option value="3">Apr√≠l</option> <option value="4">M√°j</option> <option value="5">J√∫n</option>
                <option value="6">J√∫l</option> <option value="7">August</option> <option value="8">September</option>
                <option value="9">Okt√≥ber</option> <option value="10">November</option> <option value="11">December</option>
            </select>
        </div>
        <details class="collapsible-settings">
            <summary>ƒéal≈°ie nastavenia</summary>
            <div class="collapsible-content">
                <div>
                    <label for="employeeNameInput">Meno pracovn√≠ka: </label>
                    <input type="text" id="employeeNameInput" placeholder="Zadajte meno pracovn√≠ka" oninput="updateEmployeeName()">
                </div>
                <div>
                    <label for="hourlyWageInput">Hodinov√° mzda (‚Ç¨): </label>
                    <input type="number" id="hourlyWageInput" value="10" min="0" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="taxRateInput">Da≈àov√© percento (%): </label>
                    <input type="number" id="taxRateInput" value="2" min="0" step="0.1" oninput="updateSettings()">
                </div>
                <div>
                    <label for="yearSelect">Rok: </label>
                    <select id="yearSelect" onchange="changeYear()"></select>
                </div>
                <div>
                    <label for="decimalPlacesSelect">Poƒçet desatinn√Ωch miest: </label>
                    <select id="decimalPlacesSelect" onchange="changeDecimalPlaces()">
                        <option value="1">1</option> <option value="2">2</option>
                    </select>
                </div>
            </div>
        </details>
        <button onclick="toggleDarkMode()" class="btn highlight">Prep√≠na≈• tmav√Ω re≈æim</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>De≈à</th><th>Pr√≠chod</th><th>Odchod</th><th>Prest√°vka</th><th>Odpracovan√©</th>
            <th>Hrub√° Mzda (‚Ç¨)</th><th>ƒåist√° Mzda (‚Ç¨)</th><th class="th-note">Pozn√°mka</th><th>Akcia</th>
          </tr>
        </thead>
        <tbody id="workDays"></tbody>
      </table>
    </div>
    <div id="totalSalary"></div>
    <div id="dataSizeContainer">
      <div id="dataSizeText">Lok√°lne √∫lo≈æisko: ~0.00 KB / 4096 KB</div>
      <div id="dataSizeBar"><div id="dataSizeFill"></div></div>
    </div>
    <div class="btn-container">
      <button class="btn reset-btn" onclick="resetAll()">Resetova≈• v≈°etko</button>
      <button class="btn export-btn" onclick="exportToPDF()">Exportova≈• do PDF</button>
      <button class="btn export-btn" onclick="sendPDF()">Odosla≈•</button>
      <button class="btn restore-btn" onclick="restoreBackup()">Obnovi≈• z√°lohu</button>
      <button class="btn backup-btn" onclick="createBackup()">Vytvori≈• z√°lohu</button>
      <!-- P√¥vodn√© logout tlaƒçidlo tu u≈æ nie je potrebn√© -->
    </div>
  </div>

  <!-- Notifik√°cia -->
  <div id="saveNotification"></div>

  <script>
    // --- ZAƒåIATOK JAVASCRIPTU ---

    // 1. Firebase Config & Init
    const firebaseConfig = { apiKey: "AIzaSyDWFiWPldB7aWPIuFhAmriAm_DR38rndIo", authDomain: "bruno-3cee2.firebaseapp.com", projectId: "bruno-3cee2", storageBucket: "bruno-3cee2.appspot.com", messagingSenderId: "155545319308", appId: "1:155545319308:web:5da498ff1cd3e1833888a9" };
    firebase.initializeApp(firebaseConfig);
    try { firebase.appCheck().activate('6LcagP8qAAAAAN3MIW5-ALzayoS57THfEvO1yUTv', true); } catch (error) { console.warn("Chyba pri aktiv√°cii Firebase App Check:", error); }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // 2. Povolenie Firestore Offline Persistence
    db.enablePersistence().then(() => { console.log("Firestore offline persistence povolen√°."); }).catch((err) => { console.error("Firestore offline persistence chyba:", err.code, err.message, err); if (err.code == 'failed-precondition') { console.warn("Firestore offline persistence: Viacn√°sobn√© otvoren√© taby, povolen√© len v jednom."); } else if (err.code == 'unimplemented') { console.error("Firestore offline persistence: Prehliadaƒç nie je podporovan√Ω."); } });

    // 3. Glob√°lne premenn√©
    let currentMonth, currentYear, decimalPlaces, employeeName, hourlyWage, taxRate;
    let monthData = {}; // Objekt na ukladanie d√°t pre r√¥zne mesiace/roky
    let firestoreListenerUnsubscribe = null; // Na odhl√°senie listenera

    // Elementy UI
    const workDays = document.getElementById('workDays');
    const totalSalaryDiv = document.getElementById('totalSalary');
    const dataSizeText = document.getElementById('dataSizeText');
    const dataSizeFill = document.getElementById('dataSizeFill');
    const hourlyWageInput = document.getElementById('hourlyWageInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const decimalPlacesSelect = document.getElementById('decimalPlacesSelect');
    const employeeNameInput = document.getElementById('employeeNameInput');
    const MAX_DATA_SIZE = 4 * 1024 * 1024; // 4MB limit pre localStorage
    const MAX_DATA_SIZE_KB = MAX_DATA_SIZE / 1024;

    // 4. Auth Modal Funkcie
    function showAuthModal() { document.getElementById('auth-modal-backdrop').style.display = 'block'; document.getElementById('auth-container').style.display = 'block'; if (document.body.classList.contains('dark-mode')) document.getElementById('auth-container').classList.add('dark-mode'); else document.getElementById('auth-container').classList.remove('dark-mode'); }
    function hideAuthModal() { document.getElementById('auth-modal-backdrop').style.display = 'none'; document.getElementById('auth-container').style.display = 'none'; }
    function registerAndClose() { const email = document.getElementById('registerEmail').value; const password = document.getElementById('registerPassword').value; if (!email || !password) { alert("Pros√≠m, zadajte email aj heslo."); return; } auth.createUserWithEmailAndPassword(email, password).then((userCredential) => { console.log("Registrovan√Ω:", userCredential.user); alert("Registr√°cia √∫spe≈°n√°!"); hideAuthModal(); }).catch((error) => { console.error("Chyba pri registr√°cii:", error.message); alert("Chyba pri registr√°cii: " + error.message); }); }
    function loginAndClose() { const email = document.getElementById('loginEmail').value; const password = document.getElementById('loginPassword').value; if (!email || !password) { alert("Pros√≠m, zadajte email aj heslo."); return; } auth.signInWithEmailAndPassword(email, password).then((userCredential) => { console.log("Prihl√°sen√Ω:", userCredential.user); alert("Prihl√°senie √∫spe≈°n√©!"); hideAuthModal(); }).catch((error) => { console.error("Chyba pri prihl√°sen√≠:", error.message); alert("Chyba pri prihl√°sen√≠: " + error.message); }); }
    function logout() { auth.signOut().then(() => { console.log("Odhl√°sen√Ω."); showSaveNotification("Odhl√°senie √∫spe≈°n√©."); }).catch((error) => { console.error("Chyba pri odhl√°sen√≠:", error.message); showSaveNotification("Chyba pri odhl√°sen√≠: " + error.message, "error"); }); }
    function forgotPassword() { const emailInput = document.getElementById('loginEmail'); const email = emailInput.value; if (!email) { alert("Pros√≠m, zadajte svoju e-mailov√∫ adresu do poƒæa pre prihl√°senie."); emailInput.focus(); return; } auth.sendPasswordResetEmail(email).then(() => { console.log("E-mail na obnovenie hesla odoslan√Ω na:", email); alert("Odkaz na obnovenie hesla bol odoslan√Ω na va≈°u e-mailov√∫ adresu. Skontrolujte si pros√≠m po≈°tu (aj prieƒçinok Spam)."); }).catch((error) => { console.error("Chyba pri odosielan√≠ e-mailu na obnovenie hesla:", error); alert("Chyba pri odosielan√≠ e-mailu na obnovenie hesla: " + error.message); }); }

    // 5. Auth State Change Listener
    auth.onAuthStateChanged(user => {
        console.log("onAuthStateChanged: Stav zisten√Ω.", user ? `Pou≈æ√≠vateƒæ: ${user.email}` : "≈Ωiadny pou≈æ√≠vateƒæ.");
        const loadingContainer = document.getElementById('loading-container');
        if (!loadingContainer.classList.contains('hidden')) { loadingContainer.classList.add('hidden'); }
        const authStatusMsg = document.getElementById('auth-status-message'); const loginRegBtn = document.getElementById('login-register-btn'); const logoutBtnInline = document.getElementById('logout-btn-inline');
        if (firestoreListenerUnsubscribe) { console.log("Odhlasujem Firestore listener."); firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; }

        if (user) { // PRIHL√ÅSEN√ù
            console.log("Stav: Prihl√°sen√Ω."); authStatusMsg.textContent = `Prihl√°sen√Ω: ${user.email}`; loginRegBtn.style.display = 'none'; logoutBtnInline.style.display = 'inline-block';
            setupFirestoreListener();
            const uid = user.uid; const userDocRef = db.collection("users").doc(uid); userDocRef.get().then(userDocSnap => { if (!userDocSnap.exists) { userDocRef.set({ email: user.email, createdAt: new Date().toISOString() }, { merge: true }).catch(err => console.error("Chyba pri vytv√°ran√≠ user doc:", err)); } }).catch(err => console.error("Chyba pri kontrole user doc:", err));
            console.log("Sp√∫≈°≈•am saveToLocalStorage() po prihl√°sen√≠."); saveToLocalStorage();
        } else { // NEPRIHL√ÅSEN√ù
            console.log("Stav: Neprihl√°sen√Ω."); authStatusMsg.textContent = "Pou≈æ√≠vate aplik√°ciu anonymne."; loginRegBtn.style.display = 'inline-block'; logoutBtnInline.style.display = 'none';
        }
        updateWelcomeMessage();
    });

    // 6. Utility funkcie
    function debounce(func, wait) { let timeout; return function (...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), wait); }; }
    function showSaveNotification(message, type = 'success') { const n = document.getElementById('saveNotification'); n.textContent = message; n.className = ''; requestAnimationFrame(() => { n.className = 'show'; if (type === 'error') n.classList.add('error'); else if (type === 'warning') n.classList.add('warning'); setTimeout(() => { n.classList.remove('show'); n.style.transform = 'translateY(20px)'; }, 3000); n.style.transform = 'translateY(0)'; }); }
    function getFirstName(fullName) { if (!fullName || typeof fullName !== 'string') { return ''; } const trimmedName = fullName.trim(); if (!trimmedName) { return ''; } const parts = trimmedName.split(' '); return parts[0]; }
    function updateWelcomeMessage() { const w = document.getElementById('welcomeMessage'); if (!w) return; const name = getFirstName(employeeName); w.textContent = name ? `Vitaj sp√§≈•, ${name}! üëã` : ''; }

    // 7. Firestore Listener Setup (vol√° sa len prihl√°sen√Ωm)
    function setupFirestoreListener() {
        if (firestoreListenerUnsubscribe) { console.log("setupFSListener: Odhlasujem existuj√∫ci."); firestoreListenerUnsubscribe(); firestoreListenerUnsubscribe = null; }
        const uid = auth.currentUser?.uid; if (!uid) { console.log("setupFSListener: Nie je UID."); return; }
        if (currentMonth === undefined || currentYear === undefined) { console.warn("setupFSListener: Ch√Ωba mesiac/rok."); const now = new Date(); currentMonth = currentMonth ?? now.getMonth(); currentYear = currentYear ?? now.getFullYear(); }
        const docPath = `users/${uid}/calculatorData/${currentYear}-${currentMonth}`; const docRef = db.doc(docPath);
        console.log(`setupFSListener: Nastavujem pre ${docPath}`);
        firestoreListenerUnsubscribe = docRef.onSnapshot({ includeMetadataChanges: true }, (docSnap) => {
            const source = docSnap.metadata.fromCache ? "cache" : "server"; console.log(`FS Snapshot: ${docPath} (${source}). Pending: ${docSnap.metadata.hasPendingWrites}`);
            if (docSnap.metadata.hasPendingWrites) {
                console.log("FS Snapshot: Lok√°lny z√°pis, UI update preskoƒçen√Ω.");
                // --- KOREKCIA Z√ÅTVORIEK ƒç.1 ---
                if (docSnap.exists) { // <<< ODSTR√ÅNEN√â Z√ÅTVORKY ()
                     const data = docSnap.data(); const firebaseDaysData = data.days || [];
                     if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {};
                     monthData[currentYear][currentMonth] = firebaseDaysData.map(day => ({ start: day.start || '', end: day.end || '', breakTime: day.breakTime || '', note: day.note || '' }));
                }
                return;
            }

            // --- KOREKCIA Z√ÅTVORIEK ƒç.2 ---
            if (docSnap.exists) { // <<< ODSTR√ÅNEN√â Z√ÅTVORKY ()
                const data = docSnap.data(); console.log(`FS Snapshot: Dokument existuje.`);
                try {
                    const fbHourly = data.hourlyWage ?? 10; const fbTax = data.taxRate ?? 2; const fbDecimals = data.decimalPlaces ?? 1; const fbName = data.employeeName ?? ''; const fbDark = data.darkMode ?? false; const fbDays = data.days || [];
                    let uiNeedsUpdate = false;
                    if (hourlyWage !== fbHourly && document.activeElement !== hourlyWageInput) { hourlyWage = fbHourly; hourlyWageInput.value = hourlyWage; uiNeedsUpdate = true; }
                    if (taxRate !== (fbTax / 100) && document.activeElement !== taxRateInput) { taxRate = fbTax / 100; taxRateInput.value = taxRate * 100; uiNeedsUpdate = true; }
                    if (decimalPlaces !== fbDecimals) { decimalPlaces = fbDecimals; decimalPlacesSelect.value = decimalPlaces; uiNeedsUpdate = true; }
                    if (employeeName !== fbName && document.activeElement !== employeeNameInput) { employeeName = fbName; employeeNameInput.value = employeeName; updateWelcomeMessage(); uiNeedsUpdate = true; }
                    if (document.body.classList.contains('dark-mode') !== fbDark) { applyDarkMode(fbDark); /* uiNeedsUpdate netreba, applyDarkMode rob√≠ dos≈• */ }

                    const currentLocalData = (monthData?.[currentYear]?.[currentMonth]) || []; const fbDataMapped = fbDays.map(d => ({ start: d.start||'', end: d.end||'', breakTime: d.breakTime||'', note: d.note||'' }));
                    if (JSON.stringify(currentLocalData) !== JSON.stringify(fbDataMapped)) {
                        console.log("FS Snapshot: Zmena v d√°tach dn√≠."); if (!monthData) monthData = {}; if (!monthData[currentYear]) monthData[currentYear] = {}; monthData[currentYear][currentMonth] = fbDataMapped;
                        const daysInMonth = getDaysInMonth(currentMonth); const activeId = document.activeElement?.id;
                        for (let i = 1; i <= daysInMonth; i++) {
                            const dayData = monthData[currentYear]?.[currentMonth]?.[i - 1]; const base = `${currentYear}-${currentMonth}-${i}`; const s = document.getElementById(`start-${base}`); const e = document.getElementById(`end-${base}`); const b = document.getElementById(`break-${base}`); const n = document.getElementById(`note-${base}`);
                            if (s && e && b && n) { const ns = dayData?.start||''; const ne = dayData?.end||''; const nb = dayData?.breakTime||''; const nn = dayData?.note||'';
                                if (s.value !== ns && activeId !== s.id) s.value = ns; if (e.value !== ne && activeId !== e.id) e.value = ne; if (b.value !== nb && activeId !== b.id) b.value = nb; if (n.value !== nn && activeId !== n.id) n.value = nn; calculateRow(i); } }
                        uiNeedsUpdate = true;
                    }
                    localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage)); localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode'))); localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces)); localStorage.setItem('employeeName', JSON.stringify(employeeName)); localStorage.setItem('workDaysData', JSON.stringify(monthData)); updateDataSize();
                    if (uiNeedsUpdate) { calculateTotal(); }
                } catch (err) { console.error(`FS Snapshot: Chyba spracovania:`, err); showSaveNotification("Chyba cloudu", "error"); }
            } else { // Dokument neexistuje na Firebase
                console.log(`FS Snapshot: Dokument ${docPath} neexistuje (${source}).`); const localData = (monthData?.[currentYear]?.[currentMonth]);
                if (localData && localData.length > 0) { console.log(`FS Snapshot: Pokus o nahratie lok√°lnych d√°t.`); saveToFirebase(); }
            }
        }, (error) => { console.error(`FS Listener chyba pre ${docPath}:`, error); showSaveNotification("Chyba spojenia s cloudom", "error"); });
    }

    // 8. Ukladanie do Firebase
    async function saveToFirebase() { const user = auth.currentUser; if (!user) return; try { const data = (monthData?.[currentYear]?.[currentMonth]) || []; console.log(`saveToFirebase: ${data.length} z√°znamov pre ${currentYear}-${currentMonth}`); const payload = { days: data, hourlyWage: hourlyWage||10, taxRate: (taxRate*100)||2, decimalPlaces: decimalPlaces||1, employeeName: employeeName||'', darkMode: document.body.classList.contains('dark-mode'), timestamp: firebase.firestore.FieldValue.serverTimestamp() }; const docRef = db.collection("users").doc(user.uid).collection("calculatorData").doc(`${currentYear}-${currentMonth}`); await docRef.set(payload, { merge: true }); console.log(`saveToFirebase: Ulo≈æen√© do ${docRef.path}`); } catch (err) { console.error(`saveToFirebase chyba:`, err); showSaveNotification("Chyba ukladania do cloudu", "error"); } }

    // 9. Ukladanie do Local Storage
    function saveToLocalStorage() { try { localStorage.setItem('hourlyWage', JSON.stringify(hourlyWage)); localStorage.setItem('taxRate', JSON.stringify(taxRate * 100)); localStorage.setItem('darkMode', JSON.stringify(document.body.classList.contains('dark-mode'))); localStorage.setItem('decimalPlaces', JSON.stringify(decimalPlaces)); localStorage.setItem('employeeName', JSON.stringify(employeeName)); localStorage.setItem('currentMonth', currentMonth.toString()); localStorage.setItem('currentYear', currentYear.toString()); if (!monthData) monthData={}; if (!monthData[currentYear]) monthData[currentYear]={}; if (!monthData[currentYear][currentMonth]) monthData[currentYear][currentMonth]=[]; const dataStr = JSON.stringify(monthData); const bytes = new Blob([dataStr]).size; if (bytes > MAX_DATA_SIZE) { alert(`Lok√°lne √∫lo≈æisko je pln√©! (${(bytes/1024).toFixed(0)} KB). Ukladanie zlyhalo.`); showSaveNotification("Chyba: Lok√°lne √∫lo≈æisko pln√©!", "error"); return; } if (bytes > MAX_DATA_SIZE * 0.95) { showSaveNotification(`Pozor: Lok√°lne √∫lo≈æisko je takmer pln√©!`, "warning"); } localStorage.setItem('workDaysData', dataStr); updateDataSize(); if (auth.currentUser) { saveToFirebase(); } } catch (err) { console.error('saveToLocalStorage chyba:', err); showSaveNotification("Chyba lok√°lneho ukladania!", "error"); } }
    const debouncedSaveToLocalStorage = debounce(saveToLocalStorage, 700);

    // 10. Naƒç√≠tanie z Local Storage
    function loadFromLocalStorage() { try { if (currentMonth === undefined) { const sm = localStorage.getItem('currentMonth'); currentMonth = sm ? parseInt(sm) : new Date().getMonth(); } if (currentYear === undefined) { const sy = localStorage.getItem('currentYear'); currentYear = sy ? parseInt(sy) : new Date().getFullYear(); } console.log(`loadFromLocalStorage: ${getMonthName(currentMonth)} ${currentYear}`); const storedData = localStorage.getItem('workDaysData'); monthData = storedData ? JSON.parse(storedData) : {}; hourlyWage = parseFloat(JSON.parse(localStorage.getItem('hourlyWage')))||10; taxRate = parseFloat(JSON.parse(localStorage.getItem('taxRate')))/100||0.02; const darkMode = JSON.parse(localStorage.getItem('darkMode'))||false; decimalPlaces = parseInt(JSON.parse(localStorage.getItem('decimalPlaces')))||1; employeeName = JSON.parse(localStorage.getItem('employeeName'))||''; updateUIFromLoadedData(darkMode); } catch (err) { console.error(`loadFromLocalStorage chyba:`, err); showSaveNotification("Chyba naƒç√≠tania lok√°lnych d√°t!", "error"); monthData={}; hourlyWage=10; taxRate=0.02; decimalPlaces=1; employeeName=''; updateUIFromLoadedData(false); } }

    // 11. Update UI z d√°t
    function updateUIFromLoadedData(darkModeValue) { console.log(`updateUIFromLoadedData: ${getMonthName(currentMonth)} ${currentYear}`); try { hourlyWageInput.value=hourlyWage; taxRateInput.value=taxRate*100; decimalPlacesSelect.value=decimalPlaces; employeeNameInput.value=employeeName; if (monthSelect.querySelector(`option[value="${currentMonth}"]`)) monthSelect.value=currentMonth; else { monthSelect.value=new Date().getMonth(); currentMonth=parseInt(monthSelect.value); localStorage.setItem('currentMonth',currentMonth.toString()); } if (yearSelect.querySelector(`option[value="${currentYear}"]`)) yearSelect.value=currentYear; else { yearSelect.value=new Date().getFullYear(); currentYear=parseInt(yearSelect.value); localStorage.setItem('currentYear',currentYear.toString()); populateYearSelect(); yearSelect.value=currentYear; } createTable(); const data=(monthData?.[currentYear]?.[currentMonth])||[]; console.log(`updateUI: Pln√≠m ${data.length} z√°znamov.`); data.forEach((d, i) => { const day=i+1; const base=`${currentYear}-${currentMonth}-${day}`; const s=document.getElementById(`start-${base}`); const e=document.getElementById(`end-${base}`); const b=document.getElementById(`break-${base}`); const n=document.getElementById(`note-${base}`); if(s&&e&&b&&n){ s.value=d.start||''; e.value=d.end||''; b.value=d.breakTime||''; n.value=d.note||''; calculateRow(day); }}); calculateTotal(); updateDataSize(); applyDarkMode(darkModeValue); updateWelcomeMessage(); console.log("updateUI: Dokonƒçen√©."); } catch (err) { console.error("updateUI chyba:", err); showSaveNotification("Chyba prekreslenia UI!", "error"); } }

    // 12. Dark Mode Toggle
    function applyDarkMode(isDark) { const b=document.body; if(isDark) b.classList.add('dark-mode'); else b.classList.remove('dark-mode'); }
    function toggleDarkMode() { const isDark = !document.body.classList.contains('dark-mode'); applyDarkMode(isDark); localStorage.setItem('darkMode', JSON.stringify(isDark)); debouncedSaveToLocalStorage(); }

    // 13. Table & Input Logic
    function getDayName(y, m, d) { const days=["Ned","Pon","Uto","Str","≈†tv","Pia","Sob"]; return days[new Date(y,m,d).getDay()]; } // Skr√°ten√© dni
    function createTable() { workDays.innerHTML = ''; const head = document.querySelector('table thead tr'); if (head && !head.querySelector('.th-note')) { const th=document.createElement('th'); th.textContent='Pozn.'; th.classList.add('th-note'); head.insertBefore(th, head.lastElementChild); } const days = getDaysInMonth(currentMonth); const today = new Date(); const d=today.getDate(), m=today.getMonth(), y=today.getFullYear(); let html = ''; for (let i = 1; i <= days; i++) { const cur = (i===d && currentMonth===m && currentYear===y); const dayN = getDayName(currentYear, currentMonth, i); const base = `${currentYear}-${currentMonth}-${i}`; html += `<tr class="${cur?'current-day':''}"><td>${i}(${dayN})</td><td><input type="tel" id="start-${base}" maxlength="5" pattern="[0-9:]*" iputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'end-${base}', ${i})"></td><td><input type="tel" id="end-${base}" maxlength="5" pattern="[0-9:]*" inputmode="numeric" placeholder="HH:MM" oninput="handleInput(this, 'break-${base}', ${i})"></td><td><input type="number" id="break-${base}" min="0" step="0.5" placeholder="hod" oninput="handleBreakInput(${i})"></td><td id="total-${base}">0h 0m (0.0 h)</td><td><input type="number" id="gross-${base}" readonly></td><td><input type="number" id="net-${base}" readonly></td><td><button id="note-toggle-${base}" class="toggle-note-btn" onclick="toggleNote(${i})">Pozn</button><div id="note-container-${base}" class="note-container"><textarea id="note-${base}" class="note-textarea" placeholder="..." oninput="handleNoteInput(this, ${i})"></textarea></div></td><td><button class="btn reset-btn" onclick="resetRow(${i})" style="padding: 4px 8px; font-size: 0.9em;">X</button></td></tr>`; } workDays.innerHTML = html; applyDarkMode(document.body.classList.contains('dark-mode')); }
    function toggleNote(day) { const cont=document.getElementById(`note-container-${currentYear}-${currentMonth}-${day}`); const btn=document.getElementById(`note-toggle-${currentYear}-${currentMonth}-${day}`); if(cont&&btn){const vis=cont.classList.toggle('visible'); btn.textContent=vis?'Skry':'Pozn';}}
    function handleNoteInput(ta, day) { updateMonthDataFromInput(ta, day); debouncedSaveToLocalStorage(); }
    function isTimeValid(t) { return /^([01]\d|2[0-3]):([0-5]\d)$/.test(t); }
    function handleInput(inp, nextId, day) { formatInput(inp); updateMonthDataFromInput(inp, day); if(inp.value.length===5 && isTimeValid(inp.value)){ debouncedSaveToLocalStorage(); moveNext(inp, nextId); } }
    function handleBreakInput(day) { const inp = document.getElementById(`break-${currentYear}-${currentMonth}-${day}`); updateMonthDataFromInput(inp, day); debouncedSaveToLocalStorage(); const nextD=day+1; let nextId=null; if(nextD<=getDaysInMonth(currentMonth)) nextId=`start-${currentYear}-${currentMonth}-${nextD}`; moveNext(inp, nextId); }
    function updateMonthDataFromInput(input, day) { if(!input) return; const idx=day-1; const id=input.id; let f='unknown'; if(id.startsWith('start-'))f='start'; else if(id.startsWith('end-'))f='end'; else if(id.startsWith('break-'))f='breakTime'; else if(id.startsWith('note-'))f='note'; const v=input.value; if(f!=='unknown'){if(!monthData)monthData={}; if(!monthData[currentYear])monthData[currentYear]={}; if(!monthData[currentYear][currentMonth])monthData[currentYear][currentMonth]=[]; while(monthData[currentYear][currentMonth].length <= idx)monthData[currentYear][currentMonth].push({start:'',end:'',breakTime:'',note:''}); if(!monthData[currentYear][currentMonth][idx])monthData[currentYear][currentMonth][idx]={start:'',end:'',breakTime:'',note:''}; monthData[currentYear][currentMonth][idx][f]=v; calculateRow(day); calculateTotal();} }
    function formatInput(inp) { if (!inp || inp.type !== 'tel') return; let v = inp.value.replace(/[^\d:]/g, ''); if (v.length >= 2 && !v.includes(':')) { if(v.length > 2) v = v.slice(0, 2) + ':' + v.slice(2); } if (v.length === 3 && v.charAt(2) !== ':') v = v.slice(0, 2) + ':' + v.slice(2); if (v.length > 5) v = v.slice(0, 5); inp.value = v; }
    function moveNext(curr, nextId) { if (!nextId || !curr) return; const next = document.getElementById(nextId); if(next && document.activeElement === curr) { next.focus(); if (next.select) next.select(); } }
    function calculateRow(day) { const base=`${currentYear}-${currentMonth}-${day}`; const s=document.getElementById(`start-${base}`)?.value; const e=document.getElementById(`end-${base}`)?.value; const b=parseFloat(document.getElementById(`break-${base}`)?.value)||0; const t=document.getElementById(`total-${base}`); const g=document.getElementById(`gross-${base}`); const n=document.getElementById(`net-${base}`); if(!t||!g||!n)return; let wm=0, dh=0, tv=false; if(s&&e&&isTimeValid(s)&&isTimeValid(e)){ tv=true; const[sh,sm]=s.split(':').map(Number); const[eh,em]=e.split(':').map(Number); const stm=sh*60+sm; let etm=eh*60+em; if(etm<stm) etm+=1440; const dm=etm-stm; const bm=b*60; wm=Math.max(0,dm-bm); dh=wm/60;} const hrs=Math.floor(wm/60); const mns=Math.round(wm%60); const dec=decimalPlaces||1; t.textContent=tv?`${hrs}h ${mns}m (${dh.toFixed(dec)} h)`:(s||e?'Chyba':`0h 0m (${(0).toFixed(dec)} h)`); const hw=hourlyWage; const tr=taxRate; const gs=dh*hw; g.value=(tv&&isFinite(gs))?gs.toFixed(2):'0.00'; const ns=gs*(1-tr); n.value=(tv&&isFinite(ns))?ns.toFixed(2):'0.00'; }
    function resetRow(day) { const idx=day-1; const base=`${currentYear}-${currentMonth}-${day}`; const s=document.getElementById(`start-${base}`); const e=document.getElementById(`end-${base}`); const b=document.getElementById(`break-${base}`); const nt=document.getElementById(`note-${base}`); const nc=document.getElementById(`note-container-${base}`); const nb=document.getElementById(`note-toggle-${base}`); if(s&&e&&b&&nt&&nc&&nb){ s.value='';e.value='';b.value='';nt.value=''; nc.classList.remove('visible'); nb.textContent='Pozn'; if(monthData?.[currentYear]?.[currentMonth]?.[idx]){monthData[currentYear][currentMonth][idx]={start:'',end:'',breakTime:'',note:''};} calculateRow(day); calculateTotal(); debouncedSaveToLocalStorage(); } }
    function resetAll() { if(confirm('Naozaj resetova≈• cel√Ω mesiac?')){ if(!monthData)monthData={}; if(!monthData[currentYear])monthData[currentYear]={}; monthData[currentYear][currentMonth]=[]; createTable(); calculateTotal(); debouncedSaveToLocalStorage(); showSaveNotification("Mesiac resetovan√Ω.");}}

    // 14. Calculate Total
    function calculateTotal() { let totMins=0, days=0; const data=(monthData?.[currentYear]?.[currentMonth])||[]; data.forEach(d=>{if(d&&d.start&&d.end&&isTimeValid(d.start)&&isTimeValid(d.end)){const b=parseFloat(d.breakTime)||0; const[sh,sm]=d.start.split(':').map(Number); const[eh,em]=d.end.split(':').map(Number); const stm=sh*60+sm; let etm=eh*60+em; if(etm<stm)etm+=1440; const diff=etm-stm; const brk=b*60; const wm=Math.max(0,diff-brk); if(wm>0){totMins+=wm; days++;}}}); const totHrsDec=totMins/60; const hw=hourlyWage; const tr=taxRate; const dec=decimalPlaces||1; const gs=totHrsDec*hw; const ns=gs*(1-tr); const avgNs=days>0?(ns/days):0; const avgMins=days>0?totMins/days:0; const avgH=Math.floor(avgMins/60); const avgM=Math.round(avgMins%60); const avgHrsDec=avgMins/60; const totH=Math.floor(totMins/60); const totMrem=Math.round(totMins%60); totalSalaryDiv.innerHTML = `Dni: ${days} | Celk. ƒças: ${totH}h ${totMrem}m (${totHrsDec.toFixed(dec)} h) | Hrub√° mzda: ${gs.toFixed(2)}‚Ç¨ | ƒåist√° mzda: ${ns.toFixed(2)}‚Ç¨ | Priem. ƒçist√°: ${avgNs.toFixed(2)}‚Ç¨/de≈à | <strong>Priem. ƒças: ${avgH}h ${avgM}m (${avgHrsDec.toFixed(dec)} h)/de≈à</strong>`; }

    // 15. PDF Export
    function exportToPDF() { if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF || !window.jspdf.jsPDF.API?.autoTable) { alert("PDF kni≈ænica nie je naƒç√≠tan√°."); return; } const { jsPDF } = window.jspdf; try { const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e){} doc.setFontSize(18); doc.text(`V√Ωkaz (${getMonthName(currentMonth)} ${currentYear})`, 14, 20); doc.setFontSize(12); doc.text(`Pracovn√≠k: ${employeeName||'-'}`, 14, 28); doc.text(`Mzda: ${hourlyWage||'?'}‚Ç¨/h | Da≈à: ${(taxRate*100).toFixed(1)}%`, 14, 34); const cols = ["De≈à", "Od", "Do", "Pr.", "Hod", "Hrub√°", "ƒåist√°", "Pozn."]; const rows = []; const data = (monthData?.[currentYear]?.[currentMonth]) || []; data.forEach((d, i) => { if (d.start || d.end || d.note) { const day = i+1; const dayN = getDayName(currentYear, currentMonth, day); let wh='0.0'; const tc=document.getElementById(`total-${currentYear}-${currentMonth}-${day}`); if(tc){const m=tc.textContent.match(/\((.*?)\s*h\)/); if(m) wh=m[1];} const gv=document.getElementById(`gross-${currentYear}-${currentMonth}-${day}`)?.value||'0.00'; const nv=document.getElementById(`net-${currentYear}-${currentMonth}-${day}`)?.value||'0.00'; rows.push([ `${day}(${dayN})`, d.start||'-', d.end||'-', d.breakTime||'0', wh, gv, nv, d.note||'' ]); } }); doc.autoTable({ head: [cols], body: rows, startY: 40, headStyles: { fillColor:[41,128,185], textColor:255, fontSize:8, cellPadding:1.5 }, styles: { fontSize:8, cellPadding:1.5, overflow:'linebreak'}, columnStyles: { 0:{cellWidth:18}, 1:{cellWidth:15}, 2:{cellWidth:15}, 3:{cellWidth:10}, 4:{cellWidth:15}, 5:{cellWidth:18}, 6:{cellWidth:18}, 7:{cellWidth:'auto'} }, alternateRowStyles:{fillColor:[240,240,240]} }); const finalY = doc.lastAutoTable.finalY || 40; doc.setFontSize(10); const totalTxt = totalSalaryDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<\/?strong>/g, '').replace(/¬†/g, ' '); doc.text(totalTxt, 14, finalY + 10); doc.save(`Vykaz-${employeeName||'pracovnik'}-${currentYear}-${getMonthName(currentMonth)}.pdf`); showSaveNotification("PDF exportovan√©."); } catch (err) { console.error("PDF export chyba:", err); alert("Chyba pri exporte PDF."); } }
    function sendPDF() { if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF || !window.jspdf.jsPDF.API?.autoTable) { alert("PDF kni≈ænica nie je naƒç√≠tan√°."); return; } const { jsPDF } = window.jspdf; try { const doc = new jsPDF(); try { doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.66/fonts/Roboto/Roboto-Regular.ttf', 'Roboto', 'normal'); doc.setFont('Roboto'); } catch(e){} doc.setFontSize(16); doc.text(`V√Ωkaz doch√°dzky - ${getMonthName(currentMonth)} ${currentYear}`, 14, 20); doc.setFontSize(12); doc.text(`Pracovn√≠k: ${employeeName||'-'}`, 14, 28); const cols = ["De≈à", "Pr√≠chod", "Odchod", "Prest√°vka(h)", "Pozn√°mka"]; const rows = []; const data = (monthData?.[currentYear]?.[currentMonth]) || []; data.forEach((d, i) => { if (d.start || d.end || d.note) { const day = i+1; const dayN = getDayName(currentYear, currentMonth, day); rows.push([ `${day}(${dayN})`, d.start||'-', d.end||'-', d.breakTime||'0', d.note||'' ]); } }); doc.autoTable({ head: [cols], body: rows, startY: 35, headStyles: { fillColor:[41,128,185], textColor:255, fontSize:9 }, styles: { fontSize:9, overflow:'linebreak'}, columnStyles: { 4:{cellWidth: 60} }, alternateRowStyles:{fillColor:[240,240,240]} }); const finalY = doc.lastAutoTable.finalY || 35; doc.setFontSize(10); const totalHTML = totalSalaryDiv.innerHTML; let daysTxt='N/A'; const m = totalHTML.match(/Dni: (\d+)/); if(m) daysTxt=m[1]; const summary = `Poƒçet odpracovan√Ωch dn√≠: ${daysTxt}`; doc.text(summary, 14, finalY + 10); const blob = doc.output('blob'); const fname = `Dochadzka-${employeeName||'pracovnik'}-${currentYear}-${getMonthName(currentMonth)}.pdf`; const file = new File([blob], fname, { type: 'application/pdf' }); if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) { navigator.share({ files: [file], title: `V√Ωkaz ${getMonthName(currentMonth)} ${currentYear}`, text: `Doch√°dzka pre ${employeeName||'pracovn√≠ka'} za ${getMonthName(currentMonth)} ${currentYear}.` }).then(() => showSaveNotification("Pripraven√© na zdieƒæanie.")).catch((err) => { if(err.name !== 'AbortError') { console.error('Share chyba:', err); showSaveNotification('Chyba zdieƒæania.', 'error'); } }); } else { showSaveNotification("Zdieƒæanie nie je podporovan√©, s≈•ahujem.", "warning"); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display='none'; a.href=url; a.download=fname; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a); } } catch (err) { console.error("PDF send chyba:", err); alert("Chyba pri vytv√°ran√≠ PDF na odoslanie."); } }

    // 16. Settings & Changes
    function changeDecimalPlaces() { const v = parseInt(decimalPlacesSelect.value); if (!isNaN(v) && v>=1 && v<=2) { decimalPlaces=v; calculateTotal(); debouncedSaveToLocalStorage(); } }
    function updateEmployeeName() { employeeName = employeeNameInput.value; updateWelcomeMessage(); debouncedSaveToLocalStorage(); }
    function updateSettings() { const hw = parseFloat(hourlyWageInput.value); const tr = parseFloat(taxRateInput.value); let ch = false; if (!isNaN(hw) && hw>=0 && hourlyWage!==hw) { hourlyWage=hw; ch=true; } if (!isNaN(tr) && tr>=0 && tr<=100) { const trd=tr/100; if(taxRate!==trd){ taxRate=trd; ch=true; } } if (ch) { calculateTotal(); debouncedSaveToLocalStorage(); } }
    function changeMonth() { const m = parseInt(monthSelect.value); if (!isNaN(m) && currentMonth !== m) { currentMonth = m; handleMonthYearChange(); } }
    function changeYear() { const y = parseInt(yearSelect.value); if (!isNaN(y) && currentYear !== y) { currentYear = y; handleMonthYearChange(); } }
    function handleMonthYearChange() { console.log(`Zmena na ${getMonthName(currentMonth)} ${currentYear}`); localStorage.setItem('currentMonth', currentMonth.toString()); localStorage.setItem('currentYear', currentYear.toString()); loadFromLocalStorage(); if (auth.currentUser) setupFirestoreListener(); }
    function getDaysInMonth(m) { if (m===undefined || currentYear===undefined) return 31; return new Date(currentYear, m + 1, 0).getDate(); }
    function getMonthName(m) { const n=["Jan","Feb","Mar","Apr","M√°j","J√∫n","J√∫l","Aug","Sep","Okt","Nov","Dec"]; return n[m] || '?'; } // Skr√°ten√© n√°zvy
    function updateDataSize() { try { let bytes = 0; for (let i = 0; i < localStorage.length; i++) { const k=localStorage.key(i); const v=localStorage.getItem(k); bytes += (k?.length||0) + (v?.length||0); } const kb = (bytes / 1024).toFixed(2); const perc = Math.min(((bytes / MAX_DATA_SIZE) * 100), 100); dataSizeText.textContent = `Lok: ~${kb}KB/${MAX_DATA_SIZE_KB}KB`; dataSizeFill.style.width = `${perc}%`; dataSizeFill.style.backgroundColor = perc > 90 ? '#f44336' : perc > 70 ? '#ff9800' : '#4CAF50'; } catch (err) { dataSizeText.textContent = "Chyba veƒækosti."; } }

    // 17. Backup & Restore
    function createBackup() { try { const d = { workDaysData: localStorage.getItem('workDaysData')||'{}', hourlyWage: localStorage.getItem('hourlyWage')||'10', taxRate: localStorage.getItem('taxRate')||'2', darkMode: localStorage.getItem('darkMode')||'false', decimalPlaces: localStorage.getItem('decimalPlaces')||'1', employeeName: localStorage.getItem('employeeName')||'""', backupVersion: 3, backupTimestamp: new Date().toISOString() }; const blob = new Blob([JSON.stringify(d, null, 2)], {type:"application/json;charset=utf-8"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`bruno-calc-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showSaveNotification("Z√°loha vytvoren√°."); } catch (err) { alert("Chyba pri vytv√°ran√≠ z√°lohy."); } }
    function restoreBackup() { const input = document.createElement('input'); input.type='file'; input.accept='.json,application/json'; input.onchange = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const backup = JSON.parse(ev.target.result); if (backup && backup.workDaysData!==undefined && backup.hourlyWage!==undefined && backup.taxRate!==undefined && backup.darkMode!==undefined && backup.decimalPlaces!==undefined && backup.employeeName!==undefined) { localStorage.setItem('workDaysData', backup.workDaysData); localStorage.setItem('hourlyWage', backup.hourlyWage); localStorage.setItem('taxRate', backup.taxRate); localStorage.setItem('darkMode', backup.darkMode); localStorage.setItem('decimalPlaces', backup.decimalPlaces); localStorage.setItem('employeeName', backup.employeeName); loadFromLocalStorage(); showSaveNotification("Z√°loha obnoven√°."); alert("Z√°loha obnoven√°."); saveToLocalStorage(); } else { alert("Chyba: Nespr√°vny form√°t z√°lohy."); } } catch (err) { alert("Chyba spracovania z√°lohy."); } }; reader.onerror = () => alert("Chyba ƒç√≠tania s√∫boru."); reader.readAsText(file); }; input.click(); }

    // 18. Inicializ√°cia
    document.addEventListener('DOMContentLoaded', () => { console.log("DOM Ready. Init calculator."); const loading = document.getElementById('loading-container'); populateYearSelect(); loadFromLocalStorage(); if (loading) loading.classList.add('hidden'); if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(reg=>console.log('SW OK:', reg.scope)).catch(err=>console.error('SW ERR:', err)); }); } else { console.warn("SW not supported."); } console.log("Init done. Waiting for Auth state..."); });
    function populateYearSelect() { const start = 2020; const end = new Date().getFullYear() + 2; let html = ''; for (let y = start; y <= end; y++) { html += `<option value="${y}">${y}</option>`; } yearSelect.innerHTML = html; }

    // --- KONIEC JAVASCRIPTU ---
  </script>
</body>
</html>
